<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>西北勤務打卡系統</title>
    <link rel="icon" type="image/png" href="https://static.wixstatic.com/ficons/6148f9_bb3f0e3c08bd4a3e83840553497fd866~mv2.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- e?aaR?c?ce?3a?? -->
    <script src="js/dashboard-functions.js"></script>
    <script src="js/features.js" defer></script>
    <script src="js/other.js" defer></script>
    <script src="js/calendar.js" defer></script>
    
    <!-- a�P2c��?e?? Firebase compat SDK e??a??a��?a??i??c�g��a�M�a??c?�La�M?a?1 v10 a�L!c�g?aR�g -->
    
    <script src="clock-in-functions.js?v=20251006" defer></script>
    <script src="reset-points.js?v=20251006" defer></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .main-container {
            width: 400px;
            height: calc(100vh - 60px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-radius: 1.5rem;
            overflow: hidden;
            margin: 10px 10px 50px 10px;
        }
        .header {
            height: 70px;
        }
        .footer {
            height: 70px;
        }
        .content-area {
            height: calc(100% - 140px);
            overflow-y: auto;
        }
        .hide { display: none !important; }
        .tab-btn.active {
            color: #dc2626; /* red-600 */
            border-top-color: #dc2626; /* red-600 */
        }
        .sub-tab-btn {
            transition: all 0.2s ease-in-out;
        }
        .sub-tab-btn.active {
            background-color: #fee2e2; /* red-100 */
            color: #991b1b; /* red-800 */
            font-weight: 600;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #dc2626; /* red-600 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Modal styles */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 40;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px; /* a?oa??aR?a?�La?��e�P? */
        }
        .modal-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            max-height: calc(100vh - 40px);
            overflow-y: auto; /* a?��aR1a?��a?2a?? */
            -webkit-overflow-scrolling: touch; /* iOS a?2a??a?aa?? */
            margin-top: 12px; /* e??e??e?�La??a??e�P?e?�Fi??e??a??e�F?a?�Xa?�a??e?Ra?? */
        }
        /* iOS/c�?e|?a?�LaR?a?�La?�a?��a?�� */
        @supports (padding: env(safe-area-inset-top)) {
            .modal-backdrop {
                padding-top: calc(env(safe-area-inset-top) + 12px);
                padding-bottom: calc(env(safe-area-inset-bottom) + 12px);
                padding-left: calc(env(safe-area-inset-left) + 12px);
                padding-right: calc(env(safe-area-inset-right) + 12px);
            }
            .modal-content {
                max-height: calc(100vh - 40px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
                margin-top: calc(env(safe-area-inset-top) + 12px);
            }
        }
        /* Ensure map canvas is visible */
        .map-canvas {
            width: 100%;
            height: 100%;
            background-color: #e5e7eb; /* Gray background as a fallback */
        }
        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: 9999px;
            color: white;
            font-weight: 500;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }
        .toast.show {
            opacity: 1;
            bottom: 110px;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <!-- API Key Warning -->
    <div id="api-key-warning" class="hide fixed inset-0 bg-red-100 z-[9999] p-8 text-red-800 flex flex-col items-center justify-center text-center">
        <i data-lucide="alert-triangle" class="w-16 h-16 mb-4"></i>
        <h2 class="text-2xl font-bold mb-2">請完成最後的設定步驟</h2>
        <p class="max-w-md">
            系統偵測到您尚未設定 Firebase 或 Google Maps 的 API 金鑰。
            <br><br>
            <strong class="text-red-900">這不是程式錯誤，而是必要的設定。</strong> 基於安全考量，我無法為您產生金鑰，您必須親自完成此設定。
            <br><br>
            請打開 <code>index.html</code> 檔案，找到最下方的 <code>&lt;script type="module"&gt;</code> 區塊，並依照註解指示填入您自己的金鑰。詳細步驟請參考 <code>README.md</code> 檔案。
        </p>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="loader"></div>
    </div>

    <!-- Login Page -->
    <div id="login-page" class="w-full max-w-sm p-8 bg-white rounded-2xl shadow-lg hide">
        <div class="text-center mb-8">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-red-600"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4"></path></svg>
            <h1 class="text-2xl font-bold text-gray-800 mt-4">西北勤務打卡系統</h1>
            <p class="text-gray-500">雲端測試版V2.2.0</p>
        </div>
        <form id="login-form">
            <div class="mb-4">
                 <div class="flex justify-between items-center mb-1">
                    <label for="email" class="block text-sm font-medium text-gray-700">電子郵件</label>
                    <div class="flex items-center">
                        <input id="remember-me" type="checkbox" class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                        <label for="remember-me" class="ml-2 block text-sm text-gray-700">記住我</label>
                    </div>
                </div>
                <input type="email" id="email" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
            </div>
            <div class="mb-6">
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">密碼</label>
                <div class="relative">
                    <input type="password" id="password" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 pr-10" required>
                    <button type="button" id="toggle-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500">
                        <i id="password-icon" data-lucide="eye-off" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            <button type="submit" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150">
                登入
            </button>
            <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
        </form>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="main-container bg-white flex flex-col hide">
        <!-- Header -->
        <header class="h-[70px] flex items-center justify-between px-4 border-b border-gray-200 flex-shrink-0">
            <div class="flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-600"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4"></path></svg>
                <span class="text-lg font-bold text-gray-800">西北勤務打卡系統</span>
                <span id="welcome-message" class="text-sm text-gray-600 ml-2"></span>
            </div>
            <button id="profile-avatar-btn">
                <img id="header-avatar" src="https://placehold.co/40x40/EFEFEF/333333?text=U" alt="User Avatar" class="w-10 h-10 rounded-full object-cover">
            </button>
        </header>

        <!-- Main Content -->
        <main id="main-content" class="flex-grow flex flex-col overflow-hidden bg-gray-50">
            <!-- This will be dynamically populated -->
        </main>

        <!-- Footer Navigation -->
        <footer class="h-[70px] border-t border-gray-200 flex-shrink-0 bg-white">
            <nav id="main-nav" class="flex justify-around h-full items-center">
                <button data-tab="dashboard" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2 active">
                    <i data-lucide="layout-dashboard"></i><span class="text-xs mt-1">儀表板</span>
                </button>
                <button data-tab="clock-in" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2">
                    <i data-lucide="fingerprint"></i><span class="text-xs mt-1">打卡</span>
                </button>
                <button id="nav-other" data-tab="other" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2 hide">
                    <i data-lucide="ellipsis"></i><span class="text-xs mt-1">其他</span>
                </button>
                <button id="nav-tracking" data-tab="tracking" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2">
                    <i data-lucide="map-pin"></i><span class="text-xs mt-1">追蹤</span>
                </button>
                <button id="nav-hr" data-tab="hr" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2 hide">
                    <i data-lucide="users"></i><span class="text-xs mt-1">人事</span>
                </button>
                <button id="nav-features" data-tab="features" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2">
                    <i data-lucide="layers"></i><span class="text-xs mt-1">功能</span>
                </button>
                <button id="nav-calendar" data-tab="calendar" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2">
                    <i data-lucide="calendar"></i><span class="text-xs mt-1">行事曆</span>
                </button>
                <button id="nav-settings" data-tab="settings" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2">
                    <i data-lucide="settings"></i><span class="text-xs mt-1">設定</span>
                </button>
                <button id="nav-group" data-tab="group" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2 hide">
                    <i data-lucide="git-branch"></i><span class="text-xs mt-1">群組</span>
                </button>
            </nav>
        </footer>
    </div>
    
    <!-- Modal Container -->
    <div id="modal-container"></div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>


    <script type="module">
        // --- e??�L e??e|?e�L-aR?i??e??a?�La-?a!?a?�Da?�Le?aa�P��c?? API e??e?�X e??�L ---
        const firebaseConfig = {
          apiKey: "AIzaSyAzgs-DZbCYHP7wEM1iWi948yL77ikigBg",
          authDomain: "nw-check-in.firebaseapp.com",
          projectId: "nw-check-in",
          storageBucket: "nw-check-in.appspot.com",
          messagingSenderId: "1060821780559",
          appId: "1:1060821780559:web:2638d630526d54f1a5023a",
          measurementId: "G-61Q1QNNRD2"
        };
        const GOOGLE_MAPS_API_KEY = "AIzaSyAzhLdWtycJgfz8UsXWlji63DkXpA4kmyY";
        // --- e??�L e�L-aR?c�g?a?? e??�L ---

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut,
            createUserWithEmailAndPassword, updatePassword, reauthenticateWithCredential,
            EmailAuthProvider
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, collection, onSnapshot,
            query, where, getDocs, serverTimestamp, orderBy, limit, GeoPoint, Timestamp, writeBatch,
            enableIndexedDbPersistence, arrayUnion, arrayRemove
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { 
            getStorage, ref, uploadBytes, getDownloadURL, deleteObject
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // a?��e?2a??e|?c?? helper a??e??a�L!c�g?e?3a??a??c?�Li??e??a�M!a??i??
        window.__fs = {
            collection,
            getDocs,
            writeBatch,
            doc,
            serverTimestamp,
            addDoc,
            getDoc,
            updateDoc,
            setDoc,
            query,
            where,
            orderBy,
            limit,
            Timestamp,
            GeoPoint,
            arrayUnion,
            arrayRemove,
        };
        window.__authHelpers = { onAuthStateChanged };

        // Global State
        const state = {
            currentUser: null,
            currentUserData: null,
            googleMapsLoaded: false,
            activeListeners: [],
            currentLocation: null,
            users: [],
            trackingMap: null,
            trackingMarkers: [],
        };
        
        // a??a��?a??a??ac?e�G?c?RIDi??c?�La??a??a?!c���e??e??e|?a?!a??a?!e�G?c?Ra�L?e�L?i??
        (function initDeviceId(){
            try {
                const key = 'device_id';
                let id = localStorage.getItem(key);
                if (!id) {
                    const bytes = new Uint8Array(16);
                    crypto.getRandomValues(bytes);
                    id = Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
                    localStorage.setItem(key, id);
                }
                state.deviceId = id;
            } catch (e) {
                console.warn('a??a��?a??e�G?c?RIDa?��a??', e);
                state.deviceId = 'unknown-device';
            }
        })();

        // e��?e?2a�X?a??a�M-a??a�L?c��?
        function roleLabel(role) {
            switch (role) {
                case 'field': return 'a??a??';
                case 'user': return 'a?��a??';
                case 'junior_manager': return 'a??e??a�M?cR!';
                case 'manager': return 'e??e??a�M?cR!';
                case 'hr': return 'aooao?';
                case 'admin': return 'cR!c??a?!';
                default: return role || 'a?��a??';
            }
        }

        // e��?e?2a??c??e!?e?2a�L�Ga??
        function roleBadgeClass(role) {
            switch (role) {
                case 'admin': return 'bg-red-100 text-red-700';
                case 'manager': return 'bg-purple-100 text-purple-700';
                case 'junior_manager': return 'bg-violet-100 text-violet-700';
                case 'hr': return 'bg-amber-100 text-amber-700';
                case 'field': return 'bg-green-100 text-green-700';
                default: return 'bg-blue-100 text-blue-700'; // user / a??a??
            }
        }
        
        const loadingScreen = document.getElementById('loading-screen');
        
        function showLoading(show) {
            if(loadingScreen) loadingScreen.classList.toggle('hide', !show);
        }

        function initializeAppLogic() {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            
            // a�P2a??c?�Le?�Fc�P?a??a1?a??a?�De??a??a�M?a?? SDK c??a??e!?ca?
            // e?�De?�a??c?�Li??e??a??a??c??a?Ra�M� SDK c??a??a�M|a�M?ec|c�?e|?a?�La?��a?��
            
            const storage = getStorage(app);

            // a??a??a?�X window a??e??a�M!a??e?3a??i??a|? reset-points.jsi??a??c?�L
            window.__app = app;
        window.__auth = auth;
        window.__db = db;
        // e�?c?�Da??a??e?3a?? Firebase e??a?�La?? helpers a�P2a�X��c�P?
        try { window.dispatchEvent(new Event('firebase-ready')); } catch (e) { /* noop */ }
            window.__storage = storage;

            const loginPage = document.getElementById('login-page');
            const appContainer = document.getElementById('app-container');
            const mainContent = document.getElementById('main-content');
            const mainNav = document.getElementById('main-nav');
            const profileAvatarBtn = document.getElementById('profile-avatar-btn');
            const modalContainer = document.getElementById('modal-container');
            const toast = document.getElementById('toast');
            const loginForm = document.getElementById('login-form');
            const bodyEl = document.body;
            
            // Login page specific elements
            const rememberMeCheckbox = document.getElementById('remember-me');
            const emailInput = document.getElementById('email');
            const togglePasswordBtn = document.getElementById('toggle-password');
            const passwordInput = document.getElementById('password');

            // Remember me logic
            const savedEmail = localStorage.getItem('rememberedEmail');
            if (savedEmail) {
                emailInput.value = savedEmail;
                rememberMeCheckbox.checked = true;
            }
            
            // Password visibility toggle
            togglePasswordBtn.addEventListener('click', () => {
                const passwordIcon = document.getElementById('password-icon');
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    passwordIcon.outerHTML = '<i id="password-icon" data-lucide="eye" class="w-5 h-5"></i>';
                } else {
                    passwordInput.type = 'password';
                    passwordIcon.outerHTML = '<i id="password-icon" data-lucide="eye-off" class="w-5 h-5"></i>';
                }
                lucide.createIcons();
            });


            // --- Authentication Logic ---
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading(true);
                const email = emailInput.value;
                const password = passwordInput.value;
                const loginError = document.getElementById('login-error');
                loginError.textContent = '';

                if (rememberMeCheckbox.checked) {
                    localStorage.setItem('rememberedEmail', email);
                } else {
                    localStorage.removeItem('rememberedEmail');
                }

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    loginError.textContent = 'c??a?�Da?��a??i??e??aa�Fa?�Da�M3e??a��?c�F?a�?';
                } finally {
                    showLoading(false);
                }
            });
            
            onAuthStateChanged(auth, (user) => {
                cleanupListeners();
                if (user) {
                    bodyEl.classList.remove('bg-red-600');
                    bodyEl.classList.add('bg-gray-100');
                    state.currentUser = user;
                    const userDocRef = doc(db, "users", user.uid);
                    const unsubscribe = onSnapshot(userDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const wasNotInitialized = !state.currentUserData;
                            state.currentUserData = { id: user.uid, ...docSnap.data() };
                            if (wasNotInitialized) {
                                initializeAppUI();
                            } else {
                                updateHeaderAvatar();
                            }
                        } else { signOut(auth); }
                    }, (error) => {
                        console.error("Error listening to user document:", error);
                        signOut(auth);
                    });
                    state.activeListeners.push(unsubscribe);
                } else {
                    bodyEl.classList.remove('bg-gray-100');
                    bodyEl.classList.add('bg-red-600');
                    state.currentUser = null;
                    state.currentUserData = null;
                    loginPage.classList.remove('hide');
                    appContainer.classList.add('hide');
                    showLoading(false);
                }
            });

            // --- UI Initialization and Navigation ---
            function initializeAppUI() {
                loadGoogleMapsScript();
                updateHeaderAvatar();
                
                const navTracking = document.getElementById('nav-tracking');
                const navSettings = document.getElementById('nav-settings');
                const navHr = document.getElementById('nav-hr');
                const navGroup = document.getElementById('nav-group');
                const navFeatures = document.getElementById('nav-features');
                const navCalendar = document.getElementById('nav-calendar');
                const navOther = document.getElementById('nav-other');
                const navDashboard = document.querySelector('.tab-btn[data-tab="dashboard"]');
                const navClockIn = document.querySelector('.tab-btn[data-tab="clock-in"]');

                // a�X?e|?e!��c?oa??e??i??a?��a??e��?e?2i??admin, manager(e??e??a�M?cR!), junior_manager(a??e??a�M?cR!), hr, user, fieldi??
                const role = state.currentUserData.role;
                [navTracking, navSettings, navHr, navGroup].forEach(el => el && el.classList.add('hide'));

                if (role === 'field') {
                    // a??a??i??a??e!��c?oa�?a??a?!a�?e??a�?a??a??a�?a??e??
                    [navDashboard, navFeatures, navCalendar, navTracking, navSettings, navHr, navGroup].forEach(el => el && el.classList.add('hide'));
                    if (navClockIn) navClockIn.classList.remove('hide');
                    if (navOther) navOther.classList.remove('hide');
                } else if (role === 'admin') {
                    // cR!c??a?!i??e!��c?oe??e1?a�?e�L-aR?a�?aooao?i??a�M?e!��c?oc??c�g?i??a??e?�a��?i??
                    navTracking.classList.remove('hide');
                    navSettings.classList.remove('hide');
                    navHr.classList.remove('hide');
                    if (navOther) navOther.classList.add('hide');
                } else if (role === 'manager') {
                    // e??e??a�M?cR!i??e!��c?oe??e1?
                    navTracking.classList.remove('hide');
                    if (navOther) navOther.classList.add('hide');
                } else if (role === 'junior_manager') {
                    // a??e??a�M?cR!i??a�M?e!��c?oe??e1?i??a??e!��c?oc??c�g?
                    // navTracking a??a??e?��e??
                    navGroup.classList.remove('hide');
                    if (navOther) navOther.classList.add('hide');
                } else if (role === 'hr') {
                    // aooao?i??e!��c?oe??e1?e??aooao?
                    navTracking.classList.remove('hide');
                    navHr.classList.remove('hide');
                    if (navOther) navOther.classList.add('hide');
                } else {
                    // a?��a??/a�M�e??a??c?�Le�?i??a�M?e!��c?oe??e1?a�?e�L-aR?a�?HRa�?c??c�g?i??a�M?e!��c?oa�?a??a??a�?a??e??
                    if (navOther) navOther.classList.add('hide');
                }
                
                loginPage.classList.add('hide');
                appContainer.classList.remove('hide');
                
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                if (role === 'field') {
                    // a??a??e??e�L-e�2a?�Da�?a??a?!a�?e??
                    const clockBtn = document.querySelector('.tab-btn[data-tab="clock-in"]');
                    if (clockBtn) clockBtn.classList.add('active');
                    showPage('clock-in');
                } else {
                    document.querySelector('.tab-btn[data-tab="dashboard"]').classList.add('active');
                    showPage('dashboard');
                }
                showLoading(false);
            }

            function updateHeaderAvatar() {
                const headerAvatar = document.getElementById('header-avatar');
                if (state.currentUserData?.avatarUrl) {
                    headerAvatar.src = state.currentUserData.avatarUrl;
                } else {
                    headerAvatar.src = `https://placehold.co/40x40/EFEFEF/333333?text=${state.currentUserData?.name?.charAt(0) || 'U'}`;
                }
                const welcomeMessage = document.getElementById('welcome-message');
                if(welcomeMessage) {
                    welcomeMessage.textContent = `a-!e??~ ${state.currentUserData.name}`;
                }
            }
            
            function renderTrackingDevices(container) {
                container.innerHTML = `
                    <div class="p-4">
                        <h2 class="text-lg font-bold mb-4">a??a?!e�G?c?Rc?�Ga?��</h2>
                        <div class="mb-4 flex items-center gap-4">
                            <div>
                                <label for="device-date-filter" class="block text-sm font-medium text-gray-700">a?�Dec�Fa?�Da??</label>
                                <input type="date" id="device-date-filter" class="mt-1 px-3 py-2 border rounded-md">
                            </div>
                            <div class="flex items-end">
                                <button id="device-search-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">a?�Dec�F</button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-300">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">a��?a??</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">c?�a??</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">a??a?!a?�Da??</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">a??a?!a??c??e�G?c?RID</th>
                                    </tr>
                                </thead>
                                <tbody id="device-records-list" class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="4" class="px-6 py-4 text-center text-gray-500">e??e?�Ma??a?�Da??a�M|e??a??a?�Dec�F</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                // e�L-aR?e??e�L-a?�Da??c?oa??a?c
                const dateFilter = document.getElementById('device-date-filter');
                const today = new Date();
                dateFilter.value = today.toISOString().split('T')[0];
                
                const searchBtn = document.getElementById('device-search-btn');
                searchBtn.addEventListener('click', loadDeviceRecords);
                
                // e??a?�Da??a?!e�G?c?Re�L?e??
                async function loadDeviceRecords() {
                    const selectedDate = new Date(dateFilter.value);
                    if (isNaN(selectedDate.getTime())) {
                        showToast('e??e?�Ma??a??a??a?�Da??', true);
                        return;
                    }
                    
                    const deviceRecordsList = document.getElementById('device-records-list');
                    deviceRecordsList.innerHTML = `
                        <tr>
                            <td colspan="4" class="px-6 py-4 text-center">
                                <div class="flex items-center justify-center">
                                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                                    <span class="ml-2">e??a?�Da�M-...</span>
                                </div>
                            </td>
                        </tr>
                    `;
                    
                    try {
                        // a??a??a?�Da??c��?a?? (c??a?�D 00:00 a?�X 23:59)
                        const startDate = new Date(selectedDate);
                        startDate.setHours(0, 0, 0, 0);
                        const endDate = new Date(selectedDate);
                        endDate.setHours(23, 59, 59, 999);
                        
                        // a?�Dec�Fa??a?!e�L?e??i??a??c?��a??a?�Da??e??a??i??e??a??e??a??c���Fa??e?�a��?i??
                        const clockInRef = collection(db, 'clockInRecords');
                        const q = query(clockInRef);
                        const qs = await getDocs(q);
                        
                        const records = [];
                        qs.forEach(doc => records.push({ id: doc.id, ...doc.data() }));
                        
                        const filtered = records.filter(r => {
                            const ts = r.timestamp?.toDate?.() || (r.timestamp ? new Date(r.timestamp) : null);
                            if (!ts) return false;
                            return ts >= startDate && ts <= endDate;
                        }).sort((a, b) => {
                            const ta = a.timestamp?.toDate?.() || (a.timestamp ? new Date(a.timestamp) : new Date(0));
                            const tb = b.timestamp?.toDate?.() || (b.timestamp ? new Date(b.timestamp) : new Date(0));
                            return tb - ta;
                        });
                        
                        // a??a??a?�a??c?�La??e3?a??a?�De!��c?oa��?a??
                        const usersRef = collection(db, 'users');
                        const usersSnapshot = await getDocs(usersRef);
                        const usersData = {};
                        usersSnapshot.forEach(doc => { usersData[doc.id] = doc.data(); });
                        
                        // a?�Da??c?�Le�?c?oa?Ra??a??c�g?
                        const grouped = {};
                        filtered.forEach(r => {
                            const uid = r.userId;
                            if (!grouped[uid]) grouped[uid] = [];
                            grouped[uid].push(r);
                        });
                        
                        let html = '';
                        Object.keys(grouped).forEach(uid => {
                            const user = usersData[uid];
                            if (!user) return;
                            const recs = grouped[uid];
                            const deviceIds = [...new Set(recs.map(r => r.deviceId).filter(Boolean))];
                            const hasAnomalies = deviceIds.length > 1;
                            
                            recs.forEach(r => {
                                const rowClass = hasAnomalies ? 'bg-red-50' : '';
                                const ts = r.timestamp?.toDate?.() || (r.timestamp ? new Date(r.timestamp) : new Date());
                                html += `
                                    <tr class="${rowClass}">
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <img src="${user.avatarUrl || `https://placehold.co/32x32/EFEFEF/333333?text=${(user.name||'U').charAt(0)}`}" class="w-8 h-8 rounded-full mr-3 object-cover">
                                                <div class="text-sm font-medium text-gray-900">${user.name || 'a?ac?�D'}</div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusColor(getStatusDisplayText(r.type || '未知', r.locationName || null, r.dutyType || null))}">${getStatusDisplayText(r.type || '未知', r.locationName || null, r.dutyType || null)}</span>
                                            ${hasAnomalies ? '<div class="text-xs text-red-600 mt-1">c?�Xa�M�M</div>' : ''}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${ts.toLocaleString('zh-TW')}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${r.deviceId || 'a?ac?�D'}</td>
                                    </tr>
                                `;
                            });
                        });
                        
                        document.getElementById('device-records-list').innerHTML = html || `
                            <tr>
                                <td colspan="4" class="px-6 py-4 text-center text-gray-500">a2?a??c?|a??a�F?a??c??c���e??</td>
                            </tr>
                        `;
                        
                    } catch (error) {
                        console.error('e??a?�De�G?c?Re�L?e??a?��a??:', error);
                        document.getElementById('device-records-list').innerHTML = `
                            <tr>
                                <td colspan="4" class="px-6 py-4 text-center text-red-500">e??a?�Da?��a??i??e??c�L?a??a??ec|</td>
                            </tr>
                        `;
                    }
                }
                
                function getStatusColor(statusText) {
                    const s = String(statusText || '').toLowerCase();
                    if (s.includes('上班') || s.includes('返回') || s.includes('在辦')) return 'bg-green-100 text-green-800';
                    if (s.includes('下班')) return 'bg-red-100 text-red-800';
                    if (s.includes('外出') || s.includes('抵達') || s.includes('離開')) return 'bg-blue-100 text-blue-800';
                    if (s.includes('請假')) return 'bg-orange-100 text-orange-800';
                    if (s.includes('特殊勤務')) return 'bg-indigo-100 text-indigo-800';
                    return 'bg-gray-100 text-gray-800';
                }
            }

            mainNav.addEventListener('click', (e) => {
                const tabButton = e.target.closest('.tab-btn');
                if (tabButton && !tabButton.classList.contains('active')) {
                    showPage(tabButton.dataset.tab);
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    tabButton.classList.add('active');
                }
            });

            // c�Foa??a?�La??a??a??a�?e??a??e?-a??a??e??e??e??a??e??a�?aooe3?a??
            document.getElementById('profile-avatar-btn').addEventListener('click', renderProfileModal);

            function showPage(pageName, subPage = null, params = {}) {
                cleanupListeners();
                state.currentLocation = null;
                state.trackingMap = null;
                state.trackingMarkers = [];
                mainContent.innerHTML = `<div class="flex justify-center items-center h-full"><div class="loader"></div></div>`;
                const router = {
                    'dashboard': renderDashboard,
                    'clock-in': () => renderClockIn(subPage || 'location'),
                    'tracking': () => ['admin','manager','hr'].includes(state.currentUserData.role) ? renderTracking(subPage || 'map') : renderAccessDenied(),
                    'features': () => renderFeatures(subPage || 'news'),
                    'other': () => state.currentUserData.role === 'field' ? renderOther(subPage || 'news') : renderAccessDenied(),
                    'calendar': () => renderCalendar(subPage || 'overview'),
                    'settings': () => state.currentUserData.role === 'admin' ? renderSettings(subPage || 'accounts') : renderAccessDenied(),
                    'hr': () => (state.currentUserData.role === 'admin' || state.currentUserData.role === 'hr') ? renderHR(subPage || 'attendance') : renderAccessDenied(),
                    'group': () => state.currentUserData.role === 'junior_manager' ? renderGroup(subPage || 'map') : renderAccessDenied()
                };
                const renderFunction = router[pageName] || renderAccessDenied;
                try {
                    renderFunction(params);
                } catch(e) {
                    console.error("Failed to render page:", e);
                    mainContent.innerHTML = `<div class="p-4 text-red-500">e??e?�Fe??a?�Da?��a??a�?</div>`;
                }
                lucide.createIcons();
            }

            function renderAccessDenied() {
                mainContent.innerHTML = `
                    <div class="p-8 text-center text-gray-500 flex flex-col items-center justify-center h-full">
                        <i data-lucide="ban" class="w-16 h-16 mx-auto mb-4"></i>
                        <h2 class="text-xl font-bold">a??e??a�M?e?3</h2>
                        <p>a?�La2?a??a??e??e�Laa??a-?e??e?�Fa�?</p>
                    </div>
                `;
            }

            // --- Page Render Functions ---
            
            function renderDashboard() {
                 mainContent.innerHTML = `
                    <div class="h-[50px] flex items-center justify-center border-b border-gray-200 bg-white">
                         <p id="current-time" class="text-lg font-semibold text-gray-700"></p>
                    </div>
                    <div class="p-4 overflow-y-auto" style="height: calc(100% - 50px);">
                        <div class="bg-white p-4 rounded-lg mb-4 shadow-sm border">
                            <h3 class="font-bold text-red-800 mb-2 flex items-center"><i data-lucide="user-circle" class="w-4 h-4 mr-2"></i>a??c??c?�a??</h3>
                            <div id="my-status" class="text-gray-600">eR�a??a�M-...</div>
                        </div>
                        <div id="all-users-summary-card" class="bg-white p-4 rounded-lg mb-4 shadow-sm border cursor-pointer">
                           <h3 class="font-bold text-gray-800 mb-2 flex items-center"><i data-lucide="users" class="w-4 h-4 mr-2"></i>a?�a??a??a??c?�a??</h3>
                           <div class="grid grid-cols-2 gap-2 text-gray-700">
                                <div><span class="text-green-600">a�M?c?-</span> : <span id="count-work">0</span> aoo</div>
                                <div><span class="text-blue-600">a??a?o</span> : <span id="count-outbound">0</span> aoo</div>
                                <div><span class="text-red-600">a�M?c?-</span> : <span id="count-off">0</span> aoo</div>
                                <div><span class="text-orange-600">e??a??</span> : <span id="count-leave">0</span> aoo</div>
                           </div>
                           <div class="text-xs text-gray-500 mt-2">e??a??a?�Dc??a?�a??a??a??c?�a??</div>
                       </div>
                    </div>
                `;
                lucide.createIcons();
                const timeEl = document.getElementById('current-time');
                const timerInterval = setInterval(() => {
                    if(timeEl){ timeEl.textContent = new Date().toLocaleString('zh-TW', { dateStyle: 'long', timeStyle: 'medium' }); }
                }, 1000);
                state.activeListeners.push(() => clearInterval(timerInterval));
                
                // aa�Fa?�Da?��a?|e!��c?oa?!a�P�Dc?�a??
                // aR?c?ce??ea?e�L-c?R
                const defaultSettings = {
                    showEmployeeStatus: true
                };
                
                // a??ec|a??a??a?�Xa-?a?2c?2a??e�L-c?R
                let localSettings;
                try {
                    const savedSettings = localStorage.getItem('app_general_settings');
                    localSettings = savedSettings ? JSON.parse(savedSettings) : defaultSettings;
                } catch (e) {
                    console.warn("Could not load settings from local storage:", e);
                    localSettings = defaultSettings;
                }
                
                // a??c?�La??a?�Xe�L-c?R
                if (localSettings.showEmployeeStatus === false) {
                    const container = document.getElementById('all-users-summary-card');
                    if (container) container.style.display = 'none';
                }
                
                // a??ec|a??Firebasec?2a??a?�a?�Xe�L-c?Ri??a??a�M?e??a!?UI
                try {
                    const settingsRef = doc(db, "settings", "general");
                    getDoc(settingsRef).then((docSnap) => {
                        if (docSnap.exists()) {
                            const settings = docSnap.data();
                            // a??a-?a?�Xa??a?�Xa-?a?2a?�Da??a�X?a??a??c?�L
                            localStorage.setItem('app_general_settings', JSON.stringify(settings));
                            
                            // a|?a??e�L-c?Re??a??a?�Xa�M?a??i??c??a?3a??c?�L
                            if (settings.showEmployeeStatus !== localSettings.showEmployeeStatus) {
                                const container = document.getElementById('all-users-summary-card');
                                if (container) {
                                    container.style.display = settings.showEmployeeStatus ? 'block' : 'none';
                                }
                            }
                    }
                }).catch(error => {
                    console.warn("Could not fetch latest settings, using local settings instead:", error);
                });
            } catch (error) {
                console.warn("Error in settings fetch attempt:", error);
            }

            // e??a??a??e|?a?!e??a??a?�a??a??a??c?�a??a??ca?
            const summaryCard = document.getElementById('all-users-summary-card');
            if (summaryCard) {
                summaryCard.addEventListener('click', () => {
                    openAllUsersStatusModal();
                });
            }
                
                const usersRef = collection(db, "users");
                const unsubscribe = onSnapshot(query(usersRef), (querySnapshot) => {
                    const countWorkEl = document.getElementById('count-work');
                    const countOutboundEl = document.getElementById('count-outbound');
                    const countOffEl = document.getElementById('count-off');
                    const countLeaveEl = document.getElementById('count-leave');
                    let myStatusFound = false;
                    const users = [];
                    querySnapshot.forEach(doc => users.push({id: doc.id, ...doc.data()}));
                    
                    // c?2a??e�L-aR?a�M-c??a?��e|?a??c?�Le�?e�L-aR?
                    let visibleUsers = {};
                    try {
                        const savedSettings = localStorage.getItem('app_general_settings');
                        if (savedSettings) {
                            const settings = JSON.parse(savedSettings);
                            visibleUsers = settings.visibleUsers || {};
                        }
                    } catch (e) {
                        console.warn("Could not load user visibility settings:", e);
                    }
                    
                    // e??a??a??a�M?e!��c?oc??a??c?�Le�?
                    const visibleUsersList = users.filter(user => visibleUsers[user.id] !== false);
                    
                    // 狀態優先級（自訂）：
                    // 1) 上班中-辦公室 2) 返回-辦公室 3) 外出-項目-地點 4) 抵達-項目-地點
                    // 5) 離開-項目-地點 6) 請假中 7) 已下班 其餘置後
                    const statusPriority = (user) => {
                        const locationText = user.clockInStatus === '外出' && user.outboundLocation ? user.outboundLocation : user.lastLocation;
                        const display = getStatusDisplayText(user.clockInStatus || '未打卡', locationText, user.dutyType);
                        let isLeave = (user.clockInStatus === '臨時請假') || (display.includes('請假'));
                        if (!isLeave) {
                            const leave = user.leaveStatus || '';
                            if (leave === 'approved' || leave === 'pending') {
                                const now = new Date();
                                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                                const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                                if (user.leaveStartTime && user.leaveEndTime) {
                                    const leaveStart = user.leaveStartTime.toDate ? user.leaveStartTime.toDate() : new Date(user.leaveStartTime);
                                    const leaveEnd = user.leaveEndTime.toDate ? user.leaveEndTime.toDate() : new Date(user.leaveEndTime);
                                    isLeave = leaveStart <= todayEnd && leaveEnd >= todayStart;
                                }
                            }
                        }

                        if (display.includes('上班') && (display.includes('辦公室') || display.includes('在辦公室'))) return 1;
                        if (display.includes('返回') && (display.includes('辦公室') || display.includes('在辦公室'))) return 2;
                        if (display.startsWith('外出-')) return 3;
                        if (display.startsWith('抵達-')) return 4;
                        if (display.startsWith('離開-')) return 5;
                        if (isLeave) return 6;
                        if (display.includes('已下班')) return 7;
                        return 8;
                    };

                    visibleUsersList.sort((a, b) => {
                        const prA = statusPriority(a);
                        const prB = statusPriority(b);
                        if (prA !== prB) return prA - prB;
                        const tA = a.lastUpdated ? (a.lastUpdated.toDate ? a.lastUpdated.toDate() : new Date(a.lastUpdated)) : new Date(0);
                        const tB = b.lastUpdated ? (b.lastUpdated.toDate ? b.lastUpdated.toDate() : new Date(b.lastUpdated)) : new Date(0);
                        if (tA.getTime() !== tB.getTime()) return tB - tA;
                        return a.name.localeCompare(b.name, 'zh-Hant');
                    }).forEach(user => {
                        const locationText = user.clockInStatus === 'a??a?o' && user.outboundLocation ? user.outboundLocation : user.lastLocation;
                        const statusText = getStatusDisplayText(user.clockInStatus || 'a?aa??a?!', locationText, user.dutyType);
                        const statusColor = getStatusColor(statusText);
                        if (user.id === state.currentUser.uid) {
                            myStatusFound = true;
                            (async () => {
                                try {
                                    const recordsRef = collection(db, 'clockInRecords');
                                    const q = query(recordsRef, where('userId', '==', state.currentUser.uid), orderBy('timestamp', 'desc'), limit(1));
                                    const snap = await getDocs(q);
                                    let innerHTML = '';
                                    if (!snap.empty) {
                                        const r = snap.docs[0].data();
                                        const statusTextLast = getStatusDisplayText(r.type || '未知', r.locationName || null, r.dutyType || null);
                                        const statusColorLast = getStatusColor(statusTextLast);
                                        const ts = r.timestamp && r.timestamp.toDate ? r.timestamp.toDate() : (r.timestamp ? new Date(r.timestamp) : null);
                                        innerHTML = `
                                          <div class="flex items-center justify-between">
                                            <span class="font-semibold text-lg ${statusColorLast}">${statusTextLast}</span>
                                          </div>
                                          <div class="text-sm text-gray-500 mt-1">
                                            ${ts ? '打卡 ' + ts.toLocaleString('zh-TW', {year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit'}) : ''}
                                          </div>`;
                                    } else {
                                        const statusTextLast = '尚未打卡';
                                        const statusColorLast = getStatusColor(statusTextLast);
                                        innerHTML = `
                                          <div class="flex items-center justify-between">
                                            <span class="font-semibold text-lg ${statusColorLast}">${statusTextLast}</span>
                                          </div>`;
                                    }
                                    document.getElementById('my-status').innerHTML = innerHTML;
                                } catch (err) {
                                    console.error('讀取最新打卡紀錄失敗', err);
                                }
                            })();
                        }
                    });

                   // e�L?cR?a??e|?aooa?�M
                   let countWork = 0, countOutbound = 0, countOff = 0, countLeave = 0;
                    const now = new Date();
                    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                   visibleUsersList.forEach(user => {
                       const s = user.clockInStatus || '';
                       const leave = user.leaveStatus || '';
                       if (s === 'a�M?c?-' || s === 'e??a??') countWork++;
                       else if (s === 'a??a?o' || s === 'a?�ge??' || s === 'e?�Fe??') countOutbound++;
                       else if (s === 'a�M?c?-' || s === 'a�P2a�M?c?--a?aa??a?!') countOff++;
                        
                        // aa�Fa?�De??a??c?�a??i??e?�La??e??a??a??c??a?ca??a??c??e??a??c?3e??
                        let isLeave = s === 'e?�La??e??a??';
                        if (!isLeave && (leave === 'approved' || leave === 'pending')) {
                            // aa�Fa?�Da?��a?|a??c??a?ca??a??c??e??a??e�L?e??
                            if (user.leaveStartTime && user.leaveEndTime) {
                                const leaveStart = user.leaveStartTime.toDate ? user.leaveStartTime.toDate() : new Date(user.leaveStartTime);
                                const leaveEnd = user.leaveEndTime.toDate ? user.leaveEndTime.toDate() : new Date(user.leaveEndTime);
                                isLeave = leaveStart <= todayEnd && leaveEnd >= todayStart;
                            }
                        }
                       if (isLeave) countLeave++;
                   });
                    if (countWorkEl) countWorkEl.textContent = countWork;
                    if (countOutboundEl) countOutboundEl.textContent = countOutbound;
                    if (countOffEl) countOffEl.textContent = countOff;
                    if (countLeaveEl) countLeaveEl.textContent = countLeave;
                    if(!myStatusFound && document.getElementById('my-status')){ document.getElementById('my-status').textContent = 'c?!a3?a??a??a?�Lc??c?�a??'; }
                    
                });
                state.activeListeners.push(unsubscribe);
            }

            // a?�a??a??a??c?�a??a??ca?
            function openAllUsersStatusModal() {
                // e??a?��
                const backdrop = document.createElement('div');
                backdrop.className = 'fixed inset-0 bg-black bg-opacity-50 z-40';
                backdrop.id = 'all-users-modal-backdrop';
                // aR1a?�L
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 z-50 flex items-center justify-center';
                modal.id = 'all-users-modal';
                const box = document.createElement('div');
                box.className = 'bg-white rounded-lg shadow-lg w-11/12 max-w-2xl p-4 border';
                box.innerHTML = `
                    <div class=\"flex items-center justify-between mb-2\">
                        <h3 class=\"font-bold text-lg flex items-center\"><i data-lucide=\"users\" class=\"w-5 h-5 mr-2\"></i>a?�a??a??a??c?�a??</h3>
                        <button id=\"close-all-users-modal\" class=\"text-gray-600 hover:text-gray-800\"><i data-lucide=\"x\" class=\"w-5 h-5\"></i></button>
                    </div>
                    <div id=\"all-users-modal-list\" class=\"space-y-2 max-h-[60vh] overflow-y-auto\">
                        <div class=\"text-center p-4 text-gray-500\">eR�a??a�M-...</div>
                    </div>
                `;
                modal.appendChild(box);
                document.body.appendChild(backdrop);
                document.body.appendChild(modal);
                lucide.createIcons();
                
                const usersRef = collection(db, 'users');
                const unsub = onSnapshot(query(usersRef), (querySnapshot) => {
                    const listEl = document.getElementById('all-users-modal-list');
                    if (!listEl) return;
                    listEl.innerHTML = '';
                    const users = [];
                    querySnapshot.forEach(doc => users.push({ id: doc.id, ...doc.data() }));
                    
                    // e!��c?oe�L-aR?e??a??
                    let visibleUsers = {};
                    try {
                        const savedSettings = localStorage.getItem('app_general_settings');
                        if (savedSettings) {
                            const settings = JSON.parse(savedSettings);
                            visibleUsers = settings.visibleUsers || {};
                        }
                    } catch (e) {
                        console.warn('Could not load user visibility settings:', e);
                    }
                    const visibleUsersList = users.filter(user => visibleUsers[user.id] !== false);
                    
                    // 排序：自訂狀態優先級 + 最近更新時間（新至舊） + 姓名
                    const statusPriority = (user) => {
                        const locationText = user.clockInStatus === '外出' && user.outboundLocation ? user.outboundLocation : user.lastLocation;
                        const display = getStatusDisplayText(user.clockInStatus || '未打卡', locationText, user.dutyType);
                        let isLeave = (user.clockInStatus === '臨時請假') || (display.includes('請假'));
                        if (!isLeave) {
                            const leave = user.leaveStatus || '';
                            if (leave === 'approved' || leave === 'pending') {
                                const now = new Date();
                                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                                const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                                if (user.leaveStartTime && user.leaveEndTime) {
                                    const leaveStart = user.leaveStartTime.toDate ? user.leaveStartTime.toDate() : new Date(user.leaveStartTime);
                                    const leaveEnd = user.leaveEndTime.toDate ? user.leaveEndTime.toDate() : new Date(user.leaveEndTime);
                                    isLeave = leaveStart <= todayEnd && leaveEnd >= todayStart;
                                }
                            }
                        }

                        if (display.includes('上班') && (display.includes('辦公室') || display.includes('在辦公室'))) return 1;
                        if (display.includes('返回') && (display.includes('辦公室') || display.includes('在辦公室'))) return 2;
                        if (display.startsWith('外出-')) return 3;
                        if (display.startsWith('抵達-')) return 4;
                        if (display.startsWith('離開-')) return 5;
                        if (isLeave) return 6;
                        if (display.includes('已下班')) return 7;
                        return 8;
                    };

                    visibleUsersList.sort((a, b) => {
                        const prA = statusPriority(a);
                        const prB = statusPriority(b);
                        if (prA !== prB) return prA - prB;
                        const tA = a.lastUpdated ? (a.lastUpdated.toDate ? a.lastUpdated.toDate() : new Date(a.lastUpdated)) : new Date(0);
                        const tB = b.lastUpdated ? (b.lastUpdated.toDate ? b.lastUpdated.toDate() : new Date(b.lastUpdated)) : new Date(0);
                        if (tA.getTime() !== tB.getTime()) return tB - tA;
                        return a.name.localeCompare(b.name, 'zh-Hant');
                    }).forEach(user => {
                        const locationText = user.clockInStatus === 'a??a?o' && user.outboundLocation ? user.outboundLocation : user.lastLocation;
                        const statusText = getStatusDisplayText(user.clockInStatus || 'a?aa??a?!', locationText, user.dutyType);
                        const statusColor = getStatusColor(statusText);
                        const timeFormatted = '讀取中...';
                        listEl.innerHTML += `
                            <div class=\"flex items-center justify-between bg-white p-3 rounded-md shadow-sm border\">
                                <div class=\"flex items-center\">
                                    <img src=\"${user.avatarUrl || `https://placehold.co/32x32/EFEFEF/333333?text=${user.name?.charAt(0) || 'U'}`}\" class=\"w-8 h-8 rounded-full mr-3 object-cover\">
                                    <div>
                                        <span class=\"font-medium text-gray-700\">${user.name || user.displayName || 'a?aa??a??'}</span>
                                        <div class=\"flex items-center mt-1\">
                                            <span class=\"text-sm font-semibold ${statusColor} mr-2\">${statusText}</span>
                                            <span class=\"text-xs text-gray-500\" id=\"clock-time-${user.id}\">${timeFormatted}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class=\"flex space-x-2\">
                                    ${user.lastPhotoUrl ? `<button class=\"view-photo-btn p-2 bg-blue-100 rounded-md\" data-photo=\"${user.lastPhotoUrl}\" data-desc=\"${user.lastLocation || ''}\"><i data-lucide=\"image\" class=\"w-6 h-6 text-blue-600\"></i></button>` : ''}
                                    ${user.lastLocation ? `<button class=\"view-map-btn p-2 bg-green-100 rounded-md\" data-lat=\"${user.lastLocation?.latitude || 0}\" data-lng=\"${user.lastLocation?.longitude || 0}\"><i data-lucide=\"map-pin\" class=\"w-6 h-6 text-green-600\"></i></button>` : ''}
                                </div>
                            </div>`;
                    });
                    // 更新每位使用者的最新打卡時間
                    try {
                        Promise.all(visibleUsersList.map(async (u) => {
                            try {
                                const qLatest = query(collection(db, 'clockInRecords'), where('userId', '==', u.id), orderBy('timestamp', 'desc'), limit(1));
                                const latestSnap = await getDocs(qLatest);
                                let dt = null;
                                if (!latestSnap.empty) {
                                    const ts = latestSnap.docs[0].data().timestamp;
                                    dt = ts?.toDate ? ts.toDate() : (ts ? new Date(ts) : null);
                                }
                                const el = document.querySelector(`#clock-time-${u.id}`);
                                if (el) {
                                    el.textContent = dt ? dt.toLocaleString('zh-TW', {year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'}) : 'N/A';
                                }
                            } catch (e) {
                                console.warn('載入使用者最新打卡失敗:', e);
                            }
                        }));
                    } catch (e) {
                        console.warn('更新最新打卡時間時發生錯誤:', e);
                    }
                    // c??aR?c?��c??e??a?�Xa??a??e??
                    document.querySelectorAll('#all-users-modal .view-photo-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const photoUrl = e.currentTarget.dataset.photo;
                            const description = e.currentTarget.dataset.desc;
                            if(photoUrl) openPhotoModal([photoUrl], [description]);
                            else showToast('c?!c?��c??a?��e!��c?o', true);
                        });
                    });
                    document.querySelectorAll('#all-users-modal .view-map-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const lat = parseFloat(e.currentTarget.dataset.lat);
                            const lng = parseFloat(e.currentTarget.dataset.lng);
                            if(lat && lng) openMapModal(lat, lng);
                            else showToast('c?!a??c?Re3?e�L?a?��e!��c?o', true);
                        });
                    });
                });
                
                function closeModal() {
                    try { unsub(); } catch {}
                    const m = document.getElementById('all-users-modal');
                    const b = document.getElementById('all-users-modal-backdrop');
                    if (m) document.body.removeChild(m);
                    if (b) document.body.removeChild(b);
                }
                document.getElementById('close-all-users-modal').addEventListener('click', closeModal);
                backdrop.addEventListener('click', closeModal);
            }

            function renderClockIn(subPage) {
                mainContent.innerHTML = `
                    <div class="h-[50px] flex items-center justify-around border-b border-gray-200 bg-white">
                        <button data-subtab="location" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'location' ? 'active' : ''}">aR?a??a??a?!</button>
                        <button data-subtab="records" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'records' ? 'active' : ''}">a??a?!c���e??</button>
                        <button data-subtab="leaves" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'leaves' ? 'active' : ''}">e??a??c���e??</button>
                    </div>
                    <div id="sub-page-content" class="overflow-y-auto" style="height: calc(100% - 50px);"></div>`;
                
                const subPageContent = document.getElementById('sub-page-content');
                if (subPage === 'location') {
                    renderClockInLocation(subPageContent);
                } else if (subPage === 'records') {
                    renderClockInRecords(subPageContent);
                } else if (subPage === 'leaves') {
                    renderMyLeaveRecords(subPageContent);
                }
                
                mainContent.querySelectorAll('.sub-tab-btn').forEach(btn => btn.addEventListener('click', () => showPage('clock-in', btn.dataset.subtab)));
            }

            function renderClockInLocation(container) {
                container.innerHTML = `
                    <div class="p-4 h-full flex flex-col">
                        <button id="relocate-btn" class="w-full bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-md hover:bg-gray-50 flex items-center justify-center mb-4">
                            <i data-lucide="locate-fixed" class="w-4 h-4 mr-2"></i>e??a?�XaR?a??
                        </button>
                        <div id="map-container" class="flex-grow rounded-lg overflow-hidden border border-gray-300 relative">
                             <div id="map" class="map-canvas"></div>
                             <div id="map-loader" class="absolute inset-0 bg-white/70 flex items-center justify-center"><div class="loader"></div></div>
                        </div>
                        <div id="status-display" class="mt-3 text-center font-semibold text-lg text-gray-700">
                            <span id="status-text">a�X?a?aa??a?!</span>
                        </div>
                        <div id="clock-in-buttons" class="grid grid-cols-2 gap-2 pt-4">
                            <!-- 第一列：上班/下班切換 與 外出循環 -->
                            <button id="work-toggle-btn" data-type="上班" class="clock-in-btn bg-green-500 text-white font-semibold py-3 px-4 rounded-md hover:bg-green-600">上班打卡</button>
                            <button id="outbound-cycle-btn" data-type="外出" class="clock-in-btn bg-blue-500 text-white font-semibold py-3 px-4 rounded-md hover:bg-blue-600">外出打卡</button>
                            <!-- 第二列：返回打卡 與 請假申請（寬度與外出一致，靠右） -->
                            <button id="return-btn" data-type="返回" class="clock-in-btn bg-gray-500 text-white font-semibold py-3 px-4 rounded-md hover:bg-gray-600">返回打卡</button>
                            <div class="flex">
                                <button data-type="臨時請假" id="temp-leave-btn" class="clock-in-btn w-full bg-orange-500 text-white font-semibold py-3 px-4 rounded-md hover:bg-orange-600">請假申請</button>
                            </div>
                        </div>
                    </div>`;
                lucide.createIcons();
                initClockInMap();

                document.getElementById('relocate-btn').addEventListener('click', initClockInMap);
                
                // a??a��?a??a??a?!c?�a??i??a?�LaR?a??a??a?!a-?e??a�M2a??aR?a??a??i??
                initClockInButtonStatus();
                updateStatusDisplay();
                
                // a??a?!a??e??e??a??ao?a??
                document.querySelectorAll('.clock-in-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        if (btn.classList.contains('disabled')) {
                            return;
                        }
                        
                        if (!state.currentLocation) {
                            alert("c?!a3?a??a??c?Ra??a??c?Ri??e??c�L?a??a??ec|");
                            return;
                        }
                        
                        const type = e.target.dataset.type;
                        
                        // a??a?oa??a?!e?�e|?a??e?�Ma?�Da?�Xe??
                        if (type === "a??a?o") {
                            // c?��a?�Da??e??a?�Xe??e?�Ma?�Da??ca?
                            const backdrop = document.createElement('div');
                            backdrop.id = 'modal-backdrop';
                            backdrop.className = 'fixed inset-0 bg-black bg-opacity-50 z-40';
                            backdrop.addEventListener('click', () => {
                                document.body.removeChild(backdrop);
                                document.body.removeChild(modal);
                            });
                            
                            // a?�ga?oa??ca?
                            const modal = document.createElement('div');
                            modal.id = 'location-input-modal';
                            modal.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg p-6 z-50 w-80';
                            
                            // a?�ga?oa�L?e!?
                            const title = document.createElement('h3');
                            title.className = 'text-lg font-semibold mb-4';
                            title.textContent = 'e??e?�Ma??a??a??e??c?Ra�M|e?�Ma?�Da??a?oa?�Xe??';

                            // a??a??e??c?Re?�Ma?R
                            const dutyContainer = document.createElement('div');
                            dutyContainer.className = 'mb-4';
                            const dutyLabel = document.createElement('label');
                            dutyLabel.className = 'block text-sm font-medium text-gray-700 mb-1';
                            dutyLabel.textContent = 'a??a??e??c?R';
                            const dutySelect = document.createElement('select');
                            dutySelect.id = 'outbound-duty-type';
                            dutySelect.className = 'w-full border border-gray-300 rounded-md p-2';
                            ['a??e!?c?�Ga��?','a??a??','a?�a?��','e?�La??a??','c�X!a?��','a??a??'].forEach(opt => {
                                const o = document.createElement('option');
                                o.value = opt;
                                o.textContent = opt;
                                dutySelect.appendChild(o);
                            });
                            dutyContainer.appendChild(dutyLabel);
                            dutyContainer.appendChild(dutySelect);

                            // a??a??a??a??e??c?Re?�Ma?�Da!?i??e??e�L-e?��e??i??
                            const otherDutyContainer = document.createElement('div');
                            otherDutyContainer.id = 'outbound-other-duty-container';
                            otherDutyContainer.className = 'mb-4 hidden';
                            const otherDutyLabel = document.createElement('label');
                            otherDutyLabel.className = 'block text-sm font-medium text-gray-700 mb-1';
                            otherDutyLabel.textContent = 'a??a??a??a??e??c?R';
                            const otherDutyInput = document.createElement('input');
                            otherDutyInput.id = 'outbound-other-duty';
                            otherDutyInput.type = 'text';
                            otherDutyInput.className = 'w-full border border-gray-300 rounded-md p-2';
                            otherDutyInput.placeholder = 'e??e?�Ma?�Da??a??e??c?R';
                            otherDutyContainer.appendChild(otherDutyLabel);
                            otherDutyContainer.appendChild(otherDutyInput);
                            
                            // a?�ga?oe?�Ma?�Da!?
                            const input = document.createElement('input');
                            input.id = 'outbound-location';
                            input.type = 'text';
                            input.className = 'w-full border border-gray-300 rounded-md p-2 mb-4';
                            input.placeholder = 'a??a|?i??aR�Fa??a??a?�Ma�?e??e?�Fc-?';
                            
                            // a?�ga?oa??e??aR1a?�L
                            const buttonContainer = document.createElement('div');
                            buttonContainer.className = 'flex justify-end space-x-2';
                            
                            // a??a??e??c?Ra??a??ao?a??i??e!��c?o/e?��e??a??a??e?�Ma?�Da!?i??
                            dutySelect && dutySelect.addEventListener('change', () => {
                                if (dutySelect.value === 'a??a??') {
                                    otherDutyContainer.classList.remove('hidden');
                                } else {
                                    otherDutyContainer.classList.add('hidden');
                                }
                            });
                            // a?�ga?oa??a??a??e??
                            const cancelButton = document.createElement('button');
                            cancelButton.className = 'px-4 py-2 bg-gray-200 text-gray-800 rounded-md';
                            cancelButton.textContent = 'a??a??';
                            cancelButton.addEventListener('click', () => {
                                document.body.removeChild(backdrop);
                                document.body.removeChild(modal);
                            });
                            
                            // a?�ga?oc�Foea?a??e??
                            const confirmButton = document.createElement('button');
                            confirmButton.className = 'px-4 py-2 bg-blue-500 text-white rounded-md';
                            confirmButton.textContent = 'c�Foea?';
                            confirmButton.addEventListener('click', () => {
                                const dutyTypeEl = document.getElementById('outbound-duty-type');
                                const dutyType = dutyTypeEl ? dutyTypeEl.value : '';
                                let dutyName = dutyType;
                                if (dutyType === 'a??a??') {
                                    const otherDuty = document.getElementById('outbound-other-duty').value.trim();
                                    if (!otherDuty) {
                                        alert('e??e?�Ma?�Da??a??e??c?R');
                                        return;
                                    }
                                    dutyName = otherDuty;
                                }
                                const locationText = document.getElementById('outbound-location').value.trim();
                                if (locationText) {
                                    state.outboundLocation = locationText;
                                    state.dutyType = dutyName;
                                    // a??a-?a?�Xe??a?�Xe�L-aR?c?? savedLocationsi??a?�a??10c-?i??
                                    try {
                                        if (!state.savedLocations) {
                                            state.savedLocations = [];
                                        }
                                        const exists = state.savedLocations.some(loc => loc === locationText);
                                        if (!exists) {
                                            state.savedLocations.push(locationText);
                                            if (state.savedLocations.length > 10) {
                                                state.savedLocations.shift();
                                            }
                                            // a??cR!c??a?!a?��a��?a?�D Firestorei??a�M�e??a??c?�Le�?a?1a-? localStorage
                                            const isAdmin = state.currentUserData && state.currentUserData.role === 'admin';
                                            const user = window.__auth?.currentUser;
                                            if (isAdmin && user) {
                                                const { updateDoc, doc } = window.__fs; const db = window.__db;
                                                updateDoc(doc(db, 'users', user.uid), { savedLocations: state.savedLocations })
                                                    .catch(err => console.warn('a??a-?a?�Xa?�a?�Xe�L-aR?a?��a??', err));
                                            } else {
                                                try {
                                                    const key = `saved_locations_${window.__auth?.currentUser?.uid || 'guest'}`;
                                                    localStorage.setItem(key, JSON.stringify(state.savedLocations));
                                                } catch (e) { console.warn('a??a-?a?�Xa?�a?�Xa??ac?a?��a??', e); }
                                            }
                                        }
                                    } catch (e) {
                                        console.warn('e??c?? savedLocations a?��a??', e);
                                    }
                                    // a??a-?a??a?oa?�Xe??a?�Xc3?c�g��a??c?Re�L-aR?i??otherLocationsi??i??a??cR!c??a?!a?�Pa??a��?a?�Da??e??
                                    try {
                                        const isAdmin = state.currentUserData && state.currentUserData.role === 'admin';
                                        const user = window.__auth?.currentUser; const db = window.__db; const { doc, getDoc, setDoc, arrayUnion, serverTimestamp } = window.__fs;
                                        if (isAdmin && user) {
                                            const settingsRef = doc(db, 'settings', 'location');
                                            // a��?a?oa??c?Rc?ca??
                                            const locEntry = {
                                                name: locationText,
                                                lat: (state.currentLocation && typeof state.currentLocation.lat === 'number') ? state.currentLocation.lat : null,
                                                lng: (state.currentLocation && typeof state.currentLocation.lng === 'number') ? state.currentLocation.lng : null,
                                                radius: 100
                                            };
                                            // a??eR�a??i??e??a??e??e??a??c�L��
                                            getDoc(settingsRef).then(docSnap => {
                                                const settings = docSnap.exists() ? docSnap.data() : {};
                                                const otherLocations = Array.isArray(settings.otherLocations) ? settings.otherLocations : [];
                                                const nameExists = otherLocations.some(l => (l && l.name) === locationText);
                                                if (!nameExists) {
                                                    setDoc(settingsRef, {
                                                        otherLocations: arrayUnion(locEntry),
                                                        updatedAt: serverTimestamp()
                                                    }, { merge: true }).catch(err => console.warn('a??a-?a??a??a??c?Ra?��a??', err));
                                                }
                                            }).catch(err => console.warn('eR�a??a??c?Re�L-aR?a?��a??', err));
                                        }
                                    } catch (e) {
                                        console.warn('e??c?? otherLocations a?��a??', e);
                                    }
                                    document.body.removeChild(backdrop);
                                    document.body.removeChild(modal);
                                    // a??e??c?�Mac?i??a?3e??c??a??a??c?Ra??a??a?oa?�Xe??a??c�L��i??e?�DaR?a??a?��a??a??a??c?�La??a??ao��a�L?
                                    if (state.currentLocation && typeof state.currentLocation.lat === 'number' && typeof state.currentLocation.lng === 'number') {
                                        openCameraModal(type, { ...state.currentLocation, name: locationText });
                                    } else {
                                        showToast('aR?a??e�?a??i??a�X?a?�Da?ac?�Da??c?Rc1?co?a??a?!i??c�L?a??a?��a??a-�Di??');
                                        openCameraModal(type, { lat: 0, lng: 0, name: locationText, isFallback: true });
                                    }
                                } else {
                                    alert('e??e?�Ma?�Da??a?oa?�Xe??');
                                }
                            });
                            
                            // c�g?e�G?a??ca?
                            buttonContainer.appendChild(cancelButton);
                            buttonContainer.appendChild(confirmButton);
                            modal.appendChild(title);
                            // a??a?�Da??a??e??c?Re?�Ma?Re??a??a??e?�Ma?�D
                            modal.appendChild(dutyContainer);
                            modal.appendChild(otherDutyContainer);
                            modal.appendChild(input);
                            modal.appendChild(buttonContainer);
                            
                            // a�P?a??a?�Xe??e?�F
                            document.body.appendChild(backdrop);
                            document.body.appendChild(modal);
                        } else if (type === "a?�ge??" || type === "e?�Fe??" || type === "e??a??") {
                            // a?�ge??a�?e?�Fe??a�?e??a??a??a?!a1?e?�e|?a??c?��
                            openCameraModal(type, state.currentLocation);
                        } else if (type === "e?�La??e??a??") {
                            // a�M?a?�Pe!?c?�Mac?a??a??
                        } else {
                            openCameraModal(type, state.currentLocation);
                        }
                    });
                });
                
                // e?�La??e??a??a??e??
                document.getElementById('temp-leave-btn').addEventListener('click', () => {
                    openTempLeaveModal();
                });
                
                // a�P2c��?e??c?1aR?a??a??a??e??
            }

            // a�?aooe??a??c���e??a-?e??c��?
            function renderMyLeaveRecords(container) {
                container.innerHTML = `
                    <div class="p-4 space-y-4">
                        <div class="flex flex-wrap items-center gap-4 mb-4">
                            <div class="flex items-center space-x-2">
                                <label for="my-leave-status-filter" class="text-sm font-medium">a��ca?�Mc?�a??:</label>
                                <select id="my-leave-status-filter" class="border border-gray-300 rounded-md px-2 py-1">
                                    <option value="all" selected>a?�Le?�L</option>
                                    <option value="pending">a??a��ca?�M</option>
                                    <option value="approved">a�P2a?�Ma??</option>
                                    <option value="rejected">a�P2a??c�g?</option>
                                </select>
                            </div>
                            <div class="flex items-center space-x-2">
                                <label for="my-leave-date-filter" class="text-sm font-medium">a?�Da??:</label>
                                <input type="date" id="my-leave-date-filter" class="border border-gray-300 rounded-md px-2 py-1" value="">
                            </div>
                            <button id="my-leave-search-btn" class="bg-blue-600 text-white px-3 py-1 rounded-md hover:bg-blue-700 flex items-center">
                                <i data-lucide="search" class="w-4 h-4 mr-1"></i>a??a�X?
                            </button>
                        </div>
                        <div class="bg-white rounded-lg shadow overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ao?c?��</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">e??a��?a??e??</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">c�g?a??a??e??</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">c?�a??</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">a??a??</th>
                                        </tr>
                                    </thead>
                                    <tbody id="my-leave-records-list" class="bg-white divide-y divide-gray-200">
                                        <tr>
                                            <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                                                <div class="flex items-center justify-center">
                                                    <i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i>
                                                    e??a?�Da�M-...
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div id="no-my-leave-records" class="hidden p-8 text-center text-gray-500 bg-white rounded-lg shadow">
                            <i data-lucide="calendar-off" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                            <p>a2?a??c?|a??a�F?a??c??e??a??e�L?e??</p>
                        </div>
                    </div>
                `;
                lucide.createIcons();

                const statusFilter = document.getElementById('my-leave-status-filter');
                const dateFilter = document.getElementById('my-leave-date-filter');
                const searchBtn = document.getElementById('my-leave-search-btn');

                // a??a��?a??e??
                loadMyLeaveRecords();

                searchBtn.addEventListener('click', loadMyLeaveRecords);

                function getStatusBadge(status) {
                    switch (status) {
                        case 'pending':
                            return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">a??a��ca?�M</span>';
                        case 'approved':
                            return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">a�P2a?�Ma??</span>';
                        case 'rejected':
                            return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">a�P2a??c�g?</span>';
                        case 'canceled':
                            return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-200 text-gray-700">a�P2a??a??</span>';
                        default:
                            return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">a?ac?�D</span>';
                    }
                }

                function loadMyLeaveRecords() {
                    const recordsList = document.getElementById('my-leave-records-list');
                    const noRecordsMsg = document.getElementById('no-my-leave-records');

                    recordsList.innerHTML = `
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                                <div class="flex items-center justify-center">
                                    <i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i>
                                    e??a?�Da�M-...
                                </div>
                            </td>
                        </tr>
                    `;
                    lucide.createIcons();

                    const status = statusFilter.value;
                    const date = dateFilter.value;

                    const user = window.__auth?.currentUser;
                    if (!user) {
                        recordsList.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-red-500">e??a??c??a?�Da?�Da?�Dc??e??a??c���e??</td></tr>';
                        return;
                    }
                    const db = window.__db; const { collection, where, query, getDocs } = window.__fs;
                    let q = query(collection(db, 'leaves'), where('userId', '==', user.uid));
                    if (status !== 'all') { q = query(q, where('status', '==', status)); }
                    // c��?e??a??ao?a?�De??a?? Firestore c���Fa??e?�a��?i??a?1c?�La??c?��a??ao?i??e?�De?�e|?i??

                    getDocs(q).then((querySnapshot) => {
                        if (querySnapshot.empty) {
                            recordsList.innerHTML = '';
                            noRecordsMsg.classList.remove('hidden');
                            return;
                        }

                        noRecordsMsg.classList.add('hidden');
                        recordsList.innerHTML = '';

                        const selectedDate = date ? new Date(date) : null;
                        let nextDay = null;
                        if (selectedDate) {
                            selectedDate.setHours(0, 0, 0, 0);
                            nextDay = new Date(selectedDate);
                            nextDay.setDate(nextDay.getDate() + 1);
                        }

                        let hasRecords = false;
                        const leaves = [];

                        querySnapshot.forEach((docSnap) => {
                            const leave = { id: docSnap.id, ...docSnap.data() };
                            leaves.push(leave);
                        });

                        // a??c?��e??a??e??a??ao?
                        const filtered = leaves.filter(leave => {
                            if (selectedDate && nextDay) {
                                const startTime = leave.startTime.toDate();
                                const endTime = leave.endTime.toDate();
                                return (startTime < nextDay && endTime > selectedDate);
                            }
                            return true;
                        }).sort((a, b) => {
                            const aTs = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : 0;
                            const bTs = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : 0;
                            return bTs - aTs;
                        });

                        filtered.forEach(leave => {
                            hasRecords = true;
                            const startTimeText = leave.startTime.toDate().toLocaleString('zh-TW');
                            const endTimeText = leave.endTime.toDate().toLocaleString('zh-TW');

                            const row = document.createElement('tr');
                            row.className = 'hover:bg-gray-50';
                            row.innerHTML = `
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">${leave.reason || 'c?!ao?c?��'}</div>
                                    <div class="text-xs text-gray-500">${leave.reasonType || ''}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">${startTimeText}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">${endTimeText}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    ${getStatusBadge(leave.status)}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    ${leave.status === 'pending' ? '<button class="cancel-leave-btn bg-gray-200 hover:bg-gray-300 text-gray-800 px-2 py-1 rounded text-xs" data-id="'+(leave.id||'')+'">a??a??</button>' : ''}
                                </td>
                            `;
                            recordsList.appendChild(row);
                        });

                        lucide.createIcons();

                        // c??aR?a??a??ao?a??i??a??e!��c?oa??a??a��ca?�Mi??
                        recordsList.querySelectorAll('.cancel-leave-btn').forEach(btn => {
                            btn.addEventListener('click', async (e) => {
                                const id = e.currentTarget.dataset.id;
                                if (!id) {
                                    showToast('c?!a3?e-?a?�Da??a?RID', true);
                                    return;
                                }
                                if (!confirm('c�FoaR?e|?a??a??e�?c-?a??a?Ra??i??')) return;
                                try {
                                    const db = window.__db; const { updateDoc, doc, serverTimestamp, Timestamp } = window.__fs; const user = window.__auth?.currentUser;
                                    await updateDoc(doc(db, 'leaves', id), { status: 'canceled', canceledAt: Timestamp.fromDate(new Date()) });
                                    if (user) {
                                        await updateDoc(doc(db, 'users', user.uid), {
                                            leaveStatus: 'canceled',
                                            status: 'a?aa??a?!',
                                            lastUpdated: serverTimestamp()
                                        });
                                    }
                                    showToast('a�P2a??a??a??a?R');
                                    loadMyLeaveRecords();
                                } catch (err) {
                                    console.error('a??a??a??a?Ra?��a??', err);
                                    showToast('a??a??a?��a??i??'+ (err.message||''), true);
                                }
                            });
                        });

                        if (!hasRecords) {
                            recordsList.innerHTML = '';
                            noRecordsMsg.classList.remove('hidden');
                        }
                    }).catch(error => {
                        console.error('c?2a??e??a??e�L?e??a?��a??:', error);
                        recordsList.innerHTML = `
                            <tr>
                                <td colspan="4" class="px-6 py-4 text-center text-red-500">
                                    eR�a??e�L?e??a?��a??i??e??c�L?a??a??ec|
                                </td>
                            </tr>
                        `;
                    });
                }
            }
            
            // e?�La??e??a??e!�La?R
            function openTempLeaveModal() {
                const modal = document.createElement('div');
                modal.className = 'modal fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50';
                modal.id = 'temp-leave-modal';
                
                const now = new Date();
                const todayStr = now.toISOString().split('T')[0];
                const currentHour = now.getHours();
                const defaultEndHour = Math.min(currentHour + 2, 23);
                
                modal.innerHTML = `
                    <div class="modal-content bg-white rounded-lg shadow-xl w-11/12 max-w-md mx-auto overflow-hidden">
                        <div class="modal-header bg-orange-500 text-white px-4 py-3 flex justify-between items-center">
                            <h3 class="text-lg font-semibold">e??a??c?3e??</h3>
                            <button class="modal-close text-white hover:text-gray-200">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <div class="modal-body p-4">
                            <form id="leave-form" class="space-y-4">
                                <div class="form-group">
                                    <label for="leave-reason-type" class="block text-sm font-medium text-gray-700 mb-1">e??a??ao?c?��</label>
                                    <select id="leave-reason-type" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500">
                                        <option value="c??a??">c??a??</option>
                                        <option value="ao?a??">ao?a??</option>
                                        <option value="a??a??">a??a??</option>
                                    </select>
                                </div>
                                
                                <div id="other-reason-container" class="form-group hidden">
                                    <label for="other-reason" class="block text-sm font-medium text-gray-700 mb-1">a??a??ao?c?��</label>
                                    <input type="text" id="other-reason" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="e??e?�Ma?�De??a??ao?c?��">
                                </div>
                                
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div class="form-group">
                                        <label for="leave-start-date" class="block text-sm font-medium text-gray-700 mb-1">e??a��?a?�Da??</label>
                                        <input type="date" id="leave-start-date" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500" value="${todayStr}">
                                    </div>
                                    <div class="form-group">
                                        <label for="leave-start-hour" class="block text-sm font-medium text-gray-700 mb-1">e??a��?a�X?a??</label>
                                        <input type="number" id="leave-start-hour" min="0" max="23" step="1" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500" value="${currentHour}">
                                    </div>
                                    <div class="form-group">
                                        <label for="leave-end-date" class="block text-sm font-medium text-gray-700 mb-1">c�g?a??a?�Da??</label>
                                        <input type="date" id="leave-end-date" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500" value="${todayStr}">
                                    </div>
                                    <div class="form-group">
                                        <label for="leave-end-hour" class="block text-sm font-medium text-gray-700 mb-1">c�g?a??a�X?a??</label>
                                        <input type="number" id="leave-end-hour" min="0" max="23" step="1" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-orange-500" value="${defaultEndHour}">
                                    </div>
                                </div>
                                
                                <div class="flex justify-end space-x-2 pt-2">
                                    <button type="button" id="leave-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">a??a??</button>
                                    <button type="submit" id="leave-submit-btn" class="px-4 py-2 bg-orange-500 text-white rounded-md hover:bg-orange-600">a??ao?c?3e??</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                lucide.createIcons();
                
                // ao?c?��e?�Ma??eR?a?��ao?a??
                const reasonTypeSelect = document.getElementById('leave-reason-type');
                const otherReasonContainer = document.getElementById('other-reason-container');
                
                reasonTypeSelect.addEventListener('change', () => {
                    if (reasonTypeSelect.value === 'a??a??') {
                        otherReasonContainer.classList.remove('hidden');
                    } else {
                        otherReasonContainer.classList.add('hidden');
                    }
                });
                
                // e??e??a??e??ao?a??
                document.querySelector('.modal-close').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                
                // a??a??a??e??ao?a??
                document.getElementById('leave-cancel-btn').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                
                // e!�La?Ra??ao?ao?a??
                document.getElementById('leave-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const reasonType = reasonTypeSelect.value;
                    let reason = reasonType;
                    
                    if (reasonType === 'a??a??') {
                        const otherReason = document.getElementById('other-reason').value.trim();
                        if (!otherReason) {
                            showToast('e??e?�Ma?�De??a??ao?c?��', true);
                            return;
                        }
                        reason = otherReason;
                    }
                    // a??a??a?�Da??e??a�X?a??i??c�g?a??c?oa??e??
                    const startDateStr = document.getElementById('leave-start-date').value;
                    const endDateStr = document.getElementById('leave-end-date').value;
                    const startHour = parseInt(document.getElementById('leave-start-hour').value, 10);
                    const endHour = parseInt(document.getElementById('leave-end-hour').value, 10);

                    if (!startDateStr || !endDateStr || isNaN(startHour) || isNaN(endHour)) {
                        showToast('e??e?�Ma??a??a??c??a?�Da??e??a�X?a??', true);
                        return;
                    }
                    const startTime = new Date(`${startDateStr}T00:00:00`);
                    startTime.setHours(startHour, 0, 0, 0);
                    const endTime = new Date(`${endDateStr}T00:00:00`);
                    endTime.setHours(endHour, 0, 0, 0);
                    
                    if (isNaN(startTime.getTime()) || isNaN(endTime.getTime())) {
                        showToast('e??e?�Ma??a??a??c??a??e??', true);
                        return;
                    }
                    
                    if (startTime >= endTime) {
                        showToast('c�g?a??a??e??a??e??a??a??e??a��?a??e??', true);
                        return;
                    }
                    
                    try {
                        showLoading(true);
                        
                        const db = window.__db; const { addDoc, collection, serverTimestamp, Timestamp, updateDoc, doc } = window.__fs; const user = window.__auth?.currentUser;
                        if (!user) throw new Error('a�X?a?ac??a?�D');
                        // a?�ga?oe??a??e�L?e??i??a?�Da�X?a??c?oa?Ra??i??
                        await addDoc(collection(db, 'leaves'), {
                            userId: user.uid,
                            userName: state.currentUserData?.name || '',
                            reason: reason,
                            reasonType: reasonType,
                            startTime: Timestamp.fromDate(startTime),
                            endTime: Timestamp.fromDate(endTime),
                            status: 'pending',
                            createdAt: serverTimestamp()
                        });
                        
                        // a?��a?�Xc?�La??c?�a??
                        await updateDoc(doc(db, 'users', user.uid), {
                            status: 'e??a??a�M-',
                            leaveStatus: 'pending',
                            lastUpdated: serverTimestamp()
                        });
                        
                        showToast('e??a??c?3e??a�P2a??ao?i??c-?a??a��ca?�M');
                        updateStatusDisplay();
                        document.body.removeChild(modal);
                    } catch (error) {
                        console.error('a??ao?e??a??c?3e??a?��a??:', error);
                        showToast('a??ao?e??a??c?3e??a?��a??i??e??c�L?a??a??ec|', true);
                    } finally {
                        showLoading(false);
                    }
                });
            }
            
            // c?1aR?a??a??e!�La?R
            function openSpecialDutyModal() {
                const modal = document.createElement('div');
                modal.className = 'modal fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50';
                modal.id = 'special-duty-modal';
                
                const now = new Date();
                const formattedNow = now.toISOString().slice(0, 16); // a??a??c?o YYYY-MM-DDTHH:MM
                const twoHoursLater = new Date(now);
                twoHoursLater.setHours(twoHoursLater.getHours() + 2);
                const formattedTwoHoursLater = twoHoursLater.toISOString().slice(0, 16);
                
                modal.innerHTML = `
                    <div class="modal-content bg-white rounded-lg shadow-xl w-11/12 max-w-md mx-auto overflow-hidden">
                        <div class="modal-header bg-purple-500 text-white px-4 py-3 flex justify-between items-center">
                            <h3 class="text-lg font-semibold">c?1aR?a??a??c??e�L?</h3>
                            <button class="modal-close text-white hover:text-gray-200">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <div class="modal-body p-4">
                            <form id="duty-form" class="space-y-4">
                                <div class="form-group">
                                    <label for="duty-type" class="block text-sm font-medium text-gray-700 mb-1">a??a??e??c?Ra??c�L��</label>
                                    <select id="duty-type" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                        <option value="a??e!?c?�Ga��?">a??e!?c?�Ga��?</option>
                                        <option value="c�X!a?��">c�X!a?��</option>
                                        <option value="a??a??">a??a??</option>
                                        <option value="a?�a?��">a?�a?��</option>
                                        <option value="e?�La??a??">e?�La??a??</option>
                                        <option value="a??a??">a??a??</option>
                                    </select>
                                </div>
                                
                                <div id="other-duty-container" class="form-group hidden">
                                    <label for="other-duty" class="block text-sm font-medium text-gray-700 mb-1">a??a??a??a??e??c?R</label>
                                    <input type="text" id="other-duty" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="e??e?�Ma?�Da??a??e??c?Ra??c�L��">
                                </div>
                                
                                <div class="form-group">
                                    <label for="duty-location" class="block text-sm font-medium text-gray-700 mb-1">a?�Xe??</label>
                                    <div class="flex space-x-2">
                                        <input type="text" id="duty-location" class="flex-grow border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="e??e?�Ma?�Da?�Xe??">
                                        <button type="button" id="map-location-btn" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 flex items-center justify-center">
                                            <i data-lucide="map-pin" class="w-5 h-5"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="duty-start-time" class="block text-sm font-medium text-gray-700 mb-1">e??a��?a??e??</label>
                                    <input type="datetime-local" id="duty-start-time" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" value="${formattedNow}">
                                </div>
                                
                                <div class="form-group">
                                    <label for="duty-end-time" class="block text-sm font-medium text-gray-700 mb-1">c�g?a??a??e??</label>
                                    <input type="datetime-local" id="duty-end-time" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" value="${formattedTwoHoursLater}">
                                </div>
                                
                                <div class="flex justify-end space-x-2 pt-2">
                                    <button type="button" id="duty-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">a??a??</button>
                                    <button type="submit" id="duty-submit-btn" class="px-4 py-2 bg-purple-500 text-white rounded-md hover:bg-purple-600">a??ao?c??e�L?</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                lucide.createIcons();
                
                // a??a??e??c?Re?�Ma??eR?a?��ao?a??
                const dutyTypeSelect = document.getElementById('duty-type');
                const otherDutyContainer = document.getElementById('other-duty-container');
                
                dutyTypeSelect.addEventListener('change', () => {
                    if (dutyTypeSelect.value === 'a??a??') {
                        otherDutyContainer.classList.remove('hidden');
                    } else {
                        otherDutyContainer.classList.add('hidden');
                    }
                });
                
                // a?�Xa??a??c?Ra??e??ao?a??
                document.getElementById('map-location-btn').addEventListener('click', () => {
                    if (state.currentLocation) {
                        // a??c?�La??a??a?�Xc??c�P�Lc�F?c?2a??a?�Xa?�
                        const geocoder = new google.maps.Geocoder();
                        const latlng = { lat: state.currentLocation.lat, lng: state.currentLocation.lng };
                        
                        geocoder.geocode({ location: latlng }, (results, status) => {
                            if (status === 'OK' && results[0]) {
                                document.getElementById('duty-location').value = results[0].formatted_address;
                            } else {
                                document.getElementById('duty-location').value = `${state.currentLocation.lat}, ${state.currentLocation.lng}`;
                            }
                        });
                    } else {
                        showToast('c?!a3?c?2a??c??a??a??c?R', true);
                    }
                });
                
                // e??e??a??e??ao?a??
                document.querySelector('.modal-close').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                
                // a??a??a??e??ao?a??
                document.getElementById('duty-cancel-btn').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                
                // e!�La?Ra??ao?ao?a??
                document.getElementById('duty-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const dutyType = dutyTypeSelect.value;
                    let dutyName = dutyType;
                    
                    if (dutyType === 'a??a??') {
                        const otherDuty = document.getElementById('other-duty').value.trim();
                        if (!otherDuty) {
                            showToast('e??e?�Ma?�Da??a??e??c?Ra??c�L��', true);
                            return;
                        }
                        dutyName = otherDuty;
                    }
                    
                    const location = document.getElementById('duty-location').value.trim();
                    if (!location) {
                        showToast('e??e?�Ma?�Da?�Xe??', true);
                        return;
                    }
                    
                    const startTime = new Date(document.getElementById('duty-start-time').value);
                    const endTime = new Date(document.getElementById('duty-end-time').value);
                    
                    if (isNaN(startTime.getTime()) || isNaN(endTime.getTime())) {
                        showToast('e??e?�Ma??a??a??c??a??e??', true);
                        return;
                    }
                    
                    if (startTime >= endTime) {
                        showToast('c�g?a??a??e??a??e??a??a??e??a��?a??e??', true);
                        return;
                    }
                    
                    try {
                        showLoading(true);
                        
                        const db = window.__db; const { addDoc, collection, Timestamp, serverTimestamp, updateDoc, doc } = window.__fs; const user = window.__auth?.currentUser;
                        if (!user) throw new Error('a�X?a?ac??a?�D');
                        // a?�ga?oc?1aR?a??a??e�L?e??
                        await addDoc(collection(db, 'specialDuties'), {
                            userId: user.uid,
                            userName: state.currentUserData?.name || '',
                            dutyName: dutyName,
                            dutyType: dutyType,
                            location: location,
                            startTime: Timestamp.fromDate(startTime),
                            endTime: Timestamp.fromDate(endTime),
                            createdAt: serverTimestamp()
                        });
                        
                        // a?��a?�Xc?�La??c?�a??
                        await updateDoc(doc(db, 'users', user.uid), {
                            status: `a?oa??-${dutyName}`,
                            lastUpdated: serverTimestamp()
                        });
                        
                        // a??a-?a?�Xe??a?�Xe�L-aR?
                        if (!state.savedLocations) {
                            state.savedLocations = [];
                        }
                        
                        // aa�Fa?�Da?��a?|a�P2a-?a?�Lc?�Ma??a?�Xe??
                        const locationExists = state.savedLocations.some(loc => loc === location);
                        if (!locationExists) {
                            state.savedLocations.push(location);
                            // a?�a??a??a-?10a�?a?�Xe??
                            if (state.savedLocations.length > 10) {
                                state.savedLocations.shift();
                            }
                            
                            // a??cR!c??a?!a?��a��?a?�D Firestorei??a�M�e??a??c?�Le�?a?1a-? localStorage
                            const isAdmin = state.currentUserData && state.currentUserData.role === 'admin';
                            if (isAdmin && user) {
                                await updateDoc(doc(db, 'users', user.uid), { savedLocations: state.savedLocations });
                            } else {
                                try {
                                    const key = `saved_locations_${user?.uid || 'guest'}`;
                                    localStorage.setItem(key, JSON.stringify(state.savedLocations));
                                } catch (e) { console.warn('a??a-?a?�Xa?�a?�Xa??ac?a?��a??', e); }
                            }
                        }
                        
                        showToast('c?1aR?a??a??a�P2c??e�L?');
                        updateStatusDisplay();
                        document.body.removeChild(modal);
                    } catch (error) {
                        console.error('a??ao?c?1aR?a??a??c??e�L?a?��a??:', error);
                        showToast('a??ao?c?1aR?a??a??c??e�L?a?��a??i??e??c�L?a??a??ec|', true);
                    } finally {
                        showLoading(false);
                    }
                });
            }

            function renderClockInRecords(container) {
                const today = new Date().toISOString().split('T')[0];
                container.innerHTML = `
                    <div class="p-4 space-y-4">
                        <div class="flex items-center space-x-2">
                            <label for="record-date" class="text-sm font-medium">c��ce?�Ma?�Da??:</label>
                            <input type="date" id="record-date" value="${today}" class="border border-gray-300 rounded-md px-2 py-1">
                        </div>
                        <div id="records-list" class="space-y-3">
                            <div class="text-center p-4 text-gray-500">a-�Ga?�LeR�a??c���e??...</div>
                        </div>
                    </div>
                `;

                const dateInput = document.getElementById('record-date');
                const loadRecords = () => {
                    const selectedDate = new Date(dateInput.value);
                    const startOfDay = new Date(selectedDate);
                    startOfDay.setHours(0, 0, 0, 0);
                    const endOfDay = new Date(selectedDate);
                    endOfDay.setHours(23, 59, 59, 999);
                    
                    const recordsRef = collection(db, "clockInRecords");
                    // a??a??a??c?�Le�?a?�Dec�Fi??e??a??e??a??c���Fa??e?�a��?i??a?�Da??a?�La??c?��e??a??
                    const q = query(recordsRef, where("userId", "==", state.currentUser.uid));

                    const unsubscribe = onSnapshot(q, (querySnapshot) => {
                        const recordsListEl = document.getElementById('records-list');
                        if (!recordsListEl) return;
                        
                        if (querySnapshot.empty) {
                            recordsListEl.innerHTML = `<p class="text-center text-gray-500 p-4">a??a?�Dc?!a??a?!c���e??</p>`;
                            return;
                        }
                        
                        const records = [];
                        querySnapshot.forEach(doc => {
                            records.push({ id: doc.id, ...doc.data() });
                        });
                        
                        // a??c?��a?�Da??e??a??e??a??e??e??ao?a??ao?
                        const filtered = records.filter(r => {
                            const ts = r.timestamp?.toDate?.() || (r.timestamp ? new Date(r.timestamp) : null);
                            if (!ts) return false;
                            return ts >= startOfDay && ts <= endOfDay;
                        }).sort((a, b) => {
                            const timeA = a.timestamp?.toDate?.() || (a.timestamp ? new Date(a.timestamp) : new Date(0));
                            const timeB = b.timestamp?.toDate?.() || (b.timestamp ? new Date(b.timestamp) : new Date(0));
                            return timeB - timeA;
                        });
                        
                        recordsListEl.innerHTML = '';
                        filtered.forEach(record => {
                            const card = document.createElement('div');
                            card.className = 'bg-white p-3 rounded-lg shadow-sm border mb-3';
const statusText = getStatusDisplayText(record.type || '未知', record.locationName || null, record.dutyType || null);
                            const statusColor = getStatusColor(statusText);
                            card.innerHTML = `
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-bold text-lg ${statusColor}">${statusText}</p>
                                        <p class="text-sm text-gray-600">${formatDate(record.timestamp)}</p>
                                    </div>
                                    <button class="map-btn bg-blue-500 text-white px-2 py-1 rounded text-sm" data-lat="${record.location?.latitude || 0}" data-lng="${record.location?.longitude || 0}">
                                        <i data-lucide="map-pin"></i> a?�Xa??
                                    </button>
                                </div>
                                <div class="mt-2 flex space-x-2 overflow-x-auto">
                                    <button class="photo-btn bg-green-500 text-white px-2 py-1 rounded text-sm" 
                                        data-photos='${encodeURIComponent(JSON.stringify(record.photoUrls || []))}' 
                                        data-descriptions='${encodeURIComponent(JSON.stringify(record.descriptions || []))}'>
                                        <i data-lucide="image"></i> c?��c?? (${(record.photoUrls?.length || 0)})
                                    </button>
                                </div>
                            `;
                            recordsListEl.appendChild(card);
                        });
                         
                        lucide.createIcons();
                        
                        document.querySelectorAll('.map-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const lat = parseFloat(e.currentTarget.dataset.lat);
                                const lng = parseFloat(e.currentTarget.dataset.lng);
                                if(lat && lng) openMapModal(lat, lng);
                                else showToast("c?!a??c?Re3?e�L?a?��e!��c?o", true);
                            });
                        });
                        
                        document.querySelectorAll('.photo-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const photos = JSON.parse(decodeURIComponent(e.currentTarget.dataset.photos || '%5B%5D'));
                                const descriptions = JSON.parse(decodeURIComponent(e.currentTarget.dataset.descriptions || '%5B%5D'));
                                openPhotoModal(photos, descriptions);
                            });
                        });
                    }, (error) => {
                        console.error("Error fetching records: ", error);
                        const recordsListEl = document.getElementById('records-list');
                        if (recordsListEl) {
                             recordsListEl.innerHTML = `<div class="text-center text-red-500 p-4">eR�a??c���e??a?��a??a�?e??c�Foea?a?�Lc?? Firestore aR?a?�Le|?a??a?��a?|a-�Gc�Foa�?</div>`;
                        }
                    });

                    state.activeListeners.push(unsubscribe);
                };

                dateInput.addEventListener('change', loadRecords);
                loadRecords();
            }

            async function initClockInMap() {
                const mapLoader = document.getElementById('map-loader');
                const mapDiv = document.getElementById('map');
                if(!mapDiv || !mapLoader) return;
                
                mapLoader.classList.remove('hide');
                state.currentLocation = null;
                
                if (!window.google || !window.google.maps) {
                    setTimeout(initClockInMap, 100);
                    return;
                }
                
                try {
                    const pos = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, { 
                            enableHighAccuracy: true, 
                            timeout: 10000, 
                            maximumAge: 0 
                        });
                    });
                    
                    const coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    state.currentLocation = coords;
                    
                    if (mapDiv.offsetWidth === 0 || mapDiv.offsetHeight === 0) {
                        mapDiv.style.width = '100%';
                        mapDiv.style.height = '300px';
                    }
                    
                    const map = new google.maps.Map(mapDiv, { 
                        center: coords, 
                        zoom: 17, 
                        disableDefaultUI: true 
                    });
                    
                    new google.maps.Marker({ 
                        position: coords, 
                        map: map 
                    });
                    
                    mapLoader.classList.add('hide');
                } catch (error) {
                    console.error("a??a��?a??a?�Xa??a??c??c??e?��ea?:", error);
                    mapDiv.innerHTML = `<div class="p-4 text-center text-red-500">c?!a3?a??a??a?�Lc??a??c?Ra�?e??c�Foea?a�P2e??a??aR?a??a??a??a�?</div>`;
                    mapLoader.classList.add('hide');
                    showToast("c?!a3?a??a??a??c?Re3?e�L?i??e??c�Foea?a�P2e??a??aR?a??a??a??", true);
                }
            }
            
            function renderTracking(subPage) {
                mainContent.innerHTML = `
                    <div class="h-[50px] flex items-center justify-around border-b border-gray-200 bg-white">
                        <button data-subtab="map" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'map' || !subPage ? 'active' : ''}">aooa?!a?�Xa??</button>
                        <button data-subtab="attendance" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'attendance' ? 'active' : ''}">a?oa??c���e??</button>
                        <button data-subtab="leave" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'leave' ? 'active' : ''}">a??a?Ra��ca?�M</button>
                        <button data-subtab="devices" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'devices' ? 'active' : ''}">a??a?!e�G?c?R</button>
                    </div>
                    <div id="sub-page-content" class="overflow-y-auto" style="height: calc(100% - 50px);"></div>`;
                
                const subPageContent = document.getElementById('sub-page-content');
                if (subPage === 'attendance') {
                    renderTrackingAttendance(subPageContent);
                } else if (subPage === 'leave') {
                    renderTrackingLeave(subPageContent);
                } else if (subPage === 'devices') {
                    renderTrackingDevices(subPageContent);
                } else {
                    renderTrackingMap(subPageContent);
                }
                
                mainContent.querySelectorAll('.sub-tab-btn').forEach(btn => btn.addEventListener('click', () => showPage('tracking', btn.dataset.subtab)));
            }

            // aooao?a??e??i??a?oa??a??e!�La�?e??a??a??e!�L
            function renderHR(subPage) {
                mainContent.innerHTML = `
                    <div class="h-[50px] flex items-center justify-around border-b border-gray-200 bg-white">
                        <button data-subtab="attendance" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'attendance' ? 'active' : ''}">a?oa??a??e!�L</button>
                        <button data-subtab="leave" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'leave' ? 'active' : ''}">e??a??a??e!�L</button>
                    </div>
                    <div id="sub-page-content" class="overflow-y-auto" style="height: calc(100% - 50px);"></div>`;

                const subPageContent = document.getElementById('sub-page-content');
                if (subPage === 'leave') {
                    renderTrackingLeave(subPageContent);
                } else {
                    renderTrackingAttendance(subPageContent);
                }
                mainContent.querySelectorAll('.sub-tab-btn').forEach(btn => btn.addEventListener('click', () => showPage('hr', btn.dataset.subtab)));
            }

            // c??c�g?a??e??i??aooa?!a?�Xa??a�?a?oa??c���e??i??a??e!��c?oa??aR?a??a?!i??
            function renderGroup(subPage) {
                mainContent.innerHTML = `
                    <div class="h-[50px] flex items-center justify-around border-b border-gray-200 bg-white">
                        <button data-subtab="map" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'map' || !subPage ? 'active' : ''}">aooa?!a?�Xa??</button>
                        <button data-subtab="attendance" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'attendance' ? 'active' : ''}">a?oa??c���e??</button>
                    </div>
                    <div id="sub-page-content" class="overflow-y-auto" style="height: calc(100% - 50px);"></div>`;

                const subPageContent = document.getElementById('sub-page-content');
                if (subPage === 'attendance') {
                    renderGroupAttendance(subPageContent);
                } else {
                    renderGroupMap(subPageContent);
                }
                mainContent.querySelectorAll('.sub-tab-btn').forEach(btn => btn.addEventListener('click', () => showPage('group', btn.dataset.subtab)));
            }

            function renderGroupMap(container) {
                container.innerHTML = `
                    <div class="h-full w-full relative">
                        <div id="group-map" class="h-full w-full"></div>
                        <div id="group-map-loader" class="absolute inset-0 bg-white/70 flex items-center justify-center"><div class="loader"></div></div>
<button id="group-map-center-btn" class="absolute top-3 right-3 z-10 bg-white text-gray-700 border border-gray-300 rounded-full shadow px-3 py-2 flex items-center hover:bg-gray-50">
                            <i data-lucide="focus" class="w-4 h-4 mr-2"></i>回到公司
                        </button>
                        <div class="absolute bottom-0 left-0 right-0 p-2">
                            <div id="group-user-list" class="bg-white/90 backdrop-blur-sm rounded-lg shadow-lg max-h-[150px] overflow-y-auto p-2 space-y-2"></div>
                        </div>
                    </div>
                `;
                try { lucide.createIcons(); } catch(e) {}
                if (state.googleMapsLoaded) {
                    initGroupMap();
                } else {
                    const interval = setInterval(() => {
                        if (state.googleMapsLoaded) { clearInterval(interval); initGroupMap(); }
                    }, 100);
                }
            }

            async function initGroupMap() {
                const mapDiv = document.getElementById('group-map');
                const mapLoader = document.getElementById('group-map-loader');
                if (!mapDiv || !mapLoader) return;
                let mapCenter = { lat: 25.0330, lng: 121.5654 };
                try {
                    const docSnap = await getDoc(doc(db, "settings", "location"));
                    if (docSnap.exists()) {
                        const s = docSnap.data();
                        if (typeof s.companyLat === 'number' && typeof s.companyLng === 'number') {
                            mapCenter = { lat: s.companyLat, lng: s.companyLng };
                        }
                    }
                } catch (e) { console.warn("載入公司位置失敗，使用預設中心點", e); }
                state.groupMap = new google.maps.Map(mapDiv, { center: mapCenter, zoom: 12, disableDefaultUI: true, zoomControl: true, mapId: 'DEMO_MAP_ID' });
                state.companyCenter = mapCenter;
                const centerBtn = document.getElementById('group-map-center-btn');
                if (centerBtn) {
                    centerBtn.addEventListener('click', () => {
                        if (state.companyCenter) {
                            state.groupMap.panTo(state.companyCenter);
                            state.groupMap.setZoom(14);
                        } else {
                            showToast('尚未設定公司座標', true);
                        }
                    });
                }
                mapLoader.classList.add('hide');
                listenForGroupUserLocations();
            }

            async function listenForGroupUserLocations() {
                const allowedUserIds = await loadJuniorManagerAllowedUsers(state.currentUserData.id);
                const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
                const usersRef = collection(db, "users");
                const q = query(usersRef, orderBy("name"));
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    const listEl = document.getElementById('group-user-list');
                    if (!listEl) return;
                    listEl.innerHTML = '';
                    if (!Array.isArray(allowedUserIds) || allowedUserIds.length === 0) {
                        listEl.innerHTML = `<p class="text-center text-gray-500 p-2">a�X?a?ac?��cR!c??a?!e�L-aR?a?��a?�Dc??aooa?!</p>`;
                        return;
                    }
                    // a�M?e??e??a�L?e�L?
                    (state.groupMarkers || []).forEach(m => m.map = null);
                    state.groupMarkers = [];

                    const users = [];
                    querySnapshot.forEach(doc => { const data = { id: doc.id, ...doc.data() }; if (allowedUserIds.includes(data.id)) users.push(data); });
                    users.forEach(user => {
                        const hasLocation = user.lastLocation && user.lastLocation.latitude;
                        const userElement = document.createElement('div');
                        userElement.className = `flex items-center justify-between p-2 rounded-md cursor-pointer hover:bg-gray-100 ${!hasLocation ? 'opacity-50' : ''}`;
                        userElement.innerHTML = `
                            <div class="flex items-center">
                                <img src="${user.avatarUrl || `https://placehold.co/32x32/EFEFEF/333333?text=${user.name.charAt(0)}`}" class="w-8 h-8 rounded-full mr-3 object-cover">
                                <div>
                                    <p class="font-medium text-sm text-gray-800">${user.name}</p>
<p class="text-xs text-gray-500">${getStatusDisplayText(user.status, user.lastLocation?.address, user.dutyType) || 'a?aa??a?!'}</p>
                                </div>
                            </div>
                            <span class="text-xs text-gray-400">${user.lastClockInTime ? 'a?�e??c?�a??a??e??i??' + timeAgo(user.lastClockInTime.toDate()) : 'c?!c���e??'}</span>
                        `;
                        listEl.appendChild(userElement);
                        if (hasLocation) {
                            const position = { lat: user.lastLocation.latitude, lng: user.lastLocation.longitude };
                            const markerIcon = document.createElement('img');
                            markerIcon.src = user.avatarUrl || `https://placehold.co/40x40/EFEFEF/333333?text=${user.name.charAt(0)}`;
                            markerIcon.className = "w-9 h-9 rounded-full border-2 border-white shadow-md object-cover";
                            const marker = new AdvancedMarkerElement({ position, map: state.groupMap, title: user.name, content: markerIcon });
                            const infoWindow = new google.maps.InfoWindow({ content: `
                                <div class="p-1">
                                    <p class="font-bold">${user.name}</p>
<p>c?�a??: ${getStatusDisplayText(user.status, user.lastLocation?.address, user.dutyType)}</p>
                                    <p>a?�e??c?�a??a??e??: ${user.lastClockInTime ? formatDateTime(user.lastClockInTime) : 'N/A'}</p>
                                </div>` });
                            marker.addListener('click', () => infoWindow.open({ anchor: marker, map: state.groupMap }));
                            userElement.addEventListener('click', () => { state.groupMap.panTo(position); state.groupMap.setZoom(17); infoWindow.open({ anchor: marker, map: state.groupMap }); });
                            state.groupMarkers.push(marker);
                        }
                    });
                });
                state.activeListeners.push(unsubscribe);
            }

            function renderGroupAttendance(container) {
                container.innerHTML = `
                    <div class="p-4 space-y-4">
                        <div class="flex flex-wrap items-center gap-4 mb-4">
                            <div class="flex items-center space-x-2">
                                <label for="group-user-select" class="text-sm font-medium">e?�Ma??aooa?!:</label>
                                <select id="group-user-select" class="border border-gray-300 rounded-md px-2 py-1">
                                    <option value="all">c?��cR!c??a?!a??aR?a??a?R</option>
                                </select>
                            </div>
                            <div class="flex items-center space-x-2">
                                <label for="group-record-date" class="text-sm font-medium">e?�Ma??a?�Da??:</label>
                                <input type="date" id="group-record-date" value="${new Date().toISOString().split('T')[0]}" class="border border-gray-300 rounded-md px-2 py-1">
                            </div>
                        </div>
                        <div id="group-attendance-records-list" class="space-y-3">
                            <div class="text-center p-4 text-gray-500">a-�Ga?�LeR�a??c���e??...</div>
                        </div>
                    </div>`;

                const userSelect = document.getElementById('group-user-select');
                const dateInput = document.getElementById('group-record-date');

                loadJuniorManagerAllowedUsers(state.currentUserData.id).then(ids => {
                    if (!ids || ids.length === 0) return;
                    const usersRef = collection(db, "users");
                    getDocs(usersRef).then((qs) => {
                        const users = [];
                        qs.forEach(doc => { const d = { id: doc.id, ...doc.data() }; if (ids.includes(d.id)) users.push(d); });
                        users.sort((a,b) => a.name.localeCompare(b.name, 'zh-Hant')).forEach(u => {
                            const opt = document.createElement('option'); opt.value = u.id; opt.textContent = u.name; userSelect.appendChild(opt);
                        });
                        const loadRecords = () => renderAttendanceRecordsList('group-attendance-records-list', userSelect.value, dateInput.value, ids);
                        userSelect.addEventListener('change', loadRecords);
                        dateInput.addEventListener('change', loadRecords);
                        loadRecords();
                    });
                });
            }

            // a?��c?�Li??a?oa??c���e??a??e!�La�M2a??i??a?��a?��a??aR?c?�La??c??a??a?Ri??
            async function renderAttendanceRecordsList(containerId, selectedUserId, selectedDateStr, allowedUserIds = null) {
                const isAdmin = await (window.checkAdminStatus ? window.checkAdminStatus() : Promise.resolve(false));
                const container = document.getElementById(containerId);
                const selectedDate = new Date(selectedDateStr);
                const startOfDay = new Date(selectedDate);
                startOfDay.setHours(0, 0, 0, 0);
                const endOfDay = new Date(selectedDate);
                endOfDay.setHours(23, 59, 59, 999);
                const recordsRef = collection(db, 'clockInRecords');
                const { Timestamp } = window.__fs || {};
                const startTS = Timestamp?.fromDate ? Timestamp.fromDate(startOfDay) : startOfDay;
                const endTS = Timestamp?.fromDate ? Timestamp.fromDate(endOfDay) : endOfDay;
                let q;
                if (selectedUserId === 'all') {
                    q = query(recordsRef, where('timestamp', '>=', startTS), where('timestamp', '<=', endTS));
                } else {
                    q = query(recordsRef, where('userId', '==', selectedUserId), where('timestamp', '>=', startTS), where('timestamp', '<=', endTS));
                }

                container.innerHTML = `<div class="text-center p-4 text-gray-500">a-�Ga?�LeR�a??c���e??...</div>`;
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    container.innerHTML = `<p class="text-center text-gray-500 p-4">c?!a??a?!c���e??</p>`;
                    return;
                }
                const records = [];
                querySnapshot.forEach(doc => records.push({ id: doc.id, ...doc.data() }));
                const usersRef = collection(db, 'users');
                const usersSnapshot = await getDocs(usersRef);
                const usersMap = {};
                usersSnapshot.forEach(doc => { usersMap[doc.id] = doc.data().name; });

                container.innerHTML = '';
                records
                    .filter(r => !allowedUserIds || allowedUserIds.includes(r.userId))
                    .sort((a,b) => {
                        const timeA = a.timestamp?.toDate?.() || new Date(0);
                        const timeB = b.timestamp?.toDate?.() || new Date(0);
                        return timeB - timeA;
                    })
                    .forEach(record => {
                        const time = record.timestamp?.toDate?.() || new Date();
                        const userName = usersMap[record.userId] || 'a?ac?�Dc?�La??';
                        const card = document.createElement('div');
                        card.className = 'bg-white p-4 rounded-lg shadow border border-gray-200';
                        card.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="font-semibold">${userName}</div>
                                    <div class="text-sm text-gray-500">${time.toLocaleString('zh-TW')}</div>
                                    <div class="mt-1 flex items-center">
<span class="px-2 py-0.5 rounded text-sm ${getStatusBgColor(getStatusDisplayText(record.type || '未知', record.locationName || null, record.dutyType || null))}">${getStatusDisplayText(record.type || '未知', record.locationName || null, record.dutyType || null)}</span>
                        ${record.location && typeof record.location.latitude === 'number' && typeof record.location.longitude === 'number' ? `<span class="ml-2 text-sm text-gray-500">${record.location.latitude.toFixed(6)}, ${record.location.longitude.toFixed(6)}</span>` : ''}
                                    </div>
                                    <div class="mt-1 text-xs text-gray-500">裝置ID: ${record.deviceId || '未知'}</div>
                                </div>
                                <div class="flex space-x-2">
                                    ${record.location ? `
                                        <button class="map-btn bg-green-500 text-white px-2 py-1 rounded text-sm" 
                                            data-lat="${record.location.latitude}" 
                                            data-lng="${record.location.longitude}">
                                            <i data-lucide="map-pin"></i> 地圖
                                        </button>
                                    ` : ''}
                                    <button 
                                        class="edit-record-btn bg-yellow-500 text-white px-2 py-1 rounded text-sm"
                                        data-id="${record.id}"
                                        data-type="${record.type || ''}"
                                        data-time="${(time instanceof Date ? time : new Date()).toISOString()}"
                                        data-lat="${record.location && typeof record.location.latitude === 'number' ? record.location.latitude : ''}"
                                        data-lng="${record.location && typeof record.location.longitude === 'number' ? record.location.longitude : ''}"
                                        data-location-name="${record.locationName || ''}"
                                        data-duty-type="${record.dutyType || ''}"
                                    >
                                        <i data-lucide="pencil"></i> 編輯
                                    </button>
                                    <button 
                                        class="delete-record-btn bg-red-500 text-white px-2 py-1 rounded text-sm"
                                        data-id="${record.id}"
                                    >
                                        <i data-lucide="trash"></i> 刪除
                                    </button>
                                </div>
                            </div>
                            <div class="mt-2 flex space-x-2 overflow-x-auto">
                                ${record.photoUrls && record.photoUrls.length > 0 ? `
                                            <button class="photo-btn bg-blue-500 text-white px-2 py-1 rounded text-sm" 
                                        data-photos='${encodeURIComponent(JSON.stringify(record.photoUrls || []))}' 
                                        data-descriptions='${encodeURIComponent(JSON.stringify(record.descriptions || []))}'>
                                        <i data-lucide="image"></i> c?��c?? (${record.photoUrls.length})
                                    </button>
                                ` : ''}
                            </div>
                        `;
                        container.appendChild(card);
                        if (!isAdmin) {
                            card.querySelectorAll('.edit-record-btn, .delete-record-btn').forEach(btn => btn.remove());
                        }
                    });
                lucide.createIcons();
                container.querySelectorAll('.map-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const lat = parseFloat(e.currentTarget.dataset.lat);
                        const lng = parseFloat(e.currentTarget.dataset.lng);
                        if(lat && lng) openMapModal(lat, lng);
                        else showToast('c?!a??c?Re3?e�L?a?��e!��c?o', true);
                    });
                });
                container.querySelectorAll('.photo-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const photos = JSON.parse(decodeURIComponent(e.currentTarget.dataset.photos || '%5B%5D'));
                        const descriptions = JSON.parse(decodeURIComponent(e.currentTarget.dataset.descriptions || '%5B%5D'));
                        openPhotoGalleryModal(photos, descriptions);
                    });
                });
                container.querySelectorAll('.edit-record-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const d = e.currentTarget.dataset;
                        openEditRecordModal({
                            id: d.id,
                            type: d.type,
                            timeISO: d.time,
                            lat: d.lat ? parseFloat(d.lat) : null,
                            lng: d.lng ? parseFloat(d.lng) : null,
                            locationName: d.locationName || '',
                            dutyType: d.dutyType || ''
                        });
                    });
                });
                container.querySelectorAll('.delete-record-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const id = e.currentTarget.dataset.id;
                        if (!id) return;
                        const ok = window.confirm('確認刪除此筆出勤紀錄？此操作無法復原');
                        if (!ok) return;
                        try {
                            const db = window.__db; const { deleteDoc, doc } = window.__fs;
                            await deleteDoc(doc(db, 'clockInRecords', id));
                            showToast('刪除成功');
                        } catch (err) {
                            console.error('delete clockInRecord error', err);
                            showToast('刪除失敗：請檢查權限或網路', true);
                        }
                    });
                });
            }

            // eR�a??a??e??a�M?cR!a?��e|?c?�La??e�L-aR?
            async function loadJuniorManagerAllowedUsers(managerUserId) {
                try {
                    const docRef = doc(db, 'settings', 'group');
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        return data?.managerGroups?.[managerUserId] || [];
                    }
                } catch (e) { console.error('loadJuniorManagerAllowedUsers error', e); }
                return [];
            }
            
            function renderTrackingMap(container) {
                container.innerHTML = `
                    <div class="h-full w-full relative">
                        <div id="tracking-map" class="h-full w-full"></div>
                        <div id="tracking-map-loader" class="absolute inset-0 bg-white/70 flex items-center justify-center"><div class="loader"></div></div>
<button id="tracking-map-center-btn" class="absolute top-3 right-3 z-10 bg-white text-gray-700 border border-gray-300 rounded-full shadow px-3 py-2 flex items-center hover:bg-gray-50">
                            <i data-lucide="focus" class="w-4 h-4 mr-2"></i>回到公司
                        </button>
                        <div class="absolute bottom-0 left-0 right-0 p-2">
                            <div id="user-tracking-list" class="bg-white/90 backdrop-blur-sm rounded-lg shadow-lg max-h-[150px] overflow-y-auto p-2 space-y-2">
                                <!-- User list will be populated here -->
                            </div>
                        </div>
                    </div>
                `;

                try { lucide.createIcons(); } catch(e) {}

                if (state.googleMapsLoaded) {
                    initTrackingMap();
                } else {
                    const interval = setInterval(() => {
                        if (state.googleMapsLoaded) {
                            clearInterval(interval);
                            initTrackingMap();
                        }
                    }, 100);
                }
            }

            async function initTrackingMap() {
                const mapDiv = document.getElementById('tracking-map');
                const mapLoader = document.getElementById('tracking-map-loader');
                if (!mapDiv || !mapLoader) return;

                let mapCenter = { lat: 25.0330, lng: 121.5654 };
                try {
                    const docSnap = await getDoc(doc(db, "settings", "location"));
                    if (docSnap.exists()) {
                        const s = docSnap.data();
                        if (typeof s.companyLat === 'number' && typeof s.companyLng === 'number') {
                            mapCenter = { lat: s.companyLat, lng: s.companyLng };
                        }
                    }
                } catch (e) { console.warn("載入公司位置失敗，使用預設中心點", e); }
                
                state.trackingMap = new google.maps.Map(mapDiv, {
                    center: mapCenter,
                    zoom: 12,
                    disableDefaultUI: true,
                    zoomControl: true,
                    mapId: 'DEMO_MAP_ID' // Required for Advanced Markers
                });
                state.companyCenter = mapCenter;
                const centerBtn = document.getElementById('tracking-map-center-btn');
                if (centerBtn) {
                    centerBtn.addEventListener('click', () => {
                        if (state.companyCenter) {
                            state.trackingMap.panTo(state.companyCenter);
                            state.trackingMap.setZoom(14);
                        } else {
                            showToast('尚未設定公司座標', true);
                        }
                    });
                }

                mapLoader.classList.add('hide');
                listenForUserLocations();
            }
            
            function renderTrackingAttendance(container) {
                container.innerHTML = `
                    <div class="p-4 space-y-4">
                        <div class="flex flex-wrap items-center gap-4 mb-4">
                            <div class="flex items-center space-x-2">
                                <label for="user-select" class="text-sm font-medium">e?�Ma??aooa?!:</label>
                                <select id="user-select" class="border border-gray-300 rounded-md px-2 py-1">
                                    <option value="all">a?�Le?�Laooa?!</option>
                                    <!-- aooa?!e?�Me??a�X?a??a??a�P?a?? -->
                                </select>
                            </div>
                            <div class="flex items-center space-x-2">
                                <label for="record-date" class="text-sm font-medium">e?�Ma??a?�Da??:</label>
                                <input type="date" id="record-date" value="${new Date().toISOString().split('T')[0]}" class="border border-gray-300 rounded-md px-2 py-1">
                            </div>
                        </div>
                        <div id="attendance-records-list" class="space-y-3">
                            <div class="text-center p-4 text-gray-500">a-�Ga?�LeR�a??c���e??...</div>
                        </div>
                    </div>
                `;
                
                // e??a?�Da?�a??c?�La??
                const usersRef = collection(db, "users");
                const userSelect = document.getElementById('user-select');
                
                getDocs(usersRef).then((querySnapshot) => {
                    const users = [];
                    querySnapshot.forEach(doc => {
                        users.push({ id: doc.id, ...doc.data() });
                    });
                    
                    users.sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant')).forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.name;
                        userSelect.appendChild(option);
                    });
                    
                    // a??a��?e??a?�De�L?e??
                    loadAttendanceRecords();
                });
                
                const dateInput = document.getElementById('record-date');
                userSelect.addEventListener('change', loadAttendanceRecords);
                dateInput.addEventListener('change', loadAttendanceRecords);
                
                function loadAttendanceRecords() {
                    const selectedDate = new Date(dateInput.value);
                    const startOfDay = new Date(selectedDate);
                    startOfDay.setHours(0, 0, 0, 0);
                    const endOfDay = new Date(selectedDate);
                    endOfDay.setHours(23, 59, 59, 999);
                    const selectedUserId = userSelect.value;
                    
                    const recordsRef = collection(db, "clockInRecords");
                    const { Timestamp } = window.__fs || {};
                    const startTS = Timestamp?.fromDate ? Timestamp.fromDate(startOfDay) : startOfDay;
                    const endTS = Timestamp?.fromDate ? Timestamp.fromDate(endOfDay) : endOfDay;
                    let q;
                    
                    if (selectedUserId === 'all') {
                        q = query(recordsRef, 
                            where("timestamp", ">=", startTS),
                            where("timestamp", "<=", endTS)
                        );
                    } else {
                        q = query(recordsRef, 
                            where("userId", "==", selectedUserId),
                            where("timestamp", ">=", startTS),
                            where("timestamp", "<=", endTS)
                        );
                    }
                    
                    const recordsList = document.getElementById('attendance-records-list');
                    recordsList.innerHTML = `<div class="text-center p-4 text-gray-500">a-�Ga?�LeR�a??c���e??...</div>`;
                    
                    getDocs(q).then((querySnapshot) => {
                        if (querySnapshot.empty) {
                            recordsList.innerHTML = `<p class="text-center text-gray-500 p-4">c?!a??a?!c���e??</p>`;
                            return;
                        }
                        
                        const records = [];
                        querySnapshot.forEach(doc => {
                            records.push({ id: doc.id, ...doc.data() });
                        });
                        
                        // c?2a??a?�a??c?�La??e3?a??i??c?�La??e!��c?oa??c�L��
                        getDocs(usersRef).then((usersSnapshot) => {
                            const usersMap = {};
                            usersSnapshot.forEach(doc => {
                                usersMap[doc.id] = doc.data().name;
                            });
                            
                            recordsList.innerHTML = '';
                            records.sort((a, b) => {
                                const timeA = a.timestamp?.toDate?.() || new Date(0);
                                const timeB = b.timestamp?.toDate?.() || new Date(0);
                                return timeB - timeA;
                            }).forEach(record => {
                                const time = record.timestamp?.toDate?.() || new Date();
                                const userName = usersMap[record.userId] || 'a?ac?�Dc?�La??';
                                
                                const card = document.createElement('div');
                                card.className = 'bg-white p-4 rounded-lg shadow border border-gray-200';
                                card.innerHTML = `
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <div class="font-semibold">${userName}</div>
                                            <div class="text-sm text-gray-500">${time.toLocaleString('zh-TW')}</div>
                                            <div class="mt-1 flex items-center">
<span class="px-2 py-0.5 rounded text-sm ${getStatusBgColor(getStatusDisplayText(record.type || '未知', record.locationName || null, record.dutyType || null))}">${getStatusDisplayText(record.type || '未知', record.locationName || null, record.dutyType || null)}</span>
                        ${record.location && typeof record.location.latitude === 'number' && typeof record.location.longitude === 'number' ? `<span class="ml-2 text-sm text-gray-500">${record.location.latitude.toFixed(6)}, ${record.location.longitude.toFixed(6)}</span>` : ''}
                                            </div>
                                            ${record.deviceId ? `<div class="mt-1 text-xs text-gray-500">e�G?c?RID: ${record.deviceId}</div>` : ''}
                                        </div>
                                        <div class="flex space-x-2">
                                            ${record.location ? `
                                                <button class="map-btn bg-green-500 text-white px-2 py-1 rounded text-sm" 
                                                    data-lat="${record.location.latitude}" 
                                                    data-lng="${record.location.longitude}">
                                                    <i data-lucide="map-pin"></i> a?�Xa??
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                    <div class="mt-2 flex space-x-2 overflow-x-auto">
                                        ${record.photoUrls && record.photoUrls.length > 0 ? `
                                            <button class="photo-btn bg-blue-500 text-white px-2 py-1 rounded text-sm" 
                                                data-photos='${encodeURIComponent(JSON.stringify(record.photoUrls || []))}' 
                                                data-descriptions='${encodeURIComponent(JSON.stringify(record.descriptions || []))}'>
                                                <i data-lucide="image"></i> c?��c?? (${record.photoUrls.length})
                                            </button>
                                        ` : ''}
                                    </div>
                                `;
                                recordsList.appendChild(card);
                            });
                            
                            lucide.createIcons();
                            
                            // a�P?a??a?�Xa??a??c?��c??a??e??c??ao?a??c?�Ge??a?�L
                            document.querySelectorAll('.map-btn').forEach(btn => {
                                btn.addEventListener('click', (e) => {
                                    const lat = parseFloat(e.currentTarget.dataset.lat);
                                    const lng = parseFloat(e.currentTarget.dataset.lng);
                                    if(lat && lng) openMapModal(lat, lng);
                                    else showToast("c?!a??c?Re3?e�L?a?��e!��c?o", true);
                                });
                            });
                            
                            document.querySelectorAll('.photo-btn').forEach(btn => {
                                btn.addEventListener('click', (e) => {
                                    const photos = JSON.parse(decodeURIComponent(e.currentTarget.dataset.photos || '%5B%5D'));
                                    const descriptions = JSON.parse(decodeURIComponent(e.currentTarget.dataset.descriptions || '%5B%5D'));
                                    openPhotoModal(photos, descriptions);
                                });
                            });
                        });
                    }).catch(error => {
                        console.error("Error fetching records:", error);
                        recordsList.innerHTML = `<div class="text-center text-red-500 p-4">eR�a??c���e??a?��a??a�?</div>`;
                    });
                }
                
                function getStatusBgColor(typeOrText) {
                    const s = String(typeOrText || '').toLowerCase();
                    if (s.includes('上班') || s.includes('返回') || s.includes('在辦')) return 'bg-green-100 text-green-800';
                    if (s.includes('下班')) return 'bg-red-100 text-red-800';
                    if (s.includes('外出') || s.includes('抵達') || s.includes('離開')) return 'bg-blue-100 text-blue-800';
                    if (s.includes('請假')) return 'bg-orange-100 text-orange-800';
                    if (s.includes('特殊勤務')) return 'bg-indigo-100 text-indigo-800';
                    return 'bg-gray-100 text-gray-800';
                }
            }
            
            function renderTrackingLeave(container) {
                container.innerHTML = `
                    <div class="p-4 space-y-4">
                        <div class="flex flex-wrap items-center gap-4 mb-4">
                            <div class="flex items-center space-x-2">
                                <label for="leave-status-filter" class="text-sm font-medium">a��ca?�Mc?�a??:</label>
                                <select id="leave-status-filter" class="border border-gray-300 rounded-md px-2 py-1">
                                    <option value="all" selected>a?�Le?�L</option>
                                    <option value="pending">a??a��ca?�M</option>
                                    <option value="approved">a�P2a?�Ma??</option>
                                    <option value="rejected">a�P2a??c�g?</option>
                                    <option value="canceled">a�P2a??a??</option>
                                </select>
                            </div>
                            <div class="flex items-center space-x-2">
                                <label for="leave-date-filter" class="text-sm font-medium">a?�Da??:</label>
                                <input type="date" id="leave-date-filter" class="border border-gray-300 rounded-md px-2 py-1" value="">
                            </div>
                            <button id="leave-search-btn" class="bg-blue-600 text-white px-3 py-1 rounded-md hover:bg-blue-700 flex items-center">
                                <i data-lucide="search" class="w-4 h-4 mr-1"></i>a??a�X?
                            </button>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">e??a??aoo</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ao?c?��</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">e??a��?a??e??</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">c�g?a??a??e??</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">c?�a??</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">a??a??</th>
                                        </tr>
                                    </thead>
                                    <tbody id="leave-records-list" class="bg-white divide-y divide-gray-200">
                                        <tr>
                                            <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                                <div class="flex items-center justify-center">
                                                    <i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i>
                                                    e??a?�Da�M-...
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div id="no-leave-records" class="hidden p-8 text-center text-gray-500 bg-white rounded-lg shadow">
                            <i data-lucide="calendar-off" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                            <p>a2?a??c?|a??a�F?a??c??e??a??e�L?e??</p>
                        </div>
                    </div>
                `;
                
                lucide.createIcons();
                
                // c?2a??a??c��?
                const statusFilter = document.getElementById('leave-status-filter');
                const dateFilter = document.getElementById('leave-date-filter');
                const searchBtn = document.getElementById('leave-search-btn');
                
                // a??a��?a??e??a?�Ma??
                loadLeaveRecords();
                
                // a�P?a??a??a�X?a??e??ao?a??
                searchBtn.addEventListener('click', () => {
                    loadLeaveRecords();
                });
                
                // a??e??e??a??e�L?e??
                function loadLeaveRecords() {
                    const recordsList = document.getElementById('leave-records-list');
                    const noRecordsMsg = document.getElementById('no-leave-records');
                    
                    recordsList.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                <div class="flex items-center justify-center">
                                    <i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i>
                                    e??a?�Da�M-...
                                </div>
                            </td>
                        </tr>
                    `;
                    lucide.createIcons();
                    
                    // c?2a??e??a??a�F?a??
                    const status = statusFilter.value;
                    const date = dateFilter.value;
                    
                    // a��?a?oa?�Dec�F
                    const db = window.__db; const { collection, query, where, orderBy, getDocs, doc, getDoc, updateDoc, serverTimestamp } = window.__fs;
                    let leavesQuery = collection(db, 'leaves');
                    
                    // a|?a??e?�Ma??ao?c?1aR?c?�a??
                    if (status !== 'all') {
                        leavesQuery = query(leavesQuery, where('status', '==', status));
                    }

                    // a??a?�ga?oa??e??a??ao?
                    leavesQuery = query(leavesQuery, orderBy('createdAt', 'desc'));

                    // a?�Pe!?a?�Dec�F
                    getDocs(leavesQuery).then((querySnapshot) => {
                        if (querySnapshot.empty) {
                            recordsList.innerHTML = '';
                            noRecordsMsg.classList.remove('hidden');
                            return;
                        }
                        
                        noRecordsMsg.classList.add('hidden');
                        recordsList.innerHTML = '';
                        
                        // a?�Da??e??a??
                        const selectedDate = date ? new Date(date) : null;
                        let nextDay = null;
                        if (selectedDate) {
                            selectedDate.setHours(0, 0, 0, 0);
                            nextDay = new Date(selectedDate);
                            nextDay.setDate(nextDay.getDate() + 1);
                        }
                        
                        let hasRecords = false;
                        
                        querySnapshot.forEach((docSnap) => {
                            const leave = docSnap.data();
                            const leaveId = docSnap.id;
                            
                            // a|?a??e?�Ma??ao?a?�Da??i??aa�Fa?�De??a??a??e??a?��a?|a?�La?�e?�Ma?�Da??c��?a??a?��
                            if (selectedDate && nextDay) {
                                const startTime = leave.startTime.toDate();
                                const endTime = leave.endTime.toDate();
                                
                                // aa�Fa?�De??a??a??e??a?��a?|e??a?�e?�Ma?�Da??a??e??c??
                                if (!(startTime < nextDay && endTime > selectedDate)) {
                                    return; // e�P3e??a�M?c?|a??a?�Da??a�F?a??c??e�L?e??
                                }
                            }
                            
                            hasRecords = true;
                            
                            const startTime = leave.startTime.toDate().toLocaleString('zh-TW');
                            const endTime = leave.endTime.toDate().toLocaleString('zh-TW');
                            
                            let statusBadge = '';
                            switch (leave.status) {
                                case 'pending':
                                    statusBadge = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">a??a��ca?�M</span>';
                                    break;
                                case 'approved':
                                    statusBadge = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">a�P2a?�Ma??</span>';
                                    break;
                                case 'rejected':
                                    statusBadge = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">a�P2a??c�g?</span>';
                                    break;
                                case 'canceled':
                                    statusBadge = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-200 text-gray-700">a�P2a??a??</span>';
                                    break;
                                default:
                                    statusBadge = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">a?ac?�D</span>';
                            }
                            
                            const row = document.createElement('tr');
                            row.className = 'hover:bg-gray-50';
                            row.innerHTML = `
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="text-sm font-medium text-gray-900">${leave.userName || 'a?ac?�Dc?�La??'}</div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">${leave.reason || 'c?!ao?c?��'}</div>
                                    <div class="text-xs text-gray-500">${leave.reasonType || ''}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">${startTime}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">${endTime}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    ${statusBadge}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    ${leave.status === 'pending' ? `
                                        <button data-leave-id="${leaveId}" data-action="approve" class="text-green-600 hover:text-green-900 mr-3">
                                            <i data-lucide="check-circle" class="w-5 h-5"></i>
                                        </button>
                                        <button data-leave-id="${leaveId}" data-action="reject" class="text-red-600 hover:text-red-900">
                                            <i data-lucide="x-circle" class="w-5 h-5"></i>
                                        </button>
                                    ` : ''}
                                </td>
                            `;
                            
                            recordsList.appendChild(row);
                        });
                        
                        lucide.createIcons();
                        
                        if (!hasRecords) {
                            recordsList.innerHTML = '';
                            noRecordsMsg.classList.remove('hidden');
                        }
                        
                        // a�P?a??a��ca?�Ma??e??ao?a??
                        document.querySelectorAll('[data-leave-id]').forEach(btn => {
                            btn.addEventListener('click', async (e) => {
                                const leaveId = e.currentTarget.dataset.leaveId;
                                const action = e.currentTarget.dataset.action;
                                
                                try {
                                    showLoading(true);
                                    
                                    // c?2a??e??a??e�L?e??
                                    const leaveDocSnap = await getDoc(doc(db, 'leaves', leaveId));
                                    if (!leaveDocSnap.exists()) {
                                        showToast('a??a�M?a?�Xe??a??e�L?e??', true);
                                        return;
                                    }
                                    const leaveData = leaveDocSnap.data();
                                    const userId = leaveData.userId;
                                    
                                    // a?��a?�Xe??a??e�L?e??c?�a??
                                    await updateDoc(doc(db, 'leaves', leaveId), {
                                        status: action === 'approve' ? 'approved' : 'rejected',
                                        reviewedAt: serverTimestamp(),
                                        reviewedBy: window.__auth?.currentUser?.uid || ''
                                    });
                                    
                                    // a|?a??a?�Ma??i??a?��a?�Xc?�La??c?�a??
                                    if (action === 'approve') {
                                        await updateDoc(doc(db, 'users', userId), { leaveStatus: 'approved' });
                                    }
                                    
                                    showToast(`a�P2${action === 'approve' ? 'a?�Ma??' : 'a??c�g?'}e??a??c?3e??`);
                                    
                                    // e??a?�Xa??e??e�L?e??
                                    loadLeaveRecords();
                                } catch (error) {
                                    console.error('e??c??e??a??c?3e??a?��a??:', error);
                                    showToast('e??c??e??a??c?3e??a?��a??i??e??c�L?a??a??ec|', true);
                                } finally {
                                    showLoading(false);
                                }
                            });
                        });
                    }).catch(error => {
                        console.error('c?2a??e??a??e�L?e??a?��a??:', error);
                        recordsList.innerHTML = `
                            <tr>
                                <td colspan="6" class="px-6 py-4 text-center text-red-500">
                                    eR�a??e�L?e??a?��a??i??e??c�L?a??a??ec|
                                </td>
                            </tr>
                        `;
                    });
                }
            }
            
            function renderTrackingReports(container) {
                container.innerHTML = `
                    <div class="h-[50px] flex items-center justify-around border-b border-gray-200 bg-white">
                        <button data-report="personal" class="report-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 active">a�?aooa?�Da?��e!�L</button>
                        <button data-report="all" class="report-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600">a?�Le??a??a?��e!�L</button>
                    </div>
                    <div id="report-content" class="p-4">
                        <div class="text-center">
                            <i data-lucide="construction" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
                            <h2 class="text-xl font-semibold text-gray-700 mb-2">a?��e!�La??e??e??c??a�M-</h2>
                            <p class="text-gray-500">a-?a??e??a-�Ga?�Le??c??a�M-i??a??e??a??a??i??</p>
                        </div>
                    </div>
                `;
                lucide.createIcons();
                
                container.querySelectorAll('.report-tab-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        container.querySelectorAll('.report-tab-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        
                        const reportType = btn.dataset.report;
                        const reportContent = document.getElementById('report-content');
                        
                        reportContent.innerHTML = `
                            <div class="text-center">
                                <i data-lucide="construction" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
                                <h2 class="text-xl font-semibold text-gray-700 mb-2">${reportType === 'personal' ? 'a�?aooa?�Da?��e!�L' : 'a?�Le??a??a?��e!�L'}a??e??e??c??a�M-</h2>
                                <p class="text-gray-500">a-?a??e??a-�Ga?�Le??c??a�M-i??a??e??a??a??i??</p>
                            </div>
                        `;
                        lucide.createIcons();
                    });
                });
            }

            async function listenForUserLocations() {
                const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
                const usersRef = collection(db, "users");
                const q = query(usersRef, orderBy("name"));

                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    state.trackingMarkers.forEach(marker => marker.map = null);
                    state.trackingMarkers = [];

                    const userListEl = document.getElementById('user-tracking-list');
                    if (!userListEl) return;
                    userListEl.innerHTML = '';

                    const users = [];
                    querySnapshot.forEach(doc => users.push({ id: doc.id, ...doc.data() }));

                    if (users.length === 0) {
                        userListEl.innerHTML = `<p class="text-center text-gray-500 p-2">a2?a??a??c?�Le�?a?��e??e1?</p>`;
                        return;
                    }

                    users.forEach(user => {
                        const hasLocation = user.lastLocation && user.lastLocation.latitude;
                        
                        const userElement = document.createElement('div');
                        userElement.className = `flex items-center justify-between p-2 rounded-md cursor-pointer hover:bg-gray-100 ${!hasLocation ? 'opacity-50' : ''}`;
                        userElement.innerHTML = `
                            <div class="flex items-center">
                                <img src="${user.avatarUrl || `https://placehold.co/32x32/EFEFEF/333333?text=${user.name.charAt(0)}`}" class="w-8 h-8 rounded-full mr-3 object-cover">
                                <div>
                                    <p class="font-medium text-sm text-gray-800">${user.name}</p>
                                    <p class="text-xs text-gray-500">${getStatusDisplayText(user.status, user.lastLocation?.address) || 'a?aa??a?!'}</p>
                                </div>
                            </div>
                            <span class="text-xs text-gray-400">${user.lastClockInTime ? 'a?�e??c?�a??a??e??i??' + timeAgo(user.lastClockInTime.toDate()) : 'c?!c���e??'}</span>
                        `;
                        userListEl.appendChild(userElement);

                        if (hasLocation) {
                            const position = { lat: user.lastLocation.latitude, lng: user.lastLocation.longitude };
                            
                            const markerIcon = document.createElement('img');
                            markerIcon.src = user.avatarUrl || `https://placehold.co/40x40/EFEFEF/333333?text=${user.name.charAt(0)}`;
                            markerIcon.className = "w-9 h-9 rounded-full border-2 border-white shadow-md object-cover";

                            const marker = new AdvancedMarkerElement({
                                position,
                                map: state.trackingMap,
                                title: user.name,
                                content: markerIcon,
                            });

                            const infoWindow = new google.maps.InfoWindow({
                                content: `
                                    <div class="p-1">
                                        <p class="font-bold">${user.name}</p>
                                        <p>c?�a??: ${getStatusDisplayText(user.status, user.lastLocation?.address)}</p>
                                        <p>a?�e??c?�a??a??e??: ${user.lastClockInTime ? formatDateTime(user.lastClockInTime) : 'N/A'}</p>
                                    </div>
                                `
                            });

                            marker.addListener('click', () => {
                                infoWindow.open({ anchor: marker, map: state.trackingMap });
                            });
                            
                            userElement.addEventListener('click', () => {
                                state.trackingMap.panTo(position);
                                state.trackingMap.setZoom(17);
                                infoWindow.open({ anchor: marker, map: state.trackingMap });
                            });

                            state.trackingMarkers.push(marker);
                        }
                    });
                });
                state.activeListeners.push(unsubscribe);
            }


            function renderSettings(subPage) {
                mainContent.innerHTML = `
                    <div class="h-[50px] flex items-center justify-around border-b border-gray-200 bg-white">
                        <button data-subtab="accounts" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'accounts' ? 'active' : ''}">a�M3e??a??e!�L</button>
                        <button data-subtab="rules" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'rules' ? 'active' : ''}">e�L?e??e|?a??</button>
                        <button data-subtab="general" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'general' ? 'active' : ''}">a�M�e??e�L-aR?</button>
                        <button data-subtab="location" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'location' ? 'active' : ''}">aR?a??a??c?R</button>
                        <button data-subtab="holidays" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'holidays' ? 'active' : ''}">a??a??a?�D</button>
                        <button data-subtab="group" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'group' ? 'active' : ''}">c??c�g?e�L-aR?</button>
                    </div>
                    <div id="sub-page-content" class="overflow-y-auto" style="height: calc(100% - 50px);"></div>`;
                
                const subPageContent = document.getElementById('sub-page-content');
                if (subPage === 'accounts') {
                    renderSettingsAccounts(subPageContent);
                } else if (subPage === 'rules') {
                    renderSettingsRules(subPageContent);
                } else if (subPage === 'general') {
                    renderSettingsGeneral(subPageContent);
                } else if (subPage === 'location') {
                    renderSettingsLocation(subPageContent);
                } else if (subPage === 'holidays') {
                    renderSettingsHolidays(subPageContent);
                } else if (subPage === 'group') {
                    renderSettingsGroup(subPageContent);
                }
                
                mainContent.querySelectorAll('.sub-tab-btn').forEach(btn => btn.addEventListener('click', () => showPage('settings', btn.dataset.subtab)));
            }

            function renderSettingsGroup(container) {
                container.innerHTML = `
                    <div class="p-4 space-y-4">
                        <h2 class="text-lg font-semibold">c??c�g?e�L-aR?</h2>
                        <p class="text-sm text-gray-600">a�X?a??e??a�M?cR!e??e?��e?3a?��a?�Dc??c??a?!a�P�Da??a?Ra�?</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div id="manager-select-panel" class="bg-white p-4 rounded-md shadow-sm border">
                                <h3 class="font-medium mb-2">e?�Ma??cR!c??e�?</h3>
                                <select id="manager-user-select" class="w-full border border-gray-300 rounded-md px-2 py-1"></select>
                            </div>
                            <div id="allowed-users-panel" class="bg-white p-4 rounded-md shadow-sm border">
                                <h3 class="font-medium mb-2">a?��a?�Dc??a?!a�P�D</h3>
                                <div id="allowed-users-list" class="space-y-2"></div>
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <button id="save-group-settings" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700">a?2a-?e�L-aR?</button>
                        </div>
                    </div>`;
                lucide.createIcons();
                initSettingsGroupUI();
            }

            async function initSettingsGroupUI() {
                const managerSelect = document.getElementById('manager-user-select');
                const allowedList = document.getElementById('allowed-users-list');
                const usersRef = collection(db, 'users');
                const qs = await getDocs(usersRef);
                const users = [];
                qs.forEach(docSnap => users.push({ id: docSnap.id, ...docSnap.data() }));
                const managers = users.filter(u => u.role === 'junior_manager');
                managers.sort((a,b)=>a.name.localeCompare(b.name,'zh-Hant')).forEach(m => {
                    const opt = document.createElement('option'); opt.value = m.id; opt.textContent = `${m.name}`; managerSelect.appendChild(opt);
                });

                const renderAllowedUsers = async () => {
                    allowedList.innerHTML = '';
                    const selectedManagerId = managerSelect.value;
                    const allowedIds = await loadJuniorManagerAllowedUsers(selectedManagerId);
                    users.filter(u => u.role === 'user').sort((a,b)=>a.name.localeCompare(b.name,'zh-Hant')).forEach(u => {
                        const row = document.createElement('label');
                        row.className = 'flex items-center justify-between bg-white p-2 rounded border';
                        const chk = document.createElement('input');
                        chk.type = 'checkbox';
                        chk.checked = allowedIds.includes(u.id);
                        chk.dataset.userid = u.id;
                        row.appendChild(document.createTextNode(u.name));
                        row.appendChild(chk);
                        allowedList.appendChild(row);
                    });
                };
                managerSelect.addEventListener('change', renderAllowedUsers);
                await renderAllowedUsers();

                document.getElementById('save-group-settings').addEventListener('click', async () => {
                    const selectedManagerId = managerSelect.value;
                    const checkboxes = allowedList.querySelectorAll('input[type="checkbox"]');
                    const allowedIds = Array.from(checkboxes).filter(c => c.checked).map(c => c.dataset.userid);
                    const docRef = doc(db, 'settings', 'group');
                    const existingSnap = await getDoc(docRef);
                    const baseData = existingSnap.exists() ? existingSnap.data() : {};
                    const newData = { ...baseData, managerGroups: { ...(baseData.managerGroups || {}), [selectedManagerId]: allowedIds } };
                    await setDoc(docRef, newData, { merge: true });
                    showToast('c??c�g?e�L-aR?a�P2a?2a-?');
                });
            }
            
            function renderSettingsAccounts(container) {
                container.innerHTML = `
                    <div class="p-4">
                        <button id="add-user-btn" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700 mb-4 flex items-center justify-center">
                            <i data-lucide="plus-circle" class="w-4 h-4 mr-2"></i>a?�Xa�F?a�M3e??
                        </button>
                        <button id="reset-points-btn" class="w-full bg-yellow-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-yellow-700 mb-4 flex items-center justify-center">
                            <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>e??c?Ra?�a??c?�La??e??a?�Mc?o0
                        </button>
                        <div id="user-list" class="space-y-2"></div>
                    </div>`;
                lucide.createIcons();
                document.getElementById('add-user-btn').addEventListener('click', () => openUserModal());
                document.getElementById('reset-points-btn').addEventListener('click', resetAllUserPoints);

                const userList = document.getElementById('user-list');
                const usersRef = collection(db, "users");
                const q = query(usersRef, orderBy("name"));
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    userList.innerHTML = '';
                    const users = [];
                    querySnapshot.forEach(doc => users.push({ id: doc.id, ...doc.data() }));
                    state.users = users; // Update global state

                    if (users.length === 0) {
                        userList.innerHTML = `<p class="text-center text-gray-500 p-4">a�X?a?aa?oc??a??a??a�M3e??</p>`;
                        return;
                    }

                    users.forEach(user => {
                        const userElement = document.createElement('div');
                        userElement.className = 'flex items-center justify-between bg-white p-3 rounded-md shadow-sm border';
                        userElement.innerHTML = `
                            <div class="flex items-center">
                                <img src="${user.avatarUrl || `https://placehold.co/40x40/EFEFEF/333333?text=${user.name.charAt(0)}`}" class="w-10 h-10 rounded-full mr-3 object-cover">
                                <div>
                                    <p class="font-medium text-gray-800">${user.name}</p>
                                    <p class="text-sm text-gray-500">${user.email}</p>
                                    <div class="flex items-center">
                                        <p class="text-xs text-gray-400 mr-2">${user.phone || ''}</p>
                                        <span class="text-xs px-2 py-1 rounded-full ${
  user.role === 'admin' ? 'bg-red-100 text-red-700' : 
  user.role === 'manager' ? 'bg-purple-100 text-purple-700' : 
  'bg-blue-100 text-blue-700'
}">${
  user.role === 'admin' ? 'cR!c??a?!' : 
  user.role === 'manager' ? 'e??e??a�M?cR!' : 
  'a?��a??'
}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button data-userid="${user.id}" class="edit-user-btn p-2 text-gray-500 hover:text-red-600"><i data-lucide="edit" class="w-4 h-4"></i></button>
                                <button data-userid="${user.id}" class="delete-user-btn p-2 text-gray-500 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>`;
                        // e|?a��?e��?e?2a??c??a??c??i??a??c?�L roleLabel e?? roleBadgeClass
                        const badgeSpan = userElement.querySelector('span.text-xs.px-2.py-1.rounded-full');
                        if (badgeSpan) {
                            badgeSpan.className = `text-xs px-2 py-1 rounded-full ${roleBadgeClass(user.role)}`;
                            badgeSpan.textContent = roleLabel(user.role);
                        }
                        userList.appendChild(userElement);
                    });
                    lucide.createIcons();

                    document.querySelectorAll('.edit-user-btn').forEach(btn => btn.addEventListener('click', (e) => {
                        const userId = e.currentTarget.dataset.userid;
                        const userToEdit = state.users.find(u => u.id === userId);
                        if (userToEdit) openUserModal(userToEdit);
                    }));

                    document.querySelectorAll('.delete-user-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                        const userId = e.currentTarget.dataset.userid;
                        const userToDelete = state.users.find(u => u.id === userId);
                        if (userToDelete && confirm(`c�FoaR?e|?a?ae?? ${userToDelete.name} c??a�M3e??e3?a??a??i??\na3�La??i??a-?a??a??a?aa??a?ae??e3?a??ao?c���e??i??a�M?a??a?ae??a??c?�Le�?c??c??a?�Da??e??a�?`)) {
                            try {
                                showLoading(true);
                                await deleteDoc(doc(db, "users", userId));
                                showToast("a�M3e??e3?a??a?ae??a??a??");
                            } catch (error) {
                                console.error("Error deleting user document:", error);
                                showToast("a?ae??a?��a??", true);
                            } finally {
                                showLoading(false);
                            }
                        }
                    }));
                });
                state.activeListeners.push(unsubscribe);
            }

            function renderSettingsGeneral(container) {
                container.innerHTML = `
                    <div class="p-4">
                        <div class="bg-white p-4 rounded-md shadow-sm border mb-4">
                            <h3 class="font-bold text-lg mb-4">a?�e!�La??e�L-aR?</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <label for="show-employee-status" class="text-gray-700">e!��c?oa?!a�P�Dc?�a??</label>
                                    <label class="switch">
                                        <input type="checkbox" id="show-employee-status" checked>
                                        <span class="slider round"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-4 rounded-md shadow-sm border mb-4">
                            <h3 class="font-bold text-lg mb-4">e?aa??a�M?c?-a??a?!e�L-aR?</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <label for="enable-auto-clock-out" class="text-gray-700">a??c?�Le?aa??a�M?c?-a??a?!</label>
                                    <label class="switch">
                                        <input type="checkbox" id="enable-auto-clock-out">
                                        <span class="slider round"></span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between">
                                    <label for="work-hours" class="text-gray-700">a�P�Da??a??a?�Mi??a�X?a??i??</label>
                                    <div class="flex items-center space-x-2">
                                        <input type="number" id="work-hours" min="1" max="24" value="8" class="w-20 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500">
                                        <span class="text-gray-500 text-sm">a�X?a??</span>
                                    </div>
                                </div>
                                <div class="text-sm text-gray-600 bg-gray-50 p-3 rounded-md">
                                    <i data-lucide="info" class="w-4 h-4 inline mr-1"></i>
                                    a??c?�La??i??c3?c�g��a�X?a?�La�M?c?-a??a?!a??c??a??aR?a??a?�Me?aa??a?�Pe!?a�M?c?-a??a?!i??c?�a??e!��c?oc?oa�?a�P2a�M?c?--a?aa??a?!a�?
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-4 rounded-md shadow-sm border mb-4" id="admin-overtime-section" style="display: none;">
                            <h3 class="font-bold text-lg mb-4">cR!c??a?!a??e??</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <label class="text-gray-700 font-medium">aa�Fa?�De??a??c?�a??</label>
                                        <p class="text-sm text-gray-500">aa�Fa?�Da?�a??a?!a�P�Da?��a?|a??e??e??a�P�Da??a??a?�Mc??a??a3?</p>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button id="check-overtime-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center">
                                            <i data-lucide="clock" class="w-4 h-4 mr-2"></i>aa�Fa?�De??a??
                                        </button>
                                        <button id="test-overtime-btn" class="bg-orange-600 text-white px-4 py-2 rounded-md hover:bg-orange-700 flex items-center">
                                            <i data-lucide="test-tube" class="w-4 h-4 mr-2"></i>a�M?ec|e??a??
                                        </button>
                                    </div>
                                </div>
                                <div id="overtime-results" class="hidden">
                                    <div class="bg-yellow-50 border border-yellow-200 rounded-md p-3">
                                        <h4 class="font-medium text-yellow-800 mb-2">e??a??a?!a�P�Da??e!�L</h4>
                                        <div id="overtime-list" class="space-y-2"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-4 rounded-md shadow-sm border mb-4">
                            <h3 class="font-bold text-lg mb-4">e!��c?oa?�a??a�M3e??</h3>
                            <p class="text-sm text-gray-600 mb-4">a??e?�Me|?a?�La?�e!�La??a�?a?�a??a??a??c?�a??a�?a�M-e!��c?oc??a�M3e??</p>
                            <div id="user-display-settings" class="space-y-2">
                                <div class="flex items-center justify-between p-2 border-b">
                                    <label class="text-gray-700 font-medium">a�M3e??a??c�L��</label>
                                    <label class="text-gray-700 font-medium">e!��c?o</label>
                                </div>
                                <div class="flex justify-center items-center py-4">
                                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-red-600"></div>
                                    <span class="ml-2 text-gray-600">e??a?�Da�M-...</span>
                                </div>
                            </div>
                        </div>
                        
                        <button id="save-general-settings" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700 mb-4 flex items-center justify-center">
                            <i data-lucide="save" class="w-4 h-4 mr-2"></i>a?2a-?e�L-aR?
                        </button>
                    </div>`;
                
                lucide.createIcons();
                
                // a?? Firebase eR�a??e�L-aR?
                const settingsRef = doc(db, "settings", "general");
                getDoc(settingsRef).then((docSnap) => {
                    if (docSnap.exists()) {
                        const settings = docSnap.data();
                        document.getElementById('show-employee-status').checked = settings.showEmployeeStatus !== false;
                        
                        // e??a?�De?aa??a�M?c?-a??a?!e�L-aR?
                        document.getElementById('enable-auto-clock-out').checked = settings.enableAutoClockOut || false;
                        document.getElementById('work-hours').value = settings.workHours || 8;
                        
                        // e??a?�Da??c?�Le�?e!��c?oe�L-aR?
                        loadUserDisplaySettings(settings.visibleUsers || {});
                    } else {
                        // a|?a??e�L-aR?a�M?a-?a?�Li??e??a?�De??e�L-a�?i??a?�Le?�Le!��c?oi??
                        document.getElementById('enable-auto-clock-out').checked = false;
                        document.getElementById('work-hours').value = 8;
                        loadUserDisplaySettings({});
                    }
                }).catch(error => {
                    console.error("Error getting general settings:", error);
                    showToast("c?!a3?eR�a??e�L-aR?", true);
                    // c??c??e?��ea?a??i??a??c??e??a?�Da??c?�Le�?a??e!�L
                    loadUserDisplaySettings({});
                });
                
                // e??a?�Da??c?�Le�?a??e!�La�M|e�L-aR?e!��c?oc?�a??
                function loadUserDisplaySettings(visibleUsers) {
                    const userDisplayContainer = document.getElementById('user-display-settings');
                    
                    // c?2a??a?�a??a??c?�Le�?
                    const usersRef = collection(db, "users");
                    getDocs(usersRef).then((querySnapshot) => {
                        // a�M?e??e??a?�Da�M-c??a??c?o
                        userDisplayContainer.innerHTML = `
                            <div class="flex items-center justify-between p-2 border-b">
                                <label class="text-gray-700 font-medium">a�M3e??a??c�L��</label>
                                <label class="text-gray-700 font-medium">e!��c?o</label>
                            </div>
                        `;
                        
                        // a�P?a??a?�Le?�M/a??a??a?�Le?�Me?�Me??
                        const selectAllDiv = document.createElement('div');
                        selectAllDiv.className = 'flex items-center justify-between p-2 border-b bg-gray-50';
                        selectAllDiv.innerHTML = `
                            <label for="select-all-users" class="text-gray-700 font-medium">a?�Le?�M/a??a??a?�Le?�M</label>
                            <label class="switch">
                                <input type="checkbox" id="select-all-users">
                                <span class="slider round"></span>
                            </label>
                        `;
                        userDisplayContainer.appendChild(selectAllDiv);
                        
                        // c?2a??a?�Le?�M/a??a??a?�Le?�Mc??checkbox
                        const selectAllCheckbox = document.getElementById('select-all-users');
                        
                        // a�P?a??a??c?�Le�?a??e!�L
                        const userCheckboxes = [];
                        querySnapshot.forEach((doc) => {
                            const userData = doc.data();
                            const userId = doc.id;
                            
                            // e??e�L-a�?i??a|?a??visibleUsersc?occoa??ec2a??c?�Le�?a?ae�L-aR?i??a??e!��c?o
                            const isVisible = visibleUsers[userId] !== false;
                            
                            const userDiv = document.createElement('div');
                            userDiv.className = 'flex items-center justify-between p-2 border-b';
                            userDiv.innerHTML = `
                                <label for="user-${userId}" class="text-gray-700">${userData.name || userData.email || 'a?aa??a??a??c?�Le�?'}</label>
                                <label class="switch">
                                    <input type="checkbox" id="user-${userId}" data-user-id="${userId}" class="user-visibility-checkbox" ${isVisible ? 'checked' : ''}>
                                    <span class="slider round"></span>
                                </label>
                            `;
                            userDisplayContainer.appendChild(userDiv);
                            
                            // a�X?checkboxa??a?�De?�Ga??i??a?�Da??a??co?a?�Le?�M/a??a??a?�Le?�Ma??a??
                            const checkbox = userDiv.querySelector(`#user-${userId}`);
                            userCheckboxes.push(checkbox);
                        });
                        
                        // e�L-aR?a?�Le?�M/a??a??a?�Le?�Mc??a??e??
                        selectAllCheckbox.checked = userCheckboxes.every(cb => cb.checked);
                        selectAllCheckbox.addEventListener('change', () => {
                            const isChecked = selectAllCheckbox.checked;
                            userCheckboxes.forEach(cb => {
                                cb.checked = isChecked;
                            });
                        });
                        
                        // c??a�?a?�DcheckboxeR?a?��a??i??a?��a?�Xa?�Le?�Mcheckboxc??c?�a??
                        userCheckboxes.forEach(cb => {
                            cb.addEventListener('change', () => {
                                selectAllCheckbox.checked = userCheckboxes.every(cb => cb.checked);
                            });
                        });
                        
                    }).catch(error => {
                        console.error("Error getting users:", error);
                        userDisplayContainer.innerHTML = `
                            <div class="p-4 text-center text-red-600">
                                <p>c?!a3?e??a?�Da??c?�Le�?a??e!�L</p>
                                <p class="text-sm">${error.message}</p>
                            </div>
                        `;
                    });
                }
                
                // a?2a-?e�L-aR?
                document.getElementById('save-general-settings').addEventListener('click', async () => {
                    try {
                        showLoading(true);
                        const showEmployeeStatus = document.getElementById('show-employee-status').checked;
                        const enableAutoClockOut = document.getElementById('enable-auto-clock-out').checked;
                        const workHours = parseInt(document.getElementById('work-hours').value) || 8;
                        
                        // a??e??a??c?�Le�?e!��c?oe�L-aR?
                        const visibleUsers = {};
                        document.querySelectorAll('.user-visibility-checkbox').forEach(checkbox => {
                            const userId = checkbox.dataset.userId;
                            // a?aa?2a-?a?aa??e?�Mc??a??c?�Le�?i??e??e�L-c?oe!��c?oi??
                            if (!checkbox.checked) {
                                visibleUsers[userId] = false;
                            }
                        });
                        
                        // a?2a-?a?�X Firebase
                        await setDoc(doc(db, "settings", "general"), {
                            showEmployeeStatus,
                            enableAutoClockOut,
                            workHours,
                            visibleUsers,
                            updatedAt: serverTimestamp()
                        }, { merge: true });
                        
                        showToast("e�L-aR?a�P2a?2a-?");
                    } catch (error) {
                        console.error("Error saving general settings:", error);
                        showToast("a?2a-?e�L-aR?a?��a??i??" + error.message, true);
                    } finally {
                        showLoading(false);
                    }
                });
                
                // aa�Fa?�Dc?�La??a?��a?|c?ocR!c??a?!i??a|?a??a?��a??e!��c?ocR!c??a?!a??e??
                (window.checkAdminStatus ? window.checkAdminStatus() : Promise.resolve(false)).then(isAdmin => {
                    if (isAdmin) {
                        document.getElementById('admin-overtime-section').style.display = 'block';
                        
                        // a�P?a??aa�Fa?�De??a??a??e??c??ao?a??c?�Ge??a?�L
                        document.getElementById('check-overtime-btn').addEventListener('click', async () => {
                            try {
                                const btn = document.getElementById('check-overtime-btn');
                                const originalText = btn.innerHTML;
                                btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 mr-2 animate-spin"></i>aa�Fa?�Da�M-...';
                                btn.disabled = true;
                                
                                // ea?c?�Laa�Fa?�De??a??c?�a??c??a??a?�M
                                const overtimeUsers = await checkAllUsersOvertimeStatus();
                                
                                // e!��c?oc�g?a??
                                const resultsDiv = document.getElementById('overtime-results');
                                const listDiv = document.getElementById('overtime-list');
                                
                                if (overtimeUsers && overtimeUsers.length > 0) {
                                    listDiv.innerHTML = '';
                                    overtimeUsers.forEach(user => {
                                        const userDiv = document.createElement('div');
                                        userDiv.className = 'flex items-center justify-between p-2 bg-white rounded border';
                                        userDiv.innerHTML = `
                                            <div>
                                                <span class="font-medium">${user.displayName}</span>
                                                <span class="text-sm text-gray-500 ml-2">a�P2a�P�Da?? ${user.workingHours} a�X?a??</span>
                                            </div>
                                            <span class="text-xs text-gray-400">${user.clockInTime.toLocaleString()}</span>
                                        `;
                                        listDiv.appendChild(userDiv);
                                    });
                                    resultsDiv.classList.remove('hidden');
                                } else {
                                    listDiv.innerHTML = '<div class="text-center text-gray-600 py-2">c?Ra??a2?a??e??a??c??a?!a�P�D</div>';
                                    resultsDiv.classList.remove('hidden');
                                }
                                
                            } catch (error) {
                                console.error('aa�Fa?�De??a??c?�a??a?��a??:', error);
                                showToast('aa�Fa?�De??a??c?�a??a?��a??i??' + error.message, true);
                            } finally {
                                const btn = document.getElementById('check-overtime-btn');
                                btn.innerHTML = '<i data-lucide="clock" class="w-4 h-4 mr-2"></i>aa�Fa?�De??a??';
                                btn.disabled = false;
                                lucide.createIcons();
                            }
                         });
                         
                         // a�P?a??a�M?ec|e??a??a??e??c??ao?a??c?�Ge??a?�L
                         document.getElementById('test-overtime-btn').addEventListener('click', async () => {
                             try {
                                 const user = auth.currentUser;
                                 if (!user) {
                                     showToast('e??a??c??a?�D', true);
                                     return;
                                 }
                                 
                                 const btn = document.getElementById('test-overtime-btn');
                                 btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 mr-2 animate-spin"></i>a�M?ec|a�M-...';
                                 btn.disabled = true;
                                 
                                 // a�L!a??e??a??a??a3?i??a?oc??a�M�c-?a�?9a�X?a??a??a�M?c?-a�?c??a??e|?a??a?!c���e??
                                 const nineHoursAgo = new Date();
                                 nineHoursAgo.setHours(nineHoursAgo.getHours() - 9);
                                 const db = window.__db; const { Timestamp, GeoPoint, addDoc, collection, serverTimestamp, setDoc, doc } = window.__fs;
                                 const ts = Timestamp.fromDate(nineHoursAgo);
                                 const loc = new GeoPoint(25.0330, 121.5654);
                                 await addDoc(collection(db, 'clockInRecords'), {
                                     userId: user.uid,
                                     type: 'a�M?c?-',
                                     timestamp: ts,
                                     location: loc,
                                     photoUrls: [],
                                     descriptions: [],
                                     deviceId: 'test-device'
                                 });
                                 // a�X?a??c?�Le�?c?�a??e�L-c?oa�M?c?-i??a??a?��a?�Xa??e�L��a??a??i??
                                 await setDoc(doc(db, 'users', user.uid), {
                                     clockInStatus: 'a�M?c?-',
                                     status: 'a�M?c?-',
                                     lastUpdated: serverTimestamp()
                                 }, { merge: true });
                                 
                                 showToast('a�P2e�L-aR?a�M?ec|e??a??c?�a??i??9a�X?a??a??a�M?c?-i??i??e??e??a?�Xe??a?�De??e?�Fa�M?ec|e?aa??a�M?c?-a??a?!a??e??');
                                 
                                 // 3c��?a??e?aa??e??a?�Xe??a?�De??e?�F
                                 setTimeout(() => {
                                     window.location.reload();
                                 }, 3000);
                                 
                             } catch (error) {
                                 console.error('e�L-aR?a�M?ec|e??a??c?�a??a?��a??:', error);
                                 showToast('e�L-aR?a�M?ec|e??a??c?�a??a?��a??i??' + error.message, true);
                             } finally {
                                 const btn = document.getElementById('test-overtime-btn');
                                 btn.innerHTML = '<i data-lucide="test-tube" class="w-4 h-4 mr-2"></i>a�M?ec|e??a??';
                                 btn.disabled = false;
                                 lucide.createIcons();
                             }
                         });
                     }
                 });
                
                // aa�Fa?�DcR!c??a?!c?�a??c??e??a?ca??a?�M
                // 確保已存在全域 window.checkAdminStatus，避免重複定義
                if (!window.checkAdminStatus) {
                    window.checkAdminStatus = async function() {
                        try {
                            const auth = window.__auth; const db = window.__db; const { getDoc, doc } = window.__fs || {};
                            if (!auth || !db || !getDoc || !doc) return false;
                            const user = auth.currentUser;
                            if (!user) return false;
                            const userDoc = await getDoc(doc(db, 'users', user.uid));
                            if (userDoc.exists()) {
                                return userDoc.data().role === 'admin';
                            }
                            return false;
                        } catch (error) {
                            console.error('checkAdminStatus error:', error);
                            return false;
                        }
                    };
                }
            }
            
            function renderSettingsLocation(container) {
                container.innerHTML = `
                    <div class="p-4">
                        <div class="bg-white p-4 rounded-md shadow-sm border mb-4">
                            <h3 class="font-bold text-lg mb-4">a??a?�Ma??c?Re�L-aR?</h3>
                            <div class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="company-lat" class="block text-sm font-medium text-gray-700">c�P��ao|</label>
                                        <input type="number" id="company-lat" step="0.000001" class="w-full mt-1 px-3 py-2 border rounded-md">
                                    </div>
                                    <div>
                                        <label for="company-lng" class="block text-sm font-medium text-gray-700">c??ao|</label>
                                        <input type="number" id="company-lng" step="0.000001" class="w-full mt-1 px-3 py-2 border rounded-md">
                                    </div>
                                </div>
                                <div>
                                    <label for="company-radius" class="block text-sm font-medium text-gray-700">a??a??a??a?!a??a?? (a??a�Xo)</label>
                                    <input type="number" id="company-radius" min="10" max="1000" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                                <div class="flex items-center justify-between">
                                    <label for="mark-abnormal-location" class="text-gray-700">a�L?e�L?c?�Xa�M�Ma??c?R</label>
                                    <label class="switch">
                                        <input type="checkbox" id="mark-abnormal-location" checked>
                                        <span class="slider round"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-4 rounded-md shadow-sm border mb-4">
                            <h3 class="font-bold text-lg mb-4">a??a??a??a?!a??c?R</h3>
                            <div id="other-locations" class="space-y-4">
                                <!-- a??a??a??c?Ra??a??a??a�P?a??a?�Le�?e�G! -->
                            </div>
                            <button id="add-location-btn" class="w-full mt-4 bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-md hover:bg-gray-300 flex items-center justify-center">
                                <i data-lucide="plus" class="w-4 h-4 mr-2"></i>a?�Xa�F?a??c?R
                            </button>
                        </div>
                        
                        <button id="save-location-settings" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700 mb-4 flex items-center justify-center">
                            <i data-lucide="save" class="w-4 h-4 mr-2"></i>a?2a-?e�L-aR?
                        </button>
                    </div>`;
                
                lucide.createIcons();
                
                // a?? Firebase eR�a??e�L-aR?
                const settingsRef = doc(db, "settings", "location");
                getDoc(settingsRef).then((docSnap) => {
                    if (docSnap.exists()) {
                        const settings = docSnap.data();
                        document.getElementById('company-lat').value = settings.companyLat || '';
                        document.getElementById('company-lng').value = settings.companyLng || '';
                        document.getElementById('company-radius').value = settings.companyRadius || 100;
                        document.getElementById('mark-abnormal-location').checked = settings.markAbnormalLocation !== false;
                        
                        // a�M2a??a??a??a??c?R
                        renderOtherLocations(settings.otherLocations || []);
                    }
                }).catch(error => {
                    console.error("Error getting location settings:", error);
                    showToast("c?!a3?eR�a??a??c?Re�L-aR?", true);
                });
                
                // a�M2a??a??a??a??c?R
                function renderOtherLocations(locations) {
                    const container = document.getElementById('other-locations');
                    container.innerHTML = '';
                    
                    if (locations.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-center">a�X?a?ae�L-aR?a??a??a??c?R</p>';
                        return;
                    }
                    
                    locations.forEach((location, index) => {
                        const locationEl = document.createElement('div');
                        locationEl.className = 'bg-gray-50 p-3 rounded-md border';
                        locationEl.innerHTML = `
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-medium">${location.name || `a??c?R ${index + 1}`}</h4>
                                <button class="delete-location-btn text-red-500" data-index="${index}">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div>
                                    <label class="block text-xs text-gray-500">a??c�L��</label>
                                    <input type="text" class="location-name w-full px-2 py-1 border rounded-md text-sm" value="${location.name || ''}" placeholder="a??c?Ra??c�L��">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500">a??a?? (a??a�Xo)</label>
                                    <input type="number" class="location-radius w-full px-2 py-1 border rounded-md text-sm" value="${location.radius || 100}" min="10" max="1000">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-xs text-gray-500">c�P��ao|</label>
                                    <input type="number" class="location-lat w-full px-2 py-1 border rounded-md text-sm" value="${location.lat || ''}" step="0.000001">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500">c??ao|</label>
                                    <input type="number" class="location-lng w-full px-2 py-1 border rounded-md text-sm" value="${location.lng || ''}" step="0.000001">
                                </div>
                            </div>
                        `;
                        container.appendChild(locationEl);
                    });
                    
                    lucide.createIcons();
                    
                    // a?ae??a??c?Ra??e??ao?a??
                    document.querySelectorAll('.delete-location-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.currentTarget.dataset.index);
                            const settingsRef = doc(db, "settings", "location");
                            getDoc(settingsRef).then((docSnap) => {
                                if (docSnap.exists()) {
                                    const settings = docSnap.data();
                                    const otherLocations = settings.otherLocations || [];
                                    otherLocations.splice(index, 1);
                                    renderOtherLocations(otherLocations);
                                }
                            });
                        });
                    });
                }
                
                // a?�Xa�F?a??c?Ra??e??ao?a??
                document.getElementById('add-location-btn').addEventListener('click', () => {
                    const settingsRef = doc(db, "settings", "location");
                    getDoc(settingsRef).then((docSnap) => {
                        const settings = docSnap.exists() ? docSnap.data() : {};
                        const otherLocations = settings.otherLocations || [];
                        otherLocations.push({
                            name: `a??c?R ${otherLocations.length + 1}`,
                            lat: '',
                            lng: '',
                            radius: 100
                        });
                        renderOtherLocations(otherLocations);
                    });
                });
                
                // a?2a-?e�L-aR?
                document.getElementById('save-location-settings').addEventListener('click', async () => {
                    try {
                        showLoading(true);
                        const companyLat = parseFloat(document.getElementById('company-lat').value);
                        const companyLng = parseFloat(document.getElementById('company-lng').value);
                        const companyRadius = parseInt(document.getElementById('company-radius').value);
                        const markAbnormalLocation = document.getElementById('mark-abnormal-location').checked;
                        
                        // a??e??a??a??a??c?Re3?a??
                        const otherLocations = [];
                        document.querySelectorAll('#other-locations > div').forEach(el => {
                            const name = el.querySelector('.location-name').value;
                            const lat = parseFloat(el.querySelector('.location-lat').value);
                            const lng = parseFloat(el.querySelector('.location-lng').value);
                            const radius = parseInt(el.querySelector('.location-radius').value);
                            
                            if (name && !isNaN(lat) && !isNaN(lng) && !isNaN(radius)) {
                                otherLocations.push({ name, lat, lng, radius });
                            }
                        });
                        
                        await setDoc(doc(db, "settings", "location"), {
                            companyLat,
                            companyLng,
                            companyRadius,
                            markAbnormalLocation,
                            otherLocations,
                            updatedAt: serverTimestamp()
                        }, { merge: true });
                        
                        showToast("a??c?Re�L-aR?a�P2a?2a-?");
                    } catch (error) {
                        console.error("Error saving location settings:", error);
                        showToast("a?2a-?a??c?Re�L-aR?a?��a??", true);
                    } finally {
                        showLoading(false);
                    }
                });
            }
            
            function renderSettingsHolidays(container) {
                container.innerHTML = `
                    <div class="p-4">
                        <div class="bg-white p-4 rounded-md shadow-sm border mb-4">
                            <h3 class="font-bold text-lg mb-4">a�M?c?-a??e??e�L-aR?</h3>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label for="work-start-time" class="block text-sm font-medium text-gray-700">a�M?c?-a??e??</label>
                                    <input type="time" id="work-start-time" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                                <div>
                                    <label for="work-end-time" class="block text-sm font-medium text-gray-700">a�M?c?-a??e??</label>
                                    <input type="time" id="work-end-time" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <label for="weekend-is-holiday" class="text-gray-700">e���a??c?oa??a??a?�D</label>
                                <label class="switch">
                                    <input type="checkbox" id="weekend-is-holiday" checked>
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="bg-white p-4 rounded-md shadow-sm border mb-4">
                            <h3 class="font-bold text-lg mb-4">a??a??a?�De�L-aR?</h3>
                            <div class="flex items-center space-x-2 mb-4">
                                <input type="date" id="holiday-date" class="flex-grow px-3 py-2 border rounded-md">
                                <button id="add-holiday-btn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-md hover:bg-gray-300 flex items-center justify-center">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <div id="holidays-list" class="space-y-2 max-h-[300px] overflow-y-auto">
                                <!-- a??a??a?�Da??e!�La??a??a??a�P?a??a?�Le�?e�G! -->
                                <p class="text-gray-500 text-center">eR�a??a�M-...</p>
                            </div>
                        </div>
                        
                        <button id="save-holiday-settings" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700 mb-4 flex items-center justify-center">
                            <i data-lucide="save" class="w-4 h-4 mr-2"></i>a?2a-?e�L-aR?
                        </button>
                    </div>`;
                
                lucide.createIcons();
                
                // a?? Firebase eR�a??e�L-aR?
                const settingsRef = doc(db, "settings", "holidays");
                getDoc(settingsRef).then((docSnap) => {
                    if (docSnap.exists()) {
                        const settings = docSnap.data();
                        document.getElementById('work-start-time').value = settings.workStartTime || '09:00';
                        document.getElementById('work-end-time').value = settings.workEndTime || '18:00';
                        document.getElementById('weekend-is-holiday').checked = settings.weekendIsHoliday !== false;
                        
                        // a�M2a??a??a??a?�Da??e!�L
                        renderHolidaysList(settings.holidays || []);
                    } else {
                        // e??e�L-a�?
                        document.getElementById('work-start-time').value = '09:00';
                        document.getElementById('work-end-time').value = '18:00';
                        document.getElementById('weekend-is-holiday').checked = true;
                        renderHolidaysList([]);
                    }
                }).catch(error => {
                    console.error("Error getting holiday settings:", error);
                    showToast("c?!a3?eR�a??a??a??a?�De�L-aR?", true);
                    renderHolidaysList([]);
                });
                
                // a�M2a??a??a??a?�Da??e!�L
                function renderHolidaysList(holidays) {
                    const container = document.getElementById('holidays-list');
                    container.innerHTML = '';
                    
                    if (holidays.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-center">a�X?a?ae�L-aR?a??a??a?�D</p>';
                        return;
                    }
                    
                    // a??ao?a??a??a?�D
                    holidays.sort((a, b) => new Date(a) - new Date(b));
                    
                    holidays.forEach((holiday, index) => {
                        const date = new Date(holiday);
                        const formattedDate = date.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
                        
                        const holidayEl = document.createElement('div');
                        holidayEl.className = 'flex items-center justify-between bg-gray-50 p-2 rounded-md border';
                        holidayEl.innerHTML = `
                            <span>${formattedDate}</span>
                            <button class="delete-holiday-btn text-red-500" data-index="${index}">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        `;
                        container.appendChild(holidayEl);
                    });
                    
                    lucide.createIcons();
                    
                    // a?ae??a??a??a?�Da??e??ao?a??
                    document.querySelectorAll('.delete-holiday-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.currentTarget.dataset.index);
                            const settingsRef = doc(db, "settings", "holidays");
                            getDoc(settingsRef).then((docSnap) => {
                                if (docSnap.exists()) {
                                    const settings = docSnap.data();
                                    const holidays = settings.holidays || [];
                                    holidays.splice(index, 1);
                                    renderHolidaysList(holidays);
                                }
                            });
                        });
                    });
                }
                
                // a?�Xa�F?a??a??a?�Da??e??ao?a??
                document.getElementById('add-holiday-btn').addEventListener('click', () => {
                    const holidayDate = document.getElementById('holiday-date').value;
                    if (!holidayDate) {
                        showToast("e??e?�Ma??a?�Da??", true);
                        return;
                    }
                    
                    const settingsRef = doc(db, "settings", "holidays");
                    getDoc(settingsRef).then((docSnap) => {
                        const settings = docSnap.exists() ? docSnap.data() : {};
                        const holidays = settings.holidays || [];
                        
                        // aa�Fa?�Da?��a?|a�P2a-?a?�L
                        if (holidays.includes(holidayDate)) {
                            showToast("a-?a?�Da??a�P2e�L-c?oa??a??a?�D", true);
                            return;
                        }
                        
                        holidays.push(holidayDate);
                        renderHolidaysList(holidays);
                        document.getElementById('holiday-date').value = '';
                    });
                });
                
                // a?2a-?e�L-aR?
                document.getElementById('save-holiday-settings').addEventListener('click', async () => {
                    try {
                        showLoading(true);
                        const workStartTime = document.getElementById('work-start-time').value;
                        const workEndTime = document.getElementById('work-end-time').value;
                        const weekendIsHoliday = document.getElementById('weekend-is-holiday').checked;
                        
                        // a??e??a??a??a?�De3?a??
                        const holidays = [];
                        const settingsRef = doc(db, "settings", "holidays");
                        const docSnap = await getDoc(settingsRef);
                        if (docSnap.exists()) {
                            const settings = docSnap.data();
                            holidays.push(...(settings.holidays || []));
                        }
                        
                        await setDoc(doc(db, "settings", "holidays"), {
                            workStartTime,
                            workEndTime,
                            weekendIsHoliday,
                            holidays,
                            updatedAt: serverTimestamp()
                        }, { merge: true });
                        
                        showToast("a??a??a?�De�L-aR?a�P2a?2a-?");
                    } catch (error) {
                        console.error("Error saving holiday settings:", error);
                        showToast("a?2a-?a??a??a?�De�L-aR?a?��a??", true);
                    } finally {
                        showLoading(false);
                    }
                });
            }
            
            function renderSettingsRules(container) {
                container.innerHTML = `
                    <div class="p-4">
                        <button id="add-rule-btn" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700 mb-4 flex items-center justify-center">
                            <i data-lucide="plus-circle" class="w-4 h-4 mr-2"></i>a?�Xa�F?e|?a??
                        </button>
                        <div id="rule-list" class="space-y-2">eR�a??a�M-...</div>
                    </div>`;
                lucide.createIcons();
                document.getElementById('add-rule-btn').addEventListener('click', () => openRuleModal());

                const ruleList = document.getElementById('rule-list');
                const rulesRef = collection(db, "pointRules");
                const q = query(rulesRef, orderBy("reason"));
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    ruleList.innerHTML = '';
                    if (querySnapshot.empty) {
                        ruleList.innerHTML = `<p class="text-center text-gray-500 p-4">a�X?a?aa?oc??a??a??e|?a??</p>`;
                        return;
                    }
                    querySnapshot.forEach(doc => {
                        const rule = { id: doc.id, ...doc.data() };
                        const pointsClass = rule.points > 0 ? 'text-green-600' : 'text-red-600';
                        const ruleElement = document.createElement('div');
                        ruleElement.className = 'flex items-center justify-between bg-white p-3 rounded-md shadow-sm border';
                        ruleElement.innerHTML = `
                            <div>
                                <p class="font-medium text-gray-800">${rule.reason}</p>
                                <p class="text-sm text-gray-500">a�X?e��!: ${rule.target}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="font-bold text-lg ${pointsClass}">${rule.points > 0 ? '+' : ''}${rule.points}</span>
                                <button data-ruleid="${rule.id}" class="edit-rule-btn p-2 text-gray-500 hover:text-red-600"><i data-lucide="edit" class="w-4 h-4"></i></button>
                                <button data-ruleid="${rule.id}" class="delete-rule-btn p-2 text-gray-500 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        `;
                        ruleList.appendChild(ruleElement);
                    });
                    lucide.createIcons();

                    document.querySelectorAll('.edit-rule-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                         const ruleId = e.currentTarget.dataset.ruleid;
                         const ruleDoc = await getDoc(doc(db, "pointRules", ruleId));
                         if (ruleDoc.exists()) {
                            openRuleModal({ id: ruleId, ...ruleDoc.data() });
                         }
                    }));

                    document.querySelectorAll('.delete-rule-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                        const ruleId = e.currentTarget.dataset.ruleid;
                        if (confirm('c�FoaR?e|?a?ae??a-?e|?a??a??i??')) {
                            await deleteDoc(doc(db, "pointRules", ruleId));
                            showToast("e|?a??a?ae??a??a??");
                        }
                    }));

                });
                state.activeListeners.push(unsubscribe);
            }

            // --- Modals ---
            function openMapModal(lat, lng) {
                const modalId = `map-modal-${Date.now()}`;
                
                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[90%] max-w-[500px] bg-white rounded-lg shadow-xl flex flex-col">
                            <div class="flex justify-between items-center p-4 border-b">
                                <h3 class="font-bold text-lg">a??c?Re3?e�L?</h3>
                                <button class="close-btn text-gray-500 hover:text-gray-700">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <div id="modal-map" class="h-[300px] w-full"></div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                lucide.createIcons();
                
                const modal = document.getElementById(modalId);
                modal.querySelector('.close-btn').addEventListener('click', () => {
                    modal.remove();
                });
                const dlBtn = modal.querySelector('.download-btn');
                if (dlBtn) {
                    dlBtn.addEventListener('click', async () => {
                        try {
                            const slides = modal.querySelectorAll('.photo-slide');
                            if (!slides || slides.length === 0) { showToast('無照片可下載', true); return; }
                            let currentIndex = 0;
                            if (slides.length > 1) {
                                const idx = Array.from(slides).findIndex(s => s.style.display !== 'none');
                                currentIndex = idx >= 0 ? idx : 0;
                            }
                            const imgEl = slides[currentIndex]?.querySelector('img');
                            const src = imgEl?.src;
                            if (!src) { showToast('無照片可下載', true); return; }

                            const defaultName = `clock-in-photo-${Date.now()}`;
                            const canDownloadAttr = 'download' in HTMLAnchorElement.prototype;
                            const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

                            if (src.startsWith('data:')) {
                                const mime = src.substring(5, src.indexOf(';'));
                                let ext = 'jpg';
                                if (mime.includes('png')) ext = 'png';
                                else if (mime.includes('jpeg')) ext = 'jpg';
                                else if (mime.includes('webp')) ext = 'webp';
                                if (canDownloadAttr && !isIOS) {
                                    const a = document.createElement('a');
                                    a.href = src;
                                    a.download = `${defaultName}.${ext}`;
                                    document.body.appendChild(a); a.click(); document.body.removeChild(a);
                                } else {
                                    window.open(src, '_blank');
                                }
                            } else {
                                try {
                                    const res = await fetch(src, { mode: 'cors' });
                                    if (!res.ok) throw new Error('下載失敗');
                                    const blob = await res.blob();
                                    const url = URL.createObjectURL(blob);
                                    const extGuess = (blob.type && blob.type.split('/')[1]) || 'jpg';
                                    if (canDownloadAttr && !isIOS) {
                                        const a = document.createElement('a');
                                        a.href = url;
                                        a.download = `${defaultName}.${extGuess}`;
                                        document.body.appendChild(a); a.click(); document.body.removeChild(a);
                                    } else {
                                        window.open(url, '_blank');
                                    }
                                    setTimeout(() => URL.revokeObjectURL(url), 5000);
                                } catch (fetchErr) {
                                    window.open(src, '_blank');
                                }
                            }
                        } catch (err) {
                            console.error('下載照片失敗', err);
                            showToast('下載照片失敗', true);
                        }
                    });
                }
                
                if (window.google && window.google.maps) {
                    const mapDiv = document.getElementById('modal-map');
                    const map = new google.maps.Map(mapDiv, {
                        center: { lat, lng },
                        zoom: 17
                    });
                    
                    new google.maps.Marker({
                        position: { lat, lng },
                        map: map
                    });
                } else {
                    document.getElementById('modal-map').innerHTML = 
                        '<div class="p-4 text-center text-red-500">Google Maps a�X?a?ae??a?�Di??e??c�L?a??a??ec|</div>';
                }
            }
            
            function openPhotoModal(photos, descriptions) {
                const modalId = `photo-modal-${Date.now()}`;
                
                let contentHTML;
                if (photos && photos.length > 0) {
                    contentHTML = photos.map((url, index) => `
                        <div class="photo-slide">
                            <img src="${url}" class="max-h-[400px] max-w-full object-contain mx-auto" onerror="this.src='https://via.placeholder.com/400x300?text=c?��c??e??a?�Da?��a??'">
                            <p class="text-center mt-2 text-gray-600">${descriptions[index] || ''}</p>
                        </div>
                    `).join('');
                } else {
                    contentHTML = '<div class="p-4 text-center text-gray-500">c?!c?��c??</div>';
                }
                
                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[90%] max-w-[500px] bg-white rounded-lg shadow-xl flex flex-col">
                            <div class="flex justify-between items-center p-4 border-b">
                                <h3 class="font-bold text-lg">照片瀏覽</h3>
                                <div class="flex items-center gap-2">
                                    <button class="download-btn text-gray-600 hover:text-gray-800" title="下載">
                                        <i data-lucide="download" class="w-5 h-5"></i>
                                    </button>
                                    <button class="close-btn text-gray-500 hover:text-gray-700">
                                        <i data-lucide="x" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="p-4 photo-container">
                                ${contentHTML}
                            </div>
                            ${(photos?.length || 0) > 1 ? `
                            <div class="flex justify-center p-2 gap-2">
                                <button class="prev-btn bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded">上一張</button>
                                <button class="next-btn bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded">下一張</button>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                lucide.createIcons();
                
                const modal = document.getElementById(modalId);
                modal.querySelector('.close-btn').addEventListener('click', () => {
                    modal.remove();
                });
                
                if ((photos?.length || 0) > 1) {
                    const slides = modal.querySelectorAll('.photo-slide');
                    let currentSlide = 0;
                    
                    slides.forEach((slide, index) => {
                        slide.style.display = index === 0 ? 'block' : 'none';
                    });
                    
                    modal.querySelector('.prev-btn').addEventListener('click', () => {
                        slides[currentSlide].style.display = 'none';
                        currentSlide = (currentSlide - 1 + slides.length) % slides.length;
                        slides[currentSlide].style.display = 'block';
                    });
                    
                    modal.querySelector('.next-btn').addEventListener('click', () => {
                        slides[currentSlide].style.display = 'none';
                        currentSlide = (currentSlide + 1) % slides.length;
                        slides[currentSlide].style.display = 'block';
                    });
                }
            }

            // 新增：編輯出勤紀錄彈窗
            function openEditRecordModal(record) {
                const modalId = `edit-record-modal-${Date.now()}`;
                const toDatetimeLocal = (iso) => {
                    try {
                        const d = iso ? new Date(iso) : new Date();
                        const pad = (n) => String(n).padStart(2, '0');
                        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
                    } catch {
                        return '';
                    }
                };
                const typeOptions = ['上班','下班','外出','返回','抵達','離開','自動下班'];
                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[90%] max-w-[520px] bg-white rounded-lg shadow-xl">
                            <div class="flex justify-between items-center p-4 border-b">
                                <h3 class="font-bold text-lg">編輯出勤紀錄</h3>
                                <button class="close-btn text-gray-500 hover:text-gray-700"><i data-lucide="x" class="w-5 h-5"></i></button>
                            </div>
                            <div class="p-4 space-y-3">
                                <div>
                                    <label class="text-sm">狀態</label>
                                    <select id="edit-type" class="border rounded px-2 py-1 w-full">
                                        ${typeOptions.map(t => `<option value="${t}" ${t===record.type? 'selected':''}>${t}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="text-sm">時間</label>
                                    <input id="edit-time" type="datetime-local" value="${toDatetimeLocal(record.timeISO)}" class="border rounded px-2 py-1 w-full" />
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="text-sm">緯度</label>
                                        <input id="edit-lat" type="number" step="0.000001" value="${record.lat ?? ''}" class="border rounded px-2 py-1 w-full" />
                                    </div>
                                    <div>
                                        <label class="text-sm">經度</label>
                                        <input id="edit-lng" type="number" step="0.000001" value="${record.lng ?? ''}" class="border rounded px-2 py-1 w-full" />
                                    </div>
                                </div>
                                <div>
                                    <label class="text-sm">地點名稱</label>
                                    <input id="edit-location-name" type="text" value="${record.locationName || ''}" class="border rounded px-2 py-1 w-full" />
                                </div>
                                <div>
                                    <label class="text-sm">勤務類型</label>
                                    <input id="edit-duty-type" type="text" value="${record.dutyType || ''}" class="border rounded px-2 py-1 w-full" />
                                </div>
                            </div>
                            <div class="flex justify-end gap-2 p-4 border-t">
                                <button class="cancel-btn px-3 py-1 rounded bg-gray-200">取消</button>
                                <button class="save-btn px-3 py-1 rounded bg-blue-600 text-white">儲存</button>
                            </div>
                        </div>
                    </div>`;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                lucide.createIcons();
                const modalEl = document.getElementById(modalId);
                const close = () => { modalEl?.remove(); };
                modalEl.querySelector('.close-btn')?.addEventListener('click', close);
                modalEl.querySelector('.cancel-btn')?.addEventListener('click', close);
                modalEl.querySelector('.save-btn')?.addEventListener('click', async () => {
                    try {
                        const db = window.__db; const { updateDoc, doc, GeoPoint, Timestamp } = window.__fs;
                        const type = document.getElementById('edit-type').value;
                        const timeStr = document.getElementById('edit-time').value;
                        const latStr = document.getElementById('edit-lat').value;
                        const lngStr = document.getElementById('edit-lng').value;
                        const locationName = document.getElementById('edit-location-name').value?.trim?.() || '';
                        const dutyType = document.getElementById('edit-duty-type').value?.trim?.() || '';
                        const allowed = ['上班','下班','外出','返回','抵達','離開','自動下班'];
                        if (!allowed.includes(type)) { showToast('狀態不合法', true); return; }
                        const d = timeStr ? new Date(timeStr) : new Date();
                        const updateData = { type, timestamp: Timestamp.fromDate(d) };
                        const lat = latStr ? parseFloat(latStr) : null;
                        const lng = lngStr ? parseFloat(lngStr) : null;
                        if (typeof lat === 'number' && typeof lng === 'number' && !Number.isNaN(lat) && !Number.isNaN(lng)) {
                            updateData.location = new GeoPoint(lat, lng);
                        }
                        if (locationName) updateData.locationName = locationName.slice(0, 100);
                        if (dutyType) updateData.dutyType = dutyType.slice(0, 100);
                        await updateDoc(doc(db, 'clockInRecords', record.id), updateData);
                        showToast('更新成功');
                        close();
                    } catch (e) {
                        console.error('update clockInRecord error', e);
                        showToast('更新失敗：請檢查權限或資料格式', true);
                    }
                });
            }

            function openUserModal(user = null) {
                const modalId = `user-modal-${Date.now()}`;
                const isEditing = user !== null;
                const title = isEditing ? 'c�P�Le?��a�M3e??' : 'a?�Xa�F?a�M3e??';
                let newUserAvatarFile = null;
                const close = () => document.getElementById(modalId)?.remove();

                const defaultAvatar = 'https://placehold.co/80x80/EFEFEF/333333?text=e?-a??';

                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[90%] max-w-md bg-white rounded-lg shadow-xl flex flex-col" style="max-height: 90vh;">
                            <div class="flex justify-between items-center p-4 border-b flex-shrink-0">
                                <h3 class="font-bold text-lg">${title}</h3>
                                <button class="close-btn text-gray-500 hover:text-gray-700"><i data-lucide="x" class="w-5 h-5"></i></button>
                            </div>
                            <form id="user-form" class="p-4 space-y-4 overflow-y-auto">
                                <!-- Avatar Section -->
                                <div class="flex flex-col items-center space-y-2">
                                    <img id="user-avatar-preview" src="${isEditing && user.avatarUrl ? user.avatarUrl : defaultAvatar}" class="w-20 h-20 rounded-full object-cover">
                                    <input type="file" id="user-avatar-upload" class="hidden" accept="image/*">
                                    <div class="flex space-x-2">
                                        <button type="button" id="user-upload-avatar-btn" class="text-sm px-3 py-1 bg-gray-200 rounded-md">a�M?a?3c?��c??</button>
                                
                                    </div>
                                </div>
                                
                                <!-- Form Fields -->
                                <div>
                                    <label for="user-name" class="block text-sm font-medium text-gray-700">a��?a?? (a??a!?)</label>
                                    <input type="text" id="user-name" value="${isEditing ? user.name : ''}" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                </div>
                                 <div>
                                    <label for="user-phone" class="block text-sm font-medium text-gray-700">a??ac?e??c�F?</label>
                                    <input type="tel" id="user-phone" value="${isEditing ? user.phone || '' : ''}" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                                 <div>
                                    <label for="user-lineid" class="block text-sm font-medium text-gray-700">Line ID</label>
                                    <input type="text" id="user-lineid" value="${isEditing ? user.lineId || '' : ''}" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                                <div>
                                    <label for="user-email" class="block text-sm font-medium text-gray-700">e??a-?e?�ga?? / a�M3e?? (a??a!?)</label>
                                    <input type="email" id="user-email" value="${isEditing ? user.email : ''}" ${isEditing ? 'disabled' : ''} class="w-full mt-1 px-3 py-2 border rounded-md ${isEditing ? 'bg-gray-100' : ''}" required>
                                </div>
                                ${!isEditing ? `
                                <div>
                                    <label for="user-password" class="block text-sm font-medium text-gray-700">e�L-aR?a��?c�F? (a??a!?, e?3a�X?6a??a?�M)</label>
                                    <input type="password" id="user-password" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                </div>
                                <div>
                                    <label for="user-confirm-password" class="block text-sm font-medium text-gray-700">a??a?!c�Foea?a��?c�F? (a??a!?)</label>
                                    <input type="password" id="user-confirm-password" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                </div>
                                ` : ''}
                                <div>
                                    <label for="user-role" class="block text-sm font-medium text-gray-700">e��?e?2 (a??a!?)</label>
                                    <select id="user-role" class="w-full mt-1 px-3 py-2 border rounded-md">
                                        <option value="field" ${isEditing && user.role === 'field' ? 'selected' : ''}>a??a??</option>
                                        <option value="user" ${isEditing && user.role === 'user' ? 'selected' : ''}>a?��a??</option>
                                        <option value="junior_manager" ${isEditing && user.role === 'junior_manager' ? 'selected' : ''}>a??e??a�M?cR!</option>
                                        <option value="manager" ${isEditing && user.role === 'manager' ? 'selected' : ''}>e??e??a�M?cR!</option>
                                        <option value="hr" ${isEditing && user.role === 'hr' ? 'selected' : ''}>aooao?</option>
                                        <option value="admin" ${isEditing && user.role === 'admin' ? 'selected' : ''}>cR!c??a?!</option>
                                    </select>
                                </div>
                                
                                <p id="user-form-error" class="text-red-500 text-sm text-center"></p>
                                <div class="flex justify-end space-x-2 pt-2 flex-shrink-0">
                                     <button type="button" class="cancel-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">a??a??</button>
                                     <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">a?2a-?</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                modalContainer.innerHTML = modalHTML;
                lucide.createIcons();
                
                const modal = document.getElementById(modalId);
                const userForm = document.getElementById('user-form');
                const errorEl = document.getElementById('user-form-error');
                const avatarPreview = document.getElementById('user-avatar-preview');
                const avatarUploadInput = document.getElementById('user-avatar-upload');

                // --- Avatar Logic ---
                // a??e�L��a?�a??c?�La??i??a??a??c�P�Le?��c??a??c?�La??i??a�M?a?3e?-a??
                const uploadBtn = document.getElementById('user-upload-avatar-btn');
                if (uploadBtn) {
                    uploadBtn.addEventListener('click', () => avatarUploadInput.click());
                }
                
                avatarUploadInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        newUserAvatarFile = file;
                        avatarPreview.src = URL.createObjectURL(file);
                    }
                });
                
                


                // --- Form Logic ---
                modal.querySelector('.close-btn').addEventListener('click', close);
                modal.querySelector('.cancel-btn').addEventListener('click', close);

                userForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    showLoading(true);
                    errorEl.textContent = '';

                    // --- Form Data Collection ---
                    const name = document.getElementById('user-name').value;
                    const phone = document.getElementById('user-phone').value;
                    const lineId = document.getElementById('user-lineid').value;
                    const email = document.getElementById('user-email').value;
                    const role = document.getElementById('user-role').value;
                    
                    const updateData = { name, phone, lineId, role, email };

                    try {
                        let targetUserId = isEditing ? user.id : null;
                        let newAvatarUrl = isEditing ? user.avatarUrl : null;

                        // --- Password Validation (for new users) ---
                        if (!isEditing) {
                            const password = document.getElementById('user-password').value;
                            const confirmPassword = document.getElementById('user-confirm-password').value;
                            if (password.length < 6) {
                                throw new Error("a��?c�F?e?�Pao|e?3a�X?e?�e|?6a�?a-?a??a�?");
                            }
                            if (password !== confirmPassword) {
                                throw new Error("a?ca?!e?�Ma?�Dc??a��?c�F?a�M?c?�Mc?|a�?");
                            }
                        }

                        // --- User Creation (if applicable) ---
                        if (!isEditing) {
                            const password = document.getElementById('user-password').value;
                            const { initializeApp: initializeAppSecondary, deleteApp } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
                            const secondaryApp = initializeAppSecondary(firebaseConfig, `secondary-app-${Date.now()}`);
                            const secondaryAuth = getAuth(secondaryApp);
                             try {
                                const userCredential = await createUserWithEmailAndPassword(secondaryAuth, email, password);
                                targetUserId = userCredential.user.uid;
                                // c�Foa??a?�Xc?�La??c??c??a?2e??a?�Me??e�L-c?o0
                                updateData.points = 0;
                            } catch (creationError) {
                                if (creationError.code === 'auth/email-already-in-use') throw new Error('a-?e??a-?e?�ga??a�P2e�F?e�L?a??a�?');
                                else throw new Error('a?oc??ec?e-?a�M3e??a?��a??i??e??c�L?a??a??ec|a�?');
                            } finally {
                                await signOut(secondaryAuth);
                                await deleteApp(secondaryApp);
                            }
                        }
                        
                        // --- Avatar Upload (if new avatar is set) ---
                        if (newUserAvatarFile) {
                            try {
                                // a??c?�L Base64 c�P�Lc�F?a??a?�G Firebase Storage a�M?a?3
                                const reader = new FileReader();
                                const base64Promise = new Promise((resolve, reject) => {
                                    reader.onload = () => resolve(reader.result);
                                    reader.onerror = () => reject(new Error("eR�a??aa?a!?a?��a??"));
                                    reader.readAsDataURL(newUserAvatarFile);
                                });
                                
                                // c-?a?? Base64 e??a??aR?a??
                                const base64String = await base64Promise;
                                
                                // c?��a?�Da�X? Base64 a-?a�M2a?2a-?a?�X Firestore
                                newAvatarUrl = base64String;
                                console.log("e?-a??a�P2e??a??c?o Base64 a??a??");
                            } catch (avatarError) {
                                console.error("e?-a??e??c??e?��ea?:", avatarError);
                                showToast("e?-a??e??c??a?��a??i??a??a??c1?co?a?2a-?a??a??e3?a??", true);
                            }
                        }
                        updateData.avatarUrl = newAvatarUrl;

                        // --- Database Operation ---
                        if (isEditing) {
                            await updateDoc(doc(db, "users", targetUserId), updateData);
                            showToast("a??c?�Le�?e3?a??a?��a?�Xa??a??");
                        } else {
                            updateData.status = "a?aa??a?!";
                            updateData.createdAt = serverTimestamp();
                            await setDoc(doc(db, "users", targetUserId), updateData);
                            showToast("a?�Xa�M3e??a?oc??a??a??");
                        }
                        
                        close();

                    } catch (error) {
                        console.error("User modal error:", error);
                        errorEl.textContent = error.message || 'a??a??a?��a??i??e??c�L?a??a??ec|a�?';
                    } finally {
                        showLoading(false);
                    }
                });
            }
            
            function openRuleModal(rule = null) {
                const modalId = `rule-modal-${Date.now()}`;
                const isEditing = rule !== null;
                const title = isEditing ? 'c�P�Le?��e|?a??' : 'a?�Xa�F?e|?a??';
                const close = () => document.getElementById(modalId)?.remove();

                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[90%] max-w-md bg-white rounded-lg shadow-xl flex flex-col">
                            <div class="flex justify-between items-center p-4 border-b">
                                <h3 class="font-bold text-lg">${title}</h3>
                                <button class="close-btn text-gray-500 hover:text-gray-700"><i data-lucide="x" class="w-5 h-5"></i></button>
                            </div>
                            <form id="rule-form" class="p-4 space-y-4">
                                <div>
                                    <label for="rule-reason" class="block text-sm font-medium text-gray-700">ao?c?��</label>
                                    <input type="text" id="rule-reason" value="${isEditing ? rule.reason : ''}" placeholder="a??a|?i??e?2a?�X" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                </div>
                                <div>
                                    <label for="rule-points" class="block text-sm font-medium text-gray-700">e??a?�M (a?��c?oe2?a?�M)</label>
                                    <input type="number" id="rule-points" value="${isEditing ? rule.points : ''}" placeholder="-1" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                </div>
                                <div>
                                    <label for="rule-target" class="block text-sm font-medium text-gray-700">e?cc?�La�X?e��!</label>
                                    <select id="rule-target" class="w-full mt-1 px-3 py-2 border rounded-md">
                                        <option value="a�?aoo" ${isEditing && rule.target === 'a�?aoo' ? 'selected' : ''}>a�?aoo</option>
                                        <option value="a?�Le??" ${isEditing && rule.target === 'a?�Le??' ? 'selected' : ''}>a?�Le??</option>
                                    </select>
                                </div>
                                <p id="rule-form-error" class="text-red-500 text-sm text-center"></p>
                                <div class="flex justify-end space-x-2 pt-2">
                                     <button type="button" class="cancel-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">a??a??</button>
                                     <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">a?2a-?</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                modalContainer.innerHTML = modalHTML;
                lucide.createIcons();

                const modal = document.getElementById(modalId);
                const ruleForm = document.getElementById('rule-form');
                const errorEl = document.getElementById('rule-form-error');

                modal.querySelector('.close-btn').addEventListener('click', close);
                modal.querySelector('.cancel-btn').addEventListener('click', close);

                ruleForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    showLoading(true);
                    errorEl.textContent = '';

                    const reason = document.getElementById('rule-reason').value;
                    const points = Number(document.getElementById('rule-points').value);
                    const target = document.getElementById('rule-target').value;

                    if (!reason || isNaN(points)) {
                        errorEl.textContent = 'e??a!?a��?a?�a??a??a??a�?';
                        showLoading(false);
                        return;
                    }

                    try {
                        if (isEditing) {
                            const ruleRef = doc(db, "pointRules", rule.id);
                            await updateDoc(ruleRef, { reason, points, target });
                            showToast("e|?a??a?��a?�Xa??a??");
                        } else {
                            await addDoc(collection(db, "pointRules"), { reason, points, target });
                            showToast("a?�Xe|?a??a?�Xa�F?a??a??");
                        }
                        close();
                    } catch (error) {
                        console.error("Rule modal error:", error);
                        errorEl.textContent = 'a??a??a?��a??i??e??c�L?a??a??ec|a�?';
                    } finally {
                        showLoading(false);
                    }
                });
            }

            function renderProfileModal() {
                const modalId = `profile-modal-${Date.now()}`;
                const close = () => document.getElementById(modalId)?.remove();

                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[90%] max-w-md bg-white rounded-lg shadow-xl flex flex-col">
                            <div class="flex justify-between items-center p-4 border-b">
                                <h3 class="font-bold text-lg">a�?aooe3?a??</h3>
                                <button class="close-btn text-gray-500 hover:text-gray-700"><i data-lucide="x" class="w-5 h-5"></i></button>
                            </div>

                            <div class="p-4 space-y-4 overflow-y-auto">
                                <!-- Avatar section -->
                                <div class="flex flex-col items-center space-y-2">
                                    <img id="modal-avatar" src="${state.currentUserData.avatarUrl || `https://placehold.co/80x80/EFEFEF/333333?text=${state.currentUserData.name.charAt(0)}`}" alt="Avatar" class="w-20 h-20 rounded-full object-cover">
                                    <label for="avatar-upload" class="cursor-pointer text-blue-600 hover:text-blue-800">
                                        a?��a??e?-a??
                                        <input type="file" id="avatar-upload" accept="image/*" class="hidden">
                                    </label>
                                </div>

                                <!-- Info -->
                                <div class="text-center">
                                    <p class="font-bold text-xl">${state.currentUserData.name}</p>
                                    <p class="text-gray-500">${state.currentUserData.email}</p>
                                </div>
                                
                                <!-- c??a?2e??a?�M -->
                                <div class="border-t pt-4">
                                    <h4 class="font-semibold mb-2">c??a?2e??a?�M</h4>
                                    <p class="text-center text-3xl font-bold">${state.currentUserData.points || 0} e??</p>
                                </div>

                                <!-- a?aa??e??a?? -->
                                <div class="border-t pt-4">
                                    <h4 class="font-semibold mb-2">e??a??c?3e??</h4>
                                    <div id="future-leaves" class="space-y-2"></div>
                                </div>
                            </div>

                            <div class="p-4 border-t">
                                <button id="logout-btn" class="w-full bg-gray-200 text-gray-700 py-2 rounded-md hover:bg-gray-300">c??a?o</button>
                            </div>
                        </div>
                    </div>
                `;

                modalContainer.innerHTML = modalHTML;
                lucide.createIcons();

                const modal = document.getElementById(modalId);
                const changePasswordForm = document.getElementById('change-password-form');
                const logoutBtn = document.getElementById('logout-btn');
                const avatarUploadInput = document.getElementById('avatar-upload');

                modal.querySelector('.close-btn').addEventListener('click', close);
                
                // a�P?a??c??a?oa??e??ao?a??c?�Ge??a?�L
                logoutBtn.addEventListener('click', async () => {
                    try {
                        showLoading(true);
                        await signOut(auth);
                        showToast("a�P2a??a??c??a?o");
                        window.location.reload();
                    } catch (error) {
                        console.error("c??a?oa?��a??:", error);
                        showToast("c??a?oa?��a??i??e??c�L?a??a??ec|", true);
                        showLoading(false);
                    }
                });

                async function processAndUploadAvatar(file) {
                    if (!file) return;
                    showLoading(true);
                    try {
                        const maxBytes = 900 * 1024; // 約 900KB 上限
                        let blob = await compressToBlob(file, 300, 'image/jpeg', 0.85);
                        if (!blob) throw new Error('圖片壓縮失敗');
                        if (blob.size > maxBytes) {
                            blob = await compressToBlob(file, 300, 'image/jpeg', 0.7);
                        }
                        if (blob.size > maxBytes) {
                            throw new Error('選擇的圖片過大（需小於約 900KB），請換較小的圖片');
                        }

                        const storage = getStorage();
                        const avatarRef = ref(storage, `userAvatars/${state.currentUser.uid}.jpg`);
                        await uploadBytes(avatarRef, blob, { contentType: 'image/jpeg' });
                        const url = await getDownloadURL(avatarRef);

                        await updateDoc(doc(db, 'users', state.currentUser.uid), { avatarUrl: url });
                        state.currentUserData.avatarUrl = url;
                        document.getElementById('modal-avatar').src = url;
                        const header = document.getElementById('header-avatar');
                        if (header) header.src = url;
                        showToast('頭像更新成功');
                    } catch (error) {
                        console.error('Avatar upload error:', error);
                        showToast('頭像上傳失敗: ' + (error.message || error), true);
                    } finally {
                        showLoading(false);
                    }
                }

                avatarUploadInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    await processAndUploadAvatar(file);
                });

                
                // 壓縮並轉 Base64（Data URL）
                async function compressToBase64(file, maxWidth) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onerror = () => reject(new Error('讀取圖片失敗'));
                        reader.onload = (event) => {
                            const img = new Image();
                            img.onerror = () => reject(new Error('圖片載入失敗'));
                            img.src = event.target.result;
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                let width = img.width;
                                let height = img.height;
                                if (width > maxWidth) {
                                    height = Math.round((height * maxWidth) / width);
                                    width = maxWidth;
                                }
                                canvas.width = width;
                                canvas.height = height;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0, width, height);
                                try {
                                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                                    resolve(dataUrl);
                                } catch (e) {
                                    reject(e);
                                }
                            };
                        };
                        reader.readAsDataURL(file);
                    });
                }

                // 新增：壓縮為 Blob（行動端更穩定，避免 Base64 大字串）
                async function compressToBlob(file, maxWidth, mime = 'image/jpeg', quality = 0.85) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onerror = () => reject(new Error('讀取圖片失敗'));
                        reader.onload = (event) => {
                            const img = new Image();
                            img.onerror = () => reject(new Error('圖片載入失敗'));
                            img.src = event.target.result;
                            img.onload = () => {
                                try {
                                    const canvas = document.createElement('canvas');
                                    let width = img.width;
                                    let height = img.height;
                                    if (width > maxWidth) {
                                        height = Math.round((height * maxWidth) / width);
                                        width = maxWidth;
                                    }
                                    canvas.width = width;
                                    canvas.height = height;
                                    const ctx = canvas.getContext('2d');
                                    ctx.drawImage(img, 0, 0, width, height);
                                    if (canvas.toBlob) {
                                        canvas.toBlob((b) => {
                                            if (b) {
                                                resolve(b);
                                            } else {
                                                reject(new Error('圖片壓縮失敗'));
                                            }
                                        }, mime, quality);
                                    } else {
                                        const dataUrl = canvas.toDataURL(mime, quality);
                                        // 優先使用 ObjectURL，避免一次性持有大型字串
                                        const objectUrl = URL.createObjectURL(dataURLtoBlob(dataUrl));
                                        fetch(objectUrl).then(r => r.blob()).then((b) => { URL.revokeObjectURL(objectUrl); resolve(b); }).catch((e) => { URL.revokeObjectURL(objectUrl); reject(e); });
                                    }
                                } catch (err) {
                                    reject(err);
                                }
                            };
                        };
                        reader.readAsDataURL(file);
                    });
                }

                // DataURL 轉 Blob 的輔助函式（避免直接傳遞大型字串）
                function dataURLtoBlob(dataurl) {
                    const arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1];
                    const bstr = atob(arr[1]);
                    let n = bstr.length;
                    const u8arr = new Uint8Array(n);
                    while (n--) { u8arr[n] = bstr.charCodeAt(n); }
                    return new Blob([u8arr], { type: mime });
                }

                logoutBtn.addEventListener('click', async () => {
                    close();
                    await signOut(auth);
                    showToast("a?�La�P2a??a??c??a?o");
                });

                // e??a?�De??a??c?3e??a�M?a?R
                (async function loadFutureLeaves() {
                    const container = document.getElementById('future-leaves');
                    if (!container) return;
                    try {
                        const uid = state.currentUser?.uid;
                        if (!uid) {
                            container.innerHTML = '<div class="text-sm text-red-600">e??a??c??a?�D</div>';
                            return;
                        }
                        container.innerHTML = '<div class="text-sm text-gray-500">e??a?�Da�M-...</div>';
                        const now = new Date();
                        const q = query(
                            collection(db, 'leaves'),
                            where('userId', '==', uid)
                        );
                        const snap = await getDocs(q);
                        const future = [];
                        snap.forEach(d => {
                            const l = d.data();
                            if (l.startTime && (l.startTime.toDate ? l.startTime.toDate() : new Date(l.startTime)) >= now) {
                                future.push({ id: d.id, ...l });
                            }
                        });
                        if (future.length === 0) {
                            container.innerHTML = '<div class="text-sm text-gray-500">a2?a??e??a??c?3e??</div>';
                            return;
                        }
                        future.sort((a, b) => (a.startTime.toDate ? a.startTime.toDate() : new Date(a.startTime)) - (b.startTime.toDate ? b.startTime.toDate() : new Date(b.startTime)));
                        const statusText = s => (
                            s === 'pending' ? 'a??a��ca?�M' : s === 'approved' ? 'a�P2a?�Ma??' : s === 'rejected' ? 'a�P2a??c�g?' : 'a?ac?�D'
                        );
                        const statusClass = s => (
                            s === 'pending' ? 'bg-yellow-100 text-yellow-800' : s === 'approved' ? 'bg-green-100 text-green-800' : s === 'rejected' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'
                        );
                        container.innerHTML = future.map(l => `
                            <div class="p-3 rounded-md border bg-white">
                                <div class="text-sm font-medium">
                                    ${l.reason || 'c?!ao?c?��'}
                                    <span class="ml-2 text-xs px-2 py-0.5 rounded-full ${statusClass(l.status)}">${statusText(l.status)}</span>
                                </div>
                                <div class="text-xs text-gray-600 mt-1">a?? ${formatDateTime(l.startTime)} e?3 ${formatDateTime(l.endTime)}</div>
                                <div class="text-xs text-gray-500">${l.reasonType || ''}</div>
                            </div>
                        `).join('');
                    } catch (e) {
                        console.error('e??a?�De??a??c?3e??a?��a??:', e);
                        container.innerHTML = '<div class="text-sm text-red-600">e??a?�De??a??c?3e??a?��a??</div>';
                    }
                })();
            }

            function renderLeaveInfo(userData) {
                if (!userData) return 'c?Ra??a2?a??e??a??e�L?e??';
                let isLeave = userData.clockInStatus === 'e?�La??e??a??';
                if (!isLeave && (userData.leaveStatus === 'approved' || userData.leaveStatus === 'pending')) {
                    const toDate = v => v?.toDate ? v.toDate() : (v ? new Date(v) : null);
                    const startTime = toDate(userData.leaveStartTime);
                    const endTime = toDate(userData.leaveEndTime);
                    const now = new Date();
                    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                    isLeave = !!(startTime && endTime && startTime <= todayEnd && endTime >= todayStart);
                }
                if (!isLeave) return 'c?Ra??a2?a??e??a??e�L?e??';
                const statusText = userData.leaveStatus === 'approved' ? 'a�P2e??a??' : 'e??a??c?3e??';
                const reasonText = userData.leaveReason ? `${userData.leaveReason}` : '';
                const typeText = userData.reasonType ? `(${userData.reasonType})` : '';
                const toDate = v => v?.toDate ? v.toDate() : (v ? new Date(v) : null);
                const startTime = toDate(userData.leaveStartTime);
                const endTime = toDate(userData.leaveEndTime);
                const timeInfo = (startTime && endTime) ? `<div class="text-sm mt-1">a?? ${formatDateTime(startTime)} e?3 ${formatDateTime(endTime)}</div>` : '';
                return `<div class="font-medium">${statusText}: ${reasonText} ${typeText}</div>${timeInfo}`;
            }

            function openAvatarCameraModal(callback) {
                const modalId = `avatar-camera-modal-${Date.now()}`;
                let videoStream;
                
                const stopCamera = () => {
                    if (videoStream) videoStream.getTracks().forEach(track => track.stop());
                };
                const close = () => {
                    stopCamera();
                    document.getElementById(modalId)?.remove();
                };

                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop" style="z-index: 60;">
                        <div class="modal-content w-[90%] max-w-md bg-black rounded-lg shadow-xl flex flex-col p-4 text-white">
                            <video id="avatar-video" playsinline autoplay muted class="w-full h-auto rounded-lg"></video>
                            <canvas id="avatar-canvas" class="hidden"></canvas>
                            <div class="flex justify-center mt-4">
                                <button id="avatar-capture-btn" class="w-16 h-16 bg-white rounded-full border-4 border-gray-500"></button>
                            </div>
                             <button id="avatar-cancel-btn" class="text-gray-400 mt-2">a??a??</button>
                        </div>
                    </div>`;
                document.body.insertAdjacentHTML('beforeend', modalHTML);

                const video = document.getElementById('avatar-video');
                const canvas = document.getElementById('avatar-canvas');

                navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false })
                    .then(stream => {
                        videoStream = stream;
                        video.muted = true;
                        video.srcObject = stream;
                        Promise.resolve(video.play()).catch(() => {});
                    }).catch(err => {
                        showToast("c?!a3?e??a??c?�Mac?", true);
                        close();
                    });

                document.getElementById('avatar-capture-btn').addEventListener('click', () => {
                    const context = canvas.getContext('2d');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    canvas.toBlob(blob => {
                        callback(blob);
                        close();
                    }, 'image/jpeg');
                });
                document.getElementById('avatar-cancel-btn').addEventListener('click', close);
            }

            function openCameraModal(type, location) {
                 const modalId = `camera-modal-${Date.now()}`;
                let videoStream;
                const capturedPhotos = []; // { blob, description }

                const stopCamera = () => {
                    if (videoStream) {
                        videoStream.getTracks().forEach(track => track.stop());
                    }
                };

                const close = () => {
                    stopCamera();
                    document.getElementById(modalId)?.remove();
                };

                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[390px] h-[730px] bg-black rounded-2xl shadow-xl flex flex-col p-4 text-white">
                            <div id="camera-view" class="flex-grow relative flex items-center justify-center">
                                <video id="camera-video" playsinline autoplay muted class="w-full h-full object-cover rounded-lg"></video>
                                <canvas id="camera-canvas" class="hidden"></canvas>
                                <div id="camera-loader" class="absolute inset-0 flex items-center justify-center bg-black/50"><div class="loader"></div></div>
                            </div>
                            <div id="preview-view" class="hide flex-grow flex flex-col">
                                <img id="photo-preview" class="w-full h-auto flex-grow object-contain rounded-lg">
                                <input type="text" id="photo-description" class="w-full mt-2 bg-gray-800 border border-gray-600 rounded-md px-3 py-2" placeholder="e?�Ma?�Deaaa?? (30a-?a?��)" maxlength="30">
                            </div>

                            <div class="flex-shrink-0 pt-4">
                                <div id="capture-controls" class="flex items-center justify-between">
                                    <button id="switch-camera-btn" class="w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center">
                                        <i data-lucide="refresh-cw" class="w-6 h-6"></i>
                                    </button>
                                    <button id="capture-btn" class="w-20 h-20 bg-white rounded-full border-4 border-gray-500 flex items-center justify-center">
                                        <i data-lucide="camera" class="w-10 h-10 text-gray-800"></i>
                                    </button>
                                    <div class="w-12 h-12"></div><!-- ccoc??a??c��?a??a??a�X?c�L�� -->
                                </div>
                                <div id="confirm-controls" class="hide grid grid-cols-2 gap-2">
                                    <button id="add-another-btn" class="py-3 bg-gray-600 rounded-lg">a??a�M?a�M�a?�g</button>
                                    <button id="finish-btn" class="py-3 bg-red-600 rounded-lg font-semibold">aR?a??a??a?!</button>
                                </div>
                            </div>
                             <div class="flex-shrink-0 text-center pt-2">
                                <button id="cancel-camera-btn" class="text-gray-400">a??a??</button>
                            </div>
                        </div>
                    </div>
                `;
                modalContainer.innerHTML = modalHTML;

                const video = document.getElementById('camera-video');
                const canvas = document.getElementById('camera-canvas');
                const cameraView = document.getElementById('camera-view');
                const previewView = document.getElementById('preview-view');
                const photoPreview = document.getElementById('photo-preview');
                const descriptionInput = document.getElementById('photo-description');
                const captureControls = document.getElementById('capture-controls');
                const confirmControls = document.getElementById('confirm-controls');

                navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false })
                    .then(stream => {
                        videoStream = stream;
                        video.muted = true;
                        video.srcObject = stream;
                        Promise.resolve(video.play()).catch(() => {});
                        document.getElementById('camera-loader').classList.add('hide');
                        
                        lucide.createIcons();
                        
                        let currentFacingMode = "environment";
                        document.getElementById('switch-camera-btn').addEventListener('click', async () => {
                            stopCamera();
                            document.getElementById('camera-loader').classList.remove('hide');
                            currentFacingMode = currentFacingMode === "environment" ? "user" : "environment";
                            
                            try {
                                const newStream = await navigator.mediaDevices.getUserMedia({ 
                                    video: { facingMode: currentFacingMode }, 
                                    audio: false 
                                });
                                
                                videoStream = newStream;
                                video.muted = true;
                                video.srcObject = newStream;
                                try { await Promise.resolve(video.play()); } catch {}
                                document.getElementById('camera-loader').classList.add('hide');
                            } catch (error) {
                                console.error("a??a??c?�Mac?a?��a??:", error);
                                showToast("a??a??c?�Mac?a?��a??i??e??e??ec|", true);
                                document.getElementById('camera-loader').classList.add('hide');
                            }
                        });
                    })
                    .catch(err => {
                        console.error("Camera error:", err);
                        showToast("c?!a3?e??a??c?�Mac?", true);
                        close();
                    });

                document.getElementById('capture-btn').addEventListener('click', () => {
                    const context = canvas.getContext('2d');
                    // e�L-c?Ra?oaR?a��?ao|i??a??a??a??a??a��?a��?a??
                    const videoWidth = video.videoWidth;
                    const videoHeight = video.videoHeight;
                    const targetWidth = 390;
                    const targetHeight = (videoHeight / videoWidth) * targetWidth;
                    
                    canvas.width = targetWidth;
                    canvas.height = targetHeight;
                    
                    // c1ae�G?a�M|a??a??a??a��?a��?a??
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    // a�P?a??a�gRa�X��a?�X
                    context.font = '16px Arial';
                    context.fillStyle = 'rgba(255, 255, 255, 0.7)';
                    const now = new Date();
                    const dateTimeText = `${now.toLocaleDateString('zh-TW')} ${now.toLocaleTimeString('zh-TW')}`;
                const locationText = (state.currentLocation && typeof state.currentLocation.lat === 'number' && typeof state.currentLocation.lng === 'number') ? `a??c?R: ${state.currentLocation.lat.toFixed(6)}, ${state.currentLocation.lng.toFixed(6)}` : 'c?!a??c?Re3?e�L?';
                    const userText = `${state.currentUserData.name} - ${type}a??a?!`;
                    
                    // a?�Lao?e?�La�P?a??a�gRa�X��a?�X
                    context.fillText(dateTimeText, 10, canvas.height - 40);
                    context.fillText(locationText, 10, canvas.height - 20);
                    context.fillText(userText, 10, canvas.height - 60);
                    
                    photoPreview.src = canvas.toDataURL('image/jpeg');
                    cameraView.classList.add('hide');
                    previewView.classList.remove('hide');
                    captureControls.classList.add('hide');
                    confirmControls.classList.remove('hide');
                });
                
                const saveAndPrepareNext = () => {
                     canvas.toBlob(blob => {
                        if (!blob) {
                            showToast("c?��c??e??c??a?��a??", true);
                            return;
                        }
                        const description = descriptionInput.value;
                        capturedPhotos.push({ blob, description });
                        
                        descriptionInput.value = '';
                        cameraView.classList.remove('hide');
                        previewView.classList.add('hide');
                        captureControls.classList.remove('hide');
                        confirmControls.classList.add('hide');
                        showToast(`a�P2a?2a-? ${capturedPhotos.length} a?�gc?��c??`);

                     }, 'image/jpeg', 0.8);
                };

                document.getElementById('add-another-btn').addEventListener('click', saveAndPrepareNext);

                document.getElementById('finish-btn').addEventListener('click', () => {
                    if (previewView.classList.contains('hide') === false) {
                         canvas.toBlob((blob) => {
                            if (blob) {
                                const description = descriptionInput.value;
                                capturedPhotos.push({ blob, description });
                            }
                            completeClockIn();
                         }, 'image/jpeg', 0.8);
                    } else {
                        completeClockIn();
                    }
                });

                const completeClockIn = async () => {
                    if (capturedPhotos.length === 0) {
                        showToast("e??e?3a�X?a??a??a�M�a?�gc?��c??", true);
                        return;
                    }
                    stopCamera();
                    showLoading(true);

                    try {
                        // a??a??e�L��aR?a?�Le|?a??a�M-c??a??a?!e!?a??
                        const allowedTypes = ['a�M?c?-','a�M?c?-','a??a?o','e??a??','a?�ge??','e?�Fe??','e?aa??a�M?c?-'];
                        if (!allowedTypes.includes(type)) {
                            console.warn('a�M?a??e�L��c??a??a?!e!?a??i??a�P2a??a??a��?a?�Di??', type);
                            showToast('a-?a??a?!e!?a??a�M?a?��a?��c���e??a��?a?�Di??e??a?1c?�La�X?a??a??e??', true);
                            return;
                        }

                        // a�X?c?��c??e??a??c?o Data URL a�M|a?2a-?i??a?�Fa?ca??e!?c?oi??
                        const photoPromises = capturedPhotos.map(async (photo) => {
                            return new Promise((resolve) => {
                                const reader = new FileReader();
                                reader.onloadend = () => {
                                    resolve({
                                        url: reader.result,
                                        description: photo.description
                                    });
                                };
                                reader.readAsDataURL(photo.blob);
                            });
                        });

                        const uploadedPhotos = await Promise.all(photoPromises);
                        // Firestore e|?a??i??a?�a?? 3 a?�gc?��c??i??a??e?�Xa?�Me??e?�a�M�e?��
                        const limitedPhotos = uploadedPhotos.slice(0, 3);
                        const photoUrls = limitedPhotos.map(p => p.url);
                        // Firestore a�M?a??e�L�� undefinedi??a�X?e??a-?a�M2eaaa??e??c?occoa-?a�M2
                        const descriptions = limitedPhotos.map(p => (typeof p.description === 'string' ? p.description : ''));

                        // aR?a?�Lao��a�L?e??c??i??e?�Dc?oa�X?a??c?oa??a??i??a??c?�L (0,0)
                        const safeLat = (location && typeof location.lat === 'number') ? location.lat : 0;
                        const safeLng = (location && typeof location.lng === 'number') ? location.lng : 0;

                        const uid = window.__auth?.currentUser?.uid || state.currentUser?.uid;
                        if (!uid) {
                            throw new Error('a?ac??a?�Da??a??a�M?a?�Xa??c?�Le�?i??c?!a3?a��?a?�Da??a?!e�L?e??');
                        }
                        const recordData = {
                            userId: uid,
                            type: type,
                            timestamp: Timestamp.now(),
                            location: new GeoPoint(safeLat, safeLng),
                            photoUrls,
                            descriptions,
                            deviceId: state.deviceId || 'unknown-device'
                        };
                        // a??a??e??c?Ri??a??a??a?oa??a?��e??a-?a?�Li??i??e??a?? undefined a��?a?�D
                        if (type === 'a??a?o' && state.dutyType) {
                            recordData.dutyType = state.dutyType;
                        }
                        
                        // a|?a??a?��a??a?oa??a?!i??a�P?a??a?�Xe??a??c�L��
                        if (type === 'a??a?o') {
                            const locName = typeof location.name === 'string' ? location.name : '';
                            if (locName) {
                                recordData.locationName = locName.slice(0, 100);
                            }
                        }
                        
                        try {
                            await addDoc(collection(db, "clockInRecords"), recordData);
                        } catch (e) {
                            console.error('a?�Xa�F? clockInRecords a?��a??i??', e?.code, e?.message || e, { keys: Object.keys(recordData), type: recordData.type, locationIsGeoPoint: recordData.location instanceof GeoPoint, photosLen: recordData.photoUrls.length, descLen: recordData.descriptions.length });
                            throw e;
                        }

                        // e|?a?!a??a?!e�G?c?RIDa��?a?�Di??a??c??a??c?�Le�?a�X?a?aa?? firstClockInDeviceId
                        try {
                            const uid3 = window.__auth?.currentUser?.uid || state.currentUser?.uid;
                            const userRef = doc(db, "users", uid3);
                            const userSnap = await getDoc(userRef);
                            const hasFirst = userSnap.exists() && userSnap.data().firstClockInDeviceId;
                            if (!hasFirst && type === 'a�M?c?-') {
                                await updateDoc(userRef, { firstClockInDeviceId: state.deviceId || 'unknown-device' });
                            }
                        } catch (e) {
                            console.warn('a��?a?�De|?a?!a??a?!e�G?c?RIDa?��a??', e);
                        }

                        const userUpdateData = {
                            status: type,
                            clockInStatus: type,
                            lastUpdated: Timestamp.now()
                        };
                        
                        // a|?a??a?��a??a?oa??a?!i??a�P?a??a??a?oa?�Xe??a??c�L��
                        if (type === 'a??a?o') {
                            const locName2 = typeof location.name === 'string' ? location.name : '';
                            if (locName2) {
                                userUpdateData.outboundLocation = locName2.slice(0, 100);
                            }
                        }
                        // a??a?oa??a??a-�Da��?a?�Da??a??e??c?Ri??e?�Da??i??
                        if (type === 'a??a?o' && state.dutyType) {
                            userUpdateData.dutyType = state.dutyType;
                        }
                        
                        try {
                            const uid2 = window.__auth?.currentUser?.uid || state.currentUser?.uid;
                            await updateDoc(doc(db, "users", uid2), userUpdateData);
                        } catch (e) {
                            console.error('a?��a?�X users c?�a??a?��a??i??', e?.code, e?.message || e, { keys: Object.keys(userUpdateData) });
                            throw e;
                        }

                        // a?��a?�Xa??a?�Xc?�a??
                        state.clockInStatus = type;
                        
                        // a|?a??a?��a�M?c?-a??a?!i??a??a??e?aa??a�M?c?-a??a?!e�L?a??a?�L
                        if (type === 'a�M?c?-' && typeof startAutoClockOutTimer === 'function') {
                            // e??a?�Xe??a?�De�L-aR?a�M|a??a??e�L?a??a?�L
                            loadAutoClockOutSettings().then(() => {
                                startAutoClockOutTimer();
                            });
                        }
                        
                        // a|?a??a?��a�M?c?-a??a?!i??a??a-�Fe?aa??a�M?c?-a??a?!e�L?a??a?�L
                        if (type === 'a�M?c?-' && typeof stopAutoClockOutTimer === 'function') {
                            stopAutoClockOutTimer();
                        }
                        
                        // a?��a?�Xe??e?�Fe!��c?o
                        updateStatusDisplay();
                        
                        showToast(`${type}a??a?!a??a??i??`);
                        close();
                        showPage('clock-in', 'location');  // a?1c?oe!��c?oaR?a??a??a?!e??e?�F

                    } catch (error) {
                        console.error("Clock in error:", error);
                        showToast("a??a?!a?��a??i??e??c�L?a??a??ec|", true);
                    } finally {
                        showLoading(false);
                    }
                };

                document.getElementById('cancel-camera-btn').addEventListener('click', close);
            }

            // --- Google Maps ---
            function loadGoogleMapsScript() {
                if (window.google && state.googleMapsLoaded) return;
                
                window.initMap = () => { 
                    state.googleMapsLoaded = true; 
                    console.log("Google Maps API a�P2a??a??a??e??");
                };
                
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&callback=initMap&v=weekly`;
                script.async = true;
                script.defer = true;
                
                script.onerror = () => {
                    console.error("Google Maps API a??e??a?��a??");
                    showToast("a?�Xa??a??a??a??e??a?��a??i??e??aa�Fa?�Dc?2c�g!e��Ga?�Da??APIe??e?�X", true);
                };
                
                document.head.appendChild(script);
            }
            
            // --- Helper functions ---
            function cleanupListeners() {
                state.activeListeners.forEach(unsubscribe => unsubscribe());
                state.activeListeners = [];
            }

            // c��?e??e??c?? getStatusColor a??a?�Mi??a??c?�L dashboard-functions.js a�M-c??c??a??
            
            // a�M2a??e??a??e3?e�L?i??c??ao?a�?c??a??i??a??c?�Lc�g��a�M�c??a??a?�Pe??e?��i??
            function renderLeaveInfo(userData) {
                if (!userData) return 'c?Ra??a2?a??e??a??e�L?e??';
                let isLeave = userData.clockInStatus === 'e?�La??e??a??';
                if (!isLeave && (userData.leaveStatus === 'approved' || userData.leaveStatus === 'pending')) {
                    const toDate = v => v?.toDate ? v.toDate() : (v ? new Date(v) : null);
                    const startTime = toDate(userData.leaveStartTime);
                    const endTime = toDate(userData.leaveEndTime);
                    const now = new Date();
                    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                    isLeave = !!(startTime && endTime && startTime <= todayEnd && endTime >= todayStart);
                }
                if (!isLeave) {
                    // aa�Fa?�Da?��a?|c?oc?1aR?a??a??
                    if (userData.clockInStatus === 'c?1aR?a??a??') {
                        const dutyName = userData.dutyName || 'a?aa??aR?a??a??';
                        const location = userData.dutyLocation || 'a?aa??aR?a?�Xe??';
                        
                        let startTimeStr = 'a?aa??aR?a??e??';
                        let endTimeStr = 'a?aa??aR?a??e??';
                        
                        if (userData.dutyStartTime) {
                            const startTime = userData.dutyStartTime.toDate ? 
                                userData.dutyStartTime.toDate() : 
                                new Date(userData.dutyStartTime);
                            startTimeStr = startTime.toLocaleString('zh-TW');
                        }
                        
                        if (userData.dutyEndTime) {
                            const endTime = userData.dutyEndTime.toDate ? 
                                userData.dutyEndTime.toDate() : 
                                new Date(userData.dutyEndTime);
                            endTimeStr = endTime.toLocaleString('zh-TW');
                        }
                        
                        return `
                            <div class="font-semibold text-lg">a?�Pe!?c?1aR?a??a??</div>
                            <div class="mt-2">
                                <p><span class="font-medium">a??a??a??c�L��i??</span>${dutyName}</p>
                                <p><span class="font-medium">a??a??a?�Xe??i??</span>${location}</p>
                                <p><span class="font-medium">e??a��?a??e??i??</span>${startTimeStr}</p>
                                <p><span class="font-medium">c�g?a??a??e??i??</span>${endTimeStr}</p>
                            </div>
                        `;
                    }
                    return 'c?Ra??a2?a??e??a??e�L?e??';
                }
                const leaveStatus = userData.leaveStatus === 'approved' ? 'a�P2e??a??' : 'e??a??c?3e??';
                const reason = userData.leaveReason || 'a?aa??aR?a??a??';
                
                const toDate = v => v?.toDate ? v.toDate() : (v ? new Date(v) : null);
                const startTime = toDate(userData.leaveStartTime);
                const endTime = toDate(userData.leaveEndTime);
                const startTimeStr = startTime ? startTime.toLocaleString('zh-TW') : 'a?aa??aR?a??e??';
                const endTimeStr = endTime ? endTime.toLocaleString('zh-TW') : 'a?aa??aR?a??e??';
                
                return `
                    <div class="font-semibold text-lg">${leaveStatus}</div>
                    <div class="mt-2">
                        <p><span class="font-medium">ao?c?��i??</span>${reason}</p>
                        <p><span class="font-medium">e??a��?a??e??i??</span>${startTimeStr}</p>
                        <p><span class="font-medium">c�g?a??a??e??i??</span>${endTimeStr}</p>
                    </div>
                `;
            }
            

            function showToast(message, isError = false) {
                toast.textContent = message;
                toast.className = `toast show ${isError ? 'bg-red-500' : 'bg-gray-800'}`;
                setTimeout(() => {
                    toast.className = 'toast';
                }, 3000);
            }
            // a??a?�La??a?��c?�Li??a?�Da??a??a??e?3a??a??a??
            window.showToast = showToast;

            function timeAgo(date) {
                const seconds = Math.floor((new Date() - date) / 1000);
                let interval = seconds / 31536000;
                if (interval > 1) return Math.floor(interval) + " a1��a??";
                interval = seconds / 2592000;
                if (interval > 1) return Math.floor(interval) + " a??a??";
                interval = seconds / 86400;
                if (interval > 1) return Math.floor(interval) + " a?ca??";
                interval = seconds / 3600;
                if (interval > 1) return Math.floor(interval) + " a�X?a??a??";
                interval = seconds / 60;
                if (interval > 1) return Math.floor(interval) + " a??e??a??";
                return "a??a??";
            }
            
            function formatDate(timestamp) {
                if (!timestamp) return '';
                return timestamp.toDate().toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
            }

            // e�?c?�La?�Da??a??e??a??a??a??i??a?��a?�� Firestore Timestampa�?Datea�?a-?a�M2e??a?�Ma-?
            function formatDateTime(value) {
                if (!value) return '';
                let d;
                try {
                    if (value && typeof value.toDate === 'function') {
                        d = value.toDate();
                    } else if (value instanceof Date) {
                        d = value;
                    } else {
                        d = new Date(value);
                    }
                    if (isNaN(d.getTime())) return '';
                    return d.toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                } catch (e) {
                    console.error('formatDateTime error:', e);
                    return '';
                }
            }
        }

        // c?�La??a??a?oe|?ca?a??e??
        document.addEventListener('click', function(e) {
            // e??e??a�P2a??e??c??a??a?oe|?ca?
            if (!e.target.closest('.user-popup') && !e.target.closest('.user-name-btn')) {
                const existingPopup = document.querySelector('.user-popup');
                if (existingPopup) {
                    existingPopup.remove();
                }
            }
            
            // e??a??c?�La??a??c�L��a??e!��c?oa??a?oe|?ca?
            if (e.target.classList.contains('user-name-btn') || e.target.closest('.user-name-btn')) {
                const nameBtn = e.target.classList.contains('user-name-btn') ? e.target : e.target.closest('.user-name-btn');
                const userId = nameBtn.dataset.userId;
                const userName = nameBtn.dataset.userName;
                const userPhone = nameBtn.dataset.userPhone;
                
                // e??e??a�P2a??e??c??a??a?oe|?ca?
                const existingPopup = document.querySelector('.user-popup');
                if (existingPopup) {
                    existingPopup.remove();
                }
                
                // a?�ga?oa?�Xc??a??a?oe|?ca?
                const popup = document.createElement('div');
                popup.className = 'user-popup fixed bg-white rounded-lg shadow-lg p-3 z-50';
                popup.style.width = '200px';
                
                // e�L?cR?a??c?R (a?�La??c�L��a�M?a?1) a�M|e??a??e??a?oe|?ca?e??c??
                const rect = nameBtn.getBoundingClientRect();
                const popupWidth = 200; // e?? CSS a��?ao|a�M�e?��
                const margin = 10; // e??e??c??a??a??e�P?e?�F
                let left = rect.left;
                let top = rect.bottom + 5;

                // a?3a?��e??c??aa�Fa?�D
                if (left + popupWidth > window.innerWidth - margin) {
                    left = Math.max(margin, window.innerWidth - popupWidth - margin);
                }
                // a�P|a?��e??c??aa�Fa?�D
                if (left < margin) {
                    left = margin;
                }

                // e??a?�Xe??ao|a�M|a??a�M?e??c??aa�Fa?�Di??e?�De??a?oa??e!��c?oa?�La??c�L��a�M?a?1
                const estimatedHeight = 120; // a?��aR1e??ao|a?�XcR?
                if (top + estimatedHeight > window.innerHeight - margin) {
                    top = rect.top - estimatedHeight - 5;
                }
                // a�M?a?��e??c??aa�Fa?�D
                if (top < margin) {
                    top = margin;
                }

                popup.style.left = `${left}px`;
                popup.style.top = `${top}px`;
                // a??a??e??a??e??ao|a�M|a??e�L��a?2a??
                const availableHeight = window.innerHeight - top - margin;
                popup.style.maxHeight = `${Math.max(80, availableHeight)}px`;
                popup.style.overflow = 'auto';
                
                // a�P?a??a??e?? (a?aa??c??a?�Da??e??ec��a??e??)
                popup.innerHTML = `
                    <div class="flex justify-center">
                        <button class="call-btn bg-blue-500 text-white py-2 px-3 rounded-md flex items-center justify-center" ${userPhone ? '' : 'disabled'} data-phone="${userPhone}">
                            <i data-lucide="phone" class="w-4 h-4 mr-1"></i>a?�Da??e??ec��
                        </button>
                    </div>
                `;
                
                // a�P?a??a?�Xe??e?�F
                document.body.appendChild(popup);
                lucide.createIcons();
                
                // a�P?a??a??e??ao?a??
                popup.querySelector('.call-btn').addEventListener('click', function() {
                    const phone = this.dataset.phone;
                    if (phone) {
                        window.open(`tel:${phone}`);
                    } else {
                        showToast('a-?c?�La??a2?a??e�L-c?Re??ec��e??c�F?', true);
                    }
                });
                
                // Linee??a?ca??e??a�P2c��?e??
            }
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
             lucide.createIcons();
             showLoading(true);
             if (firebaseConfig.apiKey === "YOUR_FIREBASE_API_KEY" || GOOGLE_MAPS_API_KEY === "YOUR_GOOGLE_MAPS_API_KEY") {
                document.getElementById('api-key-warning').classList.remove('hide');
                showLoading(false);
                console.error("API Keys are not configured. Please edit index.html"); 
            } else {
                initializeAppLogic();
            }
        });
    </script>
</body>
</html>
