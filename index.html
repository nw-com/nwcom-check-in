<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¥¿åŒ—ç¤¾å€æ‰“å¡ç³»çµ±</title>
    <link rel="icon" type="image/png" href="https://static.wixstatic.com/ficons/6148f9_bb3f0e3c08bd4a3e83840553497fd866~mv2.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- è‡ªå®šç¾©è…³æœ¬ -->
    <script src="js/dashboard-functions.js"></script>
    <script src="js/features.js" defer></script>
    <script src="js/other.js" defer></script>
    <script src="js/calendar.js" defer></script>
    
    <!-- å·²ç§»é™¤ Firebase compat SDK èˆ‡åˆå§‹åŒ–ï¼›çµ±ä¸€ä½¿ç”¨ä¸‹æ–¹ v10 æ¨¡çµ„æ®µ -->
    
    <script src="clock-in-functions.js?v=20251006" defer></script>
    <script src="reset-points.js?v=20251006" defer></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #1f2937; /* æ·±ç°è‰²èƒŒæ™¯ */
        }
        .main-container {
            width: 400px;
            height: calc(100vh - 100px); /* é€²ä¸€æ­¥ç¸®æ¸›å®¹å™¨é«˜åº¦ */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-radius: 1.5rem;
            overflow: hidden;
            margin: 50px 10px 50px 10px; /* ä¸Š50 ä¸‹50 å·¦10 å³10 */
        }
        .header {
            height: 70px;
        }
        .footer {
            height: 70px;
        }
        .content-area {
            height: calc(100% - 140px);
            overflow-y: auto;
        }
        .hide { display: none !important; }
        .tab-btn.active {
            color: #dc2626; /* red-600 */
            border-top-color: #dc2626; /* red-600 */
        }
        .nav-sub-btn.active {
            color: #dc2626; /* red-600 */
            border-top-color: #dc2626; /* red-600 */
        }
        .sub-tab-btn {
            transition: all 0.2s ease-in-out;
        }
        .sub-tab-btn.active {
            background-color: #dc2626; /* red-600 */
            color: #ffffff; /* white */
            font-weight: 600;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #dc2626; /* red-600 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Modal styles */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background-color: rgba(17, 24, 39, 0.45);
            backdrop-filter: blur(2px);
            z-index: 40;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px; /* åŸºæœ¬å®‰å…¨å…§è· */
            overflow: auto; /* é¿å…å…§å®¹éé•·é€ æˆé®ç½©é˜»æ“‹äº’å‹• */
        }
        .modal-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            max-height: calc(100vh - 40px);
            overflow-y: auto; /* å…§å®¹å¯æ²å‹• */
            -webkit-overflow-scrolling: touch; /* iOS æ²å‹•å„ªåŒ– */
            margin-top: 12px; /* èˆ‡é ‚éƒ¨ä¿æŒè·é›¢ï¼Œé¿å…è¢«åœ°å€åˆ—é®ä½ */
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.25);
            padding: 16px;
        }
        /* iOS/ç€è¦½å™¨å®‰å…¨å€æ”¯æ´ */
        @supports (padding: env(safe-area-inset-top)) {
            .modal-backdrop {
                padding-top: calc(env(safe-area-inset-top) + 12px);
                padding-bottom: calc(env(safe-area-inset-bottom) + 12px);
                padding-left: calc(env(safe-area-inset-left) + 12px);
                padding-right: calc(env(safe-area-inset-right) + 12px);
            }
            .modal-content {
                max-height: calc(100vh - 40px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
                margin-top: calc(env(safe-area-inset-top) + 12px);
            }
        }
        /* Ensure map canvas is visible */
        .map-canvas {
            width: 100%;
            height: 100%;
            background-color: #e5e7eb; /* Gray background as a fallback */
        }
        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: 9999px;
            color: white;
            font-weight: 500;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }
        .toast.show {
            opacity: 1;
            bottom: 110px;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <!-- API Key Warning -->
    <div id="api-key-warning" class="hide fixed inset-0 bg-red-100 z-[9999] p-8 text-red-800 flex flex-col items-center justify-center text-center">
        <i data-lucide="alert-triangle" class="w-16 h-16 mb-4"></i>
        <h2 class="text-2xl font-bold mb-2">è«‹å®Œæˆæœ€å¾Œçš„è¨­å®šæ­¥é©Ÿ</h2>
        <p class="max-w-md">
            ç³»çµ±åµæ¸¬åˆ°æ‚¨å°šæœªè¨­å®š Firebase æˆ– Google Maps çš„ API é‡‘é‘°ã€‚
            <br><br>
            <strong class="text-red-900">é€™ä¸æ˜¯ç¨‹å¼éŒ¯èª¤ï¼Œè€Œæ˜¯å¿…è¦çš„è¨­å®šã€‚</strong> åŸºæ–¼å®‰å…¨è€ƒé‡ï¼Œæˆ‘ç„¡æ³•ç‚ºæ‚¨ç”¢ç”Ÿé‡‘é‘°ï¼Œæ‚¨å¿…é ˆè¦ªè‡ªå®Œæˆæ­¤è¨­å®šã€‚
            <br><br>
            è«‹æ‰“é–‹ <code>index.html</code> æª”æ¡ˆï¼Œæ‰¾åˆ°æœ€ä¸‹æ–¹çš„ <code>&lt;script type="module"&gt;</code> å€å¡Šï¼Œä¸¦ä¾ç…§è¨»è§£æŒ‡ç¤ºå¡«å…¥æ‚¨è‡ªå·±çš„é‡‘é‘°ã€‚è©³ç´°æ­¥é©Ÿè«‹åƒè€ƒ <code>README.md</code> æª”æ¡ˆã€‚
        </p>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="loader"></div>
    </div>

    <!-- Login Page -->
    <div id="login-page" class="w-full max-w-sm p-8 bg-white rounded-2xl shadow-lg hide">
        <div class="text-center mb-8">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-red-600"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4"></path></svg>
            <h1 class="text-2xl font-bold text-gray-800 mt-4">è¥¿åŒ—ç¤¾å€æ‰“å¡ç³»çµ±</h1>
            <p class="text-gray-500">ç¤¾å€ç¶²é ç‰ˆV3.1.1</p>
        </div>
        <form id="login-form">
            <div class="mb-4">
                 <div class="flex justify-between items-center mb-1">
                    <label for="email" class="block text-sm font-medium text-gray-700">é›»å­éƒµä»¶æˆ–æ‰‹æ©Ÿè™Ÿç¢¼</label>
                    <div class="flex items-center">
                        <input id="remember-me" type="checkbox" class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                        <label for="remember-me" class="ml-2 block text-sm text-gray-700">è¨˜ä½æˆ‘</label>
                    </div>
                </div>
                <input type="text" id="email" placeholder="è«‹è¼¸å…¥é›»å­éƒµä»¶æˆ–æ‰‹æ©Ÿè™Ÿç¢¼" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
            </div>
            <div class="mb-6">
                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">å¯†ç¢¼</label>
                <div class="relative">
                    <input type="password" id="password" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 pr-10" required>
                    <button type="button" id="toggle-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500">
                        <i id="password-icon" data-lucide="eye-off" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            <div class="space-y-4">
                <button type="submit" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150">
                    ç™»å…¥
                </button>
                <button type="button" id="apply-account-btn" class="w-full bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition duration-150">
                    ç”³è«‹å¸³è™Ÿ
                </button>
                <button type="button" id="forgot-password-btn" class="w-full bg-white border border-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition duration-150">
                    å¿˜è¨˜å¯†ç¢¼
                </button>
            </div>
            <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
            <p id="login-help" class="text-gray-500 text-xs mt-2 text-center">æ–°å»ºç«‹æˆ–æ ¸å‡†çš„å¸³è™Ÿéœ€è¦å…ˆè¨­å®šå¯†ç¢¼ï¼Œè«‹ä½¿ç”¨ã€Œå¿˜è¨˜å¯†ç¢¼ã€å¯„é€é‡è¨­ä¿¡ã€‚</p>
        </form>
    </div>

    <!-- Reset Password Page (Chinese UI) -->
    <div id="reset-password-page" class="w-full max-w-sm p-8 bg-white rounded-2xl shadow-lg hide">
        <div class="text-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">é‡è¨­æ‚¨çš„å¯†ç¢¼</h2>
            <p id="reset-email" class="text-gray-500 mt-2"></p>
        </div>
        <form id="reset-password-form" class="space-y-4">
            <div>
                <label for="reset-new-password" class="block text-sm font-medium text-gray-700 mb-1">æ–°å¯†ç¢¼</label>
                <div class="relative">
                    <input type="password" id="reset-new-password" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 pr-10" required>
                    <button type="button" id="toggle-reset-new" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500">
                        <i data-lucide="eye-off" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            <div>
                <label for="reset-confirm-password" class="block text-sm font-medium text-gray-700 mb-1">å†æ¬¡ç¢ºèªæ–°å¯†ç¢¼</label>
                <div class="relative">
                    <input type="password" id="reset-confirm-password" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 pr-10" required>
                    <button type="button" id="toggle-reset-confirm" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-500">
                        <i data-lucide="eye-off" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            <p id="reset-error" class="text-red-500 text-sm"></p>
            <button type="submit" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150">
                å„²å­˜
            </button>
            <button type="button" id="reset-back-login" class="w-full mt-2 bg-white border border-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-md hover:bg-gray-50 focus:outline-none">
                è¿”å›ç™»å…¥
            </button>
        </form>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="main-container bg-white flex flex-col hide">
        <!-- Header -->
        <header class="h-[70px] flex items-center justify-between px-4 border-b border-gray-200 flex-shrink-0">
            <div class="flex items-center space-x-2">
                <a id="header-logo" href="index.html?goto=navigation&sub=community" title="è¿”å›å°è¦½é " class="flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-600"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m9 12 2 2 4-4"></path></svg>
                    <span id="header-title" class="text-lg font-bold text-gray-800 whitespace-nowrap">è¥¿åŒ—ç¤¾å€æ‰“å¡ç³»çµ±</span>
                </a>
                <span id="welcome-message" class="text-sm text-gray-600 ml-2"></span>
            </div>
            <button id="profile-avatar-btn">
                <img id="header-avatar" src="https://placehold.co/40x40/EFEFEF/333333?text=U" alt="User Avatar" class="w-10 h-10 rounded-full object-cover">
            </button>
        </header>

        <!-- Main Content -->
        <main id="main-content" class="flex-grow flex flex-col overflow-hidden bg-gray-50">
            <!-- This will be dynamically populated -->
        </main>

        <!-- Footer Navigation -->
        <footer class="h-[70px] border-t border-gray-200 flex-shrink-0 bg-white">
            <nav id="main-nav" class="flex justify-around h-full items-center">
                <button data-tab="dashboard" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2 active">
                    <i data-lucide="layout-dashboard"></i><span class="text-xs mt-1">å„€è¡¨æ¿</span>
                </button>
                <button data-tab="clock-in" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2">
                    <i data-lucide="fingerprint"></i><span class="text-xs mt-1">æ‰“å¡</span>
                </button>
                <button id="nav-tracking" data-tab="tracking" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2">
                    <i data-lucide="map-pin"></i><span class="text-xs mt-1">è¿½è¹¤</span>
                </button>
                <button id="nav-hr" data-tab="hr" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2 hide">
                    <i data-lucide="users"></i><span class="text-xs mt-1">äººå“¡</span>
                </button>
                <button id="nav-features" data-tab="features" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2">
                    <i data-lucide="layers"></i><span class="text-xs mt-1">åŠŸèƒ½</span>
                </button>
                <button id="nav-calendar" data-tab="calendar" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2">
                    <i data-lucide="calendar"></i><span class="text-xs mt-1">è¡Œäº‹æ›†</span>
                </button>
                <button id="nav-schedule" data-tab="schedule" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2 hide">
                    <i data-lucide="calendar-days"></i><span class="text-xs mt-1">æ’ç­</span>
                </button>
                <button id="nav-settings" data-tab="settings" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2">
                    <i data-lucide="settings"></i><span class="text-xs mt-1">è¨­å®š</span>
                </button>
                
                </nav>
        </footer>
    </div>
    
    <!-- Modal Container -->
    <div id="modal-container"></div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>


    <script type="module">
        // --- ğŸš¨ é‡è¦è¨­å®šï¼šè«‹åœ¨æ­¤å¡«å…¥æ‚¨è‡ªå·±çš„ API é‡‘é‘° ğŸš¨ ---
        const firebaseConfig = {
          apiKey: "AIzaSyD81_3sUzJSoQI9ODzpAa95ub2h4xrWCZo",
          authDomain: "nw-checkin-all.firebaseapp.com",
          projectId: "nw-checkin-all",
          storageBucket: "nw-checkin-all.appspot.com",
          messagingSenderId: "162851442567",
          appId: "1:162851442567:web:46e9b42fdbb171d7ff4d22",
          measurementId: "G-PLQS2H99D3"
        };
        const GOOGLE_MAPS_API_KEY = "AIzaSyAzhLdWtycJgfz8UsXWlji63DkXpA4kmyY";
        // Icon library fallback: prevent ReferenceError if lucide not loaded
        if (!window.lucide || typeof window.lucide.createIcons !== 'function') {
            window.lucide = window.lucide || {};
            window.lucide.createIcons = function() {};
            try { console.warn('Lucide æœªè¼‰å…¥ï¼Œå·²ä½¿ç”¨å¾Œå‚™ç©ºå‡½å¼é¿å…éŒ¯èª¤'); } catch (e) {}
        }
        // --- ğŸš¨ è¨­å®šçµæŸ ğŸš¨ ---

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut,
            createUserWithEmailAndPassword, updatePassword, reauthenticateWithCredential,
            EmailAuthProvider, sendPasswordResetEmail,
            verifyPasswordResetCode, confirmPasswordReset
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, collection, onSnapshot,
            query, where, getDocs, serverTimestamp, orderBy, limit, GeoPoint, Timestamp, writeBatch,
            enableIndexedDbPersistence, arrayUnion, arrayRemove
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { 
            getStorage, ref, uploadBytes, getDownloadURL, deleteObject
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // æš´éœ²å¿…è¦çš„ helper ä¾›éæ¨¡çµ„è…³æœ¬ä½¿ç”¨ï¼ˆéæ¸¡æœŸï¼‰
        window.__fs = {
            collection,
            getDocs,
            onSnapshot,
            writeBatch,
            doc,
            serverTimestamp,
            addDoc,
            getDoc,
            updateDoc,
            deleteDoc,
            setDoc,
            query,
            where,
            orderBy,
            limit,
            Timestamp,
            GeoPoint,
            arrayUnion,
            arrayRemove,
        };
        window.__authHelpers = { onAuthStateChanged };

        // å…¨åŸŸç®¡ç†å“¡æª¢æŸ¥å‡½æ•¸ï¼ˆé¿å…å€åŸŸä½œç”¨åŸŸé€ æˆæœªå®šç¾©ï¼‰
        window.checkAdminStatus = async function() {
            try {
                const user = window.__auth?.currentUser;
                if (!user) return false;
                const db = window.__db; const { doc, getDoc } = window.__fs || {};
                if (!db || !doc || !getDoc) return false;
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                return !!(userDoc.exists() && userDoc.data().role === 'admin');
            } catch (error) {
                console.warn('checkAdminStatus å¤±æ•—:', error);
                return false;
            }
        };

        // å…¨åŸŸå¯©æ ¸æ¬Šé™æª¢æŸ¥ï¼šç®¡ç†å“¡ã€äººäº‹ã€é«˜éšä¸»ç®¡ã€åˆéšä¸»ç®¡ã€ç¤¾å€ç®¡ç†å“¡ã€ç¸½å¹¹äº‹çš†å¯
        window.checkReviewerStatus = async function() {
            try {
                const user = window.__auth?.currentUser;
                if (!user) return false;
                const db = window.__db; const { doc, getDoc } = window.__fs || {};
                if (!db || !doc || !getDoc) return false;
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (!userDoc.exists()) return false;
                const role = userDoc.data().role;
                return ['admin','hr','manager','junior_manager','community_admin','ç¤¾å€ç®¡ç†å“¡','ç¸½å¹¹äº‹'].includes(role);
            } catch (error) {
                console.warn('checkReviewerStatus å¤±æ•—:', error);
                return false;
            }
        };

        // Global State
        const state = {
            currentUser: null,
            currentUserData: null,
            googleMapsLoaded: false,
            activeListeners: [],
            currentLocation: null,
            users: [],
            trackingMap: null,
            trackingMarkers: [],
            // ç”¨æ–¼ç•°å¸¸æ¨™ç¤ºçš„è¨­å®šèˆ‡å¿«å–
            markAbnormalLocation: true,
            communitiesById: {},
            availableCommunities: [],
            currentCommunity: null,
            appMode: 'default',
            communityIdFromQuery: null,
            // è‡ªå‹•æ¸…ç†é€€é¿ï¼ˆé¿å…æ¬Šé™ä¸è¶³æ™‚é‡è¤‡å˜—è©¦ï¼‰
            lastCleanupRun: 0,
            cleanupBackoffMs: 60000,
        };
        
        // åˆå§‹åŒ–æœ¬æ©Ÿè£ç½®IDï¼ˆç”¨æ–¼æ‰“å¡ç´€éŒ„èˆ‡é¦–æ¬¡æ‰“å¡è£ç½®æ¨™è¨˜ï¼‰
        (function initDeviceId(){
            try {
                const key = 'device_id';
                let id = localStorage.getItem(key);
                if (!id) {
                    const bytes = new Uint8Array(16);
                    crypto.getRandomValues(bytes);
                    id = Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
                    localStorage.setItem(key, id);
                }
                state.deviceId = id;
            } catch (e) {
                console.warn('åˆå§‹åŒ–è£ç½®IDå¤±æ•—', e);
                state.deviceId = 'unknown-device';
            }
        })();

        // è§’è‰²å°æ‡‰ä¸­æ–‡æ¨™ç±¤
        function roleLabel(role) {
            switch (role) {
                case 'field': return 'å¤–å‹¤';
                case 'user': return 'å…§å‹¤';
                case 'junior_manager': return 'åˆéšä¸»ç®¡';
                case 'manager': return 'é«˜éšä¸»ç®¡';
                case 'hr': return 'äººäº‹';
                case 'community_admin': return 'ç¤¾å€ç®¡ç†å“¡';
                case 'admin': return 'ç®¡ç†å“¡';
                default: return role || 'å…§å‹¤';
            }
        }

        // è§’è‰²å¾½ç« é¡è‰²æ¨£å¼
        function roleBadgeClass(role) {
            switch (role) {
                case 'admin': return 'bg-red-100 text-red-700';
                case 'manager': return 'bg-purple-100 text-purple-700';
                case 'junior_manager': return 'bg-violet-100 text-violet-700';
                case 'hr': return 'bg-amber-100 text-amber-700';
                case 'field': return 'bg-green-100 text-green-700';
                case 'ç¸½å¹¹äº‹': return 'bg-green-100 text-green-700';
                case 'ä¿å…¨': return 'bg-green-100 text-green-700';
                case 'ç§˜æ›¸': return 'bg-green-100 text-green-700';
                case 'æ¸…æ½”': return 'bg-green-100 text-green-700';
                case 'æ©Ÿé›»': return 'bg-green-100 text-green-700';
                default: return 'bg-blue-100 text-blue-700'; // user / å…¶ä»–
            }
        }

        // æ’åºè¼”åŠ©ï¼šç¤¾å€ç·¨è™Ÿï¼ˆå­—æ¯å‰ç¶´ + æ•¸å­—ï¼‰
        function parseCommunityCode(code) {
            const c = (code || '').toString().trim();
            const m = c.match(/^([A-Za-z]+)(\d+)/);
            if (m) {
                return { prefix: m[1].toUpperCase(), num: parseInt(m[2], 10) };
            }
            // ç„¡æ³•è§£æï¼Œä½¿ç”¨æ•´é«”å­—ä¸²ä½œç‚ºå‰ç¶´ï¼Œæ•¸å­—è¨­ç‚ºæ¥µå¤§é¿å…å¹²æ“¾æ’åº
            return { prefix: c.toUpperCase(), num: Number.POSITIVE_INFINITY };
        }
        function compareCommunitiesByCode(a, b) {
            const ca = parseCommunityCode(a?.code || '');
            const cb = parseCommunityCode(b?.code || '');
            if (ca.prefix !== cb.prefix) return ca.prefix.localeCompare(cb.prefix);
            if (ca.num !== cb.num) return ca.num - cb.num;
            // å‰ç¶´èˆ‡æ•¸å­—ç›¸åŒæ™‚ï¼Œä»¥å®Œæ•´å­—ä¸²ç©©å®šæ’åº
            return (a?.code || '').localeCompare(b?.code || '');
        }

        // æ’åºè¼”åŠ©ï¼šäººå“¡ä¾å§“æ°ç­†ç•«ï¼ˆå°‘ â†’ å¤šï¼‰
        const collStroke = (typeof Intl !== 'undefined' && typeof Intl.Collator === 'function')
            ? new Intl.Collator('zh-Hant-u-co-stroke', { sensitivity: 'base' })
            : null;
        function compareUsersBySurnameStroke(a, b) {
            const an = (a?.name || '').trim();
            const bn = (b?.name || '').trim();
            const ac = an.charAt(0);
            const bc = bn.charAt(0);
            if (collStroke) {
                const r = collStroke.compare(ac || '', bc || '');
                if (r !== 0) return r;
            }
            // Fallbackï¼šåŒç­†ç•«æˆ–ç„¡æ³•æ¯”è¼ƒæ™‚ï¼Œæ”¹ç”¨ä¸­æ–‡èªç³»å­—å…¸åº
            return an.localeCompare(bn, 'zh-Hant');
        }

        // æ–°å¢è¼”åŠ©ï¼šåˆ¤æ–·æ˜¯å¦ç‚ºæŒ‡å®šç¤¾å€è§’è‰²ï¼ˆç¸½å¹¹äº‹ã€ç§˜æ›¸ã€ä¿å…¨ã€æ¸…æ½”ã€æ©Ÿé›»ï¼‰
        function isFieldLikeRole(role) {
            const fieldRoles = new Set(['ç¸½å¹¹äº‹','ç§˜æ›¸','ä¿å…¨','æ¸…æ½”','æ©Ÿé›»']);
            return fieldRoles.has((role || '').trim());
        }
        
        const loadingScreen = document.getElementById('loading-screen');
        
        function showLoading(show) {
            if(loadingScreen) loadingScreen.classList.toggle('hide', !show);
        }
        // æ›åˆ°å…¨åŸŸè®“å¤–éƒ¨è…³æœ¬å¯ä½¿ç”¨
        window.showLoading = showLoading;

        function initializeAppLogic() {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            try { auth.languageCode = 'zh-TW'; } catch (_) {}
            const db = getFirestore(app);

            // å•Ÿç”¨ Firestore é›¢ç·šæŒä¹…åŒ–èˆ‡ç·šä¸Š/é›¢ç·šæç¤º
            enableIndexedDbPersistence(db).then(() => {
                window.__persistenceEnabled = true;
            }).catch((err) => {
                if (err?.code === 'failed-precondition') {
                    console.warn('Firestore persistence failed-precondition', err);
                    try { showToast('æç¤ºï¼šé›¢ç·šæ¨¡å¼åƒ…æ”¯æ´å–®ä¸€åˆ†é ï¼Œè«‹é—œé–‰å…¶ä»–åˆ†é ', true); } catch (_) {}
                } else if (err?.code === 'unimplemented') {
                    console.warn('Firestore persistence unimplemented', err);
                    try { showToast('æç¤ºï¼šç€è¦½å™¨ä¸æ”¯æ´é›¢ç·šå­˜å–ï¼Œéœ€é€£ç·šä½¿ç”¨', true); } catch (_) {}
                } else {
                    console.warn('å•Ÿç”¨é›¢ç·šæŒä¹…åŒ–å¤±æ•—', err);
                }
            });
            const notifyOnlineState = (online) => {
                window.__isOnline = !!online;
                try {
                    if (online) showToast('å·²æ¢å¾©é€£ç·šï¼Œæ­£åœ¨åŒæ­¥');
                    else showToast('ç›®å‰é›¢ç·šï¼Œè³‡æ–™å°‡æš«å­˜ä¸¦åœ¨é€£ç·šå¾ŒåŒæ­¥', true);
                } catch (_) {}
            };
            try { notifyOnlineState(navigator.onLine); } catch (_) {}
            try {
                window.addEventListener('online', () => notifyOnlineState(true));
                window.addEventListener('offline', () => notifyOnlineState(false));
            } catch (_) {}
            
            const storage = getStorage(app);

            // æš«æ›åˆ° window ä¾›éæ¸¡æœŸè…³æœ¬ï¼ˆå¦‚ reset-points.jsï¼‰ä½¿ç”¨
            window.__app = app;
        window.__auth = auth;
        window.__db = db;
        // é€šçŸ¥å…¶ä»–è…³æœ¬ Firebase èˆ‡å…¨åŸŸ helpers å·²å°±ç·’
        try { window.dispatchEvent(new Event('firebase-ready')); } catch (e) { /* noop */ }
            window.__storage = storage;

            const loginPage = document.getElementById('login-page');
            const appContainer = document.getElementById('app-container');
            const resetPasswordPage = document.getElementById('reset-password-page');
            const mainContent = document.getElementById('main-content');
            const mainNav = document.getElementById('main-nav');
            // ä¿å­˜å®¹å™¨é å°¾ï¼ˆå…¨åŸŸåº•éƒ¨å°è¦½ï¼‰çš„é è¨­å…§å®¹ï¼Œä¾¿æ–¼å°è¦½é åˆ‡æ›æ™‚å¾©åŸ
            state.defaultMainNavHtml = mainNav ? mainNav.innerHTML : '';
            const profileAvatarBtn = document.getElementById('profile-avatar-btn');
            const modalContainer = document.getElementById('modal-container');
            const toast = document.getElementById('toast');
            const loginForm = document.getElementById('login-form');
            const bodyEl = document.body;
            
            // Login page specific elements
            const rememberMeCheckbox = document.getElementById('remember-me');
            const emailInput = document.getElementById('email');
            const togglePasswordBtn = document.getElementById('toggle-password');
            const passwordInput = document.getElementById('password');
            const applyAccountBtn = document.getElementById('apply-account-btn');

            // è§£ææŸ¥è©¢åƒæ•¸ï¼šæ”¯æ´ç¤¾å€æ¨¡å¼èˆ‡æŒ‡å®šåˆå§‹é 
            try {
                const params = new URLSearchParams(window.location.search);
                state.appMode = params.get('mode') || 'default';
                state.communityIdFromQuery = params.get('communityId') || null;
                state.gotoPage = params.get('goto') || null; // e.g., 'navigation'
                // å¯†ç¢¼é‡è¨­ï¼ˆFirebase é€é email é€£çµå¸¶å…¥ï¼‰
                state.inPasswordResetMode = (params.get('mode') === 'resetPassword' && !!params.get('oobCode'));
                state.passwordResetOobCode = params.get('oobCode') || null;
            } catch (_) {}

            // æ¸²æŸ“ä¸­æ–‡å¯†ç¢¼é‡è¨­é é¢
            async function renderResetPasswordPage(oobCode) {
                try {
                    const email = await verifyPasswordResetCode(auth, oobCode);
                    const el = document.getElementById('reset-email');
                    if (el) el.textContent = `å¸³è™Ÿï¼š${email}`;
                } catch (e) {
                    const errEl = document.getElementById('reset-error');
                    if (errEl) errEl.textContent = 'é€£çµå·²å¤±æ•ˆæˆ–ç„¡æ•ˆï¼Œè«‹é‡æ–°å¯„é€é‡è¨­å¯†ç¢¼ä¿¡ã€‚';
                }

                // é¡¯ç¤ºæ§åˆ¶
                loginPage.classList.add('hide');
                appContainer.classList.add('hide');
                resetPasswordPage.classList.remove('hide');
                bodyEl.classList.remove('bg-gray-100');
                bodyEl.classList.add('bg-red-600');

                // äº‹ä»¶ç¶å®š
                const form = document.getElementById('reset-password-form');
                const errorEl = document.getElementById('reset-error');
                const newPwdInput = document.getElementById('reset-new-password');
                const confirmPwdInput = document.getElementById('reset-confirm-password');
                const toggleNew = document.getElementById('toggle-reset-new');
                const toggleConfirm = document.getElementById('toggle-reset-confirm');
                const backBtn = document.getElementById('reset-back-login');

                toggleNew?.addEventListener('click', () => {
                    const icon = toggleNew.querySelector('i');
                    if (newPwdInput.type === 'password') { newPwdInput.type = 'text'; icon.outerHTML = '<i data-lucide="eye" class="w-5 h-5"></i>'; }
                    else { newPwdInput.type = 'password'; icon.outerHTML = '<i data-lucide="eye-off" class="w-5 h-5"></i>'; }
                });
                toggleConfirm?.addEventListener('click', () => {
                    const icon = toggleConfirm.querySelector('i');
                    if (confirmPwdInput.type === 'password') { confirmPwdInput.type = 'text'; icon.outerHTML = '<i data-lucide="eye" class="w-5 h-5"></i>'; }
                    else { confirmPwdInput.type = 'password'; icon.outerHTML = '<i data-lucide="eye-off" class="w-5 h-5"></i>'; }
                });
                backBtn?.addEventListener('click', () => {
                    const base = window.location.origin + window.location.pathname;
                    window.location.href = base; // è¿”å›ç™»å…¥é 
                });
                form?.addEventListener('submit', async (ev) => {
                    ev.preventDefault();
                    errorEl.textContent = '';
                    const newPwd = (newPwdInput?.value || '').trim();
                    const confirmPwd = (confirmPwdInput?.value || '').trim();
                    if (!newPwd || newPwd.length < 6) { errorEl.textContent = 'æ–°å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦ 6 ä½æ•¸ã€‚'; return; }
                    if (newPwd !== confirmPwd) { errorEl.textContent = 'å…©æ¬¡è¼¸å…¥çš„æ–°å¯†ç¢¼ä¸ä¸€è‡´ã€‚'; return; }
                    showLoading(true);
                    try {
                        await confirmPasswordReset(auth, oobCode, newPwd);
                        showToast('å¯†ç¢¼å·²æ›´æ–°ï¼Œè«‹ä»¥æ–°å¯†ç¢¼ç™»å…¥');
                        const base = window.location.origin + window.location.pathname;
                        window.location.href = base;
                    } catch (err) {
                        console.error('confirmPasswordReset å¤±æ•—', err);
                        errorEl.textContent = 'é‡è¨­å¯†ç¢¼å¤±æ•—ï¼Œè«‹é‡æ–°å¯„é€é‡è¨­å¯†ç¢¼ä¿¡å¾Œå†è©¦ã€‚';
                    } finally {
                        showLoading(false);
                    }
                });
            }

            // ---- è·é›¢èˆ‡ç•°å¸¸åˆ¤å®šè¼”åŠ©ï¼ˆä¾›å¤šè™•æ¸²æŸ“å…±ç”¨ï¼‰----
            function calculateDistanceMeters(lat1, lon1, lat2, lon2) {
                const toRad = (v) => (v * Math.PI) / 180;
                const R = 6371000; // åœ°çƒåŠå¾‘ï¼ˆå…¬å°ºï¼‰
                const dLat = toRad(lat2 - lat1);
                const dLon = toRad(lon2 - lon1);
                const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            }

            function openApplyAccountModal() {
                const modalId = `apply-account-modal-${Date.now()}`;
                const defaultAvatar = 'https://placehold.co/80x80/EFEFEF/333333?text=é ­åƒ';
                const close = () => document.getElementById(modalId)?.remove();

                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[90%] max-w-md bg-white rounded-lg shadow-xl flex flex-col" style="max-height: 90vh;">
                            <div class="flex justify-between items-center p-4 border-b flex-shrink-0">
                                <h3 class="font-bold text-lg">ç”³è«‹æ–°å¸³è™Ÿ</h3>
                                <button class="close-btn text-gray-500 hover:text-gray-700"><i data-lucide="x" class="w-5 h-5"></i></button>
                            </div>
                            <form id="apply-account-form" class="p-4 space-y-4 overflow-y-auto">
                                <!-- Avatar -->
                                <div class="flex flex-col items-center space-y-2">
                                    <img id="apply-avatar-preview" src="${defaultAvatar}" class="w-20 h-20 rounded-full object-cover">
                                    <input type="file" id="apply-avatar-upload" class="hidden" accept="image/*">
                                    <button type="button" id="apply-upload-avatar-btn" class="text-sm px-3 py-1 bg-gray-200 rounded-md">ä¸Šå‚³ç…§ç‰‡</button>
                                </div>

                                <div>
                                    <label for="apply-name" class="block text-sm font-medium text-gray-700">å§“å (å¿…å¡«)</label>
                                    <input type="text" id="apply-name" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                </div>
                                <div>
                                    <label for="apply-phone" class="block text-sm font-medium text-gray-700">æ‰‹æ©Ÿè™Ÿç¢¼ï¼ˆå¿…å¡«ï¼‰</label>
                                    <input type="tel" id="apply-phone" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                </div>
                                <div>
                                    <label for="apply-title" class="block text-sm font-medium text-gray-700">ç”³è«‹è·ç¨±ï¼ˆå¿…å¡«ï¼‰</label>
                                    <select id="apply-title" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                        <option value="">æœªé¸æ“‡</option>
                                        <option value="ç¸½å¹¹äº‹">ç¸½å¹¹äº‹</option>
                                        <option value="ç§˜æ›¸">ç§˜æ›¸</option>
                                        <option value="ä¿å…¨">ä¿å…¨</option>
                                        <option value="æ¸…æ½”">æ¸…æ½”</option>
                                        <option value="æ©Ÿé›»">æ©Ÿé›»</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="apply-email" class="block text-sm font-medium text-gray-700">é›»å­éƒµä»¶ï¼ˆé¸å¡«ï¼‰</label>
                                    <input type="email" id="apply-email" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                                <div>
                                    <label for="apply-password" class="block text-sm font-medium text-gray-700">è¨­å®šå¯†ç¢¼ï¼ˆè‡³å°‘ 6 ä½ï¼Œå¿…å¡«ï¼‰</label>
                                    <input type="password" id="apply-password" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                </div>
                                <div>
                                    <label for="apply-confirm-password" class="block text-sm font-medium text-gray-700">å†æ¬¡ç¢ºèªå¯†ç¢¼ï¼ˆå¿…å¡«ï¼‰</label>
                                    <input type="password" id="apply-confirm-password" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                </div>
                                <div>
                                    <label for="apply-address" class="block text-sm font-medium text-gray-700">ä½å®¶åœ°å€ï¼ˆå¿…å¡«ï¼‰</label>
                                    <input type="text" id="apply-address" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                </div>
                                <div>
                                    <label for="apply-birthdate" class="block text-sm font-medium text-gray-700">å‡ºç”Ÿå¹´æœˆæ—¥ï¼ˆå¿…å¡«ï¼‰</label>
                                    <input type="date" id="apply-birthdate" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                </div>
                                <div>
                                    <label for="apply-idnumber" class="block text-sm font-medium text-gray-700">èº«åˆ†è­‰è™Ÿï¼ˆå¿…å¡«ï¼‰</label>
                                    <input type="text" id="apply-idnumber" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                </div>
                                <div>
                                    <label for="apply-blood-type" class="block text-sm font-medium text-gray-700">è¡€å‹ï¼ˆå¿…å¡«ï¼‰</label>
                                    <select id="apply-blood-type" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                        <option value="">æœªé¸æ“‡</option>
                                        <option value="A">A</option>
                                        <option value="B">B</option>
                                        <option value="O">O</option>
                                        <option value="AB">AB</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="apply-emergency-name" class="block text-sm font-medium text-gray-700">ç·Šæ€¥è¯çµ¡äººå§“åï¼ˆå¿…å¡«ï¼‰</label>
                                    <input type="text" id="apply-emergency-name" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                </div>
                                <div>
                                    <label for="apply-emergency-relation" class="block text-sm font-medium text-gray-700">èˆ‡è¯çµ¡äººé—œä¿‚ï¼ˆå¿…å¡«ï¼‰</label>
                                    <input type="text" id="apply-emergency-relation" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                </div>
                                <div>
                                    <label for="apply-emergency-phone" class="block text-sm font-medium text-gray-700">ç·Šæ€¥é€£çµ¡äººæ‰‹æ©Ÿè™Ÿç¢¼ï¼ˆå¿…å¡«ï¼‰</label>
                                    <input type="tel" id="apply-emergency-phone" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                </div>
                                <div>
                                    <label for="apply-license" class="block text-sm font-medium text-gray-700">å°ˆæ¥­è­‰ç…§ï¼ˆå¿…å¡«ï¼‰</label>
                                    <select id="apply-license" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                        <option value="ç„¡">ç„¡</option>
                                        <option value="è·æ¥­å®‰å…¨è¡›ç”Ÿæ¥­å‹™ä¸»ç®¡è­‰ç…§">è·æ¥­å®‰å…¨è¡›ç”Ÿæ¥­å‹™ä¸»ç®¡è­‰ç…§</option>
                                        <option value="è·æ¥­å®‰å…¨è¡›ç”Ÿç®¡ç†å“¡è­‰ç…§">è·æ¥­å®‰å…¨è¡›ç”Ÿç®¡ç†å“¡è­‰ç…§</option>
                                        <option value="é˜²ç«é¿é›£è¨­æ–½ç®¡ç†äººå“¡è­‰ç…§">é˜²ç«é¿é›£è¨­æ–½ç®¡ç†äººå“¡è­‰ç…§</option>
                                        <option value="è¨­å‚™å®‰å…¨ç®¡ç†äººå“¡è­‰ç…§">è¨­å‚™å®‰å…¨ç®¡ç†äººå“¡è­‰ç…§</option>
                                        <option value="æ•‘ç”Ÿå“¡è­‰ç…§">æ•‘ç”Ÿå“¡è­‰ç…§</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="apply-service-code" class="block text-sm font-medium text-gray-700">æœå‹™ç¤¾å€ä»£è™Ÿï¼ˆå¿…å¡«ï¼Œ4ä½è‹±æ•¸ï¼‰</label>
                                    <input type="text" id="apply-service-code" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                </div>

                                <p id="apply-form-error" class="text-red-500 text-sm text-center"></p>
                                <div class="flex justify-end space-x-2 pt-2 flex-shrink-0">
                                     <button type="button" class="cancel-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">å–æ¶ˆ</button>
                                     <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">é€å‡ºç”³è«‹</button>
                                </div>
                            </form>
                        </div>
                    </div>`;

                modalContainer.innerHTML = modalHTML;
                lucide.createIcons();

                const modal = document.getElementById(modalId);
                const form = document.getElementById('apply-account-form');
                const errorEl = document.getElementById('apply-form-error');
                const avatarPreview = document.getElementById('apply-avatar-preview');
                const avatarUploadInput = document.getElementById('apply-avatar-upload');

                // å£“ç¸®åœ–ç‰‡ç‚º Base64
                const compressToBase64 = async (file, maxW = 320, maxH = 320, quality = 0.8) => {
                    return await new Promise((resolve, reject) => {
                        const img = new Image();
                        const reader = new FileReader();
                        reader.onload = () => { img.src = reader.result; };
                        reader.onerror = () => reject(new Error('è®€å–æª”æ¡ˆå¤±æ•—'));
                        img.onload = () => {
                            let { width, height } = img;
                            const ratio = Math.min(maxW / width, maxH / height, 1);
                            width = Math.round(width * ratio); height = Math.round(height * ratio);
                            const canvas = document.createElement('canvas');
                            canvas.width = width; canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            try {
                                const dataUrl = canvas.toDataURL('image/jpeg', quality);
                                resolve(dataUrl);
                            } catch (e) { reject(e); }
                        };
                        reader.readAsDataURL(file);
                    });

                };

                document.getElementById('apply-upload-avatar-btn').addEventListener('click', () => avatarUploadInput.click());
                avatarUploadInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    try { avatarPreview.src = await compressToBase64(file); } catch (_) {}
                });

                modal.querySelector('.close-btn').addEventListener('click', close);
                modal.querySelector('.cancel-btn').addEventListener('click', close);

                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    showLoading(true);
                    errorEl.textContent = '';
                    try {
                        const name = document.getElementById('apply-name').value.trim();
                        const phone = document.getElementById('apply-phone').value.trim();
                        const email = document.getElementById('apply-email').value.trim();
                        const password = document.getElementById('apply-password').value;
                        const confirmPassword = document.getElementById('apply-confirm-password').value;
                        const homeAddress = document.getElementById('apply-address').value.trim();
                        const birthDate = document.getElementById('apply-birthdate').value.trim();
                        const idNumber = document.getElementById('apply-idnumber').value.trim();
                        const bloodType = document.getElementById('apply-blood-type').value;
                        const emergencyName = document.getElementById('apply-emergency-name').value.trim();
                        const emergencyRelation = document.getElementById('apply-emergency-relation').value.trim();
                        const emergencyPhone = document.getElementById('apply-emergency-phone').value.trim();
                        const license = document.getElementById('apply-license').value;
                        const serviceCommunityCode = document.getElementById('apply-service-code').value.trim();
                        const applicationTitle = document.getElementById('apply-title').value;

                        if (!name || !phone) throw new Error('è«‹å¡«å¯«å§“åèˆ‡æ‰‹æ©Ÿè™Ÿç¢¼');
                        if (!applicationTitle) throw new Error('è«‹é¸æ“‡ç”³è«‹è·ç¨±');
                        if (!serviceCommunityCode) throw new Error('è«‹å¡«å¯«æœå‹™ç¤¾å€ä»£è™Ÿ');
                        if (!/^[A-Za-z0-9]{4}$/.test(serviceCommunityCode)) throw new Error('æœå‹™ç¤¾å€ä»£è™Ÿéœ€ 4 ä½è‹±æ•¸');
                        if (!password || password.length < 6) throw new Error('å¯†ç¢¼è‡³å°‘ 6 ä½æ•¸');
                        if (!confirmPassword || password !== confirmPassword) throw new Error('å…©æ¬¡å¯†ç¢¼ä¸ä¸€è‡´');
                        if (!homeAddress) throw new Error('è«‹å¡«å¯«ä½å®¶åœ°å€');
                        if (!birthDate) throw new Error('è«‹å¡«å¯«å‡ºç”Ÿå¹´æœˆæ—¥');
                        if (!idNumber) throw new Error('è«‹å¡«å¯«èº«åˆ†è­‰è™Ÿ');
                        if (!bloodType) throw new Error('è«‹é¸æ“‡è¡€å‹');
                        if (!emergencyName) throw new Error('è«‹å¡«å¯«ç·Šæ€¥è¯çµ¡äººå§“å');
                        if (!emergencyRelation) throw new Error('è«‹å¡«å¯«èˆ‡è¯çµ¡äººé—œä¿‚');
                        if (!emergencyPhone) throw new Error('è«‹å¡«å¯«ç·Šæ€¥é€£çµ¡äººæ‰‹æ©Ÿè™Ÿç¢¼');
                        if (!license) throw new Error('è«‹é¸æ“‡å°ˆæ¥­è­‰ç…§');

                        // å¹´é½¡é©—è­‰ï¼šæœªæ»¿æˆ–ç­‰æ–¼ 18 æ­²ä¸å¾—ç”³è«‹
                        try {
                            const bd = new Date(birthDate.replace(/\//g, '-'));
                            if (isNaN(bd.getTime())) throw new Error('å‡ºç”Ÿå¹´æœˆæ—¥æ ¼å¼éŒ¯èª¤');
                            const today = new Date();
                            let age = today.getFullYear() - bd.getFullYear();
                            const m = today.getMonth() - bd.getMonth();
                            if (m < 0 || (m === 0 && today.getDate() < bd.getDate())) age--;
                            if (typeof age === 'number' && age <= 18) {
                                errorEl.textContent = 'æœªæ»¿æˆ–ç­‰æ–¼18æ­²ï¼Œä¸å¾—ç”³è«‹ï¼ˆè©²ç­†ç„¡æ³•ç”³è«‹ï¼‰';
                                showLoading(false);
                                return;
                            }
                        } catch (_) {
                            errorEl.textContent = 'å‡ºç”Ÿå¹´æœˆæ—¥æ ¼å¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥';
                            showLoading(false);
                            return;
                        }

                        // å¼·åŒ–æª¢æŸ¥ï¼šæ‰‹æ©Ÿï¼é›»å­éƒµä»¶ä¸å¯é‡è¤‡ï¼ˆåŒ…å«æœªæ ¸å‡†çš„ç”³è«‹ï¼‰
                        const { collection, query, where, getDocs, limit, addDoc, doc, getDoc, serverTimestamp } = window.__fs || {};
                        let hasApplied = false;
                        let dupReason = '';
                        try {
                            // æª¢æŸ¥ usersï¼šEmail å·²å­˜åœ¨
                            if (email && !hasApplied) {
                                const qsUserEmail = await getDocs(query(collection(window.__db, 'users'), where('email', '==', email), limit(1)));
                                if (!qsUserEmail.empty) { hasApplied = true; dupReason = 'é›»å­éƒµä»¶å·²å­˜åœ¨æ–¼ç³»çµ±'; }
                            }
                            // æª¢æŸ¥ users/loginIndexï¼šæ‰‹æ©Ÿå·²å­˜åœ¨ï¼ˆä½¿ç”¨æ¨™æº–åŒ– phoneKeyï¼‰
                            if (phone && !hasApplied) {
                                const phoneKey = normalizePhone(phone);
                                if (phoneKey) {
                                    const idxSnap = await getDoc(doc(window.__db, 'loginIndex', phoneKey));
                                    if (idxSnap?.exists()) { hasApplied = true; dupReason = 'æ‰‹æ©Ÿè™Ÿç¢¼å·²å­˜åœ¨æ–¼ç³»çµ±'; }
                                }
                                // é€€å›æª¢æŸ¥ï¼šè‹¥å°šæœªå»ºç«‹ loginIndexï¼Œå˜—è©¦æ¯”å° users å…§åŸå§‹ phone æ¬„ä½
                                if (!hasApplied) {
                                    const qsUserPhone = await getDocs(query(collection(window.__db, 'users'), where('phone', '==', phone), limit(1)));
                                    if (!qsUserPhone.empty) { hasApplied = true; dupReason = 'æ‰‹æ©Ÿè™Ÿç¢¼å·²å­˜åœ¨æ–¼ç³»çµ±'; }
                                }
                            }
                            // æª¢æŸ¥ accountApplicationsï¼šEmail æœ‰æœªæ ¸å‡†ç”³è«‹ï¼ˆpending/rejected ç­‰é approvedï¼‰
                            if (email && !hasApplied) {
                                const qsEmail = await getDocs(query(collection(window.__db, 'accountApplications'), where('email', '==', email), limit(5)));
                                qsEmail.forEach(d => { const st = (d.data()?.status || 'pending'); if (st !== 'approved') { hasApplied = true; dupReason = 'é›»å­éƒµä»¶å·²æœ‰æœªæ ¸å‡†ç”³è«‹'; } });
                            }
                            // æª¢æŸ¥ accountApplicationsï¼šæ‰‹æ©Ÿæœ‰æœªæ ¸å‡†ç”³è«‹
                            if (phone && !hasApplied) {
                                const qsPhone = await getDocs(query(collection(window.__db, 'accountApplications'), where('phone', '==', phone), limit(5)));
                                qsPhone.forEach(d => { const st = (d.data()?.status || 'pending'); if (st !== 'approved') { hasApplied = true; dupReason = 'æ‰‹æ©Ÿè™Ÿç¢¼å·²æœ‰æœªæ ¸å‡†ç”³è«‹'; } });
                            }
                            // ä¿ç•™èº«åˆ†è­‰é‡è¤‡æª¢æŸ¥ï¼ˆæœªæ ¸å‡†ä¹Ÿé˜»æ“‹ï¼‰
                            if (idNumber && !hasApplied) {
                                const qsId = await getDocs(query(collection(window.__db, 'accountApplications'), where('idNumber', '==', idNumber), limit(5)));
                                qsId.forEach(d => { const st = (d.data()?.status || 'pending'); if (st !== 'approved') { hasApplied = true; dupReason = 'èº«åˆ†è­‰è™Ÿå·²æœ‰æœªæ ¸å‡†ç”³è«‹'; } });
                            }
                        } catch (_) { /* å¿½ç•¥æª¢æŸ¥éŒ¯èª¤ï¼Œé¿å…é˜»æ–·é€å‡º */ }

                        if (hasApplied) {
                            errorEl.textContent = dupReason ? `${dupReason}ï¼›æ­¤ç­†ä¸æˆç«‹` : 'æ‰‹æ©Ÿæˆ–é›»å­éƒµä»¶é‡è¤‡ï¼ˆåŒ…å«æœªæ ¸å‡†ç”³è«‹ï¼‰ï¼Œæ­¤ç­†ä¸æˆç«‹';
                            try { showToast(errorEl.textContent, true); } catch (_) {}
                            showLoading(false);
                            return;
                        }

                        const data = {
                            name, phone, email: (email || null), homeAddress, birthDate, idNumber, license, serviceCommunityCode,
                            bloodType, emergencyName, emergencyRelation, emergencyPhone,
                            applicationTitle,
                            applyPassword: (password && password.length >= 6) ? password : null,
                            avatarUrl: (avatarPreview?.src && !avatarPreview.src.includes('placehold.co')) ? avatarPreview.src : null,
                            status: 'pending',
                            createdAt: serverTimestamp()
                        };
                        await addDoc(collection(window.__db, 'accountApplications'), data);
                        showToast('ç”³è«‹å·²é€å‡ºï¼Œå¾…å¾Œç«¯å¯©æ ¸');
                        close();
                    } catch (err) {
                        console.error('apply account error', err);
                        errorEl.textContent = err.message || 'é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
                    } finally {
                        showLoading(false);
                    }
                });
            }
            async function ensureAbnormalMarkingConfig() {
                if (state._markSettingLoaded) return;
                try {
                    const { doc, getDoc } = window.__fs || {};
                    const sSnap = await getDoc(doc(db, 'settings', 'location'));
                    if (sSnap.exists()) {
                        const s = sSnap.data();
                        // è‹¥æœªè¨­å®šå‰‡é è¨­ç‚º trueï¼Œä»¥ç¬¦åˆéœ€æ±‚
                        state.markAbnormalLocation = typeof s.markAbnormalLocation === 'boolean' ? s.markAbnormalLocation : true;
                    }
                } catch (e) { /* noop */ }
                state._markSettingLoaded = true;
            }

            async function ensureCommunitiesCache() {
                if (state._communitiesLoaded && state.communitiesById && Object.keys(state.communitiesById).length > 0) return;
                try {
                    const { collection, getDocs } = window.__fs || {};
                    const snap = await getDocs(collection(db, 'communities'));
                    const map = {};
                    snap.forEach(d => {
                        const data = d.data() || {};
                        const gp = data.location;
                        const lat = gp && typeof gp.latitude === 'number' ? gp.latitude : null;
                        const lng = gp && typeof gp.longitude === 'number' ? gp.longitude : null;
                        const radius = (typeof data.radius === 'number' && data.radius >= 0) ? data.radius : null;
                        const region = typeof data.region === 'string' ? data.region : '';
                        const code = typeof data.code === 'string' ? data.code : '';
                        const shortName = typeof data.shortName === 'string' ? data.shortName : '';
                        map[d.id] = {
                            id: d.id,
                            name: data.name || '',
                            region,
                            code,
                            shortName,
                            lat,
                            lng,
                            radius,
                        };
                    });
                    state.communitiesById = map;
                } catch (e) { /* noop */ }
                state._communitiesLoaded = true;
            }

            // ç”³è«‹å¸³è™ŸæŒ‰éˆ•äº‹ä»¶
            if (applyAccountBtn) {
                applyAccountBtn.addEventListener('click', () => {
                    try { openApplyAccountModal(); } catch (e) { console.error('openApplyAccountModal error', e); }
                });
            }

            // --- ç¤¾å€å°è¦½èˆ‡åˆ‡æ›è¼”åŠ© ---
            function computeAvailableCommunities() {
                const user = state.currentUserData || {};
                const role = user.role || '';
                let list = [];
                const byId = state.communitiesById || {};
                const serviceIds = Array.isArray(user.serviceCommunities) ? user.serviceCommunities.filter(Boolean) : [];
                if (serviceIds.length > 0) {
                    list = serviceIds.map(id => byId[id]).filter(Boolean);
                } else if ([ 'admin', 'manager' ].includes(role)) {
                    list = Object.values(byId);
                } else {
                    // é è¨­ä»é¡¯ç¤ºæ‰€æœ‰ç¤¾å€ä»¥é¿å… 0 å€‹çš„ç‹€æ…‹
                    list = Object.values(byId);
                }
                // è‹¥è¨ˆç®—çµæœç‚ºç©ºä¸”å·²è¼‰å…¥ç¤¾å€è³‡æ–™ï¼Œå›é€€é¡¯ç¤ºæ‰€æœ‰ç¤¾å€ï¼Œé¿å…å‡ºç¾ã€Œ0 å€‹ã€æç¤º
                if (!list || list.length === 0) {
                    list = Object.values(byId);
                }
                // é è¨­ä¾ç¤¾å€ç·¨è™Ÿæ’åºï¼ˆå¦‚ A101, A102, ... B209ï¼‰
                list.sort(compareCommunitiesByCode);
                state.availableCommunities = list;
                if (!state.currentCommunity && list.length === 1) {
                    state.currentCommunity = list[0];
                }
                updateHeaderCommunity();
                return list;
            }

            function updateHeaderCommunity() {
                const titleEl = document.getElementById('header-title');
                if (!titleEl) return;
                // è‹¥ç›®å‰åœ¨å°è¦½é ï¼Œå›ºå®šé¡¯ç¤ºç³»çµ±æ¨™é¡Œï¼Œé¿å…è¢«ä¸Šä¸€å€‹ç¤¾å€ç‹€æ…‹è¦†è“‹
                if (state.currentPage === 'navigation') {
                    titleEl.textContent = 'è¥¿åŒ—ç¤¾å€æ‰“å¡ç³»çµ±';
                    return;
                }
                const c = state.currentCommunity;
                if (c?.name) {
                    const code = c.code || '';
                    // é¡¯ç¤ºç¤¾å€åç¨±ï¼Œä¸¦åœ¨ä¸‹æ–¹ä»¥è¼ƒå°å­—é«”é¡¯ç¤ºç¤¾å€ç·¨è™Ÿï¼ˆç¸®å°é–“è·ï¼‰
                    titleEl.innerHTML = `${c.name} ç¤¾å€${code ? '<div class="text-xs text-gray-500" style="margin-top: 2px; line-height: 1;">' + code + '</div>' : ''}`;
                } else {
                    titleEl.textContent = 'è¥¿åŒ—ç¤¾å€æ‰“å¡ç³»çµ±';
                }
            }

            function isNavigationAllowed(user = null) {
                const u = user || state.currentUserData || {};
                const role = u.role || '';
                const managerial = new Set(['admin','hr','manager','junior_manager']);
                const ids = Array.isArray(u.serviceCommunities) ? u.serviceCommunities.filter(Boolean) : [];
                // ç®¡ç†è§’è‰²ä¸€å¾‹å…è¨±ï¼›å…¶é¤˜è§’è‰²åªè¦æœå‹™ç¤¾å€æ•¸ â‰¥ 2 äº¦å…è¨±
                if (managerial.has(role)) return true;
                return ids.length >= 2;
            }

            function shouldShowNavigationPage() {
                // ç¤¾å€æ¨¡å¼ä¸é¡¯ç¤ºå°è¦½é 
                if (state.appMode === 'community') return false;
                // åƒ…å…è¨±ç‰¹å®šè§’è‰²æˆ–æœå‹™ >=2 ç¤¾å€çš„æŒ‡å®šè§’è‰²é€²å…¥å°è¦½é 
                return isNavigationAllowed(state.currentUserData);
            }

            function openCommunitySwitchModal() {
                const modalContainer = document.getElementById('modal-container');
                const list = state.availableCommunities || [];
                if (!modalContainer) return;
                modalContainer.innerHTML = `
                    <div class="modal-overlay" id="community-modal-overlay"></div>
                    <div class="modal-content">
                        <div class="modal-header">é¸æ“‡ç¤¾å€</div>
                        <div class="space-y-2">
                            ${list.length === 0 ? '<div class="text-gray-500">ç›®å‰ç„¡å¯é¸æ“‡çš„ç¤¾å€</div>' : list.map(c => `
                                <button class="w-full text-left px-3 py-2 rounded border hover:bg-gray-50" data-id="${c.id}">${c.name || '(æœªå‘½åç¤¾å€)'}</button>
                            `).join('')}
                        </div>
                        <div class="modal-actions">
                            <button id="community-modal-close" class="px-3 py-1 rounded bg-gray-100">é—œé–‰</button>
                        </div>
                    </div>`;
                modalContainer.classList.add('show');
                // bind events
                const close = () => { modalContainer.classList.remove('show'); modalContainer.innerHTML = ''; };
                const overlay = document.getElementById('community-modal-overlay');
                const closeBtn = document.getElementById('community-modal-close');
                overlay && overlay.addEventListener('click', close);
                closeBtn && closeBtn.addEventListener('click', close);
                modalContainer.querySelectorAll('button[data-id]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        const c = (state.availableCommunities || []).find(x => x.id === id);
                        if (c) {
                            state.currentCommunity = c;
                            updateHeaderCommunity();
                            showToast(`å·²åˆ‡æ›è‡³ã€Œ${c.name}ã€`);
                            close();
                            try { showPage('dashboard'); } catch (_) {}
                        }
                    });
                });
            }

            function enterCommunityMainPage(commId) {
                const c = (state.availableCommunities || []).find(x => x.id === commId) || state.communitiesById?.[commId];
                if (c) {
                    state.currentCommunity = c;
                    updateHeaderCommunity();
                    showPage('dashboard');
                } else {
                    showToast('æ‰¾ä¸åˆ°ç¤¾å€è³‡æ–™', true);
                }
            }

            function computeRecordAbnormal(record, serviceCommunityIds) {
                try {
                    if (!state.markAbnormalLocation) return null;
                    const loc = record.location;
                    const lat = loc && typeof loc.latitude === 'number' ? loc.latitude : null;
                    const lng = loc && typeof loc.longitude === 'number' ? loc.longitude : null;
                    if (lat == null || lng == null) return null;
                    const ids = Array.isArray(serviceCommunityIds) ? serviceCommunityIds : [];
                    if (!ids.length) return null;
                    let considered = 0;
                    let inside = false;
                    let nearest = Infinity;
                    let nearestCommunity = null;
                    for (const id of ids) {
                        const c = state.communitiesById?.[id];
                        if (!c || c.lat == null || c.lng == null || !(typeof c.radius === 'number' && c.radius > 0)) continue;
                        considered++;
                        const dist = calculateDistanceMeters(lat, lng, c.lat, c.lng);
                        if (dist <= c.radius) {
                            inside = true; break;
                        }
                        if (dist < nearest) { nearest = dist; nearestCommunity = c; }
                    }
                    if (!considered) return null;
                    if (inside) return { isAbnormal: false };
                    const detail = nearestCommunity ? `è·é›¢${nearestCommunity.name || 'æœ€è¿‘ç¤¾å€'}ç´„${Math.round(nearest)}å…¬å°º` : '';
                    return { isAbnormal: true, detail };
                } catch (e) { return null; }
            }

            // Remember me logic
            const savedEmail = localStorage.getItem('rememberedEmail');
            if (savedEmail) {
                emailInput.value = savedEmail;
                rememberMeCheckbox.checked = true;
            }
            
            // Password visibility toggle
            togglePasswordBtn.addEventListener('click', () => {
                const passwordIcon = document.getElementById('password-icon');
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    passwordIcon.outerHTML = '<i id="password-icon" data-lucide="eye" class="w-5 h-5"></i>';
                } else {
                    passwordInput.type = 'password';
                    passwordIcon.outerHTML = '<i id="password-icon" data-lucide="eye-off" class="w-5 h-5"></i>';
                }
                lucide.createIcons();
            });


            // --- Authentication Logic ---
            const translateAuthError = (error) => {
                const code = error?.code || '';
                if (code === 'auth/invalid-email') return 'é›»å­éƒµä»¶æ ¼å¼ä¸æ­£ç¢ºã€‚';
                if (code === 'auth/user-not-found') return 'æŸ¥ç„¡æ­¤å¸³è™Ÿï¼Œè«‹å…ˆç”±ç®¡ç†ç«¯å»ºç«‹æˆ–æ ¸å‡†ã€‚';
                if (code === 'auth/wrong-password' || code === 'auth/invalid-credential' || code === 'auth/invalid-login-credentials') return 'å¯†ç¢¼éŒ¯èª¤ï¼Œå¦‚å¿˜è¨˜è«‹ä½¿ç”¨ã€Œå¿˜è¨˜å¯†ç¢¼ã€ã€‚';
                if (code === 'auth/too-many-requests') return 'å˜—è©¦æ¬¡æ•¸éå¤šï¼Œå·²æš«æ™‚å°é–ï¼Œç¨å¾Œå†è©¦ã€‚';
                if (code === 'auth/operation-not-allowed') return 'æœªå•Ÿç”¨ Email/å¯†ç¢¼ç™»å…¥ï¼Œè«‹è¯ç¹«ç³»çµ±ç®¡ç†å“¡ã€‚';
                if (code === 'auth/network-request-failed') return 'ç¶²è·¯ç•°å¸¸ï¼Œè«‹æª¢æŸ¥é€£ç·šã€‚';
                return '';
            };

            // å¯„é€é‡è¨­å¯†ç¢¼ä¿¡ï¼ˆè‡ªå‹• fallback è‡³ Firebase é è¨­é ï¼‰
            async function sendResetEmailWithFallback(email) {
                const actionCodeSettings = {
                    url: `${window.location.origin}${window.location.pathname}?mode=resetPassword`,
                    handleCodeInApp: true
                };
                try {
                    await sendPasswordResetEmail(auth, email, actionCodeSettings);
                } catch (err) {
                    if (err?.code === 'auth/unauthorized-continue-uri') {
                        // ç›®æ¨™ç¶²åŸŸæœªåŠ å…¥ Firebase Authorized domainsï¼Œæ”¹ç”¨é è¨­é 
                        await sendPasswordResetEmail(auth, email);
                        showToast('å·²å¯„å‡ºé‡è¨­å¯†ç¢¼é€šçŸ¥ä¿¡ï¼ˆä½¿ç”¨é è¨­é ï¼‰');
                        return;
                    }
                    throw err;
                }
            }

            // è¼”åŠ©ï¼šåˆ¤æ–·æ˜¯å¦ç‚ºçœ‹èµ·ä¾†åƒæ‰‹æ©Ÿçš„å­—ä¸²ï¼ˆç°¡åŒ–ç‰ˆï¼‰
            function looksLikePhone(input) {
                const s = (input || '').trim();
                // ç°¡å–®è¦å‰‡ï¼šä¸å« '@' ä¸”è‡³å°‘ 8 ä½æ•¸å­—ï¼ˆå…è¨±ç©ºæ ¼ã€ç ´æŠ˜è™Ÿã€+ï¼‰
                const digits = s.replace(/[^0-9]/g, '');
                return s && !s.includes('@') && digits.length >= 8;
            }

            // è¼”åŠ©ï¼šæ¨™æº–åŒ–æ‰‹æ©Ÿè™Ÿç¢¼ï¼ˆç§»é™¤ç©ºç™½èˆ‡ç ´æŠ˜è™Ÿï¼‰ï¼Œä¿ç•™åœ‹ç¢¼ + è™Ÿ
            function normalizePhone(input) {
                const s = (input || '').trim();
                // ä¿ç•™å‰å° +ï¼Œå…¶ä»–éæ•¸å­—å…¨éƒ¨ç§»é™¤
                if (s.startsWith('+')) {
                    return '+' + s.slice(1).replace(/[^0-9]/g, '');
                }
                return s.replace(/[^0-9]/g, '');
            }

            // è¼”åŠ©ï¼šå°‡ä½¿ç”¨è€…è¼¸å…¥çš„è­˜åˆ¥å€¼ï¼ˆEmail æˆ–æ‰‹æ©Ÿï¼‰è§£æç‚ºå¯ä¾› Firebase Auth ä½¿ç”¨çš„ Email
            async function resolveEmailFromIdentifier(identifier) {
                const raw = (identifier || '').trim();
                // åŸºæœ¬ Email æ ¼å¼åˆ¤æ–·
                const isEmail = /.+@.+\..+/.test(raw);
                if (isEmail) return raw;
                if (!looksLikePhone(raw)) {
                    throw new Error('è«‹è¼¸å…¥æ­£ç¢ºçš„é›»å­éƒµä»¶æˆ–æ‰‹æ©Ÿè™Ÿç¢¼');
                }
                // å˜—è©¦ä»¥æ‰‹æ©Ÿè™Ÿç¢¼æŸ¥è©¢å°æ‡‰çš„ Emailï¼ˆä½¿ç”¨ loginIndexï¼‰
                const phone = normalizePhone(raw);
                try {
                    const idxSnap = await getDoc(doc(db, 'loginIndex', phone));
                    if (!idxSnap || !idxSnap.exists()) {
                        throw new Error('æŸ¥ç„¡æ­¤æ‰‹æ©Ÿè™Ÿç¢¼ï¼Œè«‹æ”¹ç”¨é›»å­éƒµä»¶ç™»å…¥æˆ–è¯ç¹«ç®¡ç†å“¡');
                    }
                    const data = idxSnap.data() || {};
                    const email = (data.email || '').trim();
                    if (!email) {
                        throw new Error('æ­¤æ‰‹æ©Ÿè™Ÿç¢¼æœªç¶å®šé›»å­éƒµä»¶ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡');
                    }
                    return email;
                } catch (e) {
                    if (e && e.message) throw e;
                    throw new Error('ç™»å…¥æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                }
            }

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading(true);
                const identifier = emailInput.value.trim();
                const password = passwordInput.value;
                const loginError = document.getElementById('login-error');
                loginError.textContent = '';

                if (rememberMeCheckbox.checked) {
                    localStorage.setItem('rememberedEmail', identifier);
                } else {
                    localStorage.removeItem('rememberedEmail');
                }

                try {
                    const emailForAuth = await resolveEmailFromIdentifier(identifier);
                    await signInWithEmailAndPassword(auth, emailForAuth, password);
                } catch (error) {
                    console.error('login error', error);
                    const msg = translateAuthError(error);
                    loginError.textContent = (msg || error?.message) || 'ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥å¸³è™Ÿå¯†ç¢¼ã€‚';
                } finally {
                    showLoading(false);
                }
            });

            // Forgot password
            const forgotPasswordBtn = document.getElementById('forgot-password-btn');
            if (forgotPasswordBtn) {
                forgotPasswordBtn.addEventListener('click', async () => {
                    const identifier = emailInput.value.trim();
                    const loginError = document.getElementById('login-error');
                    loginError.textContent = '';
                    if (!identifier) {
                        loginError.textContent = 'è«‹å…ˆè¼¸å…¥æ‚¨çš„é›»å­éƒµä»¶æˆ–æ‰‹æ©Ÿè™Ÿç¢¼ï¼Œå†é»é¸å¿˜è¨˜å¯†ç¢¼ã€‚';
                        return;
                    }
                    showLoading(true);
                    try {
                        const emailForReset = await resolveEmailFromIdentifier(identifier);
                        await sendResetEmailWithFallback(emailForReset);
                        showToast('å·²å¯„å‡ºé‡è¨­å¯†ç¢¼é€šçŸ¥ä¿¡');
                    } catch (error) {
                        console.error('reset password error', error);
                        const msg = translateAuthError(error);
                        loginError.textContent = (msg || error?.message) || 'å¯„é€é‡è¨­å¯†ç¢¼å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
                    } finally {
                        showLoading(false);
                    }
                });
            }
            
            onAuthStateChanged(auth, (user) => {
                cleanupListeners();
                // è‹¥ç‚ºå¯†ç¢¼é‡è¨­æ¨¡å¼ï¼Œå¼·åˆ¶é¡¯ç¤ºä¸­æ–‡é‡è¨­é 
                if (state.inPasswordResetMode && state.passwordResetOobCode) {
                    renderResetPasswordPage(state.passwordResetOobCode);
                    return;
                }
                if (user) {
                    bodyEl.classList.remove('bg-red-600');
                    bodyEl.classList.add('bg-gray-100');
                    state.currentUser = user;
                    const userDocRef = doc(db, "users", user.uid);
                    const unsubscribe = onSnapshot(userDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const wasNotInitialized = !state.currentUserData;
                            state.currentUserData = { id: user.uid, ...docSnap.data() };
                            if (wasNotInitialized) {
                                initializeAppUI();
                            } else {
                                updateHeaderAvatar();
                            }
                        } else { 
                            showToast('æ­¤å¸³è™Ÿå°šæœªåˆå§‹åŒ–ï¼Œè«‹é€šçŸ¥ç®¡ç†å“¡å»ºç«‹äººå“¡è³‡æ–™', true);
                            signOut(auth); 
                        }
                    }, (error) => {
                        console.error("Error listening to user document:", error);
                        showToast('è®€å–ç”¨æˆ¶è³‡æ–™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', true);
                        signOut(auth);
                    });
                    state.activeListeners.push(unsubscribe);
                } else {
                    bodyEl.classList.remove('bg-gray-100');
                    bodyEl.classList.add('bg-red-600');
                    state.currentUser = null;
                    state.currentUserData = null;
                    // éç™»å…¥ç‹€æ…‹é¡¯ç¤ºæ§åˆ¶
                    if (state.inPasswordResetMode && state.passwordResetOobCode) {
                        renderResetPasswordPage(state.passwordResetOobCode);
                    } else {
                        loginPage.classList.remove('hide');
                        appContainer.classList.add('hide');
                    }
                    showLoading(false);
                }
            });

            // --- UI Initialization and Navigation ---
            function initializeAppUI() {
                loadGoogleMapsScript();
                updateHeaderAvatar();
                // æº–å‚™ç¤¾å€è³‡æ–™èˆ‡æ¨™é ­é¡¯ç¤º
                try { ensureCommunitiesCache().then(() => { computeAvailableCommunities(); updateHeaderCommunity(); }); } catch (_) {}
                // åŠ å…¥é é¦– LOGO/æ¨™é¡Œçš„é»æ“Šäº‹ä»¶ï¼Œç›´æ¥å›å°è¦½é ï¼ˆä¾ç¤¾å€ï¼‰
                try {
                    const headerLogo = document.getElementById('header-logo');
                    if (headerLogo) {
                        headerLogo.addEventListener('click', (ev) => {
                            // åƒ…æœå‹™ >=2 ç¤¾å€æˆ–ç®¡ç†è§’è‰²å¯è¿”å›å°è¦½é 
                            if (!isNavigationAllowed(state.currentUserData)) {
                                ev.preventDefault();
                                return;
                            }
                            // è‹¥å­˜åœ¨ SPA ç’°å¢ƒï¼Œé¿å…æ•´é é‡è¼‰ï¼Œç›´æ¥åˆ‡æ›åˆ°å°è¦½é 
                            ev.preventDefault();
                            try { renderFooterNavForNavigation('community'); } catch (e) { /* noop */ }
                            try { showPage('navigation', 'community'); } catch (e) { /* noop */ }
                        });
                    }
                } catch (_) {}
                // å–æ¶ˆé é¦–é€£çµèˆ‡æŒ‰éˆ•è¡Œç‚ºï¼ˆä¸å†æä¾›é»æ“Šå°è¦½æˆ–ç¤¾å€åˆ‡æ›ï¼‰
                
                // ç¤¾å€æ¨¡å¼ï¼šéš±è—å…§éƒ¨æ¨™é ­èˆ‡åº•éƒ¨å°è¦½ï¼Œä¸¦å›ºå®šç”±å¤–å±¤æ§åˆ¶
                const appHeaderEl = appContainer.querySelector('header');
                const appFooterEl = appContainer.querySelector('footer');
                if (state.appMode === 'community') {
                    appHeaderEl && appHeaderEl.classList.add('hide');
                    appFooterEl && appFooterEl.classList.add('hide');
                }
                
                const navTracking = document.getElementById('nav-tracking');
                const navSettings = document.getElementById('nav-settings');
                const navHr = document.getElementById('nav-hr');
                const navGroup = document.getElementById('nav-group');
                const navFeatures = document.getElementById('nav-features');
                const navCalendar = document.getElementById('nav-calendar');
                const navSchedule = document.getElementById('nav-schedule');
                const navDashboard = document.querySelector('.tab-btn[data-tab="dashboard"]');
                const navClockIn = document.querySelector('.tab-btn[data-tab="clock-in"]');

                // å°è¦½é¡¯ç¤ºæ¬Šé™ï¼ˆè§’è‰²ï¼šadminã€managerã€junior_managerã€ç¸½å¹¹äº‹ã€ç§˜æ›¸ã€ä¿å…¨ã€æ¸…æ½”ã€æ©Ÿé›»ï¼‰
                const role = state.currentUserData.role;
                [navTracking, navSettings, navHr, navGroup, navSchedule].forEach(el => el && el.classList.add('hide'));

                if (role === 'admin') {
                    // ç®¡ç†å“¡ï¼šé¡¯ç¤ºè¿½è¹¤èˆ‡æ’ç­ï¼›è¨­å®šå·²ç§»è‡³å°è¦½é 
                    navTracking && navTracking.classList.remove('hide');
                    navSchedule && navSchedule.classList.remove('hide');
                    navSettings && navSettings.classList.add('hide');
                    // äººäº‹åˆ†é ä¸å†é‡å°ã€Œäººäº‹ã€è§’è‰²é–‹æ”¾ï¼Œé è¨­éš±è—
                    navHr && navHr.classList.add('hide');
                } else if (role === 'manager') {
                    // é«˜éšä¸»ç®¡ï¼šé¡¯ç¤ºè¿½è¹¤èˆ‡æ’ç­
                    navTracking && navTracking.classList.remove('hide');
                    navSchedule && navSchedule.classList.remove('hide');
                    navSettings && navSettings.classList.add('hide');
                } else if (role === 'junior_manager') {
                    // åˆéšä¸»ç®¡ï¼šåƒ…é¡¯ç¤ºç¾¤çµ„
                    navGroup && navGroup.classList.remove('hide');
                    navSettings && navSettings.classList.add('hide');
                } else if (role === 'ç¸½å¹¹äº‹') {
                    // ç¸½å¹¹äº‹ï¼šå„€éŒ¶æ¿ã€æ‰“å¡ã€è¿½è¹¤ã€åŠŸèƒ½ã€è¡Œäº‹æ›†
                    navTracking && navTracking.classList.remove('hide');
                    // å…¶ä»–åˆ†é å·²ç§»é™¤ï¼›è¨­å®šã€äººäº‹ã€ç¾¤çµ„ã€æ’ç­ä¿æŒéš±è—
                    navSettings && navSettings.classList.add('hide');
                } else if (['ç§˜æ›¸','ä¿å…¨','æ¸…æ½”','æ©Ÿé›»'].includes(role)) {
                    // ä¸€èˆ¬äººå“¡ï¼ˆç§˜æ›¸ã€ä¿å…¨ã€æ¸…æ½”ã€æ©Ÿé›»ï¼‰ï¼šå„€éŒ¶æ¿ã€æ‰“å¡ã€åŠŸèƒ½ã€è¡Œäº‹æ›†
                    // è¿½è¹¤ã€è¨­å®šã€äººäº‹ã€ç¾¤çµ„ã€æ’ç­å…¨éƒ¨éš±è—
                    navSettings && navSettings.classList.add('hide');
                } else {
                    // å…¶é¤˜è§’è‰²ï¼šä¿å®ˆé è¨­ä¸é¡¯ç¤ºé€²éšåˆ†é 
                    navSettings && navSettings.classList.add('hide');
                }
                
                loginPage.classList.add('hide');
                appContainer.classList.remove('hide');

                // è‹¥ç‚ºç¤¾å€æ¨¡å¼ä¸”å¸¶å…¥ communityIdï¼Œç›´æ¥é€²å…¥å„€è¡¨æ¿ï¼Œä¸é¡¯ç¤ºå°è¦½é 
                if (state.appMode === 'community' && state.communityIdFromQuery) {
                    // è¨­å®šç•¶å‰ç¤¾å€
                    const cid = state.communityIdFromQuery;
                    state.currentCommunity = state.communitiesById?.[cid] || state.currentCommunity;
                    try {
                        const cname = state.currentCommunity?.name || '';
                        window.parent && window.parent.postMessage({ type: 'community-info', id: cid, name: cname }, '*');
                    } catch (_) {}
                    showPage('dashboard');
                    showLoading(false);
                    return;
                }

                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                let initialPage = 'dashboard';
                let initialSub = null;
                // è‹¥ URL æŒ‡å®šå°è¦½é ï¼Œå„ªå…ˆé¡¯ç¤ºå°è¦½é 
                if (state.gotoPage === 'navigation') {
                    initialPage = 'navigation';
                    initialSub = 'community';
                    renderFooterNavForNavigation(initialSub);
                } else if (shouldShowNavigationPage()) {
                    initialPage = 'navigation';
                    initialSub = 'community';
                    // é¡¯ç¤ºå®¹å™¨é å°¾ç‚ºå°è¦½å­åˆ†é 
                    renderFooterNavForNavigation(initialSub);
                } else {
                    restoreFooterMainTabs('dashboard');
                }
                showPage(initialPage, initialSub);
                showLoading(false);
            }

            function updateHeaderAvatar() {
                const headerAvatar = document.getElementById('header-avatar');
                if (state.currentUserData?.avatarUrl) {
                    headerAvatar.src = state.currentUserData.avatarUrl;
                } else {
                    headerAvatar.src = `https://placehold.co/40x40/EFEFEF/333333?text=${state.currentUserData?.name?.charAt(0) || 'U'}`;
                }
                const welcomeMessage = document.getElementById('welcome-message');
                if(welcomeMessage) {
                    welcomeMessage.textContent = `æ­¡è¿~ ${state.currentUserData.name}`;
                }
            }
            
            function renderTrackingDevices(container) {
                container.innerHTML = `
                    <div class="p-4">
                        <h2 class="text-lg font-bold mb-4">æ‰“å¡è£ç½®ç›£æ§</h2>
                        <div class="mb-4 flex items-center gap-4">
                            <div>
                                <label for="device-date-filter" class="block text-sm font-medium text-gray-700">æŸ¥è©¢æ—¥æœŸ</label>
                                <input type="date" id="device-date-filter" class="mt-1 px-3 py-2 border rounded-md">
                            </div>
                            <div class="flex items-end">
                                <button id="device-search-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">æŸ¥è©¢</button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-300">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å§“å</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç‹€æ…‹</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ‰“å¡æ—¥æœŸ</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ‰“å¡æ™‚çš„è£ç½®ID</th>
                                    </tr>
                                </thead>
                                <tbody id="device-records-list" class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="4" class="px-6 py-4 text-center text-gray-500">è«‹é¸æ“‡æ—¥æœŸä¸¦é»æ“ŠæŸ¥è©¢</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                // è¨­å®šé è¨­æ—¥æœŸç‚ºä»Šå¤©
                const dateFilter = document.getElementById('device-date-filter');
                const today = new Date();
                dateFilter.value = today.toISOString().split('T')[0];
                
                const searchBtn = document.getElementById('device-search-btn');
                searchBtn.addEventListener('click', loadDeviceRecords);
                
                // è¼‰å…¥æ‰“å¡è£ç½®è¨˜éŒ„
                async function loadDeviceRecords() {
                    const selectedDate = new Date(dateFilter.value);
                    if (isNaN(selectedDate.getTime())) {
                        showToast('è«‹é¸æ“‡æœ‰æ•ˆæ—¥æœŸ', true);
                        return;
                    }
                    
                    const deviceRecordsList = document.getElementById('device-records-list');
                    deviceRecordsList.innerHTML = `
                        <tr>
                            <td colspan="4" class="px-6 py-4 text-center">
                                <div class="flex items-center justify-center">
                                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                                    <span class="ml-2">è¼‰å…¥ä¸­...</span>
                                </div>
                            </td>
                        </tr>
                    `;
                    
                    try {
                        // å–å¾—æ—¥æœŸç¯„åœ (ç•¶æ—¥ 00:00 åˆ° 23:59)
                        const startDate = new Date(selectedDate);
                        startDate.setHours(0, 0, 0, 0);
                        const endDate = new Date(selectedDate);
                        endDate.setHours(23, 59, 59, 999);
                        
                        // æŸ¥è©¢æ‰“å¡è¨˜éŒ„ï¼ˆå‰ç«¯ä¾æ—¥æœŸéæ¿¾ï¼Œé¿å…è¤‡åˆç´¢å¼•éœ€æ±‚ï¼‰
                        const clockInRef = collection(db, 'clockInRecords');
                        const q = query(clockInRef);
                        const qs = await getDocs(q);
                        
                        const records = [];
                        qs.forEach(doc => records.push({ id: doc.id, ...doc.data() }));
                        
                        const filtered = records.filter(r => {
                            const ts = r.timestamp?.toDate?.() || (r.timestamp ? new Date(r.timestamp) : null);
                            if (!ts) return false;
                            return ts >= startDate && ts <= endDate;
                        }).sort((a, b) => {
                            const ta = a.timestamp?.toDate?.() || (a.timestamp ? new Date(a.timestamp) : new Date(0));
                            const tb = b.timestamp?.toDate?.() || (b.timestamp ? new Date(b.timestamp) : new Date(0));
                            return tb - ta;
                        });
                        
                        // å–å¾—æ‰€æœ‰ç”¨æˆ¶è³‡æ–™ä»¥é¡¯ç¤ºå§“å
                        const usersRef = collection(db, 'users');
                        const usersSnapshot = await getDocs(usersRef);
                        const usersData = {};
                        usersSnapshot.forEach(doc => { usersData[doc.id] = doc.data(); });
                        
                        // ä»¥ä½¿ç”¨è€…ç‚ºå–®ä½åˆ†çµ„
                        const grouped = {};
                        filtered.forEach(r => {
                            const uid = r.userId;
                            if (!grouped[uid]) grouped[uid] = [];
                            grouped[uid].push(r);
                        });
                        
                        let html = '';
                        Object.keys(grouped).forEach(uid => {
                            const user = usersData[uid];
                            if (!user) return;
                            const recs = grouped[uid];
                            const deviceIds = [...new Set(recs.map(r => r.deviceId).filter(Boolean))];
                            const hasAnomalies = deviceIds.length > 1;
                            
                            recs.forEach(r => {
                                const rowClass = hasAnomalies ? 'bg-red-50' : '';
                                const ts = r.timestamp?.toDate?.() || (r.timestamp ? new Date(r.timestamp) : new Date());
                                const locName = typeof r.locationName === 'string' ? r.locationName : (r.location?.address || null);
                                const statusText = getStatusDisplayText(r.type || 'æœªçŸ¥', locName, r.dutyType || null);
                                const statusColorClass = getStatusColor(statusText);
                                html += `
                                    <tr class="${rowClass}">
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <img src="${user.avatarUrl || `https://placehold.co/32x32/EFEFEF/333333?text=${(user.name||'U').charAt(0)}`}" class="w-8 h-8 rounded-full mr-3 object-cover">
                                                <div class="text-sm font-medium text-gray-900">${user.name || 'æœªçŸ¥'}</div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColorClass}">${statusText}</span>
                                            ${hasAnomalies ? '<div class="text-xs text-red-600 mt-1">ç•°å¸¸</div>' : ''}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${ts.toLocaleString('zh-TW', { hour12: false })}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${r.deviceId || 'æœªçŸ¥'}</td>
                                    </tr>
                                `;
                            });
                        });
                        
                        document.getElementById('device-records-list').innerHTML = html || `
                            <tr>
                                <td colspan="4" class="px-6 py-4 text-center text-gray-500">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ç´€éŒ„</td>
                            </tr>
                        `;
                        
                    } catch (error) {
                        console.error('è¼‰å…¥è£ç½®è¨˜éŒ„å¤±æ•—:', error);
                        document.getElementById('device-records-list').innerHTML = `
                            <tr>
                                <td colspan="4" class="px-6 py-4 text-center text-red-500">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</td>
                            </tr>
                        `;
                    }
                }
                
                function getStatusColor(status) {
                    if (typeof status !== 'string') return 'bg-gray-100 text-gray-800';
                    if (status.includes('ä¸Šç­')) return 'bg-green-100 text-green-800';
                    if (status.includes('å·²ä¸‹ç­-æœªæ‰“å¡')) return 'bg-yellow-100 text-yellow-800';
                    if (status.includes('ä¸‹ç­') || status.includes('å·²ä¸‹ç­')) return 'bg-red-100 text-red-800';
                    if (status.includes('å¤–å‡º') || status.includes('æŠµé”') || status.includes('é›¢é–‹')) return 'bg-blue-100 text-blue-800';
                    if (status.includes('è¿”å›')) return 'bg-green-100 text-green-800';
                    if (status.includes('è«‹å‡') || status.includes('è‡¨æ™‚è«‹å‡')) return 'bg-orange-100 text-orange-800';
                    if (status.includes('ç‰¹æ®Šå‹¤å‹™') || status.includes('å‡ºå‹¤')) return 'bg-indigo-100 text-indigo-800';
                    return 'bg-gray-100 text-gray-800';
                }
            }

            mainNav.addEventListener('click', (e) => {
                const tabButton = e.target.closest('.tab-btn');
                if (!tabButton) return;
                const tab = tabButton.dataset.tab;
                if (!tab || state.currentPage === tab) return;
                // äº¤ç”± showPage é‡å»ºé å°¾ä¸¦è¨­å®šæ­£ç¢ºçš„ active æ¨£å¼
                showPage(tab);
            });

            // å°è¦½é ä½¿ç”¨å®¹å™¨é å°¾ï¼ˆFooterï¼‰ä½œç‚ºå­åˆ†é åˆ‡æ›ï¼Œéå…§åµŒæ–¼é é¢å…§å®¹
            function renderFooterNavForNavigation(activeSubTab) {
                if (!mainNav) return;
                const role = state.currentUserData?.role || '';
                const showSettings = role === 'admin';
                const managerial = new Set(['admin','hr','manager','junior_manager']);
                const showNameTab = managerial.has(role);
                const showHRTab = managerial.has(role);
                let html = `
                    <button data-subtab="community" class="nav-sub-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2 ${!activeSubTab || activeSubTab==='community' ? 'active' : ''}">
                        <i data-lucide="building-2"></i><span class="text-xs mt-1">ä¾ç¤¾å€</span>
                    </button>`;
                if (showNameTab) {
                    html += `
                    <button data-subtab="name" class="nav-sub-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2 ${activeSubTab==='name' ? 'active' : ''}">
                        <i data-lucide="user"></i><span class="text-xs mt-1">ä¾å§“å</span>
                    </button>`;
                }
                if (showHRTab) {
                    html += `
                    <button data-subtab="hr" class="nav-sub-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2 ${activeSubTab==='hr' ? 'active' : ''}">
                        <i data-lucide="users"></i><span class="text-xs mt-1">äººäº‹</span>
                    </button>`;
                }
                if (showSettings) {
                    html += `
                    <button data-subtab="settings" class="nav-sub-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2 ${activeSubTab==='settings' ? 'active' : ''}">
                        <i data-lucide="settings"></i><span class="text-xs mt-1">è¨­å®š</span>
                    </button>`;
                }
                mainNav.innerHTML = html;
                // ç¶å®šå®¹å™¨é å°¾å­åˆ†é åˆ‡æ›
                mainNav.querySelectorAll('.nav-sub-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        // åˆ‡æ› active æ¨£å¼ä»¥ç¬¦åˆä¸»é  footer é¢¨æ ¼
                        mainNav.querySelectorAll('.nav-sub-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        showPage('navigation', btn.dataset.subtab);
                    });
                });
                try { lucide.createIcons(); } catch (_) {}
            }

            function applyRoleNavVisibility() {
                const role = state.currentUserData?.role || '';
                const navTracking = document.getElementById('nav-tracking');
                const navSchedule = document.getElementById('nav-schedule');
                const navSettings = document.getElementById('nav-settings');
                const navHr = document.getElementById('nav-hr');
                const navGroup = document.getElementById('nav-group');

                // é è¨­éš±è—é€²éšåˆ†é 
                navTracking && navTracking.classList.add('hide');
                navSchedule && navSchedule.classList.add('hide');
                navSettings && navSettings.classList.add('hide');
                navHr && navHr.classList.add('hide');
                navGroup && navGroup.classList.add('hide');

                if (role === 'admin') {
                    navTracking && navTracking.classList.remove('hide');
                    navSchedule && navSchedule.classList.remove('hide');
                    // å…¨åŸŸè¨­å®šå·²ç§»è‡³å°è¦½é è¨­å®šï¼Œä¿æŒéš±è—
                    navSettings && navSettings.classList.add('hide');
                    // äººäº‹ä¿æŒéš±è—
                    navHr && navHr.classList.add('hide');
                } else if (role === 'manager') {
                    navTracking && navTracking.classList.remove('hide');
                    navSchedule && navSchedule.classList.remove('hide');
                    navSettings && navSettings.classList.add('hide');
                } else if (role === 'junior_manager') {
                    navGroup && navGroup.classList.remove('hide');
                    navSettings && navSettings.classList.add('hide');
                } else if (role === 'ç¸½å¹¹äº‹') {
                    navTracking && navTracking.classList.remove('hide');
                    navSettings && navSettings.classList.add('hide');
                } else if (['ç§˜æ›¸','ä¿å…¨','æ¸…æ½”','æ©Ÿé›»'].includes(role)) {
                    navSettings && navSettings.classList.add('hide');
                } else {
                    navSettings && navSettings.classList.add('hide');
                }
            }

            function restoreFooterMainTabs(activeTab) {
                if (!mainNav) return;
                const role = state.currentUserData?.role || '';

                // æ ¹æ“šè§’è‰²ç¾¤çµ„å‹•æ…‹é‡å»ºä¸»é é å°¾å°è¦½æŒ‰éˆ•
                const isManagement = new Set(['admin','hr','manager','junior_manager']).has(role);
                const isStaff = new Set(['ç¸½å¹¹äº‹','ç§˜æ›¸','ä¿å…¨','æ¸…æ½”','æ©Ÿé›»']).has(role);

                const items = [];
                const pushItem = (tab, icon, label) => items.push({ tab, icon, label });
                const idForTab = (tab) => {
                    switch (tab) {
                        case 'tracking': return 'nav-tracking';
                        case 'hr': return 'nav-hr';
                        case 'features': return 'nav-features';
                        case 'calendar': return 'nav-calendar';
                        case 'schedule': return 'nav-schedule';
                        case 'settings': return 'nav-settings';
                        case 'group': return 'nav-group';
                        default: return '';
                    }
                };

                if (isManagement) {
                    // ç®¡ç†å“¡ã€äººäº‹ã€é«˜éšä¸»ç®¡ã€åˆéšä¸»ç®¡ï¼šä¾æ¬Šé™é¡¯ç¤ºä¸¦ä¾æŒ‡å®šé †åºæ’åˆ—
                    pushItem('dashboard', 'layout-dashboard', 'å„€è¡¨æ¿');
                    if (['admin','hr','manager','junior_manager'].includes(role)) {
                        pushItem('tracking', 'map-pin', 'è¿½è¹¤');
                    }
                    if (['admin','hr','manager','junior_manager'].includes(role)) {
                        pushItem('schedule', 'calendar-days', 'æ’ç­');
                    }
                    pushItem('features', 'layers', 'åŠŸèƒ½');
                    if (['admin','hr','manager','junior_manager'].includes(role)) {
                        pushItem('hr', 'users', 'äººå“¡');
                    }
                } else if (isStaff) {
                    // ç¸½å¹¹äº‹ã€ç§˜æ›¸ã€ä¿å…¨ã€æ¸…æ½”ã€æ©Ÿé›»
                    pushItem('dashboard', 'layout-dashboard', 'å„€è¡¨æ¿');
                    pushItem('clock-in', 'fingerprint', 'æ‰“å¡');
                    pushItem('features', 'layers', 'åŠŸèƒ½');
                } else {
                    // å…¶ä»–æœªå®šç¾©è§’è‰²ï¼šä¿å®ˆå‘ˆç¾åŸºæœ¬åŠŸèƒ½
                    pushItem('dashboard', 'layout-dashboard', 'å„€è¡¨æ¿');
                    pushItem('clock-in', 'fingerprint', 'æ‰“å¡');
                    pushItem('features', 'layers', 'åŠŸèƒ½');
                }

                const html = items.map(({ tab, icon, label }) => {
                    const idAttr = idForTab(tab);
                    const activeClass = (activeTab || 'dashboard') === tab ? 'active' : '';
                    return `
                        <button ${idAttr ? `id="${idAttr}"` : ''} data-tab="${tab}" class="tab-btn flex flex-col items-center text-gray-500 border-t-2 border-transparent pt-2 ${activeClass}">
                            <i data-lucide="${icon}"></i><span class="text-xs mt-1">${label}</span>
                        </button>`;
                }).join('\n');

                mainNav.innerHTML = html;
                try { lucide.createIcons(); } catch (_) {}
            }

            // ç¢ºä¿åœ¨ä»»ä½•æ™‚å€™é»æ“Šé ­åƒæŒ‰éˆ•éƒ½èƒ½æ‰“é–‹å€‹äººè³‡æ–™
            document.getElementById('profile-avatar-btn').addEventListener('click', renderProfileModal);

            function showPage(pageName, subPage = null, params = {}) {
                cleanupListeners();
                // è¨˜éŒ„ç›®å‰é é¢ï¼Œä¾›å…¶ä»–äº’å‹•åˆ¤æ–·
                state.currentPage = pageName;
                state.currentLocation = null;
                state.trackingMap = null;
                state.trackingMarkers = [];
                // å°è¦½é æ”¹ç”¨å®¹å™¨é å°¾ä½œç‚ºå­åˆ†é åˆ‡æ›ï¼›éå°è¦½é å¾©åŸå®¹å™¨é å°¾
                if (mainNav) {
                    if (pageName === 'navigation') {
                        renderFooterNavForNavigation(subPage || 'community');
                    } else {
                        restoreFooterMainTabs(pageName);
                    }
                }
                // ä¾é é¢èª¿æ•´é é¦–æ¨™é¡Œèˆ‡è¿”å›å°è¦½çš„é€£çµè¡Œç‚º
                try {
                    const headerLogo = document.getElementById('header-logo');
                    const headerTitle = document.getElementById('header-title');
                    if (headerLogo && headerTitle) {
                        if (pageName === 'navigation') {
                            // å°è¦½é ï¼šé¡¯ç¤ºç³»çµ±æ¨™é¡Œï¼Œé—œé–‰è¿”å›å°è¦½çš„é»æ“Šè¡Œç‚º
                            headerTitle.textContent = 'è¥¿åŒ—ç¤¾å€æ‰“å¡ç³»çµ±';
                            headerLogo.classList.add('pointer-events-none', 'cursor-default');
                            headerLogo.removeAttribute('href');
                        } else {
                            // å…¶ä»–é ï¼šé¡¯ç¤ºç¤¾å€åç¨±ï¼ˆè‹¥æœ‰ï¼‰ï¼›åƒ…å…è¨±å¯è¿”å›å°è¦½çš„å¸³è™Ÿå•Ÿç”¨é»æ“Š
                            try { updateHeaderCommunity(); } catch (e) { /* noop */ }
                            if (isNavigationAllowed(state.currentUserData)) {
                                headerLogo.classList.remove('pointer-events-none', 'cursor-default');
                                headerLogo.setAttribute('href', 'index.html?goto=navigation&sub=community');
                            } else {
                                headerLogo.classList.add('pointer-events-none', 'cursor-default');
                                headerLogo.removeAttribute('href');
                            }
                        }
                    }
                    window.openLeaveModalWithDefaults = openLeaveModalWithDefaults;
                } catch (_) {}
                mainContent.innerHTML = `<div class="flex justify-center items-center h-full"><div class="loader"></div></div>`;
                const role = state.currentUserData?.role || '';
                const router = {
                    'dashboard': renderDashboard,
                    'clock-in': () => renderClockIn(subPage || 'workdays'),
                    'tracking': () => ['admin','hr','manager','junior_manager'].includes(role) ? renderTracking(subPage || 'map', params) : renderAccessDenied(),
                    'features': () => renderFeatures(subPage || 'training'),
                    'calendar': () => renderCalendar(subPage || 'overview'),
                    'schedule': () => ['admin','hr','manager','junior_manager'].includes(role) ? renderShifts(subPage || null) : renderAccessDenied(),
                    'settings': () => role === 'admin' ? renderSettings(subPage || 'applications') : renderAccessDenied(),
                    'hr': () => (['admin','hr','manager','junior_manager'].includes(role)) ? renderHR(subPage || 'applications') : renderAccessDenied(),
                    'navigation': () => isNavigationAllowed(state.currentUserData) ? renderNavigation(subPage || 'community') : renderAccessDenied(),
                    // å·²ç§»é™¤å·¡é‚åˆ†é èˆ‡åŠŸèƒ½
                };
                const renderFunction = router[pageName] || renderAccessDenied;
                try {
                    renderFunction(params);
                } catch(e) {
                    console.error("Failed to render page:", e);
                    mainContent.innerHTML = `<div class="p-4 text-red-500">é é¢è¼‰å…¥å¤±æ•—ã€‚</div>`;
                }
                lucide.createIcons();
            }

            function renderAccessDenied() {
                mainContent.innerHTML = `
                    <div class="p-8 text-center text-gray-500 flex flex-col items-center justify-center h-full">
                        <i data-lucide="ban" class="w-16 h-16 mx-auto mb-4"></i>
                        <h2 class="text-xl font-bold">æ¬Šé™ä¸è¶³</h2>
                        <p>æ‚¨æ²’æœ‰æ¬Šé™è¨ªå•æ­¤é é¢ã€‚</p>
                    </div>
                `;
            }

            // å°è¦½é ï¼ˆç®¡ç†éšå±¤ä½¿ç”¨ï¼‰
            function renderNavigation(subPage) {
                const role = state.currentUserData?.role || '';
                const showSettings = role === 'admin';
                // å°è¦½é ï¼šå­åˆ†é åˆ‡æ›ç§»è‡³å®¹å™¨é å°¾ï¼ˆFooterï¼‰ï¼Œå…§å®¹å€å…¨é«˜é¡¯ç¤º
                mainContent.innerHTML = `
                    <div id="sub-page-content" class="overflow-y-auto h-full"></div>`;

                const subPageContent = document.getElementById('sub-page-content');
                if (subPage === 'name') {
                    renderNavByName(subPageContent);
                } else if (subPage === 'hr' && ['admin','hr','manager','junior_manager'].includes(role)) {
                    renderNavHR(subPageContent);
                } else if (subPage === 'settings' && showSettings) {
                    renderNavSettings(subPageContent);
                } else {
                    renderNavByCommunity(subPageContent);
                }
                try { lucide.createIcons(); } catch (_) {}
            }

            function renderNavByCommunity(container) {
                const byId = state.communitiesById || {};
                const isReady = byId && Object.keys(byId).length > 0;
                // è‹¥ç¤¾å€è³‡æ–™å°šæœªè¼‰å…¥ï¼Œé¡¯ç¤ºè¼‰å…¥ä¸­ä¸¦åœ¨è¼‰å…¥å®Œæˆå¾Œé‡ç¹ª
                if (!isReady) {
                    container.innerHTML = `
                        <div class="p-8 flex items-center justify-center h-full">
                            <div class="text-center text-gray-500">
                                <i data-lucide="loader" class="w-6 h-6 mx-auto mb-2 animate-spin"></i>
                                <div>è¼‰å…¥ç¤¾å€è³‡æ–™ä¸­...</div>
                            </div>
                        </div>`;
                    try {
                        ensureCommunitiesCache().then(() => {
                            try { computeAvailableCommunities(); } catch (_) {}
                            renderNavByCommunity(container);
                            try { lucide.createIcons(); } catch (_) {}
                    // ç¶å®šè§’è‰²éæ¿¾æŒ‰éˆ•
                    const summaryEl = document.getElementById('shift-summary');
                    const updateRoleButtonsActive = () => {
                        if (!summaryEl) return;
                        summaryEl.querySelectorAll('button[data-role]').forEach(b => {
                            const r = b.getAttribute('data-role');
                            const active = (pageState.roleFilter === r);
                            b.classList.toggle('ring-2', active);
                            b.classList.toggle('ring-offset-1', active);
                            b.classList.toggle('opacity-80', !active && pageState.roleFilter !== null);
                        });
                    };
                    if (summaryEl) {
                        summaryEl.querySelectorAll('button[data-role]').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const role = btn.getAttribute('data-role');
                                pageState.roleFilter = (pageState.roleFilter === role) ? null : role;
                                updateRoleButtonsActive();
                                renderCalendar();
                                renderMonthlyList();
                            });
                        });
                        updateRoleButtonsActive();
                    }
                        });
                    } catch (_) {}
                    try { lucide.createIcons(); } catch (_) {}
                    return;
                }

                // ç¢ºä¿å¯é¡¯ç¤ºæ¸…å–®å·²è¨ˆç®—
                try { computeAvailableCommunities(); } catch (_) {}
                const list = state.availableCommunities || [];
                if (!list.length) {
                    container.innerHTML = `
                        <div class="p-8 flex items-center justify-center h-full">
                            <div class="text-center text-gray-500">
                                <i data-lucide="home" class="w-8 h-8 mx-auto mb-3"></i>
                                <div>ç›®å‰æ²’æœ‰å¯é¡¯ç¤ºçš„ç¤¾å€</div>
                            </div>
                        </div>`;
                    try { lucide.createIcons(); } catch (_) {}
                    return;
                }

                let selectedRegion = null; // 'å°åŒ—' | 'æ–°åŒ—' | 'æ¡ƒåœ’' | null
                const renderList = () => {
                    const sorted = [...list].sort(compareCommunitiesByCode);
                    const filtered = selectedRegion ? sorted.filter(c => (c?.region || '') === selectedRegion) : sorted;
                    // ä¾ç¤¾å€ç°¡ç¨±å…§å®¹é¡¯ç¤ºï¼Œæ”¯æ´å¤šè¡Œï¼ˆé¡¯ç¤ºè‡³å¤šå…©è¡Œï¼‰ï¼Œç½®ä¸­é¡¯ç¤º
                    const toTwoLines = (text) => {
                        const raw = (text || '').toString();
                        const lines = raw.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
                        if (lines.length === 0) return ['æœªå‘½å', ''];
                        if (lines.length === 1) return [lines[0], ''];
                        return [lines[0], lines[1]];
                    };
                    container.innerHTML = `
                        <div class="p-4 space-y-3">
                            <div class="flex items-center mb-2">
                                <div class="flex items-center gap-2 flex-nowrap overflow-x-auto">
                                    <button class="region-btn px-3 py-1 rounded border ${selectedRegion==='å°åŒ—'?'bg-red-600 text-white border-red-600':'bg-white'}" data-region="å°åŒ—">å°åŒ—</button>
                                    <button class="region-btn px-3 py-1 rounded border ${selectedRegion==='æ–°åŒ—'?'bg-red-600 text-white border-red-600':'bg-white'}" data-region="æ–°åŒ—">æ–°åŒ—</button>
                                    <button class="region-btn px-3 py-1 rounded border ${selectedRegion==='æ¡ƒåœ’'?'bg-red-600 text-white border-red-600':'bg-white'}" data-region="æ¡ƒåœ’">æ¡ƒåœ’</button>
                                </div>
                                
                            </div>
                            <hr class="border-t border-gray-200 my-2" />
                            <div class="text-sm text-gray-500">ç¸½ç¤¾å€æ•¸ï¼š${filtered.length}</div>
                            <div class="grid grid-cols-5 gap-2">
                                ${filtered.map(c => {
                                    const [line1, line2] = toTwoLines(c.shortName || c.name || c.code || '');
                                    const title = (c.name || '').replace(/"/g,'&quot;');
                                    return `
                                    <button class="enter-community w-full px-3 py-2 rounded-md border bg-white hover:bg-red-50 text-gray-800 font-medium text-sm flex flex-col items-center justify-center text-center" style="aspect-ratio: 1 / 1;" data-id="${c.id}" title="${title}">
                                        <span class="block leading-tight text-center" style="font-size:13px;">${line1 || '&nbsp;'}</span>
                                        <span class="block leading-tight text-center" style="font-size:13px;">${line2 || '&nbsp;'}</span>
                                    </button>`;
                                }).join('')}
                            </div>
                        </div>`;
                    container.querySelectorAll('.enter-community').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const id = e.currentTarget.getAttribute('data-id');
                            enterCommunityMainPage(id);
                        });
                    });
                    container.querySelectorAll('.region-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const r = e.currentTarget.getAttribute('data-region');
                            selectedRegion = (selectedRegion === r) ? null : r;
                            renderList();
                        });
                    });
                    try { lucide.createIcons(); } catch (_) {}

                    // è¼‰å…¥ä¸¦å¥—ç”¨ç¤¾å€å±¤ç´šç•°å¸¸æ¨™è‰²ï¼ˆç´…>æ©™>é»ƒï¼‰
                    (async () => {
                        try {
                            const fs = window.__fs || {}; const db = window.__db;
                            const { doc, getDoc, collection, getDocs, query, where, orderBy, Timestamp } = fs;
                            const start = new Date(); start.setHours(0,0,0,0);
                            const end = new Date(); end.setHours(23,59,59,999);
                            const tsStart = Timestamp?.fromDate ? Timestamp.fromDate(start) : start;
                            const tsEnd = Timestamp?.fromDate ? Timestamp.fromDate(end) : end;
                            const ymdToday = `${start.getFullYear()}-${String(start.getMonth()+1).padStart(2,'0')}-${String(start.getDate()).padStart(2,'0')}`;

                            // è¼‰å…¥ç•°å¸¸æ¨™è‰²é…ç½®
                            let markLocation = true, markShiftOverdue = true, markNoScheduleCommunity = true;
                            try {
                                const locSnap = await getDoc(doc(db, 'settings', 'location'));
                                if (locSnap?.exists()) {
                                    const locCfg = locSnap.data() || {};
                                    if (typeof locCfg.markAbnormalLocation === 'boolean') markLocation = locCfg.markAbnormalLocation;
                                }
                                const genSnap = await getDoc(doc(db, 'settings', 'general'));
                                if (genSnap?.exists()) {
                                    const gen = genSnap.data() || {};
                                    if (typeof gen.markShiftOverdueNotStarted === 'boolean') markShiftOverdue = gen.markShiftOverdueNotStarted;
                                    if (typeof gen.markNoScheduleCommunity === 'boolean') markNoScheduleCommunity = gen.markNoScheduleCommunity;
                                }
                            } catch (_) {}

                            // å–ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼ˆä¾ä½¿ç”¨è€…åˆ†çµ„ï¼‰
                            const recordsByUser = {};
                            try {
                                const recSnap = await getDocs(query(collection(db, 'clockInRecords'), where('timestamp','>=', tsStart), where('timestamp','<=', tsEnd)));
                                recSnap.forEach(d => {
                                    const r = { id: d.id, ...d.data() };
                                    (recordsByUser[r.userId] ||= []).push(r);
                                });
                            } catch (_) {}

                            // å–ä½¿ç”¨è€…è³‡æ–™ï¼ˆç”¨æ–¼ç¯©é¸ç¤¾å€æˆå“¡ï¼‰
                            const users = [];
                            try {
                                const usnap = await getDocs(collection(db, 'users'));
                                usnap.forEach(d => users.push({ id: d.id, ...d.data() }));
                            } catch (_) {}

                            const parseHM = (iso, hm) => {
                                if (!iso || !hm) return null;
                                const dt = new Date(`${iso}T00:00:00`);
                                const [hh, mm] = (hm||'').split(':');
                                dt.setHours(parseInt(hh,10)||0, parseInt(mm,10)||0, 0, 0);
                                return isNaN(dt.getTime()) ? null : dt;
                            };

                            const currentList = selectedRegion ? [...list].sort(compareCommunitiesByCode).filter(c => (c?.region || '') === selectedRegion) : [...list].sort(compareCommunitiesByCode);

                            // ä¸€æ¬¡æ€§æŠ“å–ä»Šæ—¥ç­è¡¨ï¼ˆæ‰€æœ‰ç¤¾å€ï¼‰ï¼Œä¸¦è¡ŒæŠ“å–å·¡é‚ä»»å‹™ï¼Œè¨ˆç®—å®Œå†å¥—è‰²
                            const communityIds = currentList.map(c => c.id);
                            const communitiesByCode = Object.fromEntries(currentList.map(c => [ (c.code||'').trim(), c.id ]));
                            const usersByCommunityId = {};
                            for (const c of currentList) {
                                usersByCommunityId[c.id] = users.filter(u => {
                                    const ids = Array.isArray(u.serviceCommunities) ? u.serviceCommunities : [];
                                    if (ids.includes(c.id)) return true;
                                    const code = (u.serviceCommunityCode || '').trim();
                                    return code && communitiesByCode[code] === c.id;
                                });
                            }

                            // ä»Šæ—¥ç­è¡¨ä¸€æ¬¡æŠ“å–ï¼ˆpostSchedulesï¼ŒdateIso=ä»Šæ—¥ï¼‰
                            const schedulesByCommunityId = {};
                            try {
                                const ssnapAll = await getDocs(query(collection(db, 'postSchedules'), where('dateIso','==', ymdToday)));
                                ssnapAll.forEach(d => {
                                    const data = d.data() || {}; const cid = data.communityId;
                                    if (!cid) return;
                                    const bucket = (schedulesByCommunityId[cid] ||= { anyScheduled: false, shifts: [] });
                                    if (data.isScheduledDay === true) bucket.anyScheduled = true;
                                    if (Array.isArray(data.shifts) && data.shifts.length > 0) { bucket.anyScheduled = true; bucket.shifts.push(...data.shifts); }
                                });
                            } catch (_) {}

                            // å·¡é‚ä»»å‹™ç›¸é—œé‚è¼¯å·²ç§»é™¤

                            // ä»Šæ—¥å¾…å¯©å‡å–®ï¼ˆä¾ä½¿ç”¨è€…åˆ†çµ„ï¼‰
                            const pendingLeavesByUserId = {};
                            try {
                                const tsStart2 = Timestamp?.fromDate ? Timestamp.fromDate(new Date(`${ymdToday}T00:00:00`)) : new Date(`${ymdToday}T00:00:00`);
                                const tsEnd2 = Timestamp?.fromDate ? Timestamp.fromDate(new Date(`${ymdToday}T23:59:59`)) : new Date(`${ymdToday}T23:59:59`);
                                const lSnap = await getDocs(query(collection(db, 'leaves'), where('status','==','pending'), where('targetTime','>=', tsStart2), where('targetTime','<=', tsEnd2)));
                                lSnap.forEach(d => {
                                    const data = d.data() || {};
                                    const uid = data.userId;
                                    if (uid) (pendingLeavesByUserId[uid] ||= []).push({ id: d.id, ...data });
                                });
                            } catch (_) {}

                            // è¨ˆç®—æ‰€æœ‰ç¤¾å€ç•°å¸¸çµæœ
                            const results = {};
                            const now = new Date();

                            for (const c of currentList) {
                                let hasAbnormalLocation = false;
                                let hasPendingLeave = false;
                                let hasDoublePunch = false;

                                const communityUsers = usersByCommunityId[c.id] || [];
                                // ä½ç½®ç•°å¸¸ï¼šä»»ä¸€æˆå“¡çš„ä»»ä¸€æ‰“å¡åœ¨ç¤¾å€åŠå¾‘å¤–ï¼ˆå—è¨­å®šæ§åˆ¶ï¼‰
                                if (markLocation) {
                                    outerLoc: for (const u of communityUsers) {
                                        const recs = recordsByUser[u.id] || [];
                                        for (const r of recs) {
                                            const abnormal = computeRecordAbnormal(r, [c.id]);
                                            if (abnormal && abnormal.isAbnormal) { hasAbnormalLocation = true; break outerLoc; }
                                        }
                                    }
                                }

                                // å¾…å¯©å‡å–®
                                for (const u of communityUsers) {
                                    if ((pendingLeavesByUserId[u.id] || []).length > 0) { hasPendingLeave = true; break; }
                                }

                                // å·¡é‚é€¾æ™‚æœªé–‹å§‹é‚è¼¯å·²ç§»é™¤

                                // ç•°å¸¸ï¼šä»Šæ—¥å­˜åœ¨é‡è¤‡ä¸Šç­æˆ–é‡è¤‡ä¸‹ç­æ‰“å¡
                                outerDouble: for (const u of communityUsers) {
                                    const recs = recordsByUser[u.id] || [];
                                    let startCount = 0, endCount = 0;
                                    for (const r of recs) {
                                        const dt = r.timestamp?.toDate?.() ? r.timestamp.toDate() : (r.timestamp ? new Date(r.timestamp) : null);
                                        if (!dt) continue;
                                        const y = dt.getFullYear(), m = dt.getMonth()+1, d = dt.getDate();
                                        const ymd = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                                        if (ymd !== ymdToday) continue;
                                        if (r.type === 'ä¸Šç­') startCount++;
                                        if (r.type === 'ä¸‹ç­') endCount++;
                                        if (startCount >= 2 || endCount >= 2) { hasDoublePunch = true; break outerDouble; }
                                    }
                                }

                                results[c.id] = { hasAbnormalLocation, hasPendingLeave, hasDoublePunch };
                            }

                            // å–è¿‘ä¸‰æ—¥æŒä¹…åŒ–ç•°å¸¸ï¼ˆæœªæŠ‘åˆ¶ä¸”æœªéæœŸï¼‰ï¼ŒæŒ‰ç¤¾å€èšåˆ
                            const hasActiveAnomaliesByCommunity = {};
                            try {
                                const nowZ = new Date();
                                const tsNowZ = Timestamp?.fromDate ? Timestamp.fromDate(nowZ) : nowZ;
                                const aSnap = await getDocs(query(collection(db, 'anomalies'), where('expiresAt','>=', tsNowZ)));
                                aSnap.forEach(d => {
                                    const data = d.data() || {};
                                    const cid = data.communityId;
                                    if (data.suppressed === true) return;
                                    if (cid) hasActiveAnomaliesByCommunity[cid] = true;
                                });
                            } catch (_) {}

                            // ä¸€æ¬¡æ€§å¥—ç”¨æ¨£å¼ï¼ˆç´…>æ©™>é»ƒï¼‰
                            for (const c of currentList) {
                                const btn = container.querySelector(`.enter-community[data-id="${c.id}"]`);
                                if (!btn) continue;
                                const r = results[c.id] || {};
                                const add = (cls) => cls.forEach(cn => btn.classList.add(cn));
                                const remove = (cls) => cls.forEach(cn => btn.classList.remove(cn));
                                if (hasActiveAnomaliesByCommunity[c.id] || r.hasPendingLeave || r.hasDoublePunch || r.hasAbnormalLocation) {
                                    remove(['bg-white','hover:bg-red-50']); add(['bg-red-50','border-red-300','text-red-800']);
                                }
                            }
                        } catch (e) {
                            console.warn('å¥—ç”¨ç¤¾å€ç•°å¸¸æ¨™è‰²å¤±æ•—', e);
                        }
                    })();

                    // ä¾ç¤¾å€é¡¯ç¤ºå¸³è™Ÿç”³è«‹å¾…æ ¸å‡†æç¤ºï¼ˆæ·ºç´«è‰²åº•ï¼Œåƒ…ç®¡ç†è§’è‰²å¯è¦‹ï¼‰ï¼Œä¸¦åœ¨ç„¡å¾…æ ¸å‡†æ™‚ç§»é™¤æ—¢æœ‰ç´«è‰²æ¨™ç¤ºï¼›
                    // è‹¥åŒåå·²æœ‰ã€Œå·²æ ¸å‡†ã€å‰‡å¿½ç•¥å…¶ pendingï¼ˆé¿å…é€ æˆæ®˜ç•™ç´«è‰²ï¼‰
                    (async () => {
                        try {
                            const role = state.currentUserData?.role || '';
                            const canSeePending = ['admin','hr','manager','junior_manager'].includes(role);
                            if (!canSeePending) return;
                            const fs = window.__fs || {}; const db = window.__db;
                            const { collection, getDocs, query, where } = fs;
                            if (!db || !collection || !getDocs || !query || !where) return;
                            // å–ç›®å‰å€åŸŸç¯©é¸å¾Œçš„ç¤¾å€åˆ—è¡¨èˆ‡ä»£è™Ÿæ˜ å°„
                            const currentList = selectedRegion ? [...list].sort(compareCommunitiesByCode).filter(c => (c?.region || '') === selectedRegion) : [...list].sort(compareCommunitiesByCode);
                            const communitiesByCode = Object.fromEntries(currentList.map(c => [ (c.code||'').trim(), c.id ]));
                            const appsSnap = await getDocs(query(collection(db, 'accountApplications'), where('status','==','pending')));
                            // è®€å–å·²æ ¸å‡†æ¸…å–®ï¼Œç”¨ä»¥éæ¿¾åŒåçš„ pendingï¼ˆåŒç¤¾å€ä»£è™Ÿï¼‰
                            let approvedKeySet = new Set();
                            try {
                                const approvedSnap = await getDocs(query(collection(db, 'accountApplications'), where('status','==','approved')));
                                approvedSnap.forEach(d => {
                                    const a = d.data() || {};
                                    const nm = (a.name || '').trim();
                                    const code = (a.serviceCommunityCode || '').trim();
                                    if (nm && communitiesByCode.hasOwnProperty(code)) {
                                        approvedKeySet.add(`${code}::${nm}`);
                                    }
                                });
                            } catch (_) {}
                            const pendingCommIds = new Set();
                            appsSnap.forEach(d => {
                                const a = d.data() || {};
                                const code = (a.serviceCommunityCode || '').trim();
                                const nm = (a.name || '').trim();
                                // è‹¥åŒç¤¾å€åŒåå·²æœ‰å·²æ ¸å‡†ï¼Œå¿½ç•¥æ­¤ pending ä»¥é¿å…ç´«è‰²æ®˜ç•™
                                if (nm && approvedKeySet.has(`${code}::${nm}`)) return;
                                const cid = communitiesByCode[code];
                                if (cid) pendingCommIds.add(cid);
                            });
                            // å¥—ç”¨ç´«è‰²æ¨™ç¤ºï¼Œè‹¥å·²è¢«ç•°å¸¸æ¨™ç´…å‰‡ä¸è¦†è“‹
                            pendingCommIds.forEach(cid => {
                                const btn = container.querySelector(`.enter-community[data-id="${cid}"]`);
                                if (!btn) return;
                                const isRed = btn.classList.contains('bg-red-50');
                                if (isRed) return;
                                btn.classList.remove('bg-white','hover:bg-red-50');
                                btn.classList.add('bg-purple-100','border-violet-200','text-violet-800');
                            });

                            // ç§»é™¤éå¾…æ ¸å‡†ç¤¾å€ä¸Šæ—¢æœ‰çš„ç´«è‰²æ¨™ç¤ºï¼ˆé¿å…æ®˜ç•™ï¼‰
                            container.querySelectorAll('.enter-community').forEach(btn => {
                                const cid = btn.getAttribute('data-id');
                                if (!pendingCommIds.has(cid) && btn.classList.contains('bg-purple-100')) {
                                    btn.classList.remove('bg-purple-100','border-violet-200','text-violet-800');
                                    const hasAlert = btn.classList.contains('bg-red-50') || btn.classList.contains('bg-orange-50') || btn.classList.contains('bg-yellow-50') || btn.classList.contains('bg-gray-100');
                                    if (!hasAlert) {
                                        btn.classList.add('bg-white','hover:bg-red-50');
                                    }
                                }
                            });
                        } catch (e) {
                            console.warn('å¥—ç”¨ç¤¾å€å¾…æ ¸å‡†æ¨™ç¤ºå¤±æ•—', e);
                        }
                    })();

                    // ä¾ç¤¾å€é¡¯ç¤ºã€Œå°šç„¡äººå“¡å¸³è™Ÿã€ç‚ºç°è‰²åº•ï¼ˆä¸è¦†è“‹ç´…/æ©™/é»ƒ/ç´«ï¼‰
                    (async () => {
                        try {
                            const fs = window.__fs || {}; const db = window.__db;
                            const { collection, getDocs } = fs;
                            if (!db || !collection || !getDocs) return;
                            const currentList = selectedRegion ? [...list].sort(compareCommunitiesByCode).filter(c => (c?.region || '') === selectedRegion) : [...list].sort(compareCommunitiesByCode);
                            const communitiesByCode = Object.fromEntries(currentList.map(c => [ (c.code||'').trim(), c.id ]));
                            const usnap = await getDocs(collection(db, 'users'));
                            const counts = Object.fromEntries(currentList.map(c => [c.id, 0]));
                            // åªè¨ˆå…¥æŒ‡å®šäººå“¡è§’è‰²ï¼šç¸½å¹¹äº‹ã€ç§˜æ›¸ã€ä¿å…¨ã€æ¸…æ½”ã€æ©Ÿé›»
                            const allowedRoles = new Set(['ç¸½å¹¹äº‹','ç§˜æ›¸','ä¿å…¨','æ¸…æ½”','æ©Ÿé›»']);
                            const resolveRole = (u) => {
                                const tags = [u.role, u.jobTitle, u.applicationTitle].map(x => ((x||'') + '').trim());
                                for (const t of tags) {
                                    if (!t) continue;
                                    if (allowedRoles.has(t)) return t;
                                    if (t.includes('ä¿å…¨')) return 'ä¿å…¨';
                                    if (t.includes('æ¸…æ½”')) return 'æ¸…æ½”';
                                    if (t.includes('æ©Ÿé›»')) return 'æ©Ÿé›»';
                                    if (t.includes('ç¸½å¹¹äº‹')) return 'ç¸½å¹¹äº‹';
                                    if (t.includes('ç§˜æ›¸')) return 'ç§˜æ›¸';
                                }
                                return null;
                            };
                            usnap.forEach(d => {
                                const u = d.data() || {};
                                // åƒ…ç•¶ä½¿ç”¨è€…å±¬æ–¼æŒ‡å®šäººå“¡è§’è‰²æ™‚æ‰è¨ˆæ•¸
                                const roleName = resolveRole(u);
                                if (!roleName) return;
                                const ids = Array.isArray(u.serviceCommunities) ? u.serviceCommunities : [];
                                const code = (u.serviceCommunityCode || '').trim();
                                const mapped = code ? communitiesByCode[code] : null;
                                const memSet = new Set();
                                ids.forEach(cid => { if (counts.hasOwnProperty(cid)) memSet.add(cid); });
                                if (mapped && counts.hasOwnProperty(mapped)) memSet.add(mapped);
                                memSet.forEach(cid => { counts[cid] = (counts[cid] || 0) + 1; });
                            });
                            Object.keys(counts).forEach(cid => {
                                if ((counts[cid] || 0) === 0) {
                                    const btn = container.querySelector(`.enter-community[data-id="${cid}"]`);
                                    if (!btn) return;
                                    const hasAlert = btn.classList.contains('bg-red-50') || btn.classList.contains('bg-orange-50') || btn.classList.contains('bg-yellow-50') || btn.classList.contains('bg-purple-100');
                                    if (hasAlert) return;
                                    btn.classList.remove('bg-white','hover:bg-red-50','text-gray-800');
                                    btn.classList.add('bg-gray-100','text-gray-600','border-gray-300');
                                }
                            });
                        } catch (e) {
                            console.warn('å¥—ç”¨ç¤¾å€ç°åº•ï¼ˆç„¡äººå“¡ï¼‰æ¨™ç¤ºå¤±æ•—', e);
                        }
                    })();
                };
                renderList();
                try { lucide.createIcons(); } catch (_) {}
            }

            function renderNavByName(container) {
                const { collection, getDocs } = window.__fs || {};
                const db = window.__db;
                container.innerHTML = `<div class="p-4"><div class="text-gray-500">è¼‰å…¥ä¸­...</div></div>`;
                if (!db || !collection || !getDocs) {
                    container.innerHTML = `<div class="p-4 text-red-600">è³‡æ–™åº«å°šæœªå°±ç·’</div>`;
                    return;
                }
                getDocs(collection(db, 'users')).then((snap) => {
                    const users = [];
                    snap.forEach(d => users.push({ id: d.id, ...d.data() }));

                    // è¨ˆç®—å¹´é½¡
                    const computeAge = (birth) => {
                        if (!birth) return null;
                        let dt = null;
                        try {
                            if (typeof birth === 'string') {
                                const s = birth.trim();
                                // æ”¯æ´ YYYY-MM-DD èˆ‡ YYYY/MM/DD
                                dt = new Date(s.replace(/\//g, '-'));
                            } else if (birth && typeof birth.seconds === 'number') {
                                dt = new Date(birth.seconds * 1000);
                            } else if (birth instanceof Date) {
                                dt = birth;
                            }
                        } catch (_) { dt = null; }
                        if (!dt || isNaN(dt.getTime())) return null;
                        const today = new Date();
                        let age = today.getFullYear() - dt.getFullYear();
                        const m = today.getMonth() - dt.getMonth();
                        if (m < 0 || (m === 0 && today.getDate() < dt.getDate())) age--;
                        return age;
                    };

                    // åƒ…é¡¯ç¤ºæŒ‡å®šè§’è‰²ï¼šç¸½å¹¹äº‹ã€ç§˜æ›¸ã€ä¿å…¨ã€æ¸…æ½”ã€æ©Ÿé›»ï¼ˆæ”¯æ´ roleã€jobTitleã€applicationTitle èˆ‡åŒç¾©è©ï¼‰
                    const allowedRoles = new Set(['ç¸½å¹¹äº‹','ç§˜æ›¸','ä¿å…¨','æ¸…æ½”','æ©Ÿé›»']);
                    const resolveRole = (u) => {
                        const tags = [u.role, u.jobTitle, u.applicationTitle].map(x => ((x||'') + '').trim());
                        for (const t of tags) {
                            if (!t) continue;
                            if (allowedRoles.has(t)) return t;
                            if (t.includes('ä¿å…¨')) return 'ä¿å…¨';
                            if (t.includes('æ¸…æ½”')) return 'æ¸…æ½”';
                            if (t.includes('æ©Ÿé›»')) return 'æ©Ÿé›»';
                            if (t.includes('ç¸½å¹¹äº‹')) return 'ç¸½å¹¹äº‹';
                            if (t.includes('ç§˜æ›¸')) return 'ç§˜æ›¸';
                        }
                        return null;
                    };
                    let baseUsers = users.filter(u => resolveRole(u));
                    // äººå“¡ä¾å¹´é½¡å¤šâ†’å°‘æ’åºï¼ˆè‹¥å¹´é½¡ç›¸åŒæˆ–æœªçŸ¥ï¼Œå‚™æ´å§“æ°ç­†ç•«ï¼‰
                    // å„ªå…ˆä½¿ç”¨ u.ageï¼Œå…¶æ¬¡ç”±ç”Ÿæ—¥æ¨ç®—
                    const ageOf = (u) => {
                        const explicitAge = (typeof u.age === 'number') ? u.age : ((typeof u.age === 'string' && /^\d+$/.test(u.age)) ? parseInt(u.age, 10) : null);
                        const computed = (explicitAge !== null && !isNaN(explicitAge)) ? explicitAge : computeAge(u.birth || u.birthday || u.birthDate);
                        return (typeof computed === 'number' && computed >= 0) ? computed : null;
                    };
                    baseUsers.sort((a, b) => {
                        const aa = ageOf(a);
                        const bb = ageOf(b);
                        if (aa !== null && bb !== null) {
                            if (aa !== bb) return bb - aa; // å¹´é½¡ç”±å¤§è‡³å°
                        }
                        if (aa !== null && bb === null) return -1; // æœ‰å¹´é½¡è€…å„ªå…ˆ
                        if (aa === null && bb !== null) return 1;
                        return compareUsersBySurnameStroke(a, b);
                    });

                    let selectedRole = null; // 'ç¸½å¹¹äº‹' | 'ç§˜æ›¸' | 'ä¿å…¨' | 'æ¸…æ½”' | 'æ©Ÿé›»' | null

                    const renderList = () => {
                        const filtered = selectedRole ? baseUsers.filter(u => resolveRole(u) === selectedRole) : baseUsers;
                        container.innerHTML = `
                            <div class="p-4 space-y-3">
                                <div class="flex items-center mb-2">
                                    <div class="flex items-center gap-2 flex-nowrap overflow-x-auto">
                                        <button class="role-btn px-3 py-1 rounded border ${selectedRole==='ç¸½å¹¹äº‹'?'bg-red-600 text-white border-red-600':'bg-white'}" data-role="ç¸½å¹¹äº‹">ç¸½å¹¹äº‹</button>
                                        <button class="role-btn px-3 py-1 rounded border ${selectedRole==='ç§˜æ›¸'?'bg-red-600 text-white border-red-600':'bg-white'}" data-role="ç§˜æ›¸">ç§˜æ›¸</button>
                                        <button class="role-btn px-3 py-1 rounded border ${selectedRole==='ä¿å…¨'?'bg-red-600 text-white border-red-600':'bg-white'}" data-role="ä¿å…¨">ä¿å…¨</button>
                                        <button class="role-btn px-3 py-1 rounded border ${selectedRole==='æ¸…æ½”'?'bg-red-600 text-white border-red-600':'bg-white'}" data-role="æ¸…æ½”">æ¸…æ½”</button>
                                        <button class="role-btn px-3 py-1 rounded border ${selectedRole==='æ©Ÿé›»'?'bg-red-600 text-white border-red-600':'bg-white'}" data-role="æ©Ÿé›»">æ©Ÿé›»</button>
                                    </div>
                                </div>
                                <hr class="border-t border-gray-200 my-2" />
                                <div class="text-sm text-gray-500">ç¸½äººå“¡æ•¸ï¼š${filtered.length}</div>
                                <div class="grid grid-cols-5 gap-2">
                                    ${filtered.map(u => {
                                        const rawName = (u.name || u.displayName || u.email || '(æœªå‘½å)') + '';
                                        const cleaned = rawName.replace(/\s+/g,'');
                                        const nameLine = cleaned || '(æœªå‘½å)';
                                        // å¹´é½¡é¡¯ç¤ºï¼šå„ªå…ˆä½¿ç”¨è³‡æ–™æ¬„ä½ u.ageï¼Œå…¶æ¬¡ç”±ç”Ÿæ—¥æ¨ç®—
                                        const explicitAge = (typeof u.age === 'number') ? u.age : ((typeof u.age === 'string' && /^\d+$/.test(u.age)) ? parseInt(u.age, 10) : null);
                                        const age = (explicitAge !== null && !isNaN(explicitAge)) ? explicitAge : computeAge(u.birth || u.birthday || u.birthDate);
                                        const ageText = (typeof age === 'number' && age >= 0) ? `(${age})` : '';
                                        // å¹´é½¡é¡è‰²è¦å‰‡ï¼š
                                        // - è¶…é 70 æ­²ä¸”ç‚ºã€Œä¿å…¨ã€é¡¯ç¤ºç´…è‰²
                                        // - è¶…é 70 æ­²ä¸”ç‚ºã€Œç¸½å¹¹äº‹ã€ã€Œç§˜æ›¸ã€ã€Œæ¸…æ½”ã€ã€Œæ©Ÿé›»ã€é¡¯ç¤ºè—è‰²
                                        let ageClass = '';
                                        if (typeof age === 'number' && age > 70) {
                                            const r = resolveRole(u);
                                            if (r === 'ä¿å…¨') {
                                                ageClass = 'font-bold text-red-600';
                                            } else if (['ç¸½å¹¹äº‹','ç§˜æ›¸','æ¸…æ½”','æ©Ÿé›»'].includes(r)) {
                                                ageClass = 'font-bold text-blue-600';
                                            }
                                        }
                                        const title = rawName.replace(/"/g,'&quot;');
                                        return `
                                        <button class="view-att w-full px-3 py-2 rounded-md border bg-white hover:bg-blue-50 text-gray-800 font-medium text-sm flex flex-col items-center justify-center text-center" style="aspect-ratio: 1 / 1;" data-id="${u.id}" title="${title}">
                                            <span class="block leading-tight whitespace-nowrap text-center" style="font-size:13px;">${nameLine}</span>
                                            <span class="block leading-tight whitespace-nowrap text-center ${ageClass}" style="font-size:13px;">${ageText || '&nbsp;'}</span>
                                        </button>`;
                                    }).join('')}
                                </div>
                            </div>`;

                        container.querySelectorAll('.view-att').forEach(btn => {
                            btn.addEventListener('click', async (e) => {
                                const id = e.currentTarget.getAttribute('data-id');
                                // æ‰¾åˆ°å°æ‡‰çš„äººå“¡ç‰©ä»¶
                                const user = (selectedRole ? baseUsers.filter(u => resolveRole(u) === selectedRole) : baseUsers).find(u => u.id === id);
                                // ç¢ºä¿ç¤¾å€å¿«å–å·²è¼‰å…¥
                                try { await ensureCommunitiesCache(); } catch (_) {}
                                const byId = state.communitiesById || {};

                                // è§£æè©²å“¡çš„ç¤¾å€IDï¼šå„ªå…ˆä½¿ç”¨ serviceCommunitiesï¼Œå…¶æ¬¡ä½¿ç”¨ serviceCommunityCode å°æ‡‰
                                const resolveCommIdFromUser = (u) => {
                                    if (!u) return null;
                                    const svc = Array.isArray(u.serviceCommunities) ? u.serviceCommunities.filter(Boolean) : [];
                                    if (svc.length > 0) return svc[0];
                                    const code = (u.serviceCommunityCode || '').trim();
                                    if (code) {
                                        const target = Object.values(byId).find(c => (c.code || '').trim() === code);
                                        return target ? target.id : null;
                                    }
                                    return null;
                                };

                                const commId = resolveCommIdFromUser(user);
                                const c = commId ? (byId[commId] || (state.availableCommunities || []).find(x => x.id === commId)) : null;
                                if (c) {
                                    state.currentCommunity = c;
                                    updateHeaderCommunity();
                                    // å°å‘ç¤¾å€çš„è¿½è¹¤åˆ†é å‡ºå‹¤ï¼Œä¸¦é é¸è©²äººå“¡
                                    showPage('tracking', 'attendance', { selectedUserId: id });
                                } else {
                                    // æ‰¾ä¸åˆ°ç¤¾å€æ™‚ï¼Œä»å°å‘å‡ºå‹¤åˆ†é ä¸¦é é¸äººå“¡
                                    showToast('æ‰¾ä¸åˆ°è©²å“¡æ‰€å±¬ç¤¾å€ï¼Œæ”¹ç‚ºç›´æ¥é¡¯ç¤ºå‡ºå‹¤', true);
                                    showPage('tracking', 'attendance', { selectedUserId: id });
                                }
                            });
                        });
                        container.querySelectorAll('.role-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const r = e.currentTarget.getAttribute('data-role');
                                selectedRole = (selectedRole === r) ? null : r;
                                renderList();
                            });
                        });
                        try { lucide.createIcons(); } catch (_) {}

                        // è¼‰å…¥ä¸¦å¥—ç”¨äººå“¡å±¤ç´šç•°å¸¸æ¨™è‰²ï¼ˆç´…>æ©™>é»ƒï¼‰
                        (async () => {
                            try {
                                const fs = window.__fs || {}; const db = window.__db;
                                const { doc, getDoc, collection, getDocs, query, where, orderBy, Timestamp } = fs;
                                const start = new Date(); start.setHours(0,0,0,0);
                                const end = new Date(); end.setHours(23,59,59,999);
                                const tsStart = Timestamp?.fromDate ? Timestamp.fromDate(start) : start;
                                const tsEnd = Timestamp?.fromDate ? Timestamp.fromDate(end) : end;
                                const ymdToday = `${start.getFullYear()}-${String(start.getMonth()+1).padStart(2,'0')}-${String(start.getDate()).padStart(2,'0')}`;

                                // ç•°å¸¸é–‹é—œï¼ˆsettings/location + settings/generalï¼‰
                                let markLocation = true, markShiftOverdue = true, markNoScheduleCommunity = true;
                                try {
                                    const locSnap = await getDoc(doc(db, 'settings', 'location'));
                                    if (locSnap?.exists()) {
                                        const locCfg = locSnap.data() || {};
                                        if (typeof locCfg.markAbnormalLocation === 'boolean') markLocation = locCfg.markAbnormalLocation;
                                    }
                                    const genSnap = await getDoc(doc(db, 'settings', 'general'));
                                    if (genSnap?.exists()) {
                                        const gen = genSnap.data() || {};
                                        if (typeof gen.markShiftOverdueNotStarted === 'boolean') markShiftOverdue = gen.markShiftOverdueNotStarted;
                                        if (typeof gen.markNoScheduleCommunity === 'boolean') markNoScheduleCommunity = gen.markNoScheduleCommunity;
                                    }
                                } catch (_) {}

                                // ç¢ºä¿ç¤¾å€å¿«å–å¯ç”¨ï¼ˆä¾› code -> id å°æ‡‰ï¼‰
                                try { await ensureCommunitiesCache(); } catch (_) {}
                                const communitiesById = state.communitiesById || {};
                                const resolveCommunityIdByCode = (code) => {
                                    const trimmed = (code || '').trim();
                                    if (!trimmed) return null;
                                    const target = Object.values(communitiesById).find(c => (c.code || '').trim() === trimmed);
                                    return target ? target.id : null;
                                };

                                // ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼ˆä¾ä½¿ç”¨è€…åˆ†çµ„ï¼‰
                                const recordsByUser = {};
                                try {
                                    const recSnap = await getDocs(query(collection(db, 'clockInRecords'), where('timestamp','>=', tsStart), where('timestamp','<=', tsEnd)));
                                    recSnap.forEach(d => {
                                        const r = { id: d.id, ...d.data() };
                                        (recordsByUser[r.userId] ||= []).push(r);
                                    });
                                } catch (_) {}

                                const parseHM = (iso, hm) => {
                                    if (!iso || !hm) return null;
                                    const dt = new Date(`${iso}T00:00:00`);
                                    const [hh, mm] = (hm||'').split(':');
                                    dt.setHours(parseInt(hh,10)||0, parseInt(mm,10)||0, 0, 0);
                                    return isNaN(dt.getTime()) ? null : dt;
                                };

                                // ä»Šæ—¥å¾…å¯©å‡å–®ï¼ˆä¾ä½¿ç”¨è€…åˆ†çµ„ï¼‰
                                const pendingLeavesByUserId = {};
                                try {
                                    const tsStart2 = Timestamp?.fromDate ? Timestamp.fromDate(new Date(`${ymdToday}T00:00:00`)) : new Date(`${ymdToday}T00:00:00`);
                                    const tsEnd2 = Timestamp?.fromDate ? Timestamp.fromDate(new Date(`${ymdToday}T23:59:59`)) : new Date(`${ymdToday}T23:59:59`);
                                    const lSnap = await getDocs(query(collection(db, 'leaves'), where('status','==','pending'), where('targetTime','>=', tsStart2), where('targetTime','<=', tsEnd2)));
                                    lSnap.forEach(d => {
                                        const data = d.data() || {};
                                        const uid = data.userId;
                                        if (uid) (pendingLeavesByUserId[uid] ||= []).push({ id: d.id, ...data });
                                    });
                                } catch (_) {}

                                const results = await Promise.all(filtered.map(async (u) => {
                                    let hasAbnormalLocation = false;
                                    let hasPendingLeave = false;
                                    let hasDoublePunch = false;

                                    let svcIds = Array.isArray(u.serviceCommunities) ? u.serviceCommunities.slice() : [];
                                    if ((!svcIds || svcIds.length === 0) && u.serviceCommunityCode) {
                                        const mapped = resolveCommunityIdByCode(u.serviceCommunityCode);
                                        if (mapped) svcIds = [mapped];
                                    }
                                    const recs = recordsByUser[u.id] || [];

                                    // ä½ç½®ç•°å¸¸
                                    if (markLocation && svcIds && svcIds.length > 0) {
                                        for (const r of recs) {
                                            const abnormal = computeRecordAbnormal(r, svcIds);
                                            if (abnormal && abnormal.isAbnormal) { hasAbnormalLocation = true; break; }
                                        }
                                    }

                                    // å¾…å¯©å‡å–®
                                    if ((pendingLeavesByUserId[u.id] || []).length > 0) hasPendingLeave = true;

                                    // ç•°å¸¸ï¼šä»Šæ—¥å­˜åœ¨é‡è¤‡ä¸Šç­æˆ–é‡è¤‡ä¸‹ç­æ‰“å¡
                                    {
                                        let startCount = 0, endCount = 0;
                                        for (const r of recs) {
                                            const dt = r.timestamp?.toDate?.() ? r.timestamp.toDate() : (r.timestamp ? new Date(r.timestamp) : null);
                                            if (!dt) continue;
                                            const y = dt.getFullYear(), m = dt.getMonth()+1, d = dt.getDate();
                                            const ymd = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                                            if (ymd !== ymdToday) continue;
                                            if (r.type === 'ä¸Šç­') startCount++;
                                            if (r.type === 'ä¸‹ç­') endCount++;
                                            if (startCount >= 2 || endCount >= 2) break;
                                        }
                                        if (startCount >= 2 || endCount >= 2) hasDoublePunch = true;
                                    }

                                    // å·¡é‚é€¾æ™‚æœªé–‹å§‹é‚è¼¯å·²ç§»é™¤

                                    return { userId: u.id, hasAbnormalLocation, hasPendingLeave, hasDoublePunch };
                                }));

                                // ä¸€æ¬¡æ€§å¥—ç”¨æ¨£å¼ï¼ˆç´…>æ©™>é»ƒï¼‰
                                for (const r of results) {
                                    const btn = container.querySelector(`.view-att[data-id="${r.userId}"]`);
                                    if (!btn) continue;
                                    const add = (cls) => cls.forEach(cn => btn.classList.add(cn));
                                    const remove = (cls) => cls.forEach(cn => btn.classList.remove(cn));
                                    if (r.hasPendingLeave || r.hasDoublePunch || r.hasAbnormalLocation) {
                                        remove(['bg-white','hover:bg-blue-50']); add(['bg-red-50','border-red-300','text-red-800']);
                                    }
                                }
                            } catch (e) {
                                console.warn('å¥—ç”¨äººå“¡ç•°å¸¸æ¨™è‰²å¤±æ•—', e);
                            }
                        })();
                    };

                    renderList();
                }).catch((err) => {
                    console.warn('è¼‰å…¥äººå“¡å¤±æ•—', err);
                    container.innerHTML = `<div class="p-4 text-red-600">è¼‰å…¥äººå“¡å¤±æ•—</div>`;
                });
            }

            function renderNavHR(container) {
                const db = window.__db;
                const fs = window.__fs || {};
                const { collection, getDocs } = fs;
                const role = state.currentUserData?.role || '';
                const managerial = new Set(['admin','hr','manager','junior_manager']);
                if (!managerial.has(role)) {
                    container.innerHTML = `<div class="p-4 text-red-600">æ‚¨æ²’æœ‰æ¬Šé™ä½¿ç”¨äººäº‹åˆ†é </div>`;
                    return;
                }

                const subAllowed = ['property','guard','points'];
                state.navHRSubPage = subAllowed.includes(state.navHRSubPage) ? state.navHRSubPage : 'property';

                const render = async () => {
                    // æº–å‚™ç¤¾å€æ¸…å–®
                    try { await ensureCommunitiesCache(); } catch (_) {}
                    try { computeAvailableCommunities(); } catch (_) {}
                    const list = state.availableCommunities || [];
                    const selectedId = state.navHRSelectedCommunityId || state.currentCommunity?.id || '';
                    const active = state.navHRSubPage;
                    const commOptions = list.map(c => `<option value="${c.id}">${c.code ? '['+c.code+'] ' : ''}${c.name || '(æœªå‘½åç¤¾å€)'}</option>`).join('');

                    container.innerHTML = `
                        <div class="h-[50px] flex items-center justify-around border-b border-gray-200 bg-white">
                            <button data-subtab="property" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium ${active==='property' ? 'bg-red-600 text-white' : 'text-gray-600'}">ç‰©æ¥­æ ¸è–ª</button>
                            <button data-subtab="guard" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium ${active==='guard' ? 'bg-red-600 text-white' : 'text-gray-600'}">ä¿å…¨æ ¸è–ª</button>
                            <button data-subtab="points" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium ${active==='points' ? 'bg-red-600 text-white' : 'text-gray-600'}">è¨ˆé»åˆ—è¡¨</button>
                        </div>
                        <div class="p-3 bg-white border-b border-gray-200 flex items-center gap-2">
                            <label class="text-sm text-gray-700">é¸æ“‡ç¤¾å€</label>
                            <select id="hr-community-select" class="px-2 py-1 border rounded text-sm">${commOptions}</select>
                        </div>
                        <div id="hr-content" class="p-3"></div>`;

                    const commSel = document.getElementById('hr-community-select');
                    if (commSel) {
                        commSel.value = selectedId || '';
                        commSel.addEventListener('change', () => {
                            state.navHRSelectedCommunityId = commSel.value || '';
                            renderContent();
                        });
                    }
                    container.querySelectorAll('.sub-tab-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const t = btn.getAttribute('data-subtab');
                            state.navHRSubPage = t;
                            render();
                        });
                    });

                    const renderContent = async () => {
                        const content = document.getElementById('hr-content');
                        const commId = (document.getElementById('hr-community-select')?.value) || '';
                        if (!commId) {
                            content.innerHTML = `<div class="p-4 text-gray-500">è«‹å…ˆé¸æ“‡ç¤¾å€</div>`;
                            return;
                        }
                        if (!db || !collection || !getDocs) {
                            content.innerHTML = `<div class="p-4 text-red-600">è³‡æ–™åº«å°šæœªå°±ç·’</div>`;
                            return;
                        }

                        const byId = state.communitiesById || {};
                        const c = byId[commId];
                        const commCode = c?.code || '';

                        // è§£æè§’è‰²ï¼ˆæ”¯æ´ roleã€jobTitleã€applicationTitle åŒç¾©è©ï¼‰
                        const resolveRole = (u) => {
                            const tags = [u.role, u.jobTitle, u.applicationTitle].map(x => ((x||'') + '').trim());
                            for (const t of tags) {
                                if (!t) continue;
                                if (t.includes('ä¿å…¨')) return 'ä¿å…¨';
                                if (t.includes('æ¸…æ½”')) return 'æ¸…æ½”';
                                if (t.includes('æ©Ÿé›»')) return 'æ©Ÿé›»';
                                if (t.includes('ç¸½å¹¹äº‹')) return 'ç¸½å¹¹äº‹';
                                if (t.includes('ç§˜æ›¸')) return 'ç§˜æ›¸';
                            }
                            return null;
                        };

                        const userBelongsToCommunity = (u) => {
                            const ids = Array.isArray(u.serviceCommunities) ? u.serviceCommunities : [];
                            const codesArr = Array.isArray(u.serviceCommunityCodes) ? u.serviceCommunityCodes : [];
                            const codeOne = (u.serviceCommunityCode || '').trim();
                            const byIdMatch = commId ? ids.includes(commId) : false;
                            const byCodeMatch = commCode ? (codesArr.includes(commCode) || codeOne === commCode) : false;
                            return byIdMatch || byCodeMatch;
                        };

                        if (state.navHRSubPage === 'property') {
                            const snap = await getDocs(collection(db, 'users'));
                            const users = [];
                            snap.forEach(d => users.push({ id: d.id, ...d.data() }));
                            const allowed = new Set(['ç¸½å¹¹äº‹','ç§˜æ›¸','æ¸…æ½”','æ©Ÿé›»']);
                            const filtered = users.filter(u => allowed.has(resolveRole(u)) && userBelongsToCommunity(u));
                            // ä¾å§“æ°ç­†ç•«æ’åº
                            filtered.sort(compareUsersBySurnameStroke);

                            // æœˆä»½é è¨­ç‚ºæœ¬æœˆï¼ˆYYYY-MMï¼‰
                            const now = new Date();
                            const defMonth = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
                            if (!state.navHRMonth) state.navHRMonth = defMonth;

                            content.innerHTML = `
                                <div class="text-sm text-gray-500 mb-2">ç¤¾å€ï¼š${c?.name || '(æœªå‘½åç¤¾å€)'}ï¼›ç‰©æ¥­äººå“¡æ•¸ï¼š${filtered.length}</div>
                                <div class="grid grid-cols-5 gap-2 mb-3">
                                    ${filtered.map(u => {
                                        const rawName = (u.name || u.displayName || u.email || '(æœªå‘½å)') + '';
                                        const cleaned = rawName.replace(/\s+/g,'');
                                        const title = rawName.replace(/"/g,'&quot;');
                                        const effRole = resolveRole(u) || '';
                                        const activeCls = (state.navHRSelectedUserId === u.id) ? 'ring-2 ring-offset-1' : '';
                                        return `
                                        <button class="hr-user-btn w-full px-3 py-2 rounded-md border bg-white hover:bg-blue-50 ${activeCls} text-gray-800 font-medium text-sm flex flex-col items-center justify-center text-center" style="aspect-ratio: 1 / 1;" data-id="${u.id}" title="${title}">
                                            <span class="block leading-tight whitespace-nowrap text-center" style="font-size:13px;">${cleaned || '(æœªå‘½å)'}</span>
                                            <span class="block leading-tight whitespace-nowrap text-center text-xs ${roleBadgeClass(effRole)}" style="font-size:11px;">${effRole || ''}</span>
                                        </button>`;
                                    }).join('')}
                                </div>
                                <div class="flex items-center gap-2 mb-2">
                                    <label class="text-sm text-gray-700">é¸æ“‡æœˆä»½</label>
                                    <input id="hr-month-input" type="month" class="px-2 py-1 border rounded text-sm" value="${state.navHRMonth}" />
                                    <button id="hr-print-user" class="px-2 py-1 border rounded text-sm">åˆ—å°æ­¤äºº</button>
                                    <button id="hr-print-all" class="px-2 py-1 border rounded text-sm">åˆ—å°å…¨å“¡</button>
                                    <div id="hr-selected-user-label" class="text-sm text-gray-600"></div>
                                </div>
                                <div id="payroll-table-container" class="bg-white border rounded"></div>
                                <div class="mt-3 text-xs text-gray-400">æç¤ºï¼šé»äººå“¡å¾Œä¸‹æ–¹ç”Ÿæˆè©²å“¡æœ¬æœˆç°½åˆ°è¡¨ï¼ˆä¸Š/ä¸‹ç­æ™‚é–“ï¼‰ã€‚</div>`;

                            const monthInput = document.getElementById('hr-month-input');
                            if (monthInput) {
                                monthInput.addEventListener('change', () => {
                                    state.navHRMonth = monthInput.value || defMonth;
                                    renderPropertyPayrollTable();
                                });
                            }
                            const labelEl = document.getElementById('hr-selected-user-label');

                            content.querySelectorAll('.hr-user-btn').forEach(btn => {
                                btn.addEventListener('click', (e) => {
                                    state.navHRSelectedUserId = e.currentTarget.getAttribute('data-id');
                                    // æ›´æ–°é¸å–æ¨£å¼
                                    content.querySelectorAll('.hr-user-btn').forEach(b=> b.classList.remove('ring-2','ring-offset-1'));
                                    e.currentTarget.classList.add('ring-2','ring-offset-1');
                                    renderPropertyPayrollTable();
                                });
                            });

                            function buildPayrollTableHtmlForUser(uid, ym) {
                                const defMonthLocal = ym || state.navHRMonth || defMonth;
                                const user = users.find(u => u.id === uid);
                                const userName = (user?.name || user?.displayName || user?.email || '(æœªå‘½å)') + '';
                                const roleTitle = resolveRole(user) || '';
                                const [yearStr, monStr] = (defMonthLocal||'').split('-');
                                const yyyy = parseInt(yearStr,10)||now.getFullYear();
                                const mm = parseInt(monStr,10)||now.getMonth()+1;
                                const daysInMonth = new Date(yyyy, mm, 0).getDate();
                                const startDt = new Date(`${yyyy}-${String(mm).padStart(2,'0')}-01T00:00:00`);
                                const endDt = new Date(`${yyyy}-${String(mm).padStart(2,'0')}-${String(daysInMonth).padStart(2,'0')}T23:59:59`);
                                const { query, where, Timestamp } = fs;
                                let records = [];
                                try {
                                    const tsStart = Timestamp?.fromDate ? Timestamp.fromDate(startDt) : startDt;
                                    const tsEnd = Timestamp?.fromDate ? Timestamp.fromDate(endDt) : endDt;
                                    const snapRec = window.__fs && window.__db ? window.__fs.getDocs(query(collection(db, 'clockInRecords'), where('userId','==', uid), where('timestamp','>=', tsStart), where('timestamp','<=', tsEnd))) : null;
                                    if (snapRec && snapRec.then) {
                                        // await for snapshot
                                        return snapRec.then(s => {
                                            s.forEach(d=> records.push({ id: d.id, ...d.data() }));
                                            return __buildPayrollHtmlFromRecords(records, { yyyy, mm, daysInMonth, userName, roleTitle, community: c });
                                        });
                                    }
                                } catch (e) {
                                    console.warn('è¼‰å…¥æ‰“å¡ç´€éŒ„å¤±æ•—', e);
                                }
                                // é async æƒ…å¢ƒï¼ˆç†è«–ä¸Šä¸æœƒé€²åˆ°é€™è£¡ï¼‰ï¼Œç›´æ¥çµ„ HTML
                                return __buildPayrollHtmlFromRecords(records, { yyyy, mm, daysInMonth, userName, roleTitle, community: c });
                            }

                            function __buildPayrollHtmlFromRecords(records, ctx) {
                                const { yyyy, mm, daysInMonth, userName, roleTitle, community } = ctx;
                                const containerEl = document.getElementById('payroll-table-container');
                                const byDay = {};
                                const toDate = (t)=> (t?.toDate?.() ? t.toDate() : (t ? new Date(t) : null));
                                const hm = (dt)=> dt ? `${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}` : '';
                                records.forEach(r=>{
                                    const dt = toDate(r.timestamp);
                                    if (!dt || isNaN(dt.getTime())) return;
                                    const day = dt.getDate();
                                    const key = day;
                                    const type = r.type || '';
                                    const cur = byDay[key] || { start:null, end:null, startRec:null, endRec:null };
                                    if (type === 'ä¸Šç­') {
                                        if (!cur.start || dt < cur.start) { cur.start = dt; cur.startRec = r; }
                                    } else if (type === 'ä¸‹ç­') {
                                        if (!cur.end || dt > cur.end) { cur.end = dt; cur.endRec = r; }
                                    }
                                    byDay[key] = cur;
                                });
                                const weekdayLabel = (y,m,d,limit)=>{
                                    if (d > limit) return '';
                                    const wd = new Date(y, m-1, d).getDay();
                                    return ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][wd];
                                };
                                const resolvePlace = (rec)=>{
                                    if (!rec) return '';
                                    const ln = (typeof rec.locationName === 'string' && rec.locationName) ? rec.locationName : (rec.location?.address || null);
                                    return ln || (community?.name || '');
                                };
                                const makeRows = (startDay, endDay, opts = {})=> Array.from({length: endDay-startDay+1}, (_,i)=>{
                                    const day = startDay + i;
                                    const rec = byDay[day] || {};
                                    const ws = weekdayLabel(yyyy, mm, day, daysInMonth);
                                    const placeText = resolvePlace(rec.startRec) || resolvePlace(rec.endRec) || '';
                                    const dateW = opts.dateWClass || 'w-10';
                                    const weekW = opts.weekdayWClass || 'w-10';
                                    const dateStyle = opts.dateStyle || '';
                                    return `
                                        <tr>
                                            <td class="border px-2 py-1 text-center ${dateW}" style="${dateStyle}">${day}</td>
                                            <td class="border px-2 py-1 text-center ${weekW}">${ws}</td>
                                            <td class="border px-2 py-1 text-center w-20">${hm(rec.start) || ''}</td>
                                            <td class="border px-2 py-1 text-center w-20">${hm(rec.end) || ''}</td>
                                            <td class="border px-2 py-1 text-center">${placeText}</td>
                                        </tr>`;
                                }).join('');

                                const leftEnd = 16;
                                const rightStart = 17;
                                const rightHas = true;
                                const attendanceDays = Object.keys(byDay).filter(k => (byDay[k]?.start || byDay[k]?.end)).length;
                                const titleComm = (community?.shortName || community?.name || '');
                                const html = `
                                    <div class="p-3 a4-landscape" style="margin:0 auto;">
                                        <div class="text-center text-lg font-semibold mb-2">è¥¿åŒ—ä¿å…¨/è¥¿åŒ—å…¬å¯“ æ©Ÿé›»ç°½åˆ°è¡¨( ${yyyy} å¹´ ${mm} æœˆ )</div>
                                        <div class="text-right mb-1"><span class="font-medium">æ¡ˆå ´</span></div>
                                        <div class="grid grid-cols-2 gap-2">
                                            <table class="w-full border border-gray-300 text-sm">
                                                <colgroup>
                                                    <col style="width:14mm;">
                                                    <col style="width:14mm;">
                                                    <col style="width:25mm;">
                                                    <col style="width:25mm;">
                                                    <col style="width:auto;">
                                                </colgroup>
                                                <thead>
                                                    <tr>
                                                        <th class="border px-2 py-1">æ—¥æœŸ</th>
                                                        <th class="border px-2 py-1">æ˜ŸæœŸ</th>
                                                        <th class="border px-2 py-1">ä¸Šç­æ™‚é–“</th>
                                                        <th class="border px-2 py-1">ä¸‹ç­æ™‚é–“</th>
                                                        <th class="border px-2 py-1">ç°½åˆ°è™•</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${makeRows(1, leftEnd, { dateStyle: 'width:14mm;' })}
                                                </tbody>
                                            </table>
                                            ${rightHas ? `
                                            <table class="w-full border border-gray-300 text-sm">
                                                <colgroup>
                                                    <col style="width:14mm;">
                                                    <col style="width:14mm;">
                                                    <col style="width:25mm;">
                                                    <col style="width:25mm;">
                                                    <col style="width:auto;">
                                                </colgroup>
                                                <thead>
                                                    <tr>
                                                        <th class="border px-2 py-1">æ—¥æœŸ</th>
                                                        <th class="border px-2 py-1">æ˜ŸæœŸ</th>
                                                        <th class="border px-2 py-1">ä¸Šç­æ™‚é–“</th>
                                                        <th class="border px-2 py-1">ä¸‹ç­æ™‚é–“</th>
                                                        <th class="border px-2 py-1">ç°½åˆ°è™•</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${makeRows(rightStart, 31, { dateStyle: 'width:14mm;' })}
                                                </tbody>
                                            </table>` : ''}
                                        </div>
                                        <div class="mt-2">
                                            <table class="w-full border border-gray-300 text-sm">
                                                <colgroup>
                                                    <col style="width:12mm;">
                                                    <col style="width:12mm;">
                                                    <col style="width:12mm;">
                                                    <col style="width:12mm;">
                                                    <col style="width:12mm;">
                                                    <col style="width:12mm;">
                                                    <col style="width:12mm;">
                                                    <col style="width:12mm;">
                                                    <col style="width:12mm;">
                                                    <col style="width:12mm;">
                                                    <col style="width:12mm;">
                                                    <col style="width:12mm;">
                                                    <col style="width:12mm;">
                                                    <col style="width:auto;">
                                                </colgroup>
                                                <tbody>
                                                    <tr>
                                                        <td class="border px-2 py-1 text-center" rowspan="2" style="writing-mode: vertical-rl; transform: rotate(180deg);">é€šå‹¤ç´€éŒ„</td>
                                                        <td class="border px-2 py-1 text-center">é²åˆ°</td>
                                                        <td class="border px-2 py-1 text-center">æ—©é€€</td>
                                                        <td class="border px-2 py-1 text-center">æ› è·</td>
                                                        <td class="border px-2 py-1 text-center">ç—…å‡</td>
                                                        <td class="border px-2 py-1 text-center">äº‹å‡</td>
                                                        <td class="border px-2 py-1 text-center">å…¬å‡</td>
                                                        <td class="border px-2 py-1 text-center">å…¬å·®</td>
                                                        <td class="border px-2 py-1 text-center">åŠ ç­</td>
                                                        <td class="border px-2 py-1 text-center">å©šå‡</td>
                                                        <td class="border px-2 py-1 text-center">å¤œç­</td>
                                                        <td class="border px-2 py-1 text-center">å…¶ä»–</td>
                                                        <td class="border px-2 py-1 text-center">å‡ºå‹¤</td>
                                                        <td class="border px-2 py-1 text-center">ä¼‘å‡</td>
                                                        <td class="border px-2 py-1 text-center">å‚™è¨»</td>
                                                    </tr>
                                                    <tr>
                                                        <td class="border px-2 py-1 text-center">æ¬¡æ•¸</td>
                                                        <td class="border px-2 py-1 text-center">æ¬¡æ•¸</td>
                                                        <td class="border px-2 py-1 text-center">æ—¥æ•¸</td>
                                                        <td class="border px-2 py-1 text-center">æ—¥æ•¸</td>
                                                        <td class="border px-2 py-1 text-center">æ—¥æ•¸</td>
                                                        <td class="border px-2 py-1 text-center">æ—¥æ•¸</td>
                                                        <td class="border px-2 py-1 text-center">æ—¥æ•¸</td>
                                                        <td class="border px-2 py-1 text-center">æ—¥æ•¸</td>
                                                        <td class="border px-2 py-1 text-center">æ—¥æ•¸</td>
                                                        <td class="border px-2 py-1 text-center">æ—¥æ•¸</td>
                                                        <td class="border px-2 py-1 text-center">æ—¥æ•¸</td>
                                                        <td class="border px-2 py-1 text-center">${attendanceDays}</td>
                                                        <td class="border px-2 py-1 text-center">æ—¥æ•¸</td>
                                                        <td class="border px-2 py-1"></td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="mt-2">
                                            <table class="w-full text-sm" style="border-collapse:collapse;">
                                                <colgroup>
                                                    <col style="width:25%;">
                                                    <col style="width:25%;">
                                                    <col style="width:25%;">
                                                    <col style="width:25%;">
                                                </colgroup>
                                                <tbody>
                                                    <tr>
                                                        <td class="no-border px-2 py-4">
                                                            <div style="display:flex; align-items:flex-end; gap:8px;">
                                                                <span>ç¸½ç¶“ç†</span>
                                                                <div class="signature-line" style="flex:1;"></div>
                                                            </div>
                                                        </td>
                                                        <td class="no-border px-2 py-4">
                                                            <div style="display:flex; align-items:flex-end; gap:8px;">
                                                                <span>ç¶“ç†</span>
                                                                <div class="signature-line" style="flex:1;"></div>
                                                            </div>
                                                        </td>
                                                        <td class="no-border px-2 py-4">
                                                            <div style="display:flex; align-items:flex-end; gap:8px;">
                                                                <span>ä¸»ç®¡</span>
                                                                <div class="signature-line" style="flex:1;"></div>
                                                            </div>
                                                        </td>
                                                        <td class="no-border px-2 py-4">
                                                            <div style="display:flex; align-items:flex-end; gap:8px;">
                                                                <span>äººäº‹</span>
                                                                <div class="signature-line" style="flex:1;"></div>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>`;
                                return html;
                            }

                            async function renderPropertyPayrollTable() {
                                const containerEl = document.getElementById('payroll-table-container');
                                if (!containerEl) return;
                                const uid = state.navHRSelectedUserId || '';
                                const ym = state.navHRMonth || defMonth;
                                if (!uid) { containerEl.innerHTML = `<div class="p-4 text-gray-500">è«‹å…ˆé¸æ“‡äººå“¡</div>`; return; }
                                const user = users.find(u => u.id === uid);
                                const userName = (user?.name || user?.displayName || user?.email || '(æœªå‘½å)') + '';
                                if (labelEl) labelEl.textContent = `äººå“¡ï¼š${userName}`;
                                const htmlOrPromise = buildPayrollTableHtmlForUser(uid, ym);
                                if (htmlOrPromise && htmlOrPromise.then) {
                                    const html = await htmlOrPromise;
                                    containerEl.innerHTML = html;
                                } else {
                                    containerEl.innerHTML = htmlOrPromise;
                                }
                                try { lucide.createIcons(); } catch (_) {}
                            }

                            // åˆ—å°ï¼šé–‹æ–°è¦–çª—å°å‡ºç•¶å‰äººå“¡æˆ–å…¨å“¡
                            const openPrintWindow = (html) => {
                                const w = window.open('', '_blank');
                                if (!w) { try { showToast('ç„¡æ³•é–‹å•Ÿåˆ—å°è¦–çª—', true); } catch(_){} return; }
                                w.document.write(`<!DOCTYPE html><html><head><meta charset="utf-8" /><title>ç°½åˆ°è¡¨åˆ—å°</title><style>
                                  @page { size: A4 landscape; margin: 12mm; }
                                  @media print { body { margin: 0; } }
                                  body{margin:20px; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "Noto Sans CJK TC", "PingFang TC", "Microsoft JhengHei", sans-serif;}
                                  table{border-collapse:collapse; width:100%; table-layout:fixed;}
                                  th,td{border:1px solid #333; padding:3px; font-size:11px;}
                                  .no-border{border:none !important;}
                                  .signature-line{border-bottom:1px solid #333; height:0;}
                                  .text-center{text-align:center;}
                                  .text-lg{font-size:16px;}
                                  /* è®“å·¦ã€å³å…©å¼µè¡¨åœ¨åˆ—å°è¦–çª—ä¸¦æ’ */
                                  .grid{display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:6px;}
                                  .p-3{padding:12px;}
                                  .mb-2{margin-bottom:8px;}
                                  .mt-2{margin-top:8px;}
                                  .a4-landscape{width:100%;}
                                </style></head><body>${html}</body></html>`);
                                w.document.close();
                                w.focus();
                                try { w.print(); } catch(_) {}
                            };

                            const printUserBtn = document.getElementById('hr-print-user');
                            const printAllBtn = document.getElementById('hr-print-all');
                            if (printUserBtn) {
                                printUserBtn.addEventListener('click', async ()=>{
                                    const uid = state.navHRSelectedUserId || '';
                                    const ym = state.navHRMonth || defMonth;
                                    if (!uid) { showToast('è«‹å…ˆé¸æ“‡äººå“¡', true); return; }
                                    const htmlOrPromise = buildPayrollTableHtmlForUser(uid, ym);
                                    const html = htmlOrPromise && htmlOrPromise.then ? await htmlOrPromise : htmlOrPromise;
                                    openPrintWindow(html);
                                });
                            }
                            if (printAllBtn) {
                                printAllBtn.addEventListener('click', async ()=>{
                                    const ym = state.navHRMonth || defMonth;
                                    const tasks = filtered.map(u => buildPayrollTableHtmlForUser(u.id, ym));
                                    const parts = [];
                                    for (const t of tasks) {
                                        const html = t && t.then ? await t : t;
                                        parts.push(html);
                                    }
                                    openPrintWindow(parts.join('<div style="page-break-after:always"></div>'));
                                });
                            }

                            // åˆæ¬¡è‹¥å·²æœ‰é¸å–äººå“¡å‰‡æ¸²æŸ“è¡¨æ ¼
                            renderPropertyPayrollTable();
                        } else if (state.navHRSubPage === 'guard') {
                            // ä¾ç¤¾å€è¼‰å…¥å“¨é»åˆ—è¡¨
                            try {
                                const posts = [];
                                const snap = await getDocs(collection(db, 'communities', commId, 'posts'));
                                snap.forEach(d => posts.push({ id: d.id, ...d.data() }));
                                posts.sort((a,b) => (a.createdAt?.toMillis?.()||0) - (b.createdAt?.toMillis?.()||0));
                                content.innerHTML = `
                                    <div class="text-sm text-gray-500 mb-2">ç¤¾å€ï¼š${c?.name || '(æœªå‘½åç¤¾å€)'}ï¼›å“¨é»æ•¸ï¼š${posts.length}</div>
                                    <div class="grid grid-cols-5 gap-2">
                                        ${posts.map(p => `
                                            <div class="w-full px-3 py-2 rounded-md border bg-white text-gray-800 font-medium text-sm flex flex-col items-center justify-center text-center" style="aspect-ratio: 1 / 1;" title="${(p.name||'æœªå‘½åå“¨é»').replace(/"/g,'&quot;')}">
                                                <span class="block leading-tight whitespace-nowrap text-center" style="font-size:13px;">${p.name || 'æœªå‘½åå“¨é»'}</span>
                                            </div>`).join('')}
                                    </div>
                                    <div class="mt-3 text-xs text-gray-400">æç¤ºï¼šå“¨é»æ ¸è–ªä¾ç­è¡¨èˆ‡æ‰“å¡è³‡æ–™ï¼Œè«‹å‰å¾€æ’ç­é ç¶­è­·å“¨é»èˆ‡ç­è¡¨ã€‚</div>`;
                            } catch (e) {
                                console.warn('è¼‰å…¥å“¨é»å¤±æ•—', e);
                                content.innerHTML = `<div class="p-4 text-red-600">è¼‰å…¥å“¨é»å¤±æ•—</div>`;
                            }
                        } else {
                            // è¨ˆé»åˆ—è¡¨ï¼šä¾ç¤¾å€è¼‰å…¥äººå“¡ï¼ˆå«ä¿å…¨ï¼‰
                            const snap = await getDocs(collection(db, 'users'));
                            const users = [];
                            snap.forEach(d => users.push({ id: d.id, ...d.data() }));
                            const allowedAll = new Set(['ç¸½å¹¹äº‹','ç§˜æ›¸','ä¿å…¨','æ¸…æ½”','æ©Ÿé›»']);
                            const filtered = users.filter(u => allowedAll.has(resolveRole(u)) && userBelongsToCommunity(u));
                            filtered.sort(compareUsersBySurnameStroke);
                            content.innerHTML = `
                                <div class="text-sm text-gray-500 mb-2">ç¤¾å€ï¼š${c?.name || '(æœªå‘½åç¤¾å€)'}ï¼›äººå“¡æ•¸ï¼š${filtered.length}</div>
                                <div class="grid grid-cols-5 gap-2">
                                    ${filtered.map(u => {
                                        const rawName = (u.name || u.displayName || u.email || '(æœªå‘½å)') + '';
                                        const cleaned = rawName.replace(/\s+/g,'');
                                        const title = rawName.replace(/"/g,'&quot;');
                                        const effRole = resolveRole(u) || '';
                                        return `
                                        <button class="hr-user-btn w-full px-3 py-2 rounded-md border bg-white hover:bg-blue-50 text-gray-800 font-medium text-sm flex flex-col items-center justify-center text-center" style="aspect-ratio: 1 / 1;" data-id="${u.id}" title="${title}">
                                            <span class="block leading-tight whitespace-nowrap text-center" style="font-size:13px;">${cleaned || '(æœªå‘½å)'}</span>
                                            <span class="block leading-tight whitespace-nowrap text-center text-xs ${roleBadgeClass(effRole)}" style="font-size:11px;">${effRole || ''}</span>
                                        </button>`;
                                    }).join('')}
                                </div>
                                <div class="mt-3 text-xs text-gray-400">æç¤ºï¼šè¨ˆé»è¦å‰‡å°šæœªé€£çµï¼Œé»æ“Šäººå“¡å¯æª¢è¦–å‡ºå‹¤ã€‚</div>`;
                            content.querySelectorAll('.hr-user-btn').forEach(btn => {
                                btn.addEventListener('click', (e) => {
                                    const id = e.currentTarget.getAttribute('data-id');
                                    showPage('tracking', 'attendance', { selectedUserId: id });
                                });
                            });
                        }
                        try { lucide.createIcons(); } catch (_) {}
                    };

                    renderContent();
                };

                render();
            }

            function renderNavSettings(container) {
                // å°è¦½é è¨­å®šï¼šå¸³è™Ÿç”³è«‹ã€å¸³è™Ÿåˆ—è¡¨ã€ç¤¾å€åˆ—è¡¨
                const allowed = ['applications','accounts','community'];
                const sub = allowed.includes(state.navSettingsSubPage) ? state.navSettingsSubPage : 'accounts';
                container.innerHTML = `
                    <div class="h-[50px] flex items-center justify-around border-b border-gray-200 bg-white">
                        <button data-subtab="applications" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${sub === 'applications' ? 'active' : ''}">å¸³è™Ÿç”³è«‹</button>
                        <button data-subtab="accounts" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${sub === 'accounts' ? 'active' : ''}">å¸³è™Ÿåˆ—è¡¨</button>
                        <button data-subtab="community" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${sub === 'community' ? 'active' : ''}">ç¤¾å€åˆ—è¡¨</button>
                    </div>
                    <div id="nav-settings-content" class="overflow-y-auto" style="height: calc(100% - 50px);"></div>`;
                try { lucide.createIcons(); } catch (_) {}

                const contentEl = document.getElementById('nav-settings-content');
                if (sub === 'applications') {
                    renderSettingsApplications(contentEl);
                } else if (sub === 'accounts') {
                    renderSettingsAccounts(contentEl);
                } else {
                    renderSettingsCommunity(contentEl);
                }

                container.querySelectorAll('.sub-tab-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        state.navSettingsSubPage = btn.dataset.subtab;
                        renderNavSettings(container);
                    });
                });
            }

            // --- Page Render Functions ---
            
            function renderDashboard() {
                const role = state.currentUserData?.role || '';
                const isManagerial = role === 'admin' || role === 'manager' || role === 'junior_manager' || role === 'hr';

                // ä¾è§’è‰²åˆ‡æ›å„€è¡¨æ¿å…§å®¹ï¼š
                // ç®¡ç†å“¡ / é«˜éšä¸»ç®¡ / åˆéšä¸»ç®¡ï¼šé¡¯ç¤ºç¤¾å€åˆ—è¡¨
                // ç¸½å¹¹äº‹ã€ä¸€èˆ¬äººå“¡ï¼ˆç§˜æ›¸ã€ä¿å…¨ã€æ¸…æ½”ã€æ©Ÿé›» ç­‰å¤–å‹¤ï¼‰ï¼šé¡¯ç¤ºæˆ‘çš„ç‹€æ…‹èˆ‡é€šçŸ¥
                let contentHtml = '';
                if (isManagerial) {
                    contentHtml = `
                        <div id="all-users-summary-card" class="bg-white p-4 rounded-lg mb-4 shadow-sm border cursor-pointer">
                            <h3 class="font-bold text-gray-800 mb-3 flex items-center justify-between">
                              <span class="flex items-center"><i data-lucide="users" class="w-4 h-4 mr-2"></i>æ‰€æœ‰ç¤¾å€äººå“¡ç‹€æ…‹</span>
                              <span id="community-total-count" class="text-sm text-gray-600">ç¸½äººæ•¸ 0</span>
                            </h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <div class="flex items-center justify-between p-3 rounded bg-green-50 border border-green-100">
                                    <div class="flex items-center text-green-700 font-semibold"><i data-lucide="briefcase" class="w-4 h-4 mr-2"></i>ä¸Šç­</div>
                                    <div id="count-work" class="text-green-800 font-bold">0</div>
                                </div>
                                <div class="flex items-center justify-between p-3 rounded bg-gray-50 border border-gray-200">
                                    <div class="flex items-center text-gray-700 font-semibold"><i data-lucide="moon" class="w-4 h-4 mr-2"></i>ä¸‹ç­</div>
                                    <div id="count-off" class="text-gray-800 font-bold">0</div>
                                </div>
                                <div class="flex items-center justify-between p-3 rounded bg-yellow-50 border border-yellow-200">
                                    <div class="flex items-center text-yellow-700 font-semibold"><i data-lucide="plane" class="w-4 h-4 mr-2"></i>è«‹å‡</div>
                                    <div id="count-leave" class="text-yellow-800 font-bold">0</div>
                                </div>
                            </div>
                            <div class="text-xs text-gray-500 mt-2">é»æ“Šå¯æŸ¥çœ‹è©³ç´°åå–®</div>
                        </div>
                        <div id="dashboard-notifications" class="bg-white p-4 rounded-lg mb-4 shadow-sm border">
                           <h3 class="font-bold text-gray-800 mb-2 flex items-center"><i data-lucide="bell" class="w-4 h-4 mr-2"></i>é€šçŸ¥</h3>
                           <div id="dashboard-anomalies-list" class="space-y-2 text-gray-700">
                             <div class="text-gray-500">è®€å–ä¸­...</div>
                           </div>
                        </div>`;
                } else {
                    contentHtml = `
                        <div class="bg-white p-4 rounded-lg mb-4 shadow-sm border">
                            <h3 class="font-bold text-red-800 mb-2 flex items-center"><i data-lucide="user-circle" class="w-4 h-4 mr-2"></i>æˆ‘çš„ç‹€æ…‹</h3>
                            <div id="my-status" class="text-gray-600">è®€å–ä¸­...</div>
                        </div>
                        <div id="dashboard-notifications" class="bg-white p-4 rounded-lg mb-4 shadow-sm border">
                           <h3 class="font-bold text-gray-800 mb-2 flex items-center"><i data-lucide="bell" class="w-4 h-4 mr-2"></i>é€šçŸ¥</h3>
                           <div id="dashboard-duty-list" class="space-y-2 text-gray-700"></div>
                        </div>`;
                }

                mainContent.innerHTML = `
                    <div class="h-[50px] flex items-center justify-center border-b border-gray-200 bg-white">
                         <p id="current-time" class="text-lg font-semibold text-gray-700"></p>
                    </div>
                    <div class="p-4 overflow-y-auto" style="height: calc(100% - 50px);">${contentHtml}</div>
                `;
                lucide.createIcons();
                // åˆå§‹æ›´æ–°ã€Œæˆ‘çš„ç‹€æ…‹ã€ä»¥ç¢ºä¿ç«‹å³é¡¯ç¤ºï¼ˆåƒ…éç®¡ç†è¦–åœ–ï¼‰
                try {
                    if (!isManagerial && typeof updateDashboardStatus === 'function') {
                        updateDashboardStatus();
                    }
                } catch (e) { console.warn('updateDashboardStatus åˆå§‹åŸ·è¡Œå¤±æ•—', e); }
                const timeEl = document.getElementById('current-time');
                const timerInterval = setInterval(() => {
                    if(timeEl){ timeEl.textContent = new Date().toLocaleString('zh-TW', { dateStyle: 'long', timeStyle: 'medium', hour12: false }); }
                }, 1000);
                state.activeListeners.push(() => clearInterval(timerInterval));
                
                // ç®¡ç†éšå±¤ï¼šæ¸²æŸ“ç•°å¸¸é€šçŸ¥ï¼ˆç¤¾å€åˆ—è¡¨é¡¯ç¤ºå·²ç§»é™¤ï¼‰
                if (isManagerial) {
                    try { renderManagerAnomalies(); } catch (e) { console.warn('æ¸²æŸ“ç•°å¸¸é€šçŸ¥å¤±æ•—', e); }
                    // æ¯ 60 ç§’è‡ªå‹•åˆ·æ–°ä¸€æ¬¡é€šçŸ¥
                    try {
                        if (state.__anomaliesRefreshIntervalId) { clearInterval(state.__anomaliesRefreshIntervalId); }
                        state.__anomaliesRefreshIntervalId = setInterval(() => {
                            try { renderManagerAnomalies(); } catch (_) {}
                        }, 60 * 1000);
                        state.activeListeners.push(() => { try { clearInterval(state.__anomaliesRefreshIntervalId); } catch (_) {} });
                    } catch (_) {}
                }
                // éç®¡ç†è§’è‰²ï¼šæ¸²æŸ“å€‹äººä»Šæ—¥ç•°å¸¸é€šçŸ¥
                if (!isManagerial) {
                    try { renderPersonalAnomalies(); } catch (e) { console.warn('æ¸²æŸ“å€‹äººç•°å¸¸é€šçŸ¥å¤±æ•—', e); }
                }
                
                // æª¢æŸ¥æ˜¯å¦é¡¯ç¤ºå“¡å·¥ç‹€æ…‹
                // å®šç¾©é»˜èªè¨­ç½®
                const defaultSettings = {
                    showEmployeeStatus: true
                };
                
                // å˜—è©¦å¾æœ¬åœ°å­˜å„²ç²å–è¨­ç½®
                let localSettings;
                try {
                    const savedSettings = localStorage.getItem('app_general_settings');
                    localSettings = savedSettings ? JSON.parse(savedSettings) : defaultSettings;
                } catch (e) {
                    console.warn("Could not load settings from local storage:", e);
                    localSettings = defaultSettings;
                }
                
                // æ‡‰ç”¨æœ¬åœ°è¨­ç½®ï¼ˆåƒ…ç•¶å­˜åœ¨ã€Œæ‰€æœ‰åŒä»ç‹€æ…‹ã€å¡ç‰‡æ™‚ï¼‰
                if (localSettings.showEmployeeStatus === false) {
                    const container = document.getElementById('all-users-summary-card');
                    if (container) container.style.display = 'none';
                }
                
                // å˜—è©¦å¾Firebaseç²å–æœ€æ–°è¨­ç½®ï¼Œä½†ä¸é˜»å¡UI
                try {
                    const settingsRef = doc(db, "settings", "general");
                    getDoc(settingsRef).then((docSnap) => {
                        if (docSnap.exists()) {
                            const settings = docSnap.data();
                            // ä¿å­˜åˆ°æœ¬åœ°å­˜å„²ä»¥ä¾›å°‡ä¾†ä½¿ç”¨
                            localStorage.setItem('app_general_settings', JSON.stringify(settings));
                            
                            // å¦‚æœè¨­ç½®èˆ‡æœ¬åœ°ä¸åŒï¼Œç«‹å³æ‡‰ç”¨
                            if (settings.showEmployeeStatus !== localSettings.showEmployeeStatus) {
                                const container = document.getElementById('all-users-summary-card');
                                if (container) {
                                    container.style.display = settings.showEmployeeStatus ? 'block' : 'none';
                                }
                            }
                    }
                }).catch(error => {
                    console.warn("Could not fetch latest settings, using local settings instead:", error);
                });
            } catch (error) {
                console.warn("Error in settings fetch attempt:", error);
            }

            // å„€è¡¨æ¿ï¼šç¤¾å€åˆ—è¡¨è¼‰å…¥ï¼ˆåƒ…ç®¡ç†å“¡/ä¸»ç®¡é¡¯ç¤ºï¼‰
            function loadDashboardCommunityList() {
                try {
                    const fs = window.__fs || {};
                    const db = window.__db;
                    const listEl = document.getElementById('dashboard-community-list');
                    if (!db || !listEl) return;
                    const { collection, query, orderBy, getDocs } = fs;
                    const communitiesRef = collection(db, 'communities');
                    let q;
                    try {
                        q = query(communitiesRef, orderBy('name'));
                    } catch (_) {
                        q = communitiesRef;
                    }
                    getDocs(q).then((snap) => {
                        listEl.innerHTML = '';
                        if (snap.empty) {
                            listEl.innerHTML = '<div class="text-gray-500">æš«ç„¡ç¤¾å€è³‡æ–™</div>';
                            return;
                        }
                        const isAdmin = state.currentUserData?.role === 'admin';
                        snap.forEach(docSnap => {
                            const c = docSnap.data();
                            const lat = c.location?.latitude;
                            const lng = c.location?.longitude;
                            const region = c.region || '';
                            const code = c.code || '';
                            const row = document.createElement('div');
                            row.className = 'flex items-center justify-between bg-white p-3 rounded-md shadow-sm border';
                            row.innerHTML = `
                                <div>
                                    <p class="font-medium text-gray-800">
                                        ${region ? `<span class=\"inline-block text-xs px-2 py-0.5 rounded bg-gray-100 text-gray-700 mr-2\">${region}</span>` : ''}
                                        ${code ? `<span class=\"inline-block text-xs px-2 py-0.5 rounded bg-blue-100 text-blue-700 mr-2\">${code}</span>` : ''}
                                        ${c.name || '(æœªå‘½å)'}
                                    </p>
                                    <p class="text-sm text-gray-500">${c.address || ''}</p>
                                    <p class="text-xs text-gray-400">${(Number.isFinite(lat) && Number.isFinite(lng)) ? `(${lat.toFixed ? lat.toFixed(6) : lat}, ${lng.toFixed ? lng.toFixed(6) : lng})` : 'æœªè¨­å®šåº§æ¨™'}</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    ${(Number.isFinite(lat) && Number.isFinite(lng)) ? `<button class="view-map-btn px-2 py-1 text-gray-600 hover:text-red-600" data-lat="${lat}" data-lng="${lng}"><i data-lucide="map-pin" class="w-4 h-4"></i></button>` : ''}
                                    ${isAdmin ? `<button class="delete-community-btn px-2 py-1 text-gray-600 hover:text-red-600" data-id="${docSnap.id}"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
                                </div>`;
                            listEl.appendChild(row);
                        });
                        lucide.createIcons();
                        listEl.querySelectorAll('.view-map-btn').forEach(btn => btn.addEventListener('click', (e) => {
                            const lat = parseFloat(e.currentTarget.dataset.lat);
                            const lng = parseFloat(e.currentTarget.dataset.lng);
                            if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;
                            openMapModal(lat, lng);
                        }));
                        listEl.querySelectorAll('.delete-community-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                            const id = e.currentTarget.dataset.id;
                            if (!id) return;
                            const ok = confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç¤¾å€ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ã€‚');
                            if (!ok) return;
                            try {
                                const { doc, deleteDoc } = window.__fs; const db = window.__db;
                                await deleteDoc(doc(db, 'communities', id));
                                e.currentTarget.closest('.flex.items-center.justify-between')?.remove();
                                try { if (state.communitiesById) { delete state.communitiesById[id]; } } catch (_) {}
                                showToast('å·²åˆªé™¤ç¤¾å€');
                            } catch (err) {
                                console.error('åˆªé™¤ç¤¾å€å¤±æ•—', err);
                                showToast('åˆªé™¤ç¤¾å€å¤±æ•—', true);
                            }
                        }));
                    }).catch((err) => {
                        console.error('è®€å–ç¤¾å€åˆ—è¡¨å¤±æ•—', err);
                        listEl.innerHTML = '<div class="text-red-500">è®€å–ç¤¾å€åˆ—è¡¨å¤±æ•—</div>';
                    });
                } catch (e) {
                    console.warn('åˆå§‹åŒ–ç¤¾å€åˆ—è¡¨å¤±æ•—', e);
                }
            }

            // ç®¡ç†è€…ç•°å¸¸é€šçŸ¥ï¼ˆæœªæ‰“å¡ã€å®šä½ç•°å¸¸ã€ææ—©ä¸‹ç­ã€é›™é‡æ‰“å¡ã€å¾…å¯©å‡å–®ï¼‰
            async function renderManagerAnomalies() {
                try {
                    const listEl = document.getElementById('dashboard-anomalies-list');
                    if (!listEl) return;
                    const fs = window.__fs || {}; const db = window.__db;
                    const { collection, getDocs, query, where, orderBy, Timestamp, doc, getDoc, setDoc, deleteDoc } = fs;
                    // éœ€è¼‰å…¥å®šä½è¨­å®šèˆ‡ç¤¾å€å¿«å–ï¼Œä¾›å®šä½ç•°å¸¸åˆ¤æ–·
                    try { await ensureAbnormalMarkingConfig(); } catch (_) {}
                    try { await ensureCommunitiesCache(); } catch (_) {}
                    // å–å¾—æ‰€æœ‰ä½¿ç”¨è€…ï¼ˆå¥—ç”¨å¯è¦‹æ€§è¨­å®šï¼‰
                    const usersSnap = await getDocs(collection(db, 'users'));
                    let users = [];
                    usersSnap.forEach(d => users.push({ id: d.id, ...d.data() }));
                    let visibleUsers = {};
                    try {
                        const savedSettings = localStorage.getItem('app_general_settings');
                        if (savedSettings) { visibleUsers = JSON.parse(savedSettings).visibleUsers || {}; }
                    } catch (_) {}
                    users = users.filter(u => visibleUsers[u.id] !== false);

                    // ä¾ç•¶å‰ç¤¾å€éæ¿¾ï¼ˆè‹¥æœ‰ï¼Œæ”¯æ´ code/id æ˜ å°„ï¼‰
                    const currentCommId = state.currentCommunity?.id || null;
                    const currentCommCode = state.currentCommunity?.code || state.currentCommunity?.communityCode || null;
                    const communitiesById = state.communitiesById || {};
                    const resolveCommunityIdByCode = (code) => {
                        const trimmed = (code || '').trim();
                        if (!trimmed) return null;
                        const target = Object.values(communitiesById).find(c => (c.code || '').trim() === trimmed);
                        return target ? target.id : null;
                    };
                    const resolvedIdFromCode = currentCommCode ? resolveCommunityIdByCode(currentCommCode) : null;
                    const targetCommunityId = currentCommId || resolvedIdFromCode || null;
                    // å°‡ç•°å¸¸äº‹ä»¶æŒä¹…åŒ–åˆ° Firestoreï¼Œä¸¦è¨­å®š 3 å¤©åˆ°æœŸï¼›é¿å…é‡è¤‡ä»¥å›ºå®šéµè¦†å¯«
                    async function persistAnomalies(events, communityId) {
                        if (!db || !Array.isArray(events) || events.length === 0) return;
                        const now = new Date();
                        const tsNow = Timestamp?.fromDate ? Timestamp.fromDate(now) : now;
                        const buildDocId = (a) => {
                            const userId = a?.user?.id || a?.userId || 'unknown';
                            const type = a?.type || 'æœªçŸ¥ç•°å¸¸';
                            const dt = a?.time instanceof Date ? a.time : (a?.time?.toDate ? a.time.toDate() : new Date());
                            const y = dt.getFullYear(), m = String(dt.getMonth()+1).padStart(2,'0'), d = String(dt.getDate()).padStart(2,'0');
                            const ymd = `${y}-${m}-${d}`;
                            const timeKey = Math.floor(dt.getTime()/1000);
                            return `${userId}_${type}_${ymd}_${timeKey}`;
                        };
                        for (const a of events) {
                            try {
                                const userId = a?.user?.id || a?.userId || 'unknown';
                                const type = a?.type || 'æœªçŸ¥ç•°å¸¸';
                                const dt = a?.time instanceof Date ? a.time : (a?.time?.toDate ? a.time.toDate() : new Date());
                                const docId = buildDocId(a);
                                const expires = new Date(dt.getTime() + 3*24*60*60*1000);
                                // è‹¥å·²æ¨™è¨˜ suppressedï¼Œç•¥éæŒä¹…åŒ–ï¼ˆé¿å…é‡æ–°è¦†å¯«ï¼‰
                                try {
                                    const existSnap = await getDoc(doc(db, 'anomalies', docId));
                                    if (existSnap.exists() && existSnap.data()?.suppressed === true) {
                                        continue;
                                    }
                                } catch (_) {}
                                const payload = {
                                    userId,
                                    type,
                                    detail: a?.detail || '',
                                    time: Timestamp?.fromDate ? Timestamp.fromDate(dt) : dt,
                                    communityId: communityId || null,
                                    createdAt: tsNow,
                                    updatedAt: tsNow,
                                    expiresAt: Timestamp?.fromDate ? Timestamp.fromDate(expires) : expires,
                                    source: 'dashboard'
                                };
                                await setDoc(doc(db, 'anomalies', docId), payload, { merge: true });
                            } catch (_) {}
                        }
                    }
                    // è‡ªå‹•æ¸…ç†ï¼šåˆªé™¤å·²éæœŸï¼ˆexpiresAt <= ç¾åœ¨ï¼‰çš„ç•°å¸¸ï¼›é™å®šç¤¾å€ä»¥æ¸›å°‘è®€å–é‡
                    async function cleanupOldAnomalies(communityId) {
                        try {
                            const now = new Date();
                            const tsNow = Timestamp?.fromDate ? Timestamp.fromDate(now) : now;
                            let q = query(collection(db, 'anomalies'), where('expiresAt','<=', tsNow));
                            if (communityId) {
                                q = query(collection(db, 'anomalies'), where('communityId','==', communityId), where('expiresAt','<=', tsNow));
                            }
                            const snap = await getDocs(q);
                            const batchDeletes = [];
                            snap.forEach(d => batchDeletes.push(d.id));
                            for (const id of batchDeletes) {
                                try { await deleteDoc(doc(db, 'anomalies', id)); } catch (_) {}
                            }
                        } catch (_) {}
                    }
                    if (currentCommId || currentCommCode) {
                        users = users.filter(u => {
                            const idsArr = Array.isArray(u.serviceCommunities) ? u.serviceCommunities : [];
                            const codesArr = Array.isArray(u.serviceCommunityCodes) ? u.serviceCommunityCodes : [];
                            const codeSingle = u.serviceCommunityCode || null;
                            const matchById = currentCommId ? idsArr.includes(currentCommId) || (resolvedIdFromCode && idsArr.includes(resolvedIdFromCode)) : false;
                            const matchByCode = currentCommCode ? (codesArr.includes(currentCommCode) || codeSingle === currentCommCode) : false;
                            return matchById || matchByCode;
                        });
                    }

                    // è¿‘ä¸‰æ—¥ç¯„åœï¼ˆå«ä»Šæ—¥ï¼‰ï¼šè¶…éä¸‰æ—¥ä¸é¡¯ç¤º
                    const now = new Date();
                    const rangeEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                    const rangeStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    rangeStart.setDate(rangeStart.getDate() - 2);
                    const tsStart = Timestamp?.fromDate ? Timestamp.fromDate(rangeStart) : rangeStart;
                    const tsEnd = Timestamp?.fromDate ? Timestamp.fromDate(rangeEnd) : rangeEnd;

                    // å–è¿‘ä¸‰æ—¥æ‰“å¡ç´€éŒ„ï¼ˆå‰ç«¯éæ¿¾æ‰€å±¬ä½¿ç”¨è€…ï¼‰
                    const recSnap = await getDocs(query(collection(db, 'clockInRecords'), where('timestamp', '>=', tsStart), where('timestamp', '<=', tsEnd)));
                    const records = [];
                    recSnap.forEach(d => records.push({ id: d.id, ...d.data() }));

                    const byUser = {};
                    users.forEach(u => { byUser[u.id] = []; });
                    records.forEach(r => { if (byUser[r.userId]) byUser[r.userId].push(r); });
                    Object.keys(byUser).forEach(uid => {
                        byUser[uid].sort((a,b)=>{
                            const ta = a.timestamp?.toDate?.() ? a.timestamp.toDate() : (a.timestamp ? new Date(a.timestamp) : new Date(0));
                            const tb = b.timestamp?.toDate?.() ? b.timestamp.toDate() : (b.timestamp ? new Date(b.timestamp) : new Date(0));
                            return ta - tb;
                        });
                    });

                    // è®€å–è¿‘ä¸‰æ—¥çš„é æœŸä¸Šä¸‹ç­æ™‚é–“ï¼ˆæ”¯æ´å€‹äººç­è¡¨ï¼Œè·¨æœˆéœ€è¼‰å…¥å¤šä»½è¨­å®šï¼‰
                    let globalDays = {};
                    const daysInRange = [];
                    const monthsToLoad = new Set();
                    {
                        const cur = new Date(rangeStart.getTime());
                        while (cur <= rangeEnd) {
                            const y = cur.getFullYear();
                            const m = String(cur.getMonth()+1).padStart(2,'0');
                            const d = String(cur.getDate()).padStart(2,'0');
                            daysInRange.push({ date: new Date(cur.getTime()), ymd: `${y}-${m}-${d}` });
                            monthsToLoad.add(`${y}-${m}`);
                            cur.setDate(cur.getDate()+1);
                        }
                    }
                    try {
                        for (const ymKey of monthsToLoad) {
                            const sSnap = await getDoc(doc(db, 'settings', `workdays_${ymKey}`));
                            if (sSnap.exists()) {
                                const sd = sSnap.data();
                                const ds = sd?.days || {};
                                Object.assign(globalDays, ds);
                            }
                        }
                    } catch (_) {}
                    const resolveDayHM = (obj) => {
                        if (!obj || typeof obj !== 'object') return { start: '', end: '' };
                        const isHM = (v) => typeof v === 'string' && /^\d{1,2}:\d{2}$/.test(v.trim());
                        let s = '', e = '';
                        const candidatesStart = ['start','startHM','startTime','startTimeDefault','expectedStart','scheduleStart','workStart'];
                        const candidatesEnd   = ['end','endHM','endTime','endTimeDefault','expectedEnd','scheduleEnd','workEnd'];
                        for (const k of candidatesStart) { if (isHM(obj[k])) { s = obj[k]; break; } }
                        for (const k of candidatesEnd)   { if (isHM(obj[k])) { e = obj[k]; break; } }
                        if (!s || !e) {
                            const nested = obj.shiftHours || obj.schedule || obj.workHours || obj.hm || {};
                            if (isHM(nested.start)) s = s || nested.start;
                            if (isHM(nested.end))   e = e || nested.end;
                            if (!s || !e) {
                                const rangeStr = (obj.shift || obj.workShift || obj.range || obj.shiftHM || obj.defaultShift || '').toString();
                                const m = rangeStr.match(/(\d{1,2}:\d{2})\s*[-~ï½è‡³åˆ°]\s*(\d{1,2}:\d{2})/);
                                if (m) { s = s || m[1]; e = e || m[2]; }
                            }
                        }
                        const isOff = obj.isOff === true || obj.workday === false || obj.isWorkday === false || obj.off === true;
                        if (isOff) return { start: '', end: '' };
                        return { start: s, end: e };
                    };
                    const fetchUserDayObjForUser = async (uid, date) => {
                        const y = date.getFullYear();
                        const m = String(date.getMonth() + 1).padStart(2, '0');
                        const d = String(date.getDate()).padStart(2, '0');
                        const ym = `${y}-${m}`;
                        const ymd = `${y}-${m}-${d}`;
                        // å…ˆçœ‹å€‹äºº workdays/calendar
                        try {
                            const uSnap = await getDoc(doc(db, 'users', uid, 'workdays', ym));
                            if (uSnap.exists()) {
                                const ud = uSnap.data() || {};
                                const obj = (ud.days && typeof ud.days === 'object' && ud.days[ymd])
                                    || (ud.workdays && typeof ud.workdays === 'object' && ud.workdays[ymd])
                                    || (Array.isArray(ud.days) ? ud.days.find(it => (it?.dateIso || it?.date || it?.ymd) === ymd) : null)
                                    || (Array.isArray(ud.workdays) ? ud.workdays.find(it => (it?.dateIso || it?.date || it?.ymd) === ymd) : null)
                                    || (ud.map && typeof ud.map === 'object' ? ud.map[ymd] : null);
                                if (obj) return obj;
                            }
                        } catch (_) {}
                        try { const s1 = await getDoc(doc(db, 'users', uid, 'workdays', ym, 'days', ymd)); if (s1.exists()) return s1.data(); } catch (_) {}
                        try { const s2 = await getDoc(doc(db, 'users', uid, 'workdays', ym, ymd)); if (s2.exists()) return s2.data(); } catch (_) {}
                        try {
                            const c1 = await getDoc(doc(db, 'users', uid, 'calendar', ym));
                            if (c1.exists()) {
                                const cd = c1.data() || {};
                                const obj = (cd.days && typeof cd.days === 'object' && cd.days[ymd])
                                    || (cd.workdays && typeof cd.workdays === 'object' && cd.workdays[ymd])
                                    || (Array.isArray(cd.days) ? cd.days.find(it => (it?.dateIso || it?.date || it?.ymd) === ymd) : null)
                                    || (Array.isArray(cd.workdays) ? cd.workdays.find(it => (it?.dateIso || it?.date || it?.ymd) === ymd) : null)
                                    || (cd.map && typeof cd.map === 'object' ? cd.map[ymd] : null);
                                if (obj) return obj;
                            }
                        } catch (_) {}
                        try { const c2 = await getDoc(doc(db, 'users', uid, 'calendar', ym, 'days', ymd)); if (c2.exists()) return c2.data(); } catch (_) {}
                        try { const c3 = await getDoc(doc(db, 'users', uid, 'calendar', ym, ymd)); if (c3.exists()) return c3.data(); } catch (_) {}
                        // å›é€€ï¼šä½¿ç”¨å…¨åŸŸè¨­å®šï¼ˆä¸å«å€‹äººå·®ç•°ï¼‰
                        return globalDays?.[ymd] || null;
                    };

                    // ä»Šæ—¥æ—¥æœŸå­—ä¸²
                    const ymdToday = `${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,'0')}-${String(new Date().getDate()).padStart(2,'0')}`;

                    // è¿‘ä¸‰æ—¥å¾…å¯©å‡å–®ï¼ˆä¾ä½¿ç”¨è€…åˆ†çµ„ï¼‰â€” ä»¥ startTime æŸ¥è©¢ã€endTime å®¢ç«¯éæ¿¾
                    const pendingLeavesByUserId = {};
                    try {
                        const lSnap = await getDocs(query(collection(db, 'leaves'), where('status','==','pending'), where('startTime','<=', tsEnd)));
                        lSnap.forEach(d => {
                            const data = d.data() || {};
                            const uid = data.userId;
                            // å®¢ç«¯éæ¿¾ï¼šendTime >= ä»Šæ—¥èµ·
                            const toDate = v => v?.toDate ? v.toDate() : (v ? new Date(v) : null);
                            const endT = toDate(data.endTime);
                            if (uid && (!endT || endT >= rangeStart)) {
                                (pendingLeavesByUserId[uid] ||= []).push({ id: d.id, ...data });
                            }
                        });
                    } catch (_) {}

                    // è¿‘ä¸‰æ—¥å·²æ ¸å‡†å‡å–®ï¼ˆä¾ä½¿ç”¨è€…èˆ‡æ—¥æœŸåˆ†çµ„ï¼‰â€” ä»¥ startTime æŸ¥è©¢ã€endTime å®¢ç«¯éæ¿¾
                    const approvedLeaveDaysByUserId = {};
                    try {
                        const aSnap = await getDocs(query(collection(db, 'leaves'), where('status','==','approved'), where('startTime','<=', tsEnd)));
                        aSnap.forEach(d => {
                            const data = d.data() || {};
                            const uid = data.userId;
                            const toDate = v => v?.toDate ? v.toDate() : (v ? new Date(v) : null);
                            const st = toDate(data.startTime);
                            const et = toDate(data.endTime);
                            if (!uid) return;
                            if (st && et && et >= rangeStart) {
                                // æ¨™è¨˜è¦†è“‹åˆ°çš„æ¯ä¸€å¤©
                                let cur = new Date(st.getFullYear(), st.getMonth(), st.getDate());
                                const until = new Date(et.getFullYear(), et.getMonth(), et.getDate());
                                while (cur <= until) {
                                    const y = cur.getFullYear();
                                    const m = String(cur.getMonth()+1).padStart(2,'0');
                                    const d = String(cur.getDate()).padStart(2,'0');
                                    const ymd = `${y}-${m}-${d}`;
                                    (approvedLeaveDaysByUserId[uid] ||= {})[ymd] = true;
                                    cur.setDate(cur.getDate()+1);
                                }
                            }
                        });
                    } catch (_) {}

                    const anomalies = [];
                    for (const u of users) {
                        const recs = byUser[u.id] || [];
                        const svcIds = Array.isArray(u.serviceCommunities) ? u.serviceCommunities : (u.serviceCommunityCode ? [u.serviceCommunityCode] : []);
                        // ä¾æ—¥æœŸåˆ†çµ„ç´€éŒ„
                        const recsByDay = {};
                        recs.forEach(r => {
                            const dt = r.timestamp?.toDate?.() ? r.timestamp.toDate() : (r.timestamp ? new Date(r.timestamp) : null);
                            if (!dt) return;
                            const y = dt.getFullYear(), m = dt.getMonth()+1, d = dt.getDate();
                            const ymd = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                            (recsByDay[ymd] ||= []).push(r);
                        });
                        Object.keys(recsByDay).forEach(ymd => {
                            recsByDay[ymd].sort((a,b)=>{
                                const ta = a.timestamp?.toDate?.() ? a.timestamp.toDate() : (a.timestamp ? new Date(a.timestamp) : new Date(0));
                                const tb = b.timestamp?.toDate?.() ? b.timestamp.toDate() : (b.timestamp ? new Date(b.timestamp) : new Date(0));
                                return ta - tb;
                            });
                        });

                        // é›™é‡æ‰“å¡ï¼ˆè¿‘ä¸‰æ—¥ä»»ä¸€å¤©å­˜åœ¨é‡è¤‡ä¸Š/ä¸‹ç­ï¼‰â€” æ¯æ¬¡é”åˆ° 2 æ¬¡æ™‚åŠ å…¥ä¸€ç­†ç•°å¸¸ï¼ˆäº‹ä»¶æ™‚é–“å–ç¬¬äºŒæ¬¡çš„æ™‚é–“ï¼‰
                        for (const { ymd, date } of daysInRange) {
                            const dayRecs = recsByDay[ymd] || [];
                            let countStart = 0, countEnd = 0;
                            for (const r of dayRecs) {
                                if (r.type === 'ä¸Šç­') {
                                    countStart++;
                                    if (countStart === 2) {
                                        const t = r.timestamp?.toDate?.() ? r.timestamp.toDate() : (r.timestamp ? new Date(r.timestamp) : date);
                                        anomalies.push({ type: 'é›™é‡æ‰“å¡', user: u, detail: 'é‡è¤‡ä¸Šç­æ‰“å¡', time: t });
                                    }
                                }
                                if (r.type === 'ä¸‹ç­') {
                                    countEnd++;
                                    if (countEnd === 2) {
                                        const t = r.timestamp?.toDate?.() ? r.timestamp.toDate() : (r.timestamp ? new Date(r.timestamp) : date);
                                        anomalies.push({ type: 'é›™é‡æ‰“å¡', user: u, detail: 'é‡è¤‡ä¸‹ç­æ‰“å¡', time: t });
                                    }
                                }
                            }
                        }

                        // å¾…å¯©å‡å–®ï¼ˆè¿‘ä¸‰æ—¥å…§æœ‰é‡ç–Šè€…ï¼Œä»¥ç”³è«‹æ™‚é–“æˆ–èµ·å§‹æ™‚é–“å‘ˆç¾ï¼‰
                        const pendLeaves = pendingLeavesByUserId[u.id] || [];
                        pendLeaves.forEach(leave => {
                            const toDate = v => v?.toDate ? v.toDate() : (v ? new Date(v) : null);
                            const st = toDate(leave.startTime);
                            const rt = toDate(leave.requestedAt) || st || new Date();
                            const et = toDate(leave.endTime);
                            if (et && et < rangeStart) return; // å·²åœ¨ç¯„åœå‰çµæŸ
                            const detail = (st && et) ? `å¾…å¯©è«‹å‡ï¼š${st.toLocaleString('zh-TW',{hour12:false})} ~ ${et.toLocaleString('zh-TW',{hour12:false})}` : 'å¾…å¯©è«‹å‡';
                            anomalies.push({ type: 'å¾…å¯©å‡å–®', user: u, detail, time: rt });
                        });

                        // ä½ç½®ç•°å¸¸ï¼ˆè¿‘ä¸‰æ—¥ä»»ä¸€ç´€éŒ„ï¼Œåªè¦ç•°å¸¸å°±åˆ—å‡ºï¼‰
                        for (const r of recs) {
                            const abnormal = computeRecordAbnormal(r, svcIds);
                            if (abnormal && abnormal.isAbnormal) {
                                const t = r.timestamp?.toDate?.() ? r.timestamp.toDate() : (r.timestamp ? new Date(r.timestamp) : new Date());
                                anomalies.push({ type: 'æ‰“å¡å®šä½ç•°å¸¸', user: u, detail: abnormal.detail || '', time: t });
                            }
                        }

                        // æœªæ‰“å¡èˆ‡ææ—©ä¸‹ç­ï¼ˆä¾ç­è¡¨ï¼Œè¿‘ä¸‰æ—¥é€æ—¥åˆ¤æ–·ï¼›æ ¸å‡†å‡å–®æ—¥ä¸åˆ—å…¥ï¼‰
                        try {
                            for (const { ymd, date } of daysInRange) {
                                // æ ¸å‡†å‡å–®è¦†è“‹ç•¶æ—¥å‰‡ç•¥é
                                if ((approvedLeaveDaysByUserId[u.id] || {})[ymd]) continue;
                                const obj = await fetchUserDayObjForUser(u.id, date);
                                const hm = resolveDayHM(obj);
                                const toDateFromHM = (hmStr) => {
                                    if (!hmStr) return null;
                                    const base = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 0, 0, 0, 0);
                                    const [hh, mm] = hmStr.split(':').map(x=>parseInt(x,10)||0);
                                    base.setHours(hh, mm, 0, 0);
                                    return isNaN(base.getTime()) ? null : base;
                                };
                                const expStart = toDateFromHM(hm.start);
                                const expEnd = toDateFromHM(hm.end);
                                const dayRecs = recsByDay[ymd] || [];
                                const actualStart = (() => {
                                    const r = dayRecs.find(x => x.type === 'ä¸Šç­') || dayRecs.find(x => x.type === 'å¤–å‡º') || dayRecs.find(x => x.type === 'æŠµé”');
                                    const dt = r?.timestamp?.toDate?.() ? r.timestamp.toDate() : (r?.timestamp ? new Date(r.timestamp) : null);
                                    return dt || null;
                                })();
                                const actualEnd = (() => {
                                    for (let i = dayRecs.length - 1; i >= 0; i--) {
                                        const x = dayRecs[i];
                                        if (x.type === 'ä¸‹ç­' || x.type === 'è‡ªå‹•ä¸‹ç­') {
                                            const dt = x.timestamp?.toDate?.() ? x.timestamp.toDate() : (x.timestamp ? new Date(x.timestamp) : null);
                                            if (dt) return dt;
                                        }
                                    }
                                    return null;
                                })();
                                const thirtyMin = 30 * 60 * 1000;
                                const refTime = (ymd === ymdToday) ? new Date() : new Date(date.getFullYear(), date.getMonth(), date.getDate(), 23,59,59,999);
                                if (expStart && refTime.getTime() >= expStart.getTime() + thirtyMin && !actualStart) {
                                    anomalies.push({ type: 'æœªæ‰“å¡', user: u, detail: 'æœªä¸Šç­ï¼ˆè¶…éè¡¨å®š30åˆ†é˜ï¼‰', time: expStart });
                                }
                                if (expEnd) {
                                    if (actualEnd && actualEnd.getTime() <= expEnd.getTime() - thirtyMin) {
                                        anomalies.push({ type: 'ææ—©ä¸‹ç­', user: u, detail: 'ä¸‹ç­æ—©æ–¼è¡¨å®š30åˆ†é˜ä»¥ä¸Š', time: actualEnd });
                                    } else if (refTime.getTime() >= expEnd.getTime() + thirtyMin && !actualEnd) {
                                        anomalies.push({ type: 'æœªæ‰“å¡', user: u, detail: 'æœªä¸‹ç­ï¼ˆè¶…éè¡¨å®š30åˆ†é˜ï¼‰', time: expEnd });
                                    }
                                }
                            }
                        } catch (_) {}

                        // å·¡é‚é€¾æ™‚æœªé–‹å§‹é‚è¼¯å·²ç§»é™¤
                    }

                    // è®€å–å·²æŠ‘åˆ¶ï¼ˆsuppressedï¼‰çš„ç•°å¸¸ DocId é›†åˆï¼Œé¿å…é‡æ–°é¡¯ç¤º
                    let suppressedIds = new Set();
                    try {
                        const nowX = new Date();
                        const tsNowX = Timestamp?.fromDate ? Timestamp.fromDate(nowX) : nowX;
                        let qSup = query(collection(db, 'anomalies'), where('expiresAt','>=', tsNowX), where('suppressed','==', true));
                        if (targetCommunityId) {
                            qSup = query(collection(db, 'anomalies'), where('communityId','==', targetCommunityId), where('expiresAt','>=', tsNowX), where('suppressed','==', true));
                        }
                        const snapSup = await getDocs(qSup);
                        snapSup.forEach(d => suppressedIds.add(d.id));
                    } catch (_) {}

                    // éæ¿¾ï¼šè¶…éä¸‰æ—¥çš„ç•°å¸¸ä¸é¡¯ç¤ºï¼ˆä¿éšªï¼Œé›–ç„¶æŸ¥è©¢å·²é™åˆ¶ï¼‰+ æ’é™¤å·²æŠ‘åˆ¶
                    const buildDocId = (a) => {
                        const userId = a?.user?.id || a?.userId || 'unknown';
                        const type = a?.type || 'æœªçŸ¥ç•°å¸¸';
                        const dt = a?.time instanceof Date ? a.time : (a?.time?.toDate ? a.time.toDate() : new Date());
                        const y = dt.getFullYear(), m = String(dt.getMonth()+1).padStart(2,'0'), d = String(dt.getDate()).padStart(2,'0');
                        const ymd = `${y}-${m}-${d}`;
                        const timeKey = Math.floor(dt.getTime()/1000);
                        return `${userId}_${type}_${ymd}_${timeKey}`;
                    };
                    const filtered = anomalies.filter(a => {
                        const t = a.time || new Date();
                        if (!(t >= rangeStart && t <= rangeEnd)) return false;
                        const idKey = buildDocId(a);
                        if (suppressedIds.has(idKey)) return false;
                        return true;
                    });
                    // ä¾æ™‚é–“æ–°â†’èˆŠæ’åº
                    filtered.sort((a,b)=>{
                        const ta = a.time ? a.time.getTime() : 0;
                        const tb = b.time ? b.time.getTime() : 0;
                        return tb - ta;
                    });
                    // è§’è‰²ï¼šç¤¾å€ç¶­è­·/ç®¡ç†å¯ç®¡ç†ç•°å¸¸ï¼ˆæŒä¹…åŒ–ã€æ¸…ç†ã€åˆªé™¤ï¼‰
                    const role = state.currentUserData?.role || '';
                    const anomalyManagers = ['admin','hr','manager','junior_manager','community_admin','ç¤¾å€ç®¡ç†å“¡','ç¸½å¹¹äº‹'];
                    const canManage = anomalyManagers.includes(role);
                    // åƒ…ç®¡ç†è§’è‰²åŸ·è¡ŒæŒä¹…åŒ–èˆ‡è‡ªå‹•æ¸…ç†ï¼Œé¿å…ä¸€èˆ¬ç”¨æˆ¶è§¸ç™¼ 400
                    if (canManage) {
                        try {
                            await persistAnomalies(filtered, targetCommunityId);
                            await cleanupOldAnomalies(targetCommunityId);
                        } catch (_) {}
                    }
                    // é¡¯ç¤ºé€šçŸ¥ï¼ˆå«åˆªé™¤éµï¼Œåƒ…ç®¡ç†è§’è‰²å¯è¦‹ï¼‰
                    let html = '';
                    const canDelete = canManage;
                    filtered.forEach(a => {
                        const name = a.user.name || a.user.displayName || 'æœªå‘½å';
                        const icon = (a.type === 'æ‰“å¡å®šä½ç•°å¸¸') ? 'map-pin' : 'alert-triangle';
                        const timeStr = a.time ? a.time.toLocaleString('zh-TW', { hour12:false }) : '';
                        const idKey = buildDocId(a);
                        html += `
                            <div class="p-3 bg-red-50 border border-red-200 rounded-md">
                                <div class="flex items-center justify-between">
                                    <i data-lucide="${icon}" class="w-4 h-4 mr-2 text-red-700"></i>
                                    <span class="font-medium text-gray-800">${a.type}</span>
                                    ${canDelete ? `<button class="delete-anomaly-btn px-2 py-1 text-gray-600 hover:text-red-600" data-id="${idKey}" title="åˆªé™¤"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
                                </div>
                                <div class="mt-1 text-sm text-gray-700">${name}</div>
                                ${a.detail ? `<div class="mt-1 text-xs text-gray-500">${a.detail}</div>` : ''}
                                ${timeStr ? `<div class="mt-1 text-xs text-gray-400">${timeStr}</div>` : ''}
                            </div>`;
                    });
                    listEl.innerHTML = html || '<div class="text-gray-500">æš«ç„¡ç•°å¸¸é€šçŸ¥</div>';
                    try { lucide.createIcons(); } catch (_) {}

                    // ç¶å®šåˆªé™¤äº‹ä»¶ï¼šæ¨™è¨˜ suppressed=trueï¼Œä¸¦ç§»é™¤å¡ç‰‡
                    if (canDelete) {
                        listEl.querySelectorAll('.delete-anomaly-btn').forEach(btn => {
                            btn.addEventListener('click', async (e) => {
                                const id = e.currentTarget.getAttribute('data-id');
                                if (!id) return;
                                try {
                                    const nowY = new Date();
                                    const tsNowY = Timestamp?.fromDate ? Timestamp.fromDate(nowY) : nowY;
                                    await setDoc(doc(db, 'anomalies', id), { suppressed: true, updatedAt: tsNowY }, { merge: true });
                                    // ç«‹å³å¾ UI ç§»é™¤å¡ç‰‡
                                    const card = e.currentTarget.closest('.p-3');
                                    if (card && card.parentNode) card.parentNode.removeChild(card);
                                    try { showToast('å·²åˆªé™¤ç•°å¸¸é€šçŸ¥'); } catch (_) {}
                                } catch (err) {
                                    console.warn('åˆªé™¤ç•°å¸¸äº‹ä»¶å¤±æ•—', err);
                                    try { showToast('åˆªé™¤ç•°å¸¸é€šçŸ¥å¤±æ•—ï¼šè«‹æª¢æŸ¥æ¬Šé™', true); } catch (_) {}
                                }
                            });
                        });
                    }
                } catch (e) {
                    console.warn('è¼‰å…¥ç®¡ç†è€…ç•°å¸¸é€šçŸ¥å¤±æ•—', e);
                }
            }

            // å€‹äººç•°å¸¸é€šçŸ¥ï¼ˆä»Šæ—¥ï¼šå®šä½ç•°å¸¸ã€é›™é‡æ‰“å¡ã€å¾…å¯©å‡å–®ï¼‰
            async function renderPersonalAnomalies() {
                try {
                    const fs = window.__fs || {}; const db = window.__db;
                    const user = window.__auth?.currentUser;
                    const listEl = document.getElementById('dashboard-duty-list');
                    if (!db || !user || !listEl) return;

                    const { collection, query, where, getDocs, doc, getDoc, Timestamp } = fs;
                    const start = new Date(); start.setHours(0,0,0,0);
                    const end = new Date(); end.setHours(23,59,59,999);
                    const tsStart = Timestamp?.fromDate ? Timestamp.fromDate(start) : start;
                    const tsEnd = Timestamp?.fromDate ? Timestamp.fromDate(end) : end;
                    const ymdToday = `${start.getFullYear()}-${String(start.getMonth()+1).padStart(2,'0')}-${String(start.getDate()).padStart(2,'0')}`;

                    // è®€å–ä½¿ç”¨è€…æ–‡ä»¶ä»¥å–å¾—æœå‹™ç¤¾å€
                    let udoc = state.currentUserData || null;
                    if (!udoc || !udoc.id) {
                        try {
                            const usnap = await getDoc(doc(db, 'users', user.uid));
                            if (usnap.exists()) udoc = { id: user.uid, ...usnap.data() };
                        } catch (_) {}
                    }
                    if (!udoc) return;

                    // æº–å‚™ç¤¾å€æ˜ å°„
                    try { await ensureCommunitiesCache(); } catch (_) {}
                    const communitiesById = state.communitiesById || {};
                    const resolveCommunityIdByCode = (code) => {
                        const trimmed = (code || '').trim();
                        if (!trimmed) return null;
                        const target = Object.values(communitiesById).find(c => (c.code || '').trim() === trimmed);
                        return target ? target.id : null;
                    };

                    let svcIds = Array.isArray(udoc.serviceCommunities) ? udoc.serviceCommunities.slice() : [];
                    if ((!svcIds || svcIds.length === 0) && udoc.serviceCommunityCode) {
                        const mapped = resolveCommunityIdByCode(udoc.serviceCommunityCode);
                        if (mapped) svcIds = [mapped];
                    }

                    // ä»Šæ—¥æ‰“å¡ç´€éŒ„ï¼ˆåƒ…æœ¬äººï¼‰
                    const recs = [];
                    try {
                        const q = query(collection(db, 'clockInRecords'), where('userId','==', user.uid), where('timestamp','>=', tsStart), where('timestamp','<=', tsEnd));
                        const snap = await getDocs(q);
                        snap.forEach(d => recs.push({ id: d.id, ...d.data() }));
                        recs.sort((a,b)=>{
                            const ta = a.timestamp?.toDate?.() ? a.timestamp.toDate() : (a.timestamp ? new Date(a.timestamp) : new Date(0));
                            const tb = b.timestamp?.toDate?.() ? b.timestamp.toDate() : (b.timestamp ? new Date(b.timestamp) : new Date(0));
                            return ta - tb;
                        });
                    } catch (_) {}

                    // ä»Šæ—¥å¾…å¯©å‡å–®ï¼ˆåƒ…æœ¬äººï¼‰
                    let pendingLeaves = [];
                    try {
                        const lq = query(collection(db, 'leaves'), where('userId','==', user.uid), where('status','==','pending'), where('targetTime','>=', tsStart), where('targetTime','<=', tsEnd));
                        const lsnap = await getDocs(lq);
                        lsnap.forEach(d => pendingLeaves.push({ id: d.id, ...d.data() }));
                    } catch (_) {}

                    // è¨ˆç®—ç•°å¸¸
                    const anomalies = [];
                    // é›™é‡æ‰“å¡
                    {
                        let startCount = 0, endCount = 0;
                        for (const r of recs) {
                            const dt = r.timestamp?.toDate?.() ? r.timestamp.toDate() : (r.timestamp ? new Date(r.timestamp) : null);
                            if (!dt) continue;
                            const y = dt.getFullYear(), m = dt.getMonth()+1, d = dt.getDate();
                            const ymd = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                            if (ymd !== ymdToday) continue;
                            if (r.type === 'ä¸Šç­') startCount++;
                            if (r.type === 'ä¸‹ç­') endCount++;
                            if (startCount >= 2 || endCount >= 2) break;
                        }
                        if (startCount >= 2 || endCount >= 2) {
                            anomalies.push({ type: 'é›™é‡æ‰“å¡', detail: 'ä»Šæ—¥å­˜åœ¨é‡è¤‡ä¸Šç­æˆ–é‡è¤‡ä¸‹ç­æ‰“å¡' });
                        }
                    }
                    // å¾…å¯©å‡å–®
                    if (pendingLeaves.length > 0) {
                        anomalies.push({ type: 'å¾…å¯©å‡å–®', detail: 'ä»Šæ—¥æœ‰æœªå¯©æ ¸çš„è«‹å‡ç”³è«‹' });
                    }
                    // å®šä½ç•°å¸¸
                    if (Array.isArray(svcIds) && svcIds.length > 0) {
                        for (const r of recs) {
                            const abnormal = computeRecordAbnormal(r, svcIds);
                            if (abnormal && abnormal.isAbnormal) {
                                anomalies.push({ type: 'æ‰“å¡å®šä½ç•°å¸¸', detail: abnormal.detail || '' });
                                break;
                            }
                        }
                    }

                    // å‘ˆç¾ï¼šå»ºç«‹æˆ–æ›´æ–°å€‹äººç•°å¸¸å¡ç‰‡
                    const iconFor = (t) => t === 'æ‰“å¡å®šä½ç•°å¸¸' ? 'map-pin' : 'alert-triangle';
                    const html = anomalies.length ? `
                        <div id="personal-anomalies-card" class="p-3 bg-red-50 border border-red-200 rounded-md">
                          <div class="flex items-center">
                            <i data-lucide="bell" class="w-4 h-4 mr-2 text-red-700"></i>
                            <span class="font-medium text-gray-800">ä»Šæ—¥ç•°å¸¸</span>
                          </div>
                          <div class="mt-2 space-y-2">
                            ${anomalies.map(a => `
                              <div class="flex items-start gap-2">
                                <i data-lucide="${iconFor(a.type)}" class="w-4 h-4 mt-0.5 text-red-700"></i>
                                <div>
                                  <div class="text-sm font-medium text-gray-800">${a.type}</div>
                                  ${a.detail ? `<div class="text-xs text-gray-600">${a.detail}</div>` : ''}
                                </div>
                              </div>
                            `).join('')}
                          </div>
                        </div>` : '';

                    const existing = document.getElementById('personal-anomalies-card');
                    if (html) {
                        if (existing) {
                            existing.outerHTML = html;
                        } else {
                            listEl.insertAdjacentHTML('afterbegin', html);
                        }
                        try { lucide.createIcons(); } catch (_) {}
                    } else if (existing) {
                        existing.remove();
                    }
                } catch (e) {
                    console.warn('è¼‰å…¥å€‹äººç•°å¸¸é€šçŸ¥å¤±æ•—', e);
                }
            }

            // é»æ“Šæ‘˜è¦å¡é–‹å•Ÿæ‰€æœ‰åŒä»ç‹€æ…‹å½ˆçª—
            const summaryCard = document.getElementById('all-users-summary-card');
            if (summaryCard) {
                summaryCard.addEventListener('click', () => {
                    openAllUsersStatusModal();
                });
            }
            
            // å„€éŒ¶æ¿é€šçŸ¥ï¼ˆé€±äº”å€¼ç­æé†’ï¼‰
            (async () => {
                try {
                    const fs = window.__fs || {};
                    const db = window.__db;
                    const user = window.__auth?.currentUser;
                    const listEl = document.getElementById('dashboard-duty-list');
                    if (!db || !user || !listEl) return;

                    const { doc, getDoc, collection, query, where, onSnapshot, Timestamp } = fs;

                    function formatYMD(date) {
                        const y = date.getFullYear();
                        const m = String(date.getMonth() + 1).padStart(2, '0');
                        const d = String(date.getDate()).padStart(2, '0');
                        return `${y}-${m}-${d}`;
                    }

                    function getWeekFriday(date) {
                        const d = new Date(date);
                        const day = d.getDay();
                        // èª¿æ•´åˆ°æœ¬é€±çš„æ˜ŸæœŸä¸€
                        const diffToMonday = day === 0 ? -6 : (1 - day);
                        const monday = new Date(d);
                        monday.setDate(d.getDate() + diffToMonday);
                        const friday = new Date(monday);
                        friday.setDate(monday.getDate() + 4);
                        return friday;
                    }

                    async function renderDutyReminder() {
                        const now = new Date();
                        const day = now.getDay(); // 1=Mon, 5=Fri
                        const friday = getWeekFriday(now);
                        const isoFriday = formatYMD(friday);

                        const settingsRef = doc(db, 'settings', 'general');
                        const s = await getDoc(settingsRef);
                        const roster = s.exists() ? (s.data().fridayDutyRoster || {}) : {};
                        const names = roster[isoFriday] || [];

                        const clearedKey = `dutyReminderCleared-${isoFriday}-${user.uid}`;
                        const cleared = localStorage.getItem(clearedKey) === '1';

                        const shouldShow = (day === 1 && names.length > 0) || (day === 5 && names.length > 0 && !cleared);
                        if (shouldShow) {
                            // å»ºç«‹æˆ–æ›´æ–°é€±äº”å€¼ç­æé†’å¡ç‰‡
                            let card = document.getElementById('duty-reminder-card');
                            const html = `
                                <div id="duty-reminder-card" class="p-3 bg-yellow-50 border border-yellow-200 rounded-md">
                                  <div class="flex items-center justify-between">
                                    <div class="flex items-center"><i data-lucide="alert-circle" class="w-4 h-4 mr-2 text-yellow-600"></i><span class="font-medium text-yellow-800">æœ¬é€±äº”å€¼ç­</span></div>
                                    <button id="view-calendar" class="text-blue-600 hover:underline text-sm">æŸ¥çœ‹æœˆæ›†</button>
                                  </div>
                                  <div class="mt-2 text-sm text-gray-700">å€¼ç­äººå“¡ï¼š${names.join('ã€')}</div>
                                  <div class="mt-1 text-xs text-gray-500">æ˜ŸæœŸäº”ï¼ˆ${isoFriday}ï¼‰å€¼ç­æé†’</div>
                                </div>`;
                            if (card) {
                                card.outerHTML = html;
                                card = document.getElementById('duty-reminder-card');
                            } else {
                                listEl.insertAdjacentHTML('afterbegin', html);
                                card = document.getElementById('duty-reminder-card');
                            }
                            const btn = document.getElementById('view-calendar');
                            btn?.addEventListener('click', () => showPage('calendar', 'overview'));
                            lucide.createIcons();
                        } else {
                            // ç§»é™¤å€¼ç­æé†’å¡ç‰‡ï¼Œä¸å½±éŸ¿å…¶ä»–é€šçŸ¥
                            const card = document.getElementById('duty-reminder-card');
                            if (card) card.remove();
                            if (!listEl.children.length) {
                                listEl.innerHTML = '<div class="text-gray-500">æš«ç„¡æé†’</div>';
                            }
                        }

                        // é€±äº”ç•¶å¤©è®€å–æ‰“å¡ç´€éŒ„ä»¥æ¸…é™¤æé†’ï¼ˆæ”¹ç”¨ä¸€æ¬¡æ€§æŸ¥è©¢ï¼Œé¿å… Firestore Listen 400ï¼‰
                        if (day === 5 && names.length > 0 && !cleared) {
                            const start = new Date(friday.getFullYear(), friday.getMonth(), friday.getDate());
                            const end = new Date(friday.getFullYear(), friday.getMonth(), friday.getDate(), 23, 59, 59, 999);
                            const tsStart = Timestamp?.fromDate ? Timestamp.fromDate(start) : start;
                            const tsEnd = Timestamp?.fromDate ? Timestamp.fromDate(end) : end;
                            const q = query(
                                collection(db, 'clockInRecords'),
                                where('userId', '==', user.uid),
                                where('timestamp', '>=', tsStart),
                                where('timestamp', '<=', tsEnd)
                            );
                            try {
                                const snap = await getDocs(q);
                                let clearedNow = false;
                                snap.forEach(d => {
                                    const r = d.data();
                                    if (r.type === 'ä¸‹ç­' || r.type === 'è‡ªå‹•ä¸‹ç­') {
                                        clearedNow = true;
                                    }
                                });
                                if (clearedNow) {
                                    localStorage.setItem(clearedKey, '1');
                                    const card = document.getElementById('duty-reminder-card');
                                    if (card) card.remove();
                                    if (!listEl.children.length) {
                                        listEl.innerHTML = '<div class="text-gray-500">æš«ç„¡æé†’</div>';
                                    }
                                }
                            } catch (e) {
                                console.warn('è®€å–é€±äº”æ‰“å¡ç´€éŒ„å¤±æ•—', e);
                            }
                        }
                    }

                    async function renderWorkdayClockCard() {
                        try {
                            const fs = window.__fs || {};
                            const db = window.__db;
                            const user = window.__auth?.currentUser;
                            const listEl = document.getElementById('dashboard-duty-list');
                            if (!db || !user || !listEl) return;

                            const { doc, getDoc, collection, query, where, orderBy, getDocs, Timestamp } = fs;
                            
                            const formatYMD = (date) => {
                                const y = date.getFullYear();
                                const m = String(date.getMonth() + 1).padStart(2, '0');
                                const d = String(date.getDate()).padStart(2, '0');
                                return `${y}-${m}-${d}`;
                            };
                            const getUserDaysMap = async (year, monthIdx) => {
                                const ymKey = `${year}-${String(monthIdx + 1).padStart(2, '0')}`;
                                try {
                                    const uSnap = await getDoc(doc(db, 'users', user.uid, 'workdays', ymKey));
                                    if (uSnap.exists()) {
                                        const ud = uSnap.data() || {};
                                        // æ”¯æ´å¤šç¨®çµæ§‹ï¼šobject æˆ– array
                                        // 1) { days: { 'YYYY-MM-DD': {start:'HH:mm', end:'HH:mm', ...}, ... } }
                                        if (ud.days && typeof ud.days === 'object' && !Array.isArray(ud.days)) {
                                            return ud.days;
                                        }
                                        // 2) { workdays: { 'YYYY-MM-DD': {...} } }
                                        if (ud.workdays && typeof ud.workdays === 'object' && !Array.isArray(ud.workdays)) {
                                            return ud.workdays;
                                        }
                                        // 3) { days: [ {dateIso:'YYYY-MM-DD', ...}, ... ] }
                                        if (Array.isArray(ud.days)) {
                                            const map = {};
                                            for (const it of ud.days) {
                                                const ymd = it?.dateIso || it?.date || it?.ymd;
                                                if (ymd) map[ymd] = it;
                                            }
                                            if (Object.keys(map).length) return map;
                                        }
                                        // 4) { workdays: [ {dateIso:'YYYY-MM-DD', ...}, ... ] }
                                        if (Array.isArray(ud.workdays)) {
                                            const map = {};
                                            for (const it of ud.workdays) {
                                                const ymd = it?.dateIso || it?.date || it?.ymd;
                                                if (ymd) map[ymd] = it;
                                            }
                                            if (Object.keys(map).length) return map;
                                        }
                                        // 5) { map: { 'YYYY-MM-DD': {...} } }
                                        if (ud.map && typeof ud.map === 'object' && !Array.isArray(ud.map)) {
                                            return ud.map;
                                        }
                                    }
                                } catch (_) {}
                                return {};
                            };
                            const hasOwn = (obj, key) => Object.prototype.hasOwnProperty.call(obj || {}, key);
                            const resolveDayHM = (obj) => {
                                const isHM = (v) => typeof v === 'string' && /^\d{1,2}:\d{2}$/.test(v);
                                let s = '', e = '';
                                if (!obj || typeof obj !== 'object') return { start: '', end: '' };
                                const candidatesStart = ['start','startHM','startTime','startTimeDefault','expectedStart','scheduleStart','workStart'];
                                const candidatesEnd   = ['end','endHM','endTime','endTimeDefault','expectedEnd','scheduleEnd','workEnd'];
                                for (const k of candidatesStart) { if (isHM(obj[k])) { s = obj[k]; break; } }
                                for (const k of candidatesEnd)   { if (isHM(obj[k])) { e = obj[k]; break; } }
                                if (!s || !e) {
                                    const nested = obj.shiftHours || obj.schedule || obj.workHours || obj.hm || {};
                                    if (isHM(nested.start)) s = s || nested.start;
                                    if (isHM(nested.end))   e = e || nested.end;
                                    if (!s || !e) {
                                        const rangeStr = (obj.shift || obj.workShift || obj.range || obj.shiftHM || obj.defaultShift || '').toString();
                                        const m = rangeStr.match(/(\d{1,2}:\d{2})\s*[-~ï½è‡³åˆ°]\s*(\d{1,2}:\d{2})/);
                                        if (m) { s = s || m[1]; e = e || m[2]; }
                                    }
                                }
                                const isOff = obj.isOff === true || obj.workday === false || obj.isWorkday === false || obj.off === true;
                                if (isOff) return { start: '', end: '' };
                                return { start: s, end: e };
                            };
                            const fetchUserDayObj = async (date) => {
                                const uid = state.currentUser?.uid;
                                if (!uid) return null;
                                const y = date.getFullYear();
                                const m = String(date.getMonth() + 1).padStart(2, '0');
                                const d = String(date.getDate()).padStart(2, '0');
                                const ym = `${y}-${m}`;
                                const ymd = `${y}-${m}-${d}`;
                                try {
                                    const uSnap = await getDoc(doc(db, 'users', uid, 'workdays', ym));
                                    if (uSnap.exists()) {
                                        const ud = uSnap.data() || {};
                                        const obj = (ud.days && typeof ud.days === 'object' && ud.days[ymd])
                                            || (ud.workdays && typeof ud.workdays === 'object' && ud.workdays[ymd])
                                            || (Array.isArray(ud.days) ? ud.days.find(it => (it?.dateIso || it?.date || it?.ymd) === ymd) : null)
                                            || (Array.isArray(ud.workdays) ? ud.workdays.find(it => (it?.dateIso || it?.date || it?.ymd) === ymd) : null)
                                            || (ud.map && typeof ud.map === 'object' ? ud.map[ymd] : null);
                                        if (obj) return obj;
                                    }
                                } catch (_) {}
                                try {
                                    const s1 = await getDoc(doc(db, 'users', uid, 'workdays', ym, 'days', ymd));
                                    if (s1.exists()) return s1.data();
                                } catch (_) {}
                                try {
                                    const s2 = await getDoc(doc(db, 'users', uid, 'workdays', ym, ymd));
                                    if (s2.exists()) return s2.data();
                                } catch (_) {}
                                try {
                                    const c1 = await getDoc(doc(db, 'users', uid, 'calendar', ym));
                                    if (c1.exists()) {
                                        const cd = c1.data() || {};
                                        const obj = (cd.days && typeof cd.days === 'object' && cd.days[ymd])
                                            || (cd.workdays && typeof cd.workdays === 'object' && cd.workdays[ymd])
                                            || (Array.isArray(cd.days) ? cd.days.find(it => (it?.dateIso || it?.date || it?.ymd) === ymd) : null)
                                            || (Array.isArray(cd.workdays) ? cd.workdays.find(it => (it?.dateIso || it?.date || it?.ymd) === ymd) : null)
                                            || (cd.map && typeof cd.map === 'object' ? cd.map[ymd] : null);
                                        if (obj) return obj;
                                    }
                                } catch (_) {}
                                try {
                                    const c2 = await getDoc(doc(db, 'users', uid, 'calendar', ym, 'days', ymd));
                                    if (c2.exists()) return c2.data();
                                } catch (_) {}
                                try {
                                    const c3 = await getDoc(doc(db, 'users', uid, 'calendar', ym, ymd));
                                    if (c3.exists()) return c3.data();
                                } catch (_) {}
                                return null;
                            };
                            const getUserCfgForDate = async (date) => {
                                const obj = await fetchUserDayObj(date);
                                if (!obj) return { start: '', end: '', _state: 'unset' };
                                const hm = resolveDayHM(obj);
                                const isOff = obj.isOff === true || obj.workday === false || obj.isWorkday === false || obj.off === true;
                                if (isOff) return { start: '', end: '', _state: 'off' };
                                if (hm.start || hm.end) return { ...hm, _state: 'set' };
                                return { start: '', end: '', _state: 'unset' };
                            };

                            // å–å¾—ä»Šæ—¥ç­è¡¨ï¼ˆè¡¨å®šï¼‰èˆ‡å¯¦éš›æ‰“å¡ï¼ˆä¸Š/ä¸‹ç­ï¼‰ï¼Œä¸¦è¨ˆç®—ä¸‹ä¸€å€‹ç­è¡¨ï¼ˆè¡¨å®šä¸Š/ä¸‹ç­ï¼‰
                            const now = new Date();
                            const todayEff = await getUserCfgForDate(now);
                            const todayStartExp = todayEff.start;
                            const todayEndExp = todayEff.end;

                            // æŸ¥è©¢ä»Šæ—¥æ‰“å¡ç´€éŒ„ä»¥å–å¾—å¯¦éš›çš„ä¸Š/ä¸‹ç­æ™‚é–“
                            let actualStart = null;
                            let actualEnd = null;
                            const start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);
                            const end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                            const tsStart = Timestamp?.fromDate ? Timestamp.fromDate(start) : start;
                            const tsEnd = Timestamp?.fromDate ? Timestamp.fromDate(end) : end;
                            let qToday;
                            try {
                                qToday = query(
                                    collection(db, 'clockInRecords'),
                                    where('userId', '==', state.currentUser.uid),
                                    where('timestamp', '>=', tsStart),
                                    where('timestamp', '<=', tsEnd),
                                    orderBy('timestamp', 'asc')
                                );
                            } catch (_) {
                                qToday = query(
                                    collection(db, 'clockInRecords'),
                                    where('userId', '==', state.currentUser.uid),
                                    where('timestamp', '>=', tsStart),
                                    where('timestamp', '<=', tsEnd)
                                );
                            }
                            const snapToday = await getDocs(qToday);
                            const recsToday = [];
                            snapToday.forEach(d => recsToday.push(d.data()));
                            const startRec = recsToday.find(r => r.type === 'ä¸Šç­') || recsToday.find(r => r.type === 'å¤–å‡º');
                            if (startRec && startRec.timestamp) {
                                actualStart = startRec.timestamp?.toDate?.() ? startRec.timestamp.toDate() : new Date(startRec.timestamp);
                            }
                            for (let i = recsToday.length - 1; i >= 0; i--) {
                                const r = recsToday[i];
                                if (r.type === 'ä¸‹ç­' || r.type === 'è‡ªå‹•ä¸‹ç­') {
                                    if (r.timestamp) {
                                        actualEnd = r.timestamp?.toDate?.() ? r.timestamp.toDate() : new Date(r.timestamp);
                                    }
                                    break;
                                }
                            }

                            // è¨ˆç®—ä¸‹ä¸€å€‹ç­è¡¨ï¼ˆåƒ…ä¾ã€Œæˆ‘çš„ç­è¡¨ã€çš„å€‹äººè¨­å®šï¼‰
                            let nextDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                            let nextStartExp = '';
                            let nextEndExp = '';
                            for (let i = 0; i < 60; i++) {
                                const eff = await getUserCfgForDate(nextDate);
                                if (eff._state === 'set' && eff.start) {
                                    nextStartExp = eff.start;
                                    nextEndExp = eff.end || '';
                                    break;
                                }
                                nextDate.setDate(nextDate.getDate() + 1);
                            }

                            const fmtHM = (dt) => dt ? dt.toLocaleTimeString('zh-TW',{hour:'2-digit',minute:'2-digit',hour12:false}) : '';
                            const lineTodayStart = (todayEff._state === 'off')
                                ? 'ä¸Šç­ï¼šéå·¥ä½œæ—¥'
                                : (todayStartExp ? `ä¸Šç­ï¼šè¡¨å®š ${todayStartExp}ï¼›å¯¦éš› ${actualStart ? fmtHM(actualStart) : 'å°šæœª'}` : 'ä¸Šç­ï¼šæœªè¨­å®š');
                            const lineTodayEnd   = (todayEff._state === 'off')
                                ? 'ä¸‹ç­ï¼šéå·¥ä½œæ—¥'
                                : (todayEndExp ? `ä¸‹ç­ï¼šè¡¨å®š ${todayEndExp}ï¼›å¯¦éš› ${actualEnd ? fmtHM(actualEnd) : 'å°šæœª'}` : 'ä¸‹ç­ï¼šæœªè¨­å®š');
                            const nextDateText = `${String(nextDate.getMonth()+1).padStart(2,'0')}/${String(nextDate.getDate()).padStart(2,'0')}`;
                            const lineNext = nextStartExp ? `ä¸‹ä¸€å€‹ç­è¡¨ï¼ˆ${nextDateText}ï¼‰ï¼šä¸Šç­ï¼ˆè¡¨å®šï¼‰${nextStartExp}${nextEndExp ? `ï¼Œä¸‹ç­ï¼ˆè¡¨å®šï¼‰${nextEndExp}` : ''}` : 'ä¸‹ä¸€å€‹ç­è¡¨ï¼šæœªè¨­å®š';

                            const html = `
                                <div id="workday-clock-card" class="p-3 bg-blue-50 border border-blue-200 rounded-md">
                                  <div class="flex items-center"><i data-lucide="clock" class="w-4 h-4 mr-2 text-blue-600"></i><span class="font-medium text-blue-800">ä»Šæ—¥ç­è¡¨èˆ‡æ‰“å¡</span></div>
                                  <div class="mt-1 text-sm text-gray-700">${lineTodayStart}</div>
                                  <div class="mt-1 text-sm text-gray-700">${lineTodayEnd}</div>
                                  <div class="mt-1 text-sm text-gray-700">${lineNext}</div>
                                </div>`;
                            const existing = document.getElementById('workday-clock-card');
                            if (existing) existing.outerHTML = html;
                            else listEl.insertAdjacentHTML('afterbegin', html);
                            try { lucide.createIcons(); } catch (_) {}
                        } catch (e) {
                            console.warn('æ¸²æŸ“æ‰“å¡æ™‚åˆ»é€šçŸ¥å¤±æ•—', e);
                        }
                    }

                    renderWorkdayClockCard();
                    renderDutyReminder();
                } catch (e) {
                    console.warn('åˆå§‹åŒ–å„€éŒ¶æ¿é€šçŸ¥å¤±æ•—', e);
                }
            })();
                
                const usersRef = collection(db, "users");
                const unsubscribe = onSnapshot(query(usersRef), (querySnapshot) => {
                    const countWorkEl = document.getElementById('count-work');
                    const countOutboundEl = document.getElementById('count-outbound');
                    const countOffEl = document.getElementById('count-off');
                    const countLeaveEl = document.getElementById('count-leave');
                    const totalEl = document.getElementById('community-total-count');
                    let myStatusFound = false;
                    const users = [];
                    querySnapshot.forEach(doc => users.push({id: doc.id, ...doc.data()}));
                    
                    // ç²å–è¨­å®šä¸­çš„å¯è¦‹ä½¿ç”¨è€…è¨­å®š
                    let visibleUsers = {};
                    try {
                        const savedSettings = localStorage.getItem('app_general_settings');
                        if (savedSettings) {
                            const settings = JSON.parse(savedSettings);
                            visibleUsers = settings.visibleUsers || {};
                        }
                    } catch (e) {
                        console.warn("Could not load user visibility settings:", e);
                    }
                    
                    // éæ¿¾æ‰ä¸é¡¯ç¤ºçš„ä½¿ç”¨è€…
                    const visibleUsersList = users.filter(user => visibleUsers[user.id] !== false);
                    // é€²ä¸€æ­¥éæ¿¾ï¼šåƒ…é¡¯ç¤ºæœå‹™ã€Œç›®å‰ç¤¾å€ã€çš„å¤–å‹¤ç›¸é—œè§’è‰²ï¼ˆç¸½å¹¹äº‹ã€ç§˜æ›¸ã€ä¿å…¨ã€æ¸…æ½”ã€æ©Ÿé›»ï¼‰
                    const currentCommId = state.currentCommunity?.id || null;
                    const currentCommCode = state.currentCommunity?.code || state.currentCommunity?.communityCode || null;
                    const filteredUsersList = visibleUsersList.filter(u => {
                        // è§’è‰²éæ¿¾ï¼ˆæ’é™¤ç®¡ç†å“¡ã€äººäº‹ã€ä¸»ç®¡ï¼‰
                        if (!isFieldLikeRole(u.role)) return false;
                        // ç¤¾å€æœå‹™éæ¿¾ï¼ˆæ”¯æ´ä»¥ id æˆ– code è¡¨ç¤ºçš„æ¬„ä½ï¼‰
                        const ids = Array.isArray(u.serviceCommunities) ? u.serviceCommunities : [];
                        const codesArr = Array.isArray(u.serviceCommunityCodes) ? u.serviceCommunityCodes : [];
                        const codeSingle = u.serviceCommunityCode || null;
                        const matchById = currentCommId ? ids.includes(currentCommId) : false;
                        const matchByCode = currentCommCode ? (codesArr.includes(currentCommCode) || codeSingle === currentCommCode) : false;
                        return matchById || matchByCode;
                    });
                    
                    // ç‹€æ…‹å„ªå…ˆç´šï¼ˆè‡ªè¨‚ï¼‰ï¼š
                    // 1) ä¸Šç­ä¸­-è¾¦å…¬å®¤ 2) è¿”å›-è¾¦å…¬å®¤ 3) å¤–å‡º-é …ç›®-åœ°é» 4) æŠµé”-é …ç›®-åœ°é»
                    // 5) é›¢é–‹-é …ç›®-åœ°é» 6) è«‹å‡ä¸­ 7) å·²ä¸‹ç­ å…¶é¤˜ç½®å¾Œ
                    const statusPriority = (user) => {
                        const locationText = user.clockInStatus === 'å¤–å‡º' && user.outboundLocation ? user.outboundLocation : (user.lastLocation?.address || null);
                        const display = getStatusDisplayText(user.clockInStatus || 'æœªæ‰“å¡', locationText, user.dutyType);
                        // è«‹å‡ä¸­ï¼šè‡¨æ™‚è«‹å‡æˆ–ç•¶å¤©æœ‰æ•ˆçš„è«‹å‡ç”³è«‹
                        let isLeave = (user.clockInStatus === 'è‡¨æ™‚è«‹å‡') || (display.includes('è«‹å‡'));
                        if (!isLeave) {
                            const leave = user.leaveStatus || '';
                            if (leave === 'approved' || leave === 'pending') {
                                const now = new Date();
                                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                                const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                                if (user.leaveStartTime && user.leaveEndTime) {
                                    const leaveStart = user.leaveStartTime.toDate ? user.leaveStartTime.toDate() : new Date(user.leaveStartTime);
                                    const leaveEnd = user.leaveEndTime.toDate ? user.leaveEndTime.toDate() : new Date(user.leaveEndTime);
                                    isLeave = leaveStart <= todayEnd && leaveEnd >= todayStart;
                                }
                            }
                        }

                        if (display.includes('ä¸Šç­') && (display.includes('è¾¦å…¬å®¤') || display.includes('åœ¨è¾¦å…¬å®¤'))) return 1;
                        if (display.includes('è¿”å›') && (display.includes('è¾¦å…¬å®¤') || display.includes('åœ¨è¾¦å…¬å®¤'))) return 2;
                        if (display.startsWith('å¤–å‡º-')) return 3;
                        if (display.startsWith('æŠµé”-')) return 4;
                        if (display.startsWith('é›¢é–‹-')) return 5;
                        if (isLeave) return 6;
                        if (display.includes('ä¸‹ç­')) return 7;
                        return 8;
                    };

                    filteredUsersList.sort((a, b) => {
                        const prA = statusPriority(a);
                        const prB = statusPriority(b);
                        if (prA !== prB) return prA - prB;
                        // åŒå„ªå…ˆç´šç”¨æœ€è¿‘æ›´æ–°æ™‚é–“ï¼ˆlastUpdatedï¼‰æ–°åˆ°èˆŠ
                        const tA = a.lastUpdated ? (a.lastUpdated.toDate ? a.lastUpdated.toDate() : new Date(a.lastUpdated)) : new Date(0);
                        const tB = b.lastUpdated ? (b.lastUpdated.toDate ? b.lastUpdated.toDate() : new Date(b.lastUpdated)) : new Date(0);
                        if (tA.getTime() !== tB.getTime()) return tB - tA;
                        return a.name.localeCompare(b.name, 'zh-Hant');
                    }).forEach(user => {
                            const locationText = user.clockInStatus === 'å¤–å‡º' && user.outboundLocation ? user.outboundLocation : (user.lastLocation?.address || null);
                            const statusText = getStatusDisplayText(user.clockInStatus || 'æœªæ‰“å¡', locationText, user.dutyType);
                            const statusColor = getStatusColor(statusText);
                        if (user.id === state.currentUser.uid) {
                            myStatusFound = true;
                            (async () => {
                                try {
                                    const myStatusEl = document.getElementById('my-status');
                                    if (!myStatusEl) return; // è‹¥æœªæ¸²æŸ“ã€Œæˆ‘çš„ç‹€æ…‹ã€ï¼Œå‰‡ç•¥éæ›´æ–°
                                    const recordsRef = collection(db, 'clockInRecords');
                                    const q = query(recordsRef, where('userId', '==', state.currentUser.uid), orderBy('timestamp', 'desc'), limit(1));
                                    const snap = await getDocs(q);
                                    let innerHTML = '';
                                    if (!snap.empty) {
                                        const r = snap.docs[0].data();
                                        const statusTextLast = getStatusDisplayText(r.type || 'æœªçŸ¥', r.locationName || null, r.dutyType || null);
                                        const statusColorLast = getStatusColor(statusTextLast);
                                        const ts = r.timestamp && r.timestamp.toDate ? r.timestamp.toDate() : (r.timestamp ? new Date(r.timestamp) : null);
                                        innerHTML = `
                                          <div class="flex items-center justify-between">
                                            <span class="font-semibold text-lg ${statusColorLast}">${statusTextLast}</span>
                                          </div>
                                          <div class="text-sm text-gray-500 mt-1">
                                            ${ts ? 'æ‰“å¡ ' + ts.toLocaleString('zh-TW', {year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false}) : ''}
                                          </div>`;
                                    } else {
                                        const statusTextLast = 'å°šæœªæ‰“å¡';
                                        const statusColorLast = getStatusColor(statusTextLast);
                                        innerHTML = `
                                          <div class="flex items-center justify-between">
                                            <span class="font-semibold text-lg ${statusColorLast}">${statusTextLast}</span>
                                          </div>`;
                                    }
                                    myStatusEl.innerHTML = innerHTML;
                                } catch (err) {
                                    console.error('è®€å–æœ€æ–°æ‰“å¡ç´€éŒ„å¤±æ•—', err);
                                }
                            })();
                        }
                    });

                   // é¡¯ç¤ºç¤¾å€ç¸½äººæ•¸ï¼ˆä¾éæ¿¾å¾Œçš„æ¸…å–®ï¼‰
                   if (totalEl) totalEl.textContent = `ç¸½äººæ•¸ ${filteredUsersList.length}`;

                   // ä»¥ã€Œä»Šæ—¥æ‰“å¡ç´€éŒ„ + ç•¶æ—¥å‡å–®ã€è¨ˆç®—æ‘˜è¦äººæ•¸
                   (async () => {
                        try {
                            const fs = window.__fs || {};
                            const db = window.__db;
                            const { collection, getDocs, query, where, Timestamp } = fs;
                            const now = new Date();
                            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                            const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                            const startTS = Timestamp?.fromDate ? Timestamp.fromDate(todayStart) : todayStart;
                            const endTS = Timestamp?.fromDate ? Timestamp.fromDate(todayEnd) : todayEnd;
                            const uidSet = new Set(filteredUsersList.map(u => u.id));

                            // ä»Šæ—¥æ‰“å¡ç´€éŒ„
                            const recSnap = await getDocs(query(collection(db, 'clockInRecords'), where('timestamp','>=', startTS), where('timestamp','<=', endTS)));
                            const recordsByUser = {};
                            filteredUsersList.forEach(u => { recordsByUser[u.id] = []; });
                            recSnap.forEach(d => {
                                const data = d.data() || {};
                                if (uidSet.has(data.userId)) {
                                    (recordsByUser[data.userId] ||= []).push(data);
                                }
                            });
                            Object.keys(recordsByUser).forEach(uid => {
                                recordsByUser[uid].sort((a,b)=>{
                                    const ta = a.timestamp?.toDate ? a.timestamp.toDate() : (a.timestamp ? new Date(a.timestamp) : new Date(0));
                                    const tb = b.timestamp?.toDate ? b.timestamp.toDate() : (b.timestamp ? new Date(b.timestamp) : new Date(0));
                                    return ta - tb;
                                });
                            });

                            // ä»Šæ—¥å‡å–®ï¼ˆpending/approvedï¼Œè¦†è“‹ä»Šæ—¥ï¼‰
                            const leavesByUser = {};
                            try {
                                const snapPending = await getDocs(query(collection(db, 'leaves'), where('status','==','pending'), where('startTime','<=', endTS)));
                                const snapApproved = await getDocs(query(collection(db, 'leaves'), where('status','==','approved'), where('startTime','<=', endTS)));
                                const toDate = v => v?.toDate ? v.toDate() : (v ? new Date(v) : null);
                                const eat = (snap) => {
                                    snap.forEach(d => {
                                        const data = d.data() || {};
                                        const uid = data.userId;
                                        const st = toDate(data.startTime);
                                        const et = toDate(data.endTime);
                                        if (!uid || !uidSet.has(uid)) return;
                                        if (st && et && st <= todayEnd && et >= todayStart) {
                                            leavesByUser[uid] = true;
                                        }
                                    });
                                };
                                eat(snapPending); eat(snapApproved);
                            } catch (_) {}

                            let countWork = 0, countOff = 0, countLeave = 0;
                            filteredUsersList.forEach(u => {
                                const recs = recordsByUser[u.id] || [];
                                const last = recs.length ? recs[recs.length - 1] : null;
                                const type = last?.type || '';
                                const isLeave = (type === 'è‡¨æ™‚è«‹å‡') || !!leavesByUser[u.id];
                                if (isLeave) countLeave++;
                                else if (type === 'ä¸Šç­' || type === 'è¿”å›') countWork++;
                                else if (type === 'ä¸‹ç­' || type === 'è‡ªå‹•ä¸‹ç­') countOff++;
                            });

                            if (countWorkEl) countWorkEl.textContent = countWork;
                            if (countOutboundEl) countOutboundEl.textContent = 0; // ä¿ç•™ä½”ä½
                            if (countOffEl) countOffEl.textContent = countOff;
                            if (countLeaveEl) countLeaveEl.textContent = countLeave;
                        } catch (err) {
                            console.warn('è¨ˆç®—å„€è¡¨æ¿æ‘˜è¦äººæ•¸å¤±æ•—', err);
                        }
                    })();
                    if(!myStatusFound && document.getElementById('my-status')){ document.getElementById('my-status').textContent = 'ç„¡æ³•å–å¾—æ‚¨çš„ç‹€æ…‹'; }
                
                });
                state.activeListeners.push(unsubscribe);
            }

            // æ‰€æœ‰åŒä»ç‹€æ…‹å½ˆçª—
            function openAllUsersStatusModal() {
                // èƒŒæ™¯
                const backdrop = document.createElement('div');
                backdrop.className = 'fixed inset-0 bg-black bg-opacity-50 z-40';
                backdrop.id = 'all-users-modal-backdrop';
                // å®¹å™¨
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 z-50 flex items-center justify-center';
                modal.id = 'all-users-modal';
                const box = document.createElement('div');
                box.className = 'bg-white rounded-lg shadow-lg w-11/12 max-w-2xl p-4 border';
                box.innerHTML = `
                    <div class=\"flex items-center justify-between mb-2\">
                        <h3 class=\"font-bold text-lg flex items-center\"><i data-lucide=\"users\" class=\"w-5 h-5 mr-2\"></i>æ‰€æœ‰åŒä»ç‹€æ…‹</h3>
                        <button id=\"close-all-users-modal\" class=\"text-gray-600 hover:text-gray-800\"><i data-lucide=\"x\" class=\"w-5 h-5\"></i></button>
                    </div>
                    <div id=\"all-users-modal-list\" class=\"space-y-2 max-h-[60vh] overflow-y-auto\">
                        <div class=\"text-center p-4 text-gray-500\">è®€å–ä¸­...</div>
                    </div>
                `;
                modal.appendChild(box);
                document.body.appendChild(backdrop);
                document.body.appendChild(modal);
                lucide.createIcons();
                
                const usersRef = collection(db, 'users');
                const unsub = onSnapshot(query(usersRef), (querySnapshot) => {
                    const listEl = document.getElementById('all-users-modal-list');
                    if (!listEl) return;
                    listEl.innerHTML = '';
                    const users = [];
                    querySnapshot.forEach(doc => users.push({ id: doc.id, ...doc.data() }));
                    
                    // é¡¯ç¤ºè¨­å®šéæ¿¾
                    let visibleUsers = {};
                    try {
                        const savedSettings = localStorage.getItem('app_general_settings');
                        if (savedSettings) {
                            const settings = JSON.parse(savedSettings);
                            visibleUsers = settings.visibleUsers || {};
                        }
                    } catch (e) {
                        console.warn('Could not load user visibility settings:', e);
                    }
                    const visibleUsersList = users.filter(user => visibleUsers[user.id] !== false);
                    
                    // é€²ä¸€æ­¥éæ¿¾ï¼šåƒ…é¡¯ç¤ºæœå‹™ã€Œç›®å‰ç¤¾å€ã€çš„å¤–å‹¤ç›¸é—œè§’è‰²ï¼ˆç¸½å¹¹äº‹ã€ç§˜æ›¸ã€ä¿å…¨ã€æ¸…æ½”ã€æ©Ÿé›»ï¼‰
                    const currentCommId = state.currentCommunity?.id || null;
                    const currentCommCode = state.currentCommunity?.code || null;
                    const filteredByRoleAndCommunity = visibleUsersList.filter(u => {
                        if (!isFieldLikeRole(u.role)) return false;
                        const ids = Array.isArray(u.serviceCommunities) ? u.serviceCommunities : [];
                        const codesArr = Array.isArray(u.serviceCommunityCodes) ? u.serviceCommunityCodes : [];
                        const codeSingle = u.serviceCommunityCode || null;
                        const matchById = currentCommId ? ids.includes(currentCommId) : false;
                        const matchByCode = currentCommCode ? (codesArr.includes(currentCommCode) || codeSingle === currentCommCode) : false;
                        return matchById || matchByCode;
                    });
                    
                    // æ’åºï¼šè‡ªè¨‚ç‹€æ…‹å„ªå…ˆç´š + æœ€è¿‘æ›´æ–°æ™‚é–“ï¼ˆæ–°è‡³èˆŠï¼‰ + å§“å
                    const statusPriority = (user) => {
                        const locationText = user.clockInStatus === 'å¤–å‡º' && user.outboundLocation ? user.outboundLocation : (user.lastLocation?.address || null);
                        const display = getStatusDisplayText(user.clockInStatus || 'æœªæ‰“å¡', locationText, user.dutyType);
                        let isLeave = (user.clockInStatus === 'è‡¨æ™‚è«‹å‡') || (display.includes('è«‹å‡'));
                        if (!isLeave) {
                            const leave = user.leaveStatus || '';
                            if (leave === 'approved' || leave === 'pending') {
                                const now = new Date();
                                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                                const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                                if (user.leaveStartTime && user.leaveEndTime) {
                                    const leaveStart = user.leaveStartTime.toDate ? user.leaveStartTime.toDate() : new Date(user.leaveStartTime);
                                    const leaveEnd = user.leaveEndTime.toDate ? user.leaveEndTime.toDate() : new Date(user.leaveEndTime);
                                    isLeave = leaveStart <= todayEnd && leaveEnd >= todayStart;
                                }
                            }
                        }

                        if (display.includes('ä¸Šç­') && (display.includes('è¾¦å…¬å®¤') || display.includes('åœ¨è¾¦å…¬å®¤'))) return 1;
                        if (display.includes('è¿”å›') && (display.includes('è¾¦å…¬å®¤') || display.includes('åœ¨è¾¦å…¬å®¤'))) return 2;
                        if (display.startsWith('å¤–å‡º-')) return 3;
                        if (display.startsWith('æŠµé”-')) return 4;
                        if (display.startsWith('é›¢é–‹-')) return 5;
                        if (isLeave) return 6;
                        if (display.includes('ä¸‹ç­')) return 7;
                        return 8;
                    };

                    (async () => {
                        const latestMap = {};
                        try {
                            await Promise.all(filteredByRoleAndCommunity.map(async (u) => {
                                try {
                                    const qLatest = query(collection(db, 'clockInRecords'), where('userId', '==', u.id), orderBy('timestamp', 'desc'), limit(1));
                                    const latestSnap = await getDocs(qLatest);
                                    if (!latestSnap.empty) {
                                        // å„²å­˜æ•´ç­†æœ€æ–°ç´€éŒ„è³‡æ–™ä»¥ä¾¿å–å¾— type/locationName/dutyType/timestamp
                                        latestMap[u.id] = latestSnap.docs[0].data();
                                    } else {
                                        latestMap[u.id] = null;
                                    }
                                } catch (e) {
                                    console.warn('è¼‰å…¥ä½¿ç”¨è€…æœ€æ–°æ‰“å¡å¤±æ•—:', e);
                                    latestMap[u.id] = null;
                                }
                            }));
                        } catch (e) {
                            console.warn('å»ºç«‹æœ€æ–°æ‰“å¡æ™‚é–“å°æ‡‰è¡¨å¤±æ•—:', e);
                        }

                    // ç‹€æ…‹éæ¿¾ï¼šåƒ…ä¿ç•™ä¸Šç­ã€ä¸‹ç­ã€è«‹å‡ï¼ˆæ’é™¤å¤–å‡º/æŠµé”/é›¢é–‹ï¼‰
                    const filteredByStatus = filteredByRoleAndCommunity.filter(u => {
                        const latest = latestMap[u.id] || null;
                        const locText = latest?.locationName || (u.clockInStatus === 'å¤–å‡º' && u.outboundLocation ? u.outboundLocation : (u.lastLocation?.address || null));
                        const display = latest ? getStatusDisplayText(latest.type || 'æœªçŸ¥', latest.locationName || null, latest.dutyType || null)
                                              : getStatusDisplayText(u.clockInStatus || 'æœªæ‰“å¡', locText, u.dutyType);
                        // è«‹å‡åˆ¤å®š
                        let isLeave = (u.clockInStatus === 'è‡¨æ™‚è«‹å‡') || display.includes('è«‹å‡');
                        if (!isLeave) {
                            const leave = u.leaveStatus || '';
                            if (leave === 'approved' || leave === 'pending') {
                                const now = new Date();
                                const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                                const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                                if (u.leaveStartTime && u.leaveEndTime) {
                                    const leaveStart = u.leaveStartTime.toDate ? u.leaveStartTime.toDate() : new Date(u.leaveStartTime);
                                    const leaveEnd = u.leaveEndTime.toDate ? u.leaveEndTime.toDate() : new Date(u.leaveEndTime);
                                    isLeave = leaveStart <= todayEnd && leaveEnd >= todayStart;
                                }
                            }
                        }
                        if (isLeave) return true;
                        if (display.includes('ä¸‹ç­') || (u.clockInStatus === 'ä¸‹ç­')) return true;
                        if (display.includes('ä¸Šç­') || (u.clockInStatus === 'è¿”å›')) return true;
                        return false;
                    });

                    filteredByStatus.sort((a, b) => {
                            const latestA = latestMap[a.id] || null;
                            const latestB = latestMap[b.id] || null;
                            const locA = latestA?.locationName || (a.clockInStatus === 'å¤–å‡º' && a.outboundLocation ? a.outboundLocation : (a.lastLocation?.address || null));
                            const locB = latestB?.locationName || (b.clockInStatus === 'å¤–å‡º' && b.outboundLocation ? b.outboundLocation : (b.lastLocation?.address || null));
                            const displayA = latestA ? getStatusDisplayText(latestA.type || 'æœªçŸ¥', latestA.locationName || null, latestA.dutyType || null)
                                                     : getStatusDisplayText(a.clockInStatus || 'æœªæ‰“å¡', locA, a.dutyType);
                            const displayB = latestB ? getStatusDisplayText(latestB.type || 'æœªçŸ¥', latestB.locationName || null, latestB.dutyType || null)
                                                     : getStatusDisplayText(b.clockInStatus || 'æœªæ‰“å¡', locB, b.dutyType);

                            // åˆ¤æ–·è«‹å‡ï¼ˆè‡¨æ™‚è«‹å‡æˆ–ç•¶å¤©æœ‰æ•ˆç”³è«‹ï¼‰
                            let isLeaveA = (a.clockInStatus === 'è‡¨æ™‚è«‹å‡') || (displayA.includes('è«‹å‡'));
                            if (!isLeaveA) {
                                const leaveA = a.leaveStatus || '';
                                if (leaveA === 'approved' || leaveA === 'pending') {
                                    const now = new Date();
                                    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                                    const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                                    if (a.leaveStartTime && a.leaveEndTime) {
                                        const leaveStartA = a.leaveStartTime.toDate ? a.leaveStartTime.toDate() : new Date(a.leaveStartTime);
                                        const leaveEndA = a.leaveEndTime.toDate ? a.leaveEndTime.toDate() : new Date(a.leaveEndTime);
                                        isLeaveA = leaveStartA <= todayEnd && leaveEndA >= todayStart;
                                    }
                                }
                            }
                            let isLeaveB = (b.clockInStatus === 'è‡¨æ™‚è«‹å‡') || (displayB.includes('è«‹å‡'));
                            if (!isLeaveB) {
                                const leaveB = b.leaveStatus || '';
                                if (leaveB === 'approved' || leaveB === 'pending') {
                                    const now = new Date();
                                    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                                    const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                                    if (b.leaveStartTime && b.leaveEndTime) {
                                        const leaveStartB = b.leaveStartTime.toDate ? b.leaveStartTime.toDate() : new Date(b.leaveStartTime);
                                        const leaveEndB = b.leaveEndTime.toDate ? b.leaveEndTime.toDate() : new Date(b.leaveEndTime);
                                        isLeaveB = leaveStartB <= todayEnd && leaveEndB >= todayStart;
                                    }
                                }
                            }

                            const prioOf = (display, isLeave) => {
                                if (display.includes('ä¸Šç­') && (display.includes('è¾¦å…¬å®¤') || display.includes('åœ¨è¾¦å…¬å®¤'))) return 1;
                                if (display.includes('è¿”å›') && (display.includes('è¾¦å…¬å®¤') || display.includes('åœ¨è¾¦å…¬å®¤'))) return 2;
                                if (display.startsWith('å¤–å‡º-')) return 3;
                                if (display.startsWith('æŠµé”-')) return 4;
                                if (display.startsWith('é›¢é–‹-')) return 5;
                                if (isLeave) return 6;
                                if (display.includes('ä¸‹ç­')) return 7;
                                return 8;
                            };

                            const prA = prioOf(displayA, isLeaveA);
                            const prB = prioOf(displayB, isLeaveB);
                            if (prA !== prB) return prA - prB;

                            const tA = latestA?.timestamp?.toDate?.() ? latestA.timestamp.toDate()
                                      : (a.lastUpdated ? (a.lastUpdated.toDate ? a.lastUpdated.toDate() : new Date(a.lastUpdated)) : new Date(0));
                            const tB = latestB?.timestamp?.toDate?.() ? latestB.timestamp.toDate()
                                      : (b.lastUpdated ? (b.lastUpdated.toDate ? b.lastUpdated.toDate() : new Date(b.lastUpdated)) : new Date(0));
                            if (tA.getTime() !== tB.getTime()) return tB - tA;
                            return a.name.localeCompare(b.name, 'zh-Hant');
                        }).forEach(user => {
                            const latest = latestMap[user.id] || null;
                            const locText = latest?.locationName || (user.clockInStatus === 'å¤–å‡º' && user.outboundLocation ? user.outboundLocation : (user.lastLocation?.address || null));
                            const statusText = latest ? getStatusDisplayText(latest.type || 'æœªçŸ¥', latest.locationName || null, latest.dutyType || null)
                                                      : getStatusDisplayText(user.clockInStatus || 'æœªæ‰“å¡', locText, user.dutyType);
                            const statusColor = getStatusColor(statusText);
                            const clockInTime = latest?.timestamp?.toDate?.() ? latest.timestamp.toDate() : (latest?.timestamp ? new Date(latest.timestamp) : null);
                            const timeFormatted = clockInTime ? clockInTime.toLocaleString('zh-TW', {year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false}) : 'N/A';
                            listEl.innerHTML += `
                                <div class=\"flex items-center justify-between bg-white p-3 rounded-md shadow-sm border\">
                                    <div class=\"flex items-center\">
                                        <img src=\"${user.avatarUrl || `https://placehold.co/32x32/EFEFEF/333333?text=${user.name?.charAt(0) || 'U'}`}\" class=\"w-8 h-8 rounded-full mr-3 object-cover\">
                                        <div>
                                            <span class=\"font-medium text-gray-700\">${user.name || user.displayName || 'æœªå‘½å'}</span>
                                            <div class=\"flex items-center mt-1\">
                                                <span class=\"text-sm font-semibold ${statusColor} mr-2\">${statusText}</span>
                                                <span class=\"text-xs text-gray-500\" id=\"clock-time-${user.id}\">${timeFormatted}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class=\"flex space-x-2\">
                                        ${user.lastPhotoUrl ? `<button class=\"view-photo-btn p-2 bg-blue-100 rounded-md\" data-photo=\"${user.lastPhotoUrl}\" data-desc=\"${user.lastLocation || ''}\"><i data-lucide=\"image\" class=\"w-6 h-6 text-blue-600\"></i></button>` : ''}
                                    </div>
                                    
                                </div>`;
                        });
                        // é‡æ–°ä»¥æœ€æ–° clockInRecords æ›´æ–°æ¯ä½ä½¿ç”¨è€…çš„æ™‚é–“ï¼ˆé¿å…å¿«ç…§æ™‚åºä¸åŒæ­¥ï¼‰
                        try {
                            Promise.all(filteredByStatus.map(async (u) => {
                                try {
                                    const qLatest = query(collection(db, 'clockInRecords'), where('userId', '==', u.id), orderBy('timestamp', 'desc'), limit(1));
                                    const latestSnap = await getDocs(qLatest);
                                    let dt = null;
                                    if (!latestSnap.empty) {
                                        const rec = latestSnap.docs[0].data();
                                        const ts = rec.timestamp;
                                        dt = ts?.toDate?.() ? ts.toDate() : (ts ? new Date(ts) : null);
                                    }
                                    const el = document.querySelector(`#clock-time-${u.id}`);
                                    if (el) {
                                        el.textContent = dt ? dt.toLocaleString('zh-TW', {year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false}) : 'N/A';
                                    }
                                } catch (e) {
                                    console.warn('è¼‰å…¥ä½¿ç”¨è€…æœ€æ–°æ‰“å¡å¤±æ•—:', e);
                                }
                            }));
                        } catch (e) {
                            console.warn('æ›´æ–°æœ€æ–°æ‰“å¡æ™‚é–“æ™‚ç™¼ç”ŸéŒ¯èª¤:', e);
                        }
                    })();
                    try { lucide.createIcons(); } catch (e) {}
                    // ç¶å®šç…§ç‰‡èˆ‡åœ°åœ–æŒ‰éˆ•
                    document.querySelectorAll('#all-users-modal .view-photo-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const photoUrl = e.currentTarget.dataset.photo;
                            const description = e.currentTarget.dataset.desc;
                            if(photoUrl) openPhotoModal([photoUrl], [description]);
                            else showToast('ç„¡ç…§ç‰‡å¯é¡¯ç¤º', true);
                        });
                    });
                    
                });
                
                function closeModal() {
                    try { unsub(); } catch {}
                    const m = document.getElementById('all-users-modal');
                    const b = document.getElementById('all-users-modal-backdrop');
                    if (m) document.body.removeChild(m);
                    if (b) document.body.removeChild(b);
                }
                document.getElementById('close-all-users-modal').addEventListener('click', closeModal);
                backdrop.addEventListener('click', closeModal);
            }

            function renderClockIn(subPage) {
                const role = state.currentUserData?.role || '';
                const isStaff = new Set(['ç¸½å¹¹äº‹','ç§˜æ›¸','ä¿å…¨','æ¸…æ½”','æ©Ÿé›»']).has(role);
                const tabs = isStaff
                    ? [
                        { key: 'workdays', label: 'æˆ‘çš„ç­è¡¨' },
                        { key: 'records', label: 'æ‰“å¡ç´€éŒ„' },
                        { key: 'leaves', label: 'è«‹å‡ç”³è«‹' }
                      ]
                    : [
                        { key: 'workdays', label: 'æˆ‘çš„ç­è¡¨' },
                        { key: 'records', label: 'æ‰“å¡ç´€éŒ„' },
                        { key: 'leaves', label: 'è«‹å‡ç”³è«‹' }
                      ];

                const tabsHtml = tabs.map(t => `
                    <button data-subtab="${t.key}" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${(subPage === t.key || (!subPage && t.key === 'workdays')) ? 'active' : ''}">${t.label}</button>
                `).join('');

                mainContent.innerHTML = `
                    <div class="h-[50px] flex items-center justify-around border-b border-gray-200 bg-white">
                        ${tabsHtml}
                    </div>
                    <div id="sub-page-content" class="overflow-y-auto" style="height: calc(100% - 50px);"></div>`;

                const subPageContent = document.getElementById('sub-page-content');
                if (subPage === 'records') {
                    renderClockInRecords(subPageContent);
                } else if (subPage === 'retro') {
                    renderRetroClockRequestForm(subPageContent);
                } else if (subPage === 'leaves') {
                    renderMyLeaveRecords(subPageContent);
                } else {
                    // åªè®€çš„æˆ‘çš„ç­è¡¨ï¼ˆæœˆè¦–åœ–ï¼‰
                    renderWorkDatesMonthView(subPageContent);
                    try { updateMyScheduleButtons(); } catch (e) { console.warn('updateMyScheduleButtons åˆå§‹åŒ–å¤±æ•—', e); }
                }

                mainContent.querySelectorAll('.sub-tab-btn').forEach(btn => btn.addEventListener('click', () => showPage('clock-in', btn.dataset.subtab)));
            }

            function renderClockInLocation(container) {
                container.innerHTML = `
                    <div class="p-4 h-full flex flex-col">
                        <button id="relocate-btn" class="w-full bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-md hover:bg-gray-50 flex items-center justify-center mb-4">
                            <i data-lucide="locate-fixed" class="w-4 h-4 mr-2"></i>é‡æ–°å®šä½
                        </button>
                        <div id="map-container" class="flex-grow rounded-lg overflow-hidden border border-gray-300 relative">
                             <div id="map" class="map-canvas"></div>
                             <div id="map-loader" class="absolute inset-0 bg-white/70 flex items-center justify-center pointer-events-none"><div class="loader"></div></div>
                        </div>
                        <div id="status-display" class="mt-3 text-center font-semibold text-lg text-gray-700">
                            <span id="status-text">å°šæœªæ‰“å¡</span>
                        </div>
                        <div id="clock-in-buttons" class="grid grid-cols-2 gap-2 pt-4">
                            <!-- åƒ…ä¿ç•™å…©å€‹æŒ‰éˆ•ï¼šä¸Šç­ã€ä¸‹ç­ï¼›è«‹å‡ç”³è«‹å·²ç§»è‡³å­åˆ†é  -->
                            <button id="work-start-btn" data-type="ä¸Šç­" class="clock-in-btn bg-green-500 text-white font-semibold py-3 px-4 rounded-md hover:bg-green-600">ä¸Šç­æ‰“å¡</button>
                            <button id="work-end-btn" data-type="ä¸‹ç­" class="clock-in-btn bg-red-500 text-white font-semibold py-3 px-4 rounded-md hover:bg-red-600">ä¸‹ç­æ‰“å¡</button>
                        </div>
                    </div>`;
                lucide.createIcons();
                initClockInMap();

                document.getElementById('relocate-btn').addEventListener('click', initClockInMap);
                
                // åˆå§‹åŒ–æ‰“å¡ç‹€æ…‹ï¼ˆåœ¨å®šä½æ‰“å¡å­é æ¸²æŸ“å®Œæˆå¾Œï¼‰
                initClockInButtonStatus();
                updateStatusDisplay();
                
                // æ‰“å¡æŒ‰éˆ•é»æ“Šäº‹ä»¶
                document.querySelectorAll('.clock-in-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        if (btn.classList.contains('disabled')) {
                            return;
                        }
                        
                        if (!state.currentLocation) {
                            alert("ç„¡æ³•å–å¾—ç›®å‰ä½ç½®ï¼Œè«‹ç¨å¾Œå†è©¦");
                            return;
                        }
                        
                        const type = e.target.dataset.type;
                        
                        // å¤–å‡ºæ‰“å¡éœ€è¦å…ˆè¼¸å…¥åœ°é»
                        if (type === "å¤–å‡º") {
                            // ç›´æ¥æ‰“é–‹åœ°é»è¼¸å…¥å½ˆçª—
                            const backdrop = document.createElement('div');
                            backdrop.id = 'modal-backdrop';
                            backdrop.className = 'fixed inset-0 bg-black bg-opacity-50 z-40';
                            backdrop.addEventListener('click', () => {
                                document.body.removeChild(backdrop);
                                document.body.removeChild(modal);
                            });
                            
                            // å‰µå»ºå½ˆçª—
                            const modal = document.createElement('div');
                            modal.id = 'location-input-modal';
                            modal.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg p-6 z-50 w-80';
                            
                            // å‰µå»ºæ¨™é¡Œ
                            const title = document.createElement('h3');
                            title.className = 'text-lg font-semibold mb-4';
                            title.textContent = 'è«‹é¸æ“‡å‹¤å‹™é …ç›®ä¸¦è¼¸å…¥å¤–å‡ºåœ°é»';

                            // å‹¤å‹™é …ç›®é¸å–®
                            const dutyContainer = document.createElement('div');
                            dutyContainer.className = 'mb-4';
                            const dutyLabel = document.createElement('label');
                            dutyLabel.className = 'block text-sm font-medium text-gray-700 mb-1';
                            dutyLabel.textContent = 'å‹¤å‹™é …ç›®';
                            const dutySelect = document.createElement('select');
                            dutySelect.id = 'outbound-duty-type';
                            dutySelect.className = 'w-full border border-gray-300 rounded-md p-2';
                            ['ä¾‹è¡Œç£å¯Ÿ','ä¾‹æœƒ','å€å¤§','è‡¨æ™‚æœƒ','ç°¡å ±','å…¶ä»–'].forEach(opt => {
                                const o = document.createElement('option');
                                o.value = opt;
                                o.textContent = opt;
                                dutySelect.appendChild(o);
                            });
                            dutyContainer.appendChild(dutyLabel);
                            dutyContainer.appendChild(dutySelect);

                            // å…¶ä»–å‹¤å‹™é …ç›®è¼¸å…¥æ¡†ï¼ˆé è¨­éš±è—ï¼‰
                            const otherDutyContainer = document.createElement('div');
                            otherDutyContainer.id = 'outbound-other-duty-container';
                            otherDutyContainer.className = 'mb-4 hidden';
                            const otherDutyLabel = document.createElement('label');
                            otherDutyLabel.className = 'block text-sm font-medium text-gray-700 mb-1';
                            otherDutyLabel.textContent = 'å…¶ä»–å‹¤å‹™é …ç›®';
                            const otherDutyInput = document.createElement('input');
                            otherDutyInput.id = 'outbound-other-duty';
                            otherDutyInput.type = 'text';
                            otherDutyInput.className = 'w-full border border-gray-300 rounded-md p-2';
                            otherDutyInput.placeholder = 'è«‹è¼¸å…¥å‹¤å‹™é …ç›®';
                            otherDutyContainer.appendChild(otherDutyLabel);
                            otherDutyContainer.appendChild(otherDutyInput);
                            
                            // å‰µå»ºè¼¸å…¥æ¡†
                            const input = document.createElement('input');
                            input.id = 'outbound-location';
                            input.type = 'text';
                            input.className = 'w-full border border-gray-300 rounded-md p-2 mb-4';
                            input.placeholder = 'ä¾‹å¦‚ï¼šå®¢æˆ¶å…¬å¸ã€é†«é™¢ç­‰';
                            
                            // å‰µå»ºæŒ‰éˆ•å®¹å™¨
                            const buttonContainer = document.createElement('div');
                            buttonContainer.className = 'flex justify-end space-x-2';
                            
                            // å‹¤å‹™é …ç›®åˆ‡æ›äº‹ä»¶ï¼ˆé¡¯ç¤º/éš±è—å…¶ä»–è¼¸å…¥æ¡†ï¼‰
                            dutySelect && dutySelect.addEventListener('change', () => {
                                if (dutySelect.value === 'å…¶ä»–') {
                                    otherDutyContainer.classList.remove('hidden');
                                } else {
                                    otherDutyContainer.classList.add('hidden');
                                }
                            });
                            // å‰µå»ºå–æ¶ˆæŒ‰éˆ•
                            const cancelButton = document.createElement('button');
                            cancelButton.className = 'px-4 py-2 bg-gray-200 text-gray-800 rounded-md';
                            cancelButton.textContent = 'å–æ¶ˆ';
                            cancelButton.addEventListener('click', () => {
                                document.body.removeChild(backdrop);
                                document.body.removeChild(modal);
                            });
                            
                            // å‰µå»ºç¢ºèªæŒ‰éˆ•
                            const confirmButton = document.createElement('button');
                            confirmButton.className = 'px-4 py-2 bg-blue-500 text-white rounded-md';
                            confirmButton.textContent = 'ç¢ºèª';
                            confirmButton.addEventListener('click', () => {
                                const dutyTypeEl = document.getElementById('outbound-duty-type');
                                const dutyType = dutyTypeEl ? dutyTypeEl.value : '';
                                let dutyName = dutyType;
                                if (dutyType === 'å…¶ä»–') {
                                    const otherDuty = document.getElementById('outbound-other-duty').value.trim();
                                    if (!otherDuty) {
                                        alert('è«‹è¼¸å…¥å‹¤å‹™é …ç›®');
                                        return;
                                    }
                                    dutyName = otherDuty;
                                }
                                const locationText = document.getElementById('outbound-location').value.trim();
                                if (locationText) {
                                    state.outboundLocation = locationText;
                                    state.dutyType = dutyName;
                                    // ä¿å­˜åœ°é»åˆ°è¨­å®šçš„ savedLocationsï¼ˆæœ€å¤š10ç­†ï¼‰
                                    try {
                                        if (!state.savedLocations) {
                                            state.savedLocations = [];
                                        }
                                        const exists = state.savedLocations.some(loc => loc === locationText);
                                        if (!exists) {
                                            state.savedLocations.push(locationText);
                                            if (state.savedLocations.length > 10) {
                                                state.savedLocations.shift();
                                            }
                                            // åƒ…ç®¡ç†å“¡å¯å¯«å…¥ Firestoreï¼›ä¸€èˆ¬ä½¿ç”¨è€…æ”¹å­˜ localStorage
                                            const isAdmin = state.currentUserData && state.currentUserData.role === 'admin';
                                            const user = window.__auth?.currentUser;
                                            if (isAdmin && user) {
                                                const { updateDoc, doc } = window.__fs; const db = window.__db;
                                                updateDoc(doc(db, 'users', user.uid), { savedLocations: state.savedLocations })
                                                    .catch(err => console.warn('ä¿å­˜åœ°å€åˆ°è¨­å®šå¤±æ•—', err));
                                            } else {
                                                try {
                                                    const key = `saved_locations_${window.__auth?.currentUser?.uid || 'guest'}`;
                                                    localStorage.setItem(key, JSON.stringify(state.savedLocations));
                                                } catch (e) { console.warn('ä¿å­˜åœ°å€åˆ°æœ¬æ©Ÿå¤±æ•—', e); }
                                            }
                                        }
                                    } catch (e) {
                                        console.warn('è™•ç† savedLocations å¤±æ•—', e);
                                    }
                                    // ä¿å­˜å¤–å‡ºåœ°é»åˆ°ç³»çµ±ä½ç½®è¨­å®šï¼ˆotherLocationsï¼‰ï¼Œåƒ…ç®¡ç†å“¡å…·æœ‰å¯«å…¥æ¬Šé™
                                    try {
                                        const isAdmin = state.currentUserData && state.currentUserData.role === 'admin';
                                        const user = window.__auth?.currentUser; const db = window.__db; const { doc, getDoc, setDoc, arrayUnion, serverTimestamp } = window.__fs;
                                        if (isAdmin && user) {
                                            const settingsRef = doc(db, 'settings', 'location');
                                            // æ§‹å»ºä½ç½®ç‰©ä»¶
                                            const locEntry = {
                                                name: locationText,
                                                lat: (state.currentLocation && typeof state.currentLocation.lat === 'number') ? state.currentLocation.lat : null,
                                                lng: (state.currentLocation && typeof state.currentLocation.lng === 'number') ? state.currentLocation.lng : null,
                                                radius: 100
                                            };
                                            // å…ˆè®€å–ï¼Œé¿å…é‡è¤‡åç¨±
                                            getDoc(settingsRef).then(docSnap => {
                                                const settings = docSnap.exists() ? docSnap.data() : {};
                                                const otherLocations = Array.isArray(settings.otherLocations) ? settings.otherLocations : [];
                                                const nameExists = otherLocations.some(l => (l && l.name) === locationText);
                                                if (!nameExists) {
                                                    setDoc(settingsRef, {
                                                        otherLocations: arrayUnion(locEntry),
                                                        updatedAt: serverTimestamp()
                                                    }, { merge: true }).catch(err => console.warn('ä¿å­˜å…¶ä»–ä½ç½®å¤±æ•—', err));
                                                }
                                            }).catch(err => console.warn('è®€å–ä½ç½®è¨­å®šå¤±æ•—', err));
                                        }
                                    } catch (e) {
                                        console.warn('è™•ç† otherLocations å¤±æ•—', e);
                                    }
                                    document.body.removeChild(backdrop);
                                    document.body.removeChild(modal);
                                    // æ‰“é–‹ç›¸æ©Ÿï¼Œå‚³éç•¶å‰ä½ç½®å’Œå¤–å‡ºåœ°é»åç¨±ï¼›è‹¥å®šä½å¤±æ•—å‰‡ä½¿ç”¨å¾Œå‚™åº§æ¨™
                                    if (state.currentLocation && typeof state.currentLocation.lat === 'number' && typeof state.currentLocation.lng === 'number') {
                                        openCameraModal(type, { ...state.currentLocation, name: locationText });
                                    } else {
                                        showToast('å®šä½é€¾æ™‚ï¼Œå°‡ä»¥æœªçŸ¥ä½ç½®ç¹¼çºŒæ‰“å¡ï¼ˆç¨å¾Œå¯åŒæ­¥ï¼‰');
                                        openCameraModal(type, { lat: 0, lng: 0, name: locationText, isFallback: true });
                                    }
                                } else {
                                    alert('è«‹è¼¸å…¥å¤–å‡ºåœ°é»');
                                }
                            });
                            
                            // çµ„è£å½ˆçª—
                            buttonContainer.appendChild(cancelButton);
                            buttonContainer.appendChild(confirmButton);
                            modal.appendChild(title);
                            // æ’å…¥å‹¤å‹™é …ç›®é¸å–®èˆ‡å…¶ä»–è¼¸å…¥
                            modal.appendChild(dutyContainer);
                            modal.appendChild(otherDutyContainer);
                            modal.appendChild(input);
                            modal.appendChild(buttonContainer);
                            
                            // æ·»åŠ åˆ°é é¢
                            document.body.appendChild(backdrop);
                            document.body.appendChild(modal);
                        } else if (type === "æŠµé”" || type === "é›¢é–‹" || type === "è¿”å›") {
                            // æŠµé”ã€é›¢é–‹ã€è¿”å›æ‰“å¡ä¹Ÿéœ€è¦æ‹ç…§
                            openCameraModal(type, state.currentLocation);
                        } else if (type === "è‡¨æ™‚è«‹å‡") {
                            // ä¸åŸ·è¡Œç›¸æ©Ÿæ“ä½œ
                        } else {
                            openCameraModal(type, state.currentLocation);
                        }
                    });
                });
                
                // è‡¨æ™‚è«‹å‡æŒ‰éˆ•ç§»è‡³ã€Œè«‹å‡ç”³è«‹ã€å­åˆ†é ï¼›ä¿ç•™å®‰å…¨æª¢æŸ¥é¿å…å…ƒç´ ä¸å­˜åœ¨å ±éŒ¯
                const tempLeaveBtnEl = document.getElementById('temp-leave-btn');
                if (tempLeaveBtnEl) {
                    tempLeaveBtnEl.addEventListener('click', () => {
                        openTempLeaveModal();
                    });
                }
                
                // å·²ç§»é™¤ç‰¹æ®Šå‹¤å‹™æŒ‰éˆ•
            }

            // æˆ‘çš„ç­è¡¨å­åˆ†é ï¼šåƒ…é¡¯ç¤ºã€Œç•¶å‰ç¤¾å€ã€ä¸­å±¬æ–¼è‡ªå·±çš„æ’ç­ï¼ˆåªè®€ï¼‰ï¼Œä¸Šæ–¹æœˆæ›†ã€é è¨­ç•¶æ—¥ã€ä¸‹æ–¹é¡¯ç¤ºæ™‚é–“èˆ‡å“¨é»
            function renderWorkDatesMonthView(container) {
                const comm = state.currentCommunity;
                if (!comm || !comm.id) {
                    container.innerHTML = `
                        <div class="p-8 flex items-center justify-center h-full">
                            <div class="text-center text-gray-500">
                                <i data-lucide="home" class="w-8 h-8 mx-auto mb-3"></i>
                                <div>è«‹å…ˆé¸æ“‡ç¤¾å€å¾Œå†æŸ¥çœ‹æˆ‘çš„ç­è¡¨</div>
                            </div>
                        </div>`;
                    try { lucide.createIcons(); } catch (_) {}
                    return;
                }
                const communityId = comm.id;

                const db = window.__db; const { collection, getDocs } = window.__fs || {};
                const userId = window.__auth?.currentUser?.uid || '';

                const pageState = {
                    monthDate: new Date(new Date().getFullYear(), new Date().getMonth(), 1),
                    selectedDayIso: null,
                    daysMap: {}, // { iso: [{ start, end, postName }] }
                    postNameMap: {},
                    // æœ¬æœˆå„æ—¥æ‰“å¡ç´€éŒ„ï¼ˆä¾›æœˆæ›†åº•è‰²åˆ¤æ–·ï¼‰
                    recordsByDay: {}
                };

                const fmtYMD = (d) => {
                    const y = d.getFullYear();
                    const m = (d.getMonth()+1).toString().padStart(2,'0');
                    const day = d.getDate().toString().padStart(2,'0');
                    return `${y}-${m}-${day}`;
                };
                const parseHM = (s) => {
                    const [h,m] = (s||'00:00').split(':').map(x=>parseInt(x,10)||0);
                    return h*60+m;
                };
                const mergeIntervalsMinutes = (list) => {
                    if (!Array.isArray(list) || !list.length) return [];
                    const intervals = list.map(it => ({start: parseHM(it.start||'00:00'), end: parseHM(it.end||'00:00')}))
                        .filter(it => it.end>it.start)
                        .sort((a,b)=>a.start-b.start);
                    const merged = [];
                    for (const iv of intervals) {
                        if (!merged.length || iv.start > merged[merged.length-1].end) {
                            merged.push({start: iv.start, end: iv.end});
                        } else {
                            merged[merged.length-1].end = Math.max(merged[merged.length-1].end, iv.end);
                        }
                    }
                    return merged;
                };
                const coverageMinutes = (list) => mergeIntervalsMinutes(list).reduce((acc,iv)=>acc+(iv.end-iv.start),0);

                const renderShell = () => {
                    container.innerHTML = `
                        <div class="p-3">
                            <div class="flex items-center justify-between mb-2">
                                <button id="my-prev-month" class="px-3 py-1 rounded border bg-white text-gray-700 hover:bg-gray-50">ä¸Šå€‹æœˆ</button>
                                <div id="my-current-month-year" class="text-lg font-semibold"></div>
                                <button id="my-next-month" class="px-3 py-1 rounded border bg-white text-gray-700 hover:bg-gray-50">ä¸‹å€‹æœˆ</button>
                            </div>
                            <div class="grid grid-cols-7 text-center text-xs text-gray-500 mb-1">
                                <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
                            </div>
                            <div id="myshift-calendar-grid" class="grid grid-cols-7 gap-1"></div>
                            <hr class="border-t border-gray-200 my-3" />
                            <div id="myshift-day-panel" class="mt-2"></div>
                        </div>`;
                    try { lucide.createIcons(); } catch (_) {}
                };

                const renderMonthHeader = () => {
                    const title = document.getElementById('my-current-month-year');
                    if (!title) return;
                    const d = pageState.monthDate;
                    title.textContent = `${d.getFullYear()} å¹´ ${d.getMonth()+1} æœˆ`;
                    const prev = document.getElementById('my-prev-month');
                    const next = document.getElementById('my-next-month');
                    if (prev) prev.onclick = async ()=>{
                        pageState.monthDate = new Date(pageState.monthDate.getFullYear(), pageState.monthDate.getMonth()-1, 1);
                        await loadMonth();
                        renderMonthHeader();
                        renderCalendar();
                        renderDayPanel();
                    };
                    if (next) next.onclick = async ()=>{
                        pageState.monthDate = new Date(pageState.monthDate.getFullYear(), pageState.monthDate.getMonth()+1, 1);
                        await loadMonth();
                        renderMonthHeader();
                        renderCalendar();
                        renderDayPanel();
                    };
                };

                const loadPosts = async () => {
                    pageState.postNameMap = {};
                    try {
                        const postsSnap = await getDocs(collection(db, 'communities', communityId, 'posts'));
                        postsSnap.forEach(d => { const data = d.data() || {}; pageState.postNameMap[d.id] = data.name || 'æœªå‘½åå“¨é»'; });
                    } catch (e) { console.warn('è¼‰å…¥å“¨é»åç¨±å¤±æ•—', e); }
                };

                const loadMonth = async () => {
                    pageState.daysMap = {};
                    try {
                        const y = pageState.monthDate.getFullYear();
                        const m = pageState.monthDate.getMonth()+1; const ymStr = `${y}-${m.toString().padStart(2,'0')}-`;
                        const schedSnap = await getDocs(collection(db, 'communities', communityId, 'postSchedules'));
                        schedSnap.forEach(d => {
                            const data = d.data() || {};
                            const iso = (data.dateIso || '').toString();
                            if (!iso.startsWith(ymStr)) return;
                            const shifts = Array.isArray(data.shifts) ? data.shifts : [];
                            const my = shifts.filter(s => Array.isArray(s.assignees) && s.assignees.includes(userId));
                            if (my.length) {
                                pageState.daysMap[iso] = my.map(s => ({ start: s.start || '', end: s.end || '', endDateIso: s.endDateIso || null, postName: pageState.postNameMap[data.postId] || 'æœªå‘½åå“¨é»' }));
                            }
                        });
                    } catch (e) { console.warn('è®€å–å€‹äººæ’ç­å¤±æ•—', e); }
                    // è®€å–æœ¬æœˆæ‰“å¡ç´€éŒ„ï¼ˆåƒ…æœ¬äººï¼‰ï¼Œä¾›æœˆæ›†åº•è‰²åˆ¤æ–·
                    try {
                        pageState.recordsByDay = {};
                        const fs = window.__fs || {};
                        const { collection: c2, getDocs: g2, query: q2, where: w2 } = fs;
                        if (c2 && g2 && q2 && w2) {
                            const snap = await g2(q2(c2(window.__db, 'clockInRecords'), w2('userId','==', userId)));
                            const y2 = pageState.monthDate.getFullYear();
                            const m0 = pageState.monthDate.getMonth();
                            const start = new Date(y2, m0, 1, 0,0,0,0);
                            const end = new Date(y2, m0+1, 0, 23,59,59,999);
                            snap.docs.forEach(docSnap => {
                                const r = { id: docSnap.id, ...docSnap.data() };
                                const ts = r.timestamp?.toDate?.() || (r.timestamp ? new Date(r.timestamp) : null);
                                if (!ts || ts < start || ts > end) return;
                                const iso = fmtYMD(ts);
                                if (!pageState.recordsByDay[iso]) pageState.recordsByDay[iso] = [];
                                pageState.recordsByDay[iso].push(r);
                            });
                        }
                    } catch (e) { console.warn('è®€å–æœ¬æœˆæ‰“å¡ç´€éŒ„å¤±æ•—ï¼ˆæˆ‘çš„ç­è¡¨æœˆæ›†ï¼‰', e); }
                    const todayIso = fmtYMD(new Date());
                    const dToday = new Date(todayIso);
                    const sameMonth = dToday.getMonth() === pageState.monthDate.getMonth() && dToday.getFullYear() === pageState.monthDate.getFullYear();
                    pageState.selectedDayIso = sameMonth ? todayIso : fmtYMD(new Date(pageState.monthDate.getFullYear(), pageState.monthDate.getMonth(), 1));
                };

                const renderCalendar = () => {
                    const grid = document.getElementById('myshift-calendar-grid');
                    if (!grid) return;
                    const year = pageState.monthDate.getFullYear();
                    const month = pageState.monthDate.getMonth();
                    const firstDay = new Date(year, month, 1);
                    const startWeekday = firstDay.getDay();
                    const daysInMonth = new Date(year, month+1, 0).getDate();
                    const prevMonthDays = new Date(year, month, 0).getDate();
                    const cells = [];
                    const selectedIso = pageState.selectedDayIso || fmtYMD(new Date());
                    const todayIsoAll = fmtYMD(new Date());
                    for (let i=startWeekday-1; i>=0; i--) { const date = new Date(year, month-1, prevMonthDays - i); cells.push({ date, inMonth:false }); }
                    for (let d=1; d<=daysInMonth; d++) { cells.push({ date: new Date(year, month, d), inMonth:true }); }
                    const totalCells = Math.ceil(cells.length/7)*7;
                    const nextFill = totalCells - cells.length;
                    for (let i=1; i<=nextFill; i++) { cells.push({ date: new Date(year, month+1, i), inMonth:false }); }
                    grid.innerHTML = cells.map(cell => {
                        const iso = fmtYMD(cell.date);
                        const myList = pageState.daysMap[iso] || [];
                        const hasSchedule = cell.inMonth && myList.length > 0;
                        const records = pageState.recordsByDay[iso] || [];
                        const isAbnormalDay = cell.inMonth && records.some(r => {
                            try {
                                const info = computeRecordAbnormal(r, state.currentUserData?.serviceCommunities || []);
                                return info && info.isAbnormal;
                            } catch (_) { return false; }
                        });
                        const isTodayCell = iso === todayIsoAll;
                        const isEndType = (r) => {
                            const t = r?.type || '';
                            return t === 'ä¸‹ç­' || (typeof t === 'string' && t.includes('ä¸‹ç­')) || r?.auto === true || r?.autoClockOut === true || r?.isAutomatic === true || t === 'è‡ªå‹•ä¸‹ç­';
                        };
                        const todayCompleted = isTodayCell && records.some(r => (r.type === 'ä¸Šç­')) && records.some(isEndType);
                        const bgStyle = (() => {
                            if (!cell.inMonth) return '';
                            if (isAbnormalDay) return 'background-color:#FEE2E2;'; // æ·ºç´…
                            if (todayCompleted) return 'background-color:#D1FAE5;'; // æ·ºç¶ 
                            if (hasSchedule) return 'background-color:#FEF3C7;'; // æ·ºé»ƒ
                            return '';
                        })();
                        const isSelected = iso === selectedIso;
                        const borderCls = isSelected ? 'border-2 border-green-500' : (isTodayCell ? 'border-2 border-red-500' : '');
                        const cls = `${cell.inMonth? '':'bg-gray-50 text-gray-400'} ${borderCls} rounded p-2 text-xs h-[30px] flex flex-col ${cell.inMonth?'bg-white':''}`;
                        return `<div class="${cls}" style="${bgStyle}" data-iso="${iso}"><div class="font-semibold">${cell.date.getDate()}</div></div>`;
                    }).join('');
                    grid.querySelectorAll('[data-iso]').forEach(el=>{ el.addEventListener('click', ()=>{ pageState.selectedDayIso = el.getAttribute('data-iso'); renderDayPanel(); renderCalendar(); }); });
                };

                const renderDayPanel = () => {
                    const panel = document.getElementById('myshift-day-panel');
                    if (!panel) return;
                    const iso = pageState.selectedDayIso || fmtYMD(new Date()); const { Timestamp } = window.__fs || {};
                    const list = pageState.daysMap[iso] || [];
                    function deriveShiftId(it, isoStr) {
                        const idBase = [isoStr || '', it.endDateIso || isoStr || '', it.postName || 'ç„¡', it.start || '', it.end || ''].join('|');
                        return (it.id || it._id || idBase).replace(/\s+/g, '');
                    }
                    panel.innerHTML = `
                        <div class="flex items-center justify-between mb-2">
                            <div class="font-semibold">${iso} çš„å€‹äººç­è¡¨</div>
                        </div>
                        <div>
                            ${list.length===0 ? `<div class="text-gray-500 text-sm">æœ¬æ—¥ç„¡å€‹äººæ’ç­</div>` : ''}
                            <div class="space-y-3">
                                ${list.map(it=>`
                                    <div class="p-3 rounded border bg-white" data-shiftid="${deriveShiftId(it, iso)}">
                                        <div class="flex items-center gap-3">
                                            <span class="text-base font-semibold">${it.start || 'â€”'} ~ ${it.end || 'â€”'}</span>
                                            ${(it.postName && it.postName !== 'ç„¡') ? `<span class="text-sm text-gray-700 font-medium">${it.postName}</span>` : ''}
                                            ${(it.endDateIso && it.endDateIso !== iso) ? `<span class="text-xs px-2 py-0.5 rounded bg-yellow-100 text-yellow-700 border border-yellow-200">è·¨æ—¥è‡³ ${it.endDateIso}</span>` : ''}
                                        </div>
                                        <div class="mt-3 flex flex-col gap-2">
                                            <div class="flex items-center gap-2">
                                                <button class="my-clock-btn px-4 py-2 text-base rounded-md bg-green-600 text-white hover:bg-green-700" data-type="ä¸Šç­" data-iso="${iso}" data-start="${it.start || ''}" data-end="${it.end || ''}" data-enddateiso="${it.endDateIso || ''}" data-shiftid="${deriveShiftId(it, iso)}">ä¸Šç­</button>
                                                <button class="my-clock-btn px-4 py-2 text-base rounded-md bg-gray-300 text-gray-500 cursor-not-allowed" data-type="ä¸‹ç­" data-iso="${iso}" data-start="${it.start || ''}" data-end="${it.end || ''}" data-enddateiso="${it.endDateIso || ''}" data-shiftid="${deriveShiftId(it, iso)}">ä¸‹ç­</button>
                                                <button class="px-4 py-2 text-base bg-orange-500 text-white rounded-md hover:bg-orange-600" data-date="${iso}" data-start="${it.start || ''}" data-end="${it.end || ''}" data-enddateiso="${it.endDateIso || ''}" data-shiftid="${deriveShiftId(it, iso)}" onclick="openLeaveModalWithDefaults(this)">è«‹å‡</button>
                                            </div>
                                            <div class="text-sm" data-alert="shift"></div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>`;
                    // ç¶å®šæˆ‘çš„ç­è¡¨æŒ‰éˆ•äº‹ä»¶ï¼ˆä¾ç­è¡¨æ™‚é–“åˆ¤æ–·ï¼‰
                    panel.querySelectorAll('.my-clock-btn').forEach(btn=>{
                        btn.addEventListener('click', ()=> handleMyShiftButtonClick(btn));
                    });
                    let __autoClockTimerId = null;
                    // å¾å¾Œç«¯ç´€éŒ„æ¨æ–·å„ç­è¡¨ç‹€æ…‹ä¸¦å¥—ç”¨ UI
                    const __syncUiShiftStatusFromBackend = async () => {
                        try {
                            const user = window.__auth?.currentUser; const db = window.__db; const fs = window.__fs || {};
                            const { collection, query, where, orderBy, getDocs, Timestamp } = fs || {};
                            if (!user || !db || !collection || !query || !where || !getDocs || !Timestamp) return;
                            let minStart = null, maxEnd = null;
                            (list || []).forEach(it => {
                                const s = toDateFromIsoHM(iso, it.start || '');
                                const e = toDateFromIsoHM(it.endDateIso || iso, it.end || '');
                                if (s && (!minStart || s < minStart)) minStart = s;
                                if (e && (!maxEnd || e > maxEnd)) maxEnd = e;
                            });
                            const windowStart = new Date((minStart || new Date(`${iso}T00:00:00`)).getTime() - 12*60*60*1000);
                            const windowEnd = new Date(((maxEnd || new Date(`${iso}T23:59:59.999`)).getTime()) + 12*60*60*1000);
                            const q = query(
                                collection(db, 'clockInRecords'),
                                where('userId','==', user.uid),
                                where('timestamp','>=', Timestamp.fromDate(windowStart)),
                                where('timestamp','<=', Timestamp.fromDate(windowEnd)),
                                orderBy('timestamp','asc')
                            );
                            const snap = await getDocs(q);
                            const records = snap.docs.map(d => d.data());
                            const statusMap = {};
                            (list || []).forEach(it => {
                                const shiftId = deriveShiftId(it, iso);
                                const startAt = toDateFromIsoHM(iso, it.start || '');
                                const endAt = toDateFromIsoHM(it.endDateIso || iso, it.end || '');
                                const startEarliest = startAt ? new Date(startAt.getTime() - 30*60*1000) : null;
                                const startLatest = endAt ? new Date(endAt.getTime() + 30*60*1000) : (startAt ? new Date(startAt.getTime() + 12*60*60*1000) : null);
                                const endEarliest = endAt ? endAt : null;
                                const endLatest = endAt ? new Date(endAt.getTime() + 30*60*1000) : null;
                                let started = false, ended = false;
                                for (const r of records) {
                                    const rt = r?.timestamp?.toDate ? r.timestamp.toDate() : null;
                                    if (!rt) continue;
                                    if (!started && startEarliest && startLatest && rt >= startEarliest && rt <= startLatest && r.type === 'ä¸Šç­') { started = true; }
                                    if (!ended && endEarliest && rt >= endEarliest && (!endLatest || rt <= endLatest) && (r.type === 'ä¸‹ç­' || r.type === 'è‡ªå‹•ä¸‹ç­')) { ended = true; }
                                    if (started && ended) break;
                                }
                                statusMap[shiftId] = { started, ended };
                            });
                            state.uiShiftStatus = statusMap;
                        } catch (e) { console.warn('åŒæ­¥ç­è¡¨ç‹€æ…‹å¤±æ•—', e); }
                    };
                    // å›æº¯è‡ªå‹•ä¸‹ç­ï¼šé‡å°å·²é 30 åˆ†é˜ä»æœªä¸‹ç­çš„éå»ç­åˆ¥ï¼Œè‡ªå‹•è£œç´€éŒ„ç‚ºæ’å®š endAt
                    const __ensureRetroAutoClockOutForPastShifts = async () => {
                        try {
                            const user = window.__auth?.currentUser; const db = window.__db; const fs = window.__fs || {};
                            const { collection, query, where, orderBy, getDocs, Timestamp } = fs || {};
                            if (!user || !db || !collection || !query || !where || !getDocs || !Timestamp) return;
                            const now = new Date();
                            for (const it of (list || [])) {
                                const shiftId = deriveShiftId(it, iso);
                                const endAt = toDateFromIsoHM(it.endDateIso || iso, it.end || '');
                                if (!endAt) continue;
                                const threshold = new Date(endAt.getTime() + 30*60*1000);
                                if (now < threshold) continue;
                                const windowStart = new Date(endAt.getTime() - 12*60*60*1000);
                                const windowEnd = new Date(endAt.getTime() + 12*60*60*1000);
                                const q = query(
                                    collection(db, 'clockInRecords'),
                                    where('userId','==', user.uid),
                                    where('timestamp','>=', Timestamp.fromDate(windowStart)),
                                    where('timestamp','<=', Timestamp.fromDate(windowEnd)),
                                    orderBy('timestamp','asc')
                                );
                                const snap = await getDocs(q);
                                let ended = false;
                                snap.docs.forEach(d=>{
                                    const r = d.data() || {};
                                    const rt = r?.timestamp?.toDate ? r.timestamp.toDate() : null;
                                    if (!rt) return;
                                    if (rt >= endAt && rt <= new Date(endAt.getTime()+30*60*1000) &&
                                        (r.type === 'ä¸‹ç­' || r.type === 'è‡ªå‹•ä¸‹ç­')) { ended = true; }
                                });
                                const ui = state.uiShiftStatus?.[shiftId];
                                if (!ended && (!ui || !ui.ended)) {
                                    await createAutoClockOutRecord(endAt, shiftId);
                                }
                            }
                        } catch (e) { console.warn('å›æº¯è‡ªå‹•ä¸‹ç­å¤±æ•—', e); }
                    };
                    __syncUiShiftStatusFromBackend().then(async ()=>{ try { applyShiftButtonEnable(panel, iso, list); } catch (_) {} try { await __ensureRetroAutoClockOutForPastShifts(); } catch(_){}})
                        .catch(()=>{ try { applyShiftButtonEnable(panel, iso, list); } catch (_) {} });
                    // æ¯åˆ†é˜å‹•æ…‹åˆ·æ–°æç¤ºèˆ‡æŒ‰éˆ•ç‹€æ…‹ï¼ˆå«å¾Œç«¯ç´€éŒ„åŒæ­¥ï¼‹å›æº¯æª¢æŸ¥ï¼‰
                    try {
                        if (window.__shiftRefreshIntervalId) { clearInterval(window.__shiftRefreshIntervalId); }
                        window.__shiftRefreshIntervalId = setInterval(() => {
                            try {
                                __syncUiShiftStatusFromBackend().then(async ()=>{ try { applyShiftButtonEnable(panel, iso, list); } catch (_) {} try { await __ensureRetroAutoClockOutForPastShifts(); } catch(_){}} );
                            } catch (_) {}
                        }, 60 * 1000);
                    } catch (_) {}
                    try { updateMyScheduleButtons(); } catch (_) {}

                    // â€”â€” æˆ‘çš„ç­è¡¨ï¼šæ‰“å¡èˆ‡è«‹å‡è¦å‰‡ â€”â€”
                    function toDateFromIsoHM(isoStr, hmStr) {
                        if (!isoStr || !hmStr) return null;
                        const d = new Date(`${isoStr}T00:00:00`);
                        const [hh, mm] = (hmStr || '00:00').split(':').map(x=>parseInt(x, 10) || 0);
                        d.setHours(hh, mm, 0, 0);
                        return isNaN(d.getTime()) ? null : d;
                    }
                    function handleMyShiftButtonClick(btn) {
                        const type = btn.dataset.type;
                        const isoStr = btn.dataset.iso;
                        const startHM = btn.dataset.start || '';
                        const endHM = btn.dataset.end || '';
                        const endDateIso = btn.dataset.enddateiso || isoStr;
                        const shiftId = btn.dataset.shiftid || `${isoStr}|${endDateIso}|${startHM}|${endHM}`;
                        state.uiShiftStatus = state.uiShiftStatus || {};
                        const uiStatus = state.uiShiftStatus[shiftId] || { started: false, ended: false };
                        const startAt = toDateFromIsoHM(isoStr, startHM);
                        const endAt = toDateFromIsoHM(endDateIso, endHM);
                        const now = new Date();
                        const alertEl = btn.closest('.flex.flex-col')?.querySelector('[data-alert="shift"]');
                        const setAlert = (msg, colorClass='text-red-600') => {
                            if (!alertEl) return;
                            alertEl.textContent = msg;
                            alertEl.classList.remove('text-red-600','text-orange-600','text-green-600','text-gray-600');
                            alertEl.classList.add(colorClass);
                        };
                        const clearAlert = () => { if (alertEl) { alertEl.textContent=''; alertEl.classList.remove('text-red-600','text-orange-600','text-green-600','text-gray-600'); } };
                        if (type === 'ä¸Šç­') {
                            if (uiStatus.started || uiStatus.ended) {
                                setAlert('å·²å®Œæˆä¸Šç­æ‰“å¡', 'text-gray-600');
                                return;
                            }
                            if (startAt) {
                                const earliest = new Date(startAt.getTime() - 30*60*1000);
                                if (now < earliest) {
                                    setAlert('å°šæœªåˆ°ä¸Šç­æ™‚é–“', 'text-gray-600');
                                    return;
                                }
                                const graceEnd = new Date(startAt.getTime() + 30*60*1000);
                                if (now <= graceEnd) {
                                    setAlert('å·²åˆ°å¯ä»¥ä¸Šç­æ‰“å¡æ™‚é–“', 'text-green-600');
                                } else {
                                    setAlert('è¶…éä¸Šç­æ‰“å¡æ™‚é–“', 'text-red-600');
                                }
                            }
                            clearAlert();
                            openClockInModal('ä¸Šç­');
                            // è¨­å®šè©²ç­è¡¨å·²ä¸Šç­ï¼ˆä¾éœ€æ±‚ä¸é¡§æ˜¯å¦å–æ¶ˆï¼‰
                            state.uiShiftStatus[shiftId] = { started: true, ended: false };
                        } else if (type === 'ä¸‹ç­') {
                            if (!uiStatus.started) {
                                // å°šæœªä¸Šç­ï¼Œä¸é¡¯ç¤ºä¸‹ç­æç¤º
                                clearAlert();
                                return;
                            }
                            if (uiStatus.ended) {
                                setAlert('å·²å®Œæˆä¸‹ç­æ‰“å¡', 'text-gray-600');
                                return;
                            }
                            if (endAt) {
                                const endGraceEnd = new Date(endAt.getTime() + 30*60*1000);
                                if (now < endAt) {
                                    setAlert('æœªåˆ°ä¸‹ç­æ‰“å¡æ™‚é–“', 'text-gray-600');
                                    return;
                                }
                                if (now <= endGraceEnd) {
                                    setAlert('å·²åˆ°å¯ä»¥ä¸‹ç­æ‰“å¡æ™‚é–“', 'text-green-600');
                                } else {
                                    setAlert('è¶…éä¸‹ç­æ‰“å¡æ™‚é–“', 'text-red-600');
                                }
                            }
                            clearAlert();
                            openClockInModal('ä¸‹ç­');
                            state.uiShiftStatus[shiftId] = { started: true, ended: true };
                        }
                    }
                    function applyShiftButtonEnable(panelEl, isoStr, shifts) {
                        try {
                            const now = new Date();
                            state.uiShiftStatus = state.uiShiftStatus || {};
                            panelEl.querySelectorAll('.my-clock-btn').forEach(btn => {
                                const type = btn.dataset.type;
                                const startHM = btn.dataset.start || '';
                                const endHM = btn.dataset.end || '';
                                const endDateIso = btn.dataset.enddateiso || isoStr;
                                const shiftId = btn.dataset.shiftid || `${isoStr}|${endDateIso}|${startHM}|${endHM}`;
                                const startAt = toDateFromIsoHM(isoStr, startHM);
                                const endAt = toDateFromIsoHM(endDateIso, endHM);
                                const uiStatus = state.uiShiftStatus[shiftId] || { started: false, ended: false };
                                const container = btn.closest('.flex.flex-col');
                                const alertEl = container?.querySelector('[data-alert="shift"]');
                                const setAlert = (msg, colorClass='text-gray-600') => {
                                    if (!alertEl) return;
                                    alertEl.textContent = msg;
                                    alertEl.classList.remove('text-gray-600','text-red-600','text-orange-600','text-green-600');
                                    alertEl.classList.add(colorClass);
                                };
                                const clearAlert = () => { if (alertEl) { alertEl.textContent=''; alertEl.classList.remove('text-gray-600','text-red-600','text-orange-600','text-green-600'); } };

                                // è«‹å‡æŒ‰éˆ•ï¼šå®Œæˆè©²ç­è¡¨ä¸‹ç­å¾Œåœç”¨æ”¹ç°è‰²ï¼Œå…¶é¤˜ç¶­æŒæ©˜è‰²å¯ç”¨
                                const leaveBtn = container?.querySelector('button[onclick*="openLeaveModalWithDefaults"]');
                                if (leaveBtn) {
                                    leaveBtn.classList.remove('bg-gray-300','text-gray-500','cursor-not-allowed','bg-orange-500','hover:bg-orange-600','text-white');
                                    if (uiStatus.ended) {
                                        leaveBtn.disabled = true;
                                        leaveBtn.classList.add('bg-gray-300','text-gray-500','cursor-not-allowed');
                                    } else {
                                        leaveBtn.disabled = false;
                                        leaveBtn.classList.add('bg-orange-500','hover:bg-orange-600','text-white');
                                    }
                                }

                                if (type === 'ä¸Šç­') {
                                    const earliest = startAt ? new Date(startAt.getTime() - 30*60*1000) : null;
                                    const graceEnd = startAt ? new Date(startAt.getTime() + 30*60*1000) : null;
                                    btn.classList.remove('bg-gray-300','text-gray-500','cursor-not-allowed','bg-green-600','hover:bg-green-700','text-white');
                                    if (uiStatus.started || uiStatus.ended) {
                                        btn.disabled = true;
                                        btn.classList.add('bg-gray-300','text-gray-500','cursor-not-allowed');
                                        // ä¸Šç­å®Œæˆå¾Œçš„æç¤ºæ”¹çœ‹ä¸‹ç­æ™‚é–“çª—
                                        if (uiStatus.started && endAt) {
                                            const endGraceEnd = new Date(endAt.getTime() + 30*60*1000);
                                            if (now < endAt) clearAlert();
                                            else if (now <= endGraceEnd) setAlert('å·²åˆ°å¯ä»¥ä¸‹ç­æ‰“å¡æ™‚é–“','text-green-600');
                                            else setAlert('è¶…éä¸‹ç­æ‰“å¡æ™‚é–“','text-red-600');
                                        } else {
                                            clearAlert();
                                        }
                                    } else {
                                        if (startAt && earliest && now < earliest) {
                                            btn.disabled = true;
                                            btn.classList.add('bg-gray-300','text-gray-500','cursor-not-allowed');
                                            setAlert('å°šæœªåˆ°ä¸Šç­æ™‚é–“','text-gray-600');
                                        } else {
                                            btn.disabled = false;
                                            btn.classList.add('bg-green-600','hover:bg-green-700','text-white');
                                            if (startAt && graceEnd) {
                                                if (now <= graceEnd) setAlert('å·²åˆ°å¯ä»¥ä¸Šç­æ‰“å¡æ™‚é–“','text-green-600');
                                                else setAlert('è¶…éä¸Šç­æ‰“å¡æ™‚é–“','text-red-600');
                                            }
                                        }
                                    }
                                }

                                if (type === 'ä¸‹ç­') {
                                    btn.classList.remove('bg-gray-300','text-gray-500','cursor-not-allowed','bg-red-600','hover:bg-red-700','text-white');
                                    if (!uiStatus.started) {
                                        // å°šæœªä¸Šç­ï¼šä¿æŒç°è‰²ï¼Œä¸é¡¯ç¤ºä¸‹ç­æç¤º
                                        btn.disabled = true;
                                        btn.classList.add('bg-gray-300','text-gray-500','cursor-not-allowed');
                                        clearAlert();
                                    } else if (uiStatus.ended) {
                                        btn.disabled = true;
                                        btn.classList.add('bg-gray-300','text-gray-500','cursor-not-allowed');
                                        clearAlert();
                                    } else {
                                        if (endAt && now >= endAt) {
                                            btn.disabled = false;
                                            btn.classList.add('bg-red-600','hover:bg-red-700','text-white');
                                            const endGraceEnd = new Date(endAt.getTime() + 30*60*1000);
                                            if (now <= endGraceEnd) setAlert('å·²åˆ°å¯ä»¥ä¸‹ç­æ‰“å¡æ™‚é–“','text-green-600');
                                            else setAlert('è¶…éä¸‹ç­æ‰“å¡æ™‚é–“','text-red-600');
                                        } else {
                                            btn.disabled = true;
                                            btn.classList.add('bg-gray-300','text-gray-500','cursor-not-allowed');
                                            if (endAt) setAlert('æœªåˆ°ä¸‹ç­æ‰“å¡æ™‚é–“','text-gray-600');
                                        }
                                    }
                                }

                                // è‡ªå‹•ä¸‹ç­ï¼šä¾ç­åˆ¥æ’ç¨‹ï¼ˆåƒ…åœ¨å·²ä¸Šç­ä¸”æœªä¸‹ç­æ™‚å•Ÿå‹•ï¼‰
                                if (endAt) ensureAutoClockOutForShift(endAt, shiftId, uiStatus);
                            });
                        } catch (e) { console.warn('applyShiftButtonEnable å¤±æ•—', e); }
                    }
                    async function ensureAutoClockOutForShift(endAt, shiftId, uiStatus) {
                        try {
                            const threshold = new Date(endAt.getTime() + 30*60*1000);
                            const now = new Date();
                            // æ¯ç­åˆ¥ç¶­æŒè¨ˆæ™‚å™¨ï¼Œé¿å…åªç”¨å–®ä¸€è¨ˆæ™‚å™¨å°è‡´æ¼è§¸ç™¼
                            window.__autoClockTimerMap = window.__autoClockTimerMap || {};
                            // è‹¥æœªä¸Šç­æˆ–å·²ä¸‹ç­ï¼Œæ¸…é™¤æ—¢æœ‰æ’ç¨‹ä¸¦è·³å‡º
                            if (!uiStatus?.started || uiStatus?.ended) {
                                if (shiftId && window.__autoClockTimerMap[shiftId]) {
                                    clearTimeout(window.__autoClockTimerMap[shiftId]);
                                    delete window.__autoClockTimerMap[shiftId];
                                }
                                return;
                            }
                            // æ™‚é»å·²é”ï¼šç«‹å³è‡ªå‹•ä¸‹ç­ï¼ˆç´€éŒ„æ™‚é–“ç‚ºæ’å®šä¸‹ç­æ™‚é–“ endAtï¼‰
                            if (now >= threshold) { await createAutoClockOutRecord(endAt, shiftId); return; }
                            // å·²æœ‰æ’ç¨‹å‰‡ä¸é‡è¤‡è¨­å®š
                            if (shiftId && window.__autoClockTimerMap[shiftId]) return;
                            const delay = Math.max(0, threshold.getTime() - now.getTime());
                            window.__autoClockTimerMap[shiftId] = setTimeout(async ()=>{
                                delete window.__autoClockTimerMap[shiftId];
                                const latest = state.uiShiftStatus?.[shiftId];
                                if (!latest || !latest.ended) { await createAutoClockOutRecord(endAt, shiftId); }
                            }, delay);
                        } catch (e) { console.warn('ensureAutoClockOutForShift å¤±æ•—', e); }
                    }
                    async function createAutoClockOutRecord(ts, shiftId) {
                        try {
                            const user = window.__auth?.currentUser; if (!user) return;
                            const db = window.__db; const { addDoc, collection, Timestamp, doc, updateDoc, serverTimestamp, GeoPoint } = window.__fs;
                            const loc = state.currentLocation || { lat: 0, lng: 0 };
                            const gp = (typeof GeoPoint === 'function') ? new GeoPoint(loc.lat || 0, loc.lng || 0) : { lat: loc.lat || 0, lng: loc.lng || 0 };
                            await addDoc(collection(db, 'clockInRecords'), {
                                userId: user.uid,
                                type: 'è‡ªå‹•ä¸‹ç­',
                                timestamp: Timestamp.fromDate(ts),
                                location: gp,
                                photoUrls: [],
                                descriptions: [],
                                isAutomatic: true,
                                shiftId: shiftId || ''
                            });
                            await updateDoc(doc(db, 'users', user.uid), {
                                clockInStatus: 'ä¸‹ç­',
                                status: 'ä¸‹ç­',
                                lastUpdated: serverTimestamp()
                            });
                            // æ›´æ–°æœ¬åœ° UI ç‹€æ…‹èˆ‡æŒ‰éˆ•
                            try {
                                state.uiShiftStatus = state.uiShiftStatus || {};
                                if (shiftId) { state.uiShiftStatus[shiftId] = { started: true, ended: true }; }
                                if (shiftId && window.__autoClockTimerMap && window.__autoClockTimerMap[shiftId]) {
                                    clearTimeout(window.__autoClockTimerMap[shiftId]);
                                    delete window.__autoClockTimerMap[shiftId];
                                }
                                await __syncUiShiftStatusFromBackend();
                                applyShiftButtonEnable(panel, iso, list);
                            } catch (_) {}
                            try { showToast('å·²è¶…éä¸‹ç­30åˆ†é˜ï¼Œç³»çµ±è‡ªå‹•ä¸‹ç­'); } catch(_){}
                        } catch (e) {
                            console.error('è‡ªå‹•ä¸‹ç­ç´€éŒ„å¤±æ•—', e);
                            try { showToast('è‡ªå‹•ä¸‹ç­å¤±æ•—ï¼š' + (e.message || ''), true); } catch(_){}
                        }
                    }
                    function openLeaveModalWithDefaults(triggerBtn) {
                        try {
                            const isoStr = triggerBtn.dataset.date;
                            const startHM = triggerBtn.dataset.start || '';
                            const endHM = triggerBtn.dataset.end || '';
                            const endDateIso = triggerBtn.dataset.enddateiso || isoStr;
                            const startAt = toDateFromIsoHM(isoStr, startHM);
                            const endAt = toDateFromIsoHM(endDateIso, endHM);
                            const formatYMDH = (d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}-${String(d.getHours()).padStart(2,'0')}`;
                            const defaultStart = startAt ? formatYMDH(startAt) : '';
                            const defaultEnd = endAt ? formatYMDH(endAt) : '';
                            const backdrop = document.createElement('div'); backdrop.className = 'modal-backdrop';
                            const modal = document.createElement('div'); modal.className = 'modal-content'; modal.style.width = '360px';
                            modal.innerHTML = `
                              <div class="space-y-3">
                                <div class="text-lg font-semibold">è«‹å‡ç”³è«‹</div>
                                <div class="space-y-2">
                                  <label class="block text-sm font-medium">è«‹å‡äº‹ç”±</label>
                                  <select id="leave-type" class="w-full border border-gray-300 rounded-md p-2">
                                    <option value="ç—…å‡">ç—…å‡</option>
                                    <option value="äº‹å‡">äº‹å‡</option>
                                    <option value="å…¶ä»–">å…¶ä»–(è‡ªå®šç¾©)</option>
                                  </select>
                                  <input id="leave-other" class="w-full border border-gray-300 rounded-md p-2 hidden" placeholder="è«‹è¼¸å…¥è‡ªå®šç¾©äº‹ç”±">
                                </div>
                                <div class="space-y-2">
                                  <label class="block text-sm font-medium">é–‹å§‹æ™‚é–“ (YYYY-MM-DD-HH)</label>
                                  <input id="leave-start" class="w-full border border-gray-300 rounded-md p-2" value="${defaultStart}">
                                </div>
                                <div class="space-y-2">
                                  <label class="block text-sm font-medium">çµæŸæ™‚é–“ (YYYY-MM-DD-HH)</label>
                                  <input id="leave-end" class="w-full border border-gray-300 rounded-md p-2" value="${defaultEnd}">
                                </div>
                                <div class="flex justify-end gap-2 pt-2">
                                  <button id="leave-cancel" class="px-3 py-2 rounded bg-gray-200 text-gray-800">å–æ¶ˆ</button>
                                  <button id="leave-submit" class="px-3 py-2 rounded bg-orange-500 text-white">é€å‡º</button>
                                </div>
                              </div>
                            `;
                            document.body.appendChild(backdrop); document.body.appendChild(modal);
                            const typeEl = modal.querySelector('#leave-type'); const otherEl = modal.querySelector('#leave-other');
                            typeEl.addEventListener('change', ()=> { otherEl.classList.toggle('hidden', typeEl.value !== 'å…¶ä»–'); });
                            const close = ()=> { try { document.body.removeChild(backdrop); document.body.removeChild(modal); } catch(_){} };
                            modal.querySelector('#leave-cancel').addEventListener('click', close);
                            backdrop.addEventListener('click', close);
                            modal.querySelector('#leave-submit').addEventListener('click', async ()=>{
                                try {
                                    const user = window.__auth?.currentUser; if (!user) { showToast('è«‹å…ˆç™»å…¥', true); return; }
                                    const startStr = modal.querySelector('#leave-start').value.trim();
                                    const endStr = modal.querySelector('#leave-end').value.trim();
                                    const [sy, sm, sd, sh] = startStr.split('-');
                                    const [ey, em, ed, eh] = endStr.split('-');
                                    const startD = new Date(parseInt(sy,10), parseInt(sm,10)-1, parseInt(sd,10), parseInt(sh,10)||0, 0, 0, 0);
                                    const endD = new Date(parseInt(ey,10), parseInt(em,10)-1, parseInt(ed,10), parseInt(eh,10)||0, 0, 0, 0);
                                    const reasonType = typeEl.value;
                                    const reason = reasonType === 'å…¶ä»–' ? (otherEl.value.trim() || 'å…¶ä»–') : reasonType;
                                    const db = window.__db; const { addDoc, collection, Timestamp } = window.__fs;
                                    await addDoc(collection(db, 'leaves'), {
                                        userId: user.uid,
                                        reason,
                                        reasonType,
                                        startTime: Timestamp.fromDate(startD),
                                        endTime: Timestamp.fromDate(endD),
                                        status: 'pending',
                                        createdAt: Timestamp.fromDate(new Date())
                                    });
                                    try { showToast('å·²é€å‡ºè«‹å‡ç”³è«‹'); } catch(_){}
                                    close();
                                } catch (e) {
                                    console.error('è«‹å‡ç”³è«‹å¤±æ•—', e);
                                    try { showToast('è«‹å‡ç”³è«‹å¤±æ•—ï¼š' + (e.message || ''), true); } catch(_){}
                                }
                            });
                        } catch (e) {
                            console.warn('openLeaveModalWithDefaults å¤±æ•—ï¼Œæ”¹ç”¨æ—¢æœ‰å‡½å¼', e);
                            try { openTempLeaveModal(triggerBtn); } catch(_){}
                        }
                    }
                    window.openLeaveModalWithDefaults = openLeaveModalWithDefaults;
                };

                const init = async () => {
                    renderShell();
                    await loadPosts();
                    renderMonthHeader();
                    await loadMonth();
                    renderCalendar();
                    renderDayPanel();
                };
                init();
            }

            // æ–°å¢ï¼šæˆ‘çš„ç­è¡¨æŒ‰éˆ•ç‹€æ…‹æ›´æ–°èˆ‡æ‰“å¡å½ˆçª—
            function updateMyScheduleButtons() {
                try {
                    const panel = document.getElementById('myshift-day-panel');
                    if (!panel) return;
                    const startBtn = panel.querySelector('.my-clock-btn[data-type="ä¸Šç­"]');
                    const endBtn = panel.querySelector('.my-clock-btn[data-type="ä¸‹ç­"]');
                    const setBtn = (btn, enabled, color) => {
                        if (!btn) return;
                        btn.disabled = !enabled;
                        btn.classList.remove('cursor-not-allowed','bg-gray-300','text-gray-500','bg-green-600','hover:bg-green-700','bg-red-600','hover:bg-red-700');
                        if (enabled) {
                            const c = color === 'red' ? ['bg-red-600','hover:bg-red-700'] : ['bg-green-600','hover:bg-green-700'];
                            btn.classList.add(...c,'text-white');
                        } else {
                            btn.classList.add('bg-gray-300','text-gray-500','cursor-not-allowed');
                        }
                    };
                    const s = state.clockInStatus || 'none';
                    if (['none','ä¸‹ç­','è¿”å›'].includes(s)) {
                        setBtn(startBtn, true, 'green'); setBtn(endBtn, false, 'red');
                    } else if (['ä¸Šç­','æŠµé”','ç‰¹æ®Šå‹¤å‹™'].includes(s)) {
                        setBtn(startBtn, false, 'green'); setBtn(endBtn, true, 'red');
                    } else if (['å¤–å‡º','é›¢é–‹','è‡¨æ™‚è«‹å‡','è«‹å‡ä¸­'].includes(s)) {
                        setBtn(startBtn, false, 'green'); setBtn(endBtn, false, 'red');
                    } else {
                        setBtn(startBtn, true, 'green'); setBtn(endBtn, false, 'red');
                    }
                } catch (e) { console.warn('æ›´æ–°æˆ‘çš„ç­è¡¨æŒ‰éˆ•ç‹€æ…‹å¤±æ•—', e); }
            }
            function openClockInModal(type) {
                try {
                    if (type === 'å¤–å‡º') {
                        createLocationInputModal();
                        return;
                    }
                    const loc = state.currentLocation || null;
                    openCameraModal(type, loc);
                } catch (e) {
                    console.warn('é–‹å•Ÿæ‰“å¡å½ˆçª—å¤±æ•—', e);
                    alert('æ‰“å¡è¦–çª—é–‹å•Ÿå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                }
            }

            // å€‹äººè«‹å‡ç´€éŒ„å­é ç±¤
            function renderMyLeaveRecords(container) {
                container.innerHTML = `
                    <div class="p-4 space-y-4">
                        <div class="flex flex-wrap items-center gap-4 mb-4">
                            <div class="flex items-center space-x-2">
                                <label for="my-leave-status-filter" class="text-sm font-medium">å¯©æ ¸ç‹€æ…‹:</label>
                                <select id="my-leave-status-filter" class="border border-gray-300 rounded-md px-2 py-1">
                                    <option value="all" selected>å…¨éƒ¨</option>
                                    <option value="pending">å¾…å¯©æ ¸</option>
                                    <option value="approved">å·²æ ¸å‡†</option>
                                    <option value="rejected">å·²æ‹’çµ•</option>
                                </select>
                            </div>
                            <div class="flex items-center space-x-2">
                                <label for="my-leave-date-filter" class="text-sm font-medium">æ—¥æœŸ:</label>
                                <input type="date" id="my-leave-date-filter" class="border border-gray-300 rounded-md px-2 py-1" value="">
                            </div>
                            <button id="my-leave-search-btn" class="bg-blue-600 text-white px-3 py-1 rounded-md hover:bg-blue-700 flex items-center">
                                <i data-lucide="search" class="w-4 h-4 mr-1"></i>æœå°‹
                            </button>
                        </div>
                        <div class="bg-white rounded-lg shadow overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">äº‹ç”±</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é–‹å§‹æ™‚é–“</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">çµæŸæ™‚é–“</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç‹€æ…‹</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="my-leave-records-list" class="bg-white divide-y divide-gray-200">
                                        <tr>
                                            <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                                                <div class="flex items-center justify-center">
                                                    <i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i>
                                                    è¼‰å…¥ä¸­...
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div id="no-my-leave-records" class="hidden p-8 text-center text-gray-500 bg-white rounded-lg shadow">
                            <i data-lucide="calendar-off" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                            <p>æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è«‹å‡è¨˜éŒ„</p>
                        </div>
                    </div>
                `;
                lucide.createIcons();

                const statusFilter = document.getElementById('my-leave-status-filter');
                const dateFilter = document.getElementById('my-leave-date-filter');
                const searchBtn = document.getElementById('my-leave-search-btn');

                // åˆå§‹åŠ è¼‰
                loadMyLeaveRecords();

                searchBtn.addEventListener('click', loadMyLeaveRecords);

                function getStatusBadge(status) {
                    switch (status) {
                        case 'pending':
                            return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">å¾…å¯©æ ¸</span>';
                        case 'approved':
                            return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">å·²æ ¸å‡†</span>';
                        case 'rejected':
                            return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">å·²æ‹’çµ•</span>';
                        case 'canceled':
                            return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-200 text-gray-700">å·²å–æ¶ˆ</span>';
                        default:
                            return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">æœªçŸ¥</span>';
                    }
                }

                function loadMyLeaveRecords() {
                    const recordsList = document.getElementById('my-leave-records-list');
                    const noRecordsMsg = document.getElementById('no-my-leave-records');

                    recordsList.innerHTML = `
                        <tr>
                            <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                                <div class="flex items-center justify-center">
                                    <i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i>
                                    è¼‰å…¥ä¸­...
                                </div>
                            </td>
                        </tr>
                    `;
                    lucide.createIcons();

                    const status = statusFilter.value;
                    const date = dateFilter.value;

                    const user = window.__auth?.currentUser;
                    if (!user) {
                        recordsList.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-red-500">è«‹å…ˆç™»å…¥ä»¥æŸ¥çœ‹è«‹å‡ç´€éŒ„</td></tr>';
                        return;
                    }
                    const db = window.__db; const { collection, where, query, getDocs } = window.__fs;
                    let q = query(collection(db, 'leaves'), where('userId', '==', user.uid));
                    if (status !== 'all') { q = query(q, where('status', '==', status)); }
                    // ç§»é™¤æ’åºä»¥é¿å… Firestore ç´¢å¼•éœ€æ±‚ï¼Œæ”¹ç”¨å‰ç«¯æ’åºï¼ˆè‹¥éœ€è¦ï¼‰

                    getDocs(q).then((querySnapshot) => {
                        if (querySnapshot.empty) {
                            recordsList.innerHTML = '';
                            noRecordsMsg.classList.remove('hidden');
                            return;
                        }

                        noRecordsMsg.classList.add('hidden');
                        recordsList.innerHTML = '';

                        const selectedDate = date ? new Date(date) : null;
                        let nextDay = null;
                        if (selectedDate) {
                            selectedDate.setHours(0, 0, 0, 0);
                            nextDay = new Date(selectedDate);
                            nextDay.setDate(nextDay.getDate() + 1);
                        }

                        let hasRecords = false;
                        const leaves = [];

                        querySnapshot.forEach((docSnap) => {
                            const leave = { id: docSnap.id, ...docSnap.data() };
                            leaves.push(leave);
                        });

                        // å‰ç«¯éæ¿¾èˆ‡æ’åº
                        const filtered = leaves.filter(leave => {
                            if (selectedDate && nextDay) {
                                const startTime = leave.startTime.toDate();
                                const endTime = leave.endTime.toDate();
                                return (startTime < nextDay && endTime > selectedDate);
                            }
                            return true;
                        }).sort((a, b) => {
                            const aTs = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : 0;
                            const bTs = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : 0;
                            return bTs - aTs;
                        });

                        filtered.forEach(leave => {
                            hasRecords = true;
                            const startTimeText = leave.startTime.toDate().toLocaleString('zh-TW', { hour12: false });
                            const endTimeText = leave.endTime.toDate().toLocaleString('zh-TW', { hour12: false });

                            const row = document.createElement('tr');
                            row.className = 'hover:bg-gray-50';
                            row.innerHTML = `
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">${leave.reason || 'ç„¡äº‹ç”±'}</div>
                                    <div class="text-xs text-gray-500">${leave.reasonType || ''}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">${startTimeText}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">${endTimeText}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    ${getStatusBadge(leave.status)}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    ${leave.status === 'pending' ? '<button class="cancel-leave-btn bg-gray-200 hover:bg-gray-300 text-gray-800 px-2 py-1 rounded text-xs" data-id="'+(leave.id||'')+'">å–æ¶ˆ</button>' : ''}
                                </td>
                            `;
                            recordsList.appendChild(row);
                        });

                        lucide.createIcons();

                        // ç¶å®šå–æ¶ˆäº‹ä»¶ï¼ˆåƒ…é¡¯ç¤ºæ–¼å¾…å¯©æ ¸ï¼‰
                        recordsList.querySelectorAll('.cancel-leave-btn').forEach(btn => {
                            btn.addEventListener('click', async (e) => {
                                const id = e.currentTarget.dataset.id;
                                if (!id) {
                                    showToast('ç„¡æ³•è­˜åˆ¥å‡å–®ID', true);
                                    return;
                                }
                                if (!confirm('ç¢ºå®šè¦å–æ¶ˆé€™ç­†å‡å–®å—ï¼Ÿ')) return;
                                try {
                                    const db = window.__db; const { updateDoc, doc, serverTimestamp, Timestamp } = window.__fs; const user = window.__auth?.currentUser;
                                    await updateDoc(doc(db, 'leaves', id), { status: 'canceled', canceledAt: Timestamp.fromDate(new Date()) });
                                    if (user) {
                                        await updateDoc(doc(db, 'users', user.uid), {
                                            leaveStatus: 'canceled',
                                            status: 'æœªæ‰“å¡',
                                            lastUpdated: serverTimestamp()
                                        });
                                    }
                                    showToast('å·²å–æ¶ˆå‡å–®');
                                    loadMyLeaveRecords();
                                } catch (err) {
                                    console.error('å–æ¶ˆå‡å–®å¤±æ•—', err);
                                    showToast('å–æ¶ˆå¤±æ•—ï¼š'+ (err.message||''), true);
                                }
                            });
                        });

                        if (!hasRecords) {
                            recordsList.innerHTML = '';
                            noRecordsMsg.classList.remove('hidden');
                        }
                    }).catch(error => {
                        console.error('ç²å–è«‹å‡è¨˜éŒ„å¤±æ•—:', error);
                        recordsList.innerHTML = `
                            <tr>
                                <td colspan="4" class="px-6 py-4 text-center text-red-500">
                                    è®€å–è¨˜éŒ„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦
                                </td>
                            </tr>
                        `;
                    });
                }
            }
            
            // è‡¨æ™‚è«‹å‡è¡¨å–®ï¼ˆå·²ç§»é™¤é‡è¤‡å®šç¾©ï¼‰
            // ç¾åœ¨çµ±ä¸€ä½¿ç”¨å¤–éƒ¨ clock-in-functions.js ä¸­çš„ openTempLeaveModalã€‚
            
            // ç‰¹æ®Šå‹¤å‹™è¡¨å–®
            function openSpecialDutyModal() {
                const modal = document.createElement('div');
                modal.className = 'modal fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50';
                modal.id = 'special-duty-modal';
                
                const now = new Date();
                const formattedNow = now.toISOString().slice(0, 16); // æ ¼å¼ç‚º YYYY-MM-DDTHH:MM
                const twoHoursLater = new Date(now);
                twoHoursLater.setHours(twoHoursLater.getHours() + 2);
                const formattedTwoHoursLater = twoHoursLater.toISOString().slice(0, 16);
                
                modal.innerHTML = `
                    <div class="modal-content bg-white rounded-lg shadow-xl w-11/12 max-w-md mx-auto overflow-hidden">
                        <div class="modal-header bg-purple-500 text-white px-4 py-3 flex justify-between items-center">
                            <h3 class="text-lg font-semibold">ç‰¹æ®Šå‹¤å‹™ç™»è¨˜</h3>
                            <button class="modal-close text-white hover:text-gray-200">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <div class="modal-body p-4">
                            <form id="duty-form" class="space-y-4">
                                <div class="form-group">
                                    <label for="duty-type" class="block text-sm font-medium text-gray-700 mb-1">å‹¤å‹™é …ç›®åç¨±</label>
                                    <select id="duty-type" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                        <option value="ä¾‹è¡Œç£å¯Ÿ">ä¾‹è¡Œç£å¯Ÿ</option>
                                        <option value="ç°¡å ±">ç°¡å ±</option>
                                        <option value="ä¾‹æœƒ">ä¾‹æœƒ</option>
                                        <option value="å€å¤§">å€å¤§</option>
                                        <option value="è‡¨æ™‚æœƒ">è‡¨æ™‚æœƒ</option>
                                        <option value="å…¶ä»–">å…¶ä»–</option>
                                    </select>
                                </div>
                                
                                <div id="other-duty-container" class="form-group hidden">
                                    <label for="other-duty" class="block text-sm font-medium text-gray-700 mb-1">å…¶ä»–å‹¤å‹™é …ç›®</label>
                                    <input type="text" id="other-duty" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="è«‹è¼¸å…¥å‹¤å‹™é …ç›®åç¨±">
                                </div>
                                
                                <div class="form-group">
                                    <label for="duty-location" class="block text-sm font-medium text-gray-700 mb-1">åœ°é»</label>
                                    <div class="flex space-x-2">
                                        <input type="text" id="duty-location" class="flex-grow border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="è«‹è¼¸å…¥åœ°é»">
                                        <button type="button" id="map-location-btn" class="px-3 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 flex items-center justify-center">
                                            <i data-lucide="map-pin" class="w-5 h-5"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="duty-start-time" class="block text-sm font-medium text-gray-700 mb-1">é–‹å§‹æ™‚é–“</label>
                                    <input type="datetime-local" id="duty-start-time" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" value="${formattedNow}">
                                </div>
                                
                                <div class="form-group">
                                    <label for="duty-end-time" class="block text-sm font-medium text-gray-700 mb-1">çµæŸæ™‚é–“</label>
                                    <input type="datetime-local" id="duty-end-time" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" value="${formattedTwoHoursLater}">
                                </div>
                                
                                <div class="flex justify-end space-x-2 pt-2">
                                    <button type="button" id="duty-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">å–æ¶ˆ</button>
                                    <button type="submit" id="duty-submit-btn" class="px-4 py-2 bg-purple-500 text-white rounded-md hover:bg-purple-600">æäº¤ç™»è¨˜</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                lucide.createIcons();
                
                // å‹¤å‹™é …ç›®é¸æ“‡è®Šæ›´äº‹ä»¶
                const dutyTypeSelect = document.getElementById('duty-type');
                const otherDutyContainer = document.getElementById('other-duty-container');
                
                dutyTypeSelect.addEventListener('change', () => {
                    if (dutyTypeSelect.value === 'å…¶ä»–') {
                        otherDutyContainer.classList.remove('hidden');
                    } else {
                        otherDutyContainer.classList.add('hidden');
                    }
                });
                
                // åœ°åœ–ä½ç½®æŒ‰éˆ•äº‹ä»¶
                document.getElementById('map-location-btn').addEventListener('click', () => {
                    if (state.currentLocation) {
                        // ä½¿ç”¨åå‘åœ°ç†ç·¨ç¢¼ç²å–åœ°å€
                        const geocoder = new google.maps.Geocoder();
                        const latlng = { lat: state.currentLocation.lat, lng: state.currentLocation.lng };
                        
                        geocoder.geocode({ location: latlng }, (results, status) => {
                            if (status === 'OK' && results[0]) {
                                document.getElementById('duty-location').value = results[0].formatted_address;
                            } else {
                                document.getElementById('duty-location').value = `${state.currentLocation.lat}, ${state.currentLocation.lng}`;
                            }
                        });
                    } else {
                        showToast('ç„¡æ³•ç²å–ç•¶å‰ä½ç½®', true);
                    }
                });
                
                // é—œé–‰æŒ‰éˆ•äº‹ä»¶
                document.querySelector('.modal-close').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                
                // å–æ¶ˆæŒ‰éˆ•äº‹ä»¶
                document.getElementById('duty-cancel-btn').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                
                // è¡¨å–®æäº¤äº‹ä»¶
                document.getElementById('duty-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const dutyType = dutyTypeSelect.value;
                    let dutyName = dutyType;
                    
                    if (dutyType === 'å…¶ä»–') {
                        const otherDuty = document.getElementById('other-duty').value.trim();
                        if (!otherDuty) {
                            showToast('è«‹è¼¸å…¥å‹¤å‹™é …ç›®åç¨±', true);
                            return;
                        }
                        dutyName = otherDuty;
                    }
                    
                    const location = document.getElementById('duty-location').value.trim();
                    if (!location) {
                        showToast('è«‹è¼¸å…¥åœ°é»', true);
                        return;
                    }
                    
                    const startTime = new Date(document.getElementById('duty-start-time').value);
                    const endTime = new Date(document.getElementById('duty-end-time').value);
                    
                    if (isNaN(startTime.getTime()) || isNaN(endTime.getTime())) {
                        showToast('è«‹é¸æ“‡æœ‰æ•ˆçš„æ™‚é–“', true);
                        return;
                    }
                    
                    if (startTime >= endTime) {
                        showToast('çµæŸæ™‚é–“å¿…é ˆæ™šæ–¼é–‹å§‹æ™‚é–“', true);
                        return;
                    }
                    
                    try {
                        showLoading(true);
                        
                        const db = window.__db; const { addDoc, collection, Timestamp, serverTimestamp, updateDoc, doc } = window.__fs; const user = window.__auth?.currentUser;
                        if (!user) throw new Error('å°šæœªç™»å…¥');
                        // å‰µå»ºç‰¹æ®Šå‹¤å‹™è¨˜éŒ„
                        await addDoc(collection(db, 'specialDuties'), {
                            userId: user.uid,
                            userName: state.currentUserData?.name || '',
                            dutyName: dutyName,
                            dutyType: dutyType,
                            location: location,
                            startTime: Timestamp.fromDate(startTime),
                            endTime: Timestamp.fromDate(endTime),
                            createdAt: serverTimestamp()
                        });
                        
                        // æ›´æ–°ç”¨æˆ¶ç‹€æ…‹
                        await updateDoc(doc(db, 'users', user.uid), {
                            status: `å‡ºå‹¤-${dutyName}`,
                            lastUpdated: serverTimestamp()
                        });
                        
                        // ä¿å­˜åœ°é»åˆ°è¨­å®š
                        if (!state.savedLocations) {
                            state.savedLocations = [];
                        }
                        
                        // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒåœ°é»
                        const locationExists = state.savedLocations.some(loc => loc === location);
                        if (!locationExists) {
                            state.savedLocations.push(location);
                            // æœ€å¤šä¿å­˜10å€‹åœ°é»
                            if (state.savedLocations.length > 10) {
                                state.savedLocations.shift();
                            }
                            
                            // åƒ…ç®¡ç†å“¡å¯å¯«å…¥ Firestoreï¼›ä¸€èˆ¬ä½¿ç”¨è€…æ”¹å­˜ localStorage
                            const isAdmin = state.currentUserData && state.currentUserData.role === 'admin';
                            if (isAdmin && user) {
                                await updateDoc(doc(db, 'users', user.uid), { savedLocations: state.savedLocations });
                            } else {
                                try {
                                    const key = `saved_locations_${user?.uid || 'guest'}`;
                                    localStorage.setItem(key, JSON.stringify(state.savedLocations));
                                } catch (e) { console.warn('ä¿å­˜åœ°å€åˆ°æœ¬æ©Ÿå¤±æ•—', e); }
                            }
                        }
                        
                        showToast('ç‰¹æ®Šå‹¤å‹™å·²ç™»è¨˜');
                        updateStatusDisplay();
                        document.body.removeChild(modal);
                    } catch (error) {
                        console.error('æäº¤ç‰¹æ®Šå‹¤å‹™ç™»è¨˜å¤±æ•—:', error);
                        showToast('æäº¤ç‰¹æ®Šå‹¤å‹™ç™»è¨˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', true);
                    } finally {
                        showLoading(false);
                    }
                });
            }

            function renderClockInRecords(container) {
                const now = new Date();
                const ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
                container.innerHTML = `
                    <div class="p-4 space-y-4">
                        <div class="flex items-center space-x-2">
                            <label for="record-month" class="text-sm font-medium">ç¯©é¸æœˆä»½:</label>
                            <input type="month" id="record-month" value="${ym}" class="border border-gray-300 rounded-md px-2 py-1">
                            <button id="open-month-report" class="ml-2 px-3 py-1.5 bg-indigo-600 text-white rounded hover:bg-indigo-700 text-sm">æœˆå ±è¡¨</button>
                        </div>
                        <div id="records-list" class="space-y-3">
                            <div class="text-center p-4 text-gray-500">æ­£åœ¨è®€å–ç´€éŒ„...</div>
                        </div>
                    </div>
                `;

                const monthInput = document.getElementById('record-month');

                const loadRecords = async () => {
                    await ensureAbnormalMarkingConfig();
                    await ensureCommunitiesCache();
                    const [yearStr, monthStr] = (monthInput.value || ym).split('-');
                    const year = parseInt(yearStr, 10);
                    const monthIdx = parseInt(monthStr, 10) - 1;
                    const startOfMonth = new Date(year, monthIdx, 1, 0, 0, 0, 0);
                    const endOfMonth = new Date(year, monthIdx + 1, 0, 23, 59, 59, 999);
                    
                    const recordsRef = collection(db, "clockInRecords");
                    // Firestore ç«¯æœˆä»½ç¯„åœæŸ¥è©¢ä»¥é¿å…æ™‚å€é‚Šç•Œèª¤å·®ï¼ˆä¿ç•™å‰ç«¯éæ¿¾ä½œç‚ºä¿éšªï¼‰
                    const { Timestamp } = window.__fs || {};
                    const startTS = Timestamp?.fromDate ? Timestamp.fromDate(startOfMonth) : startOfMonth;
                    const endTS = Timestamp?.fromDate ? Timestamp.fromDate(endOfMonth) : endOfMonth;
                    const q = query(
                        recordsRef,
                        where("userId", "==", state.currentUser.uid),
                        where("timestamp", ">=", startTS),
                        where("timestamp", "<=", endTS)
                    );

                    try {
                        const querySnapshot = await getDocs(q);
                        const recordsListEl = document.getElementById('records-list');
                        if (!recordsListEl) return;
                        
                        if (querySnapshot.empty) {
                            (async () => {
                                try {
                                    const { doc, getDoc } = window.__fs; const db2 = window.__db;
                                    const uid = state.currentUser?.uid || window.__auth?.currentUser?.uid;
                                    if (!uid) { recordsListEl.innerHTML = `<p class="text-center text-gray-500 p-4">æœ¬æœˆç„¡æ‰“å¡ç´€éŒ„</p>`; return; }
                                    const userRef = doc(db2, 'users', uid);
                                    const userSnap = await getDoc(userRef);
                                    if (userSnap.exists()) {
                                        const u = userSnap.data();
                                        const ts = u.lastUpdated?.toDate?.() || (u.lastUpdated ? new Date(u.lastUpdated) : null);
                                        if (u.clockInStatus && ts && ts >= startOfMonth && ts <= endOfMonth) {
                                            const statusText = getStatusDisplayText(u.clockInStatus, u.outboundLocation || null, u.dutyType || null);
                                            const statusColor = getStatusColor(statusText);
                                            recordsListEl.innerHTML = `
                                                <div class="bg-white p-3 rounded-lg shadow-sm border mb-3">
                                                    <div class="flex justify-between items-start">
                                                        <div>
                                                            <p class="font-bold text-lg ${statusColor}">${statusText}</p>
                                                            <p class="text-sm text-gray-600">${formatDate(ts)}</p>
                                                        </div>
                                                    </div>
                                                    <div class="mt-2 text-xs text-gray-400">ä¾†æºï¼šä½¿ç”¨è€…ç‹€æ…‹å¿«ç…§ï¼ˆclockInRecords å»ºç«‹å¤±æ•—ï¼‰</div>
                                                </div>`;
                                            try { lucide.createIcons(); } catch(e){}
                                        } else {
                                                recordsListEl.innerHTML = `<p class="text-center text-gray-500 p-4">æœ¬æœˆç„¡æ‰“å¡ç´€éŒ„</p>`;
                                            }
                                        } else {
                                            recordsListEl.innerHTML = `<p class="text-center text-gray-500 p-4">æœ¬æœˆç„¡æ‰“å¡ç´€éŒ„</p>`;
                                    }
                                } catch (e) {
                                    const expectedCodes = ['permission-denied','failed-precondition','invalid-argument'];
                                    const logFn = expectedCodes.includes(e?.code) ? console.warn : console.error;
                                    logFn('è®€å–ä½¿ç”¨è€…ç‹€æ…‹å¿«ç…§å¤±æ•—:', e?.code, e?.message || e);
                                    recordsListEl.innerHTML = `<p class="text-center text-gray-500 p-4">æœ¬æœˆç„¡æ‰“å¡ç´€éŒ„</p>`;
                                }
                            })();
                            return;
                        }
                        
                        const records = [];
                        querySnapshot.forEach(doc => {
                            records.push({ id: doc.id, ...doc.data() });
                        });
                        
                        // å‰ç«¯æ—¥æœŸéæ¿¾èˆ‡æ™‚é–“é™åºæ’åº
                        const filtered = records.filter(r => {
                            const ts = r.timestamp?.toDate?.() || (r.timestamp ? new Date(r.timestamp) : null);
                            if (!ts) return false;
                            return ts >= startOfMonth && ts <= endOfMonth;
                        }).sort((a, b) => {
                            const timeA = a.timestamp?.toDate?.() || (a.timestamp ? new Date(a.timestamp) : new Date(0));
                            const timeB = b.timestamp?.toDate?.() || (b.timestamp ? new Date(b.timestamp) : new Date(0));
                            return timeB - timeA;
                        });
                        
                        recordsListEl.innerHTML = '';
                        filtered.forEach(record => {
                            const card = document.createElement('div');
                            card.className = 'bg-white p-3 rounded-lg shadow-sm border mb-3';
                            const statusText = getStatusDisplayText(record.type || 'æœªçŸ¥', record.locationName || null, record.dutyType || null);
                            const statusColor = getStatusColor(statusText);
                            const abnormalInfo = computeRecordAbnormal(record, state.currentUserData?.serviceCommunities || []);
                            const abnormalHtml = (abnormalInfo && abnormalInfo.isAbnormal)
                                ? `<div class="mt-1 flex items-center"><span class="px-2 py-0.5 rounded text-xs bg-red-100 text-red-700 border border-red-200">æ‰“å¡ä½ç½®ç•°å¸¸</span>${abnormalInfo.detail ? `<span class="ml-2 text-xs text-gray-500">${abnormalInfo.detail}</span>` : ''}</div>`
                                : '';
                            card.innerHTML = `
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-bold text-lg ${statusColor}">${statusText}</p>
                                        <p class="text-sm text-gray-600">${formatDate(record.timestamp)}</p>
                                        ${abnormalHtml}
                                    </div>
                                </div>
                                <div class="mt-2 flex space-x-2 overflow-x-auto">
                                    <button class="photo-btn bg-green-500 text-white px-2 py-1 rounded text-sm" 
                                        data-photos='${encodeURIComponent(JSON.stringify(record.photoUrls || []))}' 
                                        data-descriptions='${encodeURIComponent(JSON.stringify(record.descriptions || []))}'>
                                        <i data-lucide="image"></i> ç…§ç‰‡ (${(record.photoUrls?.length || 0)})
                                    </button>
                                    <button class="map-btn bg-blue-500 text-white px-2 py-1 rounded text-sm" data-lat="${record.location?.latitude || 0}" data-lng="${record.location?.longitude || 0}">
                                        <i data-lucide="map-pin"></i> åœ°åœ–
                                    </button>
                                    <button class="apply-mod-btn bg-orange-500 text-white px-2 py-1 rounded text-sm"
                                        data-id="${record.id}"
                                        data-type="${record.type || ''}"
                                        data-ts="${(record.timestamp?.toMillis ? record.timestamp.toMillis() : (record.timestamp?.seconds ? record.timestamp.seconds * 1000 : (record.timestamp ? (new Date(record.timestamp)).getTime() : Date.now())))}"
                                        data-locationname="${record.locationName || ''}">
                                        <i data-lucide="edit"></i> ç”³è«‹ä¿®æ”¹
                                    </button>
                                </div>
                            `;
                            recordsListEl.appendChild(card);
                        });
                         
                        lucide.createIcons();
                        
                        document.querySelectorAll('.map-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const lat = parseFloat(e.currentTarget.dataset.lat);
                                const lng = parseFloat(e.currentTarget.dataset.lng);
                                if (Number.isFinite(lat) && Number.isFinite(lng)) openMapModal(lat, lng);
                                else showToast("ç„¡ä½ç½®è³‡è¨Šå¯é¡¯ç¤º", true);
                            });
                        });

                        // ç”³è«‹ä¿®æ”¹æŒ‰éˆ•äº‹ä»¶ï¼ˆæäº¤è‡³ retroClockRequestsï¼Œä½¿ç”¨ä¸­æ–‡æ¬„ä½ï¼‰
                        document.querySelectorAll('.apply-mod-btn').forEach(btn => {
                            btn.addEventListener('click', async (e) => {
                                const d = e.currentTarget.dataset;
                                const tsMillis = parseInt(d.ts || '0', 10);
                                const ts = Number.isFinite(tsMillis) && tsMillis > 0 ? new Date(tsMillis) : new Date();
                                const recTypeRaw = d.type || '';
                                const recLocationName = d.locationname || '';
                                const typeMap = { clock_in: 'ä¸Šç­', clock_out: 'ä¸‹ç­', out: 'å¤–å‡º', arrive: 'æŠµé”', leave: 'é›¢é–‹', return: 'è¿”å›' };
                                const recType = typeMap[recTypeRaw] || recTypeRaw;
                                const backdrop = document.createElement('div');
                                backdrop.className = 'fixed inset-0 bg-black bg-opacity-40 z-40';
                                const modal = document.createElement('div');
                                modal.className = 'fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg p-4 z-50 w-[92%] max-w-[560px]';
                                modal.innerHTML = `
                                    <h3 class="text-lg font-bold mb-3">ç”³è«‹ä¿®æ”¹æ‰“å¡è³‡æ–™</h3>
                                    <div class="space-y-3">
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="text-sm font-medium">æ—¥æœŸ</label>
                                                <input type="date" id="mod-date" class="w-full border border-gray-300 rounded-md p-2" value="${ts.toISOString().split('T')[0]}" />
                                            </div>
                                            <div>
                                                <label class="text-sm font-medium">æ™‚é–“</label>
                                                <input type="time" id="mod-time" class="w-full border border-gray-300 rounded-md p-2" value="${String(ts.getHours()).padStart(2,'0')}:${String(ts.getMinutes()).padStart(2,'0')}" />
                                            </div>
                                        </div>
                                        <div>
                                            <label class="text-sm font-medium">é …ç›®</label>
                                            <select id="mod-type" class="w-full border border-gray-300 rounded-md p-2">
                                                <option value="ä¸Šç­" ${recType==='ä¸Šç­' ? 'selected' : ''}>ä¸Šç­</option>
                                                <option value="ä¸‹ç­" ${recType==='ä¸‹ç­' ? 'selected' : ''}>ä¸‹ç­</option>
                                                <option value="å¤–å‡º" ${recType==='å¤–å‡º' ? 'selected' : ''}>å¤–å‡º</option>
                                                <option value="æŠµé”" ${recType==='æŠµé”' ? 'selected' : ''}>æŠµé”</option>
                                                <option value="é›¢é–‹" ${recType==='é›¢é–‹' ? 'selected' : ''}>é›¢é–‹</option>
                                                <option value="è¿”å›" ${recType==='è¿”å›' ? 'selected' : ''}>è¿”å›</option>
                                            </select>
                                        </div>
                                        <div id="mod-extra" class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="text-sm font-medium">äº‹ç”±</label>
                                                <input type="text" id="mod-reason" class="w-full border border-gray-300 rounded-md p-2" placeholder="è«‹è¼¸å…¥äº‹ç”±" />
                                            </div>
                                            <div>
                                                <label class="text-sm font-medium">åœ°é»</label>
                                                <input type="text" id="mod-location" class="w-full border border-gray-300 rounded-md p-2" placeholder="è«‹è¼¸å…¥åœ°é»" value="${recLocationName}" />
                                            </div>
                                        </div>
                                        <div>
                                            <label class="text-sm font-medium">å‚™è¨»</label>
                                            <input type="text" id="mod-note" class="w-full border border-gray-300 rounded-md p-2" placeholder="è«‹å¡«å¯«ç”³è«‹åŸå› /èªªæ˜" />
                                        </div>
                                    </div>
                                    <div class="flex justify-end gap-2 mt-4">
                                        <button id="mod-cancel" class="px-3 py-2 border rounded-md">å–æ¶ˆ</button>
                                        <button id="mod-submit" class="px-3 py-2 bg-orange-600 text-white rounded-md">é€å‡ºå¯©æ ¸</button>
                                    </div>
                                `;
                                document.body.appendChild(backdrop);
                                document.body.appendChild(modal);
                                const typeSelect = modal.querySelector('#mod-type');
                                const reasonInput = modal.querySelector('#mod-reason');
                                const locInput = modal.querySelector('#mod-location');
                                const toggle = () => {
                                    const need = ['å¤–å‡º','æŠµé”','é›¢é–‹'].includes(typeSelect.value);
                                    modal.querySelector('#mod-extra').style.display = need ? 'grid' : 'none';
                                };
                                typeSelect.addEventListener('change', toggle); toggle();
                                modal.querySelector('#mod-cancel').addEventListener('click', () => { backdrop.remove(); modal.remove(); });
                                backdrop.addEventListener('click', () => { backdrop.remove(); modal.remove(); });
                                modal.querySelector('#mod-submit').addEventListener('click', async () => {
                                    try {
                                        const { addDoc, collection, Timestamp } = window.__fs; const db = window.__db; const user = window.__auth?.currentUser;
                                        if (!user) { showToast('å°šæœªç™»å…¥', true); return; }
                                        const dateStr = modal.querySelector('#mod-date').value;
                                        const timeStr = modal.querySelector('#mod-time').value;
                                        const type = typeSelect.value;
                                        const reason = (reasonInput.value || '').trim();
                                        const locationName = (locInput.value || '').trim();
                                        if (!dateStr || !timeStr) { showToast('è«‹å¡«å¯«æ—¥æœŸèˆ‡æ™‚é–“', true); return; }
                                        if (['å¤–å‡º','æŠµé”','é›¢é–‹'].includes(type) && (!reason || !locationName)) { showToast('å¤–å‡º/æŠµé”/é›¢é–‹éœ€å¡«å¯«äº‹ç”±èˆ‡åœ°é»', true); return; }
                                        const dt = new Date(`${dateStr}T${timeStr}:00`);
                                        const payload = {
                                            userId: user.uid,
                                            type,
                                            reason: reason || '',
                                            locationName: locationName || '',
                                            requestedAt: Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date(),
                                            targetTime: Timestamp?.fromDate ? Timestamp.fromDate(dt) : dt,
                                            status: 'pending'
                                        };
                                        await addDoc(collection(db, 'retroClockRequests'), payload);
                                        showToast('å·²é€å‡ºä¿®æ”¹ç”³è«‹');
                                        backdrop.remove(); modal.remove();
                                    } catch (err) {
                                        console.error('é€å‡ºç”³è«‹å¤±æ•—', err);
                                        showToast('é€å‡ºç”³è«‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', true);
                                    }
                                });
                            });
                        });
                        
                        document.querySelectorAll('.photo-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const photos = JSON.parse(decodeURIComponent(e.currentTarget.dataset.photos || '%5B%5D'));
                                const descriptions = JSON.parse(decodeURIComponent(e.currentTarget.dataset.descriptions || '%5B%5D'));
                                openPhotoModal(photos, descriptions);
                            });
                        });
                    } catch (error) {
                        const recordsListEl = document.getElementById('records-list');
                        const expectedCodes = ['permission-denied','failed-precondition','invalid-argument'];
                        if (expectedCodes.includes(error?.code)) {
                            console.warn("è®€å– clockInRecords å¤±æ•—:", error?.code, error?.message || error);
                        } else {
                            console.error("Error fetching records: ", error);
                        }
                        if (recordsListEl) {
                            (async () => {
                                try {
                                    const { doc, getDoc, collection, query, where, getDocs } = window.__fs; const db2 = window.__db;
                                    const uid = state.currentUser?.uid || window.__auth?.currentUser?.uid;
                                    if (!uid) { recordsListEl.innerHTML = `<p class="text-center text-gray-500 p-4">æœ¬æœˆç„¡æ‰“å¡ç´€éŒ„</p>`; return; }

                                    // Fallbackï¼šåƒ…ä»¥ userId è®€å–ç´€éŒ„ï¼Œå†åœ¨å‰ç«¯ä¾æœˆä»½éæ¿¾
                                    const q2 = query(collection(db2, 'clockInRecords'), where('userId', '==', uid));
                                    const snap2 = await getDocs(q2);
                                    const records = [];
                                    snap2.forEach(d => { records.push({ id: d.id, ...d.data() }); });
                                    const filtered = records.filter(r => {
                                        const ts = r.timestamp?.toDate?.() || (r.timestamp ? new Date(r.timestamp) : null);
                                        return ts && ts >= startOfMonth && ts <= endOfMonth;
                                    }).sort((a, b) => {
                                        const timeA = a.timestamp?.toDate?.() || (a.timestamp ? new Date(a.timestamp) : new Date(0));
                                        const timeB = b.timestamp?.toDate?.() || (b.timestamp ? new Date(b.timestamp) : new Date(0));
                                        return timeB - timeA;
                                    });

                                    if (filtered.length > 0) {
                                        recordsListEl.innerHTML = '';
                                        filtered.forEach(record => {
                                            const card = document.createElement('div');
                                            card.className = 'bg-white p-3 rounded-lg shadow-sm border mb-3';
                                            const statusText = getStatusDisplayText(record.type || 'æœªçŸ¥', record.locationName || null, record.dutyType || null);
                                            const statusColor = getStatusColor(statusText);
                                            const abnormalInfo = computeRecordAbnormal(record, state.currentUserData?.serviceCommunities || []);
                                            const abnormalHtml = (abnormalInfo && abnormalInfo.isAbnormal)
                                                ? `<div class="mt-1 flex items-center"><span class="px-2 py-0.5 rounded text-xs bg-red-100 text-red-700 border border-red-200">æ‰“å¡ä½ç½®ç•°å¸¸</span>${abnormalInfo.detail ? `<span class="ml-2 text-xs text-gray-500">${abnormalInfo.detail}</span>` : ''}</div>`
                                                : '';
                                            card.innerHTML = `
                                                <div class="flex justify-between items-start">
                                                    <div>
                                                        <p class="font-bold text-lg ${statusColor}">${statusText}</p>
                                                        <p class="text-sm text-gray-600">${formatDate(record.timestamp)}</p>
                                                        ${abnormalHtml}
                                                    </div>
                                                </div>
                                                <div class="mt-2 flex space-x-2 overflow-x-auto">
                                                    <button class="photo-btn bg-green-500 text-white px-2 py-1 rounded text-sm" 
                                                        data-photos='${encodeURIComponent(JSON.stringify(record.photoUrls || []))}' 
                                                        data-descriptions='${encodeURIComponent(JSON.stringify(record.descriptions || []))}'>
                                                        <i data-lucide="image"></i> ç…§ç‰‡ (${(record.photoUrls?.length || 0)})
                                                    </button>
                                                    <button class="map-btn bg-blue-500 text-white px-2 py-1 rounded text-sm" data-lat="${record.location?.latitude || 0}" data-lng="${record.location?.longitude || 0}">
                                                        <i data-lucide="map-pin"></i> åœ°åœ–
                                                    </button>
                                                    <button class="apply-mod-btn bg-orange-500 text-white px-2 py-1 rounded text-sm"
                                                        data-id="${record.id}"
                                                        data-type="${record.type || ''}"
                                                        data-ts="${(record.timestamp?.toMillis ? record.timestamp.toMillis() : (record.timestamp?.seconds ? record.timestamp.seconds * 1000 : (record.timestamp ? (new Date(record.timestamp)).getTime() : Date.now())))}"
                                                        data-locationname="${record.locationName || ''}">
                                                        <i data-lucide="edit"></i> ç”³è«‹ä¿®æ”¹
                                                    </button>
                                                </div>
                                            `;
                                            recordsListEl.appendChild(card);
                                        });
                                         
                                        try { lucide.createIcons(); } catch(e) {}
                                        document.querySelectorAll('.map-btn').forEach(btn => {
                                            btn.addEventListener('click', (e) => {
                                                const lat = parseFloat(e.currentTarget.dataset.lat);
                                                const lng = parseFloat(e.currentTarget.dataset.lng);
                                                if (Number.isFinite(lat) && Number.isFinite(lng)) openMapModal(lat, lng);
                                                else showToast("ç„¡ä½ç½®è³‡è¨Šå¯é¡¯ç¤º", true);
                                            });
                                        });
                                        
                                        document.querySelectorAll('.apply-mod-btn').forEach(btn => {
                                            btn.addEventListener('click', async (e) => {
                                                const d = e.currentTarget.dataset;
                                                const tsMillis = parseInt(d.ts || '0', 10);
                                                const ts = Number.isFinite(tsMillis) && tsMillis > 0 ? new Date(tsMillis) : new Date();
                                                const recTypeRaw = d.type || '';
                                                const recLocationName = d.locationname || '';
                                                const typeMap = { clock_in: 'ä¸Šç­', clock_out: 'ä¸‹ç­', out: 'å¤–å‡º', arrive: 'æŠµé”', leave: 'é›¢é–‹', return: 'è¿”å›' };
                                                const recType = typeMap[recTypeRaw] || recTypeRaw;
                                                const backdrop = document.createElement('div');
                                                backdrop.className = 'fixed inset-0 bg-black bg-opacity-40 z-40';
                                                const modal = document.createElement('div');
                                                modal.className = 'fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg p-4 z-50 w-[92%] max-w-[560px]';
                                                modal.innerHTML = `
                                                    <h3 class="text-lg font-bold mb-3">ç”³è«‹ä¿®æ”¹æ‰“å¡è³‡æ–™</h3>
                                                    <div class="space-y-3">
                                                        <div class="grid grid-cols-2 gap-3">
                                                            <div>
                                                                <label class="text-sm font-medium">æ—¥æœŸ</label>
                                                                <input type="date" id="mod-date" class="w-full border border-gray-300 rounded-md p-2" value="${ts.toISOString().split('T')[0]}" />
                                                            </div>
                                                            <div>
                                                                <label class="text-sm font-medium">æ™‚é–“</label>
                                                                <input type="time" id="mod-time" class="w-full border border-gray-300 rounded-md p-2" value="${String(ts.getHours()).padStart(2,'0')}:${String(ts.getMinutes()).padStart(2,'0')}" />
                                                            </div>
                                                        </div>
                                                        <div>
                                                            <label class="text-sm font-medium">é …ç›®</label>
                                                            <select id="mod-type" class="w-full border border-gray-300 rounded-md p-2">
                                                                <option value="ä¸Šç­" ${recType==='ä¸Šç­' ? 'selected' : ''}>ä¸Šç­</option>
                                                                <option value="ä¸‹ç­" ${recType==='ä¸‹ç­' ? 'selected' : ''}>ä¸‹ç­</option>
                                                                <option value="å¤–å‡º" ${recType==='å¤–å‡º' ? 'selected' : ''}>å¤–å‡º</option>
                                                                <option value="æŠµé”" ${recType==='æŠµé”' ? 'selected' : ''}>æŠµé”</option>
                                                                <option value="é›¢é–‹" ${recType==='é›¢é–‹' ? 'selected' : ''}>é›¢é–‹</option>
                                                                <option value="è¿”å›" ${recType==='è¿”å›' ? 'selected' : ''}>è¿”å›</option>
                                                            </select>
                                                        </div>
                                                        <div id="mod-extra" class="grid grid-cols-2 gap-3">
                                                            <div>
                                                                <label class="text-sm font-medium">äº‹ç”±</label>
                                                                <input type="text" id="mod-reason" class="w-full border border-gray-300 rounded-md p-2" placeholder="è«‹è¼¸å…¥äº‹ç”±" />
                                                            </div>
                                                            <div>
                                                                <label class="text-sm font-medium">åœ°é»</label>
                                                                <input type="text" id="mod-location" class="w-full border border-gray-300 rounded-md p-2" placeholder="è«‹è¼¸å…¥åœ°é»" value="${recLocationName}" />
                                                            </div>
                                                        </div>
                                                        <div>
                                                            <label class="text-sm font-medium">å‚™è¨»</label>
                                                            <input type="text" id="mod-note" class="w-full border border-gray-300 rounded-md p-2" placeholder="è«‹å¡«å¯«ç”³è«‹åŸå› /èªªæ˜" />
                                                        </div>
                                                    </div>
                                                    <div class="flex justify-end gap-2 mt-4">
                                                        <button id="mod-cancel" class="px-3 py-2 border rounded-md">å–æ¶ˆ</button>
                                                        <button id="mod-submit" class="px-3 py-2 bg-orange-600 text-white rounded-md">é€å‡ºå¯©æ ¸</button>
                                                    </div>
                                                `;
                                                document.body.appendChild(backdrop);
                                                document.body.appendChild(modal);
                                                const typeSelect = modal.querySelector('#mod-type');
                                                const reasonInput = modal.querySelector('#mod-reason');
                                                const locInput = modal.querySelector('#mod-location');
                                                const toggle = () => {
                                                    const need = ['å¤–å‡º','æŠµé”','é›¢é–‹'].includes(typeSelect.value);
                                                    modal.querySelector('#mod-extra').style.display = need ? 'grid' : 'none';
                                                };
                                                typeSelect.addEventListener('change', toggle); toggle();
                                                modal.querySelector('#mod-cancel').addEventListener('click', () => { backdrop.remove(); modal.remove(); });
                                                backdrop.addEventListener('click', () => { backdrop.remove(); modal.remove(); });
                                                modal.querySelector('#mod-submit').addEventListener('click', async () => {
                                                    try {
                                                        const { addDoc, collection, Timestamp } = window.__fs; const db = window.__db; const user = window.__auth?.currentUser;
                                                        if (!user) { showToast('å°šæœªç™»å…¥', true); return; }
                                                        const dateStr = modal.querySelector('#mod-date').value;
                                                        const timeStr = modal.querySelector('#mod-time').value;
                                                        const type = typeSelect.value;
                                                        const reason = (reasonInput.value || '').trim();
                                                        const locationName = (locInput.value || '').trim();
                                                        if (!dateStr || !timeStr) { showToast('è«‹å¡«å¯«æ—¥æœŸèˆ‡æ™‚é–“', true); return; }
                                                        if (['å¤–å‡º','æŠµé”','é›¢é–‹'].includes(type) && (!reason || !locationName)) { showToast('å¤–å‡º/æŠµé”/é›¢é–‹éœ€å¡«å¯«äº‹ç”±èˆ‡åœ°é»', true); return; }
                                                        const dt = new Date(`${dateStr}T${timeStr}:00`);
                                                        const payload = {
                                                            userId: user.uid,
                                                            type,
                                                            reason: reason || '',
                                                            locationName: locationName || '',
                                                            requestedAt: Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date(),
                                                            targetTime: Timestamp?.fromDate ? Timestamp.fromDate(dt) : dt,
                                                            status: 'pending'
                                                        };
                                                        await addDoc(collection(db, 'retroClockRequests'), payload);
                                                        showToast('å·²é€å‡ºä¿®æ”¹ç”³è«‹');
                                                        backdrop.remove(); modal.remove();
                                                    } catch (err) {
                                                        console.error('é€å‡ºç”³è«‹å¤±æ•—', err);
                                                        showToast('é€å‡ºç”³è«‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', true);
                                                    }
                                                });
                                            });
                                        });
                                        
                                        document.querySelectorAll('.photo-btn').forEach(btn => {
                                            btn.addEventListener('click', (e) => {
                                                const photos = JSON.parse(decodeURIComponent(e.currentTarget.dataset.photos || '%5B%5D'));
                                                const descriptions = JSON.parse(decodeURIComponent(e.currentTarget.dataset.descriptions || '%5B%5D'));
                                                openPhotoModal(photos, descriptions);
                                            });
                                        });
                                    } else {
                                        const userRef = doc(db2, 'users', uid);
                                        const userSnap = await getDoc(userRef);
                                        if (userSnap.exists() && userSnap.data().clockInStatus) {
                                            const u = userSnap.data();
                                            const ts = u.lastUpdated?.toDate?.() || (u.lastUpdated ? new Date(u.lastUpdated) : null);
                                            if (ts && ts >= startOfMonth && ts <= endOfMonth) {
                                                const statusText = getStatusDisplayText(u.clockInStatus, u.outboundLocation || null, u.dutyType || null);
                                                const statusColor = getStatusColor(statusText);
                                                recordsListEl.innerHTML = `
                                                    <div class="bg-white p-3 rounded-lg shadow-sm border mb-3">
                                                        <div class="flex justify-between items-start">
                                                            <div>
                                                                <p class="font-bold text-lg ${statusColor}">${statusText}</p>
                                                                <p class="text-sm text-gray-600">${ts ? formatDate(ts) : ''}</p>
                                                            </div>
                                                        </div>
                                                        <div class="mt-2 text-xs text-gray-400">ä¾†æºï¼šä½¿ç”¨è€…ç‹€æ…‹å¿«ç…§ï¼ˆclockInRecords å»ºç«‹å¤±æ•—ï¼‰</div>
                                                    </div>`;
                                                try { lucide.createIcons(); } catch(e){}
                                            } else {
                                                const hint = (error?.code === 'failed-precondition') ? 'å¯èƒ½éœ€è¦å»ºç«‹è¤‡åˆç´¢å¼•ï¼ˆuserId + timestampï¼‰ã€‚' : 'è«‹ç¢ºèª Firestore è¦å‰‡èˆ‡ç¶²è·¯ç‹€æ³ã€‚';
                                                recordsListEl.innerHTML = `<p class="text-center text-gray-500 p-4">æœ¬æœˆç„¡æ‰“å¡ç´€éŒ„ ${hint}</p>`;
                                            }
                                        } else {
                                            const hint = (error?.code === 'failed-precondition') ? 'å¯èƒ½éœ€è¦å»ºç«‹è¤‡åˆç´¢å¼•ï¼ˆuserId + timestampï¼‰ã€‚' : 'è«‹ç¢ºèª Firestore è¦å‰‡èˆ‡ç¶²è·¯ç‹€æ³ã€‚';
                                            recordsListEl.innerHTML = `<p class="text-center text-gray-500 p-4">æœ¬æœˆç„¡æ‰“å¡ç´€éŒ„ ${hint}</p>`;
                                        }
                                    }
                                } catch (e2) {
                                    const hint = (error?.code === 'failed-precondition') ? 'å¯èƒ½éœ€è¦å»ºç«‹è¤‡åˆç´¢å¼•ï¼ˆuserId + timestampï¼‰ã€‚' : 'è«‹ç¢ºèª Firestore è¦å‰‡èˆ‡ç¶²è·¯ç‹€æ³ã€‚';
                                    recordsListEl.innerHTML = `<p class="text-center text-gray-500 p-4">æœ¬æœˆç„¡æ‰“å¡ç´€éŒ„ ${hint}</p>`;
                                }
                            })();
                        }
                    }
                };

                monthInput.addEventListener('change', loadRecords);
                loadRecords();

                // æœˆå ±è¡¨ï¼šé¸æ“‡æœˆä»½å½ˆçª—
                const monthBtn = document.getElementById('open-month-report');
                monthBtn?.addEventListener('click', () => openMonthReportModal());

                function openMonthReportModal() {
                    const now = new Date();
                    const ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50';
                    modal.innerHTML = `
                        <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-md overflow-hidden">
                            <div class="px-4 py-3 bg-indigo-600 text-white flex items-center justify-between">
                                <h3 class="font-semibold">é¸æ“‡æœˆä»½</h3>
                                <button class="close-month-modal">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <div class="p-4 space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">æœˆä»½</label>
                                    <input type="month" id="month-input" value="${ym}" class="w-full border border-gray-300 rounded-md px-3 py-2">
                                </div>
                                <div class="flex justify-end space-x-2">
                                    <button class="close-month-modal px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">å–æ¶ˆ</button>
                                    <button id="gen-month-report" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">ç”Ÿæˆæœˆå ±è¡¨</button>
                                </div>
                            </div>
                        </div>`;
                    document.body.appendChild(modal);
                    try { lucide.createIcons(); } catch(e) {}
                    modal.querySelectorAll('.close-month-modal').forEach(btn => btn.addEventListener('click', () => document.body.removeChild(modal)));
                    document.getElementById('gen-month-report').addEventListener('click', async () => {
                        const mi = document.getElementById('month-input').value;
                        if (!mi) { showToast('è«‹é¸æ“‡æœˆä»½', true); return; }
                        document.body.removeChild(modal);
                        await generateMonthlyReport(mi);
                    });
                }

                async function generateMonthlyReport(ymStr) {
                    // ymStr: YYYY-MM
                    const [yearStr, monthStr] = ymStr.split('-');
                    const year = parseInt(yearStr, 10); const monthIndex = parseInt(monthStr, 10) - 1; // 0-based
                    const start = new Date(year, monthIndex, 1, 0, 0, 0, 0);
                    const end = new Date(year, monthIndex + 1, 0, 23, 59, 59, 999);

                    // è®€å–è©²æœˆæ‰“å¡ç´€éŒ„ï¼ˆæœ¬äººï¼‰
                    const { collection, where, query, getDocs, Timestamp } = window.__fs; const db = window.__db;
                    const startTS = Timestamp?.fromDate ? Timestamp.fromDate(new Date(year, monthIndex, 1)) : start;
                    const endTS = Timestamp?.fromDate ? Timestamp.fromDate(new Date(year, monthIndex + 1, 0, 23, 59, 59, 999)) : end;
                    const q = query(
                        collection(db, 'clockInRecords'),
                        where('userId', '==', state.currentUser.uid),
                        where('timestamp', '>=', startTS),
                        where('timestamp', '<=', endTS)
                    );
                    const snap = await getDocs(q);
                    const allRecords = [];
                    snap.forEach(d => allRecords.push({ id: d.id, ...d.data() }));

                    // è«‹å‡è³‡æ–™ï¼ˆè¦†è“‹è©²æœˆä»»ä½•ä¸€å¤©ï¼‰
                    let leaves = [];
                    try {
                        const lq = query(collection(db, 'leaves'), where('userId','==', state.currentUser.uid));
                        const ls = await getDocs(lq);
                        ls.forEach(doc => leaves.push({ id: doc.id, ...doc.data() }));
                    } catch(e) { console.warn('è®€å–è«‹å‡å¤±æ•—', e); }

                    // ç‰¹æ®Šå‹¤å‹™ï¼ˆå€¼ç­ï¼‰è³‡æ–™
                    let duties = [];
                    try {
                        const dq = query(collection(db, 'specialDuties'), where('userId','==', state.currentUser.uid));
                        const ds = await getDocs(dq);
                        ds.forEach(doc => duties.push({ id: doc.id, ...doc.data() }));
                    } catch(e) { console.warn('è®€å–ç‰¹æ®Šå‹¤å‹™å¤±æ•—', e); }

                    // è®€å–é€±äº”å€¼ç­åå–®ï¼ˆè¨­å®šï¼‰ï¼Œç”¨æ–¼åˆ¤æ–·æœ¬äººçš„å€¼ç­æ—¥
                    let fridayDutyRoster = {};
                    try {
                        const { doc, getDoc } = window.__fs || {};
                        if (doc && getDoc && db) {
                            const settingsRef = doc(db, 'settings', 'general');
                            const settingsSnap = await getDoc(settingsRef);
                            fridayDutyRoster = settingsSnap.exists() ? (settingsSnap.data().fridayDutyRoster || {}) : {};
                        }
                    } catch (e) { console.warn('è®€å–å€¼ç­åå–®å¤±æ•—', e); }

                    // è®€å–æœ¬æœˆæ’ç­è³‡æ–™ï¼ˆç”¨æ–¼åˆ¤æ–·æ˜¯å¦ç‚ºæ’ç­æ—¥ï¼Œé¿å…èª¤æ¨™ã€Œæ’ä¼‘ã€ï¼‰
                    let schedulesByDate = {};
                    try {
                        const sq = query(
                            collection(db, 'postSchedules'),
                            where('dateTS', '>=', startTS),
                            where('dateTS', '<=', endTS)
                        );
                        const ss = await getDocs(sq);
                        ss.forEach(doc => {
                            const data = doc.data();
                            const di = data.dateIso;
                            if (!di) return;
                            if (!schedulesByDate[di]) schedulesByDate[di] = [];
                            schedulesByDate[di].push(data);
                        });
                    } catch(e) { console.warn('è®€å–æ’ç­è³‡æ–™å¤±æ•—', e); }

                    // å·¥å…·ï¼šåˆ¤æ–·æŸæ—¥æ˜¯å¦ç‚ºæœ¬äººæ’ç­æˆ–å…¨é«”æ’ç­æ—¥
                    const hasScheduleForUser = (dateIso) => {
                        const docs = schedulesByDate[dateIso];
                        if (!Array.isArray(docs) || docs.length === 0) return false;
                        const uid = state.currentUser?.uid || '';
                        const myName = (state.currentUserData?.name || state.currentUser?.displayName || state.currentUser?.email || '').trim();
                        const norm = (s) => (s || '').trim();
                        return docs.some(sd => {
                            if (sd?.isScheduledDay === true) return true; // è©²æ—¥æ•´é«”æ’ç­
                            const shifts = Array.isArray(sd?.shifts) ? sd.shifts : [];
                            return shifts.some(s => {
                                if (!s) return false;
                                if (typeof s === 'string') return norm(s) === myName;
                                if (typeof s === 'object') return (norm(s.name) === myName) || (norm(s.assigneeName) === myName) || (s.userId === uid) || (s.assigneeId === uid);
                                return false;
                            });
                        });
                    };

                    // æº–å‚™åˆ—å°å®¹å™¨
                    const old = document.getElementById('monthly-report-container');
                    if (old) old.remove();
                    const container = document.createElement('div');
                    container.id = 'monthly-report-container';
                    container.className = 'fixed inset-0 z-50 bg-white';
                    const name = state.currentUserData?.name || state.currentUser.displayName || state.currentUser.email || '';
                    const ymTag = `${year}-${String(monthIndex+1).padStart(2,'0')}`;
                    const titleText = `${ymTag}å‡ºå‹¤ç´€éŒ„-${name}`;
                    container.innerHTML = `
                        <div class="bg-white w-full h-full flex flex-col">
                            <div class="px-4 py-3 bg-indigo-600 text-white flex items-center justify-between shrink-0">
                                <h3 class="font-semibold">${titleText}</h3>
                                <div class="space-x-2">
                                    <button id="print-month-report" class="px-3 py-1.5 bg-white text-indigo-700 rounded hover:bg-gray-100">åˆ—å°</button>
                                    <button id="close-month-report" class="px-3 py-1.5 bg-white text-indigo-700 rounded hover:bg-gray-100">é—œé–‰</button>
                                </div>
                            </div>
                            <div class="p-4 flex-1 overflow-auto">
                                <div id="month-report-content" class="mx-auto" style="width:190mm">
                                    <div id="month-report-inner" style="transform-origin: top left;">
                                        <h2 class="text-xl font-bold mb-2 text-center">${titleText}</h2>
                                        <table class="w-full border border-gray-300 text-sm">
                                            <thead>
                                                <tr class="bg-gray-100">
                                                    <th class="border px-2 py-1">æ—¥æœŸ</th>
                                                    <th class="border px-2 py-1">æ˜ŸæœŸ</th>
                                                    <th class="border px-2 py-1">ä¸Šç­æ‰“å¡æ™‚é–“</th>
                                                    <th class="border px-2 py-1">ä¸‹ç­æ‰“å¡æ™‚é–“</th>
                                                    <th class="border px-2 py-1">ç¸½æ™‚æ•¸</th>
                                                    <th class="border px-2 py-1">å‚™è¨»</th>
                                                </tr>
                                            </thead>
                                            <tbody id="month-report-body"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    document.body.appendChild(container);

                    // å¡«å……è¡¨æ ¼
                    const weekdayZh = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
                    const bodyEl = container.querySelector('#month-report-body');
                    const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
                    for (let d = 1; d <= daysInMonth; d++) {
                        const dayStart = new Date(year, monthIndex, d, 0, 0, 0, 0);
                        const dayEnd = new Date(year, monthIndex, d, 23, 59, 59, 999);
                        const w = dayStart.getDay();
                        const dateLabel = `${year}-${String(monthIndex+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;

                        const records = allRecords.filter(r => {
                            const ts = r.timestamp?.toDate?.() || (r.timestamp ? new Date(r.timestamp) : null);
                            if (!ts) return false;
                            return ts >= dayStart && ts <= dayEnd;
                        }).sort((a,b) => {
                            const ta = a.timestamp?.toDate?.() || (a.timestamp ? new Date(a.timestamp) : new Date(0));
                            const tb = b.timestamp?.toDate?.() || (b.timestamp ? new Date(b.timestamp) : new Date(0));
                            return ta - tb;
                        });

                        // ä¸Šç­ç‹€æ…‹/æ™‚é–“ï¼šå„ªå…ˆã€Œä¸Šç­ã€ï¼Œè‹¥ç„¡å‰‡å–ç¬¬ä¸€å€‹ã€Œå¤–å‡ºã€
                        let startRecord = records.find(r => (r.type === 'ä¸Šç­')) || records.find(r => (r.type === 'å¤–å‡º')) || null;
                        const isEndType = (r) => {
                            const t = r?.type || '';
                            return t === 'ä¸‹ç­' || (typeof t === 'string' && t.includes('ä¸‹ç­')) || r?.auto === true || r?.autoClockOut === true || r?.isAuto === true;
                        };
                        let endRecord = records.slice().reverse().find(isEndType) || null;
                        const fmt = (dt) => dt ? `${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}` : '';
                        const startTime = startRecord ? (startRecord.timestamp?.toDate?.() || new Date(startRecord.timestamp)) : null;
                        const endTime = endRecord ? (endRecord.timestamp?.toDate?.() || new Date(endRecord.timestamp)) : null;
                        const startText = startTime ? fmt(startTime) : '';
                        const endText = endTime ? fmt(endTime) : '';

                        // ç¸½æ™‚æ•¸
                        let totalHours = '';
                        if (startTime && endTime && endTime > startTime) {
                            const diffMs = endTime - startTime;
                            totalHours = (diffMs / 3600000).toFixed(2);
                        }


                        // æŒ‡ç¤ºæ¨™è¨»ï¼šä¾ç­è¡¨èˆ‡è«‹å‡ä¾†åˆ¤æ–·ã€Œæ’ä¼‘ã€ï¼Œä¸å†ä»¥é€±æœ«æˆ–ä½¿ç”¨è€…å·¥ä½œæ—¥è¨­å®šåˆ¤æ–·ã€‚
                        // è¦å‰‡ï¼šç•¶æ—¥æœªæ’ç­ã€æœªè«‹å‡ã€äº¦éå€¼ç­ï¼ˆç‰¹æ®Šå‹¤å‹™/é€±äº”å€¼ç­åå–®ï¼‰ï¼Œæ¨™ç¤ºã€Œæ’ä¼‘ã€ã€‚
                        // é¡å¤–è¦å‰‡ï¼šå‚™è¨»åƒ…åœ¨ã€Œç•¶æ—¥ä¹‹å‰ï¼ˆå«ç•¶æ—¥ï¼‰ã€é¡¯ç¤ºï¼Œæ˜å¤©ä»¥å¾Œä¸é¡¯ç¤ºã€‚
                        let indicators = [];
                        const nowForReport = new Date();
                        const todayEndForReport = new Date(nowForReport.getFullYear(), nowForReport.getMonth(), nowForReport.getDate(), 23, 59, 59, 999);
                        const isFutureDayForNotes = dayStart > todayEndForReport;
                        const nextDay = new Date(dayStart); nextDay.setDate(nextDay.getDate()+1);
                        if (!isFutureDayForNotes) {
                            // å€¼ç­åˆ¤å®šï¼ˆç‰¹æ®Šå‹¤å‹™æˆ–åœ¨é€±äº”å€¼ç­åå–®å…§ï¼‰
                            const isDutyBySpecial = duties.some(di => {
                                const s = di.startTime?.toDate?.() || (di.startTime ? new Date(di.startTime) : null);
                                const e = di.endTime?.toDate?.() || (di.endTime ? new Date(di.endTime) : null);
                                if (!s || !e) return false;
                                return s < nextDay && e > dayStart;
                            });
                            const myName = state.currentUserData?.name || state.currentUser.displayName || state.currentUser.email || '';
                            const rosterNamesForDay = fridayDutyRoster[dateLabel] || [];
                            const normalizeName = (s) => (s || '').trim();
                            const isRosterDuty = Array.isArray(rosterNamesForDay) && rosterNamesForDay.some(n => normalizeName(n) === normalizeName(myName));
                            const isDuty = isDutyBySpecial || isRosterDuty;
                            const scheduled = hasScheduleForUser(dateLabel);
                            const hasAnyRecord = records.length > 0;
                            // è«‹å‡æ—¥ï¼ˆæ™‚é–“ç¯„åœç›¸äº¤ï¼‰
                            const isLeave = leaves.some(l => {
                                const s = l.startTime?.toDate?.() || (l.startTime ? new Date(l.startTime) : null);
                                const e = l.endTime?.toDate?.() || (l.endTime ? new Date(l.endTime) : null);
                                if (!s || !e) return false;
                                return s < nextDay && e > dayStart; // overlap
                            });
                            if (!scheduled && !isLeave && !isDuty && !hasAnyRecord) {
                                indicators.push('æ’ä¼‘');
                            }
                            if (isLeave) {
                                indicators.push('è«‹å‡');
                            }
                        }
                        

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td class="border px-2 py-1">${dateLabel}</td>
                            <td class="border px-2 py-1">${weekdayZh[w]}</td>
                            <td class="border px-2 py-1">${startText}</td>
                            <td class="border px-2 py-1">${endText}</td>
                            <td class="border px-2 py-1">${totalHours}</td>
                            <td class="border px-2 py-1">${indicators.join('ã€')}</td>`;
                        bodyEl.appendChild(tr);
                    }

                    // æ³¨å…¥åˆ—å°æ¨£å¼ï¼ˆA4ã€é ä¸Šå°é½Šã€æ°´å¹³ç½®ä¸­ï¼Œåƒ…é¡¯ç¤ºå ±è¡¨å…§å®¹ï¼‰
                    if (!document.getElementById('monthly-report-print-style')) {
                        const style = document.createElement('style');
                        style.id = 'monthly-report-print-style';
                        style.textContent = `
                        @page { size: A4; margin: 10mm; }
                        @media print {
                            body { -webkit-print-color-adjust: exact; }
                            body > * { display: none !important; }
                            #monthly-report-container { display: block !important; position: static !important; }
                            #monthly-report-container .px-4.py-3.bg-indigo-600 { display: none !important; }
                            #monthly-report-container .p-4.flex-1 { padding: 0 !important; }
                            #month-report-content { width: 190mm !important; margin: 0 auto !important; }
                            table { border-collapse: collapse; }
                            th, td { font-size: 11px; line-height: 1.2; padding: 2px 4px; }
                        }
                        `;
                        document.head.appendChild(style);
                    }

                    container.querySelector('#close-month-report').addEventListener('click', () => container.remove());
                    container.querySelector('#print-month-report').addEventListener('click', () => {
                        window.print();
                    });
                    // å·²å–æ¶ˆ PDF åŒ¯å‡ºåŠŸèƒ½
                }
            }

            async function initClockInMap() {
                const mapLoader = document.getElementById('map-loader');
                const mapDiv = document.getElementById('map');
                if(!mapDiv || !mapLoader) return;
                
                mapLoader.classList.remove('hide');
                state.currentLocation = null;
                
                // Geolocation requires secure context in modern browsers
                if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                    console.warn('éå®‰å…¨ä¾†æºï¼Œå¯èƒ½å°è‡´ geolocation æˆ–åœ°åœ–ç„¡æ³•ä½¿ç”¨');
                    const tip = document.createElement('div');
                    tip.className = 'p-2 text-yellow-700 text-xs';
                    tip.textContent = 'æç¤ºï¼šè«‹ä»¥ https æˆ– localhost é–‹å•Ÿä»¥ä½¿ç”¨å®šä½åŠŸèƒ½';
                    mapDiv.parentElement?.insertBefore(tip, mapDiv);
                }

                if (!window.google || !window.google.maps) {
                    setTimeout(initClockInMap, 100);
                    return;
                }
                
                try {
                    const pos = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, { 
                            enableHighAccuracy: true, 
                            timeout: 10000, 
                            maximumAge: 0 
                        });
                    });
                    
                    const coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    state.currentLocation = coords;
                    
                    if (mapDiv.offsetWidth === 0 || mapDiv.offsetHeight === 0) {
                        mapDiv.style.width = '100%';
                        mapDiv.style.height = '300px';
                    }
                    
                    const map = new google.maps.Map(mapDiv, { 
                        center: coords, 
                        zoom: 17, 
                        disableDefaultUI: true 
                    });
                    
                    new google.maps.Marker({ 
                        position: coords, 
                        map: map 
                    });
                    
                    mapLoader.classList.add('hide');
                } catch (error) {
                    console.error("åˆå§‹åŒ–åœ°åœ–æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                    mapDiv.innerHTML = `<div class="p-4 text-center text-red-500">ç„¡æ³•å–å¾—æ‚¨çš„ä½ç½®ã€‚è«‹ç¢ºèªå·²é–‹å•Ÿå®šä½æœå‹™ã€‚</div>`;
                    mapLoader.classList.add('hide');
                    showToast("ç„¡æ³•å–å¾—ä½ç½®è³‡è¨Šï¼Œè«‹ç¢ºèªå·²é–‹å•Ÿå®šä½æœå‹™", true);
                }
            }
            
            function renderTracking(subPage, params = {}) {
                const role = state.currentUserData?.role || '';
                mainContent.innerHTML = `
                    <div class="h-[50px] flex items-center justify-around border-b border-gray-200 bg-white">
                        <button data-subtab="map" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'map' || !subPage ? 'active' : ''}">äººå“¡åœ°åœ–</button>
                        <button data-subtab="attendance" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'attendance' ? 'active' : ''}">å‡ºå‹¤ç´€éŒ„</button>
                        <button data-subtab="leave" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'leave' ? 'active' : ''}">å‡å–®å¯©æ ¸</button>
                    </div>
                    <div id="sub-page-content" class="overflow-y-auto" style="height: calc(100% - 50px);"></div>`;
                
                const subPageContent = document.getElementById('sub-page-content');
                if (subPage === 'attendance') {
                    renderTrackingAttendanceSchedule(subPageContent, params);
                } else if (subPage === 'leave') {
                    renderTrackingLeave(subPageContent);
                } else {
                    renderTrackingMap(subPageContent);
                }
                
                mainContent.querySelectorAll('.sub-tab-btn').forEach(btn => btn.addEventListener('click', () => showPage('tracking', btn.dataset.subtab)));
            }

            // è£œæ‰“å¡ç”³è«‹è¡¨å–®
            function renderRetroClockRequestForm(container) {
                const todayStr = new Date().toISOString().split('T')[0];
                container.innerHTML = `
                    <div class="p-4 h-full">
                        <div class="bg-white rounded-lg shadow-sm border p-4 space-y-4">
                            <h2 class="text-lg font-bold">è£œæ‰“å¡ç”³è«‹</h2>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">æ—¥æœŸ</label>
                                    <input type="date" id="retro-date" value="${todayStr}" class="w-full border border-gray-300 rounded-md p-2" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">æ™‚é–“</label>
                                    <input type="time" id="retro-time" class="w-full border border-gray-300 rounded-md p-2" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">é …ç›®</label>
                                    <select id="retro-type" class="w-full border border-gray-300 rounded-md p-2">
                                        <option value="ä¸Šç­">ä¸Šç­</option>
                                        <option value="ä¸‹ç­">ä¸‹ç­</option>
                                        <option value="å¤–å‡º">å¤–å‡º</option>
                                        <option value="æŠµé”">æŠµé”</option>
                                        <option value="é›¢é–‹">é›¢é–‹</option>
                                        <option value="è¿”å›">è¿”å›</option>
                                    </select>
                                </div>
                            </div>
                            <div id="retro-extra" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">äº‹ç”±</label>
                                    <input type="text" id="retro-reason" placeholder="è«‹è¼¸å…¥äº‹ç”±" class="w-full border border-gray-300 rounded-md p-2" />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">åœ°é»</label>
                                    <input type="text" id="retro-location" placeholder="è«‹è¼¸å…¥åœ°é»" class="w-full border border-gray-300 rounded-md p-2" />
                                </div>
                            </div>
                            <div class="flex justify-end space-x-2">
                                <button id="retro-submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">é€å‡ºç”³è«‹</button>
                            </div>
                        </div>
                        <div id="retro-submit-status" class="mt-3 text-sm text-gray-500"></div>
                        <div class="mt-4 bg-white rounded-lg shadow-sm border p-4">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="font-bold">æˆ‘çš„ç”³è«‹åˆ—è¡¨</h3>
                                <span class="text-sm text-gray-500">é¡¯ç¤ºæœ¬äººå·²æäº¤è£œæ‰“å¡</span>
                            </div>
                            <div id="my-retro-list" class="space-y-3"></div>
                        </div>
                    </div>`;
                try { lucide.createIcons(); } catch (e) {}
                const typeEl = document.getElementById('retro-type');
                const reasonEl = document.getElementById('retro-reason');
                const locEl = document.getElementById('retro-location');
                const toggleExtra = () => {
                    const t = typeEl.value;
                    const needExtra = ['å¤–å‡º','æŠµé”','é›¢é–‹'].includes(t);
                    reasonEl.parentElement.style.display = needExtra ? 'block' : 'none';
                    locEl.parentElement.style.display = needExtra ? 'block' : 'none';
                };
                typeEl.addEventListener('change', toggleExtra);
                toggleExtra();

                document.getElementById('retro-submit').addEventListener('click', async () => {
                    const dateStr = document.getElementById('retro-date').value;
                    const timeStr = document.getElementById('retro-time').value;
                    const type = typeEl.value;
                    const reason = reasonEl.value.trim();
                    const locationName = locEl.value.trim();
                    if (!dateStr || !timeStr) { showToast('è«‹å¡«å¯«æ—¥æœŸèˆ‡æ™‚é–“', true); return; }
                    if (['å¤–å‡º','æŠµé”','é›¢é–‹'].includes(type)) {
                        if (!reason || !locationName) { showToast('å¤–å‡º/æŠµé”/é›¢é–‹éœ€å¡«å¯«äº‹ç”±èˆ‡åœ°é»', true); return; }
                    }
                    const dt = new Date(`${dateStr}T${timeStr}:00`);
                    const { addDoc, collection, Timestamp } = window.__fs; const db = window.__db; const user = window.__auth?.currentUser;
                    if (!user) { showToast('å°šæœªç™»å…¥', true); return; }
                    const payload = {
                        userId: user.uid,
                        type,
                        reason: reason || '',
                        locationName: locationName || '',
                        requestedAt: Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date(),
                        targetTime: Timestamp?.fromDate ? Timestamp.fromDate(dt) : dt,
                        status: 'pending'
                    };
                    try {
                        await addDoc(collection(db, 'retroClockRequests'), payload);
                        showToast('å·²é€å‡ºè£œæ‰“å¡ç”³è«‹');
                        document.getElementById('retro-submit-status').textContent = 'ç”³è«‹å·²é€å‡ºï¼Œå¾…ç®¡ç†å“¡å¯©æ ¸';
                        try { await renderMyRetroRequests(); } catch (e) {}
                    } catch (e) {
                        console.error('é€å‡ºè£œæ‰“å¡ç”³è«‹å¤±æ•—', e);
                        showToast('é€å‡ºç”³è«‹å¤±æ•—', true);
                    }
                });

                // æˆ‘çš„ç”³è«‹åˆ—è¡¨ï¼ˆæœ¬äººï¼‰
                async function renderMyRetroRequests() {
                    const listEl = document.getElementById('my-retro-list');
                    if (!listEl) return;
                    listEl.innerHTML = `<div class="p-2 text-center text-gray-500"><div class="flex items-center justify-center"><i data-lucide="loader" class="w-4 h-4 mr-2 animate-spin"></i>è¼‰å…¥ä¸­...</div></div>`;
                    try {
                        const { collection, query, where, orderBy, getDocs } = window.__fs; const db = window.__db; const user = window.__auth?.currentUser;
                        if (!user) { listEl.innerHTML = '<p class="text-sm text-red-600">è«‹å…ˆç™»å…¥</p>'; return; }
                        const qs = await getDocs(query(collection(db, 'retroClockRequests'), where('userId','==', user.uid), orderBy('requestedAt', 'desc')));
                        if (qs.empty) { listEl.innerHTML = '<p class="text-sm text-gray-500">å°šç„¡ç”³è«‹</p>'; return; }
                        listEl.innerHTML = '';
                        qs.forEach(docSnap => {
                            const r = { id: docSnap.id, ...docSnap.data() };
                            const when = r.targetTime?.toDate?.() ? r.targetTime.toDate() : (r.targetTime ? new Date(r.targetTime) : null);
                            const item = document.createElement('div');
                            item.className = 'p-3 border rounded-md bg-white flex items-center justify-between';
                            item.innerHTML = `
                                <div>
                                    <p class=\"font-medium text-gray-800\">${r.type}</p>
                                    <p class=\"text-sm text-gray-600\">${when ? when.toLocaleString('zh-TW', { hour12: false }) : ''}</p>
                                    ${r.locationName ? `<p class=\"text-xs text-gray-500\">åœ°é»ï¼š${r.locationName}</p>` : ''}
                                    ${r.reason ? `<p class=\"text-xs text-gray-500\">äº‹ç”±ï¼š${r.reason}</p>` : ''}
                                </div>
                                <span class=\"text-sm ${r.status==='approved' ? 'text-green-600' : (r.status==='rejected' ? 'text-red-600' : 'text-gray-500')}\">${r.status || 'pending'}</span>`;
                            listEl.appendChild(item);
                        });
                    } catch (e) {
                        console.error('è¼‰å…¥ç”³è«‹åˆ—è¡¨å¤±æ•—', e);
                        listEl.innerHTML = '<p class="text-sm text-red-600">è¼‰å…¥å¤±æ•—</p>';
                    } finally { try { lucide.createIcons(); } catch(e) {} }
                }
                try { renderMyRetroRequests(); } catch(e) {}
            }

            // è£œæ‰“ç”³è«‹å¯©æ ¸é é¢
            /* async function renderRetroApprovals(container) {
                container.innerHTML = `
                    <div class="p-4 h-full">
                        <div class="bg-white rounded-lg shadow-sm border p-4">
                            <div class="flex items-center justify-between mb-3">
                                <h2 class="text-lg font-bold">è£œæ‰“ç”³è«‹å¯©æ ¸</h2>
                                <button id="manual-add-record" class="px-3 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">æ–°å¢äººå“¡æ‰“å¡ç´€éŒ„</button>
                            </div>
                            <div class="mb-3 flex items-center gap-2">
                                <input type="date" id="retro-filter-date" class="border border-gray-300 rounded-md p-2">
                                <select id="retro-filter-user" class="border border-gray-300 rounded-md p-2 min-w-[180px]">
                                    <option value="">å…¨éƒ¨äººå“¡</option>
                                </select>
                            </div>
                            <div id="retro-requests-list" class="space-y-3"></div>
                        </div>
                    </div>`;
                try { lucide.createIcons(); } catch(e) {}
                const { collection, query, where, orderBy, getDocs, addDoc, updateDoc, doc, Timestamp, GeoPoint } = window.__fs; const db = window.__db;
                const listEl = document.getElementById('retro-requests-list');
                const filterDateEl = document.getElementById('retro-filter-date');
                const filterUserEl = document.getElementById('retro-filter-user');

                // è¼‰å…¥äººå“¡ä¸‹æ‹‰
                try {
                    const us = await getDocs(collection(db, 'users'));
                    us.forEach(d => {
                        const opt = document.createElement('option');
                        opt.value = d.id; opt.textContent = d.data().name || d.id;
                        filterUserEl.appendChild(opt);
                    });
                } catch(e) {}

                async function renderList() {
                    listEl.innerHTML = `<div class="p-4 text-center text-gray-500"><div class="flex items-center justify-center"><i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i>è¼‰å…¥ç”³è«‹...</div></div>`;
                    try {
                        const qs = await getDocs(query(collection(db, 'retroClockRequests'), where('status','==','pending'), orderBy('requestedAt','desc')));
                        const selectedUser = filterUserEl.value || '';
                        const selectedDate = filterDateEl.value || '';
                        const items = [];
                        qs.forEach(docSnap => {
                            const req = { id: docSnap.id, ...docSnap.data() };
                            const when = req.targetTime?.toDate?.() ? req.targetTime.toDate() : (req.targetTime ? new Date(req.targetTime) : null);
                            const dateStr = when ? when.toISOString().split('T')[0] : '';
                            if (selectedUser && req.userId !== selectedUser) return;
                            if (selectedDate && dateStr !== selectedDate) return;
                            items.push({ ...req, when });
                        });
                        if (items.length === 0) { listEl.innerHTML = `<p class="text-center text-gray-500 p-4">ç„¡ç¬¦åˆæ¢ä»¶çš„ç”³è«‹</p>`; return; }
                        // è¼‰å…¥ä½¿ç”¨è€…åç¨±æ˜ å°„
                        const userMap = {};
                        try {
                            const us = await getDocs(collection(db, 'users'));
                            us.forEach(d => userMap[d.id] = d.data().name || d.id);
                        } catch(e) {}
                        listEl.innerHTML = '';
                        items.forEach(req => {
                            const userName = userMap[req.userId] || req.userId;
                            const item = document.createElement('div');
                            item.className = 'p-3 border rounded-md bg-white flex items-center justify-between';
                            item.innerHTML = `
                                <div>
                                    <p class=\"font-medium text-gray-800\">${userName}</p>
                                    <p class=\"text-sm text-gray-600\">${req.type} Â· ${req.when ? req.when.toLocaleString('zh-TW', { hour12: false }) : ''}</p>
                                    ${req.locationName ? `<p class=\"text-xs text-gray-500\">åœ°é»ï¼š${req.locationName}</p>` : ''}
                                    ${req.reason ? `<p class=\"text-xs text-gray-500\">äº‹ç”±ï¼š${req.reason}</p>` : ''}
                                </div>
                                <div class=\"flex items-center space-x-2\">
                                    <button class=\"approve-btn px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700\" data-id=\"${req.id}\">åŒæ„</button>
                                    <button class=\"reject-btn px-3 py-2 bg-red-600 text-white rounded-md hover:bg-red-700\" data-id=\"${req.id}\">ä¸åŒæ„</button>
                                </div>`;
                            listEl.appendChild(item);
                        });
                        try { lucide.createIcons(); } catch(e) {}
                        // ç¶å®šäº‹ä»¶
                        const canReview = await (window.checkReviewerStatus ? window.checkReviewerStatus() : (window.checkAdminStatus ? window.checkAdminStatus() : Promise.resolve(false)));
                        const handleApprove = async (id) => {
                            if (!canReview) { showToast('åƒ…ç®¡ç†å“¡/äººäº‹/é«˜éšä¸»ç®¡å¯å¯©æ ¸', true); return; }
                            try {
                                const reqDoc = await window.__fs.getDoc(window.__fs.doc(db, 'retroClockRequests', id));
                                if (!reqDoc.exists()) { showToast('ç”³è«‹ä¸å­˜åœ¨', true); return; }
                                const r = reqDoc.data();
                                const ts = r.targetTime?.toDate?.() ? r.targetTime.toDate() : (r.targetTime ? new Date(r.targetTime) : new Date());
                                await addDoc(collection(db, 'clockInRecords'), {
                                    userId: r.userId,
                                    type: r.type,
                                    timestamp: Timestamp?.fromDate ? Timestamp.fromDate(ts) : ts,
                                    location: GeoPoint ? new GeoPoint(0,0) : { latitude: 0, longitude: 0 },
                                    photoUrls: [],
                                    descriptions: [],
                                    deviceId: 'retro',
                                    locationName: r.locationName || null,
                                    dutyType: null,
                                    isAutomatic: false
                                });
                                // åŒæ­¥æ›´æ–° users ç‹€æ…‹ï¼Œè®“å„€éŒ¶æ¿èˆ‡å®šä½æ‰“å¡æŒ‰éˆ•æ­£ç¢ºé¡¯ç¤º
                                try {
                                    const newStatus = r.type; // å¯èƒ½ç‚ºï¼šä¸Šç­/ä¸‹ç­/å¤–å‡º/æŠµé”/é›¢é–‹/è¿”å›
                                    const updatePayload = {
                                        status: newStatus,
                                        clockInStatus: newStatus,
                                        lastUpdated: Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()
                                    };
                                    // æ ¸å‡†ã€Œä¸Šç­ã€è£œæ‰“å¡æ™‚ï¼Œæ›´æ–° lastClockInTime ä¾›æ’åºèˆ‡é¡¯ç¤º
                                    if (newStatus === 'ä¸Šç­') {
                                        updatePayload.lastClockInTime = Timestamp?.fromDate ? Timestamp.fromDate(ts) : ts;
                                    }
                                    // å¤–å‡º/æŠµé”/é›¢é–‹å¯æ›´æ–°å¤–å‡ºåœ°é»æ–‡å­—ï¼ˆè‹¥æœ‰ï¼‰
                                    if (newStatus === 'å¤–å‡º' || newStatus === 'æŠµé”' || newStatus === 'é›¢é–‹') {
                                        updatePayload.outboundLocation = r.locationName || '';
                                    }
                                    await updateDoc(doc(db, 'users', r.userId), updatePayload);
                                } catch (e) {
                                    console.warn('æ›´æ–°ä½¿ç”¨è€…ç‹€æ…‹å¤±æ•—ï¼ˆå·²æ–°å¢æ‰“å¡ç´€éŒ„ï¼Œä½† users ç‹€æ…‹æœªåŒæ­¥ï¼‰', e);
                                }
                                await updateDoc(doc(db, 'retroClockRequests', id), {
                                    status: 'approved',
                                    reviewerId: window.__auth?.currentUser?.uid || null,
                                    reviewedAt: Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()
                                });
                                showToast('å·²æ ¸å‡†ä¸¦æ–°å¢æ‰“å¡ç´€éŒ„');
                                renderList();
                            } catch (e) {
                                console.error('æ ¸å‡†å¤±æ•—', e);
                                showToast('æ ¸å‡†å¤±æ•—', true);
                            }
                        };
                        const handleReject = async (id) => {
                            if (!canReview) { showToast('åƒ…ç®¡ç†å“¡/äººäº‹/é«˜éšä¸»ç®¡å¯å¯©æ ¸', true); return; }
                            try {
                                await updateDoc(doc(db, 'retroClockRequests', id), {
                                    status: 'rejected',
                                    reviewerId: window.__auth?.currentUser?.uid || null,
                                    reviewedAt: Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()
                                });
                                showToast('å·²é€€å›ç”³è«‹');
                                renderList();
                            } catch (e) {
                                console.error('é€€å›å¤±æ•—', e);
                                showToast('é€€å›å¤±æ•—', true);
                            }
                        };
                        container.querySelectorAll('.approve-btn').forEach(btn => btn.addEventListener('click', (e) => handleApprove(e.currentTarget.dataset.id)));
                        container.querySelectorAll('.reject-btn').forEach(btn => btn.addEventListener('click', (e) => handleReject(e.currentTarget.dataset.id)));
                    } catch (e) {
                        console.error('è®€å–è£œæ‰“ç”³è«‹å¤±æ•—', e);
                        listEl.innerHTML = `<p class="text-center text-gray-500 p-4">è®€å–å¤±æ•—</p>`;
                    }
                }

                filterDateEl.addEventListener('change', renderList);
                filterUserEl.addEventListener('change', renderList);

                // æ‰‹å‹•æ–°å¢äººå“¡æ‰“å¡ç´€éŒ„ï¼ˆå½ˆçª—ï¼‰
                document.getElementById('manual-add-record').addEventListener('click', () => {
                    const backdrop = document.createElement('div');
                    backdrop.className = 'fixed inset-0 bg-black bg-opacity-40 z-40';
                    const modal = document.createElement('div');
                    modal.className = 'fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg p-4 z-50 w-[90%] max-w-[520px]';
                    modal.innerHTML = `
                        <h3 class=\"text-lg font-bold mb-3\">æ–°å¢äººå“¡æ‰“å¡ç´€éŒ„</h3>
                        <div class=\"space-y-3\">
                            <div>
                                <label class=\"text-sm font-medium\">äººå“¡å§“å</label>
                                <select id=\"manual-user\" class=\"w-full border border-gray-300 rounded-md p-2\"></select>
                            </div>
                            <div class=\"grid grid-cols-2 gap-3\">
                                <div>
                                    <label class=\"text-sm font-medium\">æ—¥æœŸ</label>
                                    <input type=\"date\" id=\"manual-date\" class=\"w-full border border-gray-300 rounded-md p-2\" />
                                </div>
                                <div>
                                    <label class=\"text-sm font-medium\">æ™‚é–“</label>
                                    <input type=\"time\" id=\"manual-time\" class=\"w-full border border-gray-300 rounded-md p-2\" />
                                </div>
                            </div>
                            <div>
                                <label class=\"text-sm font-medium\">é …ç›®</label>
                                <select id=\"manual-type\" class=\"w-full border border-gray-300 rounded-md p-2\">
                                    <option value=\"ä¸Šç­\">ä¸Šç­</option>
                                    <option value=\"ä¸‹ç­\">ä¸‹ç­</option>
                                    <option value=\"å¤–å‡º\">å¤–å‡º</option>
                                    <option value=\"æŠµé”\">æŠµé”</option>
                                    <option value=\"é›¢é–‹\">é›¢é–‹</option>
                                    <option value=\"è¿”å›\">è¿”å›</option>
                                </select>
                            </div>
                            <div id=\"manual-extra\" class=\"grid grid-cols-2 gap-3\">
                                <div>
                                    <label class=\"text-sm font-medium\">äº‹ç”±</label>
                                    <input type=\"text\" id=\"manual-reason\" class=\"w-full border border-gray-300 rounded-md p-2\" placeholder=\"è«‹è¼¸å…¥äº‹ç”±\" />
                                </div>
                                <div>
                                    <label class=\"text-sm font-medium\">åœ°é»</label>
                                    <input type=\"text\" id=\"manual-location\" class=\"w-full border border-gray-300 rounded-md p-2\" placeholder=\"è«‹è¼¸å…¥åœ°é»\" />
                                </div>
                            </div>
                        </div>
                        <div class=\"flex justify-end gap-2 mt-4\">
                            <button id=\"manual-cancel\" class=\"px-3 py-2 border rounded-md\">å–æ¶ˆ</button>
                            <button id=\"manual-submit\" class=\"px-3 py-2 bg-indigo-600 text-white rounded-md\">æ–°å¢</button>
                        </div>
                    `;
                    document.body.appendChild(backdrop);
                    document.body.appendChild(modal);
                    // å¡«å…¥äººå“¡
                    filterUserEl.querySelectorAll('option').forEach(opt => {
                        if (!opt.value) return;
                        const o = document.createElement('option'); o.value = opt.value; o.textContent = opt.textContent;
                        modal.querySelector('#manual-user').appendChild(o);
                    });
                    const typeSelect = modal.querySelector('#manual-type');
                    const reasonInput = modal.querySelector('#manual-reason');
                    const locInput = modal.querySelector('#manual-location');
                    const toggle = () => {
                        const need = ['å¤–å‡º','æŠµé”','é›¢é–‹'].includes(typeSelect.value);
                        modal.querySelector('#manual-extra').style.display = need ? 'grid' : 'none';
                    };
                    typeSelect.addEventListener('change', toggle); toggle();
                    modal.querySelector('#manual-cancel').addEventListener('click', () => { backdrop.remove(); modal.remove(); });
                    backdrop.addEventListener('click', () => { backdrop.remove(); modal.remove(); });
                    modal.querySelector('#manual-submit').addEventListener('click', async () => {
                        try {
                            const userId = modal.querySelector('#manual-user').value;
                            const dateStr = modal.querySelector('#manual-date').value;
                            const timeStr = modal.querySelector('#manual-time').value;
                            const type = typeSelect.value;
                            const reason = (reasonInput.value || '').trim();
                            const locationName = (locInput.value || '').trim();
                            if (!userId || !dateStr || !timeStr) { showToast('è«‹å®Œæ•´å¡«å¯«äººå“¡èˆ‡æ—¥æœŸæ™‚é–“', true); return; }
                            if (['å¤–å‡º','æŠµé”','é›¢é–‹'].includes(type) && (!reason || !locationName)) { showToast('å¤–å‡º/æŠµé”/é›¢é–‹éœ€å¡«å¯«äº‹ç”±èˆ‡åœ°é»', true); return; }
                            const tsDate = new Date(`${dateStr}T${timeStr}:00`);
                            await addDoc(collection(db, 'clockInRecords'), {
                                userId,
                                type,
                                timestamp: Timestamp?.fromDate ? Timestamp.fromDate(tsDate) : tsDate,
                                location: GeoPoint ? new GeoPoint(0,0) : { latitude: 0, longitude: 0 },
                                photoUrls: [],
                                descriptions: [],
                                deviceId: 'manual-admin',
                                locationName: ['å¤–å‡º','æŠµé”','é›¢é–‹'].includes(type) ? `${locationName}${reason ? 'ï½œ'+reason : ''}` : (locationName || null),
                                dutyType: null,
                                isAutomatic: false
                            });
                            // åŒæ­¥ä½¿ç”¨è€…æ–‡ä»¶çš„ç‹€æ…‹ï¼Œè®“å„€è¡¨æ¿å³æ™‚é¡¯ç¤º
                            try {
                                const userUpdate = {
                                    status: type,
                                    clockInStatus: type,
                                    lastUpdated: Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date(),
                                    outboundLocation: ['å¤–å‡º','æŠµé”','é›¢é–‹'].includes(type) ? `${locationName}${reason ? 'ï½œ'+reason : ''}` : null,
                                    dutyType: null
                                };
                                if (type === 'ä¸Šç­') {
                                    userUpdate.lastClockInTime = Timestamp?.fromDate ? Timestamp.fromDate(tsDate) : tsDate;
                                }
                                await updateDoc(doc(db, 'users', userId), userUpdate);
                            } catch (uerr) {
                                console.warn('æ›´æ–°ä½¿ç”¨è€…ç‹€æ…‹å¤±æ•—ï¼ˆéè‡´å‘½ï¼‰', uerr);
                            }
                            if (typeof updateDashboardStatus === 'function') {
                                try { updateDashboardStatus(); } catch {}
                            }
                            showToast('å·²æ–°å¢æ‰“å¡ç´€éŒ„');
                            backdrop.remove(); modal.remove();
                        } catch (err) {
                            console.error('æ–°å¢æ‰“å¡å¤±æ•—', err);
                            showToast('æ–°å¢å¤±æ•—', true);
                        }
                    });
                });

                await renderList();
            } */

            // äººå“¡åˆ†é ï¼šå¸³è™Ÿç”³è«‹ã€å¸³è™Ÿåˆ—è¡¨ï¼ˆå„ç¤¾å€ç¨ç«‹å…§å®¹ï¼‰
            function renderHR(subPage) {
                const role = state.currentUserData?.role || '';
                // ä¾éœ€æ±‚ï¼šäººå“¡é åªæä¾›å¸³è™Ÿç”³è«‹ã€å¸³è™Ÿåˆ—è¡¨
                mainContent.innerHTML = `
                    <div class="h-[50px] flex items-center justify-around border-b border-gray-200 bg-white">
                        <button data-subtab="applications" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'applications' ? 'active' : ''}">å¸³è™Ÿç”³è«‹</button>
                        <button data-subtab="accounts" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'accounts' ? 'active' : ''}">å¸³è™Ÿåˆ—è¡¨</button>
                    </div>
                    <div id="sub-page-content" class="overflow-y-auto" style="height: calc(100% - 50px);"></div>`;

                const subPageContent = document.getElementById('sub-page-content');
                if (subPage === 'accounts') {
                    renderSettingsAccounts(subPageContent);
                } else {
                    renderSettingsApplications(subPageContent);
                }
                mainContent.querySelectorAll('.sub-tab-btn').forEach(btn => btn.addEventListener('click', () => showPage('hr', btn.dataset.subtab)));
            }

            // ç¾¤çµ„åˆ†é ï¼šäººå“¡åœ°åœ–ã€å‡ºå‹¤ç´€éŒ„ï¼ˆåƒ…é¡¯ç¤ºæŒ‡å®šæˆå“¡ï¼‰
            function renderGroup(subPage) {
                // ç¾¤çµ„åˆ†é èˆ‡å·¡é‚åŠŸèƒ½å·²åœç”¨
                mainContent.innerHTML = `
                    <div class="p-8 flex items-center justify-center h-full">
                        <div class="text-center text-gray-500">
                            <i data-lucide="alert-triangle" class="w-8 h-8 mx-auto mb-3"></i>
                            <div>æ­¤åˆ†é å·²åœç”¨</div>
                        </div>
                    </div>`;
                try { lucide.createIcons(); } catch (_) {}
            }

            function renderShifts(subPage) {
                const comm = state.currentCommunity;
                if (!comm || !comm.id) {
                    mainContent.innerHTML = `
                        <div class="p-8 flex items-center justify-center h-full">
                            <div class="text-center text-gray-500">
                                <i data-lucide="home" class="w-8 h-8 mx-auto mb-3"></i>
                                <div>è«‹å…ˆé¸æ“‡ç¤¾å€å¾Œå†é€²å…¥æ’ç­é </div>
                            </div>
                        </div>`;
                    try { lucide.createIcons(); } catch (_) {}
                    return;
                }
                const communityId = comm.id;

                const pageState = {
                    posts: [],
                    selectedPostId: null,
                    monthDate: new Date(new Date().getFullYear(), new Date().getMonth(), 1),
                    monthDocsMap: {},
                    selectedDayIso: null,
                    roleFilter: null
                };

                const fmtYMD = (d) => {
                    const y = d.getFullYear();
                    const m = (d.getMonth()+1).toString().padStart(2,'0');
                    const day = d.getDate().toString().padStart(2,'0');
                    return `${y}-${m}-${day}`;
                };
                const parseHM = (s) => {
                    const [h,m] = (s||'00:00').split(':').map(x=>parseInt(x,10)||0);
                    return h*60+m;
                };
                const mergeIntervalsMinutes = (list) => {
                    if (!Array.isArray(list) || !list.length) return [];
                    const intervals = list.map(it => ({start: parseHM(it.start||'00:00'), end: parseHM(it.end||'00:00')}))
                        .filter(it => it.end>it.start)
                        .sort((a,b)=>a.start-b.start);
                    const merged = [];
                    for (const iv of intervals) {
                        if (!merged.length || iv.start > merged[merged.length-1].end) {
                            merged.push({start: iv.start, end: iv.end});
                        } else {
                            merged[merged.length-1].end = Math.max(merged[merged.length-1].end, iv.end);
                        }
                    }
                    return merged;
                };
                const hasOverlap = (list) => {
                    const intervals = list.map(it => ({start: parseHM(it.start||'00:00'), end: parseHM(it.end||'00:00')}))
                        .filter(it => it.end>it.start)
                        .sort((a,b)=>a.start-b.start);
                    for (let i=1;i<intervals.length;i++) {
                        if (intervals[i].start < intervals[i-1].end) return true;
                    }
                    return false;
                };
                const coverageMinutes = (list) => {
                    const merged = mergeIntervalsMinutes(list);
                    return merged.reduce((acc,iv)=>acc+(iv.end-iv.start),0);
                };

                // æ’ç­ç•°å¸¸é‚è¼¯å·²ç§»é™¤

                const renderShell = () => {
                    mainContent.innerHTML = `
                        <div class="h-[50px] flex items-center justify-between border-b border-gray-200 bg-white px-3">
                            <div id="shift-summary" class="flex items-center gap-2 flex-wrap">
                                <button class="px-2 py-1 text-xs rounded-md bg-amber-500 text-white" data-role="ç¸½å¹¹äº‹"><span id="count-gm">ç¸½å¹¹äº‹ï¼š0</span></button>
                                <button class="px-2 py-1 text-xs rounded-md bg-purple-500 text-white" data-role="ç§˜æ›¸"><span id="count-sec">ç§˜æ›¸ï¼š0</span></button>
                                <button class="px-2 py-1 text-xs rounded-md bg-green-700 text-white" data-role="ä¿å…¨"><span id="count-guard">ä¿å…¨ï¼š0</span></button>
                                <button class="px-2 py-1 text-xs rounded-md bg-pink-500 text-white" data-role="æ¸…æ½”"><span id="count-clean">æ¸…æ½”ï¼š0</span></button>
                                <button class="px-2 py-1 text-xs rounded-md bg-blue-500 text-white" data-role="æ©Ÿé›»"><span id="count-mech">æ©Ÿé›»ï¼š0</span></button>
                            </div>
                        </div>
                        <div class="overflow-y-auto" style="height: calc(100% - 50px);">
                            <div id="calendar-sticky" class="sticky top-0 z-10 bg-white" style="height: 50%;">
                                <div class="p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <button id="prev-month" class="px-3 py-1 rounded border bg-white text-gray-700 hover:bg-gray-50">ä¸Šå€‹æœˆ</button>
                                        <div id="shift-current-month-year" class="text-lg font-semibold"></div>
                                        <button id="next-month" class="px-3 py-1 rounded border bg-white text-gray-700 hover:bg-gray-50">ä¸‹å€‹æœˆ</button>
                                    </div>
                                    <div class="grid grid-cols-7 text-center text-xs text-gray-500 mb-1">
                                        <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
                                    </div>
                                    <div id="shift-calendar-grid" class="grid grid-cols-7 gap-1"></div>
                                </div>
                            </div>
                            <div class="p-3">
                                    <div class="flex items-center justify-between mt-1 flex-nowrap">
                                        <div class="flex items-center gap-2">
                                            <div id="shift-list-title" class="text-xs font-medium whitespace-nowrap">æ¯æœˆç­è¡¨åˆ—è¡¨</div>
                                        </div>
                                        <div class="flex items-center gap-1 whitespace-nowrap">
                                            <button id="export-csv" class="px-2 py-1 text-xs rounded border bg-white text-gray-700 hover:bg-gray-50">åŒ¯å‡ºCSV</button>
                                            <button id="import-csv" class="px-2 py-1 text-xs rounded border bg-white text-gray-700 hover:bg-gray-50">åŒ¯å…¥CSV</button>
                                            <button id="open-add-schedule" class="px-2 py-1 text-xs rounded bg-red-600 text-white hover:bg-red-700">æ–°å¢æ’ç­</button>
                                            <button id="delete-schedule" class="px-2 py-1 text-xs rounded bg-rose-600 text-white hover:bg-rose-700">åˆªé™¤</button>
                                            <input id="import-csv-input" type="file" accept=".csv,text/csv" class="hidden">
                                        </div>
                                    </div>
                                <div id="shift-monthly-list" class="mt-2"></div>
                            </div>
                        </div>`;
                    try { lucide.createIcons(); } catch (_) {}
                    // ç¶å®šè§’è‰²éæ¿¾æŒ‰éˆ•
                    const summaryEl = document.getElementById('shift-summary');
                    const updateRoleButtonsActive = () => {
                        if (!summaryEl) return;
                        summaryEl.querySelectorAll('button[data-role]').forEach(b => {
                            const r = b.getAttribute('data-role');
                            const active = (pageState.roleFilter === r);
                            b.classList.toggle('ring-2', active);
                            b.classList.toggle('ring-offset-1', active);
                            b.classList.toggle('opacity-80', !active && pageState.roleFilter !== null);
                        });
                    };
                    if (summaryEl) {
                        summaryEl.querySelectorAll('button[data-role]').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const role = btn.getAttribute('data-role');
                                pageState.roleFilter = (pageState.roleFilter === role) ? null : role;
                                updateRoleButtonsActive();
                                renderCalendar();
                                renderMonthlyList();
                            });
                        });
                        updateRoleButtonsActive();
                    }
                };

                const loadPosts = async () => {
                    try {
                        const qref = collection(db, 'communities', communityId, 'posts');
                        const snap = await getDocs(qref);
                        pageState.posts = [];
                        snap.forEach(d=> pageState.posts.push({ id: d.id, ...d.data() }));
                        if (!pageState.posts.length) {
                            // åˆæ¬¡ç„¡å“¨é»ï¼šå»ºç«‹ä¸€å€‹é è¨­å“¨é»
                            const defaultName = 'å“¨é» A';
                            const newDoc = await addDoc(collection(db,'communities', communityId, 'posts'), {
                                communityId,
                                name: defaultName,
                                createdAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()),
                                updatedAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date())
                            });
                            pageState.posts.push({ id: newDoc.id, communityId, name: defaultName });
                        }
                        pageState.posts.sort((a,b)=> (a.createdAt?.toMillis?.()||0) - (b.createdAt?.toMillis?.()||0));
                        pageState.selectedPostId = pageState.selectedPostId || pageState.posts[0]?.id || null;
                        updateCounts();
                    } catch (e) {
                        console.warn('è¼‰å…¥å“¨é»å¤±æ•—', e);
                        pageState.posts = [];
                        updateCounts();
                    }
                };

                const ALL_POSTS_ID = '__ALL__';
                const renderTabs = () => {
                    const tabsEl = document.getElementById('posts-tabs');
                    if (!tabsEl) return;
                    tabsEl.innerHTML = [
                        // èšåˆåˆ†é ï¼ˆæ‰€æœ‰å“¨é»ï¼‰
                        `<button class="px-3 py-1 rounded-md text-sm font-medium ${pageState.selectedPostId===ALL_POSTS_ID? 'bg-red-600 text-white':'bg-white text-gray-700 border'}" data-post="${ALL_POSTS_ID}" title="æ‰€æœ‰å“¨é»">å…¨éƒ¨</button>`,
                        ...pageState.posts.map((p,i)=>`
                            <button class="px-3 py-1 rounded-md text-sm font-medium ${pageState.selectedPostId===p.id? 'bg-red-600 text-white':'bg-white text-gray-700 border'}" data-post="${p.id}" title="${p.name||'æœªå‘½åå“¨é»'}">
                                <span class="text-gray-500 mr-1">${i+1}</span>
                                <span class="post-name">${p.name||'æœªå‘½åå“¨é»'}</span>
                                <span class="ml-2 text-gray-400 hover:text-red-600 delete-post" title="åˆªé™¤">Ã—</span>
                            </button>
                        `),
                        `<button class="px-3 py-1 rounded-md text-sm font-medium bg-white text-gray-700 border" data-action="add" title="æ–°å¢å“¨é»">ï¼‹</button>`
                    ].join('');
                    // åˆ‡æ›å“¨é»
                    tabsEl.querySelectorAll('button[data-post]').forEach(btn=>{
                        btn.addEventListener('click', ()=>{
                            pageState.selectedPostId = btn.getAttribute('data-post');
                            // åˆå§‹åŒ–å“¨é»ç¯©é¸ç‹€æ…‹ï¼šåˆ‡åˆ°ã€Œå…¨éƒ¨ã€æ™‚é è¨­é¡¯ç¤ºå…¨éƒ¨ï¼Œå…¶å®ƒåˆ†é å–æ¶ˆç¯©é¸
                            if (pageState.selectedPostId === ALL_POSTS_ID) {
                                pageState.postFilterId = ALL_POSTS_ID;
                            } else {
                                pageState.postFilterId = null;
                            }
                            renderTabs();
                            renderPostTitle();
                            loadMonth().then(()=> { renderCalendar(); });
                        });
                        // ç›´è¦ºå¼é‡å‘½åï¼ˆé›™æ“Šï¼‰
                        btn.addEventListener('dblclick', ()=>{
                            const postId = btn.getAttribute('data-post');
                            if (postId !== ALL_POSTS_ID) startRenameTab(btn, postId);
                        });
                        // åˆªé™¤å“¨é»
                        const del = btn.querySelector('.delete-post');
                        if (del) del.addEventListener('click', async (e)=>{
                            e.stopPropagation();
                            const postId = btn.getAttribute('data-post');
                            await handleDeletePost(postId);
                        });
                    });

                    async function handleDeletePost(postId) {
                        if (!postId) return;
                        if (!confirm('ç¢ºå®šåˆªé™¤è©²å“¨é»åŠå…¶ç­è¡¨ï¼Ÿ')) return;
                        try {
                            // åˆªé™¤å“¨é»æ¨¡æ¿ï¼ˆè‹¥ä»å­˜åœ¨ï¼‰
                            const tplSnap = await getDocs(collection(db,'communities', communityId, 'posts', postId, 'templates'));
                            await Promise.all(tplSnap.docs.map(d=> deleteDoc(doc(db,'communities', communityId, 'posts', postId, 'templates', d.id))));
                            // åˆªé™¤è©²å“¨é»æ‰€æœ‰ç­è¡¨
                            const schedSnap = await getDocs(query(collection(db,'communities', communityId, 'postSchedules'), where('postId','==', postId)));
                            await Promise.all(schedSnap.docs.map(d=> deleteDoc(doc(db,'communities', communityId, 'postSchedules', d.id))));
                            // åˆªé™¤å“¨é»æ–‡ä»¶
                            await deleteDoc(doc(db,'communities', communityId, 'posts', postId));
                            // æ›´æ–°æœ¬åœ°ç‹€æ…‹
                            pageState.posts = pageState.posts.filter(p=> p.id !== postId);
                            if (pageState.selectedPostId === postId) pageState.selectedPostId = pageState.posts[0]?.id || null;
                            updateCounts();
                            renderTabs();
                            await loadMonth();
                            renderCalendar();
                            renderDayPanel();
                            showToast('å“¨é»å·²åˆªé™¤');
                        } catch (e) { showToast('åˆªé™¤å“¨é»å¤±æ•—', true); }
                    }
                    // ä½¿ç”¨ã€Œï¼‹ã€å­åˆ†é æ–°å¢å“¨é»
                    const plusBtn = tabsEl.querySelector('button[data-action="add"]');
                    if (plusBtn) plusBtn.addEventListener('click', async ()=>{
                        try {
                            const defaultName = 'æœªå‘½åå“¨é»';
                            const newDoc = await addDoc(collection(db,'communities', communityId, 'posts'), {
                                communityId,
                                name: defaultName,
                                createdAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()),
                                updatedAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date())
                            });
                            pageState.posts.push({ id: newDoc.id, communityId, name: defaultName });
                            pageState.selectedPostId = newDoc.id;
                            updateCounts();
                            renderTabs();
                            // è‡ªå‹•é€²å…¥é‡å‘½åæ¨¡å¼
                            const newTab = tabsEl.querySelector(`button[data-post="${newDoc.id}"]`);
                            if (newTab) startRenameTab(newTab, newDoc.id);
                            await loadMonth();
                            renderCalendar();
                        } catch (e) { showToast('æ–°å¢å“¨é»å¤±æ•—', true); }
                    });

                    function startRenameTab(btn, postId) {
                        const nameEl = btn.querySelector('.post-name');
                        const current = nameEl ? nameEl.textContent : '';
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.value = current;
                        input.className = 'px-2 py-1 text-sm border rounded';
                        btn.innerHTML = '';
                        btn.appendChild(input);
                        input.focus();
                        // é˜²æ­¢é»æ“Šè¼¸å…¥æ¡†è§¸ç™¼åˆ‡æ›äº‹ä»¶
                        input.addEventListener('click', (e)=> e.stopPropagation());

                        const commit = async (val) => {
                            const newName = (val || '').trim();
                            if (newName && newName !== current) {
                                try {
                                    await updateDoc(doc(db,'communities', communityId, 'posts', postId), {
                                        name: newName,
                                        updatedAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date())
                                    });
                                    const p = pageState.posts.find(p=>p.id===postId);
                                    if (p) p.name = newName;
                                } catch (e) { showToast('é‡å‘½åå¤±æ•—', true); }
                            }
                            renderTabs();
                        };

                        input.addEventListener('keydown', (e)=>{
                            if (e.key === 'Enter') commit(input.value);
                            else if (e.key === 'Escape') renderTabs();
                        });
                        input.addEventListener('blur', ()=> commit(input.value));
                    }
                };

                const renderPostTitle = () => {
                    const el = document.getElementById('post-title');
                    if (!el) return;
                    if (pageState.selectedPostId === '__ALL__') {
                        el.innerHTML = `<span id="post-title-text">æ‰€æœ‰å“¨é»ï¼ˆèšåˆï¼‰</span>`;
                    } else {
                        const current = pageState.posts.find(p=>p.id===pageState.selectedPostId) || pageState.posts[0] || null;
                        const name = current?.name || 'æœªå‘½åå“¨é»';
                        el.innerHTML = `<span id="post-title-text" class="cursor-pointer">${name}</span>`;
                        const span = document.getElementById('post-title-text');
                        if (span) {
                            span.addEventListener('dblclick', ()=> startRenameTitle(el, current?.id));
                        }
                    }
                };

                function startRenameTitle(container, postId) {
                    if (!container || !postId) return;
                    const current = (container.textContent || '').trim();
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = current;
                    input.className = 'px-2 py-1 text-sm border rounded';
                    container.innerHTML = '';
                    container.appendChild(input);
                    input.focus();
                    const commit = async (val) => {
                        const newName = (val || '').trim();
                        if (newName && newName !== current) {
                            try {
                                await updateDoc(doc(db,'communities', communityId, 'posts', postId), {
                                    name: newName,
                                    updatedAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date())
                                });
                                const p = pageState.posts.find(p=>p.id===postId);
                                if (p) p.name = newName;
                            } catch (e) { showToast('é‡å‘½åå¤±æ•—', true); }
                        }
                        renderTabs();
                        renderPostTitle();
                    };
                    input.addEventListener('keydown', (e)=>{
                        if (e.key === 'Enter') commit(input.value);
                        else if (e.key === 'Escape') renderPostTitle();
                    });
                    input.addEventListener('blur', ()=> commit(input.value));
                }

                const renderMonthHeader = () => {
                    const title = document.getElementById('shift-current-month-year');
                    if (!title) return;
                    const d = pageState.monthDate;
                    title.textContent = `${d.getFullYear()} å¹´ ${d.getMonth()+1} æœˆ`;
                    const prev = document.getElementById('prev-month');
                    const next = document.getElementById('next-month');
                    // ä½¿ç”¨ onclick å–ä»£ addEventListenerï¼Œé¿å…é‡è¤‡ç¶å®šå°è‡´æœˆä»½éŒ¯äº‚
                    if (prev) prev.onclick = ()=>{ pageState.monthDate = new Date(pageState.monthDate.getFullYear(), pageState.monthDate.getMonth()-1, 1); loadMonth().then(()=>{ renderMonthHeader(); renderCalendar(); renderMonthlyList(); }); };
                    if (next) next.onclick = ()=>{ pageState.monthDate = new Date(pageState.monthDate.getFullYear(), pageState.monthDate.getMonth()+1, 1); loadMonth().then(()=>{ renderMonthHeader(); renderCalendar(); renderMonthlyList(); }); };
                };

                const updateCounts = () => {
                    const list = (pageState.communityUsers || []);
                    const counts = { 'ç¸½å¹¹äº‹': 0, 'ç§˜æ›¸': 0, 'ä¿å…¨': 0, 'æ¸…æ½”': 0, 'æ©Ÿé›»': 0 };
                    const allowedRoles = new Set(Object.keys(counts));
                    for (const u of list) {
                        const roleTag = (u.role || '').trim();
                        const titleTag = ((u.jobTitle || u.applicationTitle || '') + '').trim();
                        const eff = allowedRoles.has(roleTag) ? roleTag : (allowedRoles.has(titleTag) ? titleTag : null);
                        if (eff) counts[eff] += 1;
                    }
                    const gmEl = document.getElementById('count-gm');
                    const secEl = document.getElementById('count-sec');
                    const guardEl = document.getElementById('count-guard');
                    const cleanEl = document.getElementById('count-clean');
                    const mechEl = document.getElementById('count-mech');
                    if (gmEl) gmEl.textContent = `ç¸½å¹¹äº‹ï¼š${counts['ç¸½å¹¹äº‹']}`;
                    if (secEl) secEl.textContent = `ç§˜æ›¸ï¼š${counts['ç§˜æ›¸']}`;
                    if (guardEl) guardEl.textContent = `ä¿å…¨ï¼š${counts['ä¿å…¨']}`;
                    if (cleanEl) cleanEl.textContent = `æ¸…æ½”ï¼š${counts['æ¸…æ½”']}`;
                    if (mechEl) mechEl.textContent = `æ©Ÿé›»ï¼š${counts['æ©Ÿé›»']}`;
                    // ä¾äººæ•¸ç¦ç”¨/æ·¡åŒ–è§’è‰²æŒ‰éˆ•
                    const summaryEl = document.getElementById('shift-summary');
                    if (summaryEl) {
                        summaryEl.querySelectorAll('button[data-role]').forEach(btn => {
                            const r = btn.getAttribute('data-role') || '';
                            const c = counts[r] || 0;
                            if (c <= 0) {
                                btn.setAttribute('disabled','true');
                                btn.classList.add('opacity-50','cursor-not-allowed');
                            } else {
                                btn.removeAttribute('disabled');
                                btn.classList.remove('opacity-50','cursor-not-allowed');
                            }
                        });
                    }
                };

                const loadMonth = async () => {
                    pageState.monthDocsMap = {};
                    try {
                        const coll = collection(db,'communities', communityId, 'postSchedules');
                        const y = pageState.monthDate.getFullYear();
                        const m = pageState.monthDate.getMonth()+1; const ymStr = `${y}-${m.toString().padStart(2,'0')}-`;
                        let snap;
                        if (pageState.selectedPostId && pageState.selectedPostId !== '__ALL__') {
                            snap = await getDocs(query(coll, where('postId','==', pageState.selectedPostId)));
                        } else {
                            snap = await getDocs(coll);
                        }
                        const nameMap = {};
                        (pageState.posts || []).forEach(p => { nameMap[p.id] = p.name || 'æœªå‘½åå“¨é»'; });
                        snap.forEach(d=>{
                            const data = d.data() || {};
                            const iso = (data.dateIso || '').toString();
                            if (!iso.startsWith(ymStr)) return;
                            if (pageState.selectedPostId === '__ALL__') {
                                const target = pageState.monthDocsMap[iso] || { shifts: [], isScheduledDay: false };
                                const shifts = Array.isArray(data.shifts) ? data.shifts : [];
                                shifts.forEach((s, idx) => {
                                    target.shifts.push({ ...s, __postId: data.postId, __docId: d.id, __origIndex: idx, __postName: nameMap[data.postId] || 'æœªå‘½åå“¨é»' });
                                });
                                target.isScheduledDay = target.isScheduledDay || !!data.isScheduledDay;
                                pageState.monthDocsMap[iso] = target;
                            } else {
                                pageState.monthDocsMap[iso] = { id: d.id, ...data };
                            }
                        });
                    } catch (e) { console.warn('è¼‰å…¥ç­è¡¨å¤±æ•—', e); }
                };

                const loadCommunityUsers = async () => {
                    try {
                        const users = [];
                        const communityCode = (comm && (comm.code || comm.communityCode)) ? (comm.code || comm.communityCode) : communityId;
                        const queries = [
                            query(collection(db,'users'), where('serviceCommunityCode','==', communityId)),
                            query(collection(db,'users'), where('serviceCommunityCode','==', communityCode)),
                            query(collection(db,'users'), where('serviceCommunityCodes','array-contains', communityId)),
                            query(collection(db,'users'), where('serviceCommunityCodes','array-contains', communityCode)),
                            // å…¼å®¹èˆŠæ¬„ä½ï¼šserviceCommunitiesï¼ˆä»¥ç¤¾å€ä»£ç¢¼ç‚ºå…ƒç´ ï¼‰
                            query(collection(db,'users'), where('serviceCommunities','array-contains', communityId)),
                            query(collection(db,'users'), where('serviceCommunities','array-contains', communityCode)),
                        ];
                        for (const q of queries) {
                            try {
                                const s = await getDocs(q);
                                s.forEach(d=> { if (!users.find(u=>u.id===d.id)) users.push({ id: d.id, ...d.data() }); });
                            } catch (_) {}
                        }
                        // åƒ…ä¾å„ç¤¾å€å¸³è™Ÿåˆ—è¡¨è§’è‰²ï¼ˆç¸½å¹¹äº‹ã€ç§˜æ›¸ã€ä¿å…¨ã€æ¸…æ½”ã€æ©Ÿé›»ï¼‰ï¼ŒåŒæ™‚æ”¯æ´ jobTitle/applicationTitle
                        const allowedRoles = new Set(['ç¸½å¹¹äº‹','ç§˜æ›¸','ä¿å…¨','æ¸…æ½”','æ©Ÿé›»']);
                        const filtered = users
                            .filter(u => {
                                const roleTag = (u.role || '').trim();
                                const titleTag = ((u.jobTitle || u.applicationTitle || '') + '').trim();
                                return allowedRoles.has(roleTag) || allowedRoles.has(titleTag);
                            })
                            .sort((a,b)=> (a.name||'').localeCompare(b.name||''));
                        pageState.communityUsers = filtered;
                        pageState.userOptionsHTML = filtered.map(u=>`<option value="${u.id}">${u.name||u.displayName||u.id}</option>`).join('');
                    } catch (e) { console.warn('è¼‰å…¥ç¤¾å€æˆå“¡å¤±æ•—', e); pageState.communityUsers = []; pageState.userOptionsHTML = ''; }
                    updateCounts();
                };

                const renderCalendar = () => {
                    const grid = document.getElementById('shift-calendar-grid');
                    if (!grid) return;
                    const year = pageState.monthDate.getFullYear();
                    const month = pageState.monthDate.getMonth();
                    const firstDay = new Date(year, month, 1);
                    const startWeekday = firstDay.getDay();
                    const daysInMonth = new Date(year, month+1, 0).getDate();
                    const prevMonthDays = new Date(year, month, 0).getDate();
                    const cells = [];
                    const selectedIso = pageState.selectedDayIso || fmtYMD(new Date());
                    // Previous month fillers
                    for (let i=startWeekday-1; i>=0; i--) {
                        const date = new Date(year, month-1, prevMonthDays - i);
                        cells.push({ date, inMonth:false });
                    }
                    // Current month
                    for (let d=1; d<=daysInMonth; d++) {
                        const date = new Date(year, month, d);
                        cells.push({ date, inMonth:true });
                    }
                    // Fill to 6 weeks
                    const totalCells = Math.ceil(cells.length/7)*7;
                    const nextFill = totalCells - cells.length;
                    for (let i=1; i<=nextFill; i++) {
                        const date = new Date(year, month+1, i);
                        cells.push({ date, inMonth:false });
                    }
                    grid.innerHTML = cells.map(cell => {
                        const iso = fmtYMD(cell.date);
                        const todayIso = fmtYMD(new Date());
                        const docData = pageState.monthDocsMap[iso];
                        let shifts = Array.isArray(docData?.shifts) ? docData.shifts : [];
                        // åœ¨ã€Œå…¨éƒ¨ã€åˆ†é ä¸”é¸äº†å“¨é»ç¯©é¸æ™‚ï¼š
                        // - å…¨éƒ¨ï¼šä¿ç•™æ‰€æœ‰ç­è¡¨
                        // - ç„¡ï¼šåƒ…é¡¯ç¤ºéä¿å…¨è§’è‰²
                        // - æŒ‡å®šå“¨é»ï¼šåƒ…é¡¯ç¤ºè©²å“¨é»ä¿å…¨ç­è¡¨
                        if (pageState.selectedPostId === ALL_POSTS_ID && pageState.postFilterId) {
                            if (pageState.postFilterId === ALL_POSTS_ID) {
                                // å…¨éƒ¨ï¼Œä¸è®Šæ›´
                            } else if (pageState.postFilterId === '__NONE__') {
                                shifts = shifts.filter(s => ((s.role || 'ä¿å…¨') !== 'ä¿å…¨'));
                            } else {
                                shifts = shifts.filter(s => ((s.role || 'ä¿å…¨') === 'ä¿å…¨') && s.__postId === pageState.postFilterId);
                            }
                        }
                        // ç‹€æ…‹ï¼šç•°å¸¸ï¼ˆæœªæ‰“å¡/æœªä¸Šå“¨ï¼‰ã€å·²å®Œæˆã€æœ‰æ’ç­
                        const statuses = shifts.map(s => computeShiftStatus(iso, s));
                        // åªæœ‰åœ¨é¡¯ç¤ºå…¨éƒ¨å“¨é»æ™‚ï¼Œæ‰æ¡ç”¨èšåˆçš„ isScheduledDay ä½œç‚ºæœ‰æ’ç­æ¨™è¨˜
                        const aggFlag = (pageState.selectedPostId === ALL_POSTS_ID && (!pageState.postFilterId || pageState.postFilterId === ALL_POSTS_ID)) ? !!docData?.isScheduledDay : false;
                        const hasShifts = (shifts.length > 0) || aggFlag;
                        const anyAbnormal = statuses.some(st => st === 'æœªä¸Šå“¨');
                        const allCompleted = hasShifts && statuses.length > 0 && statuses.every(st => st === 'å·²å®Œæˆ');
                        // æ–·çºŒæ¨™ç« 
                        let segCount = 0;
                        try {
                            const mins = shifts.map(s=>({ start: parseHM(s.start), end: parseHM(s.end) }));
                            segCount = mergeIntervalsMinutes(mins).length;
                        } catch (_) { segCount = (shifts.length>0?1:0); }
                        const discontinuity = segCount > 1;
                        const badgeText = discontinuity ? 'æ–·çºŒ' : '';
                        const badge = badgeText ? `<span class="text-[10px] text-blue-600">${badgeText}</span>` : '';

                        const isSelected = iso === selectedIso;
                        const isToday = iso === todayIso;
                        // è§’è‰²æ¡†ç·šï¼ˆåƒ…åœ¨é¸æ“‡äº†è§’è‰²éæ¿¾æ™‚ï¼Œä¸”è©²æ—¥æœ‰è©²è§’è‰²çš„ç­è¡¨ï¼‰
                        const hasRole = !!pageState.roleFilter && Array.isArray(shifts) && shifts.some(s => ((s.role || 'ä¿å…¨') === pageState.roleFilter));
                        const roleBorderMap = { 'ç¸½å¹¹äº‹':'border-amber-500','ç§˜æ›¸':'border-purple-500','ä¿å…¨':'border-green-700','æ¸…æ½”':'border-pink-500','æ©Ÿé›»':'border-blue-500' };

                        // åº•è‰²ï¼šç•°å¸¸ç´…ã€å®Œæˆç¶ ã€æœ‰æ’ç­è—ï¼›è·¨æœˆç°ï¼›ç„¡æ’ç­ç™½
                        let bgCls = 'bg-white';
                        if (!cell.inMonth) bgCls = 'bg-gray-50';
                        else if (anyAbnormal) bgCls = 'bg-red-100';
                        else if (allCompleted) bgCls = 'bg-green-100';
                        else if (hasShifts) bgCls = 'bg-blue-100';

                        // æ¡†ç·šï¼šå„ªå…ˆé †åºï¼šé¸å–æ·ºç¶  > ä»Šæ—¥æ·ºç´… > è§’è‰²æ¡†ç·š
                        let borderCls = '';
                        if (cell.inMonth) {
                            if (isSelected) borderCls = 'border-2 border-green-300';
                            else if (isToday) borderCls = 'border-2 border-red-300';
                            else if (hasRole) borderCls = `border-2 ${roleBorderMap[pageState.roleFilter] || 'border-gray-300'}`;
                        }

                        const textTone = cell.inMonth ? 'text-gray-900' : 'text-gray-400';
                        const cls = `${bgCls} ${textTone} ${borderCls} rounded p-2 text-xs h-[30px] flex flex-col`;
                        return `<div class="${cls}" data-iso="${iso}"><div class="font-semibold">${cell.date.getDate()}</div><div class="mt-auto">${badge}</div></div>`;
                    }).join('');
                    grid.querySelectorAll('[data-iso]').forEach(el=>{
                        el.addEventListener('click', ()=>{
                            const iso = el.getAttribute('data-iso');
                            pageState.selectedDayIso = (pageState.selectedDayIso === iso) ? null : iso;
                            renderDayPanel();
                            renderMonthlyList();
                        });
                    });
                };

                const renderDayPanel = async () => {
                    const panel = document.getElementById('shift-day-panel');
                    if (!panel) return;
                    const iso = pageState.selectedDayIso || fmtYMD(new Date());
                    const { Timestamp } = window.__fs || {};
                    pageState.selectedDayIso = iso;
                    const isAgg = (pageState.selectedPostId === ALL_POSTS_ID);
                    const postFilterId = pageState.postFilterId || (isAgg ? ALL_POSTS_ID : null);
                    let docData = null;
                    let shifts = [];
                    let isScheduledDay = false;
                    if (isAgg) {
                        const agg = pageState.monthDocsMap[iso] || { shifts: [], isScheduledDay: false };
                        docData = agg;
                        shifts = Array.isArray(agg.shifts) ? agg.shifts : [];
                        isScheduledDay = !!agg.isScheduledDay;
                    } else {
                        const id = `${communityId}__${pageState.selectedPostId}__${iso}`;
                        try {
                            const dref = doc(db,'communities', communityId, 'postSchedules', id);
                            const dsnap = await getDoc(dref);
                            if (dsnap.exists()) docData = dsnap.data();
                        } catch (e) { console.warn('è®€å–ç•¶æ—¥ç­è¡¨å¤±æ•—', e); }
                        shifts = Array.isArray(docData?.shifts) ? docData.shifts : [];
                        isScheduledDay = !!docData?.isScheduledDay;
                    }

                    // ä¾å“¨é»ç¯©é¸ï¼ˆåƒ…åœ¨å…¨éƒ¨åˆ†é ï¼‰ï¼š
                    // å…¨éƒ¨ï¼šä¸éæ¿¾ï¼›ç„¡ï¼šåƒ…éä¿å…¨ï¼›æŒ‡å®šå“¨é»ï¼šè©²å“¨é»ä¿å…¨
                    if (isAgg && postFilterId) {
                        if (postFilterId === ALL_POSTS_ID) {
                            // å…¨éƒ¨ï¼Œä¸è®Šæ›´
                        } else if (postFilterId === '__NONE__') {
                            shifts = shifts.filter(s => ((s.role || 'ä¿å…¨') !== 'ä¿å…¨'));
                        } else {
                            shifts = shifts.filter(s => ((s.role || 'ä¿å…¨') === 'ä¿å…¨') && s.__postId === postFilterId);
                        }
                    }

                    // è§’è‰²éæ¿¾ï¼šä¿ç•™åŸå§‹ç´¢å¼•ï¼Œäº‹ä»¶ä»æŒ‡å‘åŸé™£åˆ—ç´¢å¼•
                    const roleFilter = pageState.roleFilter || null;
                    const filteredList = roleFilter
                        ? shifts.map((s,idx)=>({ s, idx })).filter(x => ((x.s.role || 'ä¿å…¨') === roleFilter))
                        : shifts.map((s,idx)=>({ s, idx }));

                    await loadCommunityUsers();
                    const userOptions = pageState.userOptionsHTML && pageState.userOptionsHTML.length ? pageState.userOptionsHTML : '<option value="" disabled>è«‹å…ˆå»ºç«‹æˆ–æŒ‡æ´¾äººå“¡</option>';
                    // é¡¯ç¤ºç›®å‰å“¨é»ç¯©é¸ç‹€æ…‹ï¼ˆèšåˆåˆ†é ï¼‰
                    let postFilterName = '';
                    if (isAgg) {
                        if (!postFilterId || postFilterId === ALL_POSTS_ID) postFilterName = 'å…¨éƒ¨';
                        else if (postFilterId === '__NONE__') postFilterName = 'ç„¡';
                        else postFilterName = (pageState.posts.find(p=>p.id===postFilterId)?.name) || 'æœªå‘½åå“¨é»';
                    }
                    panel.innerHTML = `
                        <div class="flex items-center justify-between mb-2">
                            <div class="font-semibold">${iso} çš„${isAgg ? `å“¨é»ï¼š${postFilterName}` : 'å“¨é»'}ç­è¡¨</div>
                        </div>
                        <div class="flex items-center gap-4 mb-3">
                            <label class="flex items-center gap-1 text-sm"><input type="checkbox" id="chk-scheduled" ${isScheduledDay?'checked':''} ${isAgg ? 'disabled' : ''}/> æ’ç­æ—¥${isAgg ? 'ï¼ˆèšåˆæ¨¡å¼ä¸å¯ç·¨è¼¯ï¼‰' : ''}</label>
                            <button id="save-day-rules" class="ml-auto px-3 py-1 rounded border bg-white text-gray-700 hover:bg-gray-50" ${isAgg ? 'disabled title="èšåˆæ¨¡å¼ä¸æ”¯æ´æ­¤æ“ä½œ"' : ''}>å„²å­˜è¨­å®š</button>
                        </div>
                        <div>
                            ${(filteredList.length===0) ? `<div class=\"text-gray-500 text-sm\">å°šæœªæ’ç­${roleFilter? 'ï¼ˆæˆ–è¢«è§’è‰²éæ¿¾ï¼‰' : ''}</div>` : ''}
                            <div id="shift-list" class="space-y-3">
                                ${filteredList.map(({s,idx})=>`
                                    <div class="flex items-start gap-2">
                                        <div class="text-sm w-48">
                                            <span data-time-label="${idx}">${s.start || 'â€”'} ~ ${s.end || 'â€”'}</span>
                                            <span class="ml-1 text-[10px] px-1 rounded bg-gray-100">${s.role || 'ä¿å…¨'}</span>
                                            ${s.__postName ? `<span class="ml-1 text-[10px] px-1 rounded bg-blue-100 text-blue-700">${s.__postName}</span>` : ''}
                                            <div class="mt-1 space-x-1">
                                                <button class="px-2 py-1 text-xs rounded border bg-white text-gray-700 hover:bg-gray-50" data-edit="${idx}">ç·¨è¼¯</button>
                                                <span class="inline-flex items-center gap-1 hidden" data-edit-area="${idx}">
                                                    <input type="time" class="px-1 py-0.5 border rounded text-xs" id="edit-start-${idx}" value="${s.start || ''}">
                                                    <span>~</span>
                                                    <input type="time" class="px-1 py-0.5 border rounded text-xs" id="edit-end-${idx}" value="${s.end || ''}">
                                                    <button class="px-2 py-1 text-xs rounded border bg-white text-gray-700 hover:bg-gray-50" data-edit-save="${idx}">å„²å­˜æ™‚é–“</button>
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex-1">
                                            <div class="text-xs text-gray-500 mb-1">æŒ‡å®šäººå“¡</div>
                                            <select class="px-2 py-1 border rounded text-xs min-w-[220px]" data-assign="${idx}">
                                                ${pageState.communityUsers.length ? pageState.communityUsers.map(u=>`<option value=\"${u.id}\" ${(Array.isArray(s.assignees)&&s.assignees[0]===u.id)?'selected':''}>${(u.name||u.displayName||u.id)}ï½œ${u.role||''}</option>`).join('') : '<option value=\"\" disabled>è«‹å…ˆå»ºç«‹æˆ–æŒ‡æ´¾äººå“¡</option>'}
                                            </select>
                                            <button class="ml-2 px-2 py-1 text-xs rounded border bg-white text-gray-700 hover:bg-gray-50" data-assign-save="${idx}">å„²å­˜æŒ‡æ´¾</button>
                                        </div>
                                        <button class="px-2 py-1 text-xs rounded border bg-white text-gray-700 hover:bg-gray-50" data-del="${idx}">åˆªé™¤</button>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="mt-3 flex items-center gap-2">
                                <input id="new-start" type="time" class="px-2 py-1 border rounded text-sm" />
                                <span>~</span>
                                <input id="new-end" type="time" class="px-2 py-1 border rounded text-sm" />
                                <select id="new-assignees" class="px-2 py-1 border rounded text-sm min-w-[220px]">${userOptions}</select>
                                <button id="add-shift" class="px-3 py-1 rounded border bg-white text-gray-700 hover:bg-gray-50" ${isAgg ? 'disabled title="èšåˆæ¨¡å¼è«‹è‡³å€‹åˆ¥å“¨é»æ–°å¢"' : ''}>æ–°å¢ç­è¡¨</button>
                            </div>
                        </div>`;

                    // å·²ç§»é™¤æ¨¡æ¿èˆ‡æ‰¹æ¬¡è¤‡è£½åŠŸèƒ½ï¼ˆæŒ‰éµèˆ‡äº‹ä»¶ï¼‰

                    const saveBtn = document.getElementById('save-day-rules');
                    if (saveBtn) saveBtn.addEventListener('click', async ()=>{
                        if (isAgg) { showToast('èšåˆæ¨¡å¼ä¸æ”¯æ´æ­¤æ“ä½œ', true); return; }
                        try {
                            const data = {
                                communityId,
                                postId: pageState.selectedPostId,
                                dateIso: iso,
                                dateTS: (Timestamp?.fromDate ? Timestamp.fromDate(new Date(`${iso}T00:00:00`)) : new Date(`${iso}T00:00:00`)),
                                isScheduledDay: !!document.getElementById('chk-scheduled')?.checked,
                                shifts: shifts,
                                updatedAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()),
                                createdAt: docData?.createdAt || (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date())
                            };
                            await setDoc(doc(db,'communities', communityId, 'postSchedules', id), data);
                            showToast('å·²å„²å­˜è¨­å®š');
                            await loadMonth();
                            renderCalendar();
                            renderDayPanel();
                        } catch (e) { showToast('å„²å­˜å¤±æ•—', true); }
                    });

                    panel.querySelectorAll('[data-del]').forEach(btn=>{
                        btn.addEventListener('click', async ()=>{
                            const idx = parseInt(btn.getAttribute('data-del'),10);
                            try {
                                let targetPostId = pageState.selectedPostId;
                                let realIdx = idx;
                                const s = shifts[idx];
                                if (isAgg && s) { targetPostId = s.__postId || targetPostId; realIdx = (s.__origIndex !== undefined) ? s.__origIndex : idx; }
                                const docId = `${communityId}__${targetPostId}__${iso}`;
                                const dsnap = await getDoc(doc(db,'communities', communityId, 'postSchedules', docId));
                                const docData2 = dsnap.exists() ? dsnap.data() : null;
                                const baseShifts = Array.isArray(docData2?.shifts) ? docData2.shifts : [];
                                const newShifts = baseShifts.filter((_,i)=> i !== realIdx);
                                const payloadDel = { communityId, postId: targetPostId, dateIso: iso, dateTS: (Timestamp?.fromDate ? Timestamp.fromDate(new Date(`${iso}T00:00:00`)) : new Date(`${iso}T00:00:00`)), isScheduledDay: !!docData2?.isScheduledDay, shifts: newShifts, createdAt: docData2?.createdAt || (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()), updatedAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()) };
                                await setDoc(doc(db,'communities', communityId, 'postSchedules', docId), payloadDel);
                                showToast('å·²åˆªé™¤ç­è¡¨');
                                await loadMonth();
                                renderCalendar();
                                renderDayPanel();
                            } catch (e) { showToast('åˆªé™¤å¤±æ•—', true); }
                        });
                    });

                    panel.querySelectorAll('[data-assign-save]').forEach(btn=>{
                        btn.addEventListener('click', async ()=>{
                            const idx = parseInt(btn.getAttribute('data-assign-save'),10);
                            const sel = panel.querySelector(`[data-assign="${idx}"]`);
                            const assVal = sel?.value || '';
                            try {
                                let targetPostId = pageState.selectedPostId;
                                let realIdx = idx;
                                const s = shifts[idx];
                                if (isAgg && s) { targetPostId = s.__postId || targetPostId; realIdx = (s.__origIndex !== undefined) ? s.__origIndex : idx; }
                                const docId = `${communityId}__${targetPostId}__${iso}`;
                                const dsnap = await getDoc(doc(db,'communities', communityId, 'postSchedules', docId));
                                const docData2 = dsnap.exists() ? dsnap.data() : null;
                                const baseShifts = Array.isArray(docData2?.shifts) ? docData2.shifts : [];
                                const newShifts = baseShifts.map((sh,i)=> i===realIdx ? { ...sh, assignees: assVal ? [assVal] : [] } : sh);
                                const payloadAssign = { communityId, postId: targetPostId, dateIso: iso, dateTS: (Timestamp?.fromDate ? Timestamp.fromDate(new Date(`${iso}T00:00:00`)) : new Date(`${iso}T00:00:00`)), isScheduledDay: !!docData2?.isScheduledDay, shifts: newShifts, createdAt: docData2?.createdAt || (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()), updatedAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()) };
                                await setDoc(doc(db,'communities', communityId, 'postSchedules', docId), payloadAssign);
                                showToast('å·²æ›´æ–°æŒ‡æ´¾');
                                await loadMonth();
                                renderCalendar();
                                renderDayPanel();
                            } catch (e) { showToast('æ›´æ–°æŒ‡æ´¾å¤±æ•—', true); }
                        });
                    });

                    // ç·¨è¼¯æ—¢æœ‰ç­è¡¨æ™‚é–“
                    panel.querySelectorAll('[data-edit]').forEach(btn=>{
                        btn.addEventListener('click', ()=>{
                            const idx = parseInt(btn.getAttribute('data-edit'),10);
                            const area = panel.querySelector(`[data-edit-area="${idx}"]`);
                            if (area) {
                                area.classList.toggle('hidden');
                                const input = area.querySelector(`#edit-start-${idx}`);
                                input && input.focus();
                            }
                        });
                    });
                    panel.querySelectorAll('[data-edit-save]').forEach(btn=>{
                        btn.addEventListener('click', async ()=>{
                            const idx = parseInt(btn.getAttribute('data-edit-save'),10);
                            const sHM = document.getElementById(`edit-start-${idx}`)?.value || '';
                            const eHM = document.getElementById(`edit-end-${idx}`)?.value || '';
                            if (!sHM || !eHM) return showToast('è«‹è¼¸å…¥å®Œæ•´æ™‚é–“', true);
                            if (parseHM(eHM) <= parseHM(sHM)) return showToast('çµæŸæ™‚é–“éœ€æ™šæ–¼é–‹å§‹æ™‚é–“', true);
                            try {
                                let targetPostId = pageState.selectedPostId;
                                let realIdx = idx;
                                const sObj = shifts[idx];
                                if (isAgg && sObj) { targetPostId = sObj.__postId || targetPostId; realIdx = (sObj.__origIndex !== undefined) ? sObj.__origIndex : idx; }
                                const docId = `${communityId}__${targetPostId}__${iso}`;
                                const dsnap = await getDoc(doc(db,'communities', communityId, 'postSchedules', docId));
                                const docData2 = dsnap.exists() ? dsnap.data() : null;
                                const baseShifts = Array.isArray(docData2?.shifts) ? docData2.shifts : [];
                                const newShifts = baseShifts.map((sh,i)=> i===realIdx ? { ...sh, start: sHM, end: eHM } : sh);
                                const payloadEdit = { communityId, postId: targetPostId, dateIso: iso, dateTS: (Timestamp?.fromDate ? Timestamp.fromDate(new Date(`${iso}T00:00:00`)) : new Date(`${iso}T00:00:00`)), isScheduledDay: !!docData2?.isScheduledDay, shifts: newShifts, createdAt: docData2?.createdAt || (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()), updatedAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()) };
                                await setDoc(doc(db,'communities', communityId, 'postSchedules', docId), payloadEdit);
                                showToast('å·²æ›´æ–°ç­è¡¨æ™‚é–“');
                                await loadMonth();
                                renderCalendar();
                                renderDayPanel();
                            } catch (e) { showToast('æ›´æ–°å¤±æ•—', true); }
                        });
                    });

                    const addBtn = document.getElementById('add-shift');
                    if (addBtn) addBtn.addEventListener('click', async ()=>{
                        if (isAgg) { showToast('èšåˆæ¨¡å¼è«‹è‡³å€‹åˆ¥å“¨é»æ–°å¢', true); return; }
                        const s = document.getElementById('new-start')?.value || '';
                        const e = document.getElementById('new-end')?.value || '';
                        if (!s || !e) return showToast('è«‹è¼¸å…¥å®Œæ•´æ™‚é–“', true);
                        if (parseHM(e) <= parseHM(s)) return showToast('çµæŸæ™‚é–“éœ€æ™šæ–¼é–‹å§‹æ™‚é–“', true);
                        const assVal = document.getElementById('new-assignees')?.value || '';
                        const newShifts = [...shifts, { start: s, end: e, assignees: assVal ? [assVal] : [] }];
                        try {
                            const base = (!docData || !docData.communityId || !docData.postId || !docData.dateIso || !docData.dateTS) ? {
                                communityId,
                                postId: pageState.selectedPostId,
                                dateIso: iso,
                                dateTS: (Timestamp?.fromDate ? Timestamp.fromDate(new Date(`${iso}T00:00:00`)) : new Date(`${iso}T00:00:00`)),
                                createdAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date())
                            } : {};
                            const payloadAdd = { communityId, postId: pageState.selectedPostId, dateIso: iso, dateTS: (Timestamp?.fromDate ? Timestamp.fromDate(new Date(`${iso}T00:00:00`)) : new Date(`${iso}T00:00:00`)), isScheduledDay, shifts: newShifts, createdAt: docData?.createdAt || (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()), updatedAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()), };
                                await setDoc(doc(db,'communities', communityId, 'postSchedules', id), payloadAdd);
                            showToast('å·²æ–°å¢ç­è¡¨');
                            await loadMonth();
                            renderCalendar();
                            renderDayPanel();
                        } catch (err) {
                            console.error('æ–°å¢ç­è¡¨å¤±æ•—', err);
                            const msg = (err && err.code === 'permission-denied') ? 'æ²’æœ‰ç¤¾å€å¯«å…¥æ¬Šé™ï¼Œè«‹ä½¿ç”¨ç®¡ç†ç«¯æˆ–ç¤¾å€ç®¡ç†å“¡èº«åˆ†' : 'æ–°å¢å¤±æ•—';
                            showToast(msg, true);
                        }
                    });
                };

                const dayOfWeekLabel = (iso) => {
                    try {
                        const arr = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
                        const dt = new Date(`${iso}T00:00:00`);
                        return `æ˜ŸæœŸ${arr[dt.getDay()]}`;
                    } catch (_) { return 'æ˜ŸæœŸ'; }
                };

                // çŸ­ç‰ˆæ˜ŸæœŸï¼ˆåªé¡¯ç¤ºæ—¥ã€ä¸€ã€äºŒã€ä¸‰ã€å››ã€äº”ã€å…­ï¼‰
                const dayOfWeekShort = (iso) => {
                    try {
                        const arr = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
                        const dt = new Date(`${iso}T00:00:00`);
                        return arr[dt.getDay()];
                    } catch (_) { return ''; }
                };

                const getUserNameById = (uid) => {
                    const key = String(uid || '').trim();
                    const users = (pageState.communityUsers || []);
                    const u = users.find(x => x.id === key) || users.find(x => String(x.name || x.displayName || '').trim() === key);
                    return u ? (u.name || u.displayName || u.id) : (key || 'æœªæŒ‡æ´¾');
                };

                const getUserTitleById = (uid) => {
                    const key = String(uid || '').trim();
                    const users = (pageState.communityUsers || []);
                    const u = users.find(x => x.id === key) || users.find(x => String(x.name || x.displayName || '').trim() === key);
                    return u ? ((u.jobTitle || u.applicationTitle || u.role || '') + '') : '';
                };

                const computeShiftStatus = (iso, shift) => {
                    try {
                        const startStr = shift?.start || '07:00';
                        const endStr = shift?.end || '19:00';
                        const endIso = shift?.endDateIso || iso;
                        const start = new Date(`${iso}T${startStr}:00`);
                        const end = new Date(`${endIso}T${endStr}:00`);
                        const now = new Date();
                        const assId = Array.isArray(shift?.assignees) ? shift.assignees[0] : null;
                        const assUser = assId ? (pageState.communityUsers || []).find(u=>u.id===assId) : null;
                        if (shift?.cashShift === true || (assUser && (assUser.employmentStatus === 'ç¾é‡‘ç­'))) return 'è½‰ç¾é‡‘ç­';
                        if (now < start) return 'æœªåˆ°ä¸Šç­æ™‚é–“';
                        if (now > end) return 'å·²å®Œæˆ';
                        return 'æœªä¸Šå“¨';
                    } catch(_) { return 'æœªä¸Šå“¨'; }
                };

                const renderMonthlyList = async () => {
                    const el = document.getElementById('shift-monthly-list');
                    if (!el) return;
                    await loadCommunityUsers();
                    const filterIso = pageState.selectedDayIso || null;
                    const roleFilter = pageState.roleFilter || null;
                    const titleEl = document.getElementById('shift-list-title');
                    // é¡¯ç¤ºç›®å‰å“¨é»ç¯©é¸ç‹€æ…‹æ–¼æ¨™é¡Œï¼ˆåƒ…åœ¨å…¨éƒ¨åˆ†é ï¼‰
                    // æ”¹ç‚ºé¡¯ç¤ºå…¨ç¤¾å€æ’ç­ï¼Œä¸å†é¡¯ç¤ºå“¨é»ç¯©é¸ç‹€æ…‹
                    const isAgg = true;
                    const postFilterId = null;
                    if (titleEl) titleEl.textContent = `${filterIso ? 'ç•¶æ—¥' : 'æ¯æœˆ'}ç­è¡¨åˆ—è¡¨${roleFilter ? `ï¼ˆè§’è‰²ï¼š${roleFilter}ï¼‰` : ''}`;
                    const entries = Object.entries(pageState.monthDocsMap).sort(([a],[b]) => a.localeCompare(b));
                    const rows = [];
                    const currentPost = pageState.posts.find(p=>p.id===pageState.selectedPostId);
                    const postName = currentPost?.name || 'æœªå‘½åå“¨é»';
                    for (const [iso, doc] of entries) {
                        if (filterIso && iso !== filterIso) continue;
                        const allShifts = Array.isArray(doc.shifts) ? doc.shifts : [];
                        // ä¸å†ä¾å“¨é»ç¯©é¸ï¼Œé¡¯ç¤ºå…¨éƒ¨æ’ç­
                        let shifts = allShifts;
                        shifts.forEach((s, idx) => {
                            if (roleFilter && ((s.role || 'ä¿å…¨') !== roleFilter)) return;
                            const start = s.start || '07:00';
                            const end = s.end || '19:00';
                            const assId = Array.isArray(s.assignees) ? (s.assignees[0] || '') : '';
                            const assName = assId ? getUserNameById(assId) : 'æœªæŒ‡æ´¾';
                            const assTitle = assId ? getUserTitleById(assId) : '';
                            const status = computeShiftStatus(iso, s);
                            const dow = dayOfWeekShort(iso);
                            const role = s.role || 'ä¿å…¨';
                            const endIso = s.endDateIso || iso;
                            const endDow = dayOfWeekShort(endIso);
                            // ç§»é™¤å“¨é»æ¬„ä½
                            rows.push(`
                                <tr>
                                  <td class="px-2 py-1 whitespace-nowrap border border-gray-300">${role}</td>
                                  <td class="px-2 py-1 whitespace-nowrap border border-gray-300">${assName}</td>
                                  <td class="px-2 py-1 whitespace-nowrap border border-gray-300">${assTitle}</td>
                                  <td class="px-2 py-1 whitespace-nowrap border border-gray-300">${iso}</td>
                                  <td class="px-2 py-1 whitespace-nowrap border border-gray-300">${dow}</td>
                                  <td class="px-2 py-1 whitespace-nowrap border border-gray-300">${start}</td>
                                  <td class="px-2 py-1 whitespace-nowrap border border-gray-300">${endIso}</td>
                                  <td class="px-2 py-1 whitespace-nowrap border border-gray-300">${endDow}</td>
                                  <td class="px-2 py-1 whitespace-nowrap border border-gray-300">${end}</td>
                                  <td class="px-2 py-1 whitespace-nowrap border border-gray-300">${status}</td>
                                  <td class="px-2 py-1 whitespace-nowrap border border-gray-300">
                                    <button class="px-2 py-1 text-xs rounded bg-blue-600 text-white hover:bg-blue-700" data-edit-month="${iso}__${idx}">ç·¨è¼¯</button>
                                    <button class="ml-1 px-2 py-1 text-xs rounded bg-indigo-600 text-white hover:bg-indigo-700" data-copy-month="${iso}__${idx}">è¤‡è£½</button>
                                    <button class="ml-1 px-2 py-1 text-xs rounded bg-rose-600 text-white hover:bg-rose-700" data-del-month="${iso}__${idx}">åˆªé™¤</button>
                                    <button class="ml-1 px-2 py-1 text-xs rounded bg-amber-500 text-white hover:bg-amber-600" data-share-month="${iso}__${idx}">åˆ†äº«(è½‰ç¾é‡‘ç­)</button>
                                  </td>
                                </tr>`);
                        });
                    }
                    // è¨ˆç®—æœ¬æœˆå¯¦éš›å‡ºç¾ä¹‹å“¨é»ï¼ˆåƒ…èšåˆåˆ†é ï¼‰ï¼Œä»¥åŠæ˜¯å¦æœ‰éä¿å…¨ç­è¡¨ï¼ˆé¡¯ç¤ºã€Œç„¡ã€ï¼‰
                    let presentPostIds = new Set();
                    let hasNonGuardRole = false;
                    if (isAgg) {
                        for (const [isoX, docX] of entries) {
                            const shiftsX = Array.isArray(docX.shifts) ? docX.shifts : [];
                            shiftsX.forEach(sx => {
                                const r = sx.role || 'ä¿å…¨';
                                if (r === 'ä¿å…¨' && sx.__postId) presentPostIds.add(sx.__postId);
                                else if (r !== 'ä¿å…¨') hasNonGuardRole = true;
                            });
                        }
                    }

                    // å·²ç§»é™¤å“¨é»ç¯©é¸ä¸‹æ‹‰ï¼Œä¸å†é¡¯ç¤ºæˆ–ç¶­è­· postFilterId

                    el.innerHTML = `
                        <div class="overflow-x-auto">
                          <table class="text-sm" style="min-width: max-content; border-collapse: collapse;">
                            <thead>
                              <tr class="bg-gray-50 text-gray-600">
                                <th class="px-2 py-1 text-left whitespace-nowrap border border-gray-300">è§’è‰²</th>
                                <th class="px-2 py-1 text-left whitespace-nowrap border border-gray-300">æŒ‡æ´¾äººå“¡</th>
                                <th class="px-2 py-1 text-left whitespace-nowrap border border-gray-300">è·ç¨±</th>
                                <th class="px-2 py-1 text-left whitespace-nowrap border border-gray-300">ä¸Šç­æ—¥æœŸ</th>
                                <th class="px-2 py-1 text-left whitespace-nowrap border border-gray-300">æ˜ŸæœŸ</th>
                                <th class="px-2 py-1 text-left whitespace-nowrap border border-gray-300">ä¸Šç­æ™‚é–“</th>
                                <th class="px-2 py-1 text-left whitespace-nowrap border border-gray-300">ä¸‹ç­æ—¥æœŸ</th>
                                <th class="px-2 py-1 text-left whitespace-nowrap border border-gray-300">æ˜ŸæœŸ</th>
                                <th class="px-2 py-1 text-left whitespace-nowrap border border-gray-300">ä¸‹ç­æ™‚é–“</th>
                                <th class="px-2 py-1 text-left whitespace-nowrap border border-gray-300">ç‹€æ…‹</th>
                                <th class="px-2 py-1 text-left whitespace-nowrap border border-gray-300">æ“ä½œ</th>
                              </tr>
                            </thead>
                            <tbody>${rows.join('') || `<tr><td colspan="12" class="px-2 py-3 text-center text-gray-500 border border-gray-300">æœ¬æœˆå°šç„¡ç­è¡¨</td></tr>`}</tbody>
                          </table>
                        </div>`;
                    // å“¨é»ä¸‹æ‹‰äº‹ä»¶å·²åœ¨æ¨™é¡Œåˆ—ç¶å®š
                    const addBtn = document.getElementById('open-add-schedule');
                    if (addBtn) { addBtn.onclick = () => openAddScheduleModal(); }

                    const deleteBtn = document.getElementById('delete-schedule');
                    if (deleteBtn) deleteBtn.onclick = async () => {
                        const filterIso = pageState.selectedDayIso || null;
                        try {
                            const { collection, getDocs, query, where, Timestamp, deleteDoc, doc } = window.__fs || {};
                            const db2 = window.__db || db;
                            if (!db2 || !collection || !getDocs || !query || !where) { showToast('è³‡æ–™åº«å°šæœªå°±ç·’', true); return; }

                            if (filterIso) {
                                if (!confirm('ç¢ºå®šåˆªé™¤ç•¶æ—¥ã€Œå…¨ç¤¾å€ã€æ‰€æœ‰å“¨é»çš„ç­è¡¨è³‡æ–™ï¼Ÿ')) return;
                                const schedulesRef = collection(db2, 'communities', communityId, 'postSchedules');
                                const dsnap = await getDocs(query(schedulesRef, where('dateIso', '==', filterIso)));
                                const tasks = [];
                                dsnap.forEach(d => tasks.push(deleteDoc(doc(db2, 'communities', communityId, 'postSchedules', d.id))));
                                await Promise.all(tasks);
                                showToast('å·²åˆªé™¤ç•¶æ—¥å…¨ç¤¾å€ç­è¡¨');
                            } else {
                                if (!confirm('ç¢ºå®šåˆªé™¤æœ¬æœˆã€Œå…¨ç¤¾å€ã€æ‰€æœ‰å“¨é»çš„ç­è¡¨è³‡æ–™ï¼Ÿ')) return;
                                const schedulesRef = collection(db2, 'communities', communityId, 'postSchedules');
                                const m = pageState.monthDate || new Date();
                                const monthStart = new Date(m.getFullYear(), m.getMonth(), 1);
                                const monthEnd = new Date(m.getFullYear(), m.getMonth()+1, 0);
                                const startTS = Timestamp?.fromDate ? Timestamp.fromDate(new Date(`${monthStart.toISOString().slice(0,10)}T00:00:00`)) : monthStart;
                                const endTS = Timestamp?.fromDate ? Timestamp.fromDate(new Date(`${monthEnd.toISOString().slice(0,10)}T23:59:59`)) : monthEnd;
                                const dsnap = await getDocs(query(schedulesRef, where('dateTS', '>=', startTS), where('dateTS', '<=', endTS)));
                                const tasks = [];
                                dsnap.forEach(d => tasks.push(deleteDoc(doc(db2, 'communities', communityId, 'postSchedules', d.id))));
                                await Promise.all(tasks);
                                showToast('å·²åˆªé™¤æœ¬æœˆå…¨ç¤¾å€ç­è¡¨');
                            }
                            await loadMonth();
                            renderCalendar();
                            renderMonthlyList();
                            renderDayPanel();
                        } catch (e) {
                            console.error('åˆªé™¤ç­è¡¨å¤±æ•—', e);
                            showToast('åˆªé™¤å¤±æ•—ï¼šè«‹æª¢æŸ¥æ¬Šé™èˆ‡ç¶²è·¯', true);
                        }
                    };

                    const exportBtn = document.getElementById('export-csv');
                    if (exportBtn) exportBtn.onclick = async () => {
                        const header = ['è§’è‰²','æŒ‡æ´¾äººå“¡','å“¨é»','ä¸Šç­æ—¥æœŸ','ä¸Šç­æ™‚é–“','ä¸‹ç­æ—¥æœŸ','ä¸‹ç­æ™‚é–“'];
                        const lines = [header.join(',')];
                        const entries2 = Object.entries(pageState.monthDocsMap).sort(([a],[b]) => a.localeCompare(b));
                        const currentPost2 = pageState.posts.find(p=>p.id===pageState.selectedPostId);
                        const postName2 = currentPost2?.name || 'æœªå‘½åå“¨é»';
                        for (const [iso2, doc2] of entries2) {
                            if (filterIso && iso2 !== filterIso) continue;
                            let shifts2 = Array.isArray(doc2.shifts) ? doc2.shifts : [];
                            if (isAgg && postFilterId) {
                                if (postFilterId === ALL_POSTS_ID) {
                                    // å…¨éƒ¨
                                } else if (postFilterId === '__NONE__') {
                                    // åƒ…éä¿å…¨è§’è‰²
                                    shifts2 = shifts2.filter(s => ((s.role || 'ä¿å…¨') !== 'ä¿å…¨'));
                                } else {
                                    // æŒ‡å®šå“¨é»çš„ä¿å…¨
                                    shifts2 = shifts2.filter(s => ((s.role || 'ä¿å…¨') === 'ä¿å…¨') && s.__postId === postFilterId);
                                }
                            }
                            shifts2.forEach((s2) => {
                                if (roleFilter && ((s2.role || 'ä¿å…¨') !== roleFilter)) return;
                                const start = s2.start || '07:00';
                                const end = s2.end || '19:00';
                                const assId = Array.isArray(s2.assignees) ? (s2.assignees[0] || '') : '';
                                const assName = assId ? getUserNameById(assId) : 'æœªæŒ‡æ´¾';
                                const assTitle = assId ? getUserTitleById(assId) : '';
                                const status = computeShiftStatus(iso2, s2);
                                const dow = dayOfWeekShort(iso2);
                                const role = s2.role || 'ä¿å…¨';
                                const endIso = s2.endDateIso || iso2;
                                const endDow = dayOfWeekShort(endIso);
                                const displayPost = role === 'ä¿å…¨' ? (s2.__postName || postName2) : 'ç„¡';
                                const row = [role, assName, displayPost, iso2, start, endIso, end].map(v => `"${String(v).replace(/"/g,'""')}"`).join(',');
                                lines.push(row);
                            });
                        }
                        const csv = lines.join('\r\n');
                        const blob = new Blob(["\uFEFF", csv], { type: 'text/csv;charset=utf-8;' });
                        const d0 = pageState.monthDate || new Date();
                        const fname = `shifts_${d0.getFullYear()}_${String(d0.getMonth()+1).padStart(2,'0')}.csv`;
                        const url = URL.createObjectURL(blob);
                        const a0 = document.createElement('a');
                        a0.href = url; a0.download = fname; a0.click();
                        setTimeout(()=> URL.revokeObjectURL(url), 1000);
                    };

                    const importBtn = document.getElementById('import-csv');
                    const importInput = document.getElementById('import-csv-input');
                    if (importBtn && importInput) {
                        importBtn.onclick = () => importInput.click();
                        importInput.onchange = async (evt) => {
                            const file = evt.target.files?.[0];
                            if (!file) return;
                            try {
                                let text = await file.text();
                                text = text.replace(/^\uFEFF/, '');
                                const lines = text.split(/\r?\n/).filter(l=>l.trim().length>0);
                                if (lines.length <= 1) { showToast('CSV ç„¡è³‡æ–™', true); return; }
                                const header = lines[0].split(',').map(h=>h.replace(/^\s*\"|\"\s*$/g,''));
                                const idxMap = {
                                    role: header.indexOf('è§’è‰²'),
                                    assignee: header.indexOf('æŒ‡æ´¾äººå“¡'),
                                    post: header.indexOf('å“¨é»'),
                                    date: header.indexOf('ä¸Šç­æ—¥æœŸ'),
                                    start: header.indexOf('ä¸Šç­æ™‚é–“'),
                                    endDate: header.indexOf('ä¸‹ç­æ—¥æœŸ'),
                                    end: header.indexOf('ä¸‹ç­æ™‚é–“')
                                };
                                const missing = ['role','assignee','post','date','start','endDate','end'].filter(k=> idxMap[k] === -1);
                                if (missing.length) { showToast('CSV æ¬„ä½ç¼ºå°‘ï¼š' + missing.join('ã€'), true); return; }
                                const { Timestamp } = window.__fs || {};
                                for (let i=1; i<lines.length; i++) {
                                    const cols = lines[i].match(/("([^"]|"")*"|[^,]+)/g);
                                    if (!cols || !cols.length) continue;
                                    const get = (ix) => {
                                        const v = cols[ix] || '';
                                        return v.trim().replace(/^\"|\"$/g,'').replace(/""/g,'"');
                                    };
                                    const roleVal = get(idxMap.role) || 'ä¿å…¨';
                                    const assigneeName = get(idxMap.assignee) || '';
                                    const rawDateIso = get(idxMap.date) || '';
                                    const startStr = get(idxMap.start) || '07:00';
                                    const rawEndDateIso = get(idxMap.endDate) || rawDateIso;
                                    const endStr = get(idxMap.end) || '19:00';
                                    // å…è¨±å¤šç¨®æ—¥æœŸæ ¼å¼ï¼Œè½‰ç‚º YYYY-MM-DDï¼›ä¸¦å»é™¤é™„å¸¶æ™‚é–“
                                    const toIso = (raw) => {
                                        const s = String(raw || '').trim();
                                        if (!s) return '';
                                        const datePart = s.split(/[T\s]/)[0];
                                        let m = datePart.match(/^([0-9]{4})[\/\.-]([0-9]{1,2})[\/\.-]([0-9]{1,2})$/);
                                        if (m) {
                                            const y = parseInt(m[1],10), mo = parseInt(m[2],10), d = parseInt(m[3],10);
                                            if (mo>=1 && mo<=12 && d>=1 && d<=31) return `${y}-${String(mo).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                                        }
                                        m = datePart.match(/^([0-9]{1,2})[\/\.-]([0-9]{1,2})[\/\.-]([0-9]{4})$/);
                                        if (m) {
                                            const mo = parseInt(m[1],10), d = parseInt(m[2],10), y = parseInt(m[3],10);
                                            if (mo>=1 && mo<=12 && d>=1 && d<=31) return `${y}-${String(mo).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                                        }
                                        const dt = new Date(datePart);
                                        if (!isNaN(dt.getTime())) {
                                            return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;
                                        }
                                        return '';
                                    };
                                    const dateIso = toIso(rawDateIso);
                                    const endDateIso = toIso(rawEndDateIso) || dateIso;
                                    let postId = pageState.selectedPostId || null;
                                    if (roleVal === 'ä¿å…¨' && idxMap.post !== -1) {
                                        const postName = get(idxMap.post) || '';
                                        if (postName) {
                                            const existing = pageState.posts.find(p => (p.name || '') === postName);
                                            if (existing) {
                                                postId = existing.id;
                                            } else {
                                                const newPostDoc = await addDoc(collection(db,'communities', communityId, 'posts'), {
                                                    communityId,
                                                    name: postName,
                                                    createdAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()),
                                                    updatedAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date())
                                                });
                                                postId = newPostDoc.id;
                                                pageState.posts.push({ id: postId, communityId, name: postName });
                                            }
                                        }
                                    }
                                    const nameOrId = String(assigneeName || '').trim();
                                    const usersList = (pageState.communityUsers || []);
                                    const assUser = usersList.find(u => u.id === nameOrId) || usersList.find(u => String(u.name || u.displayName || '').trim() === nameOrId);
                                    const assId = assUser ? assUser.id : '';
                                    if (!dateIso || !startStr || !endStr) continue;
                                    const effPostId = postId || pageState.selectedPostId;
                                    const dref = doc(db,'communities', communityId, 'postSchedules', `${communityId}__${effPostId}__${dateIso}`);
                                    const dsnap = await getDoc(dref);
                                    const docData = dsnap.exists() ? dsnap.data() : null;
                                    const shifts = Array.isArray(docData?.shifts) ? docData.shifts : [];
                                    const newShift = { start: startStr, end: endStr, assignees: assId ? [assId] : [], role: roleVal, endDateIso };
                                    const payload = {
                                        communityId, postId: effPostId, dateIso,
                                        // é¿å…å­—ä¸²è§£æé€ æˆ Invalid time valueï¼Œæ”¹ç”¨åŸç”Ÿå¹´æœˆæ—¥å»ºæ§‹
                                        dateTS: (() => {
                                            const parts = dateIso.split('-');
                                            const y = parseInt(parts[0],10), mo = parseInt(parts[1],10), d = parseInt(parts[2],10);
                                            const jsDate = new Date(y, mo - 1, d, 0, 0, 0, 0);
                                            return (Timestamp?.fromDate ? Timestamp.fromDate(jsDate) : jsDate);
                                        })(),
                                        isScheduledDay: !!docData?.isScheduledDay,
                                        shifts: [...shifts, newShift],
                                        createdAt: docData?.createdAt || (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()),
                                        updatedAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date())
                                    };
                                    await setDoc(dref, payload);
                                }
                                showToast('CSV åŒ¯å…¥å®Œæˆ');
                                await loadMonth();
                                renderCalendar();
                                renderMonthlyList();
                                renderDayPanel();
                            } catch (e) {
                                console.error('CSV åŒ¯å…¥éŒ¯èª¤', e);
                                showToast('CSV åŒ¯å…¥å¤±æ•—', true);
                            } finally {
                                importInput.value = '';
                            }
                        };
                    }

                    el.querySelectorAll('[data-edit-month]').forEach(btn=>{
                        btn.addEventListener('click', async ()=>{
                            const [iso, idxStr] = btn.getAttribute('data-edit-month').split('__');
                            const idx = parseInt(idxStr,10);
                            const d = pageState.monthDocsMap[iso];
                            const s = Array.isArray(d?.shifts) ? d.shifts[idx] : null;
                            if (!s) return;
                            openAddScheduleModal({ iso, index: idx, shift: s });
                        });
                    });
                    el.querySelectorAll('[data-del-month]').forEach(btn=>{
                        btn.addEventListener('click', async ()=>{
                            const [iso, idxStr] = btn.getAttribute('data-del-month').split('__');
                            const idx = parseInt(idxStr,10);
                            const d = pageState.monthDocsMap[iso];
                            const s = Array.isArray(d?.shifts) ? d.shifts[idx] : null;
                            const postId = s?.__postId || pageState.selectedPostId;
                            const realIdx = (s?.__origIndex !== undefined) ? s.__origIndex : idx;
                            const id = `${communityId}__${postId}__${iso}`;
                            try {
                                const { Timestamp } = window.__fs || {};
                                const dsnap = await getDoc(doc(db,'communities', communityId, 'postSchedules', id));
                                const docData = dsnap.exists() ? dsnap.data() : null;
                                const isScheduledDay = !!docData?.isScheduledDay;
                                const shifts = Array.isArray(docData?.shifts) ? docData.shifts : [];
                                const newShifts = shifts.filter((_,i)=>i!==realIdx);
                                const payload = {
                                    communityId, postId, dateIso: iso,
                                    dateTS: (Timestamp?.fromDate ? Timestamp.fromDate(new Date(`${iso}T00:00:00`)) : new Date(`${iso}T00:00:00`)),
                                    isScheduledDay, shifts: newShifts,
                                    createdAt: docData?.createdAt || (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()),
                                    updatedAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date())
                                };
                                await setDoc(doc(db,'communities', communityId, 'postSchedules', id), payload);
                                showToast('å·²åˆªé™¤ç­è¡¨');
                                await loadMonth();
                                renderCalendar();
                                renderMonthlyList();
                                renderDayPanel();
                            } catch(e) { showToast('åˆªé™¤å¤±æ•—', true); }
                        });
                    });
                    el.querySelectorAll('[data-share-month]').forEach(btn=>{
                        btn.addEventListener('click', async ()=>{
                            const [iso, idxStr] = btn.getAttribute('data-share-month').split('__');
                            const idx = parseInt(idxStr,10);
                            const d = pageState.monthDocsMap[iso];
                            const s = Array.isArray(d?.shifts) ? d.shifts[idx] : null;
                            if (!s) return;
                            const start = s.start || '07:00';
                            const end = s.end || '19:00';
                            const assId = Array.isArray(s.assignees) ? (s.assignees[0] || '') : '';
                            const assName = assId ? getUserNameById(assId) : 'æœªæŒ‡æ´¾';
                            const dow = dayOfWeekLabel(iso);
                            const role = s.role || 'ä¿å…¨';
                            const endIso = s.endDateIso || iso;
                            const endDow = dayOfWeekLabel(endIso);
                            const displayPost = role === 'ä¿å…¨' ? (s.__postName || postName) : 'ç„¡';
                            const content = `è·ç¨±ï¼š${role}\nå“¨é»ï¼š${displayPost}\nä¸Šç­æ—¥æœŸï¼š${iso} ${dow}\nä¸Šç­æ™‚é–“ï¼š${start}\nä¸‹ç­æ—¥æœŸï¼š${endIso} ${endDow}\nä¸‹ç­æ™‚é–“ï¼š${end}\næŒ‡æ´¾äººå“¡ï¼š${assName}`;
                            try {
                                if (navigator.share) {
                                    await navigator.share({ title: 'ç­è¡¨', text: content });
                                } else {
                                    await navigator.clipboard.writeText(content);
                                    showToast('å·²è¤‡è£½ç­è¡¨è³‡è¨Š');
                                }
                                // åˆ†äº«å¾Œæ¨™è¨˜ç‚ºç¾é‡‘ç­
                                const { Timestamp } = window.__fs || {};
                                const postId = s?.__postId || pageState.selectedPostId;
                                const realIdx = (s?.__origIndex !== undefined) ? s.__origIndex : idx;
                                const id = `${communityId}__${postId}__${iso}`;
                                const dsnap = await getDoc(doc(db,'communities', communityId, 'postSchedules', id));
                                const docData = dsnap.exists() ? dsnap.data() : null;
                                const shifts = Array.isArray(docData?.shifts) ? docData.shifts : [];
                                const newShifts = shifts.map((sh,i)=> i===realIdx ? { ...sh, cashShift: true } : sh);
                                const payload = {
                                    communityId, postId, dateIso: iso,
                                    dateTS: (Timestamp?.fromDate ? Timestamp.fromDate(new Date(`${iso}T00:00:00`)) : new Date(`${iso}T00:00:00`)),
                                    isScheduledDay: !!docData?.isScheduledDay, shifts: newShifts,
                                    createdAt: docData?.createdAt || (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()),
                                    updatedAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date())
                                };
                                await setDoc(doc(db,'communities', communityId, 'postSchedules', id), payload);
                            } catch(_) {}
                        });
                    });
                    el.querySelectorAll('[data-copy-month]').forEach(btn=>{
                        btn.addEventListener('click', async ()=>{
                            const [iso, idxStr] = btn.getAttribute('data-copy-month').split('__');
                            const idx = parseInt(idxStr,10);
                            const d = pageState.monthDocsMap[iso];
                            const s = Array.isArray(d?.shifts) ? d.shifts[idx] : null;
                            if (!s) return;
                            const start = s.start || '07:00';
                            const end = s.end || '19:00';
                            const assId = Array.isArray(s.assignees) ? (s.assignees[0] || '') : '';
                            const assName = assId ? getUserNameById(assId) : 'æœªæŒ‡æ´¾';
                            const dow = dayOfWeekLabel(iso);
                            const role = s.role || 'ä¿å…¨';
                            const endIso = s.endDateIso || iso;
                            const endDow = dayOfWeekLabel(endIso);
                            const displayPost = role === 'ä¿å…¨' ? (s.__postName || postName) : 'ç„¡';
                            const content = `è·ç¨±ï¼š${role}\nå“¨é»ï¼š${displayPost}\nä¸Šç­æ—¥æœŸï¼š${iso} ${dow}\nä¸Šç­æ™‚é–“ï¼š${start}\nä¸‹ç­æ—¥æœŸï¼š${endIso} ${endDow}\nä¸‹ç­æ™‚é–“ï¼š${end}\næŒ‡æ´¾äººå“¡ï¼š${assName}`;
                            try {
                                await navigator.clipboard.writeText(content);
                                showToast('å·²è¤‡è£½ç­è¡¨è³‡è¨Š');
                            } catch(_) {}
                        });
                    });
                };

                const openAddScheduleModal = (edit = null) => {
                    const defaultDateIso = pageState.selectedDayIso || fmtYMD(new Date());
                    const defaultStart = edit?.shift?.start || '07:00';
                    const defaultEnd = edit?.shift?.end || '19:00';
                    const defaultEndDateIso = edit?.shift?.endDateIso || defaultDateIso;
                    const defaultRole = edit?.shift?.role || 'ä¿å…¨';
                    const defaultAss = Array.isArray(edit?.shift?.assignees) ? edit.shift.assignees[0] || '' : '';
                    const isAgg = (pageState.selectedPostId === ALL_POSTS_ID);
                    const currentPostId = edit?.shift?.__postId || pageState.selectedPostId;
                    const currentPostName = (isAgg && edit?.shift?.__postName) ? (edit.shift.__postName || '') : ((pageState.posts.find(p => p.id===currentPostId)?.name) || '');
                    const postsOptionsDatalist = pageState.posts.map(p => `<option value="${p.name||'æœªå‘½åå“¨é»'}"></option>`).join('');
                    const usersOptions = (pageState.userOptionsHTML && pageState.userOptionsHTML.length) ? pageState.userOptionsHTML : '<option value="" disabled>è«‹å…ˆå»ºç«‹æˆ–æŒ‡æ´¾äººå“¡</option>';
                    const startDow = dayOfWeekLabel(defaultDateIso);
                    const endDow = dayOfWeekLabel(defaultEndDateIso);
                    const modal = document.getElementById('modal-container');
                    if (!modal) return;
                    modal.innerHTML = `
                        <div class="modal-backdrop"></div>
                        <div class="modal-content max-w-[880px]">
                          <div class="text-lg font-semibold mb-3">${edit ? 'ç·¨è¼¯æ’ç­' : 'æ–°å¢æ’ç­'}</div>
                          <div class="grid grid-cols-8 gap-2 items-center">
                            <div class="col-span-2 text-sm text-gray-600">è§’è‰²</div>
                            <div class="col-span-6">
                              <select id="new-role" class="px-2 py-1 border rounded w-full">
                                ${['ç¸½å¹¹äº‹','ç§˜æ›¸','ä¿å…¨','æ¸…æ½”','æ©Ÿé›»'].map(r=>`<option value="${r}" ${r===defaultRole?'selected':''}>${r}</option>`).join('')}
                              </select>
                            </div>

                            <div class="col-span-2 text-sm text-gray-600">æŒ‡æ´¾äººå“¡</div>
                            <div class="col-span-6"><select id="new-assignee" class="px-2 py-1 border rounded w-full">${usersOptions}</select></div>

                            <div id="role-post-row" class="contents">
                              <div class="col-span-2 text-sm text-gray-600">å“¨é»</div>
                              <div class="col-span-6">
                                <input id="new-post-input" list="post-name-list" class="px-2 py-1 border rounded w-full" value="${currentPostName}" placeholder="è¼¸å…¥æˆ–é¸æ“‡å“¨é»"/>
                                <datalist id="post-name-list">${postsOptionsDatalist}</datalist>
                              </div>
                            </div>

                            <div class="col-span-2 text-sm text-gray-600 single-only">ä¸Šç­æ—¥æœŸ</div>
                            <div class="col-span-6 single-only"><input type="date" id="new-date" value="${defaultDateIso}" class="px-2 py-1 border rounded w-full"/></div>

                            <div class="col-span-2 text-sm text-gray-600 single-only">æ˜ŸæœŸ</div>
                            <div class="col-span-6 single-only"><input id="new-dow" class="px-2 py-1 border rounded w-full" value="${startDow}" readonly/></div>

                            <div class="col-span-2 text-sm text-gray-600">ä¸Šç­æ™‚é–“</div>
                            <div class="col-span-6"><input type="time" id="new-start-time" value="${defaultStart}" class="px-2 py-1 border rounded w-full"/></div>

                            <div class="col-span-2 text-sm text-gray-600">åŠ å…¥å°æ™‚æŒ‰éˆ•</div>
                            <div class="col-span-6">
                              <div class="flex items-center gap-2">
                                <button id="btn-add-9h" class="px-2 py-1 rounded border bg-white text-gray-700 hover:bg-gray-50">+9</button>
                                <button id="btn-add-12h" class="px-2 py-1 rounded border bg-white text-gray-700 hover:bg-gray-50">+12</button>
                              </div>
                            </div>

                            <!-- å¤šæ—¥æ¨¡å¼åˆ‡æ› -->
                            <div class="col-span-2 text-sm text-gray-600">æ—¥æœŸé¸æ“‡</div>
                            <div class="col-span-6">
                              <label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" id="multi-date-toggle"/> å¤šæ—¥æ¨¡å¼ï¼ˆä¸€æ¬¡å‹¾é¸å¤šå€‹æ—¥æœŸï¼‰</label>
                            </div>

                            <!-- å¤šæ—¥é¸æ“‡å™¨ï¼ˆåƒ…æ–°å¢ä½¿ç”¨ï¼‰ -->
                            <div class="col-span-2 text-sm text-gray-600 multi-only hidden">ä¸Šç­æ—¥æœŸï¼ˆå¤šé¸ï¼‰</div>
                            <div class="col-span-6 multi-only hidden">
                              <div class="flex items-center gap-2 mb-2">
                                <button id="multi-prev-month" class="px-2 py-1 rounded border bg-white text-gray-700 hover:bg-gray-50" title="ä¸Šä¸€æœˆ">ã€ˆ</button>
                                <span id="multi-month-label" class="text-sm font-medium"></span>
                                <button id="multi-next-month" class="px-2 py-1 rounded border bg-white text-gray-700 hover:bg-gray-50" title="ä¸‹ä¸€æœˆ">ã€‰</button>
                              </div>
                              <div id="multi-date-grid" class="grid grid-cols-7 gap-1"></div>
                              <div class="text-xs text-gray-600 mt-1">å·²é¸ <span id="multi-selected-count">0</span> å¤©</div>
                            </div>

                            <div class="col-span-2 text-sm text-gray-600 single-only">ä¸‹ç­æ—¥æœŸ</div>
                            <div class="col-span-6 single-only"><input type="date" id="new-end-date" value="${defaultEndDateIso}" class="px-2 py-1 border rounded w-full"/></div>

                            <div class="col-span-2 text-sm text-gray-600 single-only">æ˜ŸæœŸ</div>
                            <div class="col-span-6 single-only"><input id="new-end-dow" class="px-2 py-1 border rounded w-full" value="${endDow}" readonly/></div>

                            <div class="col-span-2 text-sm text-gray-600">ä¸‹ç­æ™‚é–“</div>
                            <div class="col-span-6"><input type="time" id="new-end-time" value="${defaultEnd}" class="px-2 py-1 border rounded w-full"/></div>


                          </div>
                          <div class="mt-4 flex items-center justify-end gap-2">
                            <button id="new-schedule-cancel" class="px-3 py-1 rounded border bg-white text-gray-700 hover:bg-gray-50">å–æ¶ˆ</button>
                            <button id="new-schedule-save" class="px-3 py-1 rounded bg-red-600 text-white hover:bg-red-700">${edit ? 'å„²å­˜' : 'æ–°å¢'}</button>
                          </div>
                        </div>`;
                    modal.classList.remove('hide');
                    try { lucide.createIcons(); } catch(_) {}

                    const roleSel = document.getElementById('new-role');
                    const postRow = document.getElementById('role-post-row');
                    const dateInput = document.getElementById('new-date');
                    const dowInput = document.getElementById('new-dow');
                    const endDateInput = document.getElementById('new-end-date');
                    const endDowInput = document.getElementById('new-end-dow');
                    const startTimeInput = document.getElementById('new-start-time');
                    const endTimeInput = document.getElementById('new-end-time');
                    const multiToggle = document.getElementById('multi-date-toggle');
                    const singleRows = Array.from(modal.querySelectorAll('.single-only'));
                    const multiRows = Array.from(modal.querySelectorAll('.multi-only'));
                    let viewMonthDate = new Date(`${defaultDateIso}T00:00:00`);
                    let selectedDates = new Set();

                    const togglePostRow = () => {
                        if (!roleSel || !postRow) return;
                        if (roleSel.value === 'ä¿å…¨') {
                            postRow.classList.remove('hidden');
                            postRow.classList.add('contents');
                        } else {
                            postRow.classList.add('hidden');
                            postRow.classList.remove('contents');
                        }
                    };
                    togglePostRow();
                    if (roleSel) roleSel.addEventListener('change', togglePostRow);

                    if (dateInput && dowInput) {
                        dateInput.addEventListener('change', ()=>{
                            const iso = dateInput.value;
                            dowInput.value = dayOfWeekLabel(iso);
                        });
                    }
                    if (endDateInput && endDowInput) {
                        endDateInput.addEventListener('change', ()=>{
                            const iso = endDateInput.value;
                            endDowInput.value = dayOfWeekLabel(iso);
                        });
                    }

                    const addHours = (h) => {
                        const iso = dateInput?.value || defaultDateIso;
                        const start = startTimeInput?.value || '07:00';
                        const addMin = h * 60;
                        const sm = parseHM(start);
                        let total = sm + addMin;
                        let endIsoCalc = iso;
                        if (total >= 24*60) {
                            total -= 24*60;
                            const d0 = new Date(`${iso}T00:00:00`);
                            d0.setDate(d0.getDate()+1);
                            endIsoCalc = fmtYMD(d0);
                        }
                        const hh = String(Math.floor(total/60)).padStart(2,'0');
                        const mm = String(total % 60).padStart(2,'0');
                        if (endTimeInput) endTimeInput.value = `${hh}:${mm}`;
                        if (endDateInput) endDateInput.value = endIsoCalc;
                        if (endDowInput) endDowInput.value = dayOfWeekLabel(endIsoCalc);
                    };

                    const btn9 = document.getElementById('btn-add-9h');
                    const btn12 = document.getElementById('btn-add-12h');
                    if (btn9) btn9.addEventListener('click', ()=> addHours(9));
                    if (btn12) btn12.addEventListener('click', ()=> addHours(12));

                    // å¤šæ—¥é¸æ“‡æ¸²æŸ“
                    const renderMultiGrid = () => {
                        const grid = document.getElementById('multi-date-grid');
                        const label = document.getElementById('multi-month-label');
                        if (!grid || !label) return;
                        const ym = `${viewMonthDate.getFullYear()}-${String(viewMonthDate.getMonth()+1).padStart(2,'0')}`;
                        label.textContent = ym;
                        const first = new Date(viewMonthDate.getFullYear(), viewMonthDate.getMonth(), 1);
                        const last = new Date(viewMonthDate.getFullYear(), viewMonthDate.getMonth()+1, 0);
                        const days = last.getDate();
                        const startDowIdx = first.getDay();
                        const cells = [];
                        for (let i=0;i<startDowIdx;i++) cells.push('<div class="h-8"></div>');
                        for (let d=1; d<=days; d++) {
                            const iso = fmtYMD(new Date(viewMonthDate.getFullYear(), viewMonthDate.getMonth(), d));
                            const active = selectedDates.has(iso);
                            cells.push(`<button class="h-8 rounded text-sm ${active? 'bg-blue-600 text-white':'bg-white text-gray-700 border'}" data-iso="${iso}">${d}</button>`);
                        }
                        grid.innerHTML = cells.join('');
                        const countEl = document.getElementById('multi-selected-count');
                        if (countEl) countEl.textContent = String(selectedDates.size);
                        grid.querySelectorAll('button[data-iso]').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const iso = btn.getAttribute('data-iso');
                                if (!iso) return;
                                if (selectedDates.has(iso)) selectedDates.delete(iso); else selectedDates.add(iso);
                                renderMultiGrid();
                            });
                        });
                    };
                    const prevM = document.getElementById('multi-prev-month');
                    const nextM = document.getElementById('multi-next-month');
                    if (prevM) prevM.addEventListener('click', ()=>{ viewMonthDate.setMonth(viewMonthDate.getMonth()-1); renderMultiGrid(); });
                    if (nextM) nextM.addEventListener('click', ()=>{ viewMonthDate.setMonth(viewMonthDate.getMonth()+1); renderMultiGrid(); });

                    // åˆ‡æ›å¤šæ—¥æ¨¡å¼é¡¯ç¤º/éš±è—å°æ‡‰æ¬„ä½
                    if (multiToggle) {
                        multiToggle.addEventListener('change', ()=>{
                            const on = multiToggle.checked;
                            singleRows.forEach(el => el.classList.toggle('hidden', on));
                            multiRows.forEach(el => el.classList.toggle('hidden', !on));
                            if (on) {
                                const initIso = dateInput?.value || defaultDateIso;
                                selectedDates = new Set(initIso ? [initIso] : []);
                                viewMonthDate = new Date(`${initIso}T00:00:00`);
                                renderMultiGrid();
                            }
                        });
                    }

                    const cancelBtn = document.getElementById('new-schedule-cancel');
                    if (cancelBtn) cancelBtn.addEventListener('click', ()=> { modal.classList.add('hide'); });

                    const saveBtn = document.getElementById('new-schedule-save');
                    if (saveBtn) saveBtn.addEventListener('click', async ()=>{
                        const roleVal = roleSel?.value || 'ä¿å…¨';
                        if (!edit && (pageState.selectedPostId === ALL_POSTS_ID) && roleVal !== 'ä¿å…¨') {
                            showToast('èšåˆæ¨¡å¼æ–°å¢åƒ…æ”¯æ´ã€Œä¿å…¨ã€ä¸”éœ€æŒ‡å®šå“¨é»', true);
                            return;
                        }
                        let postId = edit?.shift?.__postId || (pageState.selectedPostId === ALL_POSTS_ID ? null : pageState.selectedPostId) || null;
                        let nameVal = '';
                        if (roleVal === 'ä¿å…¨') {
                            nameVal = document.getElementById('new-post-input')?.value.trim() || '';
                            if (!nameVal) return showToast('è«‹è¼¸å…¥å“¨é»åç¨±', true);
                            const existing = pageState.posts.find(p => (p.name || '') === nameVal);
                            if (existing) {
                                postId = existing.id;
                            } else {
                                const { Timestamp } = window.__fs || {};
                                const newPostDoc = await addDoc(collection(db,'communities', communityId, 'posts'), {
                                    communityId,
                                    name: nameVal,
                                    createdAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()),
                                    updatedAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date())
                                });
                                postId = newPostDoc.id;
                            }
                        }
                        const iso = document.getElementById('new-date')?.value || defaultDateIso;
                        const endIso = document.getElementById('new-end-date')?.value || defaultEndDateIso;
                        const start = startTimeInput?.value || '07:00';
                        const end = endTimeInput?.value || '19:00';
                        const assId = document.getElementById('new-assignee')?.value || '';
                        if (!start || !end) return showToast('è«‹å®Œæ•´å¡«å¯«æ’ç­è³‡è¨Š', true);
                        if (roleVal === 'ä¿å…¨' && !postId) return showToast('è«‹è¼¸å…¥å“¨é»åç¨±', true);
                        const isMulti = !!multiToggle?.checked;
                        if (!isMulti && (!iso)) return showToast('è«‹é¸æ“‡ä¸Šç­æ—¥æœŸ', true);
                        if (!isMulti && endIso === iso && parseHM(end) <= parseHM(start)) return showToast('çµæŸæ™‚é–“éœ€æ™šæ–¼é–‹å§‹æ™‚é–“', true);
                        try {
                            const { Timestamp } = window.__fs || {};
                            const effPostId = (postId && postId !== ALL_POSTS_ID) ? postId : (edit?.shift?.__postId || pageState.selectedPostId);
                            const saveSingle = async () => {
                                const dref = doc(db,'communities', communityId, 'postSchedules', `${communityId}__${effPostId}__${iso}`);
                                const dsnap = await getDoc(dref);
                                const docData = dsnap.exists() ? dsnap.data() : null;
                                const shifts = Array.isArray(docData?.shifts) ? docData.shifts : [];
                                let newShifts = [];
                                if (edit && typeof edit.index === 'number') {
                                    const editRealIdx = (edit.shift?.__origIndex !== undefined) ? edit.shift.__origIndex : edit.index;
                                    newShifts = shifts.map((sh,i)=> i===editRealIdx ? { ...sh, start, end, assignees: assId ? [assId] : [], role: roleVal, endDateIso: endIso } : sh);
                                } else {
                                    newShifts = [...shifts, { start, end, assignees: assId ? [assId] : [], role: roleVal, endDateIso: endIso }];
                                }
                                const payload = {
                                    communityId, postId: effPostId, dateIso: iso,
                                    dateTS: (Timestamp?.fromDate ? Timestamp.fromDate(new Date(`${iso}T00:00:00`)) : new Date(`${iso}T00:00:00`)),
                                    isScheduledDay: !!docData?.isScheduledDay,
                                    shifts: newShifts,
                                    createdAt: docData?.createdAt || (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()),
                                    updatedAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date())
                                };
                                await setDoc(dref, payload);
                            };

                            const saveMulti = async () => {
                                if (selectedDates.size === 0) return showToast('è«‹å‹¾é¸è‡³å°‘ä¸€å€‹æ—¥æœŸ', true);
                                const tasks = [];
                                for (const isoSel of Array.from(selectedDates)) {
                                    let endIsoCalc = isoSel;
                                    if (parseHM(end) <= parseHM(start)) {
                                        const d0 = new Date(`${isoSel}T00:00:00`);
                                        d0.setDate(d0.getDate()+1);
                                        endIsoCalc = fmtYMD(d0);
                                    }
                                    const dref = doc(db,'communities', communityId, 'postSchedules', `${communityId}__${effPostId}__${isoSel}`);
                                    const dsnap = await getDoc(dref);
                                    const docData = dsnap.exists() ? dsnap.data() : null;
                                    const shifts = Array.isArray(docData?.shifts) ? docData.shifts : [];
                                    const newShifts = [...shifts, { start, end, assignees: assId ? [assId] : [], role: roleVal, endDateIso: endIsoCalc }];
                                    const payload = {
                                        communityId, postId: effPostId, dateIso: isoSel,
                                        dateTS: (Timestamp?.fromDate ? Timestamp.fromDate(new Date(`${isoSel}T00:00:00`)) : new Date(`${isoSel}T00:00:00`)),
                                        isScheduledDay: !!docData?.isScheduledDay,
                                        shifts: newShifts,
                                        createdAt: docData?.createdAt || (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date()),
                                        updatedAt: (Timestamp?.fromDate ? Timestamp.fromDate(new Date()) : new Date())
                                    };
                                    tasks.push(setDoc(dref, payload));
                                }
                                await Promise.all(tasks);
                                showToast(`å·²æ–°å¢ ${selectedDates.size} ç­†æ’ç­`);
                            };

                            if (isMulti && !edit) {
                                await saveMulti();
                            } else {
                                await saveSingle();
                                showToast(edit ? 'å·²æ›´æ–°æ’ç­' : 'å·²æ–°å¢æ’ç­');
                            }
                            modal.classList.add('hide');
                            if (pageState.selectedPostId !== ALL_POSTS_ID) {
                                pageState.selectedPostId = effPostId;
                            }
                            await loadMonth();
                            renderTabs();
                            renderPostTitle();
                            renderMonthHeader();
                            renderCalendar();
                            renderMonthlyList();
                            renderDayPanel();
                        } catch(e) {
                            const msg = (e && e.code === 'permission-denied') ? 'æ²’æœ‰ç¤¾å€å¯«å…¥æ¬Šé™ï¼Œè«‹ä½¿ç”¨ç®¡ç†ç«¯æˆ–ç¤¾å€ç®¡ç†å“¡èº«åˆ†' : 'å„²å­˜å¤±æ•—';
                            showToast(msg, true);
                        }
                    });
                };

                const init = async () => {
                    renderShell();
                    await loadPosts();
                    await loadCommunityUsers();
                    renderMonthHeader();
                    await loadMonth();
                    renderCalendar();
                    await renderMonthlyList();
                    await renderDayPanel();
                    updateCounts();
                };
                init();
            }

function renderGroupPatrolList(container) {
    // æ­¤åŠŸèƒ½å·²åœç”¨ï¼ˆä¿ç•™å‡½å¼ä»‹é¢é¿å…å¤–éƒ¨å¼•ç”¨è§¸ç™¼éŒ¯èª¤ï¼‰
    container.innerHTML = `<div class="p-4 text-gray-500">æ­¤åŠŸèƒ½å·²åœç”¨</div>`;
    try { lucide.createIcons(); } catch (_) {}
    return;
                const db = window.__db;
                const fs = window.__fs || {};
                const { collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, query, where, orderBy, Timestamp, serverTimestamp } = fs;
                const comm = state.currentCommunity;
                if (!comm || !comm.id) {
                    container.innerHTML = `<div class="p-6 text-center text-gray-500">è«‹å…ˆé¸æ“‡ç¤¾å€</div>`;
                    return;
                }

                const allowedRoles = new Set(['ç¸½å¹¹äº‹','ç§˜æ›¸','ä¿å…¨','æ¸…æ½”','æ©Ÿé›»']);
                const local = {
                    monthDate: new Date(new Date().getFullYear(), new Date().getMonth(), 1),
                    dayDate: new Date(),
                    usersCache: [],
                    pointsCache: [],
                    tasksCache: [],
                    logsByKey: {},
                    selectedPointId: 'all'
                };

                const fmtHM = (date) => {
                    if (!date || isNaN(date.getTime())) return '';
                    return `${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
                };
                const toDate = (tsOrDate) => tsOrDate?.toDate?.() || (tsOrDate instanceof Date ? tsOrDate : (tsOrDate ? new Date(tsOrDate) : null));
                const monthStart = () => new Date(local.monthDate.getFullYear(), local.monthDate.getMonth(), 1, 0, 0, 0, 0);
                const monthEnd = () => new Date(local.monthDate.getFullYear(), local.monthDate.getMonth()+1, 0, 23, 59, 59, 999);
                const fmtMonthLabel = () => `${local.monthDate.getFullYear()}å¹´ ${local.monthDate.getMonth()+1}æœˆ`;
                const fmtDayLabel = () => `${local.dayDate.getFullYear()}-${String(local.dayDate.getMonth()+1).padStart(2,'0')}-${String(local.dayDate.getDate()).padStart(2,'0')}`;

                const computeStatus = (expectedStartHM, expectedEndHM, actualStartTS, actualEndTS) => {
                    try {
                        const now = new Date();
                        const dayIso = `${local.dayDate.getFullYear()}-${String(local.dayDate.getMonth()+1).padStart(2,'0')}-${String(local.dayDate.getDate()).padStart(2,'0')}`;
                        const sDate = expectedStartHM ? new Date(`${dayIso}T${expectedStartHM}:00`) : null;
                        const eDate = expectedEndHM ? new Date(`${dayIso}T${expectedEndHM}:00`) : null;
                        const aStart = toDate(actualStartTS);
                        const aEnd = toDate(actualEndTS);
                        if (!aStart && sDate && now < sDate) return 'å°šæœªé–‹å§‹';
                        if (aStart && !aEnd) return 'é€²è¡Œä¸­';
                        if (aStart && aEnd) return 'å·²å®Œæˆ';
                        if (!aStart && eDate && now > eDate) return 'æœªåŸ·è¡Œ';
                        return 'å°šæœªé–‹å§‹';
                    } catch (_) { return 'å°šæœªé–‹å§‹'; }
                };

                container.innerHTML = `
                    <div class="p-3 space-y-3">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2 text-xs">
                                <button id="patrol-prev-day" class="px-2 py-1 rounded border bg-white text-gray-700 hover:bg-gray-50">ä¸Šä¸€æ—¥</button>
                                <span class="text-gray-600">æ—¥æœŸ</span>
                                <div id="patrol-current-day" class="text-xs font-medium">${fmtDayLabel()}</div>
                                <button id="patrol-next-day" class="px-2 py-1 rounded border bg-white text-gray-700 hover:bg-gray-50">ä¸‹ä¸€æ—¥</button>
                            </div>
                            <div class="flex items-center gap-2">
                                <button id="patrol-new-point" class="px-2 py-1 rounded bg-amber-600 text-white hover:bg-amber-700 text-xs">æ–°å¢å·¡é‚é …ç›®</button>
                                <button id="patrol-delete-all" class="px-2 py-1 rounded bg-red-600 text-white hover:bg-red-700 text-xs">å…¨éƒ¨åˆªé™¤</button>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 px-1"><div id="point-tabs" class="flex gap-2 overflow-x-auto"></div></div>
                        <div class="bg-white rounded-lg shadow overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-2 text-left whitespace-nowrap">å·¡é‚é»ç·¨è™Ÿ</th>
                                        <th class="px-3 py-2 text-left whitespace-nowrap">å·¡é‚é»åç¨±</th>
                                        <th class="px-3 py-2 text-left whitespace-nowrap">ä»»å‹™</th>
                                        <th class="px-3 py-2 text-left whitespace-nowrap">æŒ‡æ´¾äººå“¡</th>
                                        <th class="px-3 py-2 text-left whitespace-nowrap">é è¨ˆé–‹å§‹æ™‚é–“</th>
                                        <th class="px-3 py-2 text-left whitespace-nowrap">å¯¦éš›é–‹å§‹æ™‚é–“</th>
                                        <th class="px-3 py-2 text-left whitespace-nowrap">é è¨ˆçµæŸæ™‚é–“</th>
                                        <th class="px-3 py-2 text-left whitespace-nowrap">å¯¦éš›çµæŸæ™‚é–“</th>
                                        <th class="px-3 py-2 text-left whitespace-nowrap">ç‹€æ…‹</th>
                                        <th class="px-3 py-2 text-left whitespace-nowrap">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="patrol-rows">
                                    <tr><td colspan="10" class="px-3 py-3 text-center text-gray-500">æ­£åœ¨è¼‰å…¥ç•¶æ—¥å·¡é‚åˆ—è¡¨...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>`;
                try { lucide.createIcons(); } catch(_) {}

                const dayLabel = document.getElementById('patrol-current-day');
                const prevBtn = document.getElementById('patrol-prev-day');
                const nextBtn = document.getElementById('patrol-next-day');
                const rowsEl = document.getElementById('patrol-rows');
                const newPointBtn = document.getElementById('patrol-new-point');
                const pointTabsEl = document.getElementById('point-tabs');

                const renderPointTabs = () => {
                    if (!pointTabsEl) return;
                    // ä»¥ã€Œå·¡é‚é …ç›®ã€åç¨±ç”Ÿæˆåˆ†é ï¼ˆå…ˆå¾å·¡é‚é» tasksï¼Œè‹¥ç‚ºç©ºå‰‡å¾æœ¬æœˆä»»å‹™ checklistï¼‰
                    const names = (() => {
                        const set = new Set();
                        const pts = Array.isArray(local.pointsCache) ? local.pointsCache : [];
                        pts.forEach(p => {
                            const arr = Array.isArray(p.tasks) ? p.tasks : [];
                            arr.forEach(t => {
                                const nm = typeof t === 'string' ? t.trim() : ((t.name || t.title || t.itemName || '').trim());
                                if (nm) set.add(nm);
                            });
                            const iname = (p.itemName || '').trim();
                            if (iname) set.add(iname);
                        });
                        const tasks = Array.isArray(local.tasksCache) ? local.tasksCache : [];
                        tasks.forEach(tt => {
                            const cl = Array.isArray(tt.checklist) ? tt.checklist : [];
                            cl.forEach(ci => {
                                const nm = (typeof ci === 'string' ? ci : ((ci.title || ci.name || ci.itemName || '')).trim());
                                if (nm) set.add(nm);
                            });
                        });
                        return Array.from(set);
                    })();
                    const tabsData = [{ id: 'all', label: 'å…¨éƒ¨' }].concat(names.map(n => ({ id: n, label: n })));
                    pointTabsEl.innerHTML = tabsData.map(t => `
                        <button class="pt-tab-btn px-2 py-1 rounded border text-xs ${local.selectedPointId === t.id ? 'bg-amber-600 text-white border-amber-600' : 'bg-white text-gray-700 hover:bg-gray-50'}" data-id="${t.id}">${t.label}</button>
                    `).join('');
                    pointTabsEl.querySelectorAll('.pt-tab-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const id = btn.getAttribute('data-id') || 'all';
                            local.selectedPointId = id;
                            renderPointTabs();
                            renderRows();
                        });
                        // é€£çºŒå¿«æŒ‰å…©ä¸‹ï¼ˆé›™æ“Šï¼‰é–‹å•Ÿç·¨è¼¯/åˆªé™¤
                        btn.addEventListener('dblclick', () => {
                            const id = btn.getAttribute('data-id') || 'all';
                            if (id === 'all') return;
                            openManageItemModal(id);
                        });
                    });
                };

                // ç·¨è¼¯æˆ–åˆªé™¤ã€Œå·¡é‚é …ç›®ã€ï¼ˆä»¥é …ç›®ç‚ºå–®ä½ï¼Œä¸æ“ä½œå–®ä¸€å·¡é‚é»ï¼‰
                const openManageItemModal = (itemName) => {
                    let points = (Array.isArray(local.pointsCache) ? local.pointsCache : [])
                        .filter(p => ((p.itemName || '').trim() === itemName));
                    // å¾Œå‚™ï¼šè‹¥å°‘æ•¸èˆŠè³‡æ–™ç„¡ itemNameï¼Œæ”¹ä»¥æœ¬æœˆä»»å‹™ checklist åç¨±å°æ‡‰ pointId
                    if (!points.length) {
                        const matchedPointIds = new Set();
                        const tasks = Array.isArray(local.tasksCache) ? local.tasksCache : [];
                        tasks.forEach(tt => {
                            const cl = Array.isArray(tt.checklist) ? tt.checklist : [];
                            if (cl.some(ci => {
                                const nm = (typeof ci === 'string' ? ci : ((ci.title || ci.name || ci.itemName || '')).trim());
                                return nm === itemName;
                            })) {
                                if (tt.pointId) matchedPointIds.add(tt.pointId);
                            }
                        });
                        points = (Array.isArray(local.pointsCache) ? local.pointsCache : []).filter(p => matchedPointIds.has(p.pointId || p.id));
                    }
                    if (!points.length) { showToast('æ‰¾ä¸åˆ°æ­¤å·¡é‚é …ç›®', true); return; }

                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black/30 flex items-center justify-center z-50';
                    modal.innerHTML = `
                        <div class="bg-white rounded-lg shadow p-4 w-[420px]">
                            <div class="text-lg font-semibold mb-2">ç·¨è¼¯å·¡é‚é …ç›®</div>
                            <div class="text-sm text-gray-600 mb-3">ç›®å‰ã€Œ${itemName}ã€åŒ…å« ${points.length} å€‹å·¡é‚é»ã€‚</div>
                            <div class="flex items-center gap-2 mb-3">
                                <input id="manage-rename-input" class="px-2 py-1 rounded border text-sm w-full" placeholder="è¼¸å…¥æ–°é …ç›®åç¨±" value="${itemName}" />
                                <button id="manage-rename-apply" class="px-3 py-1 rounded bg-amber-600 text-white">å„²å­˜åç¨±</button>
                            </div>
                            <div class="mt-2 flex justify-between">
                                <button id="manage-cancel" class="px-3 py-1 rounded border">å–æ¶ˆ</button>
                                <button id="manage-delete-all" class="px-3 py-1 rounded bg-red-600 text-white">åˆªé™¤æ­¤å·¡é‚é …ç›®</button>
                            </div>
                        </div>`;
                    document.body.appendChild(modal);
                    const close = () => { try { document.body.removeChild(modal); } catch(_){} };
                    modal.querySelector('#manage-cancel')?.addEventListener('click', close);
                    modal.querySelector('#manage-delete-all')?.addEventListener('click', async () => {
                        const ok = confirm('ç¢ºå®šè¦åˆªé™¤è©²é …ç›®ä¸‹æ‰€æœ‰å·¡é‚é»åŠå…¶ç›¸é—œä»»å‹™ï¼Ÿ');
                        if (!ok) return;
                        close();
                        await deleteMultiplePointsByName(points);
                    });
                    const renameInput = modal.querySelector('#manage-rename-input');
                    modal.querySelector('#manage-rename-apply')?.addEventListener('click', async () => {
                        const newName = (renameInput?.value || '').trim();
                        if (!newName) { showToast('è«‹è¼¸å…¥æ–°åç¨±', true); return; }
                        if (newName === itemName) { showToast('åç¨±æœªè®Šæ›´'); return; }
                        const ok = confirm(`ç¢ºå®šå°‡ã€Œ${itemName}ã€æ”¹åç‚ºã€Œ${newName}ã€ï¼Ÿ`);
                        if (!ok) return;
                        close();
                        await renameItemPointsAndTasks(itemName, newName);
                    });
                };

                // åˆªé™¤å–®ä¸€å·¡é‚é»åŠå…¶ç›¸é—œä»»å‹™
                const deletePointAndRelatedTasks = async (point) => {
                    try {
                        showLoading(true);
                        const db2 = window.__db; const { collection, getDocs, query, where, doc, writeBatch } = window.__fs || {};
                        if (!db2 || !collection || !getDocs || !query || !where || !doc || !writeBatch) throw new Error('Firestore æœªåˆå§‹åŒ–');
                        const pid = point.id || point.pointId;
                        let batch = writeBatch(db2); let count = 0;
                        // åˆªé™¤å·¡é‚é»
                        batch.delete(doc(db2, 'communities', comm.id, 'patrolPoints', pid));
                        // åˆªé™¤ç›¸é—œä»»å‹™
                        const tsnap = await getDocs(query(collection(db2, 'communities', comm.id, 'patrolTasks'), where('pointId','==', pid)));
                        const taskIds = []; tsnap.forEach(d => taskIds.push(d.id));
                        for (const tid of taskIds) { batch.delete(doc(db2, 'communities', comm.id, 'patrolTasks', tid)); count++; if (count % 400 === 0) { await batch.commit(); batch = writeBatch(db2); } }
                        await batch.commit();
                        showToast('å·²åˆªé™¤å·¡é‚é»åŠç›¸é—œä»»å‹™');
                    } catch(e) {
                        console.error('åˆªé™¤å·¡é‚é»å¤±æ•—', e);
                        showToast('åˆªé™¤å¤±æ•—ï¼šè«‹æª¢æŸ¥æ¬Šé™', true);
                    } finally {
                        showLoading(false);
                        await loadPoints();
                        renderPointTabs();
                        await ensureTasksForMonth();
                        await loadTasksAndLogs();
                        renderRows();
                    }
                };

                // æ‰¹æ¬¡åˆªé™¤åŒä¸€é …ç›®åç¨±çš„æ‰€æœ‰å·¡é‚é»èˆ‡ä»»å‹™
                const deleteMultiplePointsByName = async (points) => {
                    try {
                        showLoading(true);
                        const db2 = window.__db; const { collection, getDocs, query, where, doc, writeBatch } = window.__fs || {};
                        if (!db2 || !collection || !getDocs || !query || !where || !doc || !writeBatch) throw new Error('Firestore æœªåˆå§‹åŒ–');
                        let batch = writeBatch(db2); let count = 0;
                        const pids = points.map(p => p.id || p.pointId).filter(Boolean);
                        // æ”¶é›†æ‰€æœ‰ç›¸é—œä»»å‹™ï¼ˆåˆ†æ‰¹è™•ç† in æ¢ä»¶ï¼‰
                        const taskIds = [];
                        const chunks = [];
                        for (let i = 0; i < pids.length; i += 10) chunks.push(pids.slice(i, i+10));
                        for (const chunk of chunks) {
                            const ts = await getDocs(query(collection(db2, 'communities', comm.id, 'patrolTasks'), where('pointId','in', chunk)));
                            ts.forEach(d => taskIds.push(d.id));
                        }
                        // åˆªé™¤å·¡é‚é»
                        for (const pid of pids) { batch.delete(doc(db2, 'communities', comm.id, 'patrolPoints', pid)); count++; if (count % 400 === 0) { await batch.commit(); batch = writeBatch(db2); } }
                        // åˆªé™¤ä»»å‹™
                        for (const tid of taskIds) { batch.delete(doc(db2, 'communities', comm.id, 'patrolTasks', tid)); count++; if (count % 400 === 0) { await batch.commit(); batch = writeBatch(db2); } }
                        await batch.commit();
                        showToast('å·²åˆªé™¤æ­¤åç¨±æ‰€æœ‰å·¡é‚é»èˆ‡ä»»å‹™');
                    } catch(e) {
                        console.error('æ‰¹æ¬¡åˆªé™¤å·¡é‚é»å¤±æ•—', e);
                        showToast('åˆªé™¤å¤±æ•—ï¼šè«‹æª¢æŸ¥æ¬Šé™', true);
                    } finally {
                        showLoading(false);
                        await loadPoints();
                        renderPointTabs();
                        await ensureTasksForMonth();
                        await loadTasksAndLogs();
                        renderRows();
                    }
                };


                // æ‰¹æ¬¡æ”¹ååŒä¸€é …ç›®åç¨±çš„æ‰€æœ‰å·¡é‚é»ï¼ˆåƒ…æ›´æ–° itemNameï¼Œä¸æ”¹å·¡é‚é»åç¨±ï¼‰
                const renameItemPointsAndTasks = async (oldName, newName) => {
                    try {
                        showLoading(true);
                        const db2 = window.__db; const { collection, getDocs, query, where, doc, writeBatch } = window.__fs || {};
                        if (!db2 || !collection || !getDocs || !query || !where || !doc || !writeBatch) throw new Error('Firestore æœªåˆå§‹åŒ–');
                        // æ‰¾å‡ºèˆŠé …ç›®åç¨±çš„æ‰€æœ‰å·¡é‚é»ï¼ˆä»¥ itemName æ¯”å°ï¼‰
                        const points = (Array.isArray(local.pointsCache) ? local.pointsCache : []).filter(p => ((p.itemName || '').trim() === oldName));
                        if (!points.length) { showToast('æ‰¾ä¸åˆ°è¦æ”¹åçš„å·¡é‚é …ç›®'); return; }
                        const pids = points.map(p => p.id || p.pointId).filter(Boolean);
                        let batch = writeBatch(db2); let count = 0;
                        // æ›´æ–°å·¡é‚é»çš„ itemName
                        for (const pid of pids) {
                            batch.update(doc(db2, 'communities', comm.id, 'patrolPoints', pid), { itemName: newName, updatedAt: new Date() });
                            count++; if (count % 400 === 0) { await batch.commit(); batch = writeBatch(db2); }
                        }
                        await batch.commit();
                        showToast('å·²å®Œæˆå·¡é‚é …ç›®æ”¹å');
                    } catch(e) {
                        console.error('æ”¹åå¤±æ•—', e);
                        showToast('æ”¹åå¤±æ•—ï¼šè«‹æª¢æŸ¥æ¬Šé™', true);
                    } finally {
                        showLoading(false);
                        await loadPoints();
                        // å°‡ç›®å‰é¸å–çš„é …ç›®åˆ‡è‡³æ–°åç¨±
                        local.selectedPointId = newName;
                        renderPointTabs();
                        await ensureTasksForMonth();
                        await loadTasksAndLogs();
                        renderRows();
                    }
                };

                const ensureUsers = async () => {
                    // ç›¡é‡ä½¿ç”¨ pageState å·²è¼‰å…¥çš„ç¤¾å€ä½¿ç”¨è€…
                    let users = Array.isArray(window.pageState?.communityUsers) ? window.pageState.communityUsers.slice() : [];
                    if (!users.length && db && collection && getDocs) {
                        const snap = await getDocs(collection(db, 'users'));
                        users = [];
                        snap.forEach(d => users.push({ id: d.id, name: d.data().name || d.data().displayName || d.id, ...d.data() }));
                    }
                    const currentCommId = state.currentCommunity?.id || null;
                    const currentCommCode = state.currentCommunity?.code || state.currentCommunity?.communityCode || null;
                    const usersByCommunity = (currentCommId || currentCommCode) ? users.filter(u => {
                        const byId = Array.isArray(u.serviceCommunities) && currentCommId ? u.serviceCommunities.includes(currentCommId) : false;
                        const codesArr = Array.isArray(u.serviceCommunityCodes) ? u.serviceCommunityCodes : [];
                        const byCode = currentCommCode ? (codesArr.includes(currentCommCode) || (u.serviceCommunityCode === currentCommCode)) : false;
                        const byLegacy = currentCommId ? ((u.serviceCommunityCode === currentCommId) || (codesArr.includes(currentCommId))) : false;
                        return byId || byCode || byLegacy;
                    }) : users;
                    local.usersCache = usersByCommunity.filter(u => allowedRoles.has((u.jobTitle || u.applicationTitle || u.role || '').trim()))
                        .sort((a,b)=> (a.name||'').localeCompare(b.name||'', 'zh-Hant'));
                };

                const loadPoints = async () => {
                    try {
                        const snap = await getDocs(collection(db, 'communities', comm.id, 'patrolPoints'));
                        local.pointsCache = [];
                        snap.forEach(d => local.pointsCache.push({ id: d.id, ...d.data() }));
                    } catch (e) {
                        console.warn('è¼‰å…¥å·¡é‚é»å¤±æ•—', e);
                        const isOffline = (!navigator.onLine) || ((e?.message || '').includes('offline'));
                        if (isOffline) {
                            if (!local.__offlinePointsWarned) {
                                try { showToast('ç›®å‰é›¢ç·šï¼Œå·¡é‚é …ç›®å¯èƒ½ç„¡æ³•è¼‰å…¥ï¼›å°‡é¡¯ç¤ºå¿«å–è³‡æ–™', true); } catch (_) {}
                                local.__offlinePointsWarned = true;
                            }
                            local.pointsCache = Array.isArray(local.pointsCache) ? local.pointsCache : [];
                        }
                    }
                };

                const ensureTasksForMonth = async () => {
                    if (!local.pointsCache.length) return;
                    const y = local.monthDate.getFullYear();
                    const m = local.monthDate.getMonth();
                    const todayStart = new Date(); todayStart.setHours(0,0,0,0);
                    for (let day=1; day<=new Date(y, m+1, 0).getDate(); day++) {
                        const d = new Date(y, m, day);
                        const dow = d.getDay();
                        const iso = `${y}-${String(m+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                        for (const p of local.pointsCache) {
                            const createdAtDate = toDate(p.createdAt) || new Date(0);
                            const baseline = createdAtDate > todayStart ? createdAtDate : todayStart;
                            if (d < baseline) continue; // åƒ…å¾ä»Šæ—¥æˆ–å»ºç«‹æ—¥é–‹å§‹ç”¢ç”Ÿ
                            const scheduled = (p.weekly === true) || (Array.isArray(p.daysOfWeek) && p.daysOfWeek.includes(dow));
                            if (!scheduled) continue;
                            const docId = `${comm.id}__${p.pointId || p.id}__${iso}`;
                            try {
                                const dref = doc(db, 'communities', comm.id, 'patrolTasks', docId);
                                const dsnap = await getDoc(dref);
                                if (!dsnap.exists()) {
                                    const checklist = Array.isArray(p.tasks) ? p.tasks.map((item, idx) => ({ index: idx+1, title: item, status: 'å°šæœªé–‹å§‹' })) : [];
                                    await setDoc(dref, {
                                        communityId: comm.id,
                                        pointId: p.pointId || p.id,
                                        pointName: p.name || '',
                                        pointCode: p.code || '',
                                        dateIso: iso,
                                        dateTS: Timestamp.fromDate(new Date(`${iso}T00:00:00`)),
                                        assignedRole: p.defaultAssigneeRole || '',
                                        assignedUserId: p.defaultAssigneeId || '',
                                        expectedStartHM: (typeof p.expectedStartHour === 'number' ? String(p.expectedStartHour).padStart(2,'0')+':00' : (p.expectedStartHM || '')),
                                        expectedEndHM: (typeof p.expectedEndHour === 'number' ? String(p.expectedEndHour).padStart(2,'0')+':00' : (p.expectedEndHM || '')),
                                        actualStartTS: null,
                                        actualEndTS: null,
                                        status: 'å°šæœªé–‹å§‹',
                                        checklist: checklist,
                                        createdAt: Timestamp.fromDate(new Date()),
                                        updatedAt: Timestamp.fromDate(new Date())
                                    });
                                }
                            } catch (e) { console.warn('å»ºç«‹å·¡é‚ä»»å‹™å¤±æ•—', e); }
                        }
                    }
                };

                const loadTasksAndLogs = async () => {
                    const startTS = Timestamp.fromDate(monthStart());
                    const endTS = Timestamp.fromDate(monthEnd());
                    const tasksSnap = await getDocs(query(collection(db, 'communities', comm.id, 'patrolTasks'), where('dateTS','>=', startTS), where('dateTS','<=', endTS), orderBy('dateTS')));
                    local.tasksCache = [];
                    tasksSnap.forEach(d => local.tasksCache.push({ id: d.id, ...d.data() }));
                    // è®€å–æ„Ÿæ‡‰ç´€éŒ„ï¼ˆæœ¬æœˆï¼‰
                    local.logsByKey = {};
                    try {
                        const logsSnap = await getDocs(query(collection(db, 'communities', comm.id, 'patrolLogs'), where('timestamp','>=', startTS), where('timestamp','<=', endTS)));
                        logsSnap.forEach(ld => {
                            const log = { id: ld.id, ...ld.data() };
                            const key = `${log.pointCode || ''}__${(log.timestamp?.toDate?.() || new Date(log.timestamp)).toISOString().split('T')[0]}`;
                            if (!local.logsByKey[key]) local.logsByKey[key] = [];
                            local.logsByKey[key].push(log);
                        });
                    } catch (e) { /* ç„¡ç´€éŒ„äº¦å¯ */ }
                };

                const renderRows = () => {
                    const dayIso = fmtDayLabel();
                    return renderPointsListRows();

                    const openPhotosModal = (t, photos) => {
                        const modal = document.createElement('div');
                        modal.className = 'fixed inset-0 bg-black/40 flex items-center justify-center z-50';
                        modal.innerHTML = `
                            <div class="bg-white rounded-lg shadow p-4 w-[720px] max-w-[90vw]">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="text-sm font-medium">${t.dateIso} ${t.pointName || ''} çš„æ‰“å¡ç…§ç‰‡</div>
                                    <button class="close px-2 py-1 rounded border text-xs">é—œé–‰</button>
                                </div>
                                <div class="grid grid-cols-3 gap-2" id="photo-grid">
                                    ${photos.length ? photos.map(u => `<div class=\"aspect-square overflow-hidden rounded border\"><img src=\"${u}\" class=\"w-full h-full object-cover\" /></div>`).join('') : `<div class=\"text-center text-gray-500 col-span-3 py-8\">æ²’æœ‰ç…§ç‰‡</div>`}
                                </div>
                            </div>`;
                        document.body.appendChild(modal);
                        modal.querySelector('.close')?.addEventListener('click', () => { try { document.body.removeChild(modal); } catch(_){} });
                    };

                    const openChecklistModal = (t) => {
                        const modal = document.createElement('div');
                        modal.className = 'fixed inset-0 bg-black/30 flex items-center justify-center z-50';
                        const items = Array.isArray(t.checklist) ? t.checklist : [];
                        modal.innerHTML = `
                            <div class="bg-white rounded-lg shadow p-4 w-[360px]">
                                <div class="text-lg font-semibold mb-2">${t.pointName || t.pointId || ''} çš„å·¡é‚ä»»å‹™</div>
                                <table class="min-w-full text-sm">
                                    <thead><tr><th class="text-left px-2">ç·¨è™Ÿ</th><th class="text-left px-2">é …ç›®</th><th class="text-left px-2">ç‹€æ³</th></tr></thead>
                                    <tbody>
                                        ${items.map(it => `<tr><td class=\"px-2\">${it.index}</td><td class=\"px-2\">${it.title}</td><td class=\"px-2\">${it.status || t.status || 'å°šæœªé–‹å§‹'}</td></tr>`).join('') || `<tr><td colspan=\"3\" class=\"px-2 py-2 text-center text-gray-500\">æœªè¨­å®šä»»å‹™</td></tr>`}
                                    </tbody>
                                </table>
                                <div class="mt-3 text-right"><button class="clo px-3 py-1 rounded border">é—œé–‰</button></div>
                            </div>`;
                        document.body.appendChild(modal);
                        modal.querySelector('.clo')?.addEventListener('click', () => { try { document.body.removeChild(modal); } catch(_){} });
                    };

                    const fetchClockInPhotosForTask = async (t) => {
                        try {
                            if (!t || !t.dateIso) return [];
                            const dayStart = new Date(`${t.dateIso}T00:00:00`);
                            const dayEnd = new Date(`${t.dateIso}T23:59:59`);
                            const startTS = Timestamp.fromDate(dayStart);
                            const endTS = Timestamp.fromDate(dayEnd);
                            const conds = [
                                where('timestamp', '>=', startTS),
                                where('timestamp', '<=', endTS)
                            ];
                            if (t.assignedUserId) conds.push(where('userId', '==', t.assignedUserId));
                            const snap = await getDocs(query(collection(db, 'clockInRecords'), ...conds));
                            const urls = [];
                            snap.forEach(d => {
                                const data = d.data();
                                if (Array.isArray(data.photoUrls)) {
                                    data.photoUrls.forEach(u => { if (typeof u === 'string') urls.push(u); });
                                }
                            });
                            return Array.from(new Set(urls));
                        } catch (e) {
                            console.warn('è¼‰å…¥æ‰“å¡ç…§ç‰‡å¤±æ•—', e);
                            return [];
                        }
                    };

                    const userOptions = local.usersCache.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
                    const rows = filtered.map(t => {
                        const key = `${t.pointCode || ''}__${t.dateIso}`;
                        const logs = local.logsByKey[key] || [];
                        const startLog = logs.filter(l => l.action === 'start').sort((a,b)=> toDate(a.timestamp) - toDate(b.timestamp))[0] || null;
                        const endLog = logs.filter(l => l.action === 'end').sort((a,b)=> toDate(b.timestamp) - toDate(a.timestamp))[0] || null;
                        const actualStartStr = startLog ? fmtHM(toDate(startLog.timestamp)) : '';
                        const actualEndStr = endLog ? fmtHM(toDate(endLog.timestamp)) : '';
                        const statusText = computeStatus(t.expectedStartHM, t.expectedEndHM, startLog?.timestamp, endLog?.timestamp);
                        const hasChecklist = Array.isArray(t.checklist) && t.checklist.length > 0;
                        return `
                            <tr data-task-id="${t.id}" data-point-id="${t.pointId || ''}">
                                <!-- æ—¥æœŸæ¬„å·²ç§»é™¤ï¼ˆæ¯æ—¥è¦–åœ–ï¼‰ -->
                                <td class="px-3 py-2 whitespace-nowrap text-amber-700 underline cursor-pointer point-edit">${t.pointId || ''}</td>
                                <td class="px-3 py-2 whitespace-nowrap">${t.pointName || ''}</td>
                                <td class="px-3 py-2 whitespace-nowrap">${hasChecklist ? `<button class=\"checklist-btn px-2 py-1 rounded border text-xs\">ä»»å‹™</button>` : ''}</td>
                                <td class="px-3 py-2 whitespace-nowrap">
                                    <select class="assign-select border rounded px-2 py-1">
                                        <option value="">æœªæŒ‡æ´¾</option>
                                        ${userOptions}
                                    </select>
                                </td>
                                <td class="px-3 py-2 whitespace-nowrap">
                                    <input type="time" step="3600" class="expected-start border rounded px-2 py-1" value="${t.expectedStartHM || ''}" />
                                </td>
                                <td class="px-3 py-2 whitespace-nowrap">${actualStartStr}</td>
                                <td class="px-3 py-2 whitespace-nowrap">
                                    <input type="time" step="3600" class="expected-end border rounded px-2 py-1" value="${t.expectedEndHM || ''}" />
                                </td>
                                <td class="px-3 py-2 whitespace-nowrap">${actualEndStr}</td>
                                <td class="px-3 py-2 whitespace-nowrap">${statusText}</td>
                                <td class="px-3 py-2 whitespace-nowrap">
                                    <div class="flex items-center gap-2">
                                        <button class="save-task bg-amber-500 text-white px-2 py-1 rounded text-xs">ç·¨è¼¯</button>
                                        <button class="photos-task bg-slate-600 text-white px-2 py-1 rounded text-xs">ç…§ç‰‡</button>
                                        <button class="delete-task bg-red-600 text-white px-2 py-1 rounded text-xs">åˆªé™¤</button>
                                    </div>
                                </td>
                            </tr>`;
                    });
                    rowsEl.innerHTML = rows.join('');
                    try { lucide.createIcons(); } catch(_) {}

                    rowsEl.querySelectorAll('tr').forEach(tr => {
                        const taskId = tr.getAttribute('data-task-id');
                        const pointId = tr.getAttribute('data-point-id');
                        const t = filtered.find(x => x.id === taskId);
                        const assignSel = tr.querySelector('.assign-select');
                        const expStart = tr.querySelector('.expected-start');
                        const expEnd = tr.querySelector('.expected-end');
                        if (assignSel) assignSel.value = t?.assignedUserId || '';
                        // æŒ‡æ´¾äººå“¡è‡ªå‹•å„²å­˜
                        assignSel?.addEventListener('change', async () => {
                            const newAssignedId = assignSel?.value || '';
                            const newAssignedRole = local.usersCache.find(u => u.id === newAssignedId)?.role || '';
                            try {
                                const dref = doc(db, 'communities', comm.id, 'patrolTasks', taskId);
                                await updateDoc(dref, { assignedUserId: newAssignedId, assignedRole: newAssignedRole || '', updatedAt: Timestamp.fromDate(new Date()) });
                                showToast('å·²å„²å­˜æŒ‡æ´¾äººå“¡');
                            } catch (e) { console.error('è‡ªå‹•å„²å­˜å¤±æ•—', e); showToast('è‡ªå‹•å„²å­˜å¤±æ•—', true); }
                        });
                        // æ™‚é–“è®Šæ›´ä»ç”¨ã€Œç·¨è¼¯ã€æŒ‰éˆ•å„²å­˜
                        tr.querySelector('.save-task')?.addEventListener('click', async () => {
                            const newStart = expStart?.value || t.expectedStartHM || '';
                            const newEnd = expEnd?.value || t.expectedEndHM || '';
                            try {
                                const dref = doc(db, 'communities', comm.id, 'patrolTasks', taskId);
                                await updateDoc(dref, { expectedStartHM: newStart, expectedEndHM: newEnd, updatedAt: Timestamp.fromDate(new Date()) });
                                showToast('å·²æ›´æ–°å·¡é‚ä»»å‹™');
                                await loadTasksAndLogs();
                                renderRows();
                            } catch (e) { console.error('æ›´æ–°å·¡é‚ä»»å‹™å¤±æ•—', e); showToast('æ›´æ–°å¤±æ•—ï¼šè«‹æª¢æŸ¥æ¬Šé™', true); }
                        });
                        tr.querySelector('.delete-task')?.addEventListener('click', async () => {
                            if (!confirm('ç¢ºå®šåˆªé™¤æ­¤å·¡é‚ä»»å‹™ï¼Ÿ')) return;
                            try {
                                await deleteDoc(doc(db, 'communities', comm.id, 'patrolTasks', taskId));
                                showToast('å·²åˆªé™¤å·¡é‚ä»»å‹™');
                                await loadTasksAndLogs();
                                renderRows();
                            } catch (e) { console.error('åˆªé™¤å·¡é‚ä»»å‹™å¤±æ•—', e); showToast('åˆªé™¤å¤±æ•—ï¼šè«‹æª¢æŸ¥æ¬Šé™', true); }
                        });
                        tr.querySelector('.point-edit')?.addEventListener('click', () => {
                            const p = local.pointsCache.find(pp => (pp.pointId||pp.id) === pointId);
                            if (p) openEditPointModal(p);
                        });
                        tr.querySelector('.checklist-btn')?.addEventListener('click', () => openChecklistModal(t));
                        tr.querySelector('.photos-task')?.addEventListener('click', async () => {
                            const photos = await fetchClockInPhotosForTask(t);
                            openPhotosModal(t, photos);
                        });
                    });
                };

                const renderPointsListRows = () => {
                    const dayIso = fmtDayLabel();
                    const points = Array.isArray(local.pointsCache) ? local.pointsCache : [];
                    const filteredPoints = local.selectedPointId === 'all' ? points : points.filter(p => {
                        const byItemName = ((p.itemName || '').trim() === local.selectedPointId);
                        if (byItemName) return true;
                        const arr = Array.isArray(p.tasks) ? p.tasks : [];
                        const matchFromPointTasks = arr.some(t => {
                            const nm = typeof t === 'string' ? t.trim() : ((t.name || t.title || t.itemName || '').trim());
                            return nm === local.selectedPointId;
                        });
                        if (matchFromPointTasks) return true;
                        const pid = p.pointId || p.id;
                        const tasks = Array.isArray(local.tasksCache) ? local.tasksCache : [];
                        return tasks.some(tt => (tt.pointId === pid) && Array.isArray(tt.checklist) && tt.checklist.some(ci => {
                            const nm = (typeof ci === 'string' ? ci : ((ci.title || ci.name || ci.itemName || '')).trim());
                            return nm === local.selectedPointId;
                        }));
                    });
                    if (!Array.isArray(filteredPoints) || !filteredPoints.length) {
                        rowsEl.innerHTML = `<tr><td colspan="10" class="px-3 py-3 text-center text-gray-500">å°šç„¡å·¡é‚é»</td></tr>`;
                        return;
                    }
                    const rows = filteredPoints.map(p => {
                        const pid = p.pointId || p.id || '';
                        const todayTasksCount = Array.isArray(local.tasksCache) ? local.tasksCache.filter(t => t.dateIso === dayIso && (t.pointId || '') === pid).length : 0;
                        const startHM = (typeof p.expectedStartHour === 'number' ? String(p.expectedStartHour).padStart(2,'0')+':00' : (p.expectedStartHM || ''));
                        const endHM = (typeof p.expectedEndHour === 'number' ? String(p.expectedEndHour).padStart(2,'0')+':00' : (p.expectedEndHM || ''));
                        return `
                            <tr data-point-id="${pid}">
                                <td class="px-3 py-2 whitespace-nowrap text-amber-700 underline cursor-pointer point-edit">${pid}</td>
                                <td class="px-3 py-2 whitespace-nowrap">${p.pointName || p.name || ''}</td>
                                <td class="px-3 py-2 whitespace-nowrap">${todayTasksCount ? `${todayTasksCount}ä»¶` : ''}</td>
                                <td class="px-3 py-2 whitespace-nowrap">-</td>
                                <td class="px-3 py-2 whitespace-nowrap">${startHM}</td>
                                <td class="px-3 py-2 whitespace-nowrap"></td>
                                <td class="px-3 py-2 whitespace-nowrap">${endHM}</td>
                                <td class="px-3 py-2 whitespace-nowrap"></td>
                                <td class="px-3 py-2 whitespace-nowrap"></td>
                                <td class="px-3 py-2 whitespace-nowrap">
                                    <div class="flex items-center gap-2">
                                        <button class="point-edit bg-amber-500 text-white px-2 py-1 rounded text-xs">ç·¨è¼¯</button>
                                        <button class="point-delete bg-red-600 text-white px-2 py-1 rounded text-xs">åˆªé™¤</button>
                                    </div>
                                </td>
                            </tr>`;
                    });
                    rowsEl.innerHTML = rows.join('');
                    try { lucide.createIcons(); } catch(_) {}
                    rowsEl.querySelectorAll('tr').forEach(tr => {
                        const pointId = tr.getAttribute('data-point-id');
                        const p = filteredPoints.find(pp => (pp.pointId || pp.id) === pointId);
                        tr.querySelector('.point-edit')?.addEventListener('click', () => { if (p) openEditPointModal(p); });
                        tr.querySelector('.point-delete')?.addEventListener('click', async () => {
                            if (!p) return;
                            if (!confirm('ç¢ºå®šåˆªé™¤æ­¤å·¡é‚é»åŠå…¶ç›¸é—œä»»å‹™ï¼Ÿ')) return;
                            try {
                                await deletePointAndRelatedTasks(p);
                                showToast('å·²åˆªé™¤å·¡é‚é»åŠæœ¬æœˆä»»å‹™');
                                await loadPoints();
                                await loadTasksAndLogs();
                                renderPointTabs();
                                renderRows();
                            } catch (e) { console.error('åˆªé™¤å·¡é‚é»å¤±æ•—', e); showToast('åˆªé™¤å¤±æ•—ï¼šè«‹æª¢æŸ¥æ¬Šé™', true); }
                        });
                    });
                };

                const renderAll = async () => {
                    dayLabel.textContent = fmtDayLabel();
                    if (!local.selectedPointId) local.selectedPointId = 'all';
                    rowsEl.innerHTML = `<tr><td colspan="10" class="px-3 py-3 text-center text-gray-500">æ­£åœ¨è¼‰å…¥ç•¶æ—¥å·¡é‚åˆ—è¡¨...</td></tr>`;
                    await ensureUsers();
                    await loadPoints();
                    await ensureTasksForMonth();
                    await loadTasksAndLogs();
                    renderPointTabs();
                    renderRows();
                };

                prevBtn.addEventListener('click', () => { 
                    local.dayDate = new Date(local.dayDate.getFullYear(), local.dayDate.getMonth(), local.dayDate.getDate()-1);
                    local.monthDate = new Date(local.dayDate.getFullYear(), local.dayDate.getMonth(), 1);
                    renderAll();
                });
                nextBtn.addEventListener('click', () => { 
                    local.dayDate = new Date(local.dayDate.getFullYear(), local.dayDate.getMonth(), local.dayDate.getDate()+1);
                    local.monthDate = new Date(local.dayDate.getFullYear(), local.dayDate.getMonth(), 1);
                    renderAll();
                });

                const deleteAllBtn = document.getElementById('patrol-delete-all');
                if (deleteAllBtn) deleteAllBtn.addEventListener('click', async () => {
                    if (!confirm('ç¢ºå®šåˆªé™¤æœ¬æœˆå…¨éƒ¨å·¡é‚ä»»å‹™ï¼Ÿ')) return;
                    try {
                        const startTS = Timestamp.fromDate(monthStart());
                        const endTS = Timestamp.fromDate(monthEnd());
                        const qsnap = await getDocs(query(collection(db, 'communities', comm.id, 'patrolTasks'), where('dateTS','>=', startTS), where('dateTS','<=', endTS)));
                        const ids = [];
                        qsnap.forEach(d => ids.push(d.id));
                        for (const id of ids) {
                            await deleteDoc(doc(db, 'communities', comm.id, 'patrolTasks', id));
                        }
                        showToast('å·²åˆªé™¤æœ¬æœˆå…¨éƒ¨å·¡é‚ä»»å‹™');
                        await loadTasksAndLogs();
                        renderRows();
                    } catch (e) { console.error('åˆªé™¤å…¨éƒ¨å·¡é‚ä»»å‹™å¤±æ•—', e); showToast('åˆªé™¤å¤±æ•—ï¼šè«‹æª¢æŸ¥æ¬Šé™', true); }
                });

                const openNewPointModal = () => {
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black/30 flex items-center justify-center z-50';
                    modal.innerHTML = `
                        <div class="bg-white rounded-lg shadow p-4 w-[360px]">
                            <div class="text-lg font-semibold mb-2">æ–°å¢å·¡é‚é …ç›®</div>
                            <div class="space-y-2">
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="text-sm">é è¨ˆé–‹å§‹æ™‚é–“(æ™‚)</label>
                                        <input id="pt-start" type="time" step="3600" class="w-full border rounded px-2 py-1" value="08:00" />
                                    </div>
                                    <div>
                                        <label class="text-sm">é è¨ˆçµæŸæ™‚é–“(æ™‚)</label>
                                        <input id="pt-end" type="time" step="3600" class="w-full border rounded px-2 py-1" value="09:00" />
                                    </div>
                                </div>
                                <div>
                                    <label class="text-sm">åŸ·è¡Œè¡Œç¨‹</label>
                                    <div class="space-y-1 text-sm">
                                        <label class="inline-flex items-center gap-2"><input type="checkbox" id="pt-weekly" /> æ¯é€± (7å¤©)</label>
                                        <div class="grid grid-cols-7 gap-1">
                                            <label class="inline-flex items-center gap-1"><input type="checkbox" class="pt-dow" value="0" />æ—¥</label>
                                            <label class="inline-flex items-center gap-1"><input type="checkbox" class="pt-dow" value="1" />ä¸€</label>
                                            <label class="inline-flex items-center gap-1"><input type="checkbox" class="pt-dow" value="2" />äºŒ</label>
                                            <label class="inline-flex items-center gap-1"><input type="checkbox" class="pt-dow" value="3" />ä¸‰</label>
                                            <label class="inline-flex items-center gap-1"><input type="checkbox" class="pt-dow" value="4" />å››</label>
                                            <label class="inline-flex items-center gap-1"><input type="checkbox" class="pt-dow" value="5" />äº”</label>
                                            <label class="inline-flex items-center gap-1"><input type="checkbox" class="pt-dow" value="6" />å…­</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3 flex justify-end gap-2">
                                <button id="pt-cancel" class="px-3 py-1 rounded border">å–æ¶ˆ</button>
                                <button id="pt-save" class="px-3 py-1 rounded bg-amber-600 text-white">å„²å­˜</button>
                            </div>
                        </div>`;
                    document.body.appendChild(modal);
                    // å·²ç§»é™¤é ‚éƒ¨å·¡é‚é»æ¬„ä½ï¼ˆæ”¹ä»¥å­åˆ†é è¼¸å…¥ï¼‰

                    // æ–°å¢å·¡é‚é …ç›®ï¼ˆå¯åŒ…å«å¤šå€‹å·¡é‚é»ï¼‰çš„å°åˆ†é 
                    const itemNameWrap = document.createElement('div');
                    itemNameWrap.innerHTML = `
                        <div>
                            <label class="text-sm">å·¡é‚é …ç›®åç¨±ï¼ˆå¯è‡ªå®šç¾©ï¼‰</label>
                            <input id="it-name" class="w-full border rounded px-2 py-1" placeholder="ä¾‹å¦‚ï¼šæ—©ç­å…¬å…±å€å·¡æª¢" />
                        </div>`;
                    modal.querySelector('.space-y-2').insertBefore(itemNameWrap, modal.querySelector('.space-y-2').firstChild);

                    // å‹•æ…‹å°åˆ†é å®¹å™¨
                    const tabsHeader = document.createElement('div');
                    tabsHeader.className = 'flex items-center justify-between';
                    tabsHeader.innerHTML = `
                        <div id="sub-tab-header" class="flex gap-2"></div>
                        <button id="sub-tab-add" class="px-2 py-1 rounded border text-xs">+</button>`;
                    modal.querySelector('.space-y-2').insertBefore(tabsHeader, itemNameWrap.nextSibling);
                    const contentWrap = document.createElement('div');
                    contentWrap.id = 'sub-tab-content';
                    modal.querySelector('.space-y-2').insertBefore(contentWrap, tabsHeader.nextSibling);

                    const genCode12Local = () => {
                        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz0123456789';
                        let s = '';
                        for (let i = 0; i < 12; i++) s += chars.charAt(Math.floor(Math.random() * chars.length));
                        return s;
                    };

                    const subTabs = [];
                    const activateTab = (idx) => {
                        subTabs.forEach((t, i) => {
                            t.headerBtn.classList.toggle('bg-amber-600', i === idx);
                            t.headerBtn.classList.toggle('text-white', i === idx);
                            t.headerBtn.classList.toggle('border-amber-600', i === idx);
                            t.content.style.display = i === idx ? 'block' : 'none';
                        });
                    };

                    const addSubTab = (initial = {}) => {
                        const idx = subTabs.length;
                        const headerBtn = document.createElement('button');
                        headerBtn.className = 'px-2 py-1 rounded border text-xs bg-white text-gray-700 hover:bg-gray-50';
                        headerBtn.textContent = 'å·¡é‚é»ç·¨è™Ÿ';
                        let __secretClicks = 0; let __secretTimer = null;
                        headerBtn.addEventListener('click', async () => {
                            activateTab(idx);
                            // éš±è—åŠŸèƒ½ï¼šé€£çºŒé»æ“Š10æ¬¡é‡ç½®ç¤¾å€å·¡é‚ä»»å‹™
                            try {
                                clearTimeout(__secretTimer);
                                __secretClicks++;
                                __secretTimer = setTimeout(() => { __secretClicks = 0; }, 2500);
                                if (__secretClicks >= 10) {
                                    __secretClicks = 0;
                                    clearTimeout(__secretTimer);
                                    if (!confirm('é€£çºŒé»æ“Šå·²è§¸ç™¼é‡ç½®ã€‚æ˜¯å¦æ¸…é™¤è©²ç¤¾å€æ‰€æœ‰å·¡é‚ä»»å‹™ï¼Ÿ')) return;
                                    const db2 = window.__db; const { collection, getDocs, doc, writeBatch } = window.__fs || {};
                                    showLoading(true);
                                    try {
                                        const snapAll = await getDocs(collection(db2, 'communities', comm.id, 'patrolTasks'));
                                        const ids = []; snapAll.forEach(d => ids.push(d.id));
                                        if (!ids.length) { showToast('ç›®å‰æ²’æœ‰å·¡é‚ä»»å‹™å¯æ¸…é™¤'); }
                                        else {
                                            let batch = writeBatch(db2); let count = 0;
                                            for (const id of ids) { batch.delete(doc(db2, 'communities', comm.id, 'patrolTasks', id)); count++; if (count % 400 === 0) { await batch.commit(); batch = writeBatch(db2); } }
                                            await batch.commit();
                                            showToast('å·²é‡ç½®è©²ç¤¾å€æ‰€æœ‰å·¡é‚ä»»å‹™');
                                            await loadTasksAndLogs();
                                            renderRows();
                                        }
                                    } catch (e) { console.error('é‡ç½®å·¡é‚ä»»å‹™å¤±æ•—', e); showToast('é‡ç½®å¤±æ•—ï¼šè«‹æª¢æŸ¥æ¬Šé™', true); }
                                    finally { showLoading(false); }
                                }
                            } catch (_) {}
                        });
                        const headerEl = modal.querySelector('#sub-tab-header');
                        headerEl.appendChild(headerBtn);

                        const content = document.createElement('div');
                        content.className = 'space-y-2';
                        content.style.display = 'none';
                        content.innerHTML = `
                            <div>
                                <label class="text-sm">å·¡é‚é»ç·¨è™Ÿ</label>
                                <input class="st-id w-full border rounded px-2 py-1" placeholder="å¦‚ P-001" />
                            </div>
                            <div>
                                <label class="text-sm">å·¡é‚é»åç¨±</label>
                                <input class="st-name w-full border rounded px-2 py-1" placeholder="å¦‚ Aæ£Ÿä¸­åº­" />
                            </div>
                            <div>
                                <label class="text-sm">å·¡é‚é» code (12ä½æ•¸)</label>
                                <div class="flex items-center gap-2">
                                    <input class="st-code flex-1 border rounded px-2 py-1" />
                                    <button class="st-code-regenerate px-2 py-1 rounded border text-xs">é‡æ–°ç”¢ç”Ÿ</button>
                                </div>
                            </div>
                            <div>
                                <label class="text-sm">å·¡é‚é»ä»»å‹™</label>
                                <div class="st-tasks space-y-1"></div>
                                <button class="st-task-add mt-1 px-2 py-1 rounded border text-xs">æ–°å¢ä»»å‹™</button>
                            </div>`;
                        contentWrap.appendChild(content);

                        const stId = content.querySelector('.st-id');
                        const stName = content.querySelector('.st-name');
                        const stCode = content.querySelector('.st-code');
                        const stTasksWrap = content.querySelector('.st-tasks');
                        const stAddTask = content.querySelector('.st-task-add');
                        const stCodeRegen = content.querySelector('.st-code-regenerate');

                        const addTaskField = (text = '') => {
                            const idx2 = (stTasksWrap?.children?.length || 0) + 1;
                            const row = document.createElement('div');
                            row.className = 'flex items-center gap-2';
                            row.innerHTML = `<span class="text-xs text-gray-500 w-5 text-right">${idx2}</span>
                                <input class="st-task-input flex-1 border rounded px-2 py-1" placeholder="ä¾‹å¦‚ï¼šæª¢æŸ¥æ»…ç«å™¨å£“åŠ›" />
                                <button class="st-task-remove px-2 py-1 rounded border text-xs">ç§»é™¤</button>`;
                            stTasksWrap.appendChild(row);
                            row.querySelector('.st-task-remove')?.addEventListener('click', () => {
                                stTasksWrap.removeChild(row);
                                Array.from(stTasksWrap.children).forEach((c, i) => { const s = c.querySelector('span'); if (s) s.textContent = String(i + 1); });
                            });
                            if (text) row.querySelector('.st-task-input').value = text;
                        };
                        addTaskField();
                        stAddTask.addEventListener('click', () => addTaskField());
                        stCode.value = genCode12Local();
                        stCodeRegen.addEventListener('click', () => { stCode.value = genCode12Local(); });

                        // åˆå§‹åŒ–ï¼šè‹¥æœ‰å·¡é‚é …ç›®åç¨±å‰‡é å¡«
                        const itNameInput = modal.querySelector('#it-name');
                        if (itNameInput && itNameInput.value && !initial.name) stName.value = itNameInput.value;
                        if (initial.id) stId.value = initial.id;
                        if (initial.name) stName.value = initial.name;
                        if (initial.code) stCode.value = initial.code;
                        if (Array.isArray(initial.tasks)) {
                            stTasksWrap.innerHTML = '';
                            initial.tasks.forEach(t => addTaskField(t));
                        }

                        const tabObj = { headerBtn, content, stId, stName, stCode, stTasksWrap };
                        subTabs.push(tabObj);
                        activateTab(idx);
                    };

                    // å»ºç«‹ç¬¬ä¸€å€‹å°åˆ†é 
                    addSubTab();
                    modal.querySelector('#sub-tab-add')?.addEventListener('click', () => addSubTab());

                    // ä¿ç•™åŸæœ¬çš„æ™‚é–“èˆ‡è¡Œç¨‹è¨­å®šï¼ˆå¥—ç”¨åˆ°æ‰€æœ‰å°åˆ†é ï¼‰
                    const close = () => { try { document.body.removeChild(modal); } catch(_){} };
                    modal.querySelector('#pt-cancel')?.addEventListener('click', close);
                    modal.querySelector('#pt-save')?.addEventListener('click', async () => {
                        const itName = modal.querySelector('#it-name')?.value.trim() || '';
                        const startHM = modal.querySelector('#pt-start')?.value || '';
                        const endHM = modal.querySelector('#pt-end')?.value || '';
                        const weekly = modal.querySelector('#pt-weekly')?.checked || false;
                        const dows = Array.from(modal.querySelectorAll('.pt-dow')).filter(x => x.checked).map(x => parseInt(x.value,10));

                        // é©—è­‰æ¯å€‹å°åˆ†é 
                        for (const tab of subTabs) {
                            const pid = tab.stId?.value.trim() || '';
                            const name = (tab.stName?.value.trim() || itName);
                            const code = tab.stCode?.value.trim() || '';
                            const tasks = Array.from(tab.stTasksWrap.querySelectorAll('.st-task-input')).map(i => i.value.trim()).filter(v => v.length > 0);
                            if (!pid || !name || !(typeof code === 'string' && code.length === 12)) { showToast('è«‹å®Œæ•´å¡«å¯«æ¯å€‹å°åˆ†é ï¼ˆcodeé ˆç‚º12ç¢¼è‹±æ•¸ï¼‰', true); return; }
                            try {
                                await setDoc(doc(db, 'communities', comm.id, 'patrolPoints', pid), {
                                    communityId: comm.id,
                                    pointId: pid,
                                    name: name,
                                    itemName: itName,
                                    code: code,
                                    expectedStartHour: parseInt((startHM||'00:00').split(':')[0],10)||0,
                                    expectedEndHour: parseInt((endHM||'00:00').split(':')[0],10)||0,
                                    expectedStartHM: startHM,
                                    expectedEndHM: endHM,
                                    weekly: weekly,
                                    daysOfWeek: weekly ? [] : dows,
                                    defaultAssigneeRole: '',
                                    defaultAssigneeId: '',
                                    tasks: tasks,
                                    createdAt: Timestamp.fromDate(new Date()),
                                    updatedAt: Timestamp.fromDate(new Date())
                                });
                            } catch (e) { console.error('æ–°å¢å·¡é‚é …ç›®-å­é»å¤±æ•—', e); showToast('æ–°å¢å¤±æ•—ï¼šè«‹æª¢æŸ¥æ¬Šé™æˆ–IDé‡è¤‡', true); return; }
                        }
                        showToast('å·²æ–°å¢å·¡é‚é …ç›®');
                        close();
                        await loadPoints();
                        await ensureTasksForMonth();
                        await loadTasksAndLogs();
                        renderRows();
                    });
                };

                const openEditPointModal = (p) => {
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black/30 flex items-center justify-center z-50';
                    const pointId = p.pointId || p.id || '';
                    const startHMInit = p.expectedStartHM || (typeof p.expectedStartHour === 'number' ? String(p.expectedStartHour).padStart(2,'0')+':00' : '');
                    const endHMInit = p.expectedEndHM || (typeof p.expectedEndHour === 'number' ? String(p.expectedEndHour).padStart(2,'0')+':00' : '');
                    const weeklyInit = !!p.weekly;
                    const daysInit = Array.isArray(p.daysOfWeek) ? p.daysOfWeek : [];
                    modal.innerHTML = `
                        <div class="bg-white rounded-lg shadow p-4 w-[360px]">
                            <div class="text-lg font-semibold mb-2">ç·¨è¼¯å·¡é‚é»</div>
                            <div class="space-y-2">
                                <div>
                                    <label class="text-sm">å·¡é‚é»ç·¨è™Ÿ</label>
                                    <input id="ep-id" class="w-full border rounded px-2 py-1 bg-gray-50" value="${pointId}" disabled />
                                </div>
                                <div>
                                    <label class="text-sm">å·¡é‚é»åç¨±</label>
                                    <input id="ep-name" class="w-full border rounded px-2 py-1" value="${p.name || ''}" />
                                </div>
                                <div>
                                    <label class="text-sm">å·¡é‚é» code (12ä½æ•¸)</label>
                                    <div class="flex items-center gap-2">
                                        <input id="ep-code" class="flex-1 border rounded px-2 py-1" value="${p.code || ''}" />
                                        <button id="ep-code-regenerate" class="px-2 py-1 rounded border text-xs">é‡æ–°ç”¢ç”Ÿ</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="text-sm">ä»»å‹™é …ç›®</label>
                                    <div id="ep-tasks" class="space-y-1"></div>
                                    <button id="ep-task-add" class="mt-1 px-2 py-1 rounded border text-xs">æ–°å¢é …ç›®</button>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="text-sm">é è¨ˆé–‹å§‹æ™‚é–“(æ™‚)</label>
                                        <input id="ep-start" type="time" step="3600" class="w-full border rounded px-2 py-1" value="${startHMInit || '08:00'}" />
                                    </div>
                                    <div>
                                        <label class="text-sm">é è¨ˆçµæŸæ™‚é–“(æ™‚)</label>
                                        <input id="ep-end" type="time" step="3600" class="w-full border rounded px-2 py-1" value="${endHMInit || '09:00'}" />
                                    </div>
                                </div>
                                <div>
                                    <label class="text-sm">åŸ·è¡Œè¡Œç¨‹</label>
                                    <div class="space-y-1 text-sm">
                                        <label class="inline-flex items-center gap-2"><input type="checkbox" id="ep-weekly" ${weeklyInit ? 'checked' : ''} /> æ¯é€± (7å¤©)</label>
                                        <div class="grid grid-cols-7 gap-1">
                                            ${[0,1,2,3,4,5,6].map(d => `<label class=\"inline-flex items-center gap-1\"><input type=\"checkbox\" class=\"ep-dow\" value=\"${d}\" ${daysInit.includes(d) ? 'checked' : ''} />${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d]}</label>`).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3 flex justify-between">
                                <button id="ep-delete" class="px-3 py-1 rounded border text-red-600">åˆªé™¤</button>
                                <div class="flex items-center gap-2">
                                    <button id="ep-cancel" class="px-3 py-1 rounded border">å–æ¶ˆ</button>
                                    <button id="ep-save" class="px-3 py-1 rounded bg-amber-600 text-white">å„²å­˜</button>
                                </div>
                            </div>
                        </div>`;
                    document.body.appendChild(modal);
                    const genCode12 = () => {
                        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz0123456789';
                        let s = '';
                        for (let i = 0; i < 12; i++) s += chars.charAt(Math.floor(Math.random() * chars.length));
                        return s;
                    };
                    modal.querySelector('#ep-code-regenerate')?.addEventListener('click', () => {
                        const ci = modal.querySelector('#ep-code'); if (ci) ci.value = genCode12();
                    });
                    const tasksWrap = modal.querySelector('#ep-tasks');
                    const addTaskField = (text = '') => {
                        const idx = (tasksWrap?.children?.length || 0) + 1;
                        const row = document.createElement('div');
                        row.className = 'flex items-center gap-2';
                        row.innerHTML = `<span class="text-xs text-gray-500 w-5 text-right">${idx}</span>
                            <input class="ep-task-input flex-1 border rounded px-2 py-1" placeholder="ä¾‹å¦‚ï¼šæª¢æŸ¥æ»…ç«å™¨å£“åŠ›" />
                            <button class="ep-task-remove px-2 py-1 rounded border text-xs">ç§»é™¤</button>`;
                        tasksWrap.appendChild(row);
                        row.querySelector('.ep-task-remove')?.addEventListener('click', () => {
                            tasksWrap.removeChild(row);
                            Array.from(tasksWrap.children).forEach((c, i) => { const s = c.querySelector('span'); if (s) s.textContent = String(i + 1); });
                        });
                        if (text) row.querySelector('.ep-task-input').value = text;
                    };
                    (Array.isArray(p.tasks) && p.tasks.length ? p.tasks : ['']).forEach(t => addTaskField(t));
                    const close = () => { try { document.body.removeChild(modal); } catch(_){} };
                    modal.querySelector('#ep-delete')?.addEventListener('click', async () => {
                        const ok = confirm('ç¢ºå®šåˆªé™¤æ­¤å·¡é‚é»åŠå…¶ç›¸é—œä»»å‹™ï¼Ÿ');
                        if (!ok) return;
                        close();
                        await deletePointAndRelatedTasks(p);
                    });
                    modal.querySelector('#ep-cancel')?.addEventListener('click', close);
                    modal.querySelector('#ep-save')?.addEventListener('click', async () => {
                        const name = modal.querySelector('#ep-name')?.value.trim() || '';
                        const code = modal.querySelector('#ep-code')?.value.trim() || '';
                        const startHM = modal.querySelector('#ep-start')?.value || '';
                        const endHM = modal.querySelector('#ep-end')?.value || '';
                        const weekly = modal.querySelector('#ep-weekly')?.checked || false;
                        const dows = Array.from(modal.querySelectorAll('.ep-dow')).filter(x => x.checked).map(x => parseInt(x.value,10));
                        const tasks = Array.from(modal.querySelectorAll('.ep-task-input')).map(i => i.value.trim()).filter(v => v.length > 0);
                        if (!name || !(typeof code === 'string' && code.length === 12)) { showToast('è«‹å®Œæ•´å¡«å¯«ï¼Œcodeé ˆç‚º12ç¢¼è‹±æ•¸', true); return; }
                        try {
                            const dref = doc(db, 'communities', comm.id, 'patrolPoints', pointId);
                            await updateDoc(dref, {
                                name: name,
                                code: code,
                                expectedStartHour: parseInt((startHM||'00:00').split(':')[0],10)||0,
                                expectedEndHour: parseInt((endHM||'00:00').split(':')[0],10)||0,
                                expectedStartHM: startHM,
                                expectedEndHM: endHM,
                                weekly: weekly,
                                daysOfWeek: weekly ? [] : dows,
                                tasks: tasks,
                                updatedAt: Timestamp.fromDate(new Date())
                            });
                            showToast('å·²æ›´æ–°å·¡é‚é»');
                            close();
                            await loadPoints();
                            renderPointTabs();
                            await ensureTasksForMonth();
                            await loadTasksAndLogs();
                            renderRows();
                        } catch (e) { console.error('æ›´æ–°å·¡é‚é»å¤±æ•—', e); showToast('æ›´æ–°å¤±æ•—ï¼šè«‹æª¢æŸ¥æ¬Šé™', true); }
                    });
                };

                newPointBtn.addEventListener('click', openNewPointModal);
                renderAll();
            }

function renderGroupPatrolRecords(container) {
    // æ­¤åŠŸèƒ½å·²åœç”¨ï¼ˆä¿ç•™å‡½å¼ä»‹é¢é¿å…å¤–éƒ¨å¼•ç”¨è§¸ç™¼éŒ¯èª¤ï¼‰
    container.innerHTML = `<div class="p-4 text-gray-500">æ­¤åŠŸèƒ½å·²åœç”¨</div>`;
    try { lucide.createIcons(); } catch (_) {}
    return;
                const db = window.__db;
                const fs = window.__fs || {};
                const { collection, getDocs, query, where, orderBy, Timestamp } = fs;
                const comm = state.currentCommunity;
                if (!comm || !comm.id) {
                    container.innerHTML = `<div class="p-6 text-center text-gray-500">è«‹å…ˆé¸æ“‡ç¤¾å€</div>`;
                    return;
                }

                const local = {
                    monthDate: new Date(new Date().getFullYear(), new Date().getMonth(), 1),
                    selectedItemId: 'all',
                    points: [],
                    pointsById: {},
                    pointsByCode: {},
                    items: [],
                    logs: [],
                    usersMap: {}
                };
                const toDate = (tsOrDate) => tsOrDate?.toDate?.() || (tsOrDate instanceof Date ? tsOrDate : (tsOrDate ? new Date(tsOrDate) : null));
                const monthStart = () => new Date(local.monthDate.getFullYear(), local.monthDate.getMonth(), 1, 0, 0, 0, 0);
                const monthEnd = () => new Date(local.monthDate.getFullYear(), local.monthDate.getMonth()+1, 0, 23, 59, 59, 999);
                const fmtMonthLabel = () => `${local.monthDate.getFullYear()}å¹´ ${local.monthDate.getMonth()+1}æœˆ`;
                const fmtYMD = (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                const fmtHM = (date) => { if (!date || isNaN(date.getTime())) return ''; return `${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`; };

                const renderShell = () => {
                    container.innerHTML = `
                        <div class="p-3 space-y-3">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2 text-xs">
                                    <button id="pr-prev-month" class="px-2 py-1 rounded border bg-white text-gray-700 hover:bg-gray-50">ä¸Šä¸€æœˆ</button>
                                    <span class="text-gray-600">æœˆä»½</span>
                                    <div id="pr-month-label" class="text-xs font-medium">${fmtMonthLabel()}</div>
                                    <button id="pr-next-month" class="px-2 py-1 rounded border bg-white text-gray-700 hover:bg-gray-50">ä¸‹ä¸€æœˆ</button>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button id="pr-print-current" class="px-2 py-1 rounded bg-slate-700 text-white hover:bg-slate-800 text-xs">åˆ—å°ç›®å‰</button>
                                    <button id="pr-print-all" class="px-2 py-1 rounded bg-slate-500 text-white hover:bg-slate-600 text-xs">åˆ—å°å…¨éƒ¨</button>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 px-1"><div id="pr-item-tabs" class="flex gap-2 overflow-x-auto"></div></div>
                            <div class="bg-white rounded-lg shadow overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200 text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-3 py-2 text-left whitespace-nowrap">æ—¥æœŸ</th>
                                            <th class="px-3 py-2 text-left whitespace-nowrap">å·¡é‚é …ç›®</th>
                                            <th class="px-3 py-2 text-left whitespace-nowrap">å·¡é‚é»ç·¨è™Ÿ</th>
                                            <th class="px-3 py-2 text-left whitespace-nowrap">å·¡é‚é»åç¨±</th>
                                            <th class="px-3 py-2 text-left whitespace-nowrap">é–‹å§‹</th>
                                            <th class="px-3 py-2 text-left whitespace-nowrap">çµæŸ</th>
                                            <th class="px-3 py-2 text-left whitespace-nowrap">åŸ·è¡Œäººå“¡</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pr-rows">
                                        <tr><td colspan="7" class="px-3 py-3 text-center text-gray-500">æ­£åœ¨è¼‰å…¥å·¡é‚ç´€éŒ„...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>`;
                };

                const loadPoints = async () => {
                    try {
                        const snap = await getDocs(collection(db, 'communities', comm.id, 'patrolPoints'));
                        local.points = []; local.pointsById = {}; local.pointsByCode = {}; const names = new Set();
                        snap.forEach(d => {
                            const p = { id: d.id, ...d.data() };
                            local.points.push(p);
                            const pid = p.pointId || p.id; const code = p.code || '';
                            if (pid) local.pointsById[pid] = p;
                            if (code) local.pointsByCode[code] = p;
                            const iname = (p.itemName || '').trim(); if (iname) names.add(iname);
                            const arr = Array.isArray(p.tasks) ? p.tasks : [];
                            arr.forEach(t => { const nm = typeof t === 'string' ? t.trim() : ((t.name||t.title||t.itemName||'').trim()); if (nm) names.add(nm); });
                        });
                        local.items = Array.from(names);
                    } catch (e) {
                        console.warn('è¼‰å…¥å·¡é‚é»å¤±æ•—', e);
                        local.points = Array.isArray(local.points) ? local.points : [];
                        local.items = Array.isArray(local.items) ? local.items : [];
                    }
                };

                const loadUsersMap = async () => {
                    try {
                        const usnap = await getDocs(collection(db, 'users'));
                        local.usersMap = {};
                        usnap.forEach(d => { const data = d.data(); local.usersMap[d.id] = data.name || data.displayName || d.id; });
                    } catch(e) { local.usersMap = {}; }
                };

                const loadLogs = async () => {
                    const startTS = Timestamp.fromDate(monthStart());
                    const endTS = Timestamp.fromDate(monthEnd());
                    const lsnap = await getDocs(query(collection(db, 'communities', comm.id, 'patrolLogs'), where('timestamp','>=', startTS), where('timestamp','<=', endTS)));
                    local.logs = []; lsnap.forEach(ld => local.logs.push({ id: ld.id, ...ld.data() }));
                };

                const renderItemTabs = () => {
                    const tabsEl = document.getElementById('pr-item-tabs'); if (!tabsEl) return;
                    const tabs = [{ id: 'all', label: 'å…¨éƒ¨' }].concat(local.items.map(n => ({ id: n, label: n })));
                    tabsEl.innerHTML = tabs.map(t => `<button class="px-2 py-1 rounded border text-xs ${local.selectedItemId === t.id ? 'bg-amber-600 text-white border-amber-600' : 'bg-white text-gray-700 hover:bg-gray-50'}" data-id="${t.id}">${t.label}</button>`).join('');
                    tabsEl.querySelectorAll('button').forEach(btn => {
                        btn.addEventListener('click', () => { local.selectedItemId = btn.getAttribute('data-id') || 'all'; renderItemTabs(); renderRows(); });
                    });
                };

                const getItemNameForPoint = (p) => {
                    if (!p) return 'æœªåˆ†é¡';
                    const iname = (p.itemName || '').trim(); if (iname) return iname;
                    const arr = Array.isArray(p.tasks) ? p.tasks : [];
                    for (const t of arr) { const nm = typeof t === 'string' ? t.trim() : ((t.name||t.title||t.itemName||'').trim()); if (nm) return nm; }
                    return 'æœªåˆ†é¡';
                };

                const computeGroupedRows = (filterItemId = null) => {
                    const map = {};
                    for (const log of local.logs) {
                        const p = (log.pointId && local.pointsById[log.pointId]) || (log.pointCode && local.pointsByCode[log.pointCode]) || null;
                        const itemName = getItemNameForPoint(p);
                        if (filterItemId && filterItemId !== 'all' && itemName !== filterItemId) continue;
                        const ts = toDate(log.timestamp) || new Date(0);
                        const dateIso = fmtYMD(ts);
                        const pointId = p?.pointId || p?.id || (log.pointId || '') || '';
                        const pointName = p?.name || p?.pointName || '';
                        const key = `${itemName}__${dateIso}__${pointId}`;
                        if (!map[key]) map[key] = { itemName, dateIso, pointId, pointName, startTS: null, endTS: null, startUserId: null, endUserId: null, startCount: 0, endCount: 0 };
                        if (log.action === 'start') {
                            const cur = map[key]; cur.startCount++; const t = toDate(log.timestamp);
                            if (!cur.startTS || (t && t < cur.startTS)) cur.startTS = t; if (log.userId) cur.startUserId = log.userId;
                        } else if (log.action === 'end') {
                            const cur = map[key]; cur.endCount++; const t = toDate(log.timestamp);
                            if (!cur.endTS || (t && t > cur.endTS)) cur.endTS = t; if (log.userId) cur.endUserId = log.userId;
                        }
                    }
                    const rows = Object.values(map);
                    rows.sort((a,b) => a.dateIso.localeCompare(b.dateIso) || (a.itemName||'').localeCompare(b.itemName||'', 'zh-Hant') || (a.pointId||'').localeCompare(b.pointId||'', 'zh-Hant'));
                    return rows;
                };

                const renderRows = () => {
                    const rowsEl = document.getElementById('pr-rows'); if (!rowsEl) return;
                    const rows = computeGroupedRows(local.selectedItemId);
                    if (!rows.length) {
                        rowsEl.innerHTML = `<tr><td colspan="7" class="px-3 py-3 text-center text-gray-500">æœ¬æœˆå°šç„¡å·¡é‚ç´€éŒ„</td></tr>`;
                        return;
                    }
                    rowsEl.innerHTML = rows.map(r => {
                        const startStr = r.startTS ? fmtHM(r.startTS) + (r.startCount>1 ? ` (+${r.startCount-1})` : '') : '';
                        const endStr = r.endTS ? fmtHM(r.endTS) + (r.endCount>1 ? ` (+${r.endCount-1})` : '') : '';
                        const userText = (() => {
                            const s = r.startUserId ? (local.usersMap[r.startUserId] || r.startUserId) : '';
                            const e = r.endUserId ? (local.usersMap[r.endUserId] || r.endUserId) : '';
                            if (s && e && s !== e) return `${s} / ${e}`;
                            return s || e || '';
                        })();
                        return `
                            <tr>
                                <td class="px-3 py-2 whitespace-nowrap">${r.dateIso}</td>
                                <td class="px-3 py-2 whitespace-nowrap">${r.itemName}</td>
                                <td class="px-3 py-2 whitespace-nowrap">${r.pointId || ''}</td>
                                <td class="px-3 py-2 whitespace-nowrap">${r.pointName || ''}</td>
                                <td class="px-3 py-2 whitespace-nowrap">${startStr}</td>
                                <td class="px-3 py-2 whitespace-nowrap">${endStr}</td>
                                <td class="px-3 py-2 whitespace-nowrap">${userText}</td>
                            </tr>`;
                    }).join('');
                };

                const generatePrintHtml = (filterItemId = 'all') => {
                    const rows = computeGroupedRows(filterItemId);
                    const sectionTitle = filterItemId === 'all' ? 'å…¨éƒ¨å·¡é‚é …ç›®' : `å·¡é‚é …ç›®ï¼š${filterItemId}`;
                    const header = `<h2 style="margin:0 0 8px 0;font-size:16px;">${fmtMonthLabel()} ${sectionTitle}</h2>`;
                    const table = `
                        <table style="width:100%;border-collapse:collapse;font-size:12px;">
                            <thead>
                                <tr>
                                    <th style="border:1px solid #ddd;padding:6px;text-align:left;">æ—¥æœŸ</th>
                                    <th style="border:1px solid #ddd;padding:6px;text-align:left;">å·¡é‚é …ç›®</th>
                                    <th style="border:1px solid #ddd;padding:6px;text-align:left;">å·¡é‚é»ç·¨è™Ÿ</th>
                                    <th style="border:1px solid #ddd;padding:6px;text-align:left;">å·¡é‚é»åç¨±</th>
                                    <th style="border:1px solid #ddd;padding:6px;text-align:left;">é–‹å§‹</th>
                                    <th style="border:1px solid #ddd;padding:6px;text-align:left;">çµæŸ</th>
                                    <th style="border:1px solid #ddd;padding:6px;text-align:left;">åŸ·è¡Œäººå“¡</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows.map(r => {
                                    const startStr = r.startTS ? fmtHM(r.startTS) + (r.startCount>1 ? ` (+${r.startCount-1})` : '') : '';
                                    const endStr = r.endTS ? fmtHM(r.endTS) + (r.endCount>1 ? ` (+${r.endCount-1})` : '') : '';
                                    const userText = (() => {
                                        const s = r.startUserId ? (local.usersMap[r.startUserId] || r.startUserId) : '';
                                        const e = r.endUserId ? (local.usersMap[r.endUserId] || r.endUserId) : '';
                                        if (s && e && s !== e) return `${s} / ${e}`;
                                        return s || e || '';
                                    })();
                                    return `<tr>
                                        <td style="border:1px solid #ddd;padding:6px;">${r.dateIso}</td>
                                        <td style="border:1px solid #ddd;padding:6px;">${r.itemName}</td>
                                        <td style="border:1px solid #ddd;padding:6px;">${r.pointId || ''}</td>
                                        <td style="border:1px solid #ddd;padding:6px;">${r.pointName || ''}</td>
                                        <td style="border:1px solid #ddd;padding:6px;">${startStr}</td>
                                        <td style="border:1px solid #ddd;padding:6px;">${endStr}</td>
                                        <td style="border:1px solid #ddd;padding:6px;">${userText}</td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>`;
                    return `<section style="margin-bottom:16px;">${header}${table}</section>`;
                };

                const openPrintWindow = (filterItemId = 'all') => {
                    const html = generatePrintHtml(filterItemId);
                    const allHtml = (filterItemId === 'all')
                        ? (['all'].concat(local.items)).map(id => generatePrintHtml(id === 'all' ? 'all' : id)).join('')
                        : html;
                    const win = window.open('', '_blank');
                    if (!win) { try { showToast('ç€è¦½å™¨é˜»æ“‹äº†é–‹çª—ï¼Œè«‹å…è¨±å½ˆå‡ºè¦–çª—', true); } catch(_) {} return; }
                    win.document.write(`<!DOCTYPE html><html><head><meta charset="utf-8" /><title>${fmtMonthLabel()} å·¡é‚ç´€éŒ„åˆ—å°</title><style>
                        body{font-family:Arial,'Noto Sans TC',sans-serif;color:#111;padding:16px;}
                        @media print { .no-print{display:none;} }
                    </style></head><body>${allHtml}</body></html>`);
                    win.document.close(); win.focus();
                    try { win.print(); } catch(_) {}
                };

                const bindEvents = () => {
                    const monthLabelEl = document.getElementById('pr-month-label');
                    const prevBtn = document.getElementById('pr-prev-month');
                    const nextBtn = document.getElementById('pr-next-month');
                    const printCurrentBtn = document.getElementById('pr-print-current');
                    const printAllBtn = document.getElementById('pr-print-all');
                    prevBtn?.addEventListener('click', async () => { local.monthDate = new Date(local.monthDate.getFullYear(), local.monthDate.getMonth()-1, 1); if (monthLabelEl) monthLabelEl.textContent = fmtMonthLabel(); await loadLogs(); renderRows(); });
                    nextBtn?.addEventListener('click', async () => { local.monthDate = new Date(local.monthDate.getFullYear(), local.monthDate.getMonth()+1, 1); if (monthLabelEl) monthLabelEl.textContent = fmtMonthLabel(); await loadLogs(); renderRows(); });
                    printCurrentBtn?.addEventListener('click', () => openPrintWindow(local.selectedItemId));
                    printAllBtn?.addEventListener('click', () => openPrintWindow('all'));
                };

                const init = async () => {
                    renderShell();
                    await loadPoints();
                    await loadUsersMap();
                    await loadLogs();
                    renderItemTabs();
                    renderRows();
                    bindEvents();
                };
                init();
            }

            function renderGroupMap(container) {
                container.innerHTML = `
                    <div class="h-full w-full relative">
                        <div id="group-map" class="h-full w-full"></div>
                        <div id="group-map-loader" class="absolute inset-0 bg-white/70 flex items-center justify-center"><div class="loader"></div></div>
<button id="group-map-center-btn" class="absolute top-3 right-3 z-10 bg-white text-gray-700 border border-gray-300 rounded-full shadow px-3 py-2 flex items-center hover:bg-gray-50">
                            <i data-lucide="focus" class="w-4 h-4 mr-2"></i>å›åˆ°ç¤¾å€
                        </button>
                        <div class="absolute bottom-0 left-0 right-0 p-2">
                            <div id="group-user-list" class="bg-white/90 backdrop-blur-sm rounded-lg shadow-lg max-h-[150px] overflow-y-auto p-2 space-y-2"></div>
                        </div>
                    </div>
                `;
                try { lucide.createIcons(); } catch(e) {}
                if (state.googleMapsLoaded) {
                    initGroupMap();
                } else {
                    const interval = setInterval(() => {
                        if (state.googleMapsLoaded) { clearInterval(interval); initGroupMap(); }
                    }, 100);
                }
            }

            async function initGroupMap() {
                const mapDiv = document.getElementById('group-map');
                const mapLoader = document.getElementById('group-map-loader');
                if (!mapDiv || !mapLoader) return;
                let mapCenter = { lat: 25.0330, lng: 121.5654 };
                try {
                    // å„ªå…ˆä½¿ç”¨ç›®å‰ç¤¾å€çš„ GPS åº§æ¨™
                    const comm = state.currentCommunity;
                    if (comm && typeof comm.lat === 'number' && typeof comm.lng === 'number') {
                        mapCenter = { lat: comm.lat, lng: comm.lng };
                    } else {
                        const docSnap = await getDoc(doc(db, "settings", "location"));
                        if (docSnap.exists()) {
                            const s = docSnap.data();
                            if (typeof s.companyLat === 'number' && typeof s.companyLng === 'number') {
                                mapCenter = { lat: s.companyLat, lng: s.companyLng };
                            }
                        }
                    }
                } catch (e) { console.warn("è¼‰å…¥ä¸­å¿ƒé»å¤±æ•—ï¼Œä½¿ç”¨é è¨­ä¸­å¿ƒé»", e); }
                state.groupMap = new google.maps.Map(mapDiv, { center: mapCenter, zoom: 12, disableDefaultUI: true, zoomControl: true, mapId: 'DEMO_MAP_ID' });
                state.companyCenter = mapCenter;
                const centerBtn = document.getElementById('group-map-center-btn');
                if (centerBtn) {
                    centerBtn.addEventListener('click', () => {
                        if (state.companyCenter) {
                            state.groupMap.panTo(state.companyCenter);
                            state.groupMap.setZoom(14);
                        } else {
                            showToast('å°šæœªè¨­å®šç¤¾å€åº§æ¨™', true);
                        }
                    });
                }
                mapLoader.classList.add('hide');
                listenForGroupUserLocations();
            }

            async function listenForGroupUserLocations() {
                const allowedUserIds = await loadJuniorManagerAllowedUsers(state.currentUserData.id);
                const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
                const usersRef = collection(db, "users");
                const q = query(usersRef, orderBy("name"));
                try {
                    const querySnapshot = await getDocs(q);
                    const listEl = document.getElementById('group-user-list');
                    if (!listEl) return;
                    listEl.innerHTML = '';
                    if (!Array.isArray(allowedUserIds) || allowedUserIds.length === 0) {
                        listEl.innerHTML = `<p class="text-center text-gray-500 p-2">å°šæœªç”±ç®¡ç†å“¡è¨­å®šå¯æŸ¥çœ‹äººå“¡</p>`;
                        return;
                    }
                    // æ¸…é™¤èˆŠæ¨™è¨˜
                    (state.groupMarkers || []).forEach(m => m.map = null);
                    state.groupMarkers = [];

                    const users = [];
                    querySnapshot.forEach(doc => { const data = { id: doc.id, ...doc.data() }; if (allowedUserIds.includes(data.id)) users.push(data); });
                    const currentCommId = state.currentCommunity?.id || null;
                    const currentCommCode = state.currentCommunity?.code || state.currentCommunity?.communityCode || null;
                    const usersByCommunity = (currentCommId || currentCommCode) ? users.filter(u => {
                        const byId = Array.isArray(u.serviceCommunities) && currentCommId ? u.serviceCommunities.includes(currentCommId) : false;
                        const codesArr = Array.isArray(u.serviceCommunityCodes) ? u.serviceCommunityCodes : [];
                        const byCode = currentCommCode ? (codesArr.includes(currentCommCode) || (u.serviceCommunityCode === currentCommCode)) : false;
                        const byLegacy = currentCommId ? ((u.serviceCommunityCode === currentCommId) || (codesArr.includes(currentCommId))) : false;
                        return byId || byCode || byLegacy;
                    }) : users;
                    let visibleUsers = {};
                    try {
                        const savedSettings = localStorage.getItem('app_general_settings');
                        if (savedSettings) {
                            const settings = JSON.parse(savedSettings);
                            visibleUsers = settings.visibleUsers || {};
                        }
                    } catch (e) {}
                    // åƒ…é¡¯ç¤ºç¤¾å€å…§æŒ‡å®šè§’è‰²ï¼ˆç¸½å¹¹äº‹ã€ç§˜æ›¸ã€ä¿å…¨ã€æ¸…æ½”ã€æ©Ÿé›»ï¼‰
                    const allowedRoles = new Set(['ç¸½å¹¹äº‹','ç§˜æ›¸','ä¿å…¨','æ¸…æ½”','æ©Ÿé›»']);
                    const communityRoleUsers = usersByCommunity.filter(u => allowedRoles.has((u.role || '').trim()));
                    const visibleUsersList = communityRoleUsers.filter(user => visibleUsers[user.id] !== false);
                    const latestMap = {};
                    try {
                        await Promise.all(visibleUsersList.map(async (u) => {
                            const recQ = query(
                                collection(db, 'clockInRecords'),
                                where('userId', '==', u.id),
                                orderBy('timestamp', 'desc'),
                                limit(1)
                            );
                            const snap = await getDocs(recQ);
                            if (!snap.empty) {
                                latestMap[u.id] = snap.docs[0].data();
                            }
                        }));
                    } catch (e) {}
                    visibleUsersList.sort((a, b) => {
                        const recA = latestMap[a.id];
                        const recB = latestMap[b.id];
                        const statusA = recA ? getStatusDisplayText(recA.type || 'æœªçŸ¥', recA.locationName || null, recA.dutyType || null) : getStatusDisplayText(a.clockInStatus || 'æœªæ‰“å¡', a.lastLocation?.address, a.dutyType);
                        const statusB = recB ? getStatusDisplayText(recB.type || 'æœªçŸ¥', recB.locationName || null, recB.dutyType || null) : getStatusDisplayText(b.clockInStatus || 'æœªæ‰“å¡', b.lastLocation?.address, b.dutyType);
                        if (statusA.includes('ä¸Šç­ä¸­') && !statusB.includes('ä¸Šç­ä¸­')) return -1;
                        if (!statusA.includes('ä¸Šç­ä¸­') && statusB.includes('ä¸Šç­ä¸­')) return 1;
                        if (statusA.includes('ä¸Šç­ä¸­') && statusB.includes('ä¸Šç­ä¸­')) {
                            const timeA = (recA?.timestamp?.toDate?.() || (a.lastClockInTime?.toDate?.() || new Date(0)));
                            const timeB = (recB?.timestamp?.toDate?.() || (b.lastClockInTime?.toDate?.() || new Date(0)));
                            return timeA - timeB;
                        }
                        return a.name.localeCompare(b.name, 'zh-Hant');
                    });
                    visibleUsersList.forEach(user => {
                        const hasLocation = user.lastLocation && user.lastLocation.latitude;
                        const userElement = document.createElement('div');
                        userElement.className = `flex items-center justify-between p-2 rounded-md cursor-pointer hover:bg-gray-100 ${!hasLocation ? 'opacity-50' : ''}`;
                        const latest = latestMap[user.id] || null;
                        const locText = latest?.locationName || (user.clockInStatus === 'å¤–å‡º' && user.outboundLocation ? user.outboundLocation : user.lastLocation?.address);
                        const statusText = latest ? getStatusDisplayText(latest.type || 'æœªçŸ¥', latest.locationName || null, latest.dutyType || null)
                                                  : (getStatusDisplayText(user.clockInStatus || 'æœªæ‰“å¡', locText, user.dutyType) || 'æœªæ‰“å¡');
                        const latestTime = latest ? (latest.timestamp?.toDate?.() || (latest.timestamp ? new Date(latest.timestamp) : null))
                                                  : (user.lastClockInTime?.toDate?.() || null);
                        userElement.innerHTML = `
                            <div class="flex items-center">
                                <img src="${user.avatarUrl || `https://placehold.co/32x32/EFEFEF/333333?text=${user.name.charAt(0)}`}" class="w-8 h-8 rounded-full mr-3 object-cover">
                                <div>
                                    <p class="font-medium text-sm text-gray-800">${user.name}</p>
                                    <p class="text-xs text-gray-500">${statusText}</p>
                                </div>
                            </div>
                            <span class="text-xs text-gray-400">${latestTime ? 'æœ€è¿‘ç‹€æ…‹æ™‚é–“ï¼š' + timeAgo(latestTime) : 'ç„¡ç´€éŒ„'}</span>
                        `;
                        listEl.appendChild(userElement);
                        if (hasLocation) {
                            const position = { lat: user.lastLocation.latitude, lng: user.lastLocation.longitude };
                            const markerIcon = document.createElement('img');
                            markerIcon.src = user.avatarUrl || `https://placehold.co/40x40/EFEFEF/333333?text=${user.name.charAt(0)}`;
                            const roleColorMap = { 'ç¸½å¹¹äº‹': 'border-amber-500', 'ç§˜æ›¸': 'border-purple-500', 'ä¿å…¨': 'border-green-800', 'æ¸…æ½”': 'border-pink-400', 'æ©Ÿé›»': 'border-blue-500' };
const titleKey = ((user.applicationTitle || user.jobTitle || user.role || '').trim());
const roleBorderClass = roleColorMap[titleKey] || 'border-white';
                            markerIcon.className = `w-9 h-9 rounded-full border-2 ${roleBorderClass} shadow-md object-cover`;
                            const marker = new AdvancedMarkerElement({ position, map: state.groupMap, title: user.name, content: markerIcon });
                            const infoWindow = new google.maps.InfoWindow({ content: `
                                <div class="p-1">
                                    <p class="font-bold">${user.name}</p>
                                    <p>ç‹€æ…‹: ${statusText}</p>
                                    <p>æœ€è¿‘ç‹€æ…‹æ™‚é–“: ${latestTime ? formatDateTime(latestTime) : 'N/A'}</p>
                                </div>` });
                            marker.addListener('click', () => infoWindow.open({ anchor: marker, map: state.groupMap }));
                            userElement.addEventListener('click', () => { state.groupMap.panTo(position); state.groupMap.setZoom(17); infoWindow.open({ anchor: marker, map: state.groupMap }); });
                            state.groupMarkers.push(marker);
                        }
                    });
                } catch (error) {
                    console.error('è®€å–ç¾¤çµ„äººå“¡æ¸…å–®å¤±æ•—', error);
                    showToast('è®€å–ç¾¤çµ„äººå“¡å¤±æ•—', true);
                }
            }

            function renderGroupAttendance(container) {
                container.innerHTML = `
                    <div class="p-4 space-y-4">
                        <div class="flex flex-wrap items-center gap-4 mb-4">
                            <div class="flex items-center space-x-2">
                                <label for="group-user-select" class="text-sm font-medium">é¸æ“‡äººå“¡:</label>
                                <select id="group-user-select" class="border border-gray-300 rounded-md px-2 py-1">
                                    <option value="all">ç”±ç®¡ç†å“¡æŒ‡å®šåå–®</option>
                                </select>
                            </div>
                            <div class="flex items-center space-x-2">
                                <label for="group-record-date" class="text-sm font-medium">é¸æ“‡æ—¥æœŸ:</label>
                                <input type="date" id="group-record-date" value="${new Date().toISOString().split('T')[0]}" class="border border-gray-300 rounded-md px-2 py-1">
                            </div>
                        </div>
                        <div id="group-attendance-records-list" class="space-y-3">
                            <div class="text-center p-4 text-gray-500">æ­£åœ¨è®€å–ç´€éŒ„...</div>
                        </div>
                    </div>`;

                const userSelect = document.getElementById('group-user-select');
                const dateInput = document.getElementById('group-record-date');

                loadJuniorManagerAllowedUsers(state.currentUserData.id).then(ids => {
                    if (!ids || ids.length === 0) return;
                    const usersRef = collection(db, "users");
                    getDocs(usersRef).then((qs) => {
                        const users = [];
                        qs.forEach(doc => { const d = { id: doc.id, ...doc.data() }; if (ids.includes(d.id)) users.push(d); });
                        users.sort((a,b) => a.name.localeCompare(b.name, 'zh-Hant')).forEach(u => {
                            const opt = document.createElement('option'); opt.value = u.id; opt.textContent = u.name; userSelect.appendChild(opt);
                        });
                        const loadRecords = () => renderAttendanceRecordsList('group-attendance-records-list', userSelect.value, dateInput.value, ids);
                        userSelect.addEventListener('change', loadRecords);
                        dateInput.addEventListener('change', loadRecords);
                        loadRecords();
                    });
                });
            }

            // å…±ç”¨ï¼šå‡ºå‹¤ç´€éŒ„åˆ—è¡¨æ¸²æŸ“ï¼ˆæ”¯æ´æŒ‡å®šç”¨æˆ¶ç™½åå–®ï¼‰
            async function renderAttendanceRecordsList(containerId, selectedUserId, selectedDateStr, allowedUserIds = null) {
                const container = document.getElementById(containerId);
                const selectedDate = new Date(selectedDateStr);
                const startOfDay = new Date(selectedDate);
                startOfDay.setHours(0, 0, 0, 0);
                const endOfDay = new Date(selectedDate);
                endOfDay.setHours(23, 59, 59, 999);
                const recordsRef = collection(db, 'clockInRecords');
                let q;
                const { Timestamp } = window.__fs || {};
                const startTS = Timestamp?.fromDate ? Timestamp.fromDate(startOfDay) : startOfDay;
                const endTS = Timestamp?.fromDate ? Timestamp.fromDate(endOfDay) : endOfDay;
                if (selectedUserId === 'all') {
                    q = query(recordsRef, where('timestamp', '>=', startTS), where('timestamp', '<=', endTS));
                } else {
                    q = query(recordsRef, where('userId', '==', selectedUserId), where('timestamp', '>=', startTS), where('timestamp', '<=', endTS));
                }

                container.innerHTML = `<div class="text-center p-4 text-gray-500">æ­£åœ¨è®€å–ç´€éŒ„...</div>`;
                await ensureAbnormalMarkingConfig();
                await ensureCommunitiesCache();
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    container.innerHTML = `<p class="text-center text-gray-500 p-4">ç„¡æ‰“å¡ç´€éŒ„</p>`;
                    return;
                }
                const records = [];
                querySnapshot.forEach(doc => records.push({ id: doc.id, ...doc.data() }));
                const usersRef = collection(db, 'users');
                const usersSnapshot = await getDocs(usersRef);
                const usersMap = {};
                const userCommunitiesMap = {};
                usersSnapshot.forEach(doc => { 
                    const d = doc.data();
                    usersMap[doc.id] = d.name;
                    userCommunitiesMap[doc.id] = Array.isArray(d.serviceCommunities) ? d.serviceCommunities : [];
                });

                container.innerHTML = '';
                records
                    .filter(r => !allowedUserIds || allowedUserIds.includes(r.userId))
                    .sort((a,b) => {
                        const timeA = a.timestamp?.toDate?.() || new Date(0);
                        const timeB = b.timestamp?.toDate?.() || new Date(0);
                        return timeB - timeA;
                    })
                    .forEach(record => {
                        const time = record.timestamp?.toDate?.() || new Date();
                        const userName = usersMap[record.userId] || 'æœªçŸ¥ç”¨æˆ¶';
                        const abnormalInfo = computeRecordAbnormal(record, userCommunitiesMap[record.userId] || []);
                        const abnormalHtml = (abnormalInfo && abnormalInfo.isAbnormal)
                            ? `<div class="mt-1"><span class="px-2 py-0.5 rounded text-xs bg-red-100 text-red-700 border border-red-200">æ‰“å¡ä½ç½®ç•°å¸¸</span>${abnormalInfo.detail ? `<span class=\"ml-2 text-xs text-gray-500\">${abnormalInfo.detail}</span>` : ''}</div>`
                            : '';
                        const card = document.createElement('div');
                        card.className = 'bg-white p-4 rounded-lg shadow border border-gray-200';
                        card.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="font-semibold">${userName}</div>
                                    <div class="text-sm text-gray-500">${time.toLocaleString('zh-TW', { hour12: false })}</div>
                                    <div class="mt-1 flex items-center">
<span class="px-2 py-0.5 rounded text-sm ${getStatusBgColor(getStatusDisplayText(record.type || 'æœªçŸ¥', record.locationName || null, record.dutyType || null))}">${getStatusDisplayText(record.type || 'æœªçŸ¥', record.locationName || null, record.dutyType || null)}</span>
                        ${record.location && typeof record.location.latitude === 'number' && typeof record.location.longitude === 'number' ? `<span class="ml-2 text-sm text-gray-500">${record.location.latitude.toFixed(6)}, ${record.location.longitude.toFixed(6)}</span>` : ''}
                                    </div>
                                    <div class="mt-1 text-xs text-gray-500">è£ç½®ID: ${record.deviceId || 'æœªçŸ¥'}</div>
                                    ${abnormalHtml}
                                </div>
                                <div class="flex space-x-2 items-start"></div>
                            </div>
                            <div class="mt-2 flex space-x-2 overflow-x-auto items-center">
                                ${record.photoUrls && record.photoUrls.length > 0 ? `
                                    <button class="photo-btn bg-blue-500 text-white px-2 py-1 rounded text-sm" 
                                        data-photos='${encodeURIComponent(JSON.stringify(record.photoUrls || []))}' 
                                        data-descriptions='${encodeURIComponent(JSON.stringify(record.descriptions || []))}'>
                                        <i data-lucide="image"></i> ç…§ç‰‡ (${record.photoUrls.length})
                                    </button>
                                ` : ''}
                                ${record.location ? `
                                    <button class="map-btn bg-green-500 text-white px-2 py-1 rounded text-sm" 
                                        data-lat="${record.location.latitude}" 
                                        data-lng="${record.location.longitude}">
                                        <i data-lucide="map-pin"></i> åœ°åœ–
                                    </button>
                                ` : ''}
                                <!-- Admin controls: edit/delete -->
                                <span class="admin-controls hidden" data-record-id="${record.id}" data-record='${encodeURIComponent(JSON.stringify({
                                    id: record.id,
                                    type: record.type,
                                    timeISO: (record.timestamp?.toDate?.() || new Date()).toISOString(),
                                    lat: record.location?.latitude ?? null,
                                    lng: record.location?.longitude ?? null,
                                    locationName: record.locationName || '',
                                    dutyType: record.dutyType || ''
                                }))}'>
                                    <button class="edit-record-btn bg-yellow-500 text-white px-2 py-1 rounded text-sm">
                                        <i data-lucide="pencil"></i> ç·¨è¼¯
                                    </button>
                                    <button class="delete-record-btn bg-red-600 text-white px-2 py-1 rounded text-sm">
                                        <i data-lucide="trash-2"></i> åˆªé™¤
                                    </button>
                                </span>
                            </div>
                        `;
                        container.appendChild(card);
                    });
                lucide.createIcons();
                container.querySelectorAll('.map-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const lat = parseFloat(e.currentTarget.dataset.lat);
                        const lng = parseFloat(e.currentTarget.dataset.lng);
                        if (Number.isFinite(lat) && Number.isFinite(lng)) openMapModal(lat, lng);
                        else showToast('ç„¡ä½ç½®è³‡è¨Šå¯é¡¯ç¤º', true);
                    });
                });
                container.querySelectorAll('.photo-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const photos = JSON.parse(decodeURIComponent(e.currentTarget.dataset.photos || '%5B%5D'));
                        const descriptions = JSON.parse(decodeURIComponent(e.currentTarget.dataset.descriptions || '%5B%5D'));
                        openPhotoModal(photos, descriptions);
                    });
                });

                // é¡¯ç¤ºä¸¦ç¶å®šç®¡ç†å“¡æ§åˆ¶æŒ‰éˆ•
                (window.checkAdminStatus ? window.checkAdminStatus() : Promise.resolve(false)).then(isAdmin => {
                    if (!isAdmin) return;
                    container.querySelectorAll('.admin-controls').forEach(ctrl => ctrl.classList.remove('hidden'));
                    container.querySelectorAll('.edit-record-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            try {
                                const parent = e.currentTarget.closest('.admin-controls');
                                const recordData = JSON.parse(decodeURIComponent(parent.dataset.record || '%7B%7D'));
                                openEditRecordModal(recordData);
                            } catch (err) {
                                console.error('openEditRecordModal parse error', err);
                                showToast('è¼‰å…¥ç´€éŒ„å¤±æ•—', true);
                            }
                        });
                    });
                    container.querySelectorAll('.delete-record-btn').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            try {
                                const parent = e.currentTarget.closest('.admin-controls');
                                const recordId = parent.dataset.recordId;
                                if (!recordId) return;
                                const ok = confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å‡ºå‹¤ç´€éŒ„ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚');
                                if (!ok) return;
                                const { doc, deleteDoc } = window.__fs;
                                const db = window.__db;
                                await deleteDoc(doc(db, 'clockInRecords', recordId));
                                showToast('åˆªé™¤æˆåŠŸ');
                                // é‡æ–°è¼‰å…¥åˆ—è¡¨
                                const selectedUserId = document.getElementById('user-select')?.value || 'all';
                                const selectedDateStr = document.getElementById('record-date')?.value || new Date().toISOString().split('T')[0];
                                await renderAttendanceRecordsList('attendance-records-list', selectedUserId, selectedDateStr);
                            } catch (err) {
                                console.error('delete clockInRecord error', err);
                                showToast('åˆªé™¤å¤±æ•—ï¼šè«‹æª¢æŸ¥æ¬Šé™', true);
                            }
                        });
                    });
                });
            }

            // è®€å–åˆéšä¸»ç®¡å¯è¦‹ç”¨æˆ¶è¨­å®š
            async function loadJuniorManagerAllowedUsers(managerUserId) {
                try {
                    const docRef = doc(db, 'settings', 'group');
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        return data?.managerGroups?.[managerUserId] || [];
                    }
                } catch (e) { console.error('loadJuniorManagerAllowedUsers error', e); }
                return [];
            }
            
            function renderTrackingMap(container) {
                container.innerHTML = `
                    <div class="sticky top-0 z-20 w-full min-h-[336px] md:min-h-[416px]">
                        <div id="tracking-map" class="w-full h-full min-h-[336px] md:min-h-[416px]"></div>
                        <div id="tracking-map-loader" class="absolute inset-0 bg-white/70 flex items-center justify-center"><div class="loader"></div></div>
                        <button id="tracking-map-center-btn" class="absolute top-3 right-3 z-10 bg-white text-gray-700 border border-gray-300 rounded-full shadow px-3 py-2 flex items-center hover:bg-gray-50">
                            <i data-lucide="focus" class="w-4 h-4 mr-2"></i>å›åˆ°ç¤¾å€
                        </button>
                    </div>
                    <div class="mt-0">
                        <div id="user-tracking-list" class="bg-white rounded-lg shadow-lg max-h-[260px] overflow-y-auto p-2 space-y-2">
                            <!-- äººå“¡åˆ—è¡¨æœƒåœ¨æ­¤è™•è¼‰å…¥ -->
                        </div>
                    </div>
                `;
                try { lucide.createIcons(); } catch(e) {}
                if (state.googleMapsLoaded) {
                    initTrackingMap();
                } else {
                    const interval = setInterval(() => {
                        if (state.googleMapsLoaded) {
                            clearInterval(interval);
                            initTrackingMap();
                        }
                    }, 100);
                }
            }

            async function initTrackingMap() {
                const mapDiv = document.getElementById('tracking-map');
                const mapLoader = document.getElementById('tracking-map-loader');
                if (!mapDiv || !mapLoader) return;

                const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");

                // ä»¥ç›®å‰é¸æ“‡çš„ç¤¾å€ GPS ç‚ºä¸­å¿ƒï¼›è‹¥ç„¡å‰‡é€€å›è¨­å®šæˆ–é è¨­
                let mapCenter = null;
                let circleRadius = null;
                const c = state.currentCommunity || {};
                const cLat = typeof c.lat === 'number' ? c.lat : null;
                const cLng = typeof c.lng === 'number' ? c.lng : null;
                if (cLat != null && cLng != null) {
                    mapCenter = { lat: cLat, lng: cLng };
                    if (typeof c.radius === 'number' && c.radius > 0) circleRadius = c.radius;
                } else {
                    try {
                        const docSnap = await getDoc(doc(db, "settings", "location"));
                        if (docSnap.exists()) {
                            const s = docSnap.data();
                            // å„ªå…ˆç¤¾å€ä¸­å¿ƒï¼Œå…¶æ¬¡èˆŠå…¬å¸ä¸­å¿ƒ
                            if (typeof s.communityLat === 'number' && typeof s.communityLng === 'number') {
                                mapCenter = { lat: s.communityLat, lng: s.communityLng };
                            } else if (typeof s.companyLat === 'number' && typeof s.companyLng === 'number') {
                                mapCenter = { lat: s.companyLat, lng: s.companyLng };
                            }
                            if (typeof s.companyRadius === 'number' && s.companyRadius > 0) circleRadius = s.companyRadius;
                        }
                    } catch (e) { console.warn("è¼‰å…¥ä¸­å¿ƒé»å¤±æ•—ï¼Œä½¿ç”¨é è¨­ä¸­å¿ƒé»", e); }
                }
                if (!mapCenter) mapCenter = { lat: 25.0330, lng: 121.5654 };
                
                state.trackingMap = new google.maps.Map(mapDiv, {
                    center: mapCenter,
                    zoom: 16,
                    disableDefaultUI: true,
                    zoomControl: true,
                    mapId: 'DEMO_MAP_ID' // Required for Advanced Markers
                });
                // å°‡ä¸­å¿ƒé»å­˜å…¥ç‹€æ…‹ï¼Œä¾›ã€Œå›åˆ°ç¤¾å€ã€ä½¿ç”¨
                state.companyCenter = mapCenter;
                const centerBtn = document.getElementById('tracking-map-center-btn');
                if (centerBtn) {
                    centerBtn.addEventListener('click', () => {
                        if (state.companyCenter) {
                            state.trackingMap.panTo(state.companyCenter);
                            state.trackingMap.setZoom(16);
                        } else {
                            showToast('å°šæœªè¨­å®šç¤¾å€åº§æ¨™', true);
                        }
                    });
                }

                // æ¸…ç†èˆŠçš„ä¸­å¿ƒæ¨™è¨˜èˆ‡åŠå¾‘åœˆ
                try {
                    if (state.trackingCenterMarker?.setMap) { state.trackingCenterMarker.setMap(null); }
                    else if (state.trackingCenterMarker) { state.trackingCenterMarker.map = null; }
                } catch (_) {}
                try { if (state.trackingRadiusCircle) state.trackingRadiusCircle.setMap(null); } catch (_) {}

                // åœ¨ç¤¾å€ä¸­å¿ƒé»æ”¾ç½® Google Maps ç¶“å…¸ç´…æ¨™ï¼ˆç¸®å°ç‚ºåŸæœ¬çš„40%ï¼‰
                const redIconUrl = 'https://maps.gstatic.com/mapfiles/api-3/images/spotlight-poi2_hdpi.png';
                state.trackingCenterMarker = new google.maps.Marker({
                    position: mapCenter,
                    map: state.trackingMap,
                    title: 'ç¤¾å€ä¸­å¿ƒ',
                    icon: redIconUrl
                });
                try {
                    const img = new Image();
                    img.onload = () => {
                        const scale = 0.6;
                        const w = img.naturalWidth || 40;
                        const h = img.naturalHeight || 40;
                        const scaledSize = new google.maps.Size(Math.round(w * scale), Math.round(h * scale));
                        const anchor = new google.maps.Point(Math.round((w / 2) * scale), Math.round(h * scale));
                        state.trackingCenterMarker.setIcon({ url: redIconUrl, scaledSize, anchor });
                    };
                    img.src = redIconUrl;
                } catch (_) {}


                // æ¨™ç¤ºç¤¾å€æ‰“å¡åŠå¾‘
                if (typeof circleRadius === 'number' && circleRadius > 0) {
                    state.trackingRadiusCircle = new google.maps.Circle({
                        map: state.trackingMap,
                        center: mapCenter,
                        radius: circleRadius,
                        strokeColor: '#FF0000',
                        strokeOpacity: 0.8,
                        strokeWeight: 2,
                        fillColor: '#FF0000',
                        fillOpacity: 0.1
                    });
                }

                mapLoader.classList.add('hide');
                listenForUserLocations();
            }
            
            function renderTrackingAttendance(container, params = {}) {
                container.innerHTML = `
                    <div class="p-4 space-y-4">
                        <div class="flex flex-wrap items-center gap-4 mb-4 mt-4">
                            <div class="flex items-center space-x-2">
                                <label for="user-select" class="text-sm font-medium">é¸æ“‡äººå“¡:</label>
                                <select id="user-select" class="border border-gray-300 rounded-md px-2 py-1">
                                    <option value="all">å…¨éƒ¨äººå“¡</option>
                                    <!-- äººå“¡é¸é …å°‡å‹•æ…‹æ·»åŠ  -->
                                </select>
                            </div>
                            <div class="flex items-center space-x-2">
                                <label for="record-date" class="text-sm font-medium">é¸æ“‡æ—¥æœŸ:</label>
                                <input type="date" id="record-date" value="${new Date().toISOString().split('T')[0]}" class="border border-gray-300 rounded-md px-2 py-1">
                            </div>
                            <button id="leave-apply-btn-track" class="bg-orange-500 text-white px-3 py-2 rounded-md hover:bg-orange-600 flex items-center">
                                <i data-lucide="calendar-days" class="w-4 h-4 mr-1"></i><span>è«‹å‡ç”³è«‹</span>
                            </button>
                        </div>
                        <div id="attendance-records-list" class="space-y-3">
                            <div class="text-center p-4 text-gray-500">æ­£åœ¨è®€å–ç´€éŒ„...</div>
                        </div>
                    </div>
                `;
                try { lucide.createIcons(); } catch(e) {}
                // è«‹å‡ç”³è«‹æŒ‰éˆ•
                const leaveApplyBtn = document.getElementById('leave-apply-btn-track');
                if (leaveApplyBtn) {
                    leaveApplyBtn.addEventListener('click', () => {
                        try { openTempLeaveModal(); } catch (err) { showToast('ç„¡æ³•é–‹å•Ÿè«‹å‡ç”³è«‹', true); }
                    });
                }
                
                // è¼‰å…¥æ‰€æœ‰ç”¨æˆ¶
                const { collection, getDocs } = window.__fs || {};
                const db = window.__db;
                const usersRef = db && collection ? collection(db, "users") : null;
                const userSelect = document.getElementById('user-select');
                if (!usersRef || !getDocs) {
                    document.getElementById('attendance-records-list').innerHTML = '<div class="p-4 text-red-600">è³‡æ–™åº«å°šæœªå°±ç·’</div>';
                    return;
                }
                
                getDocs(usersRef).then((querySnapshot) => {
                    const users = [];
                    querySnapshot.forEach(doc => {
                        users.push({ id: doc.id, ...doc.data() });
                    });
                    
                    users.sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant')).forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.name;
                        userSelect.appendChild(option);
                    });
                    // è‹¥å¸¶å…¥ selectedUserId åƒæ•¸ï¼Œé é¸è©²ä½¿ç”¨è€…
                    if (params && params.selectedUserId) {
                        userSelect.value = params.selectedUserId;
                    }
                    
                    // åˆå§‹è¼‰å…¥è¨˜éŒ„
                    loadAttendanceRecords();
                });
                
                const dateInput = document.getElementById('record-date');
                userSelect.addEventListener('change', loadAttendanceRecords);
                dateInput.addEventListener('change', loadAttendanceRecords);
                
                async function loadAttendanceRecords() {
                    const selectedDate = new Date(dateInput.value);
                    const startOfDay = new Date(selectedDate);
                    startOfDay.setHours(0, 0, 0, 0);
                    const endOfDay = new Date(selectedDate);
                    endOfDay.setHours(23, 59, 59, 999);
                    const selectedUserId = userSelect.value;
                    
                    const recordsRef = collection(db, "clockInRecords");
                    let q;
                    const { Timestamp } = window.__fs || {};
                    const startTS = Timestamp?.fromDate ? Timestamp.fromDate(startOfDay) : startOfDay;
                    const endTS = Timestamp?.fromDate ? Timestamp.fromDate(endOfDay) : endOfDay;
                    
                    if (selectedUserId === 'all') {
                        q = query(recordsRef, 
                            where("timestamp", ">=", startTS),
                            where("timestamp", "<=", endTS)
                        );
                    } else {
                        q = query(recordsRef, 
                            where("userId", "==", selectedUserId),
                            where("timestamp", ">=", startTS),
                            where("timestamp", "<=", endTS)
                        );
                    }
                    
                    const recordsList = document.getElementById('attendance-records-list');
                    recordsList.innerHTML = `<div class="text-center p-4 text-gray-500">æ­£åœ¨è®€å–ç´€éŒ„...</div>`;
                    await ensureAbnormalMarkingConfig();
                    await ensureCommunitiesCache();
                    getDocs(q).then((querySnapshot) => {
                        if (querySnapshot.empty) {
                            recordsList.innerHTML = `<p class="text-center text-gray-500 p-4">ç„¡æ‰“å¡ç´€éŒ„</p>`;
                            return;
                        }
                        
                        const records = [];
                        querySnapshot.forEach(doc => {
                            records.push({ id: doc.id, ...doc.data() });
                        });
                        
                        // ç²å–æ‰€æœ‰ç”¨æˆ¶è³‡æ–™ï¼Œç”¨æ–¼é¡¯ç¤ºåç¨±
                        getDocs(usersRef).then((usersSnapshot) => {
                            const usersMap = {};
                            usersSnapshot.forEach(doc => {
                                usersMap[doc.id] = doc.data().name;
                            });
                            
                            recordsList.innerHTML = '';
                            records.sort((a, b) => {
                                const timeA = a.timestamp?.toDate?.() || new Date(0);
                                const timeB = b.timestamp?.toDate?.() || new Date(0);
                                return timeB - timeA;
                            }).forEach(record => {
                                const time = record.timestamp?.toDate?.() || new Date();
                                const userName = usersMap[record.userId] || 'æœªçŸ¥ç”¨æˆ¶';
                                const abnormalInfo = computeRecordAbnormal(record, (users.find(u => u.id === record.userId)?.serviceCommunities) || []);
                                const abnormalHtml = (abnormalInfo && abnormalInfo.isAbnormal)
                                    ? `<div class="mt-1"><span class="px-2 py-0.5 rounded text-xs bg-red-100 text-red-700 border border-red-200">æ‰“å¡ä½ç½®ç•°å¸¸</span>${abnormalInfo.detail ? `<span class=\"ml-2 text-xs text-gray-500\">${abnormalInfo.detail}</span>` : ''}</div>`
                                    : '';
                                
                                const card = document.createElement('div');
                                card.className = 'bg-white p-4 rounded-lg shadow border border-gray-200';
                                card.innerHTML = `
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <div class="font-semibold">${userName}</div>
                                            <div class="text-sm text-gray-500">${time.toLocaleString('zh-TW', { hour12: false })}</div>
                                            <div class="mt-1 flex items-center">
                                                <span class="px-2 py-0.5 rounded text-sm ${getStatusBgColor(getStatusDisplayText(record.type || 'æœªçŸ¥', record.locationName || null, record.dutyType || null))}">${getStatusDisplayText(record.type || 'æœªçŸ¥', record.locationName || null, record.dutyType || null)}</span>
                        ${record.location && typeof record.location.latitude === 'number' && typeof record.location.longitude === 'number' ? `<span class="ml-2 text-sm text-gray-500">${record.location.latitude.toFixed(6)}, ${record.location.longitude.toFixed(6)}</span>` : ''}
                                            </div>
                                            <div class="mt-1 text-xs text-gray-500">è£ç½®ID: ${record.deviceId || 'æœªçŸ¥'}</div>
                                            ${abnormalHtml}
                                        </div>
                                        <div class="flex space-x-2 items-start"></div>
                                    </div>
                                    <div class="mt-2 flex space-x-2 overflow-x-auto items-center">
                                        ${record.photoUrls && record.photoUrls.length > 0 ? `
                                            <button class="photo-btn bg-blue-500 text-white px-2 py-1 rounded text-sm" 
                                                data-photos='${encodeURIComponent(JSON.stringify(record.photoUrls || []))}' 
                                                data-descriptions='${encodeURIComponent(JSON.stringify(record.descriptions || []))}'>
                                                <i data-lucide="image"></i> ç…§ç‰‡ (${record.photoUrls.length})
                                            </button>
                                        ` : ''}
                                        ${record.location ? `
                                            <button class="map-btn bg-green-500 text-white px-2 py-1 rounded text-sm" 
                                                data-lat="${record.location.latitude}" 
                                                data-lng="${record.location.longitude}">
                                                <i data-lucide="map-pin"></i> åœ°åœ–
                                            </button>
                                        ` : ''}
                                        <!-- Admin controls: edit/delete -->
                                        <span class="admin-controls hidden" data-record-id="${record.id}" data-record='${encodeURIComponent(JSON.stringify({
                                            id: record.id,
                                            type: record.type,
                                            timeISO: (record.timestamp?.toDate?.() || new Date()).toISOString(),
                                            lat: record.location?.latitude ?? null,
                                            lng: record.location?.longitude ?? null,
                                            locationName: record.locationName || '',
                                            dutyType: record.dutyType || ''
                                        }))}'>
                                            <button class="edit-record-btn bg-yellow-500 text-white px-2 py-1 rounded text-sm">
                                                <i data-lucide="pencil"></i> ç·¨è¼¯
                                            </button>
                                            <button class="delete-record-btn bg-red-600 text-white px-2 py-1 rounded text-sm">
                                                <i data-lucide="trash-2"></i> åˆªé™¤
                                            </button>
                                        </span>
                                    </div>
                                `;
                                recordsList.appendChild(card);
                            });
                            
                            lucide.createIcons();
                            
                            // æ·»åŠ åœ°åœ–å’Œç…§ç‰‡æŒ‰éˆ•çš„äº‹ä»¶ç›£è½å™¨
                            document.querySelectorAll('.map-btn').forEach(btn => {
                                btn.addEventListener('click', (e) => {
                                    const lat = parseFloat(e.currentTarget.dataset.lat);
                                    const lng = parseFloat(e.currentTarget.dataset.lng);
                                    if (Number.isFinite(lat) && Number.isFinite(lng)) openMapModal(lat, lng);
                                    else showToast("ç„¡ä½ç½®è³‡è¨Šå¯é¡¯ç¤º", true);
                                });
                            });
                            
                            document.querySelectorAll('.photo-btn').forEach(btn => {
                                btn.addEventListener('click', (e) => {
                                    const photos = JSON.parse(decodeURIComponent(e.currentTarget.dataset.photos || '%5B%5D'));
                                    const descriptions = JSON.parse(decodeURIComponent(e.currentTarget.dataset.descriptions || '%5B%5D'));
                                    openPhotoModal(photos, descriptions);
                                });
                            });

                            // é¡¯ç¤ºä¸¦ç¶å®šç®¡ç†å“¡æ§åˆ¶æŒ‰éˆ•
                            (window.checkAdminStatus ? window.checkAdminStatus() : Promise.resolve(false)).then(isAdmin => {
                                if (!isAdmin) return;
                                recordsList.querySelectorAll('.admin-controls').forEach(ctrl => ctrl.classList.remove('hidden'));
                                recordsList.querySelectorAll('.edit-record-btn').forEach(btn => {
                                    btn.addEventListener('click', (e) => {
                                        try {
                                            const parent = e.currentTarget.closest('.admin-controls');
                                            const recordData = JSON.parse(decodeURIComponent(parent.dataset.record || '%7B%7D'));
                                            openEditRecordModal(recordData);
                                        } catch (err) {
                                            console.error('openEditRecordModal parse error', err);
                                            showToast('è¼‰å…¥ç´€éŒ„å¤±æ•—', true);
                                        }
                                    });
                                });
                                recordsList.querySelectorAll('.delete-record-btn').forEach(btn => {
                                    btn.addEventListener('click', async (e) => {
                                        try {
                                            const parent = e.currentTarget.closest('.admin-controls');
                                            const recordId = parent.dataset.recordId;
                                            if (!recordId) return;
                                            const ok = confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å‡ºå‹¤ç´€éŒ„ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚');
                                            if (!ok) return;
                                            const { doc, deleteDoc } = window.__fs;
                                            const db = window.__db;
                                            await deleteDoc(doc(db, 'clockInRecords', recordId));
                                            showToast('åˆªé™¤æˆåŠŸ');
                                            loadAttendanceRecords();
                                        } catch (err) {
                                            console.error('delete clockInRecord error', err);
                                            showToast('åˆªé™¤å¤±æ•—ï¼šè«‹æª¢æŸ¥æ¬Šé™', true);
                                        }
                                    });
                                });
                            });
                        });
                    }).catch(error => {
                        console.error("Error fetching records:", error);
                        recordsList.innerHTML = `<div class="text-center text-red-500 p-4">è®€å–ç´€éŒ„å¤±æ•—ã€‚</div>`;
                    });
                }
                
                function getStatusBgColor(typeOrText) {
                    const s = String(typeOrText || '').toLowerCase();
                    if (s.includes('ä¸Šç­') || s.includes('è¿”å›') || s.includes('åœ¨è¾¦')) return 'bg-green-100 text-green-800';
                    if (s.includes('ä¸‹ç­')) return 'bg-red-100 text-red-800';
                    if (s.includes('å¤–å‡º') || s.includes('æŠµé”') || s.includes('é›¢é–‹')) return 'bg-blue-100 text-blue-800';
                    if (s.includes('è«‹å‡')) return 'bg-orange-100 text-orange-800';
                    if (s.includes('ç‰¹æ®Šå‹¤å‹™')) return 'bg-indigo-100 text-indigo-800';
                    return 'bg-gray-100 text-gray-800';
                }
            }
            
            function renderTrackingAttendanceSchedule(container, params = {}) {
  const todayIso = new Date().toISOString().split('T')[0];
  container.innerHTML = `
    <div class="p-4 space-y-4">
      <div class="flex flex-wrap items-center gap-4 mb-2">
        <div class="flex items-center space-x-2">
          <label for="schedule-date" class="text-sm font-medium">æ—¥æœŸ:</label>
          <input type="date" id="schedule-date" value="${todayIso}" class="border border-gray-300 rounded-md px-2 py-1" />
        </div>
        <div class="flex items-center space-x-2">
          <label for="schedule-user" class="text-sm font-medium">äººå“¡:</label>
          <select id="schedule-user" class="border border-gray-300 rounded-md px-2 py-1">
            <option value="all">å…¨éƒ¨äººå“¡</option>
          </select>
        </div>
        <!-- å“¨é»ç¯©é¸å·²ç§»é™¤ï¼šåˆ—è¡¨æ”¹ç‚ºé¡¯ç¤ºå…¨ç¤¾å€æ’ç­ -->
      </div>
      <div class="bg-white rounded-lg shadow overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-3 py-2 text-left whitespace-nowrap">è§’è‰²</th>
              <th class="px-3 py-2 text-left whitespace-nowrap">æŒ‡æ´¾äººå“¡</th>
              <th class="px-3 py-2 text-left whitespace-nowrap">æ’å®šä¸Šç­æ™‚é–“</th>
              <th class="px-3 py-2 text-left whitespace-nowrap">å¯¦éš›æ‰“å¡æ™‚é–“</th>
              <th class="px-3 py-2 text-left whitespace-nowrap">æ’å®šä¸‹ç­æ™‚é–“</th>
              <th class="px-3 py-2 text-left whitespace-nowrap">å¯¦éš›æ‰“å¡ä¸‹ç­æ™‚é–“</th>
              <th class="px-3 py-2 text-left whitespace-nowrap">ç‹€æ…‹</th>
              <th class="px-3 py-2 text-left whitespace-nowrap">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="schedule-rows">
            <tr><td colspan="8" class="px-3 py-3 text-center text-gray-500">æ­£åœ¨è¼‰å…¥ç•¶æ—¥æ’ç­...</td></tr>
          </tbody>
        </table>
      </div>
    </div>`;
  try { lucide.createIcons(); } catch (_) {}

  const dateInput = document.getElementById('schedule-date');
  const userSelect = document.getElementById('schedule-user');
  const rowsEl = document.getElementById('schedule-rows');
  // å“¨é»é¸æ“‡å·²ç§»é™¤

  // æœ¬åœ°ä½¿ç”¨è€…æ¸…å–®ï¼Œé¿å…ä¾è³´ pageState
  let scheduleUsers = [];
  const getUserById = (uid) => {
    const fromLocal = scheduleUsers.find(x => x.id === uid);
    const fromPageState = (window.pageState?.communityUsers || []).find(x => x.id === uid);
    return fromLocal || fromPageState || null;
  };
  const getUserNameById = (uid) => {
    const u = getUserById(uid);
    return u ? (u.name || u.displayName || u.id) : (uid || 'æœªæŒ‡æ´¾');
  };
  const getUserTitleById = (uid) => {
    const u = getUserById(uid);
    return u ? ((u.jobTitle || u.applicationTitle || u.role || '') + '') : '';
  };

  const roleOrder = { 'ç¸½å¹¹äº‹': 0, 'ç§˜æ›¸': 1, 'ä¿å…¨': 2, 'æ¸…æ½”': 3, 'æ©Ÿé›»': 4 };
  const toDate = (tsOrDate) => tsOrDate?.toDate?.() || (tsOrDate instanceof Date ? tsOrDate : new Date(tsOrDate));
  const fmtHM = (date) => {
    if (!date || isNaN(date.getTime())) return '';
    return `${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
  };
  const getStatusBgColor = (typeOrText) => {
    const s = String(typeOrText || '').toLowerCase();
    if (s.includes('ä¸Šç­') || s.includes('è¿”å›') || s.includes('åœ¨è¾¦')) return 'bg-green-100 text-green-800';
    if (s.includes('ä¸‹ç­')) return 'bg-red-100 text-red-800';
    if (s.includes('å¤–å‡º') || s.includes('æŠµé”') || s.includes('é›¢é–‹')) return 'bg-blue-100 text-blue-800';
    if (s.includes('è«‹å‡')) return 'bg-orange-100 text-orange-800';
    if (s.includes('ç‰¹æ®Šå‹¤å‹™') || s.includes('ç¾é‡‘ç­')) return 'bg-indigo-100 text-indigo-800';
    return 'bg-gray-100 text-gray-800';
  };

  const ensureUsersOptions = async () => {
    const { collection, getDocs } = window.__fs || {};
    const db = window.__db;
    // ä¾ç›®å‰é¸å®šç¤¾å€åˆ¤æ–·æˆå“¡æ­¸å±¬
    const selectedCommunityId = state.currentCommunity?.id || window.pageState?.selectedCommunityId || null;
    const selectedCommunityCode = state.currentCommunity?.code || state.currentCommunity?.communityCode || null;
    const userInCurrentCommunity = (u) => {
      const ids = Array.isArray(u.serviceCommunities) ? u.serviceCommunities : [];
      const codesArr = Array.isArray(u.serviceCommunityCodes) ? u.serviceCommunityCodes : [];
      const codeOne = (u.serviceCommunityCode || '').trim();
      const byIdMatch = selectedCommunityId ? ids.includes(selectedCommunityId) : false;
      const byCodeMatch = selectedCommunityCode ? (codesArr.includes(selectedCommunityCode) || codeOne === selectedCommunityCode) : false;
      return byIdMatch || byCodeMatch;
    };
    // å„ªå…ˆä½¿ç”¨ pageState å·²è¼‰å…¥çš„ç¤¾å€ä½¿ç”¨è€…
    if (Array.isArray(window.pageState?.communityUsers) && window.pageState.communityUsers.length) {
      // é é¢å·²è¼‰å…¥çš„ç¤¾å€äººå“¡åå–®ï¼ˆå·²æ˜¯ç¤¾å€å¸³è™Ÿæ¸…å–®ï¼‰
      scheduleUsers = window.pageState.communityUsers.slice();
    } else if (db && collection && getDocs) {
      // å¾Œæ´ï¼šå¾ users ç›´æ¥è¼‰å…¥
      try {
        const snap = await getDocs(collection(db, 'users'));
        scheduleUsers = [];
        snap.forEach(d => {
          const data = d.data();
          scheduleUsers.push({ id: d.id, name: data.name || data.displayName || d.id, ...data });
        });
      } catch (e) {
        console.warn('è¼‰å…¥ä½¿ç”¨è€…å¤±æ•—', e);
      }
    }

    // è‹¥æ˜¯å¾Œæ´è¼‰å…¥ï¼Œéœ€éæ¿¾ç‚ºã€Œåƒ…æ­¤ç¤¾å€å¸³è™Ÿæ¸…å–®ã€
    if (!Array.isArray(window.pageState?.communityUsers) || !window.pageState.communityUsers.length) {
      scheduleUsers = scheduleUsers.filter(userInCurrentCommunity);
    }

    // åƒ…ä¿ç•™ã€Œç¸½å¹¹äº‹ã€ç§˜æ›¸ã€ä¿å…¨ã€æ¸…æ½”ã€æ©Ÿé›»ã€
    const allowedRoles = new Set(['ç¸½å¹¹äº‹','ç§˜æ›¸','ä¿å…¨','æ¸…æ½”','æ©Ÿé›»']);
    const filteredUsers = scheduleUsers.filter(u => allowedRoles.has((u.jobTitle || u.applicationTitle || u.role || '').trim()));
    filteredUsers.sort((a,b)=> (a.name||'').localeCompare(b.name||'', 'zh-Hant')).forEach(u => {
      const opt = document.createElement('option');
      opt.value = u.id; opt.textContent = u.name || u.displayName || u.id;
      userSelect.appendChild(opt);
    });
    if (params && params.selectedUserId) userSelect.value = params.selectedUserId;
  };

  // å–å¾—å“¨é»åç¨±ï¼ˆå„ªå…ˆä½¿ç”¨ pageState çš„ postsï¼Œå¾Œæ´æŸ¥è©¢ posts é›†åˆï¼‰
  let postNamesById = {};
  const ensurePostNames = async () => {
    try {
      if (Object.keys(postNamesById).length) return;
      const cid = state.currentCommunity?.id || window.pageState?.selectedCommunityId || null;
      // å…ˆç”¨å·²è¼‰å…¥çš„ posts
      if (Array.isArray(window.pageState?.posts) && window.pageState.posts.length) {
        window.pageState.posts.forEach(p => { postNamesById[p.id] = p.name || 'æœªå‘½åå“¨é»'; });
        return;
      }
      const { collection, getDocs } = window.__fs || {};
      const db = window.__db;
      if (db && collection && getDocs && cid) {
        const snap = await getDocs(collection(db, 'communities', cid, 'posts'));
        snap.forEach(d => { const data = d.data() || {}; postNamesById[d.id] = data.name || 'æœªå‘½åå“¨é»'; });
      }
    } catch(_) {}
  };

  const computeStatusText = (now, start, end, startRec, endRec, cashShift) => {
    try {
      if (cashShift === true) return 'è½‰ç¾é‡‘ç­';
      if (now < start) return 'å°šæœªåˆ°ä¸Šç­æ™‚é–“';
      if (!startRec) return 'æœªæ‰“ä¸Šç­å¡';
      if (now < end) return 'æ­£å¸¸ä¸Šç­';
      if (endRec) return 'æ­£å¸¸ä¸‹ç­';
      return 'æœªæ‰“ä¸‹ç­å¡';
    } catch(_) { return 'æœªæ‰“å¡'; }
  };

  const renderList = async () => {
    const iso = dateInput.value || todayIso;
    const communityId = state.currentCommunity?.id || window.pageState?.selectedCommunityId || null;
    const { collection, getDocs, query, where, Timestamp } = window.__fs || {};
    const db = window.__db;
    if (!communityId || !collection || !getDocs) {
      rowsEl.innerHTML = `<tr><td colspan="8" class="px-3 py-3 text-center text-red-600">è³‡æ–™åº«æˆ–ç¤¾å€å°šæœªå°±ç·’</td></tr>`;
      return;
    }

    rowsEl.innerHTML = `<tr><td colspan="8" class="px-3 py-3 text-center text-gray-500">æ­£åœ¨è¼‰å…¥ç•¶æ—¥æ’ç­...</td></tr>`;

    // è®€å–ç•¶æ—¥æ‰€æœ‰å“¨é»çš„æ’ç­ï¼ˆpostSchedulesï¼‰
    const schedulesRef = collection(db, 'communities', communityId, 'postSchedules');
    const snap = await getDocs(query(schedulesRef, where('dateIso', '==', iso)));
    const shifts = [];
    snap.forEach(d => {
      const data = d.data();
      const postId = data.postId;
      const arr = Array.isArray(data.shifts) ? data.shifts : [];
      arr.forEach((s, idx) => {
        shifts.push({
          role: s.role || 'ä¿å…¨',
          assignees: Array.isArray(s.assignees) ? s.assignees : [],
          startStr: s.start || '07:00',
          endStr: s.end || '19:00',
          endDateIso: s.endDateIso || iso,
          cashShift: s.cashShift === true,
          docId: d.id,
          postId,
          dateIso: iso,
          shiftIndex: idx
        });
      });
    });

    // ç¯©é¸äººå“¡ï¼ˆè‹¥é¸æ“‡ç‰¹å®šäººå“¡ï¼Œåªé¡¯ç¤ºåŒ…å«è©²äººå“¡ä¹‹æ’ç­ï¼‰
    const selectedUserId = userSelect.value;
    // å“¨é»é¸å–®å·²ç§»é™¤ï¼Œæ”¹ç‚ºé¡¯ç¤ºæ‰€æœ‰æ’ç­ï¼ˆä¸å†ä¾å“¨é»ç¯©é¸ï¼‰

    // å…ˆä¾äººå“¡ç¯©é¸
    let filtered = selectedUserId === 'all' ? shifts.slice() : shifts.filter(s => s.assignees.includes(selectedUserId));

    // ä¸å†ä¾å“¨é»ç¯©é¸ï¼Œä¿ç•™ä¾äººå“¡çš„ç¯©é¸ï¼ˆé¡¯ç¤ºå…¨ç¤¾å€æ’ç­ï¼‰

    // è®€å–ç•¶æ—¥æ‰“å¡è¨˜éŒ„
    const startOfDay = new Date(`${iso}T00:00:00`);
    const endOfDay = new Date(`${iso}T23:59:59`);
    const startTS = Timestamp?.fromDate ? Timestamp.fromDate(startOfDay) : startOfDay;
    const endTS = Timestamp?.fromDate ? Timestamp.fromDate(endOfDay) : endOfDay;
    const clockRef = collection(db, 'clockInRecords');
    const clockSnap = await getDocs(query(clockRef, where('timestamp', '>=', startTS), where('timestamp', '<=', endTS)));
    const recsByUser = {};
    clockSnap.forEach(dd => {
      const r = { id: dd.id, ...dd.data() };
      if (!recsByUser[r.userId]) recsByUser[r.userId] = [];
      recsByUser[r.userId].push(r);
    });

    // æŒ‰è§’è‰²æ’åº
    filtered.sort((a,b) => {
      const ao = roleOrder[a.role] ?? 999, bo = roleOrder[b.role] ?? 999;
      if (ao !== bo) return ao - bo;
      const an = (a.assignees[0] ? getUserNameById(a.assignees[0]) : ''), bn = (b.assignees[0] ? getUserNameById(b.assignees[0]) : '');
      return an.localeCompare(bn, 'zh-Hant');
    });

    const now = new Date();
    const rows = filtered.map(s => {
      const assId = s.assignees[0] || '';
      const assUser = getUserById(assId);
      const assName = assId ? getUserNameById(assId) : 'æœªæŒ‡æ´¾';
      const start = new Date(`${s.dateIso}T${s.startStr}:00`);
      const end = new Date(`${s.endDateIso}T${s.endStr}:00`);
      const userRecs = recsByUser[assId] || [];
      const startRec = userRecs.filter(r => (r.type === 'ä¸Šç­')).sort((a,b)=> toDate(a.timestamp) - toDate(b.timestamp))[0] || null;
      const endRec = userRecs.filter(r => (r.type === 'ä¸‹ç­')).sort((a,b)=> toDate(b.timestamp) - toDate(a.timestamp))[0] || null;
      const startTimeDisp = startRec ? fmtHM(toDate(startRec.timestamp)) : '';
      const endTimeDisp = endRec ? fmtHM(toDate(endRec.timestamp)) : '';
      const statusText = computeStatusText(now, start, end, startRec, endRec, s.cashShift);

      const recordInfo = (() => {
        const sUpBy = startRec?.updatedBy || null, eUpBy = endRec?.updatedBy || null;
        const sUpAt = startRec?.updatedAt ? toDate(startRec.updatedAt) : null;
        const eUpAt = endRec?.updatedAt ? toDate(endRec.updatedAt) : null;
        const maxAt = (!sUpAt && !eUpAt) ? null : (!sUpAt ? eUpAt : (!eUpAt ? sUpAt : (sUpAt > eUpAt ? sUpAt : eUpAt)));
        const maxBy = (maxAt === sUpAt) ? sUpBy : eUpBy;
        const byName = maxBy ? getUserNameById(maxBy) : '';
        return maxAt ? `${byName} @ ${maxAt.toLocaleString('zh-TW', { hour12: false })}` : '';
      })();

      return `
        <tr data-doc-id="${s.docId}" data-shift-index="${s.shiftIndex}" data-assignee-id="${assId}" data-start-record-id="${startRec?.id||''}" data-end-record-id="${endRec?.id||''}">
          <td class="px-3 py-2 whitespace-nowrap">${s.role}</td>
          <td class="px-3 py-2 whitespace-nowrap">${assName}</td>
          <td class="px-3 py-2 whitespace-nowrap">${s.dateIso} ${s.startStr}</td>
          <td class="px-3 py-2 whitespace-nowrap">
            <div class="flex items-center gap-2">
              <input type="time" class="start-time-input px-2 py-1 border rounded" value="${startTimeDisp}" placeholder="--:--" />
              <button class="save-start-time bg-yellow-500 text-white px-2 py-1 rounded text-xs"><i data-lucide="save"></i> å„²å­˜</button>
            </div>
          </td>
          <td class="px-3 py-2 whitespace-nowrap">${s.endDateIso} ${s.endStr}</td>
          <td class="px-3 py-2 whitespace-nowrap">
            <div class="flex items-center gap-2">
              <input type="time" class="end-time-input px-2 py-1 border rounded" value="${endTimeDisp}" placeholder="--:--" />
              <button class="save-end-time bg-yellow-500 text-white px-2 py-1 rounded text-xs"><i data-lucide="save"></i> å„²å­˜</button>
            </div>
          </td>
          <td class="px-3 py-2 whitespace-nowrap">
            <span class="px-2 py-0.5 rounded ${getStatusBgColor(statusText)}">${statusText}</span>
          </td>
          <td class="px-3 py-2 whitespace-nowrap">
            <div class="flex items-center gap-2">
              <button class="manual-clock-in bg-green-600 text-white px-2 py-1 rounded text-xs"><i data-lucide="log-in"></i> æ‰‹å‹•ä¸Šç­æ‰“å¡</button>
              <button class="manual-clock-out bg-red-600 text-white px-2 py-1 rounded text-xs"><i data-lucide="log-out"></i> æ‰‹å‹•ä¸‹ç­æ‰“å¡</button>
              <button class="row-leave-apply bg-orange-500 text-white px-2 py-1 rounded text-xs"><i data-lucide="calendar-days"></i> è«‹å‡ç”³è«‹</button>
              <button class="row-share bg-amber-500 text-white px-2 py-1 rounded text-xs"><i data-lucide="share-2"></i> åˆ†äº«</button>
              <span class="text-xs text-gray-500">${recordInfo}</span>
            </div>
          </td>
        </tr>`;
    });

    rowsEl.innerHTML = rows.length ? rows.join('') : `<tr><td colspan="8" class="px-3 py-3 text-center text-gray-500">ç•¶æ—¥å°šç„¡æ’ç­</td></tr>`;
    try { lucide.createIcons(); } catch (_) {}

    bindRowEvents();
  };

  const bindRowEvents = () => {
    const { addDoc, collection, Timestamp, serverTimestamp, updateDoc, doc, getDoc, setDoc } = window.__fs || {};
    const db = window.__db;

    const parseTimeInput = (iso, hm) => {
      if (!iso || !hm) return null;
      const dt = new Date(`${iso}T00:00:00`);
      const [hh, mm] = hm.split(':');
      dt.setHours(parseInt(hh,10)||0, parseInt(mm,10)||0, 0, 0);
      return dt;
    };

    const updateClockTime = async (assigneeId, type, iso, hm, existingRecordId = null) => {
      if (!assigneeId || !type || !iso || !hm) { showToast('æ™‚é–“ç„¡æ•ˆ', true); return; }
      const user = window.__auth?.currentUser;
      const dt = parseTimeInput(iso, hm);
      if (!dt) { showToast('æ™‚é–“ç„¡æ•ˆ', true); return; }
      try {
        if (existingRecordId) {
          await updateDoc(doc(db, 'clockInRecords', existingRecordId), {
            timestamp: Timestamp.fromDate(dt),
            updatedBy: user?.uid || '',
            updatedAt: Timestamp.fromDate(new Date())
          });
          showToast('å·²æ›´æ–°æ™‚é–“');
        } else {
          await addDoc(collection(db, 'clockInRecords'), {
            userId: assigneeId,
            type: type,
            timestamp: Timestamp.fromDate(dt),
            location: state.currentLocation ? { latitude: state.currentLocation.lat, longitude: state.currentLocation.lng } : null,
            photoUrls: [],
            descriptions: [],
            deviceId: state.deviceId || 'manual',
            locationName: state.currentCommunity?.name || '',
            dutyType: '',
            isAutomatic: false,
            createdAt: serverTimestamp()
          });
          showToast('å·²æ–°å¢æ‰“å¡');
        }
      } catch (e) {
        console.error('updateClockTime error', e);
        showToast('æ›´æ–°å¤±æ•—ï¼šè«‹æª¢æŸ¥æ¬Šé™æˆ–æ ¼å¼', true);
      }
    };

    const manualClock = async (row, type) => {
      const assigneeId = row.getAttribute('data-assignee-id') || '';
      try {
        await addDoc(collection(db, 'clockInRecords'), {
          userId: assigneeId,
          type: type,
          timestamp: Timestamp.fromDate(new Date()),
          location: state.currentLocation ? { latitude: state.currentLocation.lat, longitude: state.currentLocation.lng } : null,
          photoUrls: [],
          descriptions: [],
          deviceId: state.deviceId || 'manual',
          locationName: state.currentCommunity?.name || '',
          dutyType: '',
          isAutomatic: false,
          createdAt: serverTimestamp()
        });
        showToast(type === 'ä¸Šç­' ? 'å·²æ‰‹å‹•ä¸Šç­æ‰“å¡' : 'å·²æ‰‹å‹•ä¸‹ç­æ‰“å¡');
        await renderList();
      } catch (e) { console.error('manual clock error', e); showToast('æ‰‹å‹•æ‰“å¡å¤±æ•—', true); }
    };

    // ç¶å®šæŒ‰éˆ•
    rowsEl.querySelectorAll('tr').forEach(tr => {
      tr.querySelector('.save-start-time')?.addEventListener('click', async () => {
        const assigneeId = tr.getAttribute('data-assignee-id') || '';
        const iso = dateInput.value;
        const hm = tr.querySelector('.start-time-input')?.value || '';
        const existingRecordId = tr.getAttribute('data-start-record-id') || null;
        await updateClockTime(assigneeId, 'ä¸Šç­', iso, hm, existingRecordId);
        await renderList();
      });
      tr.querySelector('.save-end-time')?.addEventListener('click', async () => {
        const assigneeId = tr.getAttribute('data-assignee-id') || '';
        const iso = dateInput.value;
        const hm = tr.querySelector('.end-time-input')?.value || '';
        const existingRecordId = tr.getAttribute('data-end-record-id') || null;
        await updateClockTime(assigneeId, 'ä¸‹ç­', iso, hm, existingRecordId);
        await renderList();
      });
      tr.querySelector('.manual-clock-in')?.addEventListener('click', () => manualClock(tr, 'ä¸Šç­'));
      tr.querySelector('.manual-clock-out')?.addEventListener('click', () => manualClock(tr, 'ä¸‹ç­'));
      tr.querySelector('.row-leave-apply')?.addEventListener('click', () => {
        try { openTempLeaveModal(); } catch (err) { showToast('ç„¡æ³•é–‹å•Ÿè«‹å‡ç”³è«‹', true); }
      });
      tr.querySelector('.row-share')?.addEventListener('click', async () => {
        try {
          const docId = tr.getAttribute('data-doc-id');
          const shiftIndex = parseInt(tr.getAttribute('data-shift-index'), 10);
          const dref = doc(db,'communities', state.currentCommunity?.id, 'postSchedules', docId);
          const dsnap = await getDoc(dref);
          const data = dsnap.exists() ? dsnap.data() : null;
          const shifts = Array.isArray(data?.shifts) ? data.shifts : [];
          const newShifts = shifts.map((sh,i)=> i===shiftIndex ? { ...sh, cashShift: true } : sh);
          await setDoc(dref, { ...data, shifts: newShifts, updatedAt: Timestamp.fromDate(new Date()) });
          showToast('å·²æ¨™è¨˜ç‚ºç¾é‡‘ç­');
        } catch (e) { console.error('share cash shift error', e); showToast('åˆ†äº«å¤±æ•—', true); }
      });
    });
  };

  ensureUsersOptions().then(renderList);
  userSelect.addEventListener('change', renderList);
  dateInput.addEventListener('change', renderList);
  // å“¨é»ä¸‹æ‹‰å·²ç§»é™¤
}

function renderTrackingLeave(container) {
                container.innerHTML = `
                    <div class="p-4 space-y-4">
                        <div class="flex flex-wrap items-center gap-4 mb-4">
                            <div class="flex items-center space-x-2">
                                <label for="leave-status-filter" class="text-sm font-medium">å¯©æ ¸ç‹€æ…‹:</label>
                                <select id="leave-status-filter" class="border border-gray-300 rounded-md px-2 py-1">
                                    <option value="all" selected>å…¨éƒ¨</option>
                                    <option value="pending">å¾…å¯©æ ¸</option>
                                    <option value="approved">å·²æ ¸å‡†</option>
                                    <option value="rejected">å·²æ‹’çµ•</option>
                                    <option value="canceled">å·²å–æ¶ˆ</option>
                                </select>
                            </div>
                            <div class="flex items-center space-x-2">
                                <label for="leave-date-filter" class="text-sm font-medium">æ—¥æœŸ:</label>
                                <input type="date" id="leave-date-filter" class="border border-gray-300 rounded-md px-2 py-1" value="">
                            </div>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="leave-show-deleted" class="rounded" />
                                <span class="text-sm font-medium">é¡¯ç¤ºå·²åˆªé™¤</span>
                            </label>
                            <button id="leave-search-btn" class="bg-blue-600 text-white px-3 py-1 rounded-md hover:bg-blue-700 flex items-center">
                                <i data-lucide="search" class="w-4 h-4 mr-1"></i>æœå°‹
                            </button>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è«‹å‡äºº</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">äº‹ç”±</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é–‹å§‹æ™‚é–“</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">çµæŸæ™‚é–“</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç‹€æ…‹</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="leave-records-list" class="bg-white divide-y divide-gray-200">
                                        <tr>
                                            <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                                <div class="flex items-center justify-center">
                                                    <i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i>
                                                    è¼‰å…¥ä¸­...
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div id="no-leave-records" class="hidden p-8 text-center text-gray-500 bg-white rounded-lg shadow">
                            <i data-lucide="calendar-off" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                            <p>æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è«‹å‡è¨˜éŒ„</p>
                        </div>
                    </div>
                `;
                
                lucide.createIcons();
                
                // ç²å–å…ƒç´ 
                const statusFilter = document.getElementById('leave-status-filter');
                const dateFilter = document.getElementById('leave-date-filter');
                const searchBtn = document.getElementById('leave-search-btn');
                const showDeletedChk = document.getElementById('leave-show-deleted');

                // å–å¾— Firestore å¿«æ·åƒè€ƒï¼ˆå¾ŒçºŒå¤šè™•ä½¿ç”¨ï¼‰
                const db = window.__db; 
                const { collection, query, where, orderBy, getDocs, doc, getDoc, updateDoc, serverTimestamp } = window.__fs;

                // ç›®å‰é¸å®šç¤¾å€ï¼ˆç”¨æ–¼éæ¿¾æˆå“¡ï¼‰
                const selectedCommunityId = state.currentCommunity?.id || window.pageState?.selectedCommunityId || null;
                const selectedCommunityCode = state.currentCommunity?.code || state.currentCommunity?.communityCode || null;
                let communityUserIds = new Set();

                // å–å¾—åƒ…å±¬æ–¼ç›®å‰ç¤¾å€çš„å¸³è™Ÿæ¸…å–®ï¼ˆID é›†åˆï¼‰
                async function ensureCommunityUserIds() {
                    try {
                        if (Array.isArray(window.pageState?.communityUsers) && window.pageState.communityUsers.length) {
                            communityUserIds = new Set(window.pageState.communityUsers.map(u => u.id));
                            return;
                        }
                        if (!db || !collection || !getDocs) { communityUserIds = new Set(); return; }
                        const snap = await getDocs(collection(db, 'users'));
                        const ids = [];
                        snap.forEach(d => {
                            const data = d.data();
                            const svcIds = Array.isArray(data.serviceCommunities) ? data.serviceCommunities : [];
                            const svcCodes = Array.isArray(data.serviceCommunityCodes) ? data.serviceCommunityCodes : [];
                            const oneCode = (data.serviceCommunityCode || '').trim();
                            const byId = selectedCommunityId ? svcIds.includes(selectedCommunityId) : false;
                            const byCode = selectedCommunityCode ? (svcCodes.includes(selectedCommunityCode) || oneCode === selectedCommunityCode) : false;
                            if (byId || byCode) ids.push(d.id);
                        });
                        communityUserIds = new Set(ids);
                    } catch (err) {
                        console.warn('è¼‰å…¥ç¤¾å€å¸³è™Ÿæ¸…å–®å¤±æ•—', err);
                        communityUserIds = new Set();
                    }
                }

                // è®€å–ç•¶å‰ä½¿ç”¨è€…æ˜¯å¦ç‚ºç®¡ç†å“¡
                let isAdmin = false;
                (async () => {
                    try {
                        const uid = window.__auth?.currentUser?.uid;
                        if (uid) {
                            const userSnap = await getDoc(doc(db, 'users', uid));
                            if (userSnap.exists()) {
                                const role = userSnap.data().role;
                                isAdmin = role === 'admin';
                            }
                        }
                    } catch (err) {
                        console.warn('è®€å–ä½¿ç”¨è€…è§’è‰²å¤±æ•—', err);
                    }
                    // åˆå§‹åŠ è¼‰ï¼šå…ˆå–å¾—ç¤¾å€å¸³è™Ÿæ¸…å–®ï¼Œå†è¼‰å…¥è«‹å‡è¨˜éŒ„
                    await ensureCommunityUserIds();
                    loadLeaveRecords();
                })();
                
                // æ·»åŠ æœå°‹æŒ‰éˆ•äº‹ä»¶
                searchBtn.addEventListener('click', () => {
                    loadLeaveRecords();
                });
                // é¡¯ç¤ºå·²åˆªé™¤å‹¾é¸äº‹ä»¶
                showDeletedChk.addEventListener('change', () => {
                    loadLeaveRecords();
                });
                
                // åŠ è¼‰è«‹å‡è¨˜éŒ„
                function loadLeaveRecords() {
                    const recordsList = document.getElementById('leave-records-list');
                    const noRecordsMsg = document.getElementById('no-leave-records');
                    
                    recordsList.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                <div class="flex items-center justify-center">
                                    <i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i>
                                    è¼‰å…¥ä¸­...
                                </div>
                            </td>
                        </tr>
                    `;
                    lucide.createIcons();
                    
                    // ç²å–éæ¿¾æ¢ä»¶
                    const status = statusFilter.value;
                    const date = dateFilter.value;
                    
                    // æ§‹å»ºæŸ¥è©¢
                    let leavesQuery = collection(db, 'leaves');
                    
                    // å¦‚æœé¸æ“‡äº†ç‰¹å®šç‹€æ…‹
                    if (status !== 'all') {
                        leavesQuery = query(leavesQuery, where('status', '==', status));
                    }

                    // æŒ‰å‰µå»ºæ™‚é–“æ’åº
                    leavesQuery = query(leavesQuery, orderBy('createdAt', 'desc'));

                    // åŸ·è¡ŒæŸ¥è©¢
                    getDocs(leavesQuery).then((querySnapshot) => {
                        if (querySnapshot.empty) {
                            recordsList.innerHTML = '';
                            noRecordsMsg.classList.remove('hidden');
                            return;
                        }
                        
                        noRecordsMsg.classList.add('hidden');
                        recordsList.innerHTML = '';
                        
                        // æ—¥æœŸéæ¿¾
                        const selectedDate = date ? new Date(date) : null;
                        let nextDay = null;
                        if (selectedDate) {
                            selectedDate.setHours(0, 0, 0, 0);
                            nextDay = new Date(selectedDate);
                            nextDay.setDate(nextDay.getDate() + 1);
                        }
                        
                        let hasRecords = false;
                        
                        querySnapshot.forEach((docSnap) => {
                            const leave = docSnap.data();
                            const leaveId = docSnap.id;
                            const isDeleted = !!leave.deleted;

                            // åƒ…é¡¯ç¤ºå±¬æ–¼ç›®å‰ç¤¾å€å¸³è™Ÿæ¸…å–®çš„ä½¿ç”¨è€…
                            if (communityUserIds && communityUserIds.size > 0) {
                                const uid = leave.userId || leave.userID || leave.uid;
                                if (!communityUserIds.has(uid)) return;
                            }
                            
                            // è‹¥æœªå‹¾é¸é¡¯ç¤ºå·²åˆªé™¤ï¼Œå‰‡éæ¿¾æ‰ deleted è¨˜éŒ„
                            if (!showDeletedChk.checked && isDeleted) {
                                return;
                            }
                            
                            // å¦‚æœé¸æ“‡äº†æ—¥æœŸï¼Œæª¢æŸ¥è«‹å‡æ™‚é–“æ˜¯å¦åœ¨æ‰€é¸æ—¥æœŸç¯„åœå…§
                            if (selectedDate && nextDay) {
                                const startTime = leave.startTime.toDate();
                                const endTime = leave.endTime.toDate();
                                
                                // æª¢æŸ¥è«‹å‡æ™‚é–“æ˜¯å¦èˆ‡æ‰€é¸æ—¥æœŸæœ‰é‡ç–Š
                                if (!(startTime < nextDay && endTime > selectedDate)) {
                                    return; // è·³éä¸ç¬¦åˆæ—¥æœŸæ¢ä»¶çš„è¨˜éŒ„
                                }
                            }
                            
                            hasRecords = true;
                            
                            const startTime = leave.startTime.toDate().toLocaleString('zh-TW', { hour12: false });
                            const endTime = leave.endTime.toDate().toLocaleString('zh-TW', { hour12: false });
                            
                            let statusBadge = '';
                            switch (leave.status) {
                                case 'pending':
                                    statusBadge = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">å¾…å¯©æ ¸</span>';
                                    break;
                                case 'approved':
                                    statusBadge = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">å·²æ ¸å‡†</span>';
                                    break;
                                case 'rejected':
                                    statusBadge = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">å·²æ‹’çµ•</span>';
                                    break;
                                case 'canceled':
                                    statusBadge = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-200 text-gray-700">å·²å–æ¶ˆ</span>';
                                    break;
                                default:
                                    statusBadge = '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">æœªçŸ¥</span>';
                            }
                            
                            const row = document.createElement('tr');
                            row.className = 'hover:bg-gray-50';
                            
                            let actionButtons = '';
                            if (leave.status === 'pending') {
                                actionButtons += `
                                    <button data-leave-id="${leaveId}" data-action="approve" class="text-green-600 hover:text-green-900 mr-3">
                                        <i data-lucide="check-circle" class="w-5 h-5"></i>
                                    </button>
                                    <button data-leave-id="${leaveId}" data-action="reject" class="text-red-600 hover:text-red-900">
                                        <i data-lucide="x-circle" class="w-5 h-5"></i>
                                    </button>
                                `;
                            }
                            if (isAdmin) {
                                actionButtons += `
                                    <button data-leave-id="${leaveId}" data-action="${isDeleted ? 'restore' : 'delete'}" class="text-gray-600 hover:text-gray-900 ml-3">
                                        <i data-lucide="${isDeleted ? 'rotate-ccw' : 'trash-2'}" class="w-5 h-5"></i>
                                    </button>
                                `;
                            }
                            
                            row.innerHTML = `
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="text-sm font-medium text-gray-900">${leave.userName || 'æœªçŸ¥ç”¨æˆ¶'}</div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">${leave.reason || 'ç„¡äº‹ç”±'}</div>
                                    <div class="text-xs text-gray-500">${leave.reasonType || ''}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">${startTime}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">${endTime}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    ${statusBadge}
                                    ${isDeleted ? '<span class="ml-2 px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-500">å·²åˆªé™¤</span>' : ''}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    ${actionButtons}
                                </td>
                            `;
                            
                            recordsList.appendChild(row);
                        });
                        
                        lucide.createIcons();
                        
                        if (!hasRecords) {
                            recordsList.innerHTML = '';
                            noRecordsMsg.classList.remove('hidden');
                        }
                        
                        // æ·»åŠ æ“ä½œæŒ‰éˆ•äº‹ä»¶ï¼ˆå¯©æ ¸ï¼åˆªé™¤ï¼é‚„åŸï¼‰
                        document.querySelectorAll('[data-leave-id]').forEach(btn => {
                            btn.addEventListener('click', async (e) => {
                                const leaveId = e.currentTarget.dataset.leaveId;
                                const action = e.currentTarget.dataset.action;
                                
                                try {
                                    showLoading(true);
                                    
                                    // ç²å–è«‹å‡è¨˜éŒ„
                                    const leaveDocSnap = await getDoc(doc(db, 'leaves', leaveId));
                                    if (!leaveDocSnap.exists()) {
                                        showToast('æ‰¾ä¸åˆ°è«‹å‡è¨˜éŒ„', true);
                                        return;
                                    }
                                    const leaveData = leaveDocSnap.data();
                                    const userId = leaveData.userId;
                                    
                                    if (action === 'approve' || action === 'reject') {
                                        // æ›´æ–°è«‹å‡è¨˜éŒ„ç‹€æ…‹ï¼ˆå¯©æ ¸ï¼‰
                                        await updateDoc(doc(db, 'leaves', leaveId), {
                                            status: action === 'approve' ? 'approved' : 'rejected',
                                            reviewedAt: serverTimestamp(),
                                            reviewedBy: window.__auth?.currentUser?.uid || ''
                                        });
                                        // å¦‚æœæ ¸å‡†ï¼Œæ›´æ–°ç”¨æˆ¶ç‹€æ…‹
                                        if (action === 'approve') {
                                            await updateDoc(doc(db, 'users', userId), { leaveStatus: 'approved' });
                                        }
                                        showToast(`å·²${action === 'approve' ? 'æ ¸å‡†' : 'æ‹’çµ•'}è«‹å‡ç”³è«‹`);
                                    } else if (action === 'delete') {
                                        // è»Ÿåˆªé™¤
                                        await updateDoc(doc(db, 'leaves', leaveId), {
                                            deleted: true,
                                            deletedAt: serverTimestamp(),
                                            deletedBy: window.__auth?.currentUser?.uid || ''
                                        });
                                        showToast('å·²æ¨™è¨˜ç‚ºåˆªé™¤');
                                    } else if (action === 'restore') {
                                        // é‚„åŸ
                                        await updateDoc(doc(db, 'leaves', leaveId), {
                                            deleted: false,
                                            restoredAt: serverTimestamp(),
                                            restoredBy: window.__auth?.currentUser?.uid || ''
                                        });
                                        showToast('å·²é‚„åŸåˆªé™¤æ¨™è¨˜');
                                    }
                                    
                                    // é‡æ–°åŠ è¼‰è¨˜éŒ„
                                    loadLeaveRecords();
                                } catch (error) {
                                    console.error('è™•ç†è«‹å‡ç”³è«‹å¤±æ•—:', error);
                                    showToast('è™•ç†è«‹å‡ç”³è«‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', true);
                                } finally {
                                    showLoading(false);
                                }
                            });
                        });
                    }).catch(error => {
                        console.error('ç²å–è«‹å‡è¨˜éŒ„å¤±æ•—:', error);
                        recordsList.innerHTML = `
                            <tr>
                                <td colspan="6" class="px-6 py-4 text-center text-red-500">
                                    è®€å–è¨˜éŒ„å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦
                                </td>
                            </tr>
                        `;
                    });
                }
            }
            
            function renderTrackingReports(container) {
                container.innerHTML = `
                    <div class="h-[50px] flex items-center justify-around border-b border-gray-200 bg-white">
                        <button data-report="personal" class="report-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 active">å€‹äººæ—¥å ±è¡¨</button>
                        <button data-report="all" class="report-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600">å…¨é«”æœˆå ±è¡¨</button>
                    </div>
                    <div id="report-content" class="p-4">
                        <div class="text-center">
                            <i data-lucide="construction" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
                            <h2 class="text-xl font-semibold text-gray-700 mb-2">å ±è¡¨åŠŸèƒ½é–‹ç™¼ä¸­</h2>
                            <p class="text-gray-500">æ­¤åŠŸèƒ½æ­£åœ¨é–‹ç™¼ä¸­ï¼Œæ•¬è«‹æœŸå¾…ï¼</p>
                        </div>
                    </div>
                `;
                lucide.createIcons();
                
                container.querySelectorAll('.report-tab-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        container.querySelectorAll('.report-tab-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        
                        const reportType = btn.dataset.report;
                        const reportContent = document.getElementById('report-content');
                        
                        reportContent.innerHTML = `
                            <div class="text-center">
                                <i data-lucide="construction" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
                                <h2 class="text-xl font-semibold text-gray-700 mb-2">${reportType === 'personal' ? 'å€‹äººæ—¥å ±è¡¨' : 'å…¨é«”æœˆå ±è¡¨'}åŠŸèƒ½é–‹ç™¼ä¸­</h2>
                                <p class="text-gray-500">æ­¤åŠŸèƒ½æ­£åœ¨é–‹ç™¼ä¸­ï¼Œæ•¬è«‹æœŸå¾…ï¼</p>
                            </div>
                        `;
                        lucide.createIcons();
                    });
                });
            }

            async function listenForUserLocations() {
                const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
                // çµ±ä¸€å¾ window.__fs / window.__db å–å¾— Firestore å‡½å¼èˆ‡ db åƒè€ƒï¼Œé¿å…é®è”½é€ æˆ TDZ éŒ¯èª¤
                const fs = window.__fs || {};
                const { collection, query, where, orderBy, limit, getDocs } = fs;
                const dbRef = window.__db || null;
                try { await ensureCommunitiesCache(); } catch (_) {}
                const usersRef = collection(dbRef, "users");
                const q = query(usersRef, orderBy("name"));
                try {
                    const querySnapshot = await getDocs(q);
                    state.trackingMarkers.forEach(marker => marker.map = null);
                    state.trackingMarkers = [];

                    const userListEl = document.getElementById('user-tracking-list');
                    if (!userListEl) return;
                    userListEl.innerHTML = '';

                    const users = [];
                    querySnapshot.forEach(doc => users.push({ id: doc.id, ...doc.data() }));

                    // é¡¯ç¤ºè©²ç¤¾å€æ‰€æœ‰äººå“¡ï¼ˆå¸³è™Ÿï¼‰ï¼Œä¸å—ä¸€èˆ¬å¯è¦‹äººå“¡è¨­å®šé™åˆ¶
                    let baseList = users;
                    const currentCommId = state.currentCommunity?.id || null;
                    const currentCommCode = state.currentCommunity?.code || state.currentCommunity?.communityCode || null;
                    if (currentCommId || currentCommCode) {
                        baseList = baseList.filter(u => {
                            const ids = Array.isArray(u.serviceCommunities) ? u.serviceCommunities : [];
                            const codesArr = Array.isArray(u.serviceCommunityCodes) ? u.serviceCommunityCodes : [];
                            const codeSingle = u.serviceCommunityCode || null;
                            const matchById = currentCommId ? ids.includes(currentCommId) : false;
                            const matchByCode = currentCommCode ? (codesArr.includes(currentCommCode) || codeSingle === currentCommCode) : false;
                            return matchById || matchByCode;
                        });
                    }

                    // åƒ…é¡¯ç¤ºæŒ‡å®šè§’è‰²ï¼ˆç¸½å¹¹äº‹ã€ç§˜æ›¸ã€ä¿å…¨ã€æ¸…æ½”ã€æ©Ÿé›»ï¼‰
                    const allowedRoles = ['ç¸½å¹¹äº‹','ç§˜æ›¸','ä¿å…¨','æ¸…æ½”','æ©Ÿé›»'];
                    const getEffectiveRole = (u) => {
                        const jt = (u.jobTitle || u.applicationTitle || '').trim();
                        return jt || (u.role || '');
                    };
                    baseList = baseList.filter(u => allowedRoles.includes(getEffectiveRole(u)));

                    if (baseList.length === 0) {
                        userListEl.innerHTML = `<p class="text-center text-gray-500 p-2">è©²ç¤¾å€ç›®å‰æ²’æœ‰å¯è¿½è¹¤çš„äººå“¡</p>`;
                        return;
                    }

                    // è®€å–æ¯ä½ä½¿ç”¨è€…æœ€æ–°æ‰“å¡ç´€éŒ„ï¼Œä¸¦ä»¥æ­¤é¡¯ç¤ºèˆ‡æ’åºï¼ˆæ²¿ç”¨å‰è¿°çµ±ä¸€å–å¾—ä¹‹å‡½å¼/åƒè€ƒï¼‰

                    const augmentedPromises = baseList.map(async (user) => {
                        let latestRecord = null;
                        try {
                            if (collection && query && where && orderBy && limit && getDocs && dbRef) {
                                const recQ = query(
                                    collection(dbRef, 'clockInRecords'),
                                    where('userId', '==', user.id),
                                    orderBy('timestamp', 'desc'),
                                    limit(1)
                                );
                                const snap = await getDocs(recQ);
                                if (!snap.empty) {
                                    latestRecord = snap.docs[0].data();
                                }
                            }
                        } catch (e) {
                            console.warn('å–å¾—æœ€æ–°æ‰“å¡ç´€éŒ„å¤±æ•—', e);
                        }

                        // ç‹€æ…‹æ–‡å­—èˆ‡æ™‚é–“ï¼šå„ªå…ˆä½¿ç”¨æœ€æ–°ç´€éŒ„ï¼Œå¦å‰‡å›é€€ user æ¬„ä½
                        const recordType = latestRecord?.type || user.clockInStatus || user.status || 'æœªæ‰“å¡';
                        const recordLocationName = latestRecord?.locationName || user.lastLocation?.address || null;
                        const dutyType = latestRecord?.dutyType || null;
                        let statusText = getStatusDisplayText(recordType, recordLocationName, dutyType);

                        // æ ¸å‡†çš„è«‹å‡ï¼šé¡¯ç¤ºã€Œè«‹å‡ã€ï¼ˆæ©˜è‰²ï¼‰ï¼Œåƒ…åœ¨ç•¶å¤©æœ‰æ•ˆæœŸå…§ï¼›æœªæ ¸å‡†ä½†è‡¨æ™‚è«‹å‡é¡¯ç¤ºã€Œè«‹å‡ç”³è«‹ã€
                        const toDate = v => v?.toDate ? v.toDate() : (v ? new Date(v) : null);
                        const now = new Date();
                        const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                        if (user.leaveStatus === 'approved' && user.leaveStartTime && user.leaveEndTime) {
                            const leaveStart = toDate(user.leaveStartTime);
                            const leaveEnd = toDate(user.leaveEndTime);
                            if (leaveStart && leaveEnd && leaveStart <= todayEnd && leaveEnd >= todayStart) {
                                statusText = 'è«‹å‡';
                            }
                        } else if (user.clockInStatus === 'è‡¨æ™‚è«‹å‡') {
                            statusText = 'è«‹å‡ç”³è«‹';
                        }

                        const ts = latestRecord?.timestamp && latestRecord.timestamp.toDate ? latestRecord.timestamp.toDate() : (latestRecord?.timestamp ? new Date(latestRecord.timestamp) : (user.lastClockInTime?.toDate ? user.lastClockInTime.toDate() : null));
                        // å®šä½ç•°å¸¸æ¨™è¨˜ï¼ˆä»¥æœå‹™ç¤¾å€åŠå¾‘åˆ¤æ–·ï¼‰
                        let abnormalText = '';
                        try {
                            const svcIds = Array.isArray(user.serviceCommunities) ? user.serviceCommunities.slice() : [];
                            if ((!svcIds || svcIds.length === 0) && user.serviceCommunityCode && state.communitiesById) {
                                const mapped = Object.values(state.communitiesById).find(c => (c.code || '').trim() === (user.serviceCommunityCode || '').trim());
                                if (mapped) svcIds.push(mapped.id);
                            }
                            if (latestRecord && svcIds.length > 0) {
                                const ab = computeRecordAbnormal(latestRecord, svcIds);
                                if (ab && ab.isAbnormal) abnormalText = 'å®šä½ç•°å¸¸';
                            }
                        } catch (_) {}

                        return {
                            ...user,
                            __statusText: statusText,
                            __lastStatusTime: ts,
                            __latestRecord: latestRecord || null,
                            __abnormalText: abnormalText
                        };
                    });

                    Promise.all(augmentedPromises).then((augmentedUsers) => {
                        // æ’åºå°é½Šã€Œæ‰€æœ‰åŒä»ç‹€æ…‹ã€ï¼šç‹€æ…‹å„ªå…ˆç´š -> æœ€è¿‘æ›´æ–°æ™‚é–“(æ–°â†’èˆŠ) -> å§“å
                        const statusPriority = (u) => {
                        const display = u.__statusText || getStatusDisplayText(u.clockInStatus || 'æœªæ‰“å¡', (u.clockInStatus === 'å¤–å‡º' && u.outboundLocation ? u.outboundLocation : (u.lastLocation?.address || null)), u.dutyType);
                            let isLeave = (u.clockInStatus === 'è‡¨æ™‚è«‹å‡') || (display.includes('è«‹å‡'));
                            if (!isLeave) {
                                const leave = u.leaveStatus || '';
                                if (leave === 'approved' || leave === 'pending') {
                                    const now = new Date();
                                    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                                    const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                                    if (u.leaveStartTime && u.leaveEndTime) {
                                        const leaveStart = u.leaveStartTime.toDate ? u.leaveStartTime.toDate() : new Date(u.leaveStartTime);
                                        const leaveEnd = u.leaveEndTime.toDate ? u.leaveEndTime.toDate() : new Date(u.leaveEndTime);
                                        isLeave = leaveStart <= todayEnd && leaveEnd >= todayStart;
                                    }
                                }
                            }
                            if (display.includes('ä¸Šç­') && (display.includes('è¾¦å…¬å®¤') || display.includes('åœ¨è¾¦å…¬å®¤'))) return 1;
                            if (display.includes('è¿”å›') && (display.includes('è¾¦å…¬å®¤') || display.includes('åœ¨è¾¦å…¬å®¤'))) return 2;
                            if (display.startsWith('å¤–å‡º-')) return 3;
                            if (display.startsWith('æŠµé”-')) return 4;
                            if (display.startsWith('é›¢é–‹-')) return 5;
                            if (isLeave) return 6;
                            if (display.includes('ä¸‹ç­')) return 7;
                            return 8;
                        };

                        augmentedUsers.sort((a, b) => {
                            const prA = statusPriority(a);
                            const prB = statusPriority(b);
                            if (prA !== prB) return prA - prB;
                            const tA = a.lastUpdated ? (a.lastUpdated.toDate ? a.lastUpdated.toDate() : new Date(a.lastUpdated)) : new Date(0);
                            const tB = b.lastUpdated ? (b.lastUpdated.toDate ? b.lastUpdated.toDate() : new Date(b.lastUpdated)) : new Date(0);
                            if (tA.getTime() !== tB.getTime()) return tB - tA;
                            return (a.name || '').localeCompare(b.name || '', 'zh-Hant');
                        });

                        // ç”Ÿæˆåˆ—è¡¨èˆ‡åœ°åœ–æ¨™è¨˜
                        augmentedUsers.forEach(user => {
                            const recLoc = user.__latestRecord?.location || null;
                            const recLat = recLoc && typeof recLoc.latitude === 'number' ? recLoc.latitude : (user.__latestRecord?.locationLat ?? null);
                            const recLng = recLoc && typeof recLoc.longitude === 'number' ? recLoc.longitude : (user.__latestRecord?.locationLng ?? null);
                            const hasRecordLocation = typeof recLat === 'number' && typeof recLng === 'number';
                            const hasLastLocation = user.lastLocation && typeof user.lastLocation.latitude === 'number' && typeof user.lastLocation.longitude === 'number';
                            const hasLocation = hasRecordLocation || hasLastLocation;

                            const userElement = document.createElement('div');
                            userElement.className = `flex items-center justify-between p-2 rounded-md cursor-pointer hover:bg-gray-100 ${!hasLocation ? 'opacity-50' : ''}`;
                            const statusColorClass = getStatusColor(user.__statusText || 'æœªæ‰“å¡');

                            // è·é›¢èˆ‡åœˆå…§å¤–é¡¯ç¤º
                            let distanceText = '';
                            let rangeText = '';
                            let insideRange = null;
                            let position = null;
                            if (hasLocation) {
                                position = hasRecordLocation
                                    ? { lat: recLat, lng: recLng }
                                    : { lat: user.lastLocation.latitude, lng: user.lastLocation.longitude };
                                const center = state.companyCenter || (state.trackingMap ? state.trackingMap.getCenter().toJSON() : null);
                                const radius = state.trackingRadiusCircle ? state.trackingRadiusCircle.getRadius() : null;
                                if (center && typeof center.lat === 'number' && typeof center.lng === 'number') {
                                    const toRad = d => d * Math.PI / 180;
                                    const R = 6371000;
                                    const dLat = toRad(position.lat - center.lat);
                                    const dLng = toRad(position.lng - center.lng);
                                    const a = Math.sin(dLat/2) ** 2 + Math.cos(toRad(center.lat)) * Math.cos(toRad(position.lat)) * Math.sin(dLng/2) ** 2;
                                    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                                    const dist = R * c;
                                    distanceText = `è·ç¤¾å€ç´„ ${Math.round(dist)}m`;
                                    if (typeof radius === 'number') {
                                        insideRange = dist <= radius;
                                        rangeText = insideRange ? 'ï¼ˆç¯„åœå…§ï¼‰' : 'ï¼ˆç¯„åœå¤–ï¼‰';
                                    }
                                }
                            }

                            userElement.innerHTML = `
                                <div class="flex items-center">
                                    <img src="${user.avatarUrl || `https://placehold.co/32x32/EFEFEF/333333?text=${(user.name || 'U').charAt(0)}`}" class="w-8 h-8 rounded-full mr-3 object-cover">
                                    <div>
                                        <p class="font-medium text-sm text-gray-800">${user.name || 'æœªçŸ¥ç”¨æˆ¶'}</p>
                                        <p class="text-xs font-semibold ${statusColorClass}">${user.__statusText || 'æœªæ‰“å¡'}${user.__abnormalText ? ' Â· âš  ' + user.__abnormalText : ''}</p>
                                        ${distanceText ? `<p class=\"text-xs text-gray-500\">${distanceText}${rangeText}</p>` : ''}
                                    </div>
                                </div>
                                <span class="text-xs text-gray-400">${user.__lastStatusTime ? 'æœ€è¿‘ç‹€æ…‹æ™‚é–“ï¼š' + timeAgo(user.__lastStatusTime) : 'ç„¡ç´€éŒ„'}</span>
                            `;
                            userListEl.appendChild(userElement);

                            if (hasLocation) {
                                const markerIcon = document.createElement('img');
                                markerIcon.src = user.avatarUrl || `https://placehold.co/40x40/EFEFEF/333333?text=${(user.name || 'U').charAt(0)}`;
                                const roleColorMap = { 'ç¸½å¹¹äº‹': 'border-amber-500', 'ç§˜æ›¸': 'border-purple-500', 'ä¿å…¨': 'border-green-800', 'æ¸…æ½”': 'border-pink-400', 'æ©Ÿé›»': 'border-blue-500' };
const titleKey = ((user.applicationTitle || user.jobTitle || user.role || '').trim());
const roleBorderClass = roleColorMap[titleKey] || null;
                                const borderClass = roleBorderClass || (insideRange === true ? 'border-green-500' : (insideRange === false ? 'border-red-500' : 'border-white'));
                                markerIcon.className = `w-9 h-9 rounded-full border-2 ${borderClass} shadow-md object-cover`;

                                const marker = new AdvancedMarkerElement({
                                    position,
                                    map: state.trackingMap,
                                    title: user.name || '',
                                    content: markerIcon,
                                });

                                const locationName = user.__latestRecord?.locationName
                                    || (user.clockInStatus === 'å¤–å‡º' ? (user.outboundLocation || '') : '')
                                    || (user.lastLocation?.address || '');
                                const infoWindow = new google.maps.InfoWindow({
                                    content: `
                                        <div class="p-1">
                                            <p class="font-bold">${user.name || 'æœªçŸ¥ç”¨æˆ¶'}</p>
                                            <p>ç‹€æ…‹: ${user.__statusText || 'æœªæ‰“å¡'}</p>
                                            <p>æœ€è¿‘ç‹€æ…‹æ™‚é–“: ${user.__lastStatusTime ? formatDateTime(user.__lastStatusTime) : 'N/A'}</p>
                                            ${locationName ? `<p>æ‰“å¡åœ°é»: ${locationName}</p>` : ''}
                                            ${distanceText ? `<p>è·ç¤¾å€ï¼š${distanceText.replace('è·ç¤¾å€ç´„ ', '').replace('m',' å…¬å°º')} ${insideRange === null ? '' : (insideRange ? '(åœˆå…§)' : '(åœˆå¤–)')}</p>` : ''}
                                        </div>
                                    `
                                });

                                marker.addListener('click', () => {
                                    infoWindow.open({ anchor: marker, map: state.trackingMap });
                                });

                                userElement.addEventListener('click', () => {
                                    state.trackingMap.panTo(position);
                                    state.trackingMap.setZoom(17);
                                    infoWindow.open({ anchor: marker, map: state.trackingMap });
                                });

                                state.trackingMarkers.push(marker);
                            }
                        });
                    });
                } catch (error) {
                    console.error('è®€å–äººå“¡ä½ç½®æ¸…å–®å¤±æ•—', error);
                    showToast('è®€å–è¿½è¹¤äººå“¡å¤±æ•—', true);
                }
            }


            function renderSettings(subPage) {
                // æ–°å¢ã€Œå¸³è™Ÿç”³è«‹ã€å­åˆ†é ï¼Œæä¾›ç®¡ç†å“¡å¯©æ ¸
                mainContent.innerHTML = `
                    <div class="h-[50px] flex items-center justify-around border-b border-gray-200 bg-white">
                        <button data-subtab="applications" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'applications' ? 'active' : ''}">å¸³è™Ÿç”³è«‹</button>
                        <button data-subtab="accounts" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'accounts' ? 'active' : ''}">å¸³è™Ÿåˆ—è¡¨</button>
                        <button data-subtab="community" class="sub-tab-btn px-4 py-2 rounded-md text-sm font-medium text-gray-600 ${subPage === 'community' ? 'active' : ''}">ç¤¾å€åˆ—è¡¨</button>
                    </div>
                    <div id="sub-page-content" class="overflow-y-auto" style="height: calc(100% - 50px);"></div>`;

                const subPageContent = document.getElementById('sub-page-content');
                if (subPage === 'applications') {
                    renderSettingsApplications(subPageContent);
                } else if (subPage === 'accounts') {
                    renderSettingsAccounts(subPageContent);
                } else {
                    renderSettingsCommunity(subPageContent);
                }

                mainContent.querySelectorAll('.sub-tab-btn').forEach(btn => btn.addEventListener('click', () => showPage('settings', btn.dataset.subtab)));
            }

            function renderSettingsGroup(container) {
                container.innerHTML = `
                    <div class="p-4 space-y-4">
                        <h2 class="text-lg font-semibold">ç¾¤çµ„è¨­å®š</h2>
                        <p class="text-sm text-gray-600">å°‡åˆéšä¸»ç®¡é—œè¯è‡³å¯æŸ¥çœ‹çš„å“¡å·¥åå–®ã€‚</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div id="manager-select-panel" class="bg-white p-4 rounded-md shadow-sm border">
                                <h3 class="font-medium mb-2">é¸æ“‡ç®¡ç†è€…</h3>
                                <select id="manager-user-select" class="w-full border border-gray-300 rounded-md px-2 py-1"></select>
                            </div>
                            <div id="allowed-users-panel" class="bg-white p-4 rounded-md shadow-sm border">
                                <h3 class="font-medium mb-2">å¯æŸ¥çœ‹å“¡å·¥</h3>
                                <div id="allowed-users-list" class="space-y-2"></div>
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <button id="save-group-settings" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700">å„²å­˜è¨­å®š</button>
                        </div>
                    </div>`;
                lucide.createIcons();
                initSettingsGroupUI();
            }

            async function initSettingsGroupUI() {
                const managerSelect = document.getElementById('manager-user-select');
                const allowedList = document.getElementById('allowed-users-list');
                const usersRef = collection(db, 'users');
                const qs = await getDocs(usersRef);
                const users = [];
                qs.forEach(docSnap => users.push({ id: docSnap.id, ...docSnap.data() }));
                const managers = users.filter(u => u.role === 'junior_manager');
                managers.sort((a,b)=>a.name.localeCompare(b.name,'zh-Hant')).forEach(m => {
                    const opt = document.createElement('option'); opt.value = m.id; opt.textContent = `${m.name}`; managerSelect.appendChild(opt);
                });

                const renderAllowedUsers = async () => {
                    allowedList.innerHTML = '';
                    const selectedManagerId = managerSelect.value;
                    const allowedIds = await loadJuniorManagerAllowedUsers(selectedManagerId);
                    users.filter(u => u.role === 'user').sort((a,b)=>a.name.localeCompare(b.name,'zh-Hant')).forEach(u => {
                        const row = document.createElement('label');
                        row.className = 'flex items-center justify-between bg-white p-2 rounded border';
                        const chk = document.createElement('input');
                        chk.type = 'checkbox';
                        chk.checked = allowedIds.includes(u.id);
                        chk.dataset.userid = u.id;
                        row.appendChild(document.createTextNode(u.name));
                        row.appendChild(chk);
                        allowedList.appendChild(row);
                    });
                };
                managerSelect.addEventListener('change', renderAllowedUsers);
                await renderAllowedUsers();

                document.getElementById('save-group-settings').addEventListener('click', async () => {
                    const selectedManagerId = managerSelect.value;
                    const checkboxes = allowedList.querySelectorAll('input[type="checkbox"]');
                    const allowedIds = Array.from(checkboxes).filter(c => c.checked).map(c => c.dataset.userid);
                    const docRef = doc(db, 'settings', 'group');
                    const existingSnap = await getDoc(docRef);
                    const baseData = existingSnap.exists() ? existingSnap.data() : {};
                    const newData = { ...baseData, managerGroups: { ...(baseData.managerGroups || {}), [selectedManagerId]: allowedIds } };
                    await setDoc(docRef, newData, { merge: true });
                    showToast('ç¾¤çµ„è¨­å®šå·²å„²å­˜');
                });
            }
            
            async function renderSettingsAccounts(container) {
                const isHRPage = state.currentPage === 'hr';
                const isGlobalSettings = state.currentPage === 'settings' || state.currentPage === 'navigation';
                const rolesHR = ['ç¸½å¹¹äº‹','ç§˜æ›¸','ä¿å…¨','æ¸…æ½”','æ©Ÿé›»'];
                const rolesGlobal = ['admin','hr','manager','junior_manager','user','ç¸½å¹¹äº‹','ç§˜æ›¸','ä¿å…¨','æ¸…æ½”','æ©Ÿé›»'];
                const roleOpts = (isHRPage ? rolesHR : rolesGlobal)
                    .map(r => `<option value="${r}">${roleLabel(r)}</option>`)
                    .join('');
                const canBackfill = ['admin','hr'].includes(state.currentUserData?.role);
                const backfillBtnHtml = canBackfill ? `<button id="backfill-loginindex-btn" class="px-3 py-1 bg-blue-600 text-white rounded-md hover:bg-blue-700">æ‰¹æ¬¡å›å¡« loginIndex</button>` : '';
                const communityFilterHtml = isGlobalSettings ? `
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">ç¤¾å€</label>
                                    <select id="filter-community" class="w-full px-3 py-2 border rounded-md">
                                        <option value="">å…¨éƒ¨ç¤¾å€</option>
                                    </select>
                                </div>` : '';
                const tipHtml = isHRPage
                    ? '<div class="text-sm text-gray-500">æ­¤åˆ—è¡¨åƒ…é¡¯ç¤ºç›®å‰ç¤¾å€ä¹‹äººå“¡ï¼›ä¸æä¾›æ–°å¢åŠŸèƒ½ã€‚</div>'
                    : '<div class="text-sm text-gray-500">é¡¯ç¤ºå…¨éƒ¨ç¤¾å€ä¹‹äººå“¡ï¼›å¯ä¾è§’è‰²èˆ‡ç¤¾å€éæ¿¾ã€‚</div>';

                container.innerHTML = `
                    <div class="p-4 space-y-4">
                        <div class="bg-white p-3 rounded-md shadow-sm border space-y-2">
                            <div class="flex items-center justify-between">
                                <h3 class="font-bold text-lg">å¸³è™Ÿåˆ—è¡¨</h3>
                                <div class="flex items-center gap-2">
                                    ${backfillBtnHtml}
                                    ${ (state.currentPage === 'navigation' && (state.currentUserData?.role === 'admin')) ? `<button id="add-user-btn" class="px-3 py-1 bg-red-600 text-white rounded-md hover:bg-red-700">æ–°å¢å¸³è™Ÿ</button>` : '' }
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">è§’è‰²</label>
                                    <select id="filter-role" class="w-full px-3 py-2 border rounded-md">
                                        <option value="">å…¨éƒ¨è§’è‰²</option>
                                        ${roleOpts}
                                    </select>
                                </div>
                                ${communityFilterHtml}
                            </div>
                        </div>

                        ${tipHtml}
                        <div id="user-list" class="space-y-2"></div>
                    </div>`;
                lucide.createIcons();

                const userList = document.getElementById('user-list');
                const usersRef = collection(db, "users");
                const q = query(usersRef, orderBy("name"));

                // ç¯©é¸ç‹€æ…‹
                let allUsers = [];
                let lastRendered = [];
                const roleSelect = document.getElementById('filter-role');
                const communitySelect = document.getElementById('filter-community');
                let communitiesCache = [];
                const getEffectiveRole = (u) => {
                    const jt = ((u?.jobTitle || u?.applicationTitle || '').trim());
                    return isFieldLikeRole(jt) ? jt : (u?.role || 'user');
                };

                roleSelect.addEventListener('change', renderUserList);
                if (isGlobalSettings && communitySelect) {
                    try { await ensureCommunitiesCache(); } catch (_) {}
                    try { computeAvailableCommunities(); } catch (_) {}
                    const byId = state.communitiesById || {};
                    const list = Object.values(byId).slice().sort(compareCommunitiesByCode);
                    communitiesCache = list;
                    communitySelect.innerHTML = `<option value="">å…¨éƒ¨ç¤¾å€</option>` + list.map(c => `<option value="${c.id}" data-code="${c.code || ''}">${c.code ? '['+c.code+'] ' : ''}${c.name || '(æœªå‘½åç¤¾å€)'}</option>`).join('');
                    communitySelect.addEventListener('change', renderUserList);
                }

                const addBtn = document.getElementById('add-user-btn');
                if (addBtn) {
                    addBtn.addEventListener('click', () => openUserModal());
                }
                const backfillBtn = document.getElementById('backfill-loginindex-btn');
                if (backfillBtn) {
                    backfillBtn.addEventListener('click', async () => {
                        try {
                            const role = state.currentUserData?.role || '';
                            if (!['admin','hr'].includes(role)) {
                                showToast('æ‚¨æ²’æœ‰æ¬Šé™åŸ·è¡Œå›å¡«', true);
                                return;
                            }
                            // å–ç›®å‰æ¸…å–®ï¼ˆä¾ç¯©é¸çµæœï¼‰
                            const usersToProcess = Array.isArray(lastRendered) && lastRendered.length ? lastRendered.slice() : allUsers.slice();
                            if (!usersToProcess.length) {
                                showToast('ç›®å‰æ¸…å–®ç‚ºç©ºï¼Œç„¡éœ€å›å¡«');
                                return;
                            }
                            showLoading(true);
                            const { doc, setDoc, serverTimestamp } = window.__fs || {};
                            const db = window.__db;
                            let success = 0, skippedNoPhone = 0, skippedNoEmail = 0;
                            const seen = new Set();
                            for (const u of usersToProcess) {
                                const rawPhone = ((u?.phone || '') + '').trim();
                                const email = ((u?.email || '') + '').trim();
                                if (!rawPhone) { skippedNoPhone++; continue; }
                                if (!email || !email.includes('@')) { skippedNoEmail++; continue; }
                                const phoneKey = normalizePhone(rawPhone);
                                if (!phoneKey) { skippedNoPhone++; continue; }
                                if (seen.has(phoneKey)) { continue; }
                                seen.add(phoneKey);
                                try {
                                    await setDoc(doc(db, 'loginIndex', phoneKey), {
                                        email,
                                        userId: u.id,
                                        updatedAt: serverTimestamp()
                                    }, { merge: true });
                                    success++;
                                } catch (e) {
                                    console.warn('å›å¡«å–®ç­†å¤±æ•—', u?.id, e);
                                }
                            }
                            showToast(`å›å¡«å®Œæˆï¼šæˆåŠŸ ${success} ç­†ï¼›ç„¡æ‰‹æ©Ÿ ${skippedNoPhone}ï¼›ç„¡æœ‰æ•ˆ email ${skippedNoEmail}`);
                        } catch (err) {
                            console.error('æ‰¹æ¬¡å›å¡«å¤±æ•—', err);
                            showToast('æ‰¹æ¬¡å›å¡«å¤±æ•—', true);
                        } finally {
                            showLoading(false);
                        }
                    });
                }

                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    allUsers = [];
                    querySnapshot.forEach(doc => allUsers.push({ id: doc.id, ...doc.data() }));
                    state.users = allUsers; // Update global state
                    renderUserList();
                });

                function renderUserList() {
                    userList.innerHTML = '';
                    if (allUsers.length === 0) {
                        userList.innerHTML = `<p class="text-center text-gray-500 p-4">å°šæœªå»ºç«‹ä»»ä½•å¸³è™Ÿ</p>`;
                        return;
                    }
                    const selectedRole = roleSelect.value || '';
                    const allowedRoles = isHRPage ? rolesHR : rolesGlobal;
                    let filtered = allUsers.filter(u => {
                        const eff = getEffectiveRole(u);
                        return selectedRole ? (eff === selectedRole) : allowedRoles.includes(eff);
                    });

                    if (isHRPage) {
                        // ä¾ç›®å‰ç¤¾å€éæ¿¾æœå‹™æˆå“¡ï¼ˆåƒ…é¡¯ç¤ºæœå‹™è©²ç¤¾å€çš„äººå“¡ï¼‰
                        const currentCommId = state.currentCommunity?.id || null;
                        const currentCommCode = state.currentCommunity?.code || null;
                        if (currentCommId || currentCommCode) {
                            filtered = filtered.filter(u => {
                                const byId = currentCommId ? (Array.isArray(u.serviceCommunities) && u.serviceCommunities.includes(currentCommId)) : false;
                                const codesArr = Array.isArray(u.serviceCommunityCodes) ? u.serviceCommunityCodes : [];
                                const byCode = currentCommCode ? (codesArr.includes(currentCommCode) || (u.serviceCommunityCode === currentCommCode)) : false;
                                return byId || byCode;
                            });
                        } else {
                            // ç„¡æŒ‡å®šç¤¾å€ï¼Œæç¤ºé¸æ“‡ç¤¾å€ä¸¦é¡¯ç¤ºç©ºåˆ—è¡¨
                            filtered = [];
                            userList.innerHTML = `<p class="text-center text-gray-500 p-4">è«‹å…ˆé¸æ“‡ç¤¾å€</p>`;
                            return;
                        }
                    } else if (isGlobalSettings && communitySelect) {
                        // è¨­å®š/å°è¦½è¨­å®šé ï¼šå¯é¸ç¤¾å€éæ¿¾ï¼›é è¨­é¡¯ç¤ºå…¨éƒ¨ç¤¾å€
                        const selectedCommId = communitySelect.value || '';
                        if (selectedCommId) {
                            const selectedComm = communitiesCache.find(c => c.id === selectedCommId);
                            const selectedCode = selectedComm?.code || '';
                            filtered = filtered.filter(u => {
                                const byId = Array.isArray(u.serviceCommunities) && u.serviceCommunities.includes(selectedCommId);
                                const codesArr = Array.isArray(u.serviceCommunityCodes) ? u.serviceCommunityCodes : [];
                                const byCode = selectedCode ? (codesArr.includes(selectedCode) || (u.serviceCommunityCode === selectedCode)) : false;
                                return byId || byCode;
                            });
                        }
                    }

                    // äººå“¡ä¾å§“æ°ç­†ç•«å°‘â†’å¤š
                    filtered = filtered.slice().sort(compareUsersBySurnameStroke);

                    filtered.forEach(user => {
                        const userElement = document.createElement('div');
                        userElement.className = 'flex items-center justify-between bg-white p-3 rounded-md shadow-sm border';
                        const effRole = getEffectiveRole(user);
                        userElement.innerHTML = `
                            <div class="flex items-center">
                                <img src="${user.avatarUrl || `https://placehold.co/40x40/EFEFEF/333333?text=${(user.name||'?').charAt(0)}`}" class="w-10 h-10 rounded-full mr-3 object-cover">
                                <div>
                                    <p class="font-medium text-gray-800">${user.name || '(æœªå‘½å)'} </p>
                                    <p class="text-sm text-gray-500">${user.email || ''}</p>
                                    <div class="flex items-center flex-wrap gap-2 mt-1">
                                        <p class="text-xs text-gray-400 mr-2">${user.phone || ''}</p>
                                        <span class="text-xs px-2 py-1 rounded-full ${roleBadgeClass(effRole)}">${roleLabel(effRole)}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button data-userid="${user.id}" class="edit-user-btn p-2 text-gray-500 hover:text-red-600"><i data-lucide="edit" class="w-4 h-4"></i></button>
                                <button data-userid="${user.id}" class="delete-user-btn p-2 text-gray-500 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>`;
                        userList.appendChild(userElement);
                    });
                    lastRendered = filtered;
                    lucide.createIcons();

                    document.querySelectorAll('.edit-user-btn').forEach(btn => btn.addEventListener('click', (e) => {
                        const userId = e.currentTarget.dataset.userid;
                        const userToEdit = state.users.find(u => u.id === userId);
                        if (userToEdit) openUserModal(userToEdit);
                    }));

                    document.querySelectorAll('.delete-user-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                        const userId = e.currentTarget.dataset.userid;
                        const userToDelete = state.users.find(u => u.id === userId);
                        if (userToDelete && confirm(`ç¢ºå®šè¦åˆªé™¤ ${userToDelete.name} çš„å¸³è™Ÿè³‡æ–™å—ï¼Ÿ\næ³¨æ„ï¼šæ­¤æ“ä½œåªæœƒåˆªé™¤è³‡æ–™åº«ç´€éŒ„ï¼Œä¸æœƒåˆªé™¤ä½¿ç”¨è€…çš„ç™»å…¥æ¬Šé™ã€‚`)) {
                            try {
                                showLoading(true);
                                await deleteDoc(doc(db, "users", userId));
                                showToast("å¸³è™Ÿè³‡æ–™åˆªé™¤æˆåŠŸ");
                            } catch (error) {
                                console.error("Error deleting user document:", error);
                                showToast("åˆªé™¤å¤±æ•—", true);
                            } finally {
                                showLoading(false);
                            }
                        }
                    }));
                }

                state.activeListeners.push(unsubscribe);
            }

            // è¨­å®šåˆ†é ï¼šå¸³è™Ÿç”³è«‹ï¼ˆå¯©æ ¸ï¼‰
            function renderSettingsApplications(container) {
                container.innerHTML = `
                    <div class="p-4 space-y-4">
                        <div class="bg-white p-3 rounded-md shadow-sm border space-y-2">
                            <div class="flex items-center justify-between">
                                <h3 class="font-bold text-lg">å¸³è™Ÿç”³è«‹å¯©æ ¸</h3>
                                <div class="flex items-center space-x-2">
                                    <button data-status="" class="status-filter-btn px-3 py-1 rounded-md text-sm font-medium text-gray-600 active">å…¨éƒ¨</button>
                                    <button data-status="pending" class="status-filter-btn px-3 py-1 rounded-md text-sm font-medium text-gray-600">å¾…å¯©</button>
                                    <button data-status="approved" class="status-filter-btn px-3 py-1 rounded-md text-sm font-medium text-gray-600">å·²æ ¸å‡†</button>
                                    <button data-status="rejected" class="status-filter-btn px-3 py-1 rounded-md text-sm font-medium text-gray-600">å·²æ‹’çµ•</button>
                                </div>
                            </div>
                        </div>

                        <div id="applications-list" class="space-y-2"></div>
                    </div>`;
                if (typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function') {
                    lucide.createIcons();
                }

                const listEl = document.getElementById('applications-list');
                const statusButtons = container.querySelectorAll('.status-filter-btn');
                let allApps = [];
                let currentStatus = '';

                statusButtons.forEach(btn => btn.addEventListener('click', () => {
                    container.querySelectorAll('.status-filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentStatus = btn.dataset.status || '';
                    renderList();
                }));

                const { collection: fsCollection, query: fsQuery, orderBy: fsOrderBy, onSnapshot: fsOnSnapshot, doc: fsDoc, getDoc: fsGetDoc, setDoc: fsSetDoc, updateDoc: fsUpdateDoc, deleteDoc: fsDeleteDoc, where: fsWhere, getDocs: fsGetDocs, serverTimestamp: fsServerTimestamp } = window.__fs || {};
                const appsCol = fsCollection(db, 'accountApplications');
                const q = fsQuery(appsCol, fsOrderBy('createdAt', 'desc'));
                // å³æ™‚ç›£è½ç”³è«‹æ¸…å–®è®Šæ›´ï¼Œä½¿æ ¸å‡†å¾Œåˆ—è¡¨ç«‹å³æ›´æ–°
                try {
                    const unsubscribe = fsOnSnapshot(q, async (snap) => {
                        allApps = [];
                        snap.forEach(ds => allApps.push({ id: ds.id, ...ds.data() }));
                        // åƒ…åœ¨å¯©æ ¸è§’è‰²ä¸‹åŸ·è¡Œè‡ªå‹•æ¸…ç†ï¼Œé¿å…æ¬Šé™ä¸è¶³éŒ¯èª¤
                        let canCleanup = false;
                        if (typeof window.checkReviewerStatus === 'function') {
                            try { canCleanup = await window.checkReviewerStatus(); } catch (_) {}
                        }
                        if (canCleanup) {
                            try { await autoCleanupDuplicates(); } catch (_) {}
                        }
                        renderList();
                    }, (error) => {
                        console.error('å³æ™‚ç›£è½å¸³è™Ÿç”³è«‹å¤±æ•—', error);
                    });
                    if (Array.isArray(state.activeListeners)) state.activeListeners.push(unsubscribe);
                } catch (e) {
                    // å›é€€ï¼šç„¡æ³•å»ºç«‹ç›£è½æ™‚ï¼Œæ”¹ç‚ºä¸€æ¬¡æ€§è¼‰å…¥
                    (async () => {
                        try {
                            const snap = await fsGetDocs(q);
                            allApps = [];
                            snap.forEach(ds => allApps.push({ id: ds.id, ...ds.data() }));
                            renderList();
                        } catch (err) {
                            console.error('è®€å–å¸³è™Ÿç”³è«‹å¤±æ•—', err);
                            listEl.innerHTML = '<p class="text-center text-red-500 p-4">ç„¡æ³•è¼‰å…¥å¸³è™Ÿç”³è«‹</p>';
                        }
                    })();
                }

                function renderList() {
                    listEl.innerHTML = '';
                    let filtered = currentStatus ? allApps.filter(a => (a.status || 'pending') === currentStatus) : allApps;

                    // ä¾ç›®å‰ç¤¾å€ä»£è™Ÿéæ¿¾ç”³è«‹
                    const currentCommCode = state.currentCommunity?.code || null;
                    if (currentCommCode) {
                        filtered = filtered.filter(a => (a.serviceCommunityCode || '') === currentCommCode);
                    } else {
                        listEl.innerHTML = `<p class="text-center text-gray-500 p-4">è«‹å…ˆé¸æ“‡ç¤¾å€</p>`;
                        return;
                    }

                    if (filtered.length === 0) {
                        listEl.innerHTML = `<p class="text-center text-gray-500 p-4">ç›®å‰è©²ç¤¾å€æ²’æœ‰ç”³è«‹</p>`;
                        return;
                    }
                    filtered.forEach(app => {
                        const el = document.createElement('div');
                        el.className = 'flex items-center justify-between bg-white p-3 rounded-md shadow-sm border';
                        const licenseStr = app.license || 'ç„¡';
                        let createdAtText = '';
                        try {
                            const dt = app.createdAt?.toDate ? app.createdAt.toDate() : (app.createdAt ? new Date(app.createdAt) : null);
                            if (dt) createdAtText = formatDateTime(dt);
                        } catch (_) {}

                        el.innerHTML = `
                            <div class="flex items-center">
                                <img src="${app.avatarUrl || `https://placehold.co/40x40/EFEFEF/333333?text=${(app.name||'?').charAt(0)}`}" class="w-10 h-10 rounded-full mr-3 object-cover">
                                <div>
                                    <p class="font-medium text-gray-800">${app.name || '(æœªå¡«å§“å)'}</p>
                                    <p class="text-sm text-gray-500">${app.email || ''}</p>
                                    <div class="text-xs text-gray-500 mt-1">
                                        <span class="mr-2">${app.phone || ''}</span>
                                        <span class="mr-2">åœ°å€ï¼š${app.homeAddress || ''}</span>
                                        <span class="mr-2">ç”Ÿæ—¥ï¼š${app.birthDate || ''}</span>
                                        <span class="mr-2">èº«åˆ†è­‰ï¼š${app.idNumber || ''}</span>
                                        <span class="mr-2">è­‰ç…§ï¼š${licenseStr}</span>
                                        <span class="mr-2">ç¤¾å€ä»£è™Ÿï¼š${app.serviceCommunityCode || ''}</span>
                                    </div>
                                    ${createdAtText ? `<p class="text-xs text-gray-400 mt-1">ç”³è«‹æ™‚é–“ï¼š${createdAtText}</p>` : ''}
                                    ${app.status && app.status !== 'pending' ? `<p class="text-xs mt-1 ${app.status==='approved' ? 'text-green-600' : 'text-red-600'}">ç‹€æ…‹ï¼š${app.status === 'approved' ? 'å·²æ ¸å‡†' : 'å·²æ‹’çµ•'}</p>` : ''}
                                </div>
                            </div>
                            <div class="flex space-x-3 items-center">
                                ${app.status === 'pending' ? `
                                <label class="inline-flex items-center space-x-1 text-sm text-gray-600">
                                  <input type="checkbox" class="approve-check w-4 h-4" data-id="${app.id}">
                                  <span>æ ¸å‡†</span>
                                </label>
                                <button data-id="${app.id}" class="reject-btn p-2 text-gray-500 hover:text-red-600" title="æ‹’çµ•"><i data-lucide="x" class="w-4 h-4"></i></button>
                                ` : ''}
                            </div>`;
                        listEl.appendChild(el);
                    });
                    if (typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function') {
                        lucide.createIcons();
                    }
                    // å‹¾é¸å³æ ¸å‡†
                    container.querySelectorAll('.approve-check').forEach(chk => {
                        chk.addEventListener('change', (e) => {
                            if (e.target.checked) {
                                e.target.disabled = true; // é¿å…é‡è¤‡é»æ“Š
                                handleApprove(e.target.dataset.id);
                            }
                        });
                    });
                    // ä¿ç•™æ—¢æœ‰æŒ‰éˆ•è¡Œç‚ºï¼ˆè‹¥ä»å­˜åœ¨ï¼‰
                    container.querySelectorAll('.approve-btn').forEach(btn => btn.addEventListener('click', () => handleApprove(btn.dataset.id)));
                    container.querySelectorAll('.reject-btn').forEach(btn => btn.addEventListener('click', () => handleReject(btn.dataset.id)));
                }

                async function handleApprove(appId) {
                    try {
                        showLoading(true);
                        const appRef = fsDoc(db, 'accountApplications', appId);
                        const appSnap = await fsGetDoc(appRef);
                        if (!appSnap.exists()) {
                            showToast('ç”³è«‹ä¸å­˜åœ¨', true);
                            return;
                        }
                        const app = appSnap.data();
                        let email = (app.email || '').trim();
                        if (!email) {
                            const rawPhone = (app.phone || '').trim();
                            const phoneKey = (typeof normalizePhone === 'function') ? normalizePhone(rawPhone) : (rawPhone ? rawPhone.replace(/[^0-9+]/g, '') : '');
                            if (phoneKey) {
                                email = `${phoneKey}@nwcom.com`;
                            } else {
                                showToast('ç”³è«‹ç¼ºå°‘é›»å­éƒµä»¶ä¸”æ‰‹æ©Ÿè™Ÿç¢¼ç„¡æ•ˆï¼Œç„¡æ³•æ ¸å‡†', true);
                                return;
                            }
                        }

                        // å»ºç«‹ Auth å¸³è™Ÿï¼ˆéš¨æ©Ÿæš«æ™‚å¯†ç¢¼ï¼‰ï¼Œè‹¥ email å·²å­˜åœ¨å‰‡å˜—è©¦æ›æ¥æ—¢æœ‰ä½¿ç”¨è€…
                        let targetUserId = null;
                        let createdAuthUser = false;
                        let usedAppPassword = false;
                        try {
                            const { initializeApp: initializeAppSecondary, deleteApp } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js');
                            const secondaryApp = initializeAppSecondary(firebaseConfig, `secondary-app-${Date.now()}`);
                            const secondaryAuth = getAuth(secondaryApp);
                            const applyPwd = (app.applyPassword || '').trim();
                            const useAppPwd = applyPwd && applyPwd.length >= 6;
                            const tempPassword = `Temp${Math.random().toString(36).slice(2, 10)}!1`;
                            const cred = await createUserWithEmailAndPassword(secondaryAuth, email, useAppPwd ? applyPwd : tempPassword);
                            targetUserId = cred.user.uid;
                            createdAuthUser = true;
                            usedAppPassword = !!useAppPwd;
                            await signOut(secondaryAuth);
                            await deleteApp(secondaryApp);
                        } catch (creationError) {
                            if (creationError?.code === 'auth/email-already-in-use') {
                                try {
                                    const usersRef = fsCollection(db, 'users');
                                    const q = fsQuery(usersRef, fsWhere('email', '==', email));
                                    const qs = await fsGetDocs(q);
                                    if (!qs.empty) {
                                        targetUserId = qs.docs[0].id;
                                    } else {
                                        throw creationError;
                                    }
                                } catch (_) {
                                    throw creationError;
                                }
                            } else {
                                throw creationError;
                            }
                        }

                        // ä¾ä»£è™Ÿæ˜ å°„æœå‹™ç¤¾å€
                        let serviceCommunities = [];
                        try {
                            const communitiesRef = fsCollection(db, 'communities');
                            const qs = await fsGetDocs(fsQuery(communitiesRef, fsWhere('code', '==', app.serviceCommunityCode || '')));
                            qs.forEach(docSnap => serviceCommunities.push(docSnap.id));
                        } catch (_) {}

                        const userDoc = {
                            name: app.name || '',
                            phone: app.phone || '',
                            email,
                            role: 'user',
                            jobTitle: app.applicationTitle || '',
                            serviceCommunities,
                            homeAddress: app.homeAddress || '',
                            birthDate: app.birthDate || '',
                            idNumber: app.idNumber || '',
                            license: app.license || 'ç„¡',
                            serviceCommunityCode: app.serviceCommunityCode || '',
                            avatarUrl: app.avatarUrl || null,
                            points: 0,
                            status: 'æœªæ‰“å¡',
                            createdAt: fsServerTimestamp(),
                        };
                        if (targetUserId) {
                            await fsSetDoc(fsDoc(db, 'users', targetUserId), userDoc, { merge: true });
                            // å¯«å…¥ç™»å…¥ç´¢å¼•ï¼šphoneKey -> email, userId
                            try {
                                const rawPhone = (app.phone || '').trim();
                                if (rawPhone) {
                                    const phoneKey = rawPhone.startsWith('+')
                                        ? ('+' + rawPhone.slice(1).replace(/[^0-9]/g, ''))
                                        : rawPhone.replace(/[^0-9]/g, '');
                                    await fsSetDoc(fsDoc(db, 'loginIndex', phoneKey), {
                                        email,
                                        userId: targetUserId,
                                        updatedAt: fsServerTimestamp()
                                    }, { merge: true });
                                }
                            } catch (e) {
                                console.warn('å¯«å…¥ loginIndex å¤±æ•—', e);
                            }
                        }

                        const updates = {
                            status: 'approved',
                            reviewerId: auth.currentUser?.uid || '',
                            reviewedAt: fsServerTimestamp(),
                            reviewNotes: '',
                            applyPassword: null
                        };
                        if (targetUserId) updates.convertedUserId = targetUserId;
                        await fsUpdateDoc(appRef, updates);

                if (!usedAppPassword) { 
                    try { 
                        const actionCodeSettings = {
                            url: `${window.location.origin}${window.location.pathname}?mode=resetPassword`,
                            handleCodeInApp: true
                        };
                        await sendPasswordResetEmail(auth, email, actionCodeSettings); 
                    } catch (_) {} 
                }
                        showToast(usedAppPassword ? 'å·²æ ¸å‡†ï¼Œè«‹ç”¨ç”³è«‹å¯†ç¢¼ç™»å…¥' : 'å·²æ ¸å‡†ä¸¦å»ºç«‹å¸³è™Ÿï¼ˆå·²å¯„å‡ºé‡è¨­å¯†ç¢¼é€šçŸ¥ï¼‰');
                    } catch (err) {
                        console.error('approve application error', err);
                        const msg = err?.code === 'auth/email-already-in-use' ? 'Email å·²å­˜åœ¨æ–¼ç³»çµ±ï¼Œè«‹ç¢ºèª' : (err.message || 'æ ¸å‡†å¤±æ•—');
                        showToast(msg, true);
                    } finally {
                        showLoading(false);
                    }
                }

                async function handleReject(appId) {
                    try {
                        const reason = prompt('è«‹è¼¸å…¥æ‹’çµ•åŸå› ï¼ˆå¯ç•™ç©ºï¼‰') || '';
                        showLoading(true);
                        const appRef = fsDoc(db, 'accountApplications', appId);
                        await fsUpdateDoc(appRef, {
                            status: 'rejected',
                            reviewerId: auth.currentUser?.uid || '',
                            reviewedAt: fsServerTimestamp(),
                            reviewNotes: reason || '',
                            applyPassword: null
                        });
                        showToast('å·²æ‹’çµ•æ­¤ç”³è«‹');
                    } catch (err) {
                        console.error('reject application error', err);
                        showToast('æ‹’çµ•å¤±æ•—', true);
                    } finally {
                        showLoading(false);
                    }
                }

                // è‡ªå‹•æ¸…ç†ï¼šåŒåé‡è¤‡ç”³è«‹ï¼ˆpendingï¼‰ï¼Œä¿ç•™æœ€æ–°ï¼›è‹¥å·²æœ‰æ ¸å‡†ï¼Œå‰‡è‡ªå‹•åˆªé™¤æ‰€æœ‰åŒåæœªæ ¸å‡†ç”³è«‹
                async function autoCleanupDuplicates() {
                    try {
                        // ç°¡å–®é€€é¿ï¼šè‹¥è¿‘æœŸå˜—è©¦å¤±æ•—ï¼Œæš«ä¸é‡è©¦
                        if (state.lastCleanupRun && (Date.now() - state.lastCleanupRun) < (state.cleanupBackoffMs || 60000)) {
                            return;
                        }
                        const currentCommCode = state.currentCommunity?.code || null;
                        const pending = allApps.filter(a => (a.status || 'pending') === 'pending' && (!currentCommCode || (a.serviceCommunityCode || '') === currentCommCode));
                        const byName = {};
                        pending.forEach(a => {
                            const key = (a.name || '').trim();
                            if (!key) return;
                            (byName[key] ||= []).push(a);
                        });

                        for (const [nameKey, apps] of Object.entries(byName)) {
                            const hasApproved = allApps.some(a => ((a.name || '').trim() === nameKey) && (a.status === 'approved'));
                            let toDelete = [];
                            if (hasApproved) {
                                toDelete = apps; // æœ‰å·²æ ¸å‡†è€…ï¼šåˆªé™¤æ‰€æœ‰åŒåæœªæ ¸å‡†ç”³è«‹
                            } else if (apps.length > 1) {
                                const sorted = apps.slice().sort((a,b) => {
                                    const ta = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : (a.createdAt ? new Date(a.createdAt).getTime() : 0);
                                    const tb = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : (b.createdAt ? new Date(b.createdAt).getTime() : 0);
                                    return tb - ta; // ç”±æ–°åˆ°èˆŠ
                                });
                                toDelete = sorted.slice(1); // ä¿ç•™æœ€æ–°ï¼Œå…¶é¤˜åˆªé™¤
                            }
                            for (const app of toDelete) {
                                try {
                                    await fsDeleteDoc(fsDoc(db, 'accountApplications', app.id));
                                } catch (e) {
                                    const msg = (e && (e.message || e.toString())) || '';
                                    if (/insufficient permissions|permission-denied/i.test(msg)) {
                                        // æ¬Šé™ä¸è¶³ï¼šè¨˜éŒ„é€€é¿æ™‚é–“ï¼Œé¿å…é‡è¤‡å™ªéŸ³
                                        state.lastCleanupRun = Date.now();
                                        state.cleanupBackoffMs = Math.min((state.cleanupBackoffMs || 60000) * 2, 10 * 60 * 1000);
                                        console.warn('è‡ªå‹•åˆªé™¤é‡è¤‡ç”³è«‹å¤±æ•—ï¼ˆæ¬Šé™ä¸è¶³ï¼‰ï¼Œæš«åœé‡è©¦', e);
                                        return; // æå‰çµæŸå¾ªç’°
                                    } else {
                                        console.warn('è‡ªå‹•åˆªé™¤é‡è¤‡ç”³è«‹å¤±æ•—', e);
                                    }
                                }
                            }
                        }
                        // æˆåŠŸåŸ·è¡Œï¼šé‡è¨­é€€é¿
                        state.lastCleanupRun = 0;
                        state.cleanupBackoffMs = 60000;
                    } catch (e) {
                        console.warn('è‡ªå‹•æ¸…ç†é‡è¤‡ç”³è«‹å¤±æ•—', e);
                    }
                }
            }

            function renderSettingsGeneral(container) {
                container.innerHTML = `
                    <div class="p-4">
                        <div class="bg-white p-4 rounded-md shadow-sm border mb-4">
                            <h3 class="font-bold text-lg mb-4">å„€è¡¨æ¿è¨­å®š</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <label for="show-employee-status" class="text-gray-700">é¡¯ç¤ºå“¡å·¥ç‹€æ…‹</label>
                                    <label class="switch">
                                        <input type="checkbox" id="show-employee-status" checked>
                                        <span class="slider round"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-4 rounded-md shadow-sm border mb-4">
                            <h3 class="font-bold text-lg mb-4">ç•°å¸¸æ¨™ç¤ºè¦å‰‡</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <label for="mark-shift-overdue" class="text-gray-700">é€¾æ™‚æœªä¸Šç­ï¼ˆç´…ï¼‰</label>
                                    <label class="switch">
                                        <input type="checkbox" id="mark-shift-overdue" checked>
                                        <span class="slider round"></span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between">
                                    <label for="mark-no-schedule-community" class="text-gray-700">ç¤¾å€å°šæœªæ’ç­ï¼ˆæ©™ï¼‰</label>
                                    <label class="switch">
                                        <input type="checkbox" id="mark-no-schedule-community" checked>
                                        <span class="slider round"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-4 rounded-md shadow-sm border mb-4" id="admin-overtime-section" style="display: none;">
                            <h3 class="font-bold text-lg mb-4">ç®¡ç†å“¡åŠŸèƒ½</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <label class="text-gray-700 font-medium">æª¢æŸ¥è¶…æ™‚ç‹€æ…‹</label>
                                        <p class="text-sm text-gray-500">æª¢æŸ¥æ‰€æœ‰å“¡å·¥æ˜¯å¦æœ‰è¶…éå·¥ä½œæ™‚æ•¸çš„æƒ…æ³</p>
                                    </div>
                                    <div class="flex space-x-2">
                                        <button id="check-overtime-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 flex items-center">
                                            <i data-lucide="clock" class="w-4 h-4 mr-2"></i>æª¢æŸ¥è¶…æ™‚
                                        </button>
                                        <button id="test-overtime-btn" class="bg-orange-600 text-white px-4 py-2 rounded-md hover:bg-orange-700 flex items-center">
                                            <i data-lucide="test-tube" class="w-4 h-4 mr-2"></i>æ¸¬è©¦è¶…æ™‚
                                        </button>
                                    </div>
                                </div>

                                <!-- è£œå»ºä½¿ç”¨è€…æ–‡ä»¶ï¼ˆå–®ç­†/æ‰¹æ¬¡ï¼‰ -->
                                <div class="flex items-center justify-between">
                                    <div>
                                        <label class="text-gray-700 font-medium">è£œå»ºä½¿ç”¨è€…æ–‡ä»¶</label>
                                        <p class="text-sm text-gray-500">å¾ç”³è«‹è³‡æ–™è£œé½Š users æ–‡ä»¶ï¼ˆå–®ç­†æˆ–æ‰¹æ¬¡ï¼‰</p>
                                    </div>
                                    <div class="flex space-x-2 items-center">
                                        <input type="email" id="backfill-email-input" class="border rounded-md px-2 py-1 w-56" placeholder="è¼¸å…¥ Email">
                                        <button id="backfill-by-email-btn" class="bg-green-600 text-white px-3 py-2 rounded-md hover:bg-green-700 flex items-center">
                                            <i data-lucide="user-plus" class="w-4 h-4 mr-2"></i>è£œé½Šå–®ç­†
                                        </button>
                                        <button id="batch-backfill-users-btn" class="bg-purple-600 text-white px-3 py-2 rounded-md hover:bg-purple-700 flex items-center">
                                            <i data-lucide="refresh-ccw" class="w-4 h-4 mr-2"></i>æ‰¹æ¬¡è£œé½Š
                                        </button>
                                    </div>
                                </div>

                                <div id="overtime-results" class="hidden">
                                    <div class="bg-yellow-50 border border-yellow-200 rounded-md p-3">
                                        <h4 class="font-medium text-yellow-800 mb-2">è¶…æ™‚å“¡å·¥åˆ—è¡¨</h4>
                                        <div id="overtime-list" class="space-y-2"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-4 rounded-md shadow-sm border mb-4">
                            <h3 class="font-bold text-lg mb-4">é¡¯ç¤ºæ‰€æœ‰å¸³è™Ÿ</h3>
                            <p class="text-sm text-gray-600 mb-4">å‹¾é¸è¦åœ¨å„€è¡¨æ¿ã€Œæ‰€æœ‰åŒä»ç‹€æ…‹ã€ä¸­é¡¯ç¤ºçš„å¸³è™Ÿ</p>
                            <div id="user-display-settings" class="space-y-2">
                                <div class="flex items-center justify-between p-2 border-b">
                                    <label class="text-gray-700 font-medium">å¸³è™Ÿåç¨±</label>
                                    <label class="text-gray-700 font-medium">é¡¯ç¤º</label>
                                </div>
                                <div class="flex justify-center items-center py-4">
                                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-red-600"></div>
                                    <span class="ml-2 text-gray-600">è¼‰å…¥ä¸­...</span>
                                </div>
                            </div>
                        </div>
                        
                        <button id="save-general-settings" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700 mb-4 flex items-center justify-center">
                            <i data-lucide="save" class="w-4 h-4 mr-2"></i>å„²å­˜è¨­å®š
                        </button>
                    </div>`;
                
                lucide.createIcons();

                // é¡¯ç¤ºç®¡ç†å“¡å€å¡Šï¼ˆç®¡ç†å“¡æˆ–å¯©æ ¸è§’è‰²å¯è¦‹ï¼‰
                if (typeof window.checkReviewerStatus === 'function') {
                    window.checkReviewerStatus().then(isReviewer => {
                        const adminSection = document.getElementById('admin-overtime-section');
                        if (adminSection) adminSection.style.display = isReviewer ? 'block' : 'none';
                    }).catch(() => {});
                }

                // åˆ¥åèˆ‡å·¥å…·
                const dbRef = window.__db;
                const { doc: fsDoc, getDoc: fsGetDoc, setDoc: fsSetDoc, updateDoc: fsUpdateDoc, collection: fsCollection, query: fsQuery, where: fsWhere, getDocs: fsGetDocs, serverTimestamp: fsServerTimestamp } = window.__fs || {};
                const authRef = window.__auth;

                // æ¬Šé™å®‰å…¨çš„æ¬„ä½å€¼
                function normalizeLicense(lic) {
                    const allowed = ['ç„¡','è·æ¥­å®‰å…¨è¡›ç”Ÿæ¥­å‹™ä¸»ç®¡è­‰ç…§','è·æ¥­å®‰å…¨è¡›ç”Ÿç®¡ç†å“¡è­‰ç…§','é˜²ç«é¿é›£è¨­æ–½ç®¡ç†äººå“¡è­‰ç…§','è¨­å‚™å®‰å…¨ç®¡ç†äººå“¡è­‰ç…§','æ•‘ç”Ÿå“¡è­‰ç…§'];
                    return allowed.includes(lic || '') ? lic : 'ç„¡';
                }

                async function resolveCommunitiesByCode(code) {
                    if (!dbRef || !fsCollection || !fsQuery || !fsWhere || !fsGetDocs) return [];
                    if (!code) return [];
                    try {
                        const qs = await fsGetDocs(fsQuery(fsCollection(dbRef, 'communities'), fsWhere('code', '==', code)));
                        const ids = [];
                        qs.forEach(d => ids.push(d.id));
                        return ids;
                    } catch (_) { return []; }
                }

                async function backfillByEmail() {
                    try {
                        const emailInput = document.getElementById('backfill-email-input');
                        const email = (emailInput?.value || '').trim();
                        if (!email) { showToast('è«‹è¼¸å…¥ Email', true); return; }
                        showLoading(true);

                        // å–å¾—ç”³è«‹è³‡æ–™ï¼ˆè‹¥å­˜åœ¨ï¼‰
                        let app = null;
                        if (dbRef && fsCollection && fsQuery && fsWhere && fsGetDocs) {
                            const appsCol = fsCollection(dbRef, 'accountApplications');
                            const qs = await fsGetDocs(fsQuery(appsCol, fsWhere('email', '==', email)));
                            let latest = null;
                            qs.forEach(snap => {
                                const data = snap.data();
                                const item = { id: snap.id, ...data };
                                if (!latest) latest = item; else latest = item; // ä¸æ’åºï¼Œä¿ç•™æœ€å¾Œä¸€ç­†
                            });
                            app = latest;
                        }

                        // æ‰¾ä½¿ç”¨è€… UID
                        let targetUserId = null;
                        if (dbRef && fsCollection && fsQuery && fsWhere && fsGetDocs) {
                            const usersCol = fsCollection(dbRef, 'users');
                            const uq = await fsGetDocs(fsQuery(usersCol, fsWhere('email', '==', email)));
                            if (!uq.empty) {
                                targetUserId = uq.docs[0].id;
                            }
                        }
                        if (!targetUserId && app && app.convertedUserId) targetUserId = app.convertedUserId;
                        if (!targetUserId) {
                            showToast('æ‰¾ä¸åˆ°ä½¿ç”¨è€… UIDï¼Œè«‹å…ˆç”¨æ ¸å‡†æµç¨‹å»ºç«‹ Auth å¸³è™Ÿ', true);
                            return;
                        }

                        // æº–å‚™ users æ–‡ä»¶è³‡æ–™
                        const serviceCommunities = await resolveCommunitiesByCode(app?.serviceCommunityCode || '');
                        const userDoc = {
                            name: app?.name || email,
                            phone: app?.phone || '',
                            email,
                            role: 'user',
                            jobTitle: app?.applicationTitle || '',
                            serviceCommunities,
                            homeAddress: app?.homeAddress || '',
                            birthDate: app?.birthDate || '',
                            idNumber: app?.idNumber || '',
                            license: normalizeLicense(app?.license),
                            serviceCommunityCode: app?.serviceCommunityCode || '',
                            avatarUrl: app?.avatarUrl || null,
                            points: 0,
                            status: 'æœªæ‰“å¡',
                            createdAt: fsServerTimestamp ? fsServerTimestamp() : new Date(),
                        };

                        if (!dbRef || !fsDoc || !fsSetDoc) { showToast('ç’°å¢ƒæœªå°±ç·’ï¼Œè«‹ç¨å¾Œå†è©¦', true); return; }
                        await fsSetDoc(fsDoc(dbRef, 'users', targetUserId), userDoc, { merge: true });

                        // åŒæ­¥ç”³è«‹ç‹€æ…‹èˆ‡å°æ‡‰ UIDï¼ˆè‹¥æœ‰ç”³è«‹ï¼‰
                        if (app && fsUpdateDoc && fsDoc) {
                            const updates = {
                                status: 'approved',
                                convertedUserId: targetUserId,
                                reviewerId: authRef?.currentUser?.uid || '',
                                reviewedAt: fsServerTimestamp ? fsServerTimestamp() : new Date(),
                                reviewNotes: 'è£œé½Šå»ºç«‹'
                            };
                            await fsUpdateDoc(fsDoc(dbRef, 'accountApplications', app.id), updates);
                        }

                        showToast('å·²è£œé½Šä½¿ç”¨è€…æ–‡ä»¶');
                    } catch (err) {
                        console.error('backfillByEmail error', err);
                        showToast('è£œé½Šå¤±æ•—ï¼š' + (err?.message || 'æœªçŸ¥éŒ¯èª¤'), true);
                    } finally { showLoading(false); }
                }

                async function batchBackfillUsers() {
                    try {
                        showLoading(true);
                        if (!dbRef || !fsCollection || !fsQuery || !fsWhere || !fsGetDocs || !fsGetDoc || !fsSetDoc || !fsDoc) {
                            showToast('ç’°å¢ƒæœªå°±ç·’ï¼Œè«‹ç¨å¾Œå†è©¦', true); return;
                        }
                        const appsCol = fsCollection(dbRef, 'accountApplications');
                        const qs = await fsGetDocs(fsQuery(appsCol, fsWhere('status', '==', 'approved')));
                        let done = 0, skipped = 0;
                        for (const docSnap of qs.docs) {
                            const app = { id: docSnap.id, ...docSnap.data() };
                            const uid = app.convertedUserId;
                            if (!uid) { skipped++; continue; }
                            const userRef = fsDoc(dbRef, 'users', uid);
                            const userSnap = await fsGetDoc(userRef);
                            if (userSnap.exists()) { skipped++; continue; }
                            const serviceCommunities = await resolveCommunitiesByCode(app?.serviceCommunityCode || '');
                            const userDoc = {
                                name: app?.name || app?.email || 'æœªå‘½å',
                                phone: app?.phone || '',
                                email: app?.email || '',
                                role: 'user',
                                jobTitle: app?.applicationTitle || '',
                                serviceCommunities,
                                homeAddress: app?.homeAddress || '',
                                birthDate: app?.birthDate || '',
                                idNumber: app?.idNumber || '',
                                license: normalizeLicense(app?.license),
                                serviceCommunityCode: app?.serviceCommunityCode || '',
                                avatarUrl: app?.avatarUrl || null,
                                points: 0,
                                status: 'æœªæ‰“å¡',
                                createdAt: fsServerTimestamp ? fsServerTimestamp() : new Date(),
                            };
                            await fsSetDoc(userRef, userDoc, { merge: true });
                            done++;
                        }
                        if (done > 0) {
                            showToast(`æ‰¹æ¬¡è£œé½Šå®Œæˆï¼š${done} ç­†ï¼Œç•¥é ${skipped} ç­†`);
                        } else {
                            showToast('æ²’æœ‰éœ€è¦è£œé½Šçš„å¸³è™Ÿ');
                        }
                    } catch (err) {
                        console.error('batchBackfillUsers error', err);
                        showToast('æ‰¹æ¬¡è£œé½Šå¤±æ•—ï¼š' + (err?.message || 'æœªçŸ¥éŒ¯èª¤'), true);
                    } finally { showLoading(false); }
                }

                // ç¶å®šæŒ‰éˆ•äº‹ä»¶
                const backfillEmailBtn = document.getElementById('backfill-by-email-btn');
                if (backfillEmailBtn) backfillEmailBtn.addEventListener('click', backfillByEmail);
                const batchBtn = document.getElementById('batch-backfill-users-btn');
                if (batchBtn) batchBtn.addEventListener('click', batchBackfillUsers);
                
                // å¾ Firebase è®€å–è¨­å®š
                const settingsRef = doc(db, "settings", "general");
                getDoc(settingsRef).then((docSnap) => {
                    if (docSnap.exists()) {
                        const settings = docSnap.data();
                        document.getElementById('show-employee-status').checked = settings.showEmployeeStatus !== false;
                        const el1 = document.getElementById('mark-shift-overdue'); if (el1) el1.checked = settings.markShiftOverdueNotStarted !== false;
                        // å·¡é‚ç›¸é—œè¨­å®šå·²ç§»é™¤
                        const el4 = document.getElementById('mark-no-schedule-community'); if (el4) el4.checked = settings.markNoScheduleCommunity !== false;
                        
                        // è¼‰å…¥ä½¿ç”¨è€…é¡¯ç¤ºè¨­å®š
                        loadUserDisplaySettings(settings.visibleUsers || {});
                    } else {
                        // å¦‚æœè¨­å®šä¸å­˜åœ¨ï¼Œè¼‰å…¥é è¨­å€¼ï¼ˆå…¨éƒ¨é¡¯ç¤ºï¼‰
                        loadUserDisplaySettings({});
                    }
                }).catch(error => {
                    console.error("Error getting general settings:", error);
                    showToast("ç„¡æ³•è®€å–è¨­å®š", true);
                    // ç™¼ç”ŸéŒ¯èª¤æ™‚ï¼Œä»ç„¶è¼‰å…¥ä½¿ç”¨è€…åˆ—è¡¨
                    loadUserDisplaySettings({});
                });
                
                // è¼‰å…¥ä½¿ç”¨è€…åˆ—è¡¨ä¸¦è¨­å®šé¡¯ç¤ºç‹€æ…‹
                function loadUserDisplaySettings(visibleUsers) {
                    const userDisplayContainer = document.getElementById('user-display-settings');
                    
                    // ç²å–æ‰€æœ‰ä½¿ç”¨è€…
                    const usersRef = collection(db, "users");
                    getDocs(usersRef).then((querySnapshot) => {
                        // æ¸…é™¤è¼‰å…¥ä¸­çš„æç¤º
                        userDisplayContainer.innerHTML = `
                            <div class="flex items-center justify-between p-2 border-b">
                                <label class="text-gray-700 font-medium">å¸³è™Ÿåç¨±</label>
                                <label class="text-gray-700 font-medium">é¡¯ç¤º</label>
                            </div>
                        `;
                        
                        // æ·»åŠ å…¨é¸/å–æ¶ˆå…¨é¸é¸é …
                        const selectAllDiv = document.createElement('div');
                        selectAllDiv.className = 'flex items-center justify-between p-2 border-b bg-gray-50';
                        selectAllDiv.innerHTML = `
                            <label for="select-all-users" class="text-gray-700 font-medium">å…¨é¸/å–æ¶ˆå…¨é¸</label>
                            <label class="switch">
                                <input type="checkbox" id="select-all-users">
                                <span class="slider round"></span>
                            </label>
                        `;
                        userDisplayContainer.appendChild(selectAllDiv);
                        
                        // ç²å–å…¨é¸/å–æ¶ˆå…¨é¸çš„checkbox
                        const selectAllCheckbox = document.getElementById('select-all-users');
                        
                        // æ·»åŠ ä½¿ç”¨è€…åˆ—è¡¨
                        const userCheckboxes = [];
                        querySnapshot.forEach((doc) => {
                            const userData = doc.data();
                            const userId = doc.id;
                            
                            // é è¨­å€¼ï¼šå¦‚æœvisibleUsersç‚ºç©ºæˆ–è©²ä½¿ç”¨è€…æœªè¨­å®šï¼Œå‰‡é¡¯ç¤º
                            const isVisible = visibleUsers[userId] !== false;
                            
                            const userDiv = document.createElement('div');
                            userDiv.className = 'flex items-center justify-between p-2 border-b';
                            userDiv.innerHTML = `
                                <label for="user-${userId}" class="text-gray-700">${userData.name || userData.email || 'æœªå‘½åä½¿ç”¨è€…'}</label>
                                <label class="switch">
                                    <input type="checkbox" id="user-${userId}" data-user-id="${userId}" class="user-visibility-checkbox" ${isVisible ? 'checked' : ''}>
                                    <span class="slider round"></span>
                                </label>
                            `;
                            userDisplayContainer.appendChild(userDiv);
                            
                            // å°‡checkboxåŠ å…¥é™£åˆ—ï¼Œä»¥ä¾¿å¾ŒçºŒå…¨é¸/å–æ¶ˆå…¨é¸æ“ä½œ
                            const checkbox = userDiv.querySelector(`#user-${userId}`);
                            userCheckboxes.push(checkbox);
                        });
                        
                        // è¨­å®šå…¨é¸/å–æ¶ˆå…¨é¸çš„åŠŸèƒ½
                        selectAllCheckbox.checked = userCheckboxes.every(cb => cb.checked);
                        selectAllCheckbox.addEventListener('change', () => {
                            const isChecked = selectAllCheckbox.checked;
                            userCheckboxes.forEach(cb => {
                                cb.checked = isChecked;
                            });
                        });
                        
                        // ç•¶å€‹åˆ¥checkboxè®Šæ›´æ™‚ï¼Œæ›´æ–°å…¨é¸checkboxçš„ç‹€æ…‹
                        userCheckboxes.forEach(cb => {
                            cb.addEventListener('change', () => {
                                selectAllCheckbox.checked = userCheckboxes.every(cb => cb.checked);
                            });
                        });
                        
                    }).catch(error => {
                        console.error("Error getting users:", error);
                        userDisplayContainer.innerHTML = `
                            <div class="p-4 text-center text-red-600">
                                <p>ç„¡æ³•è¼‰å…¥ä½¿ç”¨è€…åˆ—è¡¨</p>
                                <p class="text-sm">${error.message}</p>
                            </div>
                        `;
                    });
                }
                
                // å„²å­˜è¨­å®š
                document.getElementById('save-general-settings').addEventListener('click', async () => {
                    try {
                        showLoading(true);
                        const showEmployeeStatus = document.getElementById('show-employee-status').checked;
                        
                        
                        // æ”¶é›†ä½¿ç”¨è€…é¡¯ç¤ºè¨­å®š
                        const visibleUsers = {};
                        document.querySelectorAll('.user-visibility-checkbox').forEach(checkbox => {
                            const userId = checkbox.dataset.userId;
                            // åªå„²å­˜æœªå‹¾é¸çš„ä½¿ç”¨è€…ï¼ˆé è¨­ç‚ºé¡¯ç¤ºï¼‰
                            if (!checkbox.checked) {
                                visibleUsers[userId] = false;
                            }
                        });
                        
                        // å„²å­˜åˆ° Firebase
                        await setDoc(doc(db, "settings", "general"), {
                            showEmployeeStatus,
                            markShiftOverdueNotStarted: document.getElementById('mark-shift-overdue')?.checked ?? true,
                            // å·¡é‚ç›¸é—œè¨­å®šå·²ç§»é™¤
                            markNoScheduleCommunity: document.getElementById('mark-no-schedule-community')?.checked ?? true,
                            visibleUsers,
                            updatedAt: serverTimestamp()
                        }, { merge: true });
                        
                        showToast("è¨­å®šå·²å„²å­˜");
                    } catch (error) {
                        console.error("Error saving general settings:", error);
                        showToast("å„²å­˜è¨­å®šå¤±æ•—ï¼š" + error.message, true);
                    } finally {
                        showLoading(false);
                    }
                });
                
                
                
                // å…¨åŸŸå‡½æ•¸å·²å®šç¾©æ–¼æª”æ¡ˆé ‚ç«¯ï¼Œé€™è£¡ä¸å†é‡è¤‡å®£å‘Š
            }
            
            function renderSettingsLocation(container) {
                container.innerHTML = `
                    <div class="p-4">
                        <div class="bg-white p-4 rounded-md shadow-sm border mb-4">
                            <h3 class="font-bold text-lg mb-4">å…¬å¸ä½ç½®è¨­å®š</h3>
                            <div class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="company-lat" class="block text-sm font-medium text-gray-700">ç·¯åº¦</label>
                                        <input type="number" id="company-lat" step="0.000001" class="w-full mt-1 px-3 py-2 border rounded-md">
                                    </div>
                                    <div>
                                        <label for="company-lng" class="block text-sm font-medium text-gray-700">ç¶“åº¦</label>
                                        <input type="number" id="company-lng" step="0.000001" class="w-full mt-1 px-3 py-2 border rounded-md">
                                    </div>
                                </div>
                                <div>
                                    <label for="company-radius" class="block text-sm font-medium text-gray-700">æœ‰æ•ˆæ‰“å¡åŠå¾‘ (å…¬å°º)</label>
                                    <input type="number" id="company-radius" min="10" max="1000" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                                <div class="flex items-center justify-between">
                                    <label for="mark-abnormal-location" class="text-gray-700">æ¨™è¨˜ç•°å¸¸ä½ç½®</label>
                                    <label class="switch">
                                        <input type="checkbox" id="mark-abnormal-location" checked>
                                        <span class="slider round"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white p-4 rounded-md shadow-sm border mb-4">
                            <h3 class="font-bold text-lg mb-4">å…¶ä»–æ‰“å¡ä½ç½®</h3>
                            <div id="other-locations" class="space-y-4">
                                <!-- å…¶ä»–ä½ç½®æœƒå‹•æ…‹æ·»åŠ åœ¨é€™è£¡ -->
                            </div>
                            <button id="add-location-btn" class="w-full mt-4 bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-md hover:bg-gray-300 flex items-center justify-center">
                                <i data-lucide="plus" class="w-4 h-4 mr-2"></i>æ–°å¢ä½ç½®
                            </button>
                        </div>
                        
                        <button id="save-location-settings" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700 mb-4 flex items-center justify-center">
                            <i data-lucide="save" class="w-4 h-4 mr-2"></i>å„²å­˜è¨­å®š
                        </button>
                    </div>`;
                
                lucide.createIcons();
                
                // å¾ Firebase è®€å–è¨­å®š
                const settingsRef = doc(db, "settings", "location");
                getDoc(settingsRef).then((docSnap) => {
                    if (docSnap.exists()) {
                        const settings = docSnap.data();
                        document.getElementById('company-lat').value = settings.companyLat || '';
                        document.getElementById('company-lng').value = settings.companyLng || '';
                        document.getElementById('company-radius').value = settings.companyRadius || 100;
                        document.getElementById('mark-abnormal-location').checked = settings.markAbnormalLocation !== false;
                        
                        // æ¸²æŸ“å…¶ä»–ä½ç½®
                        renderOtherLocations(settings.otherLocations || []);
                    }
                }).catch(error => {
                    console.error("Error getting location settings:", error);
                    showToast("ç„¡æ³•è®€å–ä½ç½®è¨­å®š", true);
                });
                
                // æ¸²æŸ“å…¶ä»–ä½ç½®
                function renderOtherLocations(locations) {
                    const container = document.getElementById('other-locations');
                    container.innerHTML = '';
                    
                    if (locations.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-center">å°šæœªè¨­å®šå…¶ä»–ä½ç½®</p>';
                        return;
                    }
                    
                    locations.forEach((location, index) => {
                        const locationEl = document.createElement('div');
                        locationEl.className = 'bg-gray-50 p-3 rounded-md border';
                        locationEl.innerHTML = `
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-medium">${location.name || `ä½ç½® ${index + 1}`}</h4>
                                <button class="delete-location-btn text-red-500" data-index="${index}">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div>
                                    <label class="block text-xs text-gray-500">åç¨±</label>
                                    <input type="text" class="location-name w-full px-2 py-1 border rounded-md text-sm" value="${location.name || ''}" placeholder="ä½ç½®åç¨±">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500">åŠå¾‘ (å…¬å°º)</label>
                                    <input type="number" class="location-radius w-full px-2 py-1 border rounded-md text-sm" value="${location.radius || 100}" min="10" max="1000">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-xs text-gray-500">ç·¯åº¦</label>
                                    <input type="number" class="location-lat w-full px-2 py-1 border rounded-md text-sm" value="${location.lat || ''}" step="0.000001">
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500">ç¶“åº¦</label>
                                    <input type="number" class="location-lng w-full px-2 py-1 border rounded-md text-sm" value="${location.lng || ''}" step="0.000001">
                                </div>
                            </div>
                        `;
                        container.appendChild(locationEl);
                    });
                    
                    lucide.createIcons();
                    
                    // åˆªé™¤ä½ç½®æŒ‰éˆ•äº‹ä»¶
                    document.querySelectorAll('.delete-location-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.currentTarget.dataset.index);
                            const settingsRef = doc(db, "settings", "location");
                            getDoc(settingsRef).then((docSnap) => {
                                if (docSnap.exists()) {
                                    const settings = docSnap.data();
                                    const otherLocations = settings.otherLocations || [];
                                    otherLocations.splice(index, 1);
                                    renderOtherLocations(otherLocations);
                                }
                            });
                        });
                    });
                }
                
                // æ–°å¢ä½ç½®æŒ‰éˆ•äº‹ä»¶
                document.getElementById('add-location-btn').addEventListener('click', () => {
                    const settingsRef = doc(db, "settings", "location");
                    getDoc(settingsRef).then((docSnap) => {
                        const settings = docSnap.exists() ? docSnap.data() : {};
                        const otherLocations = settings.otherLocations || [];
                        otherLocations.push({
                            name: `ä½ç½® ${otherLocations.length + 1}`,
                            lat: '',
                            lng: '',
                            radius: 100
                        });
                        renderOtherLocations(otherLocations);
                    });
                });
                
                // å„²å­˜è¨­å®š
                document.getElementById('save-location-settings').addEventListener('click', async () => {
                    try {
                        showLoading(true);
                        const companyLat = parseFloat(document.getElementById('company-lat').value);
                        const companyLng = parseFloat(document.getElementById('company-lng').value);
                        const companyRadius = parseInt(document.getElementById('company-radius').value);
                        const markAbnormalLocation = document.getElementById('mark-abnormal-location').checked;
                        
                        // æ”¶é›†å…¶ä»–ä½ç½®è³‡æ–™
                        const otherLocations = [];
                        document.querySelectorAll('#other-locations > div').forEach(el => {
                            const name = el.querySelector('.location-name').value;
                            const lat = parseFloat(el.querySelector('.location-lat').value);
                            const lng = parseFloat(el.querySelector('.location-lng').value);
                            const radius = parseInt(el.querySelector('.location-radius').value);
                            
                            if (name && !isNaN(lat) && !isNaN(lng) && !isNaN(radius)) {
                                otherLocations.push({ name, lat, lng, radius });
                            }
                        });
                        
                        await setDoc(doc(db, "settings", "location"), {
                            companyLat,
                            companyLng,
                            companyRadius,
                            markAbnormalLocation,
                            otherLocations,
                            updatedAt: serverTimestamp()
                        }, { merge: true });
                        
                        showToast("ä½ç½®è¨­å®šå·²å„²å­˜");
                    } catch (error) {
                        console.error("Error saving location settings:", error);
                        showToast("å„²å­˜ä½ç½®è¨­å®šå¤±æ•—", true);
                    } finally {
                        showLoading(false);
                    }
                });
            }
            
            function renderSettingsWorkdays(container) {
                container.innerHTML = `
                    <div class="p-4">
                        <div class="bg-white p-4 rounded-md shadow-sm border mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-bold text-lg">ä¸Šç­è¨­å®šï¼ˆæ¯äººæ¯æœˆï¼‰</h3>
                                <div class="flex items-center space-x-2">
                                    <button id="prev-month" class="bg-gray-200 text-gray-700 px-3 py-1 rounded hover:bg-gray-300">
                                        <i data-lucide="chevrons-left" class="w-4 h-4"></i>
                                    </button>
                                    <span id="workdays-month-label" class="font-semibold"></span>
                                    <button id="next-month" class="bg-gray-200 text-gray-700 px-3 py-1 rounded hover:bg-gray-300">
                                        <i data-lucide="chevrons-right" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 mb-3">ç‚ºç›®å‰ç™»å…¥è€…è¨­å®šæŒ‡å®šæœˆä»½çš„ä¸Šç­æ—¥ã€‚</p>
                            <div id="workdays-grid" class="grid grid-cols-7 gap-2"></div>
                        </div>
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-2">
                                <button id="select-weekdays" class="bg-gray-100 text-gray-700 px-3 py-1 rounded hover:bg-gray-200">é¸å–é€±ä¸€è‡³é€±äº”</button>
                                <button id="clear-selection" class="bg-gray-100 text-gray-700 px-3 py-1 rounded hover:bg-gray-200">æ¸…é™¤é¸å–</button>
                            </div>
                            <button id="save-workdays" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700 flex items-center justify-center">
                                <i data-lucide="save" class="w-4 h-4 mr-2"></i>å„²å­˜æœ¬æœˆä¸Šç­æ—¥
                            </button>
                        </div>
                    </div>`;

                lucide.createIcons();

                const { doc, getDoc, setDoc, serverTimestamp } = window.__fs || {};
                const db = window.__db;
                const user = window.__auth?.currentUser;
                if (!user) {
                    showToast('è«‹å…ˆç™»å…¥', true);
                    return;
                }

                let targetYear, targetMonth; // 0-based month
                const gridEl = document.getElementById('workdays-grid');
                const labelEl = document.getElementById('workdays-month-label');

                function setMonth(date) {
                    targetYear = date.getFullYear();
                    targetMonth = date.getMonth();
                    labelEl.textContent = `${targetYear}å¹´${String(targetMonth + 1).padStart(2,'0')}æœˆ`;
                    renderMonthGrid();
                    loadWorkdays();
                    // è¼‰å…¥æœ¬æœˆé€±äº”å€¼ç­äººå“¡
                    loadFridayDuty?.();
                }

                function daysInMonth(y, m0) {
                    return new Date(y, m0 + 1, 0).getDate();
                }

                function renderMonthGrid(selectedDays = new Set()) {
                    gridEl.innerHTML = '';
                    // Weekday headers
                    const weekdays = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
                    weekdays.forEach(w => {
                        const h = document.createElement('div');
                        h.className = 'text-center text-gray-500 text-sm';
                        h.textContent = w;
                        gridEl.appendChild(h);
                    });
                    // First day offset
                    const firstDay = new Date(targetYear, targetMonth, 1).getDay();
                    for (let i = 0; i < firstDay; i++) {
                        const empty = document.createElement('div');
                        gridEl.appendChild(empty);
                    }
                    const dim = daysInMonth(targetYear, targetMonth);
                    for (let d = 1; d <= dim; d++) {
                        const cell = document.createElement('button');
                        cell.className = 'border rounded p-2 text-center hover:bg-gray-50';
                        cell.dataset.day = String(d);
                        const dow = new Date(targetYear, targetMonth, d).getDay();
                        const isSelected = selectedDays.has(d);
                        cell.innerHTML = `
                            <div class="text-xs text-gray-500">${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][dow]}</div>
                            <div class="text-lg">${d}</div>
                        `;
                        if (isSelected) {
                            cell.classList.add('bg-blue-100','border-blue-400');
                        }
                        cell.addEventListener('click', () => {
                            cell.classList.toggle('bg-blue-100');
                            cell.classList.toggle('border-blue-400');
                        });
                        gridEl.appendChild(cell);
                    }
                }

                async function loadWorkdays() {
                    try {
                        const ymId = `${targetYear}-${String(targetMonth + 1).padStart(2,'0')}`;
                        const ref = doc(db, 'users', user.uid, 'workdays', ymId);
                        const snap = await getDoc(ref);
                        const selected = new Set();
                        if (snap.exists()) {
                            const data = snap.data();
                            (data.days || []).forEach(n => selected.add(Number(n)));
                        }
                        renderMonthGrid(selected);
                    } catch (err) {
                        console.error('è¼‰å…¥ä¸Šç­æ—¥è¨­å®šå¤±æ•—:', err);
                        renderMonthGrid(new Set());
                        showToast('è¼‰å…¥ä¸Šç­æ—¥è¨­å®šå¤±æ•—', true);
                    }
                }

                function getSelectedDays() {
                    const selected = [];
                    gridEl.querySelectorAll('button[data-day]').forEach(btn => {
                        if (btn.classList.contains('bg-blue-100')) {
                            selected.push(Number(btn.dataset.day));
                        }
                    });
                    return selected;
                }

                document.getElementById('prev-month').addEventListener('click', () => {
                    const d = new Date(targetYear, targetMonth - 1, 1);
                    setMonth(d);
                });
                document.getElementById('next-month').addEventListener('click', () => {
                    const d = new Date(targetYear, targetMonth + 1, 1);
                    setMonth(d);
                });
                document.getElementById('select-weekdays').addEventListener('click', () => {
                    // Select Mon-Fri
                    gridEl.querySelectorAll('button[data-day]').forEach(btn => {
                        const day = Number(btn.dataset.day);
                        const dow = new Date(targetYear, targetMonth, day).getDay();
                        if (dow >= 1 && dow <= 5) {
                            btn.classList.add('bg-blue-100','border-blue-400');
                        } else {
                            btn.classList.remove('bg-blue-100','border-blue-400');
                        }
                    });
                });
                document.getElementById('clear-selection').addEventListener('click', () => {
                    gridEl.querySelectorAll('button[data-day]').forEach(btn => {
                        btn.classList.remove('bg-blue-100','border-blue-400');
                    });
                });

                document.getElementById('save-workdays').addEventListener('click', async () => {
                    try {
                        showLoading(true);
                        const days = getSelectedDays();
                        const ymId = `${targetYear}-${String(targetMonth + 1).padStart(2,'0')}`;
                        const ref = doc(db, 'users', user.uid, 'workdays', ymId);
                        await setDoc(ref, { days, updatedAt: serverTimestamp() }, { merge: true });
                        showToast('æœ¬æœˆä¸Šç­æ—¥å·²å„²å­˜');
                    } catch (err) {
                        console.error('å„²å­˜ä¸Šç­æ—¥å¤±æ•—:', err);
                        showToast('å„²å­˜ä¸Šç­æ—¥å¤±æ•—', true);
                    } finally {
                        showLoading(false);
                    }
                });

                // å‹•æ…‹æ’å…¥é€±äº”å€¼ç­åå–®ï¼ˆåˆ†é€±è¨­å®šï¼‰
                try {
                    const root = container.querySelector('.p-4');
                    const dutyHTML = `
                        <div class="bg-white p-4 rounded-md shadow-sm border mb-2">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-bold text-lg">æŒ‡å®šæœˆä»½æ¯é€±äº”å€¼ç­åå–®ï¼ˆåˆ†é€±è¨­å®šï¼‰</h3>
                            </div>
                            <p class="text-sm text-gray-600 mb-3">æ¯é€±å–®ç¨è¨­å®šï¼Œè«‹å¾ä¸‹æ‹‰æ¸…å–®é¸æ“‡å€¼ç­äººå“¡ï¼ˆå¯å¤šé¸ï¼‰ï¼Œä¸è¦æ‰‹å¯«è¼¸å…¥ã€‚</p>
                            <div id="friday-roster-list" class="space-y-2"></div>
                            <div class="flex items-center justify-end mt-2">
                                <button id="save-friday-roster" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 flex items-center justify-center">
                                    <i data-lucide="save" class="w-4 h-4 mr-2"></i>å„²å­˜æŒ‡å®šæœˆä»½å€¼ç­åå–®
                                </button>
                            </div>
                            <div class="text-sm text-gray-500 mt-2">å·²å„²å­˜ï¼š<span id="friday-duty-display"></span></div>
                        </div>`;
                    root?.insertAdjacentHTML('beforeend', dutyHTML);
                    lucide.createIcons();
                } catch(e) { console.warn('æ’å…¥é€±äº”å€¼ç­äººå“¡å€å¡Šå¤±æ•—', e); }

                // ä¾›å€¼ç­åå–®é¸æ“‡ä½¿ç”¨ï¼šæ‰€æœ‰ä½¿ç”¨è€…å§“å
                let allUserNames = [];

                async function loadAllUserNames() {
                    try {
                        if (typeof getDocs !== 'function' || typeof collection !== 'function') {
                            allUserNames = [];
                            return;
                        }
                        const snap = await getDocs(collection(db, 'users'));
                        const namesSet = new Set();
                        snap.forEach(docu => {
                            const data = docu.data();
                            const name = (data.displayName || data.name || data.email || docu.id || '').toString().trim();
                            if (name) namesSet.add(name);
                        });
                        allUserNames = Array.from(namesSet).sort((a, b) => a.localeCompare(b, 'zh-Hant'));
                    } catch (e) {
                        console.warn('è®€å–æ‰€æœ‰å¸³è™Ÿå§“åå¤±æ•—', e);
                        allUserNames = [];
                    }
                }

                // å·¥å…·ï¼šå–å¾—æŸæœˆæ‰€æœ‰é€±äº”æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰
                function getFridaysInMonth(year, month0) {
                    const fridays = [];
                    const last = new Date(year, month0 + 1, 0).getDate();
                    for (let d = 1; d <= last; d++) {
                        const dt = new Date(year, month0, d);
                        if (dt.getDay() === 5) {
                            const y = dt.getFullYear();
                            const m = String(dt.getMonth() + 1).padStart(2, '0');
                            const dd = String(dt.getDate()).padStart(2, '0');
                            fridays.push(`${y}-${m}-${dd}`);
                        }
                    }
                    return fridays;
                }

                // å°‡åå–®æ¸²æŸ“æˆæ¯é€±å¤šé¸ä¸‹æ‹‰åˆ—
                function renderFridayRosterList(rosterMap) {
                    const listEl = document.getElementById('friday-roster-list');
                    if (!listEl) return;
                    const fridays = getFridaysInMonth(targetYear, targetMonth);
                    listEl.innerHTML = '';
                    fridays.forEach((iso) => {
                        const presetArr = (rosterMap[iso] || []);
                        const row = document.createElement('div');
                        row.className = 'space-y-1';
                        const label = document.createElement('label');
                        label.className = 'block text-sm text-gray-700';
                        label.textContent = `${iso}ï¼ˆé€±äº”ï¼‰`;
                        const select = document.createElement('select');
                        select.className = 'w-full border border-gray-300 rounded-md px-3 py-2';
                        select.multiple = true;
                        select.setAttribute('data-iso', iso);
                        // å»ºç«‹é¸é …
                        (allUserNames || []).forEach(name => {
                            const opt = document.createElement('option');
                            opt.value = name;
                            opt.textContent = name;
                            if (presetArr.includes(name)) opt.selected = true;
                            select.appendChild(opt);
                        });
                        row.appendChild(label);
                        row.appendChild(select);
                        listEl.appendChild(row);
                    });
                }

                // é¡¯ç¤ºæ‘˜è¦æ–‡å­—
                function summarizeRosterDisplay(rosterMap) {
                    const fridays = getFridaysInMonth(targetYear, targetMonth);
                    const items = fridays
                        .filter(iso => (rosterMap[iso] || []).length > 0)
                        .map(iso => `${iso}ï¼š${(rosterMap[iso] || []).join('ã€')}`);
                    return items.length ? items.join('ï¼›') : '';
                }

                // é€±äº”å€¼ç­åå–®è¼‰å…¥ï¼ˆå…¨åŸŸè¨­å®š settings/general.fridayDutyRosterï¼‰
                async function loadFridayDuty() {
                    try {
                        const settingsRef = doc(db, 'settings', 'general');
                        const snap = await getDoc(settingsRef);
                        const roster = snap.exists() ? (snap.data().fridayDutyRoster || {}) : {};

                        // è‡ªå‹•å¸¶å…¥åå–®ï¼šè‹¥æœ¬æœˆæœªå¡«ï¼Œå˜—è©¦æ²¿ç”¨ä¸Šå€‹æœˆåŒé€±æ¬¡çš„åå–®
                        const thisFridays = getFridaysInMonth(targetYear, targetMonth);
                        const prevDate = new Date(targetYear, targetMonth - 1, 1);
                        const prevFridays = getFridaysInMonth(prevDate.getFullYear(), prevDate.getMonth());
                        const renderMap = { ...roster };
                        for (let i = 0; i < thisFridays.length; i++) {
                            const iso = thisFridays[i];
                            const prevIso = prevFridays[i];
                            const hasThis = Array.isArray(renderMap[iso]) && renderMap[iso].length > 0;
                            const hasPrev = prevIso && Array.isArray(roster[prevIso]) && roster[prevIso].length > 0;
                            if (!hasThis && hasPrev) {
                                renderMap[iso] = roster[prevIso];
                            }
                        }

                        // å…ˆè¼‰å…¥æ‰€æœ‰ä½¿ç”¨è€…å§“åï¼Œå†æ¸²æŸ“å¤šé¸æ¸…å–®
                        if (!allUserNames || allUserNames.length === 0) {
                            await loadAllUserNames();
                        }
                        renderFridayRosterList(renderMap);
                        const display = document.getElementById('friday-duty-display');
                        if (display) display.textContent = summarizeRosterDisplay(renderMap);
                    } catch (e) {
                        console.warn('è¼‰å…¥é€±äº”å€¼ç­åå–®å¤±æ•—', e);
                    }
                }

                function parseDutyNames(str) {
                    return (str || '')
                        .split(/[,ï¼Œã€\s]+/)
                        .map(s => s.trim())
                        .filter(s => s.length > 0);
                }

                const saveFridayBtn = document.getElementById('save-friday-roster');
                if (saveFridayBtn) {
                    saveFridayBtn.addEventListener('click', async () => {
                        try {
                            showLoading(true);
                            const settingsRef = doc(db, 'settings', 'general');
                            const snap = await getDoc(settingsRef);
                            const current = snap.exists() ? (snap.data().fridayDutyRoster || {}) : {};
                            const fridays = getFridaysInMonth(targetYear, targetMonth);
                            const updated = { ...current };
                            fridays.forEach(iso => {
                                const select = document.querySelector(`#friday-roster-list select[data-iso="${iso}"]`);
                                const names = Array.from(select?.selectedOptions || []).map(o => o.value);
                                updated[iso] = names;
                            });
                            await setDoc(settingsRef, { fridayDutyRoster: updated, updatedAt: serverTimestamp() }, { merge: true });
                            const display = document.getElementById('friday-duty-display');
                            if (display) display.textContent = summarizeRosterDisplay(updated);
                            showToast('æŒ‡å®šæœˆä»½é€±äº”å€¼ç­åå–®å·²å„²å­˜');
                        } catch (err) {
                            console.error('å„²å­˜é€±äº”å€¼ç­åå–®å¤±æ•—:', err);
                            showToast('å„²å­˜é€±äº”å€¼ç­åå–®å¤±æ•—', true);
                        } finally {
                            showLoading(false);
                        }
                    });
                }

                setMonth(new Date());
            }
            
            function renderSettingsRules(container) {
                container.innerHTML = `
                    <div class="p-4">
                        <button id="add-rule-btn" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-700 mb-4 flex items-center justify-center">
                            <i data-lucide="plus-circle" class="w-4 h-4 mr-2"></i>æ–°å¢è¦å‰‡
                        </button>
                        <div id="rule-list" class="space-y-2">è®€å–ä¸­...</div>
                    </div>`;
                lucide.createIcons();
                document.getElementById('add-rule-btn').addEventListener('click', () => openRuleModal());

                const ruleList = document.getElementById('rule-list');
                const rulesRef = collection(db, "pointRules");
                const q = query(rulesRef, orderBy("reason"));
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    ruleList.innerHTML = '';
                    if (querySnapshot.empty) {
                        ruleList.innerHTML = `<p class="text-center text-gray-500 p-4">å°šæœªå»ºç«‹ä»»ä½•è¦å‰‡</p>`;
                        return;
                    }
                    querySnapshot.forEach(doc => {
                        const rule = { id: doc.id, ...doc.data() };
                        const pointsClass = rule.points > 0 ? 'text-green-600' : 'text-red-600';
                        const ruleElement = document.createElement('div');
                        ruleElement.className = 'flex items-center justify-between bg-white p-3 rounded-md shadow-sm border';
                        ruleElement.innerHTML = `
                            <div>
                                <p class="font-medium text-gray-800">${rule.reason}</p>
                                <p class="text-sm text-gray-500">å°è±¡: ${rule.target}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="font-bold text-lg ${pointsClass}">${rule.points > 0 ? '+' : ''}${rule.points}</span>
                                <button data-ruleid="${rule.id}" class="edit-rule-btn p-2 text-gray-500 hover:text-red-600"><i data-lucide="edit" class="w-4 h-4"></i></button>
                                <button data-ruleid="${rule.id}" class="delete-rule-btn p-2 text-gray-500 hover:text-red-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        `;
                        ruleList.appendChild(ruleElement);
                    });
                    lucide.createIcons();

                    document.querySelectorAll('.edit-rule-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                         const ruleId = e.currentTarget.dataset.ruleid;
                         const ruleDoc = await getDoc(doc(db, "pointRules", ruleId));
                         if (ruleDoc.exists()) {
                            openRuleModal({ id: ruleId, ...ruleDoc.data() });
                         }
                    }));

                    document.querySelectorAll('.delete-rule-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                        const ruleId = e.currentTarget.dataset.ruleid;
                        if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¦å‰‡å—ï¼Ÿ')) {
                            await deleteDoc(doc(db, "pointRules", ruleId));
                            showToast("è¦å‰‡åˆªé™¤æˆåŠŸ");
                        }
                    }));

                });
                state.activeListeners.push(unsubscribe);
            }

            // --- Settings: ç¤¾å€åˆ—è¡¨ ---
            function renderSettingsCommunity(container) {
                const canEditCommunity = (state.currentUserData?.role === 'admin');
                container.innerHTML = `
                    <div class="p-4 space-y-4">
                        <div class="bg-white p-3 rounded-md shadow-sm border">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">å€åŸŸ</label>
                                    <select id="filter-community-region" class="w-full px-3 py-2 border rounded-md">
                                        <option value="">å…¨éƒ¨</option>
                                        <option value="å°åŒ—">å°åŒ—</option>
                                        <option value="æ–°åŒ—">æ–°åŒ—</option>
                                        <option value="æ¡ƒåœ’">æ¡ƒåœ’</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">ç·¨è™Ÿ(å‰ç¶´)</label>
                                    <input id="filter-community-code" type="text" class="w-full px-3 py-2 border rounded-md" placeholder="ä¾‹å¦‚ï¼šA" />
                                </div>
                                <div class="flex items-end">
                                    <button id="reset-community-filters" class="w-full px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 flex items-center justify-center">é‡ç½®ç¯©é¸</button>
                                </div>
                                <div class="flex items-end">
                                    <button id="add-community-btn" ${canEditCommunity ? '' : 'disabled'} class="w-full ${canEditCommunity ? 'bg-red-600 text-white hover:bg-red-700' : 'bg-gray-200 text-gray-500 cursor-not-allowed'} font-semibold py-2 px-4 rounded-md flex items-center justify-center">
                                        <i data-lucide="plus-circle" class="w-4 h-4 mr-2"></i>æ–°å¢ç¤¾å€
                                    </button>
                                </div>
                            </div>
                            ${canEditCommunity ? '' : '<div class="mt-3 bg-yellow-50 border border-yellow-200 text-yellow-900 rounded-md px-3 py-2 text-sm">æ‚¨ç›®å‰æ²’æœ‰æ¬Šé™æ–°å¢æˆ–ç·¨è¼¯ç¤¾å€ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡ã€‚</div>'}
                        </div>
                        <div id="community-list" class="space-y-2">è®€å–ä¸­...</div>
                    </div>`;
                lucide.createIcons();
                const listEl = document.getElementById('community-list');
                const addBtn = document.getElementById('add-community-btn');
                if (canEditCommunity) {
                    addBtn.addEventListener('click', () => openCommunityModal());
                } else {
                    addBtn.addEventListener('click', () => showToast('æ‚¨ç›®å‰æ²’æœ‰æ¬Šé™æ–°å¢æˆ–ç·¨è¼¯ç¤¾å€ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡ã€‚', true));
                }
                const regionSelect = document.getElementById('filter-community-region');
                const codeInput = document.getElementById('filter-community-code');
                const resetFilterBtn = document.getElementById('reset-community-filters');

                const communitiesRef = collection(db, 'communities');
                const q = query(communitiesRef, orderBy('name'));
                let allCommunities = [];

                const unsubscribe = onSnapshot(q, (snap) => {
                    allCommunities = [];
                    snap.forEach(docSnap => { allCommunities.push({ id: docSnap.id, ...docSnap.data() }); });
                    renderCommunityList();
                });

                function renderCommunityList() {
                    listEl.innerHTML = '';
                    if (!allCommunities.length) {
                        listEl.innerHTML = `<p class="text-center text-gray-500 p-4">å°šæœªå»ºç«‹ä»»ä½•ç¤¾å€</p>`;
                        return;
                    }
                    const region = regionSelect.value || '';
                    const codePrefix = (codeInput.value || '').trim();
                    let filtered = allCommunities.filter(c => {
                        const rOk = region ? (c.region === region) : true;
                        const codeVal = (c.code || '').toString();
                        const cOk = codePrefix ? codeVal.toUpperCase().startsWith(codePrefix.toUpperCase()) : true;
                        return rOk && cOk;
                    });
                    // é è¨­ä¾ç¤¾å€ç·¨è™Ÿæ’åºï¼ˆA101, A102, ... B209ï¼‰
                    filtered = filtered.slice().sort((a,b) => compareCommunitiesByCode(a, b));

                    filtered.forEach(c => {
                        const lat = c.location?.latitude ?? '';
                        const lng = c.location?.longitude ?? '';
                        const region = c.region || '';
                        const code = c.code || '';
                        const row = document.createElement('div');
                        row.className = 'flex items-center justify-between bg-white p-3 rounded-md shadow-sm border';
                        row.innerHTML = `
                            <div>
                                <p class="font-medium text-gray-800">
                                    ${region ? `<span class=\"inline-block text-xs px-2 py-0.5 rounded bg-gray-100 text-gray-700 mr-2\">${region}</span>` : ''}
                                    ${code ? `<span class=\"inline-block text-xs px-2 py-0.5 rounded bg-blue-100 text-blue-700 mr-2\">${code}</span>` : ''}
                                    ${c.name || '(æœªå‘½å)'}
                                </p>
                                <p class="text-sm text-gray-500">${c.address || ''}</p>
                                <p class="text-xs text-gray-400">${lat && lng ? `(${lat.toFixed ? lat.toFixed(6) : lat}, ${lng.toFixed ? lng.toFixed(6) : lng})` : 'æœªè¨­å®šåº§æ¨™'}</p>
                                <p class="text-xs text-gray-500">æœ‰æ•ˆæ‰“å¡ç¯„åœï¼š${(typeof c.radius === 'number' && c.radius >= 0) ? `${c.radius} å…¬å°º` : 'æœªè¨­å®š'}</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button class="view-map-btn px-2 py-1 text-gray-600 hover:text-red-600" data-lat="${lat}" data-lng="${lng}"><i data-lucide="map-pin" class="w-4 h-4"></i></button>
                                ${canEditCommunity ? `<button class=\"edit-community-btn px-2 py-1 text-gray-600 hover:text-red-600\" data-id=\"${c.id}\"><i data-lucide=\"edit\" class=\"w-4 h-4\"></i></button>` : ''}
                                ${canEditCommunity ? `<button class=\"delete-community-btn px-2 py-1 text-gray-600 hover:text-red-600\" data-id=\"${c.id}\"><i data-lucide=\"trash-2\" class=\"w-4 h-4\"></i></button>` : ''}
                            </div>`;
                        listEl.appendChild(row);
                    });

                    lucide.createIcons();

                    listEl.querySelectorAll('.view-map-btn').forEach(btn => btn.addEventListener('click', (e) => {
                        const latStr = e.currentTarget.dataset.lat;
                        const lngStr = e.currentTarget.dataset.lng;
                        const lat = parseFloat(latStr);
                        const lng = parseFloat(lngStr);
                        if (!Number.isFinite(lat) || !Number.isFinite(lng)) {
                            showToast('æ­¤ç¤¾å€å°šæœªè¨­å®šåº§æ¨™', true);
                            return;
                        }
                        openMapModal(lat, lng);
                    }));

                    if (canEditCommunity) {
                        listEl.querySelectorAll('.edit-community-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                            const id = e.currentTarget.dataset.id;
                            try {
                                const d = await getDoc(doc(db, 'communities', id));
                                if (d.exists()) openCommunityModal({ id, ...d.data() });
                            } catch (err) {
                                console.error('è®€å–ç¤¾å€è³‡æ–™å¤±æ•—', err);
                                showToast('è®€å–ç¤¾å€è³‡æ–™å¤±æ•—', true);
                            }
                        }));

                        listEl.querySelectorAll('.delete-community-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                            const id = e.currentTarget.dataset.id;
                            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç¤¾å€å—ï¼Ÿ')) return;
                            try {
                                await deleteDoc(doc(db, 'communities', id));
                                showToast('ç¤¾å€å·²åˆªé™¤');
                            } catch (err) {
                                console.error('åˆªé™¤ç¤¾å€å¤±æ•—', err);
                                showToast('åˆªé™¤ç¤¾å€å¤±æ•—', true);
                            }
                        }));
                    }
                }

                regionSelect.addEventListener('change', renderCommunityList);
                codeInput.addEventListener('input', renderCommunityList);
                resetFilterBtn.addEventListener('click', () => {
                    regionSelect.value = '';
                    codeInput.value = '';
                    renderCommunityList();
                });
                state.activeListeners.push(unsubscribe);
            }

            function openCommunityModal(community = null) {
                const role = state.currentUserData?.role || '';
                if (role !== 'admin') {
                    showToast('æ‚¨ç›®å‰æ²’æœ‰æ¬Šé™æ–°å¢æˆ–ç·¨è¼¯ç¤¾å€ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡ã€‚', true);
                    return;
                }
                const modalId = `community-modal-${Date.now()}`;
                const isEditing = !!community;
                const title = isEditing ? 'ç·¨è¼¯ç¤¾å€' : 'æ–°å¢ç¤¾å€';
                const initLat = community?.location?.latitude ?? null;
                const initLng = community?.location?.longitude ?? null;
                const nameVal = community?.name || '';
                const addrVal = community?.address || '';
                const regionVal = community?.region || '';
                const codeVal = community?.code || '';
                const shortNameVal = community?.shortName || '';
                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[90%] max-w-md bg-white rounded-lg shadow-xl flex flex-col" style="max-height: 90vh;">
                            <div class="flex justify-between items-center p-4 border-b flex-shrink-0">
                                <h3 class="font-bold text-lg">${title}</h3>
                                <button class="close-btn text-gray-500 hover:text-gray-700"><i data-lucide="x" class="w-5 h-5"></i></button>
                            </div>
                            <form id="community-form" class="p-4 space-y-4 overflow-y-auto">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">ç¤¾å€åç¨± (å¿…å¡«)</label>
                                    <input id="community-name" type="text" value="${nameVal}" class="w-full mt-1 px-3 py-2 border rounded-md" required />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">åœ°å€</label>
                                    <input id="community-address" type="text" value="${addrVal}" class="w-full mt-1 px-3 py-2 border rounded-md" />
                                    <p class="text-xs text-gray-500 mt-1">è¼¸å…¥åœ°å€å¾Œè‡ªå‹•å¸¶å‡ºGPSåº§æ¨™èˆ‡å€åŸŸ</p>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">å€åŸŸ (å¿…é¸)</label>
                                        <select id="community-region" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                            <option value="" ${!regionVal ? 'selected' : ''}>è«‹é¸æ“‡</option>
                                            <option value="å°åŒ—" ${regionVal === 'å°åŒ—' ? 'selected' : ''}>å°åŒ—</option>
                                            <option value="æ–°åŒ—" ${regionVal === 'æ–°åŒ—' ? 'selected' : ''}>æ–°åŒ—</option>
                                            <option value="æ¡ƒåœ’" ${regionVal === 'æ¡ƒåœ’' ? 'selected' : ''}>æ¡ƒåœ’</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">ç¤¾å€ç·¨è™Ÿ (ä¸å¯é‡è¤‡)</label>
                                        <input id="community-code" type="text" value="${codeVal}" class="w-full mt-1 px-3 py-2 border rounded-md" placeholder="ä¾‹å¦‚ï¼šA001" required />
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">ç¤¾å€ç°¡ç¨±ï¼ˆå¯å¤šè¡Œï¼‰</label>
                                    <textarea id="community-short" rows="3" class="w-full mt-1 px-3 py-2 border rounded-md" placeholder="å¯è¼¸å…¥å¤šè¡Œï¼Œé¡¯ç¤ºæ–¼ã€ä¾ç¤¾å€ã€æŒ‰éˆ•ä¸­ç½®ä¸­é¡¯ç¤º">${shortNameVal}</textarea>
                                    <p class="text-xs text-gray-500 mt-1">æ¯ä¸€è¡Œæœƒå°æ‡‰æŒ‰éˆ•ä¸­çš„ä¸€åˆ—ï¼ˆæœ€å¤šé¡¯ç¤ºå‰å…©è¡Œï¼‰ã€‚</p>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">ç·¯åº¦</label>
                                        <input id="community-lat" type="number" step="0.000001" value="${initLat ?? ''}" class="w-full mt-1 px-3 py-2 border rounded-md" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">ç¶“åº¦</label>
                                        <input id="community-lng" type="number" step="0.000001" value="${initLng ?? ''}" class="w-full mt-1 px-3 py-2 border rounded-md" />
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">æœ‰æ•ˆæ‰“å¡ç¯„åœåŠå¾‘ (å…¬å°º)</label>
                                    <input id="community-radius" type="number" min="0" step="1" value="${typeof community?.radius === 'number' ? community.radius : ''}" class="w-full mt-1 px-3 py-2 border rounded-md" placeholder="ä¾‹å¦‚ï¼š100" />
                                    <p class="text-xs text-gray-500 mt-1">æ‰“å¡é»è·ç¤¾å€åº§æ¨™çš„æœ€å¤§è·é›¢ï¼Œè¶…éå‰‡æ¨™ç¤ºç‚ºæ‰“å¡ä½ç½®ç•°å¸¸ã€‚</p>
                                </div>
                                <div>
                                    <button type="button" id="pick-location-btn" class="px-3 py-1 bg-gray-200 rounded-md text-sm">é¸æ“‡åº§æ¨™</button>
                                </div>
                                <p id="community-form-error" class="text-red-500 text-sm text-center"></p>
                                <div class="flex justify-end space-x-2 pt-2">
                                    <button type="button" class="cancel-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">å–æ¶ˆ</button>
                                    <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">å„²å­˜</button>
                                </div>
                            </form>
                        </div>
                    </div>`;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                lucide.createIcons();
                const modal = document.getElementById(modalId);
                const close = () => modal?.remove();
                modal.querySelector('.close-btn').addEventListener('click', close);
                modal.querySelector('.cancel-btn').addEventListener('click', close);

                const nameInput = document.getElementById('community-name');
                const addrInput = document.getElementById('community-address');
                const regionInput = document.getElementById('community-region');
                const codeInput = document.getElementById('community-code');
                const shortNameInput = document.getElementById('community-short');
                const latInput = document.getElementById('community-lat');
                const lngInput = document.getElementById('community-lng');
                const errorEl = document.getElementById('community-form-error');
                document.getElementById('pick-location-btn').addEventListener('click', () => {
                    const lat = parseFloat(latInput.value);
                    const lng = parseFloat(lngInput.value);
                    const hasInit = Number.isFinite(lat) && Number.isFinite(lng);
                    openSelectLocationModal(hasInit ? lat : null, hasInit ? lng : null, (selLat, selLng) => {
                        // æ­£è¦åŒ–ç‚º 6 ä½å°æ•¸ï¼Œé¿å… step é©—è­‰å¤±æ•—
                        latInput.value = Number(selLat).toFixed(6);
                        lngInput.value = Number(selLng).toFixed(6);
                    });
                });

                // åœ°å€è‡ªå‹•åœ°ç†ç·¨ç¢¼èˆ‡å€åŸŸåˆ¤æ–·
                const debounceMs = 600;
                let geoTimer = null;
                const guessRegionFromText = (text) => {
                    if (!text) return '';
                    const t = ('' + text).toLowerCase();
                    if (/å°åŒ—|è‡ºåŒ—|taipei/.test(t)) return 'å°åŒ—';
                    if (/æ–°åŒ—|new taipei/.test(t)) return 'æ–°åŒ—';
                    if (/æ¡ƒåœ’|taoyuan/.test(t)) return 'æ¡ƒåœ’';
                    return '';
                };
                const guessRegionFromComponents = (components = []) => {
                    for (const c of components) {
                        const name = `${c.long_name || ''} ${c.short_name || ''}`;
                        const r = guessRegionFromText(name);
                        if (r) return r;
                    }
                    return '';
                };
                const geocodeAddressAndFill = async (addr) => {
                    const address = (addr || '').trim();
                    if (!address) return;
                    try {
                        const apiKey = typeof GOOGLE_MAPS_API_KEY !== 'undefined' ? GOOGLE_MAPS_API_KEY : null;
                        if (!apiKey) {
                            console.warn('GOOGLE_MAPS_API_KEY æœªè¨­å®šï¼Œè·³éåœ°ç†ç·¨ç¢¼');
                            return;
                        }
                        const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address)}&region=tw&language=zh-TW&key=${apiKey}`;
                        const res = await fetch(url);
                        const data = await res.json();
                        if (data.status === 'OK' && Array.isArray(data.results) && data.results.length > 0) {
                            const r = data.results[0];
                            const loc = r.geometry && r.geometry.location ? r.geometry.location : null;
                            if (loc && Number.isFinite(loc.lat) && Number.isFinite(loc.lng)) {
                                // æ­£è¦åŒ–ç‚º 6 ä½å°æ•¸ä»¥ç¬¦åˆ input çš„ step=0.000001
                                latInput.value = Number(loc.lat).toFixed(6);
                                lngInput.value = Number(loc.lng).toFixed(6);
                            }
                            // å˜—è©¦å¾ components æˆ–å­—ä¸²æ¨æ–·å€åŸŸ
                            let regionCandidate = guessRegionFromComponents(r.address_components || []);
                            if (!regionCandidate) regionCandidate = guessRegionFromText(r.formatted_address || '');
                            if (!regionCandidate) regionCandidate = guessRegionFromText(address);
                            if (regionCandidate) {
                                regionInput.value = regionCandidate;
                            }
                        } else {
                            console.warn('Geocode å¤±æ•—:', data.status, data.error_message || '');
                            // è‹¥å¤±æ•—ï¼Œä¸é˜»å¡æµç¨‹ï¼›æç¤ºè¨Šæ¯ç•™åœ¨è¡¨å–®æäº¤éšæ®µ
                        }
                    } catch (e) {
                        console.error('Geocode ç™¼ç”ŸéŒ¯èª¤:', e);
                    }
                };
                const triggerGeocodeDebounced = () => {
                    if (geoTimer) clearTimeout(geoTimer);
                    geoTimer = setTimeout(() => geocodeAddressAndFill(addrInput.value), debounceMs);
                };
                addrInput.addEventListener('input', () => {
                    errorEl.textContent = '';
                    triggerGeocodeDebounced();
                });
                addrInput.addEventListener('blur', () => {
                    errorEl.textContent = '';
                    const v = addrInput.value.trim();
                    if (v) geocodeAddressAndFill(v);
                });
                // å¤±ç„¦æ™‚æ­£è¦åŒ–åº§æ¨™ç‚º 6 ä½å°æ•¸ï¼Œé¿å…ç€è¦½å™¨é¡¯ç¤ºç„¡æ•ˆå€¼
                latInput.addEventListener('blur', () => {
                    const v = parseFloat(latInput.value);
                    if (Number.isFinite(v)) latInput.value = v.toFixed(6);
                });
                lngInput.addEventListener('blur', () => {
                    const v = parseFloat(lngInput.value);
                    if (Number.isFinite(v)) lngInput.value = v.toFixed(6);
                });
                // è‹¥å·²æœ‰åœ°å€ä½†åº§æ¨™æˆ–å€åŸŸç¼ºå¤±ï¼Œåˆå§‹åŒ–æ™‚å˜—è©¦è§£æ
                if ((addrVal && (!Number.isFinite(initLat) || !Number.isFinite(initLng) || !regionVal))) {
                    setTimeout(() => geocodeAddressAndFill(addrVal), 0);
                }

                document.getElementById('community-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    showLoading(true);
                    errorEl.textContent = '';
                    try {
                        const name = nameInput.value.trim();
                        const address = addrInput.value.trim();
                        const region = regionInput.value.trim();
                        const code = codeInput.value.trim();
                        const shortName = shortNameInput.value.trim();
                        const lat = parseFloat(latInput.value);
                        const lng = parseFloat(lngInput.value);
                        const radiusInput = document.getElementById('community-radius');
                        const radiusVal = radiusInput ? parseFloat(radiusInput.value) : null;
                        if (!name) throw new Error('è«‹è¼¸å…¥ç¤¾å€åç¨±');
                        if (!region) throw new Error('è«‹é¸æ“‡å€åŸŸ');
                        if (!code) throw new Error('è«‹è¼¸å…¥ç¤¾å€ç·¨è™Ÿ');
                        if (!Number.isFinite(lat) || !Number.isFinite(lng)) throw new Error('è«‹è¨­å®šæœ‰æ•ˆåº§æ¨™');
                        // æª¢æŸ¥ç¤¾å€ç·¨è™Ÿå”¯ä¸€æ€§
                        try {
                            const fs = window.__fs || {};
                            const db = window.__db;
                            const { collection, query, where, getDocs } = fs;
                            if (!collection || !query || !where || !getDocs || !db) {
                                console.warn('Firestore å‡½å¼ä¸å¯ç”¨ï¼Œè·³éç·¨è™Ÿå”¯ä¸€æ€§æª¢æŸ¥');
                            } else {
                                const q = query(collection(db, 'communities'), where('code', '==', code));
                                const snap = await getDocs(q);
                                let duplicated = false;
                                snap.forEach(d => {
                                    const sameId = community?.id && d.id === community.id;
                                    if (!sameId) duplicated = true;
                                });
                                if (duplicated) throw new Error('ç¤¾å€ç·¨è™Ÿå·²å­˜åœ¨ï¼Œè«‹ä½¿ç”¨å…¶ä»–ç·¨è™Ÿ');
                            }
                        } catch (checkErr) {
                            if (checkErr && checkErr.message) throw checkErr;
                        }
                        const payload = {
                            name,
                            address,
                            region,
                            code,
                            shortName: shortName || null,
                            location: new GeoPoint(lat, lng),
                            radius: (Number.isFinite(radiusVal) && radiusVal >= 0) ? Math.floor(radiusVal) : 0,
                            updatedAt: serverTimestamp()
                        };
                        if (isEditing) {
                            await updateDoc(doc(db, 'communities', community.id), payload);
                            showToast('ç¤¾å€å·²æ›´æ–°');
                        } else {
                            payload.createdAt = serverTimestamp();
                            await addDoc(collection(db, 'communities'), payload);
                            showToast('ç¤¾å€å·²æ–°å¢');
                        }
                        close();
                    } catch (err) {
                        console.error('å„²å­˜ç¤¾å€å¤±æ•—', err);
                        if (err && (err.code === 'permission-denied' || /insufficient permissions/i.test(err.message || ''))) {
                            errorEl.textContent = 'æ‚¨ç›®å‰æ²’æœ‰æ¬Šé™æ–°å¢æˆ–ç·¨è¼¯ç¤¾å€ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡ã€‚';
                        } else {
                            errorEl.textContent = err.message || 'å„²å­˜å¤±æ•—';
                        }
                    } finally {
                        showLoading(false);
                    }
                });
            }

            // é€šç”¨ï¼šäº’å‹•å¼é¸é»åœ°åœ–
            function openSelectLocationModal(initialLat = null, initialLng = null, onSelect = () => {}) {
                const modalId = `select-location-modal-${Date.now()}`;
                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[90%] max-w-[520px] bg-white rounded-lg shadow-xl flex flex-col">
                            <div class="flex justify-between items-center p-4 border-b">
                                <h3 class="font-bold text-lg">é¸æ“‡åº§æ¨™</h3>
                                <button class="close-btn text-gray-500 hover:text-gray-700"><i data-lucide="x" class="w-5 h-5"></i></button>
                            </div>
                            <div id="select-map" class="h-[320px] w-full"></div>
                            <div class="flex items-center justify-between p-4 border-t">
                                <div class="text-sm text-gray-600"><span id="sel-lat">--</span>, <span id="sel-lng">--</span></div>
                                <div class="flex gap-2">
                                    <button class="cancel-btn px-3 py-1 rounded bg-gray-200">å–æ¶ˆ</button>
                                    <button class="ok-btn px-3 py-1 rounded bg-blue-600 text-white">ç¢ºå®š</button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                lucide.createIcons();
                const modalEl = document.getElementById(modalId);
                const close = () => modalEl?.remove();
                modalEl.querySelector('.close-btn')?.addEventListener('click', close);
                modalEl.querySelector('.cancel-btn')?.addEventListener('click', close);
                const latEl = modalEl.querySelector('#sel-lat');
                const lngEl = modalEl.querySelector('#sel-lng');

                let selectedLat = initialLat;
                let selectedLng = initialLng;
                const updateDisplay = () => {
                    latEl.textContent = Number.isFinite(selectedLat) ? selectedLat.toFixed(6) : '--';
                    lngEl.textContent = Number.isFinite(selectedLng) ? selectedLng.toFixed(6) : '--';
                };
                updateDisplay();

                if (!(window.google && window.google.maps)) {
                    document.getElementById('select-map').innerHTML = '<div class="p-4 text-center text-red-500">Google Maps å°šæœªè¼‰å…¥</div>';
                } else {
                    const center = Number.isFinite(initialLat) && Number.isFinite(initialLng)
                        ? { lat: initialLat, lng: initialLng }
                        : { lat: 25.0330, lng: 121.5654 };
                    const map = new google.maps.Map(document.getElementById('select-map'), { center, zoom: 16 });
                    let marker = null;
                    if (Number.isFinite(initialLat) && Number.isFinite(initialLng)) {
                        marker = new google.maps.Marker({ position: center, map });
                    }
                    map.addListener('click', (e) => {
                        const pos = e.latLng;
                        selectedLat = pos.lat();
                        selectedLng = pos.lng();
                        if (!marker) {
                            marker = new google.maps.Marker({ position: pos, map });
                        } else {
                            marker.setPosition(pos);
                        }
                        updateDisplay();
                    });
                }

                modalEl.querySelector('.ok-btn')?.addEventListener('click', () => {
                    if (!Number.isFinite(selectedLat) || !Number.isFinite(selectedLng)) {
                        showToast('è«‹åœ¨åœ°åœ–ä¸Šé»é¸ä½ç½®', true);
                        return;
                    }
                    try { onSelect(selectedLat, selectedLng); } catch (_) {}
                    close();
                });
            }

            // --- Modals ---
            function openMapModal(lat, lng) {
                const modalId = `map-modal-${Date.now()}`;
                
                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[90%] max-w-[500px] bg-white rounded-lg shadow-xl flex flex-col">
                            <div class="flex justify-between items-center p-4 border-b">
                                <h3 class="font-bold text-lg">ä½ç½®è³‡è¨Š</h3>
                                <button class="close-btn text-gray-500 hover:text-gray-700">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <div id="modal-map" class="h-[300px] w-full"></div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                lucide.createIcons();
                
                const modal = document.getElementById(modalId);
                modal.querySelector('.close-btn').addEventListener('click', () => {
                    modal.remove();
                });
                
                // Chrome requires secure context (https:// or localhost) for geolocation; inform user if not secure
                if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                    console.warn('éå®‰å…¨ä¾†æºï¼Œå¯èƒ½å°è‡´å®šä½æˆ–åœ°åœ–ç„¡æ³•ä½¿ç”¨');
                    showToast('æç¤ºï¼šè«‹ä»¥ https æˆ– localhost é–‹å•Ÿä»¥ä½¿ç”¨åœ°åœ–å®šä½', true);
                }
                if (window.google && window.google.maps) {
                    const mapDiv = document.getElementById('modal-map');
                    const map = new google.maps.Map(mapDiv, {
                        center: { lat, lng },
                        zoom: 17
                    });
                    
                    new google.maps.Marker({
                        position: { lat, lng },
                        map: map
                    });
                } else {
                    document.getElementById('modal-map').innerHTML = 
                        '<div class="p-4 text-center text-red-500">Google Maps å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å¾Œå†è©¦</div>';
                }
            }
            
            function openPhotoModal(photos, descriptions) {
                const modalId = `photo-modal-${Date.now()}`;
                
                let contentHTML;
                if (photos && photos.length > 0) {
                    contentHTML = photos.map((url, index) => `
                        <div class="photo-slide">
                            <img src="${url}" class="max-h-[400px] max-w-full object-contain mx-auto" onerror="this.src='https://via.placeholder.com/400x300?text=ç…§ç‰‡è¼‰å…¥å¤±æ•—'">
                            <p class="text-center mt-2 text-gray-600">${descriptions[index] || ''}</p>
                        </div>
                    `).join('');
                } else {
                    contentHTML = '<div class="p-4 text-center text-gray-500">ç„¡ç…§ç‰‡</div>';
                }
                
                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[90%] max-w-[500px] bg-white rounded-lg shadow-xl flex flex-col">
                            <div class="flex justify-between items-center p-4 border-b">
                                <h3 class="font-bold text-lg">ç…§ç‰‡ç€è¦½</h3>
                                <div class="flex items-center gap-2">
                                    <button class="close-btn text-gray-500 hover:text-gray-700">
                                        <i data-lucide="x" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="p-4 photo-container">
                                ${contentHTML}
                            </div>
                            ${(photos?.length || 0) > 1 ? `
                            <div class="flex justify-center p-2 gap-2">
                                <button class="prev-btn bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded">ä¸Šä¸€å¼µ</button>
                                <button class="next-btn bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded">ä¸‹ä¸€å¼µ</button>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                lucide.createIcons();
                
                const modal = document.getElementById(modalId);
                modal.querySelector('.close-btn').addEventListener('click', () => {
                    modal.remove();
                });
                // ä¸‹è¼‰åŠŸèƒ½å·²ç§»é™¤
                
                if ((photos?.length || 0) > 1) {
                    const slides = modal.querySelectorAll('.photo-slide');
                    let currentSlide = 0;
                    
                    slides.forEach((slide, index) => {
                        slide.style.display = index === 0 ? 'block' : 'none';
                    });
                    
                    modal.querySelector('.prev-btn').addEventListener('click', () => {
                        slides[currentSlide].style.display = 'none';
                        currentSlide = (currentSlide - 1 + slides.length) % slides.length;
                        slides[currentSlide].style.display = 'block';
                    });
                    
                    modal.querySelector('.next-btn').addEventListener('click', () => {
                        slides[currentSlide].style.display = 'none';
                        currentSlide = (currentSlide + 1) % slides.length;
                        slides[currentSlide].style.display = 'block';
                    });
                }
            }

            // æ–°å¢ï¼šç·¨è¼¯å‡ºå‹¤ç´€éŒ„å½ˆçª—
            function openEditRecordModal(record) {
                const modalId = `edit-record-modal-${Date.now()}`;
                const toDatetimeLocal = (iso) => {
                    try {
                        const d = iso ? new Date(iso) : new Date();
                        const pad = (n) => String(n).padStart(2, '0');
                        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
                    } catch {
                        return '';
                    }
                };
                const typeOptions = ['ä¸Šç­','ä¸‹ç­','å¤–å‡º','è¿”å›','æŠµé”','é›¢é–‹','è‡ªå‹•ä¸‹ç­'];
                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[90%] max-w-[520px] bg-white rounded-lg shadow-xl">
                            <div class="flex justify-between items-center p-4 border-b">
                                <h3 class="font-bold text-lg">ç·¨è¼¯å‡ºå‹¤ç´€éŒ„</h3>
                                <button class="close-btn text-gray-500 hover:text-gray-700"><i data-lucide="x" class="w-5 h-5"></i></button>
                            </div>
                            <div class="p-4 space-y-3">
                                <div>
                                    <label class="text-sm">ç‹€æ…‹</label>
                                    <select id="edit-type" class="border rounded px-2 py-1 w-full">
                                        ${typeOptions.map(t => `<option value="${t}" ${t===record.type? 'selected':''}>${t}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="text-sm">æ™‚é–“</label>
                                    <input id="edit-time" type="datetime-local" value="${toDatetimeLocal(record.timeISO)}" class="border rounded px-2 py-1 w-full" />
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="text-sm">ç·¯åº¦</label>
                                        <input id="edit-lat" type="number" step="0.000001" value="${record.lat ?? ''}" class="border rounded px-2 py-1 w-full" />
                                    </div>
                                    <div>
                                        <label class="text-sm">ç¶“åº¦</label>
                                        <input id="edit-lng" type="number" step="0.000001" value="${record.lng ?? ''}" class="border rounded px-2 py-1 w-full" />
                                    </div>
                                </div>
                                <div>
                                    <label class="text-sm">åœ°é»åç¨±</label>
                                    <input id="edit-location-name" type="text" value="${record.locationName || ''}" class="border rounded px-2 py-1 w-full" />
                                </div>
                                <div>
                                    <label class="text-sm">å‹¤å‹™é¡å‹</label>
                                    <input id="edit-duty-type" type="text" value="${record.dutyType || ''}" class="border rounded px-2 py-1 w-full" />
                                </div>
                            </div>
                            <div class="flex justify-end gap-2 p-4 border-t">
                                <button class="cancel-btn px-3 py-1 rounded bg-gray-200">å–æ¶ˆ</button>
                                <button class="save-btn px-3 py-1 rounded bg-blue-600 text-white">å„²å­˜</button>
                            </div>
                        </div>
                    </div>`;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                lucide.createIcons();
                const modalEl = document.getElementById(modalId);
                const close = () => { modalEl?.remove(); };
                modalEl.querySelector('.close-btn')?.addEventListener('click', close);
                modalEl.querySelector('.cancel-btn')?.addEventListener('click', close);
                modalEl.querySelector('.save-btn')?.addEventListener('click', async () => {
                    try {
                        const db = window.__db; const { updateDoc, doc, GeoPoint, Timestamp } = window.__fs;
                        const type = document.getElementById('edit-type').value;
                        const timeStr = document.getElementById('edit-time').value;
                        const latStr = document.getElementById('edit-lat').value;
                        const lngStr = document.getElementById('edit-lng').value;
                        const locationName = document.getElementById('edit-location-name').value?.trim?.() || '';
                        const dutyType = document.getElementById('edit-duty-type').value?.trim?.() || '';
                        const allowed = ['ä¸Šç­','ä¸‹ç­','å¤–å‡º','è¿”å›','æŠµé”','é›¢é–‹','è‡ªå‹•ä¸‹ç­'];
                        if (!allowed.includes(type)) { showToast('ç‹€æ…‹ä¸åˆæ³•', true); return; }
                        const d = timeStr ? new Date(timeStr) : new Date();
                        const updateData = { type, timestamp: Timestamp.fromDate(d) };
                        // æ›´æ–°è€…è³‡è¨Š
                        updateData.updatedBy = window.__auth?.currentUser?.uid || null;
                        updateData.updatedAt = Timestamp.fromDate(new Date());
                        const lat = latStr ? parseFloat(latStr) : null;
                        const lng = lngStr ? parseFloat(lngStr) : null;
                        if (typeof lat === 'number' && typeof lng === 'number' && !Number.isNaN(lat) && !Number.isNaN(lng)) {
                            updateData.location = new GeoPoint(lat, lng);
                        }
                        if (locationName) updateData.locationName = locationName.slice(0, 100);
                        if (dutyType) updateData.dutyType = dutyType.slice(0, 100);
                        await updateDoc(doc(db, 'clockInRecords', record.id), updateData);
                        showToast('æ›´æ–°æˆåŠŸ');
                        // ä¾ç•¶å‰é é¢è§¸ç™¼åˆ·æ–°ï¼šè¿½è¹¤æˆ–äººäº‹åˆ—è¡¨
                        try {
                            if (typeof loadAttendanceRecords === 'function') {
                                // è¿½è¹¤é é¢
                                loadAttendanceRecords();
                            } else if (typeof renderAttendanceRecordsList === 'function') {
                                // äººäº‹åˆ—è¡¨é é¢
                                const selectedUserId = document.getElementById('user-select')?.value || 'all';
                                const selectedDateStr = document.getElementById('record-date')?.value || new Date().toISOString().split('T')[0];
                                await renderAttendanceRecordsList('attendance-records-list', selectedUserId, selectedDateStr);
                            }
                        } catch (err) {
                            console.warn('åˆ·æ–°åˆ—è¡¨æ™‚ç™¼ç”Ÿå•é¡Œï¼š', err);
                        }
                        close();
                    } catch (e) {
                        console.error('update clockInRecord error', e);
                        showToast('æ›´æ–°å¤±æ•—ï¼šè«‹æª¢æŸ¥æ¬Šé™æˆ–è³‡æ–™æ ¼å¼', true);
                    }
                });
            }

            function openUserModal(user = null) {
                const modalId = `user-modal-${Date.now()}`;
                const isEditing = user !== null;
                const title = isEditing ? 'ç·¨è¼¯å¸³è™Ÿ' : 'æ–°å¢å¸³è™Ÿ';
                const isSelfEditing = isEditing && user.id === (state.currentUser?.uid || null);
                let newUserAvatarFile = null;
                let newUserAvatarBase64 = null;
                const close = () => document.getElementById(modalId)?.remove();

                const defaultAvatar = 'https://placehold.co/80x80/EFEFEF/333333?text=é ­åƒ';
                // é è¨­è§’è‰²ï¼šå„ªå…ˆä½¿ç”¨è·ç¨±ï¼ˆè‹¥å±¬æŒ‡å®šç¤¾å€è§’è‰²ï¼‰ï¼Œå¦å‰‡ä½¿ç”¨è³‡æ–™åº«å…§çš„è§’è‰²
                const jt = isEditing ? ((user?.jobTitle || user?.applicationTitle || '') + '').trim() : '';
                const effRole = isEditing ? (isFieldLikeRole(jt) ? jt : ((user?.role || 'user') + '')) : '';

                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[90%] max-w-md bg-white rounded-lg shadow-xl flex flex-col" style="max-height: 90vh;">
                            <div class="flex justify-between items-center p-4 border-b flex-shrink-0">
                                <h3 class="font-bold text-lg">${title}</h3>
                                <button class="close-btn text-gray-500 hover:text-gray-700"><i data-lucide="x" class="w-5 h-5"></i></button>
                            </div>
                            <form id="user-form" class="p-4 space-y-4 overflow-y-auto">
                                <!-- Avatar Section -->
                                <div class="flex flex-col items-center space-y-2">
                                    <img id="user-avatar-preview" src="${isEditing && user.avatarUrl ? user.avatarUrl : defaultAvatar}" class="w-20 h-20 rounded-full object-cover">
                                    <input type="file" id="user-avatar-upload" class="hidden" accept="image/*">
                                    <div class="flex space-x-2">
                                        <button type="button" id="user-upload-avatar-btn" class="text-sm px-3 py-1 bg-gray-200 rounded-md">ä¸Šå‚³ç…§ç‰‡</button>
                                
                                    </div>
                                </div>
                                
                                <!-- Form Fields -->
                                <div>
                                    <label for="user-name" class="block text-sm font-medium text-gray-700">å§“å (å¿…å¡«)</label>
                                    <input type="text" id="user-name" value="${isEditing ? user.name : ''}" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                </div>
                                <div>
                                    <label for="user-phone" class="block text-sm font-medium text-gray-700">æ‰‹æ©Ÿè™Ÿç¢¼</label>
                                    <input type="tel" id="user-phone" value="${isEditing ? user.phone || '' : ''}" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                                <div>
                                    <label for="user-title" class="block text-sm font-medium text-gray-700">è·ç¨±</label>
                                    <input type="text" id="user-title" value="${isEditing ? (user.jobTitle || '') : ''}" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                                <div>
                                    <label for="user-employment-status" class="block text-sm font-medium text-gray-700">ç‹€æ…‹</label>
                                    <select id="user-employment-status" class="w-full mt-1 px-3 py-2 border rounded-md">
                                        <option value="åœ¨è·" ${isEditing ? (user.employmentStatus === 'åœ¨è·' ? 'selected' : '') : 'selected'}>åœ¨è·</option>
                                        <option value="é›¢è·" ${isEditing && user.employmentStatus === 'é›¢è·' ? 'selected' : ''}>é›¢è·</option>
                                        <option value="ç¾é‡‘ç­" ${isEditing && user.employmentStatus === 'ç¾é‡‘ç­' ? 'selected' : ''}>ç¾é‡‘ç­</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="user-email" class="block text-sm font-medium text-gray-700">é›»å­éƒµä»¶ / å¸³è™Ÿ (å¿…å¡«)</label>
                                    <input type="email" id="user-email" value="${isEditing ? user.email : ''}" ${isEditing ? 'disabled' : ''} class="w-full mt-1 px-3 py-2 border rounded-md ${isEditing ? 'bg-gray-100' : ''}" required>
                                </div>
                                ${!isEditing ? `
                                <div>
                                    <label for="user-password" class="block text-sm font-medium text-gray-700">è¨­å®šå¯†ç¢¼ (å¿…å¡«, è‡³å°‘6ä½æ•¸)</label>
                                    <input type="password" id="user-password" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                </div>
                                <div>
                                    <label for="user-confirm-password" class="block text-sm font-medium text-gray-700">å†æ¬¡ç¢ºèªå¯†ç¢¼ (å¿…å¡«)</label>
                                    <input type="password" id="user-confirm-password" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                </div>
                                ` : ''}
                                <!-- æ–°å¢æ¬„ä½ï¼šä½å®¶åœ°å€ / ç”Ÿæ—¥ / èº«åˆ†è­‰è™Ÿ / è­‰ç…§ / å‰ç§‘ / æœå‹™ç¤¾å€ä»£è™Ÿ -->
                                <div>
                                    <label for="user-address" class="block text-sm font-medium text-gray-700">ä½å®¶åœ°å€</label>
                                    <input type="text" id="user-address" value="${isEditing ? (user.homeAddress || '') : ''}" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                                <div>
                                    <label for="user-birthdate" class="block text-sm font-medium text-gray-700">å‡ºç”Ÿå¹´æœˆæ—¥</label>
                                    <input type="date" id="user-birthdate" value="${isEditing ? (user.birthDate || '') : ''}" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                                <div>
                                    <label for="user-idnumber" class="block text-sm font-medium text-gray-700">èº«åˆ†è­‰è™Ÿ</label>
                                    <input type="text" id="user-idnumber" value="${isEditing ? (user.idNumber || '') : ''}" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                                <div>
                                    <label for="user-blood-type" class="block text-sm font-medium text-gray-700">è¡€å‹</label>
                                    <select id="user-blood-type" class="w-full mt-1 px-3 py-2 border rounded-md">
                                        <option value="" ${isEditing && !user.bloodType ? 'selected' : ''}>æœªé¸æ“‡</option>
                                        <option value="A" ${isEditing && user.bloodType === 'A' ? 'selected' : ''}>A</option>
                                        <option value="B" ${isEditing && user.bloodType === 'B' ? 'selected' : ''}>B</option>
                                        <option value="O" ${isEditing && user.bloodType === 'O' ? 'selected' : ''}>O</option>
                                        <option value="AB" ${isEditing && user.bloodType === 'AB' ? 'selected' : ''}>AB</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="user-emergency-name" class="block text-sm font-medium text-gray-700">ç·Šæ€¥è¯çµ¡äººå§“å</label>
                                    <input type="text" id="user-emergency-name" value="${isEditing ? (user.emergencyName || '') : ''}" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                                <div>
                                    <label for="user-emergency-relation" class="block text-sm font-medium text-gray-700">èˆ‡è¯çµ¡äººé—œä¿‚</label>
                                    <input type="text" id="user-emergency-relation" value="${isEditing ? (user.emergencyRelation || '') : ''}" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                                <div>
                                    <label for="user-emergency-phone" class="block text-sm font-medium text-gray-700">ç·Šæ€¥é€£çµ¡äººæ‰‹æ©Ÿè™Ÿç¢¼</label>
                                    <input type="tel" id="user-emergency-phone" value="${isEditing ? (user.emergencyPhone || '') : ''}" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                                <div>
                                    <label for="user-license" class="block text-sm font-medium text-gray-700">å°ˆæ¥­è­‰ç…§</label>
                                    <select id="user-license" class="w-full mt-1 px-3 py-2 border rounded-md">
                                        <option value="ç„¡" ${isEditing && user.license === 'ç„¡' ? 'selected' : ''}>ç„¡</option>
                                        <option value="è·æ¥­å®‰å…¨è¡›ç”Ÿæ¥­å‹™ä¸»ç®¡è­‰ç…§" ${isEditing && user.license === 'è·æ¥­å®‰å…¨è¡›ç”Ÿæ¥­å‹™ä¸»ç®¡è­‰ç…§' ? 'selected' : ''}>è·æ¥­å®‰å…¨è¡›ç”Ÿæ¥­å‹™ä¸»ç®¡è­‰ç…§</option>
                                        <option value="è·æ¥­å®‰å…¨è¡›ç”Ÿç®¡ç†å“¡è­‰ç…§" ${isEditing && user.license === 'è·æ¥­å®‰å…¨è¡›ç”Ÿç®¡ç†å“¡è­‰ç…§' ? 'selected' : ''}>è·æ¥­å®‰å…¨è¡›ç”Ÿç®¡ç†å“¡è­‰ç…§</option>
                                        <option value="é˜²ç«é¿é›£è¨­æ–½ç®¡ç†äººå“¡è­‰ç…§" ${isEditing && user.license === 'é˜²ç«é¿é›£è¨­æ–½ç®¡ç†äººå“¡è­‰ç…§' ? 'selected' : ''}>é˜²ç«é¿é›£è¨­æ–½ç®¡ç†äººå“¡è­‰ç…§</option>
                                        <option value="è¨­å‚™å®‰å…¨ç®¡ç†äººå“¡è­‰ç…§" ${isEditing && user.license === 'è¨­å‚™å®‰å…¨ç®¡ç†äººå“¡è­‰ç…§' ? 'selected' : ''}>è¨­å‚™å®‰å…¨ç®¡ç†äººå“¡è­‰ç…§</option>
                                        <option value="æ•‘ç”Ÿå“¡è­‰ç…§" ${isEditing && user.license === 'æ•‘ç”Ÿå“¡è­‰ç…§' ? 'selected' : ''}>æ•‘ç”Ÿå“¡è­‰ç…§</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="user-criminal" class="block text-sm font-medium text-gray-700">æœ‰ç„¡å‰ç§‘</label>
                                    <select id="user-criminal" class="w-full mt-1 px-3 py-2 border rounded-md">
                                        <option value="ç„¡" ${isEditing && (user.hasCriminalRecord === false) ? 'selected' : ''}>ç„¡</option>
                                        <option value="æœ‰" ${isEditing && (user.hasCriminalRecord === true) ? 'selected' : ''}>æœ‰</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="user-service-code" class="block text-sm font-medium text-gray-700">æœå‹™ç¤¾å€ä»£è™Ÿ (æ‰‹å‹•è¼¸å…¥)</label>
                                    <input type="text" id="user-service-code" value="${isEditing ? (user.serviceCommunityCode || '') : ''}" class="w-full mt-1 px-3 py-2 border rounded-md">
                                </div>
                                <div>
                                    <label for="user-role" class="block text-sm font-medium text-gray-700">è§’è‰² (å¿…å¡«)</label>
                                    <select id="user-role" class="w-full mt-1 px-3 py-2 border rounded-md">
                                        <option value="field" ${isEditing && effRole === 'field' ? 'selected' : ''}>å¤–å‹¤ï¼ˆä¸€èˆ¬ï¼‰</option>
                                        <option value="ç¸½å¹¹äº‹" ${isEditing && effRole === 'ç¸½å¹¹äº‹' ? 'selected' : ''}>ç¸½å¹¹äº‹</option>
                                        <option value="ä¿å…¨" ${isEditing && effRole === 'ä¿å…¨' ? 'selected' : ''}>ä¿å…¨</option>
                                        <option value="ç§˜æ›¸" ${isEditing && effRole === 'ç§˜æ›¸' ? 'selected' : ''}>ç§˜æ›¸</option>
                                        <option value="æ¸…æ½”" ${isEditing && effRole === 'æ¸…æ½”' ? 'selected' : ''}>æ¸…æ½”</option>
                                        <option value="æ©Ÿé›»" ${isEditing && effRole === 'æ©Ÿé›»' ? 'selected' : ''}>æ©Ÿé›»</option>
                                        <option value="user" ${isEditing && effRole === 'user' ? 'selected' : ''}>å…§å‹¤</option>
                                        <option value="junior_manager" ${isEditing && effRole === 'junior_manager' ? 'selected' : ''}>åˆéšä¸»ç®¡</option>
                                        <option value="manager" ${isEditing && effRole === 'manager' ? 'selected' : ''}>é«˜éšä¸»ç®¡</option>
                                        <option value="hr" ${isEditing && effRole === 'hr' ? 'selected' : ''}>äººäº‹</option>
                                        <option value="admin" ${isEditing && effRole === 'admin' ? 'selected' : ''}>ç®¡ç†å“¡</option>
                                    </select>
                                </div>

                                <!-- æœå‹™ç¤¾å€ (å¯è¤‡é¸) -->
                                <div id="service-communities-section">
                                    <label class="block text-sm font-medium text-gray-700">æœå‹™ç¤¾å€ (å¯è¤‡é¸)</label>
                                    <div class="flex items-center mb-2">
                                        <input type="checkbox" id="service-community-select-all" class="mr-2">
                                        <span class="text-sm text-gray-600">å…¨é¸</span>
                                    </div>
                                    <div id="service-community-list" class="grid grid-cols-1 gap-2"></div>
                                </div>

                                <!-- å¯†ç¢¼ç®¡ç†ï¼ˆç·¨è¼¯ï¼‰ -->
                                ${isEditing ? `
                                <div class="bg-gray-50 p-3 rounded-md border">
                                    <p class="text-sm font-medium text-gray-700 mb-2">å¯†ç¢¼ç®¡ç†</p>
                                    ${isSelfEditing ? `
                                        <div>
                                            <label for="edit-new-password" class="block text-sm font-medium text-gray-700">æ–°å¯†ç¢¼ (é¸å¡«ï¼Œè‡³å°‘6ä½æ•¸)</label>
                                            <input type="password" id="edit-new-password" class="w-full mt-1 px-3 py-2 border rounded-md">
                                        </div>
                                        <div>
                                            <label for="edit-confirm-password" class="block text-sm font-medium text-gray-700">å†æ¬¡ç¢ºèªæ–°å¯†ç¢¼</label>
                                            <input type="password" id="edit-confirm-password" class="w-full mt-1 px-3 py-2 border rounded-md">
                                        </div>
                                    ` : `
                                        <button type="button" id="send-reset-email-btn" class="w-full bg-gray-200 text-gray-700 py-2 rounded-md hover:bg-gray-300">
                                            å¯„é€é‡è¨­å¯†ç¢¼ä¿¡åˆ° ${user.email}
                                        </button>
                                        <p class="mt-2 text-xs text-gray-500">ç„¡æ³•ç›´æ¥è®Šæ›´å…¶ä»–ç”¨æˆ¶å¯†ç¢¼ï¼Œè«‹é€é Email é‡è¨­ã€‚</p>
                                    `}
                                </div>
                                ` : ''}
                                
                                <p id="user-form-error" class="text-red-500 text-sm text-center"></p>
                                <div class="flex justify-end space-x-2 pt-2 flex-shrink-0">
                                     <button type="button" class="cancel-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">å–æ¶ˆ</button>
                                     <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">å„²å­˜</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                modalContainer.innerHTML = modalHTML;
                lucide.createIcons();
                
                const modal = document.getElementById(modalId);
                const userForm = document.getElementById('user-form');
                const errorEl = document.getElementById('user-form-error');
                const avatarPreview = document.getElementById('user-avatar-preview');
                const avatarUploadInput = document.getElementById('user-avatar-upload');
                const serviceCommunityListEl = document.getElementById('service-community-list');
                const serviceCommunitySelectAllEl = document.getElementById('service-community-select-all');

                // é™åˆ¶è§’è‰²é¸é …ï¼ˆè¨­å®šåˆ†é èˆ‡äººå“¡åˆ†é ï¼‰
                try {
                    const roleSelectEl = document.getElementById('user-role');
                    if (roleSelectEl) {
                        const allowedHR = new Set(['ç¸½å¹¹äº‹','ç§˜æ›¸','ä¿å…¨','æ¸…æ½”','æ©Ÿé›»']);
                        const allowedGlobal = new Set(['admin','hr','manager','junior_manager','ç¸½å¹¹äº‹','ç§˜æ›¸','ä¿å…¨','æ¸…æ½”','æ©Ÿé›»']);
                        const isHRPage = state.currentPage === 'hr';
                        const isGlobalSettings = state.currentPage === 'settings' || state.currentPage === 'navigation';
                        const allowedSet = isHRPage ? allowedHR : (isGlobalSettings ? allowedGlobal : null);
                        if (allowedSet) {
                            const currentVal = roleSelectEl.value;
                            Array.from(roleSelectEl.options).forEach(opt => {
                                if (!allowedSet.has(opt.value)) {
                                    opt.remove();
                                }
                            });
                            if (!allowedSet.has(currentVal) && roleSelectEl.options.length > 0) {
                                roleSelectEl.selectedIndex = 0;
                            }
                        }
                    }
                } catch (e) { /* noop */ }

                // å£“ç¸®åœ–ç‰‡ç‚º Base64ï¼Œé™åˆ¶å¤§å°èˆ‡å°ºå¯¸
                const compressToBase64 = async (file, maxW = 320, maxH = 320, quality = 0.8) => {
                    return await new Promise((resolve, reject) => {
                        const img = new Image();
                        const url = URL.createObjectURL(file);
                        img.onload = () => {
                            try {
                                const ratio = Math.min(maxW / img.width, maxH / img.height, 1);
                                const w = Math.max(1, Math.floor(img.width * ratio));
                                const h = Math.max(1, Math.floor(img.height * ratio));
                                const canvas = document.createElement('canvas');
                                canvas.width = w;
                                canvas.height = h;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0, w, h);
                                const dataUrl = canvas.toDataURL('image/jpeg', quality);
                                URL.revokeObjectURL(url);
                                resolve(dataUrl);
                            } catch (err) {
                                URL.revokeObjectURL(url);
                                reject(err);
                            }
                        };
                        img.onerror = (e) => {
                            URL.revokeObjectURL(url);
                            reject(e);
                        };
                        img.src = url;
                    });
                };

                // --- Avatar Logic ---
                // å…è¨±æ‰€æœ‰ç”¨æˆ¶ï¼ˆåŒ…æ‹¬ç·¨è¼¯ç¾æœ‰ç”¨æˆ¶ï¼‰ä¸Šå‚³é ­åƒ
                const uploadBtn = document.getElementById('user-upload-avatar-btn');
                if (uploadBtn) {
                    uploadBtn.addEventListener('click', () => avatarUploadInput.click());
                }
                
                avatarUploadInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        newUserAvatarFile = file;
                        try {
                            const base64 = await compressToBase64(file, 320, 320, 0.8);
                            // æª¢æŸ¥å¤§å°ï¼ˆç´„ç•¥æ›ç®— Base64 è‡³ä½å…ƒçµ„ï¼‰
                            const approxBytes = Math.floor(base64.length * 3 / 4);
                            if (approxBytes > 900 * 1024) {
                                showToast('ç…§ç‰‡éå¤§ï¼Œè«‹é¸æ“‡è¼ƒå°æª”æ¡ˆæˆ–é™ä½å“è³ª', true);
                                newUserAvatarBase64 = null;
                                return;
                            }
                            newUserAvatarBase64 = base64;
                            avatarPreview.src = base64;
                        } catch (err) {
                            console.warn('å£“ç¸®é ­åƒå¤±æ•—ï¼Œä½¿ç”¨åŸæª”é è¦½ï¼š', err);
                            avatarPreview.src = URL.createObjectURL(file);
                            newUserAvatarBase64 = null;
                        }
                    }
                });
                
                // è¼‰å…¥æœå‹™ç¤¾å€æ¸…å–®ï¼ˆå¤šé¸ + å…¨é¸ï¼‰
                (async () => {
                    try {
                        const communitiesSnap = await getDocs(collection(db, 'communities'));
                        const communities = [];
                        communitiesSnap.forEach(docSnap => communities.push({ id: docSnap.id, ...docSnap.data() }));
                        // ä¾ç¤¾å€ç·¨è™Ÿæ’åºï¼ˆå¦‚ A101ã€A102ã€...ã€B207ã€B208ï¼‰
                        communities.sort(compareCommunitiesByCode);
                        const selectedIds = isEditing && Array.isArray(user.serviceCommunities) ? new Set(user.serviceCommunities) : new Set();
                        serviceCommunityListEl.innerHTML = communities.map(c => {
                            const label = `${c.region ? `[${c.region}] ` : ''}${c.code ? `[${c.code}] ` : ''}${c.name || ''}`;
                            const checked = selectedIds.has(c.id) ? 'checked' : '';
                            return `
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" name="service-community" value="${c.id}" class="rounded" ${checked}>
                                    <span class="text-sm text-gray-700">${label}</span>
                                </label>
                            `;
                        }).join('');

                        if (serviceCommunitySelectAllEl) {
                            serviceCommunitySelectAllEl.addEventListener('change', (e) => {
                                const checked = e.target.checked;
                                serviceCommunityListEl.querySelectorAll('input[name="service-community"]').forEach(chk => { chk.checked = checked; });
                            });
                        }
                    } catch (err) {
                        console.error('è¼‰å…¥æœå‹™ç¤¾å€å¤±æ•—', err);
                        serviceCommunityListEl.innerHTML = '<p class="text-sm text-red-500">æœå‹™ç¤¾å€è¼‰å…¥å¤±æ•—</p>';
                    }
                })();


                // --- Form Logic ---
                modal.querySelector('.close-btn').addEventListener('click', close);
                modal.querySelector('.cancel-btn').addEventListener('click', close);

                userForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    showLoading(true);
                    errorEl.textContent = '';

                    // --- Form Data Collection ---
                    const name = document.getElementById('user-name').value;
                    const phone = document.getElementById('user-phone').value;
                    const jobTitle = document.getElementById('user-title')?.value || '';
                    const employmentStatus = document.getElementById('user-employment-status')?.value || '';
                    const email = document.getElementById('user-email').value;
                    const rawRole = document.getElementById('user-role').value;
                    const homeAddress = document.getElementById('user-address')?.value || '';
                    const birthDate = document.getElementById('user-birthdate')?.value || '';
                    const idNumber = document.getElementById('user-idnumber')?.value || '';
                    const bloodType = document.getElementById('user-blood-type')?.value || '';
                    const emergencyName = document.getElementById('user-emergency-name')?.value || '';
                    const emergencyRelation = document.getElementById('user-emergency-relation')?.value || '';
                    const emergencyPhone = document.getElementById('user-emergency-phone')?.value || '';
                    const license = document.getElementById('user-license')?.value || '';
                    const hasCriminalRecord = (document.getElementById('user-criminal')?.value || 'ç„¡') === 'æœ‰';
                    const serviceCommunityCode = document.getElementById('user-service-code')?.value || '';
                    
                    // æ”¶é›†æœå‹™ç¤¾å€
                    const scChecks = modal.querySelectorAll('input[name="service-community"]');
                    const serviceCommunities = Array.from(scChecks).filter(c => c.checked).map(c => c.value);
                    // æ¬Šé™è§’è‰²èˆ‡è·å‹™æ˜ å°„ï¼šä¸€èˆ¬å“¡å·¥çš„æ¬Šé™ä¸€å¾‹ç‚º userï¼Œè·å‹™è¨˜éŒ„åœ¨ applicationTitle
                    const titleRoles = new Set(['ç¸½å¹¹äº‹','ç§˜æ›¸','ä¿å…¨','æ¸…æ½”','æ©Ÿé›»','field']);
                    const permissionRole = (['admin','hr','manager','junior_manager','community_admin','user'].includes(rawRole)) ? rawRole : 'user';
                    const applicationTitle = titleRoles.has(rawRole) ? (rawRole === 'field' ? '' : rawRole) : '';
                    const updateData = { name, phone, role: permissionRole, email, serviceCommunities, homeAddress, birthDate, idNumber, license, hasCriminalRecord, serviceCommunityCode, bloodType, emergencyName, emergencyRelation, emergencyPhone, jobTitle, employmentStatus };
                    if (applicationTitle) updateData.applicationTitle = applicationTitle;

                    try {
                        let targetUserId = isEditing ? user.id : null;
                        let newAvatarUrl = isEditing ? user.avatarUrl : null;

                        // --- Password Validation (for new users) ---
                        if (!isEditing) {
                            const password = document.getElementById('user-password').value;
                            const confirmPassword = document.getElementById('user-confirm-password').value;
                            if (password.length < 6) {
                                throw new Error("å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦6å€‹å­—å…ƒã€‚");
                            }
                            if (password !== confirmPassword) {
                                throw new Error("å…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸ç›¸ç¬¦ã€‚");
                            }
                        }

                        // --- User Creation (if applicable) ---
                        if (!isEditing) {
                            const password = document.getElementById('user-password').value;
                            const { initializeApp: initializeAppSecondary, deleteApp } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
                            const secondaryApp = initializeAppSecondary(firebaseConfig, `secondary-app-${Date.now()}`);
                            const secondaryAuth = getAuth(secondaryApp);
                             try {
                                const userCredential = await createUserWithEmailAndPassword(secondaryAuth, email, password);
                                targetUserId = userCredential.user.uid;
                                // ç¢ºä¿æ–°ç”¨æˆ¶çš„çæ‡²é»æ•¸é è¨­ç‚º0
                                updateData.points = 0;
                            } catch (creationError) {
                                if (creationError.code === 'auth/email-already-in-use') throw new Error('æ­¤é›»å­éƒµä»¶å·²è¢«è¨»å†Šã€‚');
                                else throw new Error('å»ºç«‹é©—è­‰å¸³è™Ÿå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                            } finally {
                                await signOut(secondaryAuth);
                                await deleteApp(secondaryApp);
                            }
                        }
                        
                        // --- Avatar Upload (if new avatar is set) ---
                        if (newUserAvatarFile) {
                            try {
                                if (newUserAvatarBase64) {
                                    newAvatarUrl = newUserAvatarBase64;
                                } else {
                                    // å¾Œå‚™ï¼šç›´æ¥è½‰ Base64ï¼ˆå¯èƒ½è¼ƒå¤§ï¼‰
                                    const reader = new FileReader();
                                    const base64Promise = new Promise((resolve, reject) => {
                                        reader.onload = () => resolve(reader.result);
                                        reader.onerror = () => reject(new Error('è®€å–æª”æ¡ˆå¤±æ•—'));
                                        reader.readAsDataURL(newUserAvatarFile);
                                    });
                                    const rawBase64 = await base64Promise;
                                    const approxBytes = Math.floor(rawBase64.length * 3 / 4);
                                    if (approxBytes > 900 * 1024) {
                                        throw new Error('ç…§ç‰‡éå¤§ï¼Œè«‹é¸æ“‡è¼ƒå°æª”æ¡ˆæˆ–é™ä½å“è³ª');
                                    }
                                    newAvatarUrl = rawBase64;
                                }
                                console.log('é ­åƒå·²è™•ç†ç‚º Base64 æ ¼å¼');
                            } catch (avatarError) {
                                console.error('é ­åƒè™•ç†éŒ¯èª¤:', avatarError);
                                showToast(avatarError.message || 'é ­åƒè™•ç†å¤±æ•—ï¼Œä½†æœƒç¹¼çºŒå„²å­˜å…¶ä»–è³‡æ–™', true);
                            }
                        }
                        updateData.avatarUrl = newAvatarUrl;

                        // --- å¯†ç¢¼ä¿®æ”¹ï¼ˆåƒ…æœ¬äººå¯ç›´æ¥ä¿®æ”¹ï¼‰ ---
                        if (isSelfEditing) {
                            const newPwd = document.getElementById('edit-new-password')?.value || '';
                            const confirmNewPwd = document.getElementById('edit-confirm-password')?.value || '';
                            if (newPwd || confirmNewPwd) {
                                if (newPwd.length < 6) throw new Error('æ–°å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦6å€‹å­—å…ƒã€‚');
                                if (newPwd !== confirmNewPwd) throw new Error('å…©æ¬¡è¼¸å…¥çš„æ–°å¯†ç¢¼ä¸ç›¸ç¬¦ã€‚');
                                try {
                                    await updatePassword(auth.currentUser, newPwd);
                                    showToast('å¯†ç¢¼å·²æ›´æ–°');
                                } catch (pwdErr) {
                                    console.error('æ›´æ–°å¯†ç¢¼å¤±æ•—', pwdErr);
                                    if (pwdErr?.code === 'auth/requires-recent-login') {
                                        throw new Error('æ›´æ–°å¯†ç¢¼éœ€è¦é‡æ–°ç™»å…¥ï¼Œè«‹å…ˆç™»å‡ºå†ç™»å…¥å¾Œé‡è©¦');
                                    } else {
                                        throw new Error('æ›´æ–°å¯†ç¢¼å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                                    }
                                }
                            }
                        }

                        // --- Database Operation ---
                        if (isEditing) {
                            await updateDoc(doc(db, "users", targetUserId), updateData);
                            showToast("ä½¿ç”¨è€…è³‡æ–™æ›´æ–°æˆåŠŸ");
                        } else {
                            updateData.status = "æœªæ‰“å¡";
                            updateData.createdAt = serverTimestamp();
                            await setDoc(doc(db, "users", targetUserId), updateData);
                            showToast("æ–°å¸³è™Ÿå»ºç«‹æˆåŠŸ");
                        }

                        // --- å¼·ä¸€è‡´ï¼šåŒæ­¥æ›´æ–° loginIndexï¼ˆphoneKey â†’ email,userIdï¼‰---
                        try {
                            const oldPhoneRaw = isEditing ? ((user.phone || '') + '').trim() : '';
                            const newPhoneRaw = ((phone || '') + '').trim();
                            const oldPhoneKey = oldPhoneRaw ? normalizePhone(oldPhoneRaw) : '';
                            const newPhoneKey = newPhoneRaw ? normalizePhone(newPhoneRaw) : '';

                            // è‹¥æ‰‹æ©Ÿæœ‰è®Šæ›´ï¼Œæ¸…ç©ºèˆŠç´¢å¼•ä»¥é¿å…èˆŠè™Ÿä»å¯ç™»å…¥
                            if (isEditing && oldPhoneKey && oldPhoneKey !== newPhoneKey) {
                                await setDoc(doc(db, 'loginIndex', oldPhoneKey), {
                                    email: '',
                                    userId: targetUserId,
                                    updatedAt: serverTimestamp()
                                }, { merge: true });
                            }
                            // å¯«å…¥æ–°è™Ÿç´¢å¼•ï¼ˆè‹¥æ–°è™Ÿå­˜åœ¨ï¼‰
                            if (newPhoneKey) {
                                await setDoc(doc(db, 'loginIndex', newPhoneKey), {
                                    email,
                                    userId: targetUserId,
                                    updatedAt: serverTimestamp()
                                }, { merge: true });
                            }
                        } catch (e) {
                            console.warn('åŒæ­¥ loginIndex å¤±æ•—', e);
                        }
                        
                        close();

                    } catch (error) {
                        console.error("User modal error:", error);
                        errorEl.textContent = error.message || 'æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
                    } finally {
                        showLoading(false);
                    }
                });

                // å¯„é€é‡è¨­å¯†ç¢¼ä¿¡ï¼ˆç·¨è¼¯ä»–äººæ™‚ï¼‰
                const sendResetBtn = document.getElementById('send-reset-email-btn');
                if (sendResetBtn) {
                    sendResetBtn.addEventListener('click', async () => {
                        try {
                            showLoading(true);
            {
                const actionCodeSettings = {
                    url: `${window.location.origin}${window.location.pathname}?mode=resetPassword`,
                    handleCodeInApp: true
                };
                await sendPasswordResetEmail(auth, user.email, actionCodeSettings);
            }
                            showToast('å·²å¯„å‡ºé‡è¨­å¯†ç¢¼é€šçŸ¥ä¿¡');
                        } catch (err) {
                            console.error('å¯„é€é‡è¨­å¯†ç¢¼ä¿¡å¤±æ•—', err);
                            showToast('å¯„é€å¤±æ•—ï¼šè«‹ç¨å¾Œå†è©¦', true);
                        } finally {
                            showLoading(false);
                        }
                    });
                }
            }
            
            function openRuleModal(rule = null) {
                const modalId = `rule-modal-${Date.now()}`;
                const isEditing = rule !== null;
                const title = isEditing ? 'ç·¨è¼¯è¦å‰‡' : 'æ–°å¢è¦å‰‡';
                const close = () => document.getElementById(modalId)?.remove();

                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[90%] max-w-md bg-white rounded-lg shadow-xl flex flex-col">
                            <div class="flex justify-between items-center p-4 border-b">
                                <h3 class="font-bold text-lg">${title}</h3>
                                <button class="close-btn text-gray-500 hover:text-gray-700"><i data-lucide="x" class="w-5 h-5"></i></button>
                            </div>
                            <form id="rule-form" class="p-4 space-y-4">
                                <div>
                                    <label for="rule-reason" class="block text-sm font-medium text-gray-700">äº‹ç”±</label>
                                    <input type="text" id="rule-reason" value="${isEditing ? rule.reason : ''}" placeholder="ä¾‹å¦‚ï¼šé²åˆ°" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                </div>
                                <div>
                                    <label for="rule-points" class="block text-sm font-medium text-gray-700">é»æ•¸ (å¯ç‚ºè² æ•¸)</label>
                                    <input type="number" id="rule-points" value="${isEditing ? rule.points : ''}" placeholder="-1" class="w-full mt-1 px-3 py-2 border rounded-md" required>
                                </div>
                                <div>
                                    <label for="rule-target" class="block text-sm font-medium text-gray-700">é©ç”¨å°è±¡</label>
                                    <select id="rule-target" class="w-full mt-1 px-3 py-2 border rounded-md">
                                        <option value="å€‹äºº" ${isEditing && rule.target === 'å€‹äºº' ? 'selected' : ''}>å€‹äºº</option>
                                        <option value="å…¨é«”" ${isEditing && rule.target === 'å…¨é«”' ? 'selected' : ''}>å…¨é«”</option>
                                    </select>
                                </div>
                                <p id="rule-form-error" class="text-red-500 text-sm text-center"></p>
                                <div class="flex justify-end space-x-2 pt-2">
                                     <button type="button" class="cancel-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">å–æ¶ˆ</button>
                                     <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">å„²å­˜</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                modalContainer.innerHTML = modalHTML;
                lucide.createIcons();

                const modal = document.getElementById(modalId);
                const ruleForm = document.getElementById('rule-form');
                const errorEl = document.getElementById('rule-form-error');

                modal.querySelector('.close-btn').addEventListener('click', close);
                modal.querySelector('.cancel-btn').addEventListener('click', close);

                ruleForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    showLoading(true);
                    errorEl.textContent = '';

                    const reason = document.getElementById('rule-reason').value;
                    const points = Number(document.getElementById('rule-points').value);
                    const target = document.getElementById('rule-target').value;

                    if (!reason || isNaN(points)) {
                        errorEl.textContent = 'è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ã€‚';
                        showLoading(false);
                        return;
                    }

                    try {
                        if (isEditing) {
                            const ruleRef = doc(db, "pointRules", rule.id);
                            await updateDoc(ruleRef, { reason, points, target });
                            showToast("è¦å‰‡æ›´æ–°æˆåŠŸ");
                        } else {
                            await addDoc(collection(db, "pointRules"), { reason, points, target });
                            showToast("æ–°è¦å‰‡æ–°å¢æˆåŠŸ");
                        }
                        close();
                    } catch (error) {
                        console.error("Rule modal error:", error);
                        errorEl.textContent = 'æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
                    } finally {
                        showLoading(false);
                    }
                });
            }

            function renderProfileModal() {
                const modalId = `profile-modal-${Date.now()}`;
                const close = () => document.getElementById(modalId)?.remove();

                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[90%] max-w-md bg-white rounded-lg shadow-xl flex flex-col">
                            <div class="flex justify-between items-center p-4 border-b">
                                <h3 class="font-bold text-lg">å€‹äººè³‡æ–™</h3>
                                <button class="close-btn text-gray-500 hover:text-gray-700"><i data-lucide="x" class="w-5 h-5"></i></button>
                            </div>

                            <div class="p-4 space-y-4 overflow-y-auto">
                                <!-- Avatar section -->
                                <div class="flex flex-col items-center space-y-2">
                                    <img id="modal-avatar" src="${state.currentUserData.avatarUrl || `https://placehold.co/80x80/EFEFEF/333333?text=${state.currentUserData.name.charAt(0)}`}" alt="Avatar" class="w-20 h-20 rounded-full object-cover">
                                    <label for="avatar-upload" class="cursor-pointer text-blue-600 hover:text-blue-800">
                                        æ›´æ›é ­åƒ
                                        <input type="file" id="avatar-upload" accept="image/*" class="hidden">
                                    </label>
                                </div>

                                <!-- Info -->
                                <div class="text-center">
                                    <p class="font-bold text-xl">${state.currentUserData.name}</p>
                                    <p class="text-gray-500">${state.currentUserData.email}</p>
                                </div>
                                
                                <!-- çæ‡²é»æ•¸ -->
                                <div class="border-t pt-4">
                                    <h4 class="font-semibold mb-2">çæ‡²é»æ•¸</h4>
                                    <p class="text-center text-3xl font-bold">${state.currentUserData.points || 0} é»</p>
                                </div>

                                <!-- æœªä¾†è«‹å‡ -->
                                <div class="border-t pt-4">
                                    <h4 class="font-semibold mb-2">è«‹å‡ç”³è«‹</h4>
                                    <div id="future-leaves" class="space-y-2"></div>
                                </div>
                            </div>

                            <div class="p-4 border-t">
                                <button id="logout-btn" class="w-full bg-gray-200 text-gray-700 py-2 rounded-md hover:bg-gray-300">ç™»å‡º</button>
                                <p class="mt-2 text-center">
                                    <a href="#" id="privacy-policy-link" class="text-blue-600 underline">éš±ç§æ¬Šæ”¿ç­–</a>
                                </p>
                            </div>
                        </div>
                    </div>
                `;

                modalContainer.innerHTML = modalHTML;
                lucide.createIcons();

                const modal = document.getElementById(modalId);
                const changePasswordForm = document.getElementById('change-password-form');
                const logoutBtn = document.getElementById('logout-btn');
                const avatarUploadInput = document.getElementById('avatar-upload');
                const privacyLink = document.getElementById('privacy-policy-link');

                modal.querySelector('.close-btn').addEventListener('click', close);
                
                // æ·»åŠ ç™»å‡ºæŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
                logoutBtn.addEventListener('click', async () => {
                    try {
                        showLoading(true);
                        await signOut(auth);
                        showToast("å·²æˆåŠŸç™»å‡º");
                        window.location.reload();
                    } catch (error) {
                        console.error("ç™»å‡ºå¤±æ•—:", error);
                        showToast("ç™»å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦", true);
                        showLoading(false);
                    }
                });

                // éš±ç§æ¬Šæ”¿ç­–é–‹çª—
                if (privacyLink) {
                    privacyLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        openPrivacyPolicyWindow();
                    });
                }

                async function processAndUploadAvatar(file) {
                    if (!file) return;
                    showLoading(true);
                    try {
                        // å£“ç¸®ç‚º Base64ï¼Œæ§åˆ¶å°ºå¯¸ä»¥ç¬¦åˆ Firestore æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆ1MBï¼‰
                        let dataUrl = await compressToBase64(file, 300); // æœ€é•·é‚Š 300pxï¼ŒJPEG 0.7
                        const base64 = dataUrl.split(',')[1] || '';
                        // è‹¥ä»éå¤§ï¼Œå˜—è©¦å†é™ä½å“è³ªèˆ‡å°ºå¯¸
                        const approxBytes = Math.ceil(base64.length * 0.75); // Base64 ä¼°ç®—
                        if (approxBytes > 900 * 1024) {
                            dataUrl = await compressToBase64(file, 240); // å†ç¸®å°
                        }
                        const base64After = dataUrl.split(',')[1] || '';
                        const bytesAfter = Math.ceil(base64After.length * 0.75);
                        if (bytesAfter > 900 * 1024) {
                            throw new Error('é¸æ“‡çš„åœ–ç‰‡éå¤§ï¼ˆéœ€å°æ–¼ç´„ 900KBï¼‰ï¼Œè«‹æ›è¼ƒå°çš„åœ–ç‰‡');
                        }

                        // å¯«å…¥ Firestore çš„ userAvatars/{uid}
                        const avatarDocRef = doc(db, 'userAvatars', state.currentUser.uid);
                        await setDoc(avatarDocRef, {
                            data: dataUrl,
                            mimeType: 'image/jpeg',
                            updatedAt: serverTimestamp(),
                        }, { merge: true });

                        // å…¼å®¹æ—¢æœ‰ UIï¼šå°‡ users.avatarUrl æ›´æ–°ç‚º Data URL
                        const userDocRef = doc(db, 'users', state.currentUser.uid);
                        await updateDoc(userDocRef, { avatarUrl: dataUrl });

                        // æ›´æ–°æœ¬åœ° UI
                        state.currentUserData.avatarUrl = dataUrl;
                        document.getElementById('modal-avatar').src = dataUrl;
                        const header = document.getElementById('header-avatar');
                        if (header) header.src = dataUrl;

                        showToast('é ­åƒæ›´æ–°æˆåŠŸï¼ˆå·²å­˜å…¥ Firestoreï¼‰');
                    } catch (error) {
                        console.error('Avatar upload error:', error);
                        showToast('é ­åƒä¸Šå‚³å¤±æ•—: ' + (error.message || error), true);
                    } finally {
                        showLoading(false);
                    }
                }

                avatarUploadInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    await processAndUploadAvatar(file);
                });

                
                // å£“ç¸®ä¸¦è½‰ Base64ï¼ˆData URLï¼‰
                async function compressToBase64(file, maxWidth) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onerror = () => reject(new Error('è®€å–åœ–ç‰‡å¤±æ•—'));
                        reader.onload = (event) => {
                            const img = new Image();
                            img.onerror = () => reject(new Error('åœ–ç‰‡è¼‰å…¥å¤±æ•—'));
                            img.src = event.target.result;
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                let width = img.width;
                                let height = img.height;
                                if (width > maxWidth) {
                                    height = Math.round((height * maxWidth) / width);
                                    width = maxWidth;
                                }
                                canvas.width = width;
                                canvas.height = height;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0, width, height);
                                try {
                                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                                    resolve(dataUrl);
                                } catch (e) {
                                    reject(e);
                                }
                            };
                        };
                        reader.readAsDataURL(file);
                    });
                }

                // æ–°å¢ï¼šå£“ç¸®ç‚º Blobï¼ˆè¡Œå‹•ç«¯æ›´ç©©å®šï¼Œé¿å… Base64 å¤§å­—ä¸²ï¼‰
                async function compressToBlob(file, maxWidth, mime = 'image/jpeg', quality = 0.85) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onerror = () => reject(new Error('è®€å–åœ–ç‰‡å¤±æ•—'));
                        reader.onload = (event) => {
                            const img = new Image();
                            img.onerror = () => reject(new Error('åœ–ç‰‡è¼‰å…¥å¤±æ•—'));
                            img.src = event.target.result;
                            img.onload = () => {
                                try {
                                    const canvas = document.createElement('canvas');
                                    let width = img.width;
                                    let height = img.height;
                                    if (width > maxWidth) {
                                        height = Math.round((height * maxWidth) / width);
                                        width = maxWidth;
                                    }
                                    canvas.width = width;
                                    canvas.height = height;
                                    const ctx = canvas.getContext('2d');
                                    ctx.drawImage(img, 0, 0, width, height);
                                    if (canvas.toBlob) {
                                        canvas.toBlob((b) => {
                                            if (b) resolve(b); else reject(new Error('åœ–ç‰‡å£“ç¸®å¤±æ•—'));
                                        }, mime, quality);
                                    } else {
                                        // Fallback: ä»¥ DataURL è½‰ Blob
                                        const dataUrl = canvas.toDataURL(mime, quality);
                                        fetch(dataUrl).then(r => r.blob()).then(resolve).catch(reject);
                                    }
                                } catch (err) {
                                    reject(err);
                                }
                            };
                        };
                        reader.readAsDataURL(file);
                    });
                }

                logoutBtn.addEventListener('click', async () => {
                    close();
                    await signOut(auth);
                    showToast("æ‚¨å·²æˆåŠŸç™»å‡º");
                });

                // è¼‰å…¥è«‹å‡ç”³è«‹æ¸…å–®
                (async function loadFutureLeaves() {
                    const container = document.getElementById('future-leaves');
                    if (!container) return;
                    try {
                        const uid = state.currentUser?.uid;
                        if (!uid) {
                            container.innerHTML = '<div class="text-sm text-red-600">è«‹å…ˆç™»å…¥</div>';
                            return;
                        }
                        container.innerHTML = '<div class="text-sm text-gray-500">è¼‰å…¥ä¸­...</div>';
                        const now = new Date();
                        const q = query(
                            collection(db, 'leaves'),
                            where('userId', '==', uid)
                        );
                        const snap = await getDocs(q);
                        const future = [];
                        snap.forEach(d => {
                            const l = d.data();
                            if (l.startTime && (l.startTime.toDate ? l.startTime.toDate() : new Date(l.startTime)) >= now) {
                                future.push({ id: d.id, ...l });
                            }
                        });
                        if (future.length === 0) {
                            container.innerHTML = '<div class="text-sm text-gray-500">æ²’æœ‰è«‹å‡ç”³è«‹</div>';
                            return;
                        }
                        future.sort((a, b) => (a.startTime.toDate ? a.startTime.toDate() : new Date(a.startTime)) - (b.startTime.toDate ? b.startTime.toDate() : new Date(b.startTime)));
                        const statusText = s => (
                            s === 'pending' ? 'å¾…å¯©æ ¸' : s === 'approved' ? 'å·²æ ¸å‡†' : s === 'rejected' ? 'å·²æ‹’çµ•' : 'æœªçŸ¥'
                        );
                        const statusClass = s => (
                            s === 'pending' ? 'bg-yellow-100 text-yellow-800' : s === 'approved' ? 'bg-green-100 text-green-800' : s === 'rejected' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'
                        );
                        container.innerHTML = future.map(l => `
                            <div class="p-3 rounded-md border bg-white">
                                <div class="text-sm font-medium">
                                    ${l.reason || 'ç„¡äº‹ç”±'}
                                    <span class="ml-2 text-xs px-2 py-0.5 rounded-full ${statusClass(l.status)}">${statusText(l.status)}</span>
                                </div>
                                <div class="text-xs text-gray-600 mt-1">å¾ ${formatDateTime(l.startTime)} è‡³ ${formatDateTime(l.endTime)}</div>
                                <div class="text-xs text-gray-500">${l.reasonType || ''}</div>
                            </div>
                        `).join('');
                    } catch (e) {
                        console.error('è¼‰å…¥è«‹å‡ç”³è«‹å¤±æ•—:', e);
                        container.innerHTML = '<div class="text-sm text-red-600">è¼‰å…¥è«‹å‡ç”³è«‹å¤±æ•—</div>';
                    }
                })();
            }

            // é–‹æ–°è¦–çª—é¡¯ç¤ºéš±ç§æ¬Šæ”¿ç­–
            function openPrivacyPolicyWindow() {
                const appName = 'è¥¿åŒ—æ‰“å¡';
                const policyHtml = `<!doctype html>
 <html lang="zh-Hant">
 <head>
   <meta charset="utf-8">
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <title>éš±ç§æ¬Šæ”¿ç­– - ${appName}</title>
   <style>
     body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans TC', 'Helvetica Neue', Arial, 'Microsoft JhengHei', sans-serif; margin: 0; padding: 24px; line-height: 1.7; color: #1f2937; }
     .container { max-width: 800px; margin: 0 auto; }
     h1 { font-size: 1.5rem; margin-bottom: 12px; }
     h2 { font-size: 1.1rem; margin-top: 20px; margin-bottom: 8px; }
     h3 { font-size: 1rem; margin-top: 14px; margin-bottom: 6px; }
     p { margin: 8px 0; }
     ul { margin: 8px 0 8px 20px; }
     .muted { color: #6b7280; font-size: 0.9rem; }
     .divider { height: 1px; background: #e5e7eb; margin: 16px 0; }
   </style>
   </head>
   <body>
     <div class="container">
       <h1>éš±ç§æ¬Šæ”¿ç­–</h1>
       <p>è¥¿åŒ—æ‰“å¡ (ä»¥ä¸‹ç°¡ç¨±ã€Œæœ¬æ‡‰ç”¨ç¨‹å¼ã€) å°Šé‡ä¸¦ä¿è­·æ‰€æœ‰ä½¿ç”¨æœå‹™ç”¨æˆ¶çš„å€‹äººéš±ç§æ¬Šã€‚ç‚ºäº†çµ¦æ‚¨æä¾›æ›´æº–ç¢ºã€æ›´æœ‰å€‹æ€§åŒ–çš„æœå‹™ï¼Œæœ¬æ‡‰ç”¨ç¨‹å¼æœƒæŒ‰ç…§æœ¬éš±ç§æ¬Šæ”¿ç­–çš„è¦å®šä½¿ç”¨å’ŒæŠ«éœ²æ‚¨çš„å€‹äººè³‡è¨Šã€‚ä½†æœ¬æ‡‰ç”¨ç¨‹å¼å°‡ä»¥é«˜åº¦çš„å‹¤å‹‰ã€å¯©æ…ç¾©å‹™å°å¾…é€™äº›è³‡è¨Šã€‚é™¤æœ¬éš±ç§æ¬Šæ”¿ç­–å¦æœ‰è¦å®šå¤–ï¼Œåœ¨æœªå¾µå¾—æ‚¨äº‹å…ˆè¨±å¯çš„æƒ…æ³ä¸‹ï¼Œæœ¬æ‡‰ç”¨ç¨‹å¼ä¸æœƒå°‡é€™äº›è³‡è¨Šå°å¤–æŠ«éœ²æˆ–å‘ç¬¬ä¸‰æ–¹æä¾›ã€‚æœ¬æ‡‰ç”¨ç¨‹å¼æœƒä¸æ™‚æ›´æ–°æœ¬éš±ç§æ¬Šæ”¿ç­–ã€‚ æ‚¨åœ¨åŒæ„æœ¬æ‡‰ç”¨ç¨‹å¼æœå‹™ä½¿ç”¨å”è­°ä¹‹æ™‚ï¼Œå³è¦–ç‚ºæ‚¨å·²ç¶“åŒæ„æœ¬éš±ç§æ¬Šæ”¿ç­–å…¨éƒ¨å…§å®¹ã€‚</p>
       <p class="muted">ç”Ÿæ•ˆæ—¥æœŸï¼š 2025å¹´10æœˆ07æ—¥</p>

       <h2>1. è³‡è¨Šæ”¶é›†èˆ‡ä½¿ç”¨</h2>
       <p>ç‚ºäº†è®“æœ¬æ‡‰ç”¨ç¨‹å¼æ­£å¸¸é‹ä½œä¸¦æä¾›æ‚¨æ‰€éœ€çš„åŠŸèƒ½ï¼Œæˆ‘å€‘éœ€è¦è«‹æ±‚ä»¥ä¸‹æ¬Šé™ï¼Œä¸¦æ”¶é›†ç›¸é—œè³‡è¨Šï¼š</p>

       <h3>ç›¸æ©Ÿ (Camera) æ¬Šé™ï¼š</h3>
       <p>æœ¬æ‡‰ç”¨ç¨‹å¼éœ€è¦å­˜å–æ‚¨è£ç½®çš„ç›¸æ©Ÿã€‚æ­¤æ¬Šé™åƒ…ç”¨æ–¼ [è«‹åœ¨æ­¤è™•æ˜ç¢ºèªªæ˜ä½¿ç”¨ç›¸æ©Ÿçš„ç›®çš„ï¼Œä¾‹å¦‚ï¼šæƒæ QR Codeã€æ‹ç…§ä¸Šå‚³ç­‰]ã€‚æˆ‘å€‘ä¸æœƒåœ¨æ‚¨ä¸çŸ¥æƒ…çš„æƒ…æ³ä¸‹é–‹å•Ÿç›¸æ©Ÿï¼Œæ‰€æ‹æ”çš„ç…§ç‰‡æˆ–å½±ç‰‡åƒ…æœƒåœ¨æ‚¨çš„æ“ä½œä¸‹é€²è¡Œè™•ç†ï¼Œæˆ‘å€‘ä¸æœƒå„²å­˜æˆ–åˆ†äº«é€™äº›å…§å®¹ï¼Œé™¤éå¾—åˆ°æ‚¨çš„æ˜ç¢ºåŒæ„ã€‚</p>

       <h3>ç²¾ç¢ºä½ç½® (Precise Location) æ¬Šé™ï¼š</h3>
       <p>æœ¬æ‡‰ç”¨ç¨‹å¼éœ€è¦ç²å–æ‚¨è£ç½®çš„ç²¾ç¢ºä½ç½®è³‡è¨Š (GPS å’Œç¶²è·¯åŸºç¤)ã€‚æ­¤æ¬Šé™åƒ…ç”¨æ–¼ [è«‹åœ¨æ­¤è™•æ˜ç¢ºèªªæ˜ä½¿ç”¨å®šä½çš„ç›®çš„ï¼Œä¾‹å¦‚ï¼šåœ°åœ–å°èˆªã€ç´€éŒ„æ‰“å¡åœ°é»ç­‰]ã€‚æ‚¨çš„ä½ç½®è³‡è¨Šå°‡ç”¨æ–¼æå‡æ‚¨çš„ä½¿ç”¨è€…é«”é©—ï¼Œæˆ‘å€‘ä¸æœƒå°‡æ‚¨çš„ä½ç½®è³‡è¨Šç”¨æ–¼æœ¬åŠŸèƒ½ä»¥å¤–çš„å…¶ä»–ç›®çš„ï¼Œä¹Ÿä¸æœƒèˆ‡ä»»ä½•ç¬¬ä¸‰æ–¹åˆ†äº«æ‚¨çš„å€‹äººè»Œè·¡ã€‚</p>

       <p>æœ¬æ‡‰ç”¨ç¨‹å¼ä¸æœƒæ”¶é›†èˆ‡ä¸Šè¿°åŠŸèƒ½ç„¡é—œçš„ä»»ä½•å…¶ä»–å€‹äººå¯è­˜åˆ¥è³‡è¨Šã€‚</p>

       <h2>2. è³‡è¨ŠæŠ«éœ²</h2>
       <p>åœ¨å¦‚ä¸‹æƒ…æ³ä¸‹ï¼Œæœ¬æ‡‰ç”¨ç¨‹å¼å°‡ä¾æ“šæ‚¨çš„å€‹äººæ„é¡˜æˆ–æ³•å¾‹çš„è¦å®šå…¨éƒ¨æˆ–éƒ¨åˆ†åœ°æŠ«éœ²æ‚¨çš„å€‹äººè³‡è¨Šï¼š</p>
       <ul>
         <li>a) ç¶“æ‚¨äº‹å…ˆåŒæ„ï¼Œå‘ç¬¬ä¸‰æ–¹æŠ«éœ²ï¼›</li>
         <li>b) ç‚ºæä¾›æ‚¨æ‰€è¦æ±‚çš„ç”¢å“å’Œæœå‹™ï¼Œè€Œå¿…é ˆå’Œç¬¬ä¸‰æ–¹åˆ†äº«æ‚¨çš„å€‹äººè³‡è¨Šï¼›</li>
         <li>c) æ ¹æ“šæ³•å¾‹çš„æœ‰é—œè¦å®šï¼Œæˆ–è€…è¡Œæ”¿æˆ–å¸æ³•æ©Ÿæ§‹çš„è¦æ±‚ï¼Œå‘ç¬¬ä¸‰æ–¹æˆ–è€…è¡Œæ”¿ã€å¸æ³•æ©Ÿæ§‹æŠ«éœ²ï¼›</li>
       </ul>

       <h2>3. è³‡è¨Šå®‰å…¨</h2>
       <p>æˆ‘å€‘è‡´åŠ›æ–¼ä¿è­·æ‚¨çš„è³‡è¨Šå®‰å…¨ã€‚æˆ‘å€‘æ¡å–äº†é©ç•¶çš„ç®¡ç†ã€æŠ€è¡“å’Œå¯¦é«”å®‰å…¨æªæ–½ä¾†ä¿è­·æ‚¨çš„è³‡è¨Šï¼Œé˜²æ­¢æœªç¶“æˆæ¬Šçš„å­˜å–ã€ä½¿ç”¨ã€æŠ«éœ²ã€ä¿®æ”¹æˆ–éŠ·æ¯€ã€‚</p>

       <h2>4. å…’ç«¥éš±ç§</h2>
       <p>æˆ‘å€‘çš„æœå‹™ä¸é‡å°ä»»ä½•æœªæ»¿ 13 æ­²çš„å…’ç«¥ã€‚æˆ‘å€‘ä¸æœƒæ•…æ„æ”¶é›† 13 æ­²ä»¥ä¸‹å…’ç«¥çš„å€‹äººå¯è­˜åˆ¥è³‡è¨Šã€‚</p>

       <h2>5. éš±ç§æ¬Šæ”¿ç­–çš„è®Šæ›´</h2>
       <p>æˆ‘å€‘å¯èƒ½æœƒä¸æ™‚æ›´æ–°æˆ‘å€‘çš„éš±ç§æ¬Šæ”¿ç­–ã€‚å› æ­¤ï¼Œæˆ‘å€‘å»ºè­°æ‚¨å®šæœŸæŸ¥çœ‹æ­¤é é¢ä»¥äº†è§£ä»»ä½•è®Šæ›´ã€‚æˆ‘å€‘å°‡é€šéåœ¨æ­¤é é¢ä¸Šç™¼å¸ƒæ–°çš„éš±ç§æ¬Šæ”¿ç­–ä¾†é€šçŸ¥æ‚¨ä»»ä½•è®Šæ›´ã€‚</p>

       <h2>6. è¯çµ¡æˆ‘å€‘</h2>
       <p>å¦‚æœæ‚¨å°æˆ‘å€‘çš„éš±ç§æ¬Šæ”¿ç­–æœ‰ä»»ä½•ç–‘å•æˆ–å»ºè­°ï¼Œè«‹éš¨æ™‚èˆ‡æˆ‘å€‘è¯çµ¡ã€‚ é›»å­éƒµä»¶:nwcom.eason@gmail.com</p>
      </div>
    </body>
  </html>`;

                // å„ªå…ˆé–‹å•Ÿç¨ç«‹é é¢ï¼Œä½¿ç”¨çµ•å°ç¶²å€é¿å…ç›¸å°è·¯å¾‘è§£æå•é¡Œ
                const url = (window.location && window.location.origin ? window.location.origin : '') + '/privacy.html';
                const win = window.open(url, '_blank', 'width=800,height=900');
                if (win) {
                    try {
                        win.document.open();
                        win.document.write(policyHtml);
                        win.document.close();
                        return;
                    } catch (e) {
                        console.error('å¯«å…¥éš±ç§æ¬Šæ”¿ç­–è¦–çª—å…§å®¹å¤±æ•—:', e);
                    }
                }
                if (!win) {
                    // å¾Œå‚™æ–¹æ¡ˆï¼šä»¥ç«™å…§å½ˆçª—å‘ˆç¾
                    const modalId = `privacy-modal-${Date.now()}`;
                    const contentOnly = policyHtml.replace(/^[\s\S]*<body[^>]*>/i, '').replace(/<\/body>[\s\S]*$/i, '');
                    const modalHTML = `
                        <div id="${modalId}" class="modal-backdrop" style="overflow:auto;">
                          <div class="modal-content w-[95%] max-w-[900px] bg-white rounded-lg shadow-xl flex flex-col">
                            <div class="flex justify-between items-center p-4 border-b">
                              <h3 class="font-bold text-lg">éš±ç§æ¬Šæ”¿ç­– - è¥¿åŒ—æ‰“å¡</h3>
                              <button class="close-btn text-gray-500 hover:text-gray-700">
                                <i data-lucide="x" class="w-5 h-5"></i>
                              </button>
                            </div>
                            <div class="p-4 overflow-y-auto" style="max-height: 80vh;">
                              ${contentOnly}
                            </div>
                          </div>
                        </div>`;
                    document.body.insertAdjacentHTML('beforeend', modalHTML);
                    const backdrop = document.getElementById(modalId);
                    const closeBtn = backdrop.querySelector('.close-btn');
                    const close = () => backdrop.remove();
                    closeBtn.addEventListener('click', close);
                    backdrop.addEventListener('click', (e) => { if (e.target.id === modalId) close(); });
                    lucide.createIcons();
                }
            }


            function openAvatarCameraModal(callback) {
                const modalId = `avatar-camera-modal-${Date.now()}`;
                let videoStream;
                
                const stopCamera = () => {
                    if (videoStream) videoStream.getTracks().forEach(track => track.stop());
                };
                const close = () => {
                    stopCamera();
                    document.getElementById(modalId)?.remove();
                };

                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop" style="z-index: 60;">
                        <div class="modal-content w-[90%] max-w-md bg-black rounded-lg shadow-xl flex flex-col p-4 text-white">
                            <video id="avatar-video" playsinline autoplay muted class="w-full h-auto rounded-lg"></video>
                            <canvas id="avatar-canvas" class="hidden"></canvas>
                            <div class="flex justify-center mt-4">
                                <button id="avatar-capture-btn" class="w-16 h-16 bg-white rounded-full border-4 border-gray-500"></button>
                            </div>
                             <button id="avatar-cancel-btn" class="text-gray-400 mt-2">å–æ¶ˆ</button>
                        </div>
                    </div>`;
                document.body.insertAdjacentHTML('beforeend', modalHTML);

                const video = document.getElementById('avatar-video');
                const canvas = document.getElementById('avatar-canvas');

                navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false })
                    .then(stream => {
                        videoStream = stream;
                        video.muted = true;
                        video.srcObject = stream;
                        Promise.resolve(video.play()).catch(err => {
                            console.warn("avatar video.play() failed:", err);
                        });
                    }).catch(async err => {
                        console.warn("avatar camera first attempt failed:", err);
                        try {
                            const fallbackStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                            videoStream = fallbackStream;
                            video.muted = true;
                            video.srcObject = fallbackStream;
                            try { await Promise.resolve(video.play()); } catch (e) { console.warn("avatar fallback video.play() failed:", e); }
                        } catch (err2) {
                            showToast("ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿï¼Œè«‹æˆæ¬Šæˆ–æª¢æŸ¥è£ç½®", true);
                            close();
                        }
                    });

                document.getElementById('avatar-capture-btn').addEventListener('click', () => {
                    const context = canvas.getContext('2d');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    canvas.toBlob(blob => {
                        callback(blob);
                        close();
                    }, 'image/jpeg');
                });
                document.getElementById('avatar-cancel-btn').addEventListener('click', close);
            }

            function openCameraModal(type, location) {
                 const modalId = `camera-modal-${Date.now()}`;
                let videoStream;
    const capturedPhotos = []; // { blob, description }
    let handleEsc;

    const stopCamera = () => {
        try {
            // åœæ­¢ç›®å‰è¨˜éŒ„çš„ä¸²æµ tracks
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }
            // è‹¥ video.srcObject ä»æ›è¼‰ä¸²æµï¼Œä¿éšªåœ°åœæ­¢å…¶ tracks
            if (video && video.srcObject && typeof video.srcObject.getTracks === 'function') {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
        } catch (_) {}
        try {
            if (video) {
                video.pause();
                video.srcObject = null;
            }
        } catch (_) {}
        videoStream = null;
    };

                const close = () => {
                    stopCamera();
                    try { if (handleEsc) document.removeEventListener('keydown', handleEsc); } catch(_) {}
                    document.getElementById(modalId)?.remove();
                };

                const modalHTML = `
                    <div id="${modalId}" class="modal-backdrop">
                        <div class="modal-content w-[390px] h-[730px] bg-black rounded-2xl shadow-xl flex flex-col p-4 text-white">
                            <div id="camera-view" class="flex-grow relative flex items-center justify-center">
                                <video id="camera-video" playsinline autoplay muted class="w-full h-full object-cover rounded-lg"></video>
                                <canvas id="camera-canvas" class="hidden"></canvas>
                                <div id="camera-loader" class="absolute inset-0 flex items-center justify-center bg-black/50 pointer-events-none"><div class="loader"></div></div>
                            </div>
                            <div id="preview-view" class="hide flex-grow flex flex-col">
                                <img id="photo-preview" class="w-full h-auto flex-grow object-contain rounded-lg">
                                <input type="text" id="photo-description" class="w-full mt-2 bg-gray-800 border border-gray-600 rounded-md px-3 py-2" placeholder="è¼¸å…¥èªªæ˜ (30å­—å…§)" maxlength="30">
                            </div>

                            <div class="flex-shrink-0 pt-4">
                                <div id="capture-controls" class="flex items-center justify-center gap-6 relative" style="z-index: 999;">
                                    <button id="switch-camera-btn" class="w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center" style="display:none;">
                                        <i data-lucide="refresh-cw" class="w-6 h-6"></i>
                                    </button>
                        <button id="capture-btn" class="w-24 h-24 bg-white rounded-full border-4 border-gray-500 flex items-center justify-center" style="z-index: 1000;">
                                        <i data-lucide="camera" class="w-10 h-10 text-gray-800"></i>
                                    </button>
                                </div>
                                <div id="confirm-controls" class="hide grid grid-cols-2 gap-2">
                                    <button id="add-another-btn" class="py-3 bg-gray-600 rounded-lg">æ‹ä¸‹ä¸€å¼µ</button>
                                    <button id="finish-btn" class="py-3 bg-red-600 rounded-lg font-semibold">å®Œæˆæ‰“å¡</button>
                                </div>
                            </div>
                             <div class="flex-shrink-0 text-center pt-2">
                                <button id="cancel-camera-btn" class="text-gray-400">å–æ¶ˆ</button>
                            </div>
                        </div>
                    </div>
                `;
                modalContainer.innerHTML = modalHTML;
                // å…è¨±é»æ“Šé®ç½©æˆ–æŒ‰ ESC é—œé–‰ï¼ˆä¸¦åœæ­¢ç›¸æ©Ÿï¼‰
                const backdrop = document.getElementById(modalId);
                if (backdrop) {
                    backdrop.addEventListener('click', (e) => { if (e.target && e.target.id === modalId) close(); });
                }
                handleEsc = (e) => { if (e.key === 'Escape') close(); };
                try { document.addEventListener('keydown', handleEsc); } catch(_) {}

                const video = document.getElementById('camera-video');
                const canvas = document.getElementById('camera-canvas');
                const cameraView = document.getElementById('camera-view');
                const previewView = document.getElementById('preview-view');
                const photoPreview = document.getElementById('photo-preview');
                const descriptionInput = document.getElementById('photo-description');
                const captureControls = document.getElementById('capture-controls');
                const confirmControls = document.getElementById('confirm-controls');
                // èª¿æ•´å¿«é–€ç‚ºæ©¢åœ“ï¼ˆåŠ å¯¬ä¸åŠ é«˜ï¼‰
                try {
                    const captureBtnEl = document.getElementById('capture-btn');
                    if (captureBtnEl && captureBtnEl.classList) {
                        captureBtnEl.classList.remove('w-24');
                        captureBtnEl.classList.add('w-36');
                    }
                } catch(_) {}

                // å¼·åˆ¶ä½¿ç”¨å‰é¡é ­ï¼ˆè‡ªæ‹ï¼‰
                let currentFacingMode = "user";
                const setupStream = async (stream) => {
                    videoStream = stream;
                    video.muted = true;
                    video.srcObject = stream;
                    try { await Promise.resolve(video.play()); } catch (e) { console.warn("camera video.play() failed:", e); }
                    const camLoaderEl = document.getElementById('camera-loader');
                    if (camLoaderEl && camLoaderEl.classList) { camLoaderEl.classList.add('hide'); }
                    lucide.createIcons();
                };

                navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: "user" } }, audio: false })
                    .then(stream => setupStream(stream))
                    .catch((err) => {
                        console.error("å‰é¡é ­é–‹å•Ÿå¤±æ•—:", err);
                        showToast("ç„¡æ³•é–‹å•Ÿå‰é¡é ­ï¼Œè«‹æˆæ¬Šæˆ–æª¢æŸ¥è£ç½®", true);
                        close();
                        return;
                    });

                const switchBtn = document.getElementById('switch-camera-btn');
                if (switchBtn) { switchBtn.style.display = 'none'; }

                document.getElementById('capture-btn').addEventListener('click', () => {
                    const context = canvas.getContext('2d');
                    // è¨­ç½®å›ºå®šå¯¬åº¦ï¼Œä½†ä¿æŒåŸå§‹æ¯”ä¾‹
                    const videoWidth = video.videoWidth;
                    const videoHeight = video.videoHeight;
                    const targetWidth = 390;
                    const targetHeight = (videoHeight / videoWidth) * targetWidth;
                    
                    canvas.width = targetWidth;
                    canvas.height = targetHeight;
                    
                    // ç¹ªè£½ä¸¦ä¿æŒåŸå§‹æ¯”ä¾‹
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    // æ·»åŠ æµ®æ°´å°
                    context.font = '16px Arial';
                    context.fillStyle = 'rgba(255, 255, 255, 0.7)';
                    const now = new Date();
                    const dateTimeText = `${now.toLocaleDateString('zh-TW')} ${now.toLocaleTimeString('zh-TW',{ hour12: false })}`;
                const locationText = (state.currentLocation && typeof state.currentLocation.lat === 'number' && typeof state.currentLocation.lng === 'number') ? `ä½ç½®: ${state.currentLocation.lat.toFixed(6)}, ${state.currentLocation.lng.toFixed(6)}` : 'ç„¡ä½ç½®è³‡è¨Š';
                    const userText = `${state.currentUserData.name} - ${type}æ‰“å¡`;
                    
                    // åœ¨åº•éƒ¨æ·»åŠ æµ®æ°´å°
                    context.fillText(dateTimeText, 10, canvas.height - 40);
                    context.fillText(locationText, 10, canvas.height - 20);
                    context.fillText(userText, 10, canvas.height - 60);
                    
                    photoPreview.src = canvas.toDataURL('image/jpeg');
                    cameraView.classList.add('hide');
                    previewView.classList.remove('hide');
                    captureControls.classList.add('hide');
                    confirmControls.classList.remove('hide');
                });
                
                const saveAndPrepareNext = () => {
                     canvas.toBlob(blob => {
                        if (!blob) {
                            showToast("ç…§ç‰‡è™•ç†å¤±æ•—", true);
                            return;
                        }
                        const description = descriptionInput.value;
                        capturedPhotos.push({ blob, description });
                        
                        descriptionInput.value = '';
                        cameraView.classList.remove('hide');
                        previewView.classList.add('hide');
                        captureControls.classList.remove('hide');
                        confirmControls.classList.add('hide');
                        showToast(`å·²å„²å­˜ ${capturedPhotos.length} å¼µç…§ç‰‡`);

                     }, 'image/jpeg', 0.8);
                };

                document.getElementById('add-another-btn').addEventListener('click', saveAndPrepareNext);

                document.getElementById('finish-btn').addEventListener('click', () => {
                    if (previewView.classList.contains('hide') === false) {
                         canvas.toBlob((blob) => {
                            if (blob) {
                                const description = descriptionInput.value;
                                capturedPhotos.push({ blob, description });
                            }
                            completeClockIn();
                         }, 'image/jpeg', 0.8);
                    } else {
                        completeClockIn();
                    }
                });

                const completeClockIn = async () => {
                    if (capturedPhotos.length === 0) {
                        showToast("è«‹è‡³å°‘æ‹æ”ä¸€å¼µç…§ç‰‡", true);
                        return;
                    }
                    stopCamera();
                    showLoading(true);

                    try {
                        // åƒ…å…è¨±å®‰å…¨è¦å‰‡ä¸­çš„æ‰“å¡é¡å‹
                        const allowedTypes = ['ä¸Šç­','ä¸‹ç­'];
                        if (!allowedTypes.includes(type)) {
                            console.warn('ä¸å…è¨±çš„æ‰“å¡é¡å‹ï¼Œå·²å–æ¶ˆå¯«å…¥ï¼š', type);
                            showToast('æ­¤æ‰“å¡é¡å‹ä¸æ”¯æ´ç´€éŒ„å¯«å…¥ï¼Œè«‹æ”¹ç”¨å°æ‡‰åŠŸèƒ½', true);
                            return;
                        }

  // å‹¤å‹™æ™‚é–“æª¢æŸ¥ï¼šé–‹å§‹å‰ç¦æ­¢æ‰“å¡ï¼ŒçµæŸå¾Œæ¨™è¨˜é€¾æ™‚
                        const toDate = v => v?.toDate ? v.toDate() : (v ? new Date(v) : null);
                        const dutyStart = toDate(state.currentUserData?.dutyStartTime);
                        const dutyEnd = toDate(state.currentUserData?.dutyEndTime);
                        const restrictedTypes = ['å¤–å‡º','æŠµé”','é›¢é–‹'];
                        let isOvertime = false;
                        if (restrictedTypes.includes(type) && (dutyStart || dutyEnd)) {
                            const now = new Date();
                            if (dutyStart && now < dutyStart) {
                                showToast(`å‹¤å‹™å°šæœªé–‹å§‹ï¼ˆ${dutyStart.toLocaleString('zh-TW', { hour12: false })}ï¼‰ï¼Œä¸å¯æ‰“å¡`, true);
                                return;
                            }
                            if (dutyEnd && now > dutyEnd) {
                                isOvertime = true;
                            }
                        }

                        // ä¸Šå‚³ç…§ç‰‡åˆ° Cloud Storageï¼›è‹¥åœ¨ GitHub Pages æˆ–é‡åˆ° CORS/ç¶²è·¯å•é¡Œå‰‡å›é€€ç‚ºå£“ç¸®å¾Œçš„ Data URL å¯«å…¥ Firestore
                        const storageInst = window.__storage;
                        const uploadTargets = capturedPhotos.slice(0, 3);
                        let photoUrls = [];
                        let descriptions = [];
                        const isGithubPages = /\.github\.io$/i.test(window.location.hostname);
                        const compressBlobToDataURL = async (blob, maxWidth = 800, quality = 0.6) => {
                            try {
                                const imgBitmap = await createImageBitmap(blob);
                                const ratio = imgBitmap.height / imgBitmap.width;
                                const canvasEl = document.createElement('canvas');
                                canvasEl.width = maxWidth;
                                canvasEl.height = Math.round(maxWidth * ratio);
                                const ctx = canvasEl.getContext('2d');
                                ctx.drawImage(imgBitmap, 0, 0, canvasEl.width, canvasEl.height);
                                return canvasEl.toDataURL('image/jpeg', quality);
                            } catch (_) {
                                return await new Promise((resolve) => {
                                    const reader = new FileReader();
                                    reader.onloadend = () => resolve(reader.result);
                                    reader.readAsDataURL(blob);
                                });
                            }
                        };
                        const useStorage = !!storageInst && !isGithubPages;
                        if (useStorage) {
                            try {
                                const uploadedPhotos = await Promise.all(uploadTargets.map(async (photo, idx) => {
                                    const nowMs = Date.now();
                                    const ext = (photo.blob && typeof photo.blob.type === 'string' && photo.blob.type.includes('png')) ? 'png' : 'jpg';
                                    const uidForPath = window.__auth?.currentUser?.uid || state.currentUser?.uid || 'unknown-user';
                                    const path = `clock-in/${uidForPath}/${nowMs}_${idx}.${ext}`;
                                    const storageRef = ref(storageInst, path);
                                    const metadata = (photo.blob && photo.blob.type) ? { contentType: photo.blob.type } : undefined;
                                    await uploadBytes(storageRef, photo.blob, metadata);
                                    const url = await getDownloadURL(storageRef);
                                    return { url, description: photo.description };
                                }));
                                photoUrls = uploadedPhotos.map(p => p.url);
                                descriptions = uploadedPhotos.map(p => (typeof p.description === 'string' ? p.description : ''));
                            } catch (uploadErr) {
                                console.warn('ç…§ç‰‡ä¸Šå‚³è‡³ Storage å¤±æ•—ï¼Œæ”¹ç”¨å£“ç¸®å¾Œçš„ Data URLï¼š', uploadErr);
                                const fallbackPhotos = await Promise.all(uploadTargets.map(async (photo) => {
                                    const url = await compressBlobToDataURL(photo.blob, 640, 0.5);
                                    return { url, description: photo.description };
                                }));
                                photoUrls = fallbackPhotos.map(p => p.url);
                                descriptions = fallbackPhotos.map(p => (typeof p.description === 'string' ? p.description : ''));
                            }
                        } else {
                            console.info('åµæ¸¬åˆ° GitHub Pages ç¶²åŸŸæˆ–ç¼ºå°‘ Storageï¼Œç›´æ¥ä½¿ç”¨å£“ç¸®å¾Œçš„ Data URLã€‚');
                            const fallbackPhotos = await Promise.all(uploadTargets.map(async (photo) => {
                                const url = await compressBlobToDataURL(photo.blob, 640, 0.5);
                                return { url, description: photo.description };
                            }));
                            photoUrls = fallbackPhotos.map(p => p.url);
                            descriptions = fallbackPhotos.map(p => (typeof p.description === 'string' ? p.description : ''));
                        }

                        // å®‰å…¨åº§æ¨™è™•ç†ï¼šåƒ…æ¥å—æœ‰é™æ•¸å€¼ï¼Œå¦å‰‡å›é€€ (0,0)
                        const toFinite = (n) => (typeof n === 'number' && Number.isFinite(n)) ? n : 0;
                        const safeLat = toFinite(location?.lat);
                        const safeLng = toFinite(location?.lng);

                        const uid = window.__auth?.currentUser?.uid || state.currentUser?.uid;
                        if (!uid || !window.__auth?.currentUser) {
                            showToast('å°šæœªç™»å…¥æˆ–ç™»å…¥é€¾æ™‚ï¼Œè«‹é‡æ–°ç™»å…¥', true);
                            showLoading(false);
                            return;
                        }
                        const recordData = {
                            userId: uid,
                            type: type,
                            timestamp: Timestamp.now(),
                            location: new GeoPoint(safeLat, safeLng),
                            photoUrls,
                            descriptions,
                            deviceId: state.deviceId || 'unknown-device',
                            isAutomatic: false
                        };
                        // å‹¤å‹™é …ç›®ï¼šé¿å… undefined å¯«å…¥
                        if (type === 'å¤–å‡º' && state.dutyType) {
                            recordData.dutyType = state.dutyType;
                        }
                        
                        // å¦‚æœæ˜¯å¤–å‡ºæ‰“å¡ï¼Œæ·»åŠ åœ°é»åç¨±
                        if (type === 'å¤–å‡º') {
                            const locName = typeof location.name === 'string' ? location.name : '';
                            if (locName) {
                                recordData.locationName = locName.slice(0, 100);
                            }
                        }
                        
                        try {
                            const { addDoc, collection } = window.__fs;
                            const db2 = window.__db;
                            await addDoc(collection(db2, "clockInRecords"), recordData);
                        } catch (e) {
                            const expectedCodes = ['permission-denied','failed-precondition','invalid-argument'];
                            const logFn = expectedCodes.includes(e?.code) ? console.warn : console.error;
                            logFn('æ–°å¢ clockInRecords å¤±æ•—ï¼š', e?.code, e?.message || e, { keys: Object.keys(recordData), type: recordData.type, locationIsGeoPoint: recordData.location instanceof GeoPoint, photosLen: recordData.photoUrls.length, descLen: recordData.descriptions.length });
                            // ç•¶å‰æ¶æ§‹åƒ…ä¸Šç­/ä¸‹ç­ï¼šè‹¥ç„¡æ³•å»ºç«‹ç´€éŒ„ï¼Œå›é€€ç‚ºåƒ…æ›´æ–°ä½¿ç”¨è€…ç‹€æ…‹
                            if (expectedCodes.includes(e?.code)) {
                                try {
                                    const { updateDoc, doc } = window.__fs;
                                    const db2 = window.__db;
                                    const uid2 = window.__auth?.currentUser?.uid || state.currentUser?.uid;
                                    await updateDoc(doc(db2, "users", uid2), {
                                        status: type,
                                        clockInStatus: type,
                                        lastUpdated: Timestamp.now()
                                    });
                                    console.warn('ç„¡æ³•å»ºç«‹ clockInRecordsï¼Œå·²æ”¹ç‚ºåƒ…æ›´æ–°ä½¿ç”¨è€…ç‹€æ…‹');
                                } catch (e2) {
                                    console.error('å›é€€æ›´æ–°ä½¿ç”¨è€…ç‹€æ…‹å¤±æ•—ï¼š', e2);
                                    throw e;
                                }
                            } else {
                                throw e;
                            }
                        }

                        // é¦–æ¬¡æ‰“å¡è£ç½®IDå¯«å…¥ï¼šåƒ…ç•¶ä½¿ç”¨è€…å°šæœªæœ‰ firstClockInDeviceId
                        try {
                            const { doc, getDoc, updateDoc } = window.__fs;
                            const db2 = window.__db;
                            const uid3 = window.__auth?.currentUser?.uid || state.currentUser?.uid;
                            const userRef = doc(db2, "users", uid3);
                            const userSnap = await getDoc(userRef);
                            const hasFirst = userSnap.exists() && userSnap.data().firstClockInDeviceId;
                            if (!hasFirst && type === 'ä¸Šç­') {
                                await updateDoc(userRef, { firstClockInDeviceId: state.deviceId || 'unknown-device' });
                            }
                        } catch (e) {
                            console.warn('å¯«å…¥é¦–æ¬¡æ‰“å¡è£ç½®IDå¤±æ•—', e);
                        }

                        const userUpdateData = {
                            status: type,
                            clockInStatus: type,
                            lastUpdated: Timestamp.now()
                        };
                        
                        // å¦‚æœæ˜¯å¤–å‡ºæ‰“å¡ï¼Œæ·»åŠ å¤–å‡ºåœ°é»åç¨±
                        if (type === 'å¤–å‡º') {
                            const locName2 = typeof location.name === 'string' ? location.name : '';
                            if (locName2) {
                                userUpdateData.outboundLocation = locName2.slice(0, 100);
                            }
                        }
                        // å¤–å‡ºåŒæ­¥å‹¤å‹™é …ç›®ï¼ˆè‹¥æœ‰ï¼‰
                        if (type === 'å¤–å‡º' && state.dutyType) {
                            userUpdateData.dutyType = state.dutyType;
                        }
                        
                        try {
                            const { updateDoc, doc } = window.__fs;
                            const db2 = window.__db;
                            const uid2 = window.__auth?.currentUser?.uid || state.currentUser?.uid;
                            await updateDoc(doc(db2, "users", uid2), userUpdateData);
                        } catch (e) {
                            console.error('æ›´æ–° users ç‹€æ…‹å¤±æ•—ï¼š', e?.code, e?.message || e, { keys: Object.keys(userUpdateData) });
                            throw e;
                        }

                        // æ›´æ–°æœ¬åœ°ç‹€æ…‹
                        state.clockInStatus = type;
                        
                        // å·²å–æ¶ˆè‡ªå‹•ä¸‹ç­åŠŸèƒ½ï¼šä¸å•Ÿå‹•è‡ªå‹•ä¸‹ç­è¨ˆæ™‚å™¨
                        // if (type === 'ä¸Šç­' && typeof startAutoClockOutTimer === 'function') {
                        //     loadAutoClockOutSettings().then(() => {
                        //         startAutoClockOutTimer();
                        //     });
                        // }
                        
                        // å¦‚æœæ˜¯ä¸‹ç­æ‰“å¡ï¼Œåœæ­¢è‡ªå‹•ä¸‹ç­æ‰“å¡è¨ˆæ™‚å™¨
                        if (type === 'ä¸‹ç­' && typeof stopAutoClockOutTimer === 'function') {
                            stopAutoClockOutTimer();
                        }
                        
                        // æ›´æ–°é é¢é¡¯ç¤º
                        updateStatusDisplay();
                        // ä¿éšªï¼šç›´æ¥åˆ·æ–°å„€è¡¨æ¿ç‹€æ…‹ï¼ˆå³ä½¿æ‰“å¡é å€å¡Šä¸å­˜åœ¨ä¹Ÿæ›´æ–°ï¼‰
                        if (typeof updateDashboardStatus === 'function') {
                            try { updateDashboardStatus(); } catch (e) { console.warn('updateDashboardStatus åŸ·è¡Œå¤±æ•—', e); }
                        }
                        // ç«‹å³æ›´æ–°æŒ‰éˆ•ç‹€æ…‹ï¼Œç¢ºä¿é›¢é–‹/è¿”å›ç­‰å¾ªç’°æŒ‰éˆ•æ–‡å­—èˆ‡æ¨£å¼æ­£ç¢º
                        if (typeof updateButtonStatus === 'function') {
                            try { updateButtonStatus(); } catch (e) { console.warn('updateButtonStatus åŸ·è¡Œå¤±æ•—', e); }
                        }
                        
                        showToast(`${type}æ‰“å¡æˆåŠŸï¼`);
                        close();
                        try { if (typeof updateMyScheduleButtons === 'function') { updateMyScheduleButtons(); } } catch(_) {}
                        // ä¿ç•™ç•¶å‰é ï¼Œä¸å†è·³è½‰å®šä½æ‰“å¡

                    } catch (error) {
                        console.error("Clock in error:", error);
                        showToast("æ‰“å¡å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦", true);
                    } finally {
                        showLoading(false);
                        stopCamera();
                    }
                };

                document.getElementById('cancel-camera-btn').addEventListener('click', close);
            }

            // æ–°å¢ï¼šæˆ‘çš„ç­è¡¨åœ°åœ–æ‰“å¡æ¨¡æ…‹èˆ‡å…¨åŸŸäº‹ä»¶å§”æ´¾
            function openClockInMapModal(type) {
                const modalContainer = document.getElementById('modal-container');
                if (!modalContainer) return;
                const isStart = type === 'ä¸Šç­';
                modalContainer.innerHTML = `
                    <div class="modal-backdrop" id="clockin-map-overlay"></div>
                    <div class="modal-content p-0 overflow-hidden" style="width:80vw;height:80vh;transform:translate(-50%,-50%);border-radius:0;max-height:none;">
                        <div class="modal-header flex items-center justify-between bg-white border-b px-4 py-3">
                            <div class="font-semibold">${type}å®šä½æ‰“å¡</div>
                            <button class="modal-close text-gray-600 hover:text-gray-800" id="clockin-close-btn"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                        <div class="px-4 py-2 bg-gray-50 border-b">
                            <div id="map-range-status" class="text-sm text-gray-600">å®šä½ä¸­...</div>
                        </div>
                        <div id="map-container" class="relative" style="height: calc(80vh - 220px);">
                            <div id="map" class="map-canvas absolute inset-0"></div>
                            <div id="map-loader" class="absolute inset-0 bg-white/70 flex items-center justify-center"><div class="loader"></div></div>
                        </div>
                        <div class="modal-actions flex items-center gap-3 px-4 py-3 bg-white border-t" style="position:absolute;bottom:0;left:0;right:0;">
                            <button id="clockin-cancel-btn" class="px-3 py-2 rounded bg-gray-100">å–æ¶ˆ</button>
                            <button id="map-recenter-btn" class="flex-1 px-4 py-3 text-base bg-white border border-gray-300 rounded hover:bg-gray-100">é‡æ–°å®šä½</button>
                            <button id="clockin-confirm-btn" data-type="${type}" class="flex-1 px-4 py-3 text-base rounded ${isStart ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'} text-white">${type}æ‰“å¡</button>
                        </div>
                    </div>`;
                modalContainer.classList.add('show');
                try { lucide.createIcons(); } catch (e) {}
                
                const closeMap = () => { modalContainer.classList.remove('show'); modalContainer.innerHTML = ''; };
                const overlay = document.getElementById('clockin-map-overlay');
                overlay && overlay.addEventListener('click', closeMap);
                const cancelBtn = document.getElementById('clockin-cancel-btn');
                cancelBtn && cancelBtn.addEventListener('click', closeMap);
                const closeBtn = document.getElementById('clockin-close-btn');
                closeBtn && closeBtn.addEventListener('click', closeMap);
                const confirmBtn = document.getElementById('clockin-confirm-btn');
                confirmBtn && confirmBtn.addEventListener('click', () => {
                    if (!state.currentLocation) { alert('ç„¡æ³•å–å¾—ç›®å‰ä½ç½®ï¼Œè«‹ç¨å¾Œå†è©¦'); return; }
                    const t = confirmBtn.getAttribute('data-type');
                    openCameraModal(t, state.currentLocation);
                });
                
                const statusEl = document.getElementById('map-range-status');
                const recenterBtn = document.getElementById('map-recenter-btn');
                const mapDiv = document.getElementById('map');
                const loader = document.getElementById('map-loader');
                let map, marker, center = null, radius = null;
                
                const setStatus = (inside) => {
                    statusEl.textContent = inside ? 'å·²åœ¨ç¤¾å€æ‰“å¡ç¯„åœå…§' : 'è¶…å‡ºç¤¾å€æ‰“å¡ç¯„åœå¤–';
                    statusEl.className = inside ? 'text-green-600 text-sm' : 'text-red-600 text-sm';
                };
                
                async function computeCenterAndRadius() {
                    const c = state.currentCommunity || {};
                    if (typeof c.lat === 'number' && typeof c.lng === 'number') {
                        center = { lat: c.lat, lng: c.lng };
                        radius = (typeof c.radius === 'number' && c.radius > 0) ? c.radius : radius;
                    }
                    if (!center) {
                        try {
                            const { getDoc, doc } = window.__fs; const db = window.__db;
                            const docSnap = await getDoc(doc(db, 'settings', 'location'));
                            if (docSnap.exists()) {
                                const s = docSnap.data() || {};
                                if (typeof s.communityLat === 'number' && typeof s.communityLng === 'number') center = { lat: s.communityLat, lng: s.communityLng };
                                else if (typeof s.companyLat === 'number' && typeof s.companyLng === 'number') center = { lat: s.companyLat, lng: s.companyLng };
                                if (typeof s.companyRadius === 'number' && s.companyRadius > 0) radius = s.companyRadius;
                            }
                        } catch (_) {}
                    }
                }
                
                function updateInsideRange() {
                    if (!center || typeof radius !== 'number') {
                        statusEl.textContent = center ? 'æœªè¨­å®šæ‰“å¡ç¯„åœ' : 'å°šæœªå–å¾—ç¤¾å€ä¸­å¿ƒ';
                        statusEl.className = 'text-gray-600 text-sm';
                        return;
                    }
                    if (!state.currentLocation) { statusEl.textContent = 'å®šä½ä¸­...'; statusEl.className = 'text-gray-600 text-sm'; return; }
                    const dist = calculateDistanceMeters(state.currentLocation.lat, state.currentLocation.lng, center.lat, center.lng);
                    setStatus(dist <= radius);
                }
                
                async function initMap() {
                    await computeCenterAndRadius();
                    try {
                        const pos = await new Promise((resolve, reject) => navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }));
                        const coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                        state.currentLocation = coords;
                        map = new google.maps.Map(mapDiv, { center: coords, zoom: 17, disableDefaultUI: true, zoomControl: true });
                        marker = new google.maps.Marker({ position: coords, map });
                        if (center && typeof radius === 'number') {
                            try { state.clockinRadiusCircle && state.clockinRadiusCircle.setMap(null); } catch (_) {}
                            state.clockinRadiusCircle = new google.maps.Circle({ map, center, radius, strokeColor:'#FF0000', strokeOpacity:0.8, strokeWeight:2, fillColor:'#FF0000', fillOpacity:0.1 });
                        }
                        loader.classList.add('hide');
                        updateInsideRange();
                    } catch (err) {
                        loader.classList.add('hide');
                        mapDiv.innerHTML = '<div class="p-4 text-center text-red-600">ç„¡æ³•å–å¾—æ‚¨çš„ä½ç½®ã€‚è«‹ç¢ºèªå·²é–‹å•Ÿå®šä½æœå‹™ã€‚</div>';
                        showToast('ç„¡æ³•å–å¾—ä½ç½®è³‡è¨Šï¼Œè«‹ç¢ºèªå·²é–‹å•Ÿå®šä½æœå‹™', true);
                    }
                }
                
                async function refreshLocation() {
                    loader.classList.remove('hide');
                    try {
                        const pos = await new Promise((resolve, reject) => navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }));
                        const coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                        state.currentLocation = coords;
                        if (map) { map.panTo(coords); marker && marker.setPosition(coords); }
                        loader.classList.add('hide');
                        updateInsideRange();
                    } catch (e) {
                        loader.classList.add('hide');
                        showToast('é‡æ–°å®šä½å¤±æ•—', true);
                    }
                }
                
                recenterBtn && recenterBtn.addEventListener('click', refreshLocation);
                
                if (!window.google || !window.google.maps || !state.googleMapsLoaded) {
                    try { loadGoogleMapsScript(); } catch (_) {}
                    const iv = setInterval(() => { if (window.google && window.google.maps) { clearInterval(iv); initMap(); } }, 200);
                } else {
                    initMap();
                }
            }

            function updateMyScheduleButtons() {
                const panel = document.getElementById('myshift-day-panel');
                if (!panel) return;
                const status = state.clockInStatus || '';
                const setBtn = (btn, enabled, isStart) => {
                    const base = 'my-clock-btn px-4 py-2 text-base rounded-md';
                    // ä¿æŒèˆ‡ã€Œè«‹å‡ã€æŒ‰éˆ•ä¸€è‡´çš„å°ºå¯¸
                    if (enabled) {
                        btn.className = base + (isStart ? ' bg-green-600 text-white hover:bg-green-700' : ' bg-red-600 text-white hover:bg-red-700');
                        btn.disabled = false;
                        btn.classList.remove('cursor-not-allowed');
                    } else {
                        btn.className = base + ' bg-gray-300 text-gray-500 cursor-not-allowed';
                        btn.disabled = true;
                    }
                };
                panel.querySelectorAll('.my-clock-btn').forEach(btn => {
                    const type = btn.getAttribute('data-type');
                    if (type === 'ä¸Šç­') {
                        setBtn(btn, status !== 'ä¸Šç­', true);
                    } else if (type === 'ä¸‹ç­') {
                        setBtn(btn, status === 'ä¸Šç­', false);
                    }
                });
            }

            // å…¨åŸŸäº‹ä»¶å§”æ´¾ï¼šè™•ç†æˆ‘çš„ç­è¡¨æ‰“å¡æŒ‰éˆ•
            document.addEventListener('click', (e) => {
                const btn = e.target.closest('.my-clock-btn');
                if (!btn) return;
                if (btn.disabled || btn.classList.contains('cursor-not-allowed')) return;
                const t = btn.getAttribute('data-type');
                openClockInMapModal(t);
            });

            // --- Google Maps ---
            function loadGoogleMapsScript() {
                if (window.google && state.googleMapsLoaded) return;

                // å…¨åŸŸæ””æˆª Google Maps ä¾è³´è¼‰å…¥å¤±æ•—çš„æœªè™•ç†æ‹’çµ•ï¼Œé¿å… console å™´éŒ¯
                if (!window.__mapsUnhandledRejectionBound) {
                    window.__mapsUnhandledRejectionBound = true;
                    window.addEventListener('unhandledrejection', (event) => {
                        const reason = event && event.reason;
                        const msg = (reason && (reason.message || String(reason))) || '';
                        if (typeof msg === 'string' && msg.includes('Could not load "util"')) {
                            event.preventDefault();
                            console.warn('Google Maps ä¾è³´ util.js æœªè¼‰å…¥ï¼Œå·²å¿½ç•¥ã€‚');
                            try { showToast('åœ°åœ–éƒ¨åˆ†æ¨¡çµ„è¼‰å…¥å¤±æ•—ï¼ŒåŸºæœ¬åŠŸèƒ½ä»å¯ä½¿ç”¨'); } catch (_) {}
                        }
                    });
                }
                
                window.initMap = () => { 
                    state.googleMapsLoaded = true; 
                    console.log("Google Maps API å·²æˆåŠŸåŠ è¼‰");
                };
                
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&callback=initMap&v=weekly`;
                script.async = true;
                script.defer = true;
                
                script.onerror = () => {
                    console.error("Google Maps API åŠ è¼‰å¤±æ•—");
                    showToast("åœ°åœ–æœå‹™åŠ è¼‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥æˆ–APIé‡‘é‘°", true);
                };
                
                document.head.appendChild(script);
            }
            
            // --- Helper functions ---
            function cleanupListeners() {
                state.activeListeners.forEach(unsubscribe => unsubscribe());
                state.activeListeners = [];
            }

            // ç§»é™¤èˆŠçš„ getStatusColor å‡½æ•¸ï¼Œä½¿ç”¨ dashboard-functions.js ä¸­çš„ç‰ˆæœ¬
            
            // æ¸²æŸ“è«‹å‡è³‡è¨Šï¼ˆç¬¬äºŒå€‹ç‰ˆæœ¬ï¼Œä½¿ç”¨çµ±ä¸€çš„åˆ¤æ–·é‚è¼¯ï¼‰
            function renderLeaveInfo(userData) {
                if (!userData) return 'ç›®å‰æ²’æœ‰è«‹å‡è¨˜éŒ„';
                let isLeave = userData.clockInStatus === 'è‡¨æ™‚è«‹å‡';
                if (!isLeave && (userData.leaveStatus === 'approved' || userData.leaveStatus === 'pending')) {
                    const toDate = v => v?.toDate ? v.toDate() : (v ? new Date(v) : null);
                    const startTime = toDate(userData.leaveStartTime);
                    const endTime = toDate(userData.leaveEndTime);
                    const now = new Date();
                    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
                    isLeave = !!(startTime && endTime && startTime <= todayEnd && endTime >= todayStart);
                }
                if (!isLeave) {
                    // æª¢æŸ¥æ˜¯å¦ç‚ºç‰¹æ®Šå‹¤å‹™
                    if (userData.clockInStatus === 'ç‰¹æ®Šå‹¤å‹™') {
                        const dutyName = userData.dutyName || 'æœªæŒ‡å®šå‹¤å‹™';
                        const location = userData.dutyLocation || 'æœªæŒ‡å®šåœ°é»';
                        
                        let startTimeStr = 'æœªæŒ‡å®šæ™‚é–“';
                        let endTimeStr = 'æœªæŒ‡å®šæ™‚é–“';
                        
                        if (userData.dutyStartTime) {
                            const startTime = userData.dutyStartTime.toDate ? 
                                userData.dutyStartTime.toDate() : 
                                new Date(userData.dutyStartTime);
                            startTimeStr = startTime.toLocaleString('zh-TW', { hour12: false });
                        }
                        
                        if (userData.dutyEndTime) {
                            const endTime = userData.dutyEndTime.toDate ? 
                                userData.dutyEndTime.toDate() : 
                                new Date(userData.dutyEndTime);
                            endTimeStr = endTime.toLocaleString('zh-TW', { hour12: false });
                        }
                        
                        return `
                            <div class="font-semibold text-lg">åŸ·è¡Œç‰¹æ®Šå‹¤å‹™</div>
                            <div class="mt-2">
                                <p><span class="font-medium">å‹¤å‹™åç¨±ï¼š</span>${dutyName}</p>
                                <p><span class="font-medium">å‹¤å‹™åœ°é»ï¼š</span>${location}</p>
                                <p><span class="font-medium">é–‹å§‹æ™‚é–“ï¼š</span>${startTimeStr}</p>
                                <p><span class="font-medium">çµæŸæ™‚é–“ï¼š</span>${endTimeStr}</p>
                            </div>
                        `;
                    }
                    return 'ç›®å‰æ²’æœ‰è«‹å‡è¨˜éŒ„';
                }
                const leaveStatus = userData.leaveStatus === 'approved' ? 'å·²è«‹å‡' : 'è«‹å‡ç”³è«‹';
                const reason = userData.leaveReason || 'æœªæŒ‡å®šåŸå› ';
                
                const toDate = v => v?.toDate ? v.toDate() : (v ? new Date(v) : null);
                const startTime = toDate(userData.leaveStartTime);
                const endTime = toDate(userData.leaveEndTime);
                const startTimeStr = startTime ? startTime.toLocaleString('zh-TW', { hour12: false }) : 'æœªæŒ‡å®šæ™‚é–“';
                const endTimeStr = endTime ? endTime.toLocaleString('zh-TW', { hour12: false }) : 'æœªæŒ‡å®šæ™‚é–“';
                
                return `
                    <div class="font-semibold text-lg">${leaveStatus}</div>
                    <div class="mt-2">
                        <p><span class="font-medium">äº‹ç”±ï¼š</span>${reason}</p>
                        <p><span class="font-medium">é–‹å§‹æ™‚é–“ï¼š</span>${startTimeStr}</p>
                        <p><span class="font-medium">çµæŸæ™‚é–“ï¼š</span>${endTimeStr}</p>
                    </div>
                `;
            }
            

            function showToast(message, isError = false) {
                toast.textContent = message;
                toast.className = `toast show ${isError ? 'bg-red-500' : 'bg-gray-800'}`;
                setTimeout(() => {
                    toast.className = 'toast';
                }, 3000);
            }
            // ä½¿å…¨åŸŸå¯ç”¨ï¼Œä»¥ä¾›å…¶ä»–è…³æœ¬å‘¼å«
            window.showToast = showToast;
            function openVoiceCallModal(targetUserId, stream) {
                const backdrop = document.createElement('div');
                backdrop.id = 'voice-call-backdrop';
                backdrop.className = 'fixed inset-0 bg-black bg-opacity-50 z-40';

                const modal = document.createElement('div');
                modal.id = 'voice-call-modal';
                modal.className = 'fixed inset-0 flex items-center justify-center z-50';

                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-lg w-96 p-4';

                const title = document.createElement('h3');
                title.className = 'text-lg font-semibold mb-2';
                const target = (window.state?.users || []).find(u => u.id === targetUserId);
                title.textContent = `èªéŸ³é€šè©±ï¼š${target?.name || target?.email || targetUserId}`;

                const statusEl = document.createElement('div');
                statusEl.className = 'text-sm text-gray-600 mb-3';
                statusEl.textContent = 'åˆå§‹åŒ–éº¥å…‹é¢¨â€¦';

                const audio = document.createElement('audio');
                audio.autoplay = true;
                audio.className = 'w-full mb-3';

                const controls = document.createElement('div');
                controls.className = 'grid grid-cols-2 gap-2';

                const muteBtn = document.createElement('button');
                muteBtn.className = 'px-3 py-2 rounded-md bg-gray-200 text-gray-700';
                muteBtn.textContent = 'éœéŸ³';

                const endBtn = document.createElement('button');
                endBtn.className = 'px-3 py-2 rounded-md bg-red-500 text-white';
                endBtn.textContent = 'çµæŸé€šè©±';

                controls.appendChild(muteBtn);
                controls.appendChild(endBtn);

                card.appendChild(title);
                card.appendChild(statusEl);
                card.appendChild(audio);
                card.appendChild(controls);
                modal.appendChild(card);
                document.body.appendChild(backdrop);
                document.body.appendChild(modal);

                function close() {
                    try {
                        if (audio.srcObject) {
                            audio.srcObject.getTracks().forEach(t => t.stop());
                            audio.srcObject = null;
                        }
                    } catch (e) {}
                    backdrop.remove();
                    modal.remove();
                }
                backdrop.addEventListener('click', close);
                endBtn.addEventListener('click', close);

                let muted = false;
                muteBtn.addEventListener('click', () => {
                    muted = !muted;
                    muteBtn.textContent = muted ? 'å–æ¶ˆéœéŸ³' : 'éœéŸ³';
                    const track = audio.srcObject && audio.srcObject.getAudioTracks()[0];
                    if (track) track.enabled = !muted;
                });

                if (stream) {
                    audio.srcObject = stream;
                    statusEl.textContent = 'éº¥å…‹é¢¨å·²å•Ÿå‹•ï¼ˆåƒ…æœ¬æ©Ÿæ’­æ”¾ï¼Œå°šæœªé€£ç·šï¼‰';
                } else {
                    statusEl.textContent = 'ç„¡æ³•å–å¾—éº¥å…‹é¢¨ä¸²æµ';
                }
            }

            async function startVoiceCall(targetUserId) {
                // Secure context check for microphone APIs
                if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                    console.warn('éå®‰å…¨ä¾†æºï¼Œéº¥å…‹é¢¨å¯èƒ½ç„¡æ³•å•Ÿç”¨');
                    showToast('æç¤ºï¼šè«‹ä»¥ https æˆ– localhost é–‹å•Ÿä»¥ä½¿ç”¨èªéŸ³é€šè©±', true);
                }
                try {
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        showToast('ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³é€šè©± API', true);
                        return;
                    }
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    openVoiceCallModal(targetUserId, stream);
                    showToast('èªéŸ³é€šè©±åˆå§‹åŒ–å®Œæˆï¼ˆå°šæœªå»ºç«‹é€£ç·šï¼‰');
                } catch (e) {
                    console.error('å•Ÿå‹•èªéŸ³é€šè©±å¤±æ•—:', e);
                    const msg = (e && e.name === 'NotAllowedError')
                        ? 'å·²æ‹’çµ•éº¥å…‹é¢¨æ¬Šé™ï¼Œè«‹åœ¨ç€è¦½å™¨è¨­å®šä¸­å…è¨±'
                        : (e && e.name === 'NotFoundError')
                            ? 'æ‰¾ä¸åˆ°å¯ç”¨çš„éŸ³è¨Šè£ç½®'
                            : 'ç„¡æ³•å•Ÿç”¨éº¥å…‹é¢¨ï¼Œè«‹æª¢æŸ¥æ¬Šé™èˆ‡ä¾†æº';
                    showToast(msg, true);
                }
            }
            window.startVoiceCall = startVoiceCall;

            function timeAgo(date) {
                const seconds = Math.floor((new Date() - date) / 1000);
                let interval = seconds / 31536000;
                if (interval > 1) return Math.floor(interval) + " å¹´å‰";
                interval = seconds / 2592000;
                if (interval > 1) return Math.floor(interval) + " æœˆå‰";
                interval = seconds / 86400;
                if (interval > 1) return Math.floor(interval) + " å¤©å‰";
                interval = seconds / 3600;
                if (interval > 1) return Math.floor(interval) + " å°æ™‚å‰";
                interval = seconds / 60;
                if (interval > 1) return Math.floor(interval) + " åˆ†é˜å‰";
                return "å‰›å‰›";
            }
            
            function formatDate(timestamp) {
                if (!timestamp) return '';
                let d;
                try {
                    if (timestamp && typeof timestamp.toDate === 'function') {
                        d = timestamp.toDate();
                    } else if (timestamp instanceof Date) {
                        d = timestamp;
                    } else {
                        d = new Date(timestamp);
                    }
                } catch (_) {
                    d = new Date(timestamp);
                }
                if (!d || isNaN(d.getTime())) return '';
                return d.toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false });
            }

            // é€šç”¨æ—¥æœŸæ™‚é–“æ ¼å¼åŒ–ï¼šæ”¯æ´ Firestore Timestampã€Dateã€å­—ä¸²èˆ‡æ•¸å­—
            function formatDateTime(value) {
                if (!value) return '';
                let d;
                try {
                    if (value && typeof value.toDate === 'function') {
                        d = value.toDate();
                    } else if (value instanceof Date) {
                        d = value;
                    } else {
                        d = new Date(value);
                    }
                    if (isNaN(d.getTime())) return '';
                    return d.toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false });
                } catch (e) {
                    console.error('formatDateTime error:', e);
                    return '';
                }
            }
        }

        // ç”¨æˆ¶å½ˆå‡ºè¦–çª—åŠŸèƒ½
        document.addEventListener('click', function(e) {
            // é—œé–‰å·²æ‰“é–‹çš„å½ˆå‡ºè¦–çª—
            if (!e.target.closest('.user-popup') && !e.target.closest('.user-name-btn')) {
                const existingPopup = document.querySelector('.user-popup');
                if (existingPopup) {
                    existingPopup.remove();
                }
            }
            
            // é»æ“Šç”¨æˆ¶åç¨±æ™‚é¡¯ç¤ºå½ˆå‡ºè¦–çª—
            if (e.target.classList.contains('user-name-btn') || e.target.closest('.user-name-btn')) {
                const nameBtn = e.target.classList.contains('user-name-btn') ? e.target : e.target.closest('.user-name-btn');
                const userId = nameBtn.dataset.userId;
                const userName = nameBtn.dataset.userName;
                const userPhone = nameBtn.dataset.userPhone;
                
                // é—œé–‰å·²æ‰“é–‹çš„å½ˆå‡ºè¦–çª—
                const existingPopup = document.querySelector('.user-popup');
                if (existingPopup) {
                    existingPopup.remove();
                }
                
                // å‰µå»ºæ–°çš„å½ˆå‡ºè¦–çª—
                const popup = document.createElement('div');
                popup.className = 'user-popup fixed bg-white rounded-lg shadow-lg p-3 z-50';
                popup.style.width = '200px';
                
                // è¨ˆç®—ä½ç½® (åœ¨åç¨±ä¸‹æ–¹) ä¸¦é¿å…è¶…å‡ºè¦–çª—é‚Šç•Œ
                const rect = nameBtn.getBoundingClientRect();
                const popupWidth = 200; // èˆ‡ CSS å¯¬åº¦ä¸€è‡´
                const margin = 10; // èˆ‡é‚Šç•Œä¿æŒè·é›¢
                let left = rect.left;
                let top = rect.bottom + 5;

                // å³å´é‚Šç•Œæª¢æŸ¥
                if (left + popupWidth > window.innerWidth - margin) {
                    left = Math.max(margin, window.innerWidth - popupWidth - margin);
                }
                // å·¦å´é‚Šç•Œæª¢æŸ¥
                if (left < margin) {
                    left = margin;
                }

                // é ä¼°é«˜åº¦ä¸¦åšä¸‹é‚Šç•Œæª¢æŸ¥ï¼›è‹¥è¶…å‡ºå‰‡é¡¯ç¤ºåœ¨åç¨±ä¸Šæ–¹
                const estimatedHeight = 120; // å…§å®¹é«˜åº¦ä¼°ç®—
                if (top + estimatedHeight > window.innerHeight - margin) {
                    top = rect.top - estimatedHeight - 5;
                }
                // ä¸Šå´é‚Šç•Œæª¢æŸ¥
                if (top < margin) {
                    top = margin;
                }

                popup.style.left = `${left}px`;
                popup.style.top = `${top}px`;
                // å‹•æ…‹é™åˆ¶é«˜åº¦ä¸¦å…è¨±æ²å‹•
                const availableHeight = window.innerHeight - top - margin;
                popup.style.maxHeight = `${Math.max(80, availableHeight)}px`;
                popup.style.overflow = 'auto';
                
                // æ·»åŠ æŒ‰éˆ•ï¼ˆèªéŸ³é€šè©±ï¼‰
                popup.innerHTML = `
                    <div class="flex justify-center">
                        <button class="call-btn bg-purple-500 text-white py-1 px-2 rounded-md flex items-center justify-center" data-userid="${userId}">
                            <i data-lucide="mic" class="w-4 h-4 mr-1"></i>èªéŸ³é€šè©±
                        </button>
                    </div>
                `;
                
                // æ·»åŠ åˆ°é é¢
                document.body.appendChild(popup);
                lucide.createIcons();
                
                // æ·»åŠ æŒ‰éˆ•äº‹ä»¶ï¼ˆèªéŸ³é€šè©±ï¼‰
                popup.querySelector('.call-btn').addEventListener('click', function() {
                    const targetUserId = this.dataset.userid;
                    if (targetUserId) {
                        startVoiceCall(targetUserId);
                    } else {
                        showToast('ç„¡å°è±¡è³‡è¨Š', true);
                    }
                });
                
                // LineèŠå¤©æŒ‰éˆ•å·²ç§»é™¤
            }
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
             lucide.createIcons();
             showLoading(true);
             if (firebaseConfig.apiKey === "YOUR_FIREBASE_API_KEY" || GOOGLE_MAPS_API_KEY === "YOUR_GOOGLE_MAPS_API_KEY") {
                document.getElementById('api-key-warning').classList.remove('hide');
                showLoading(false);
                console.error("API Keys are not configured. Please edit index.html"); 
            } else {
                initializeAppLogic();
            }
        });
    </script>
</body>
</html>




